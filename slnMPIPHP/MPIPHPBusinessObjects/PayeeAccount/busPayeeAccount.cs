#region Using directives
using System;
using System.Collections;
using System.Collections.ObjectModel;
using System.Text;
using System.Data;
using Sagitec.Common;
using Sagitec.DBUtility;
using Sagitec.BusinessObjects;
using MPIPHP.CustomDataObjects;
using MPIPHP.DataObjects;
using Sagitec.DataObjects;
using System.Linq;
using Sagitec.CustomDataObjects;
using Sagitec.Interface;
using System.Data.SqlClient;

using System.Collections.Generic;
using System.Data.SqlTypes;
using System.Windows.Forms;
using System.IO;
using NeoSpin.BusinessObjects;
using Sagitec.Bpm;
#endregion

namespace MPIPHP.BusinessObjects
{
    /// <summary>
    /// Class MPIPHP.BusinessObjects.busPayeeAccount:
    /// Inherited from busPayeeAccountGen, the class is used to customize the business object busPayeeAccountGen.
    /// </summary>
    [Serializable]
    public class busPayeeAccount : busPayeeAccountGen
    {
        #region Public Properties
        public busCalculation ibusCalculation { get; set; }
        public busPerson ibusPayee { get; set; }
        public busPerson ibusParticipant { get; set; }
        public busOrganization ibusOrganization { get; set; }
        public busPayeeBenefitAccount ibusPayeeBenefitAccount { get; set; }
        public busBenefitApplication ibusBenefitApplication { get; set; }
        public busBenefitCalculationHeader ibusBenefitCalculationHeader { get; set; }
        public busQdroCalculationHeader ibusQDROCalculationHeader { get; set; }//PIR-829
        public busPayeeAccountStatus ibusCurrentPayeeAccount { get; set; }
        public busPayeeAccountStatus ibusCurrentActivePayeeAccount { get; set; }
        public busPaymentHistoryHeader ibusPaymentHistoryHeader { get; set; }
        public busDocumentProcessCrossref ibusDocumentProcessCrossref { get; set; }
        public int aintPatrticpant { get; set; }
        public int aintNoOverPayement { get; set; }

        public int aintSpouseConsent { get; set; }
        public string strBenefitOptionValueIAP { get; set; }
        public int aintIAPPlan { get; set; }
        public int aintIAPflg { get; set; }
        public Collection<busPensionVerificationHistory> iclbPensionVerificationHistory { get; set; }


        //public Collection<busOrganization> iclbOrganization { get; set; }
        public Collection<busPaymentItemType> iclbPaymentItemType { get; set; }
        public Collection<busRetroItemType> iclbRetroItemTypeInitialAndReac { get; set; }
        public Collection<busPayeeAccount> iclbPayeeAccount { get; set; }
        public Collection<busPayeeAccountTaxWithholding> iclbTaxWithHoldingHistory { get; set; }
        public Collection<busPayeeAccountTaxWithholding> iclbFederalTaxWithholding { get; set; }
        public Collection<busPayeeAccountTaxWithholding> iclbStateTaxWithholding { get; set; }
        public Collection<busRetroItemType> iclbRetroItemType { get; set; }
        public Collection<busPayeeAccountTaxWithholdingItemDetail> iclbPayeeAccountTaxWithholdingItemDetail { get; set; }
        public Collection<busPayeeAccountTaxWithholding> iclbPayeeAccountTaxWithholdingActive { get; set; }
        public Collection<busPayeeAccountDeduction> iclbPayeeAccountDeductionActive { get; set; }

        public Collection<busPayeeAccountRolloverDetail> iclbActiveRolloverDetails { get; set; }
        public Collection<busPayeeAccountPaymentItemType> iclbPayeeAccountPaymentItemTypeActive { get; set; }

        public Collection<busPayeeAccountDeduction> iclbPayeeAccountDeduction { get; set; }
        public Collection<busWithholdingInformation> iclbWithholdingInformation { get; set; }
        public Collection<busWithholdingInformationHistoryDetail> iclbWithholdingInformationHistoryDetail { get; set; }
        public Collection<busPayeeAccountBenefitOverpayment> iclbPayeeAccountBenefitOverpayment { get; set; }
        public Collection<busRepaymentSchedule> iclbRepaymentSchedule { get; set; }
        public Collection<busIapHardshipPayback> iclbIAPHardshipPayback { get; set; } //6/15/2020 - IAP Payback
        public Collection<busPersonAccountRetirementContribution> iclbPersonAccountRetirementContribution { get; set; } //6/15/2020 - IAP Payback
        public Collection<busError> iclbBenfErrors { get; set; }//PIR-527

        DataTable idtbPaymentItemType { get; set; }
        DataTable idtbRetroItemType { get; set; }
        public DateTime idtStatusEffectiveDate { get; set; }
        public DateTime idtNextBenefitPaymentDate { get; set; }
        public DateTime idtLastBenefitPaymentDate { get; set; }
        public decimal idecGrossAmount { get; set; }
        public decimal idecTotalAmount { get; set; }
        public string istrVerifiedFlag { get; set; }
        public string istrPayeeStatus { get; set; }
        public string istrPayeeBreakDownChequeAChHeader { get; set; }

        public string istrCheckPayeeRetroAdjustAmount { get; set; }
        public decimal idecRolledOverAmount { get; set; }
        public string istrRecepientNameInProperCase { get; set; }
        public decimal idecTotalTaxableRolledOverAmount { get; set; }
        public decimal idecTotalRolledOverAmount { get; set; }
        public decimal idecTotalTaxableAmount { get; set; }
        public decimal idecAdjustedTaxableAmount { get; set; }
        public decimal idecNextMonthTaxable { get; set; }
        public decimal idecNextMonthNonTaxable { get; set; }
        public decimal idecNextGrossPaymentRollOver { get; set; }
        public decimal idecNextNetPaymentRollOver { get; set; }
        public decimal idecNextGrossPaymentACH { get; set; }
        public decimal idecNextNetPaymentACH { get; set; }
        public decimal idecRetroAdjustmentAmount { get; set; }

        public string istrAnnunityName { get; set; }

        public string istrFullStateDescription { get; set; }
        public string istrMandatoryState { get; set; }
        public string istrNonMandatoryState { get; set; }

        public string istrNewState { get; set; }

        public string istrPrevState { get; set; }

        public decimal idecRetroGrossAmount { get; set; }  // pir-713




        public decimal idecFederalTaxWithHolding { get; set; }

        public decimal idecStateTaxWithHolding { get; set; }

        public decimal idecCorrFederalTaxWithHolding { get; set; }

        public decimal idecCorrStateTaxWithHolding { get; set; }

        public decimal idecDeduction { get; set; }
        public decimal idecPensionReceivable { get; set; }

        public decimal idecWithholdingPercentage { get; set; }//PIR 990

        public decimal idecTotalTaxableAmountForVariableTax { get; set; }
        public decimal idecTotalTaxableAmountForVariableTaxRetro { get; set; }
        public decimal idecNontaxableAmount { get; set; }
        public string astrCheckCurrentPage { get; set; }
        public decimal idecGrossAmountAfterRollover { get; set; }
        public DateTime idtPayeeLastBenefitPaymentDate { get; set; }
        public decimal ideLastMonthAmount { get; set; }
        public decimal idecGrossBenefitAmount { get; set; }

        //Properties to display payment history tab
        public Collection<busPaymentHistoryHeader> iclbPaymentHistoryHeader { get; set; }
        public Collection<busPaymentHistoryDistribution> iclbPaymentHistoryDistribution { get; set; }
        public Collection<busPaymentHistoryHeader> iclbPaymentHistoryHeaderDetails { get; set; }
        public decimal idecPaidGrossAmount { get; set; }
        public decimal idecPaidTaxableAmount { get; set; }
        public decimal idecPaidNonTaxableAmount { get; set; }
        public decimal idecPaidTaxableRolloverAmount { get; set; }
        public decimal idecPaidNonTaxableRolloverAmount { get; set; }
        public decimal idecRemainingMinimumGuaranteeAmount { get; set; }
        public decimal idecRemainingNonTaxableBeginningBalance { get; set; }
        public Collection<busPlanBenefitXr> iclbcdoPlanBenefit { get; set; }
        public decimal idecPaymentHistoryDetailGrossAmount { get; set; }
        public decimal idecPaymentHistoryDetailGrossAmountAfterRollover { get; set; }

        public DateTime idtBenefitPaymentDateForTaxWithholding { get; set; }
        public DateTime idtBenefitPaymentDateForDeduction { get; set; }

        public decimal idecIAPHoursSUM { get; set; }
        public decimal idecIAPHours4QtrAlloc { get; set; }
        public DateTime idtVerificationHoursEffectiveDate { get; set; }
        public string istrVerificationHoursEffectiveDate { get; set; }
        public DateTime idtToDate { get; set; }
        public DateTime idtParticDateBirth { get; set; }
        public string istrToDate { get; set; }
        public string istrEmployerName { get; set; }
        public string istrAddress1 { get; set; }
        public string istrCity1 { get; set; }
        public string istrAddress2 { get; set; }
        public string istrState { get; set; }
        public string istrContact1 { get; set; }
        public string istrPostalCode { get; set; }
        public string istrContact2 { get; set; }
        public string istrStreet { get; set; }
        public string istrPayeeDomesticStateIntlCountry { get; set; }  //rid 81162
        public string istrContactTRUE { get; set; }
        public string iblnAdjustmentPaymentEliglbleFlag { get; set; }

        public string istrBenefitBeginDate { get; set; }
        public string istrMonthYear { get; set; }

        //PIR 977
        public string istrCurrentDatePlus32Days { get; set; }

        public bool iblnIsQualifiedSpouse { get; set; }
        public string istrQualifiedSpouse { get; set; }
        public decimal idecRetireeIncAmount { get; set; }
        public string istrShowRollOver { get; set; }

        //Properties for corPAYEE-0016
        public string istr1 { get; set; }
        public Collection<busPayeeAccount> iclbPayeeAccountForTable { get; set; }
        public string istrFormattedDate { get; set; }
        public DateTime idtFromDate { get; set; }
        public string istrFromDate { get; set; }
        public string istrFromDtCorr16 { get; set; }
        public DateTime idtFromDtCorr16 { get; set; }
        bool aboolTransChange = false;
        public string istrChildFullName { get; set; }
        public DateTime idtSuspendedStatusEffectiveDate { get; set; }

        public string istrOrgName { get; set; }

        public string istrOrgMpId { get; set; }

        public string istrOrgAddress { get; set; }

        public string istrOrgAddress2 { get; set; }
        public string istrOrgCity { get; set; }
        public string istrOrgState { get; set; }
        public int intOrgZip { get; set; }

        public string istrFundTypeorPlanCode { get; set; }

        public string istrNewAddress { get; set; }

        public string istrPreviousAddress { get; set; }
        public int aintmdflag { get; set; }

        //10 Percent
        public string istrMoreInformation { get; set; }

        public string istrRolloverOrgName { get; set; }
        public string isRolloverOrgExists { get; set; }

        //EmergencyOneTimePayment - 03/17/2020
        public string isCOVID19PayFlag { get; set; }
        //Payback - 6/15/2020
        public string istrCOVIDOptionValue { get; set; }
        //Payment Adjustment - Reissue
        string ReissueFlag = "N";
        public string istrReissueFlag
        {
            get
            {

                return ReissueFlag;
            }
            set
            {
                ReissueFlag = value;
            }
        }

        public int iintPaymentReissueDetailId { get; set; }

        //PIR - 825
        public decimal idecRetroSpkAmount { get; set; }
        public decimal idecRetroSpkFederalTaxWithHolding { get; set; }
        public decimal idecRetroSpkStateTaxWithHolding { get; set; }

        public decimal idecRetroSpkNextGrossPaymentACH { get; set; }

        public decimal idecRetroSpkNextNetPaymentACH { get; set; }

        #region Properties for Correspondence
        public int aintRetirementDateYear { get; set; }

        public int aintAchPresent { get; set; }

        public int aintWithHoldingPresent { get; set; }

        public int aintretireeincr { get; set; }

        public string istrStatusEffectiveDate { get; set; }

        public string istrLastBenefitPaymentDate { get; set; }

        public int aintCheckUVHP { get; set; }

        public string istrDistributionType { get; set; }

        public int aintIsRetrUnreducesLess65 { get; set; }

        public int aintOverPaymentPriorPlanYear { get; set; }
        public string istrTransferOrgContactName { get; set; }
        public string istrCurrentDate { get; set; }
        public string istrRetirementDate { get; set; }
        //public string istrChildSupportStartDate { get; set; }
        public string istrChildSupportBenefitStartDate { get; set; }
        public string istrRecepientName { get; set; }
        public string istrPayeeFullName { get; set; }
        public string istrPayeeNameProperCase { get; set; }
        public string istrAddrLine1 { get; set; }
        public string istrAddrLine2 { get; set; }
        public string istrAddrLine3 { get; set; }
        public string istrCity { get; set; }
        public string istrStateDescription { get; set; }
        public string istrCountryDescription { get; set; }
        public int lintCountryValue { get; set; }
        public string istrCountryValue { get; set; }

        public string istrStdPayeeFullName { get; set; } //rid 81162
        public string istrStdPayeeNameInProperCase { get; set; } //rid 81162
        public string istrForeignProvince { get; set; } //rid 81162
        public int iintPayeeIsUSA { get; set; } //rid 81162
        public string istrDOD { get; set; }  //rid 81162       
        public bool iblnIsBatch { get; set; }

        public string istrZipCode { get; set; }
        public string istrZipCode4 { get; set; }
        public int iintCheckNumber { get; set; }
        public DateTime idtCheckDate { get; set; }
        public decimal idecAmount { get; set; }
        public decimal idecIndividualAccPlanBalance { get; set; }
        public int iintBenefitBeginDateYear { get; set; }
        public string istrRetroEffStartDate { get; set; }
        public string istrNextBenefitPaymentDate { get; set; }
        public decimal idecGrossBenefitAmt { get; set; }
        public decimal idecNetBenefitAmt { get; set; }  //rid 81162
        public string istrPaymentDate { get; set; }
        public string istrPlan { get; set; }
        public string istrRetroStartDate { get; set; }
        public int iintRetirementYear { get; set; }
        public int iintLastYearFromRetrYear { get; set; }
        public string istrRetirementMonthYear { get; set; }
        public string istrNextMonthAfterRetirementDate { get; set; }
        public string istrEndDate { get; set; }
        public string istrQuarter { get; set; }
        public string istrEligibleForAdjustmentPayment { get; set; }
        public string istrLumpSumOnFile { get; set; }
        public int iinIAPasOfDateYear { get; set; }
        public string istrAccountNumber { get; set; }
        public int iintRoutingNumber { get; set; }
        public decimal idecOverPaymentRepaid { get; set; }
        public decimal idecMonthlyBenefitAmt { get; set; }
        public int iintSuspendibleMonth { get; set; }
        public string istrBirthMonthAndYear { get; set; }
        public string istrBenefitOptionValue { get; set; }
        public string istrCheckDate { get; set; }
        public int iintPlanYear { get; set; }
        public decimal idecDefaultPayment { get; set; }
        public decimal idecLevyAmount { get; set; }
        public decimal idecReimbersmentAmount { get; set; }
        public string istrEffectiveDate { get; set; }
        public decimal idecNextAmtDue { get; set; }
        public string istrEstimateEndDate { get; set; }
        public string istrMonthEndDate { get; set; }
        public string istrFollowingMonthDate { get; set; }
        public string istrFollowingMonth { get; set; }
        public string istrBeneficiaryFullName { get; set; }
        public string istrBeneficiaryLastName { get; set; }
        public string istrBeneficiaryAddrLine1 { get; set; }
        public string istrBeneficiaryAddrline2 { get; set; }
        public string istrBeneficiaryCity { get; set; }
        public string istrBeneficiaryState { get; set; }
        public string istrBeneficiaryZipCode { get; set; }
        public string istrBeneficiaryPrefix { get; set; }
        public string istrBenefitOptionPercent { get; set; }
        public decimal idecMonthlyBenefitPlusRetroActive { get; set; }
        public string istrReasonForUnderPayment { get; set; }
        public string istrMonthWiseAjstPaymentDate { get; set; }
        public string istrLocal600 { get; set; }
        public decimal idecReemploymentCreditedHours { get; set; }
        public int iintReemploymentYear { get; set; }
        public decimal idecFinalMonthlyBenefit { get; set; }
        public decimal idecIAPAmount { get; set; }
        public decimal idecPaymentAmountAfterDeath { get; set; }
        public decimal idecFinalAccuredBenefitAmount { get; set; }

        public DateTime idtProcessedByDate { get; set; }
        public DateTime idtOriginalRetirementDate { get; set; }
        public DateTime idtMinimumDistributionDate { get; set; }
        public DateTime idtOPDateForAccturialAdjustment { get; set; }
        public DateTime idtAdjustedRetirementDate { get; set; }
        public DateTime idtPaymentAdjustmentDate { get; set; }
        public decimal idecCurrentMonthlyRetrBenefit { get; set; }
        public decimal idecReductionForFuturePayment { get; set; }
        public decimal idecQdroOffset { get; set; }
        public decimal idecMonthlyAmountForReduction { get; set; }
        public decimal idecActuarilaOffset { get; set; }
        public DateTime idtFulPaymentReinstallmentDate { get; set; }
        public decimal idecFinalMonthlyBenefits { get; set; }


        public decimal idecSumEEDerivedShudHvPaid { get; set; }
        public decimal idecSumERDerivedShudHvPaid { get; set; }
        public decimal idecSumTotalShudHvPaid { get; set; }
        public decimal idecSumActuallyPaidForMonth { get; set; }
        public decimal idecSumOverUnderPaymentPerMonth { get; set; }

        public decimal idecSumEEDerived { get; set; }
        public decimal idecSumERDerived { get; set; }
        public decimal idecSumTotal { get; set; }
        public decimal idecSumPayableForTheMonth { get; set; }
        public decimal idecSumReimbrAmtInCurrentMonth { get; set; }

        public decimal idecGrandTotal { get; set; }
        public decimal idecGrandTotalPayableForMonth { get; set; }
        public decimal idecGrandTotalReimbrAmt { get; set; }

        public decimal idecFlatPercent { get; set; }
        public decimal idecMonthlyAmtOfReduction { get; set; }

        public string istrDisabilityConvDate { get; set; }
        public string istrPaymentCuttOffDate { get; set; }

        public bool iblnIsRaclaimedFail { get; set; }
        public string istrIsReclaimedFail { get; set; }  //rid 81162

        public string istrDistrbutionStatus { get; set; }
        public string istrReportedBy { get; set; }
        public string istrReportedByInProper { get; set; }
        public bool iblnIsReportedBy { get; set; }


        public DateTime idtEstimatedEndDate { get; set; }
        public string istrMonthAftrEstimEndDate { get; set; }
        public string istr30DaysAfterCurrDate { get; set; }

        public string istrBenefirBeginDate { get; set; }

        //ChangeID: 58624
        public decimal idecPreviousMonthlyGrossAmt { get; set; }
        public decimal idecChangeInMonthlyGrossAmt { get; set; }
        public int iintMonthDiff { get; set; }

        public DateTime idtRetirementDate { get; set; }

        public string istrIAP { get; set; }
        public string istrRetro { get; set; }
        public string istrACH { get; set; }

        //6/15/2020 - IAP Paybacks
        public decimal idecIAPPaybackPaymentsReceived { get; set; }
        public DateTime idtIAPPaybackMaximumDueDate { get; set; }
        public string istrIAPPaybackMaximumDueDate { get; set; }
        public DateTime idtIAPHardshipPaymentCheckDate { get; set; }
        public string istrIAPHardshipPaymentCheckDate { get; set; }
        public decimal idecIAPPaybackRemainingUnPaidBalance { get; set; }

        public string istrIAPPaybackStatus { get; set; }

        public bool aboolIAPPaybackChange = false;
        public Collection<cdoIapHardshipPayback> iclbIAPPaybacksSummary { get; set; }
        public DateTime idtCurrentPaybackCheckReceivedDate { get; set; }
        public string istrCurrentPaybackCheckNumber { get; set; }
        public decimal idecCurrentPaybackCheckAmount { get; set; }
        public decimal idecIAPPayback2020Amount { get; set; }
        public decimal idecIAPPayback2021Amount { get; set; }
        public decimal idecIAPPayback2022Amount { get; set; }
        public decimal idecIAPPayback2023Amount { get; set; }

        public decimal idecIAPPayback2025Amount { get; set; }
        public decimal idecIAPPayback2026Amount { get; set; }
        public decimal idecIAPPayback2027Amount { get; set; }
        public decimal idecIAPPayback2028Amount { get; set; }
        public string istrIAPPaybackLastChkNum { get; set; }
        public DateTime idtIAPPaybackLastChkDt { get; set; }
        public decimal idecIAPPaybackLastChkAmt { get; set; }
        bool bConvertBenefitOptionToLife = false;
        private int aintSpuseConsent;
        string istrFdrlHidden = "FDRL";
        public string istrWizardTaxIdentifier
        {
            get
            {

                return istrFdrlHidden;
            }
            set
            {
                istrFdrlHidden = value;
            }

        }

        public string istrWizardStateTaxIdentifier { get; set; }
        public string istrWizardStateDescription { get; set; }
        public string istrWizardMinDistributionType { get; set; }
        public string istrWizardMaritalStatusValue { get; set; }
        public string istrWizardTaxOptionValue { get; set; }
        public decimal idecWizardStep2b3 { get; set; }

        public decimal idecWizardStep3 { get; set; }

        public decimal idecWizardStep4A { get; set; }

        public decimal idecWizardStep4B { get; set; }

        public decimal idecWizardStep4C { get; set; }
        public Decimal idecWizardadditional_tax_amount { get; set; }
        public Decimal idecWizardtax_percentage { get; set; }
        public int iWizardtax_allowance { get; set; }
        public DateTime idtWizardStartDate { get; set; }
        public DateTime idtWizardEndDate { get; set; }
        public int iintWizardPersonlExemption { get; set; }
        public int iintWizardVoluntary_Withholding { get; set; }
        public int iintWizardAgeandBlindnessExemptions { get; set; }

        public string istrWizardPaymentMethod { get; set; }

        public string istrWizardBankAccountType { get; set; }
        public string istrWizardRoutingNumber { get; set; }

        public string istrWizardAccountNumber { get; set; }

        public DateTime dtWizardAchStartDate { get; set; }

        public DateTime dtWizardAchEnddate { get; set; }

        public int iintWizardBankOrgId { get; set; }

        public string istrWizardPrenoteFlag { get; set; }
        public DateTime dtWizardPreNoteCompletionDate { get; set; }

       public string istrWizardJointAccountFlag { get; set; }
        #endregion


        #region Properties for WorkFlow
        public int PAYEE_ACCOUNT_ID { get; set; }
        public int FINAL_CALCULATION_ID { get; set; }
        public int FINAL_DRO_CALCULATION_ID { get; set; }
        #endregion


        //LA Sunset - Payment Directives
        #region Properties for Payment Directives

        public Collection<busPaymentDirectives> iclbPaymentDirectives { get; set; }
        public Collection<busPaymentDirectives> iclbDeletedPaymentDirectives { get; set; }
        public string istrSpecialInstructions { get; set; }
        public DateTime idtAdhocPaymentDate { get; set; }
        public string istrModifiedBy { get; set; }

        public string istrTemplateName { get; set; }

        public string idtPaymentCycleDate
        {
            get; set;
        }

        public int iintDeletedPaymentDirectiveId { get; set; }

        public DateTime idtLatestPaymentDirectiveCycleDate { get; set; }
        public string istrWithdrawalPaymentDate { get; set; }

        #endregion Properties for Payment Directives

        #endregion

        public busPayeeAccount()
        {
            if (this.ibusCalculation.IsNull())
            {
                this.ibusCalculation = new busCalculation();
            }
        }

        #region Load Payee Account Rollover Details
        public override void LoadPayeeAccountRolloverDetails()
        {
            base.LoadPayeeAccountRolloverDetails();
            if (this.iclbPayeeAccountRolloverDetail.Count > 0)
            {
                foreach (busPayeeAccountRolloverDetail lbusPayeeAccountRolloverDetail in this.iclbPayeeAccountRolloverDetail)
                {

                    DataTable ldtbOrgDetails = busBase.Select("cdoOrganization.GetOrgDetailsByOrganizationId", new object[1] { lbusPayeeAccountRolloverDetail.icdoPayeeAccountRolloverDetail.rollover_org_id });
                    if (ldtbOrgDetails.Rows.Count > 0 && ldtbOrgDetails.IsNotNull())
                    {
                        DataRow ldtrRow = ldtbOrgDetails.Rows[0];
                        lbusPayeeAccountRolloverDetail.icdoPayeeAccountRolloverDetail.istrOrgMPID = Convert.ToString(ldtrRow["MPI_ORG_ID"]);
                        lbusPayeeAccountRolloverDetail.icdoPayeeAccountRolloverDetail.istrOrgName = Convert.ToString(ldtrRow["ORG_NAME"]);
                    }
                    else
                    {
                        lbusPayeeAccountRolloverDetail.icdoPayeeAccountRolloverDetail.istrOrgMPID = string.Empty;
                        lbusPayeeAccountRolloverDetail.icdoPayeeAccountRolloverDetail.istrOrgName = string.Empty;
                    }
                }
            }
        }
        #endregion

        #region Load Payee Account ACH Details
        public override void LoadPayeeAccountAchDetails()
        {
            base.LoadPayeeAccountAchDetails();

            if (iclbPayeeAccountAchDetail.Count > 0)
            {
                //PIR 917
                iclbPayeeAccountAchDetail = iclbPayeeAccountAchDetail.OrderBy(c => c.icdoPayeeAccountAchDetail.ach_end_date).ToList().ToCollection();

                foreach (busPayeeAccountAchDetail lbusPayeeAccountAchDetail in this.iclbPayeeAccountAchDetail)
                {
                    DataTable ldtbOrgDetails = busBase.Select("cdoOrganization.GetOrgDetailsByOrganizationId", new object[1] { lbusPayeeAccountAchDetail.icdoPayeeAccountAchDetail.bank_org_id });
                    if (ldtbOrgDetails.Rows.Count > 0 && ldtbOrgDetails.IsNotNull())
                    {
                        DataRow ldtrRow = ldtbOrgDetails.Rows[0];
                        lbusPayeeAccountAchDetail.icdoPayeeAccountAchDetail.istrOrgMPID = Convert.ToString(ldtrRow["MPI_ORG_ID"]);
                        lbusPayeeAccountAchDetail.icdoPayeeAccountAchDetail.istrOrgName = Convert.ToString(ldtrRow["ORG_NAME"]);
                        if (ldtrRow["ROUTING_NUMBER"] != DBNull.Value)
                        {
                            lbusPayeeAccountAchDetail.icdoPayeeAccountAchDetail.iintRoutingNumber = Convert.ToInt32(ldtrRow["ROUTING_NUMBER"]);
                            lbusPayeeAccountAchDetail.icdoPayeeAccountAchDetail.istrRoutingNumber = Convert.ToString(ldtrRow["ROUTING_NUMBER"]);
                        }
                    }
                    else
                    {
                        lbusPayeeAccountAchDetail.icdoPayeeAccountAchDetail.istrOrgMPID = string.Empty;
                        lbusPayeeAccountAchDetail.icdoPayeeAccountAchDetail.istrOrgName = string.Empty;
                    }
                }
            }
        }
        #endregion
        public DataTable LoadOrgDetailsByRoutingNumber( string iintRoutingNumber)
        {
            DataTable ldtbOrgDetails = busBase.Select("cdoOrganization.GetOrgDetailsByRoutingNumber", new object[1] { iintRoutingNumber });
            return ldtbOrgDetails;
        }

        #region Load Payee Account ACH Details
        public override void LoadPayeeAccountWireDetail()
        {
            base.LoadPayeeAccountWireDetail();

            if (iclbPayeeAccountWireDetail.Count > 0)
            {
                //PIR 917
                iclbPayeeAccountWireDetail = iclbPayeeAccountWireDetail.OrderBy(c => c.icdoPayeeAccountWireDetail.wire_end_date).ToList().ToCollection();

                foreach (busPayeeAccountWireDetail lbusPayeeAccountWireDetail in this.iclbPayeeAccountWireDetail)
                {
                    // lbusPayeeAccountWireDetail.icdoPayeeAccountWireDetail.bank_account_type_value = "WIRE";
                    DataTable ldtbOrgDetails = busBase.Select("cdoOrganization.GetOrgDetailsByOrganizationId", new object[1] { lbusPayeeAccountWireDetail.icdoPayeeAccountWireDetail.bank_org_id });
                    if (ldtbOrgDetails.Rows.Count > 0 && ldtbOrgDetails.IsNotNull())
                    {
                        DataRow ldtrRow = ldtbOrgDetails.Rows[0];
                        lbusPayeeAccountWireDetail.icdoPayeeAccountWireDetail.istrOrgMPID = Convert.ToString(ldtrRow["MPI_ORG_ID"]);
                        lbusPayeeAccountWireDetail.icdoPayeeAccountWireDetail.istrOrgName = Convert.ToString(ldtrRow["ORG_NAME"]);
                        if (ldtrRow["ABA_SWIFT_BANK_CODE"] != DBNull.Value)
                        {
                            // lbusPayeeAccountWireDetail.icdoPayeeAccountWireDetail.iintAbaSwiftBankCode = Convert.ToInt32(ldtrRow["ABA_SWIFT_BANK_CODE"]);
                            lbusPayeeAccountWireDetail.icdoPayeeAccountWireDetail.istrAbaSwiftBankCode = Convert.ToString(ldtrRow["ABA_SWIFT_BANK_CODE"]);

                        }
                    }
                    else
                    {
                        lbusPayeeAccountWireDetail.icdoPayeeAccountWireDetail.istrOrgMPID = string.Empty;
                        lbusPayeeAccountWireDetail.icdoPayeeAccountWireDetail.istrOrgName = string.Empty;
                        //  lbusPayeeAccountWireDetail.icdoPayeeAccountWireDetail.bank_account_type_value = string.Empty;
                    }

                    DataTable ldtInterbOrgDetails = busBase.Select("cdoOrganization.GetOrgDetailsByOrganizationId", new object[1] { lbusPayeeAccountWireDetail.icdoPayeeAccountWireDetail.inter_bank_org_id });
                    if (ldtInterbOrgDetails.Rows.Count > 0 && ldtInterbOrgDetails.IsNotNull())
                    {
                        DataRow ldtrRow = ldtInterbOrgDetails.Rows[0];
                        lbusPayeeAccountWireDetail.icdoPayeeAccountWireDetail.istrinterOrgMPID = Convert.ToString(ldtrRow["MPI_ORG_ID"]);
                        lbusPayeeAccountWireDetail.icdoPayeeAccountWireDetail.istrInterOrgName = Convert.ToString(ldtrRow["ORG_NAME"]);
                        if (ldtrRow["ABA_SWIFT_BANK_CODE"] != DBNull.Value)
                        {
                            // lbusPayeeAccountWireDetail.icdoPayeeAccountWireDetail.iintInterAbaSwiftBankCode = Convert.ToInt32(ldtrRow["ABA_SWIFT_BANK_CODE"]);
                            lbusPayeeAccountWireDetail.icdoPayeeAccountWireDetail.istrInterAbaSwiftBankCode = Convert.ToString(ldtrRow["ABA_SWIFT_BANK_CODE"]);
                        }
                    }
                    else
                    {
                        lbusPayeeAccountWireDetail.icdoPayeeAccountWireDetail.istrinterOrgMPID = string.Empty;
                        lbusPayeeAccountWireDetail.icdoPayeeAccountWireDetail.istrInterOrgName = string.Empty;
                    }


                }
            }
        }
        #endregion

        #region Load Next Benefit Payment Date
        public void LoadNextBenefitPaymentDate()
        {
            if (this.icdoPayeeAccount.iintPlanId == 0)
            {
                LoadDRODetails();
                LoadBenefitDetails();
            }
            idtLastBenefitPaymentDate = busPayeeAccountHelper.GetLastBenefitPaymentDate(this.icdoPayeeAccount.iintPlanId);
            if (this.icdoPayeeAccount.iintPlanId != busConstant.IAP_PLAN_ID)
                idtNextBenefitPaymentDate = idtLastBenefitPaymentDate.AddMonths(1);
            else
                idtNextBenefitPaymentDate = busGlobalFunctions.GetPaymentDayForIAP(idtLastBenefitPaymentDate.AddDays(7));
            //ask
            if (icdoPayeeAccount.benefit_begin_date > idtNextBenefitPaymentDate)
            {
                idtNextBenefitPaymentDate = icdoPayeeAccount.benefit_begin_date;
            }
            iintBenefitBeginDateYear = idtNextBenefitPaymentDate.Year;
            istrNextBenefitPaymentDate = busGlobalFunctions.ConvertDateIntoDifFormat(idtNextBenefitPaymentDate);

        }

        #endregion

        #region Load Total Rollover Amount
        public void LoadTotalRolloverAmount()
        {
            idecTotalRolledOverAmount = 0.0m;
            if (idtNextBenefitPaymentDate == DateTime.MinValue)
                LoadNextBenefitPaymentDate();
            LoadPayeeAccountPaymentItemType();

            // Active Payee Account Payment Item type
            idecTotalRolledOverAmount = (from item in this.iclbPayeeAccountPaymentItemType
                                         where busGlobalFunctions.CheckDateOverlapping(idtNextBenefitPaymentDate,
                                         item.icdoPayeeAccountPaymentItemType.start_date, item.icdoPayeeAccountPaymentItemType.end_date)
                                         && item.ibusPaymentItemType.icdoPaymentItemType.allow_rollover_code_value == busConstant.RolloverItemReductionCheck
                                         select item.icdoPayeeAccountPaymentItemType.amount).Sum();

            idecTotalTaxableRolledOverAmount = (from item in this.iclbPayeeAccountPaymentItemType
                                                where busGlobalFunctions.CheckDateOverlapping(idtNextBenefitPaymentDate,
                                                item.icdoPayeeAccountPaymentItemType.start_date, item.icdoPayeeAccountPaymentItemType.end_date)
                                                && item.ibusPaymentItemType.icdoPaymentItemType.allow_rollover_code_value == busConstant.RolloverItemReductionCheck
                                                && item.ibusPaymentItemType.icdoPaymentItemType.taxable_item_flag == busConstant.FLAG_YES
                                                select item.icdoPayeeAccountPaymentItemType.amount).Sum();
        }
        #endregion

        #region Load Gross Amount
        public void LoadGrossAmount()
        {
            if (idtNextBenefitPaymentDate == DateTime.MinValue)
                this.LoadNextBenefitPaymentDate();
            LoadGrossAmount(idtNextBenefitPaymentDate);
        }

        //RID 75975
        public void LoadMonthlyGrossAmount()
        {
            if (idtNextBenefitPaymentDate == DateTime.MinValue)
                this.LoadNextBenefitPaymentDate();
            LoadMonthlyGrossAmount(idtNextBenefitPaymentDate);
        }

        public void LoadPayeeAccountRetroPaymentDetails()
        {
            foreach (busPayeeAccountRetroPayment lobjPayeeAccountRetroPayment in iclbPayeeAccountRetroPayment)
            {
                lobjPayeeAccountRetroPayment.LoadPayeeAccountRetroPaymentDetails();
                if (lobjPayeeAccountRetroPayment.iclbPayeeAccountRetroPaymentDetail != null)
                {
                    foreach (busPayeeAccountRetroPaymentDetail lobjPayeeAccountRetroPaymentDetail in lobjPayeeAccountRetroPayment.iclbPayeeAccountRetroPaymentDetail)
                    {
                        lobjPayeeAccountRetroPaymentDetail.LoadPaymentItemType();
                    }
                }
            }
        }

        public void LoadPayeeAccountOverPaymentPaymentDetails()
        {
            if (iclbPayeeAccountBenefitOverpayment != null)
            {
                foreach (busPayeeAccountBenefitOverpayment lbusPayeeAccountBenefitOverpayment in iclbPayeeAccountBenefitOverpayment)
                {
                    lbusPayeeAccountBenefitOverpayment.LoadPayeeAccountRetroPaymentDetails();
                }
            }
        }


        public void LoadGrossAmount(DateTime adtEffectiveDate)
        {
            idecGrossAmount = 0.00m;
            if (iclbPayeeAccountPaymentItemType == null)
            {
                this.LoadPayeeAccountPaymentItemType();
            }
            // Active Payee Account Payment Item type
            idecGrossAmount = (from item in this.iclbPayeeAccountPaymentItemType
                               where busGlobalFunctions.CheckDateOverlapping(idtNextBenefitPaymentDate,
                               item.icdoPayeeAccountPaymentItemType.start_date, item.icdoPayeeAccountPaymentItemType.end_date)
                               && item.ibusPaymentItemType.icdoPaymentItemType.item_type_direction == 1
                               select item.icdoPayeeAccountPaymentItemType.amount).Sum();
        }

        //RID 75975
        public void LoadMonthlyGrossAmount(DateTime adtEffectiveDate)
        {
            idecGrossAmount = 0.00m;
            if (iclbPayeeAccountPaymentItemType == null)
            {
                this.LoadPayeeAccountPaymentItemType();
            }
            // Active Payee Account Payment Item type
            idecGrossAmount = (from item in this.iclbPayeeAccountPaymentItemType
                               where busGlobalFunctions.CheckDateOverlapping(idtNextBenefitPaymentDate,
                               item.icdoPayeeAccountPaymentItemType.start_date, item.icdoPayeeAccountPaymentItemType.end_date)
                               && (item.ibusPaymentItemType.icdoPaymentItemType.item_type_direction == 1 && item.ibusPaymentItemType.icdoPaymentItemType.base_amount_flag == "Y")
                               select item.icdoPayeeAccountPaymentItemType.amount).Sum();
        }

        #endregion

        #region Load Benefit Details
        public void LoadBenefitDetails()
        {
            if (this.icdoPayeeAccount.benefit_application_detail_id != 0)
            {
                DataTable ldtbList = busBase.Select("cdoBenefitCalculationDetail.GetBenefitDetailsByDetailID", new object[1] { this.icdoPayeeAccount.benefit_application_detail_id });
                if (ldtbList.IsNotNull() && ldtbList.Rows.Count > 0)
                {
                    DataRow ldtrRow;
                    if (this.icdoPayeeAccount.benefit_calculation_detail_id == 0)
                    {
                        ldtrRow = (from obj in ldtbList.AsEnumerable()
                                   where obj.Field<Int32>(enmPayeeAccount.payee_account_id.ToString()) == this.icdoPayeeAccount.payee_account_id
                                   select obj).FirstOrDefault();
                    }
                    else
                    {
                        ldtrRow = (from obj in ldtbList.AsEnumerable()
                                   where obj.Field<Int32>(enmPayeeAccount.payee_account_id.ToString()) == this.icdoPayeeAccount.payee_account_id
                                   && obj.Field<Int32>(enmPayeeAccount.benefit_calculation_detail_id.ToString()) == this.icdoPayeeAccount.benefit_calculation_detail_id
                                   select obj).FirstOrDefault();
                    }
                    if (ldtrRow != null)
                    {
                        if (ldtrRow["BENEFIT_CALCULATION_HEADER_ID"] != DBNull.Value)
                            this.icdoPayeeAccount.iintBenefitCalculationID = Convert.ToInt32(ldtrRow["BENEFIT_CALCULATION_HEADER_ID"]);

                        if (ldtrRow["WITHDRAWAL_DATE"] != DBNull.Value && icdoPayeeAccount.benefit_account_type_value == busConstant.BENEFIT_TYPE_WITHDRAWAL)
                        {
                            this.icdoPayeeAccount.idtRetireMentDate = Convert.ToDateTime(ldtrRow["WITHDRAWAL_DATE"]);
                            if (ldtrRow["EMERGENCY_ONETIME_PAYMENT_FLAG"] != DBNull.Value && Convert.ToString(ldtrRow["EMERGENCY_ONETIME_PAYMENT_FLAG"]) == "Y")
                            {
                                istrMoreInformation += "COVID 19 IAP Hardship Payment.";
                                isCOVID19PayFlag = "Y";
                            }
                            else
                            {
                                isCOVID19PayFlag = "N";
                                busCode lbusCode = new busCode();
                                istrMoreInformation += Convert.ToString(ldtrRow["WITHDRAWAL_TYPE_VALUE"]).IsNotNullOrEmpty() ? lbusCode.GetCodeValue(7098, Convert.ToString(ldtrRow["WITHDRAWAL_TYPE_VALUE"])).description : string.Empty;
                            }

                            istrCOVIDOptionValue = Convert.ToString(ldtrRow["COVID_OPTION_VALUE"]);
                        }
                        else if (ldtrRow["RETIREMENT_DATE"] != DBNull.Value && icdoPayeeAccount.benefit_account_type_value != busConstant.BENEFIT_TYPE_WITHDRAWAL)
                            this.icdoPayeeAccount.idtRetireMentDate = Convert.ToDateTime(ldtrRow["RETIREMENT_DATE"]);

                        if (ldtrRow["PLAN_NAME"] != DBNull.Value)
                            this.icdoPayeeAccount.istrPlanDescription = Convert.ToString(ldtrRow["PLAN_NAME"]);

                        if (ldtrRow["PLAN_ID"] != DBNull.Value)
                            this.icdoPayeeAccount.iintPlanId = Convert.ToInt32(ldtrRow["PLAN_ID"]);

                        if (ldtrRow["PLAN_CODE"] != DBNull.Value)
                            this.icdoPayeeAccount.istrPlanCode = Convert.ToString(ldtrRow["PLAN_CODE"]);

                        if (ldtrRow["BENEFIT_APPLICATION_ID"] != DBNull.Value)
                            this.icdoPayeeAccount.iintBenefitApplicationID = Convert.ToInt32(ldtrRow["BENEFIT_APPLICATION_ID"]);

                        if (ldtrRow["BENEFIT_OPTION_VALUE"] != DBNull.Value && ldtrRow["BENEFIT_OPTION_ID"] != DBNull.Value)
                        {
                            this.icdoPayeeAccount.istrBenefitOptionValue = Convert.ToString(ldtrRow["BENEFIT_OPTION_VALUE"]);
                            this.icdoPayeeAccount.istrBenefitOption = busGlobalFunctions.GetCodeValueDescriptionByValue(Convert.ToInt32(ldtrRow["BENEFIT_OPTION_ID"]), Convert.ToString(ldtrRow["BENEFIT_OPTION_VALUE"])).description;
                        }


                        if (ldtrRow["CALCULATION_TYPE_VALUE"] != DBNull.Value)
                            this.icdoPayeeAccount.istrCalculationType = Convert.ToString(ldtrRow["CALCULATION_TYPE_VALUE"]);

                        if (ldtrRow[enmBenefitApplication.converted_min_distribution_flag.ToString().ToUpper()] != DBNull.Value
                            && Convert.ToString(ldtrRow[enmBenefitApplication.converted_min_distribution_flag.ToString().ToUpper()]) == busConstant.FLAG_YES)
                            istrMoreInformation += "Converted From RMD.";
                        //PIR 894
                        if (ldtrRow["ORIGINAL_BENEFIT_OPTION_VALUE"] != DBNull.Value)
                            this.icdoPayeeAccount.istrOriginalBenefitOptionValue = Convert.ToString(ldtrRow["ORIGINAL_BENEFIT_OPTION_VALUE"]);

                        //PIR 894
                        if (ldtrRow["SPOUSE_DOD"] != DBNull.Value && Convert.ToString(ldtrRow["SPOUSE_DOD"]).IsNotNullOrEmpty())
                            this.icdoPayeeAccount.idtSpouseDateOfDeath = Convert.ToDateTime(ldtrRow["SPOUSE_DOD"]);

                        if ((this.icdoPayeeAccount.benefit_account_type_value == busConstant.BENEFIT_TYPE_RETIREMENT ||
                           this.icdoPayeeAccount.benefit_account_type_value == busConstant.BENEFIT_TYPE_DISABILITY) && icdoPayeeAccount.account_relation_value == busConstant.BenefitCalculation.ACCOUNT_RELATIONSHIP_MEMBER)
                        {

                            if (icdoPayeeAccount.istrBenefitOptionValue == busConstant.LIFE &&
                                (icdoPayeeAccount.istrOriginalBenefitOptionValue == busConstant.JOINT_100_PERCENT_POPUP_ANNUITY ||
                                icdoPayeeAccount.istrOriginalBenefitOptionValue == busConstant.JOINT_50_PERCENT_POPUP_ANNUITY ||
                                icdoPayeeAccount.istrOriginalBenefitOptionValue == busConstant.JOINT_75_PERCENT_POPUP_ANNUITY))
                            {
                                istrMoreInformation += Convert.ToString(istrMoreInformation).IsNullOrEmpty() ? "Converted from J&S pop up." : " Converted from J&S pop up.";
                            }
                        }

                        //LA Sunset - Payment Directives
                        if (ldtrRow[enmBenefitApplication.disability_conversion_date.ToString().ToUpper()] != DBNull.Value
                         && Convert.ToString(ldtrRow[enmBenefitApplication.disability_conversion_date.ToString().ToUpper()]).IsNotNullOrEmpty())
                            istrMoreInformation += Convert.ToString(istrMoreInformation).IsNullOrEmpty() ? "Disability Conversion." : " Disability Conversion.";

                    }

                }

            }

        }
        #endregion

        #region Load DRO Details
        public void LoadDRODetails()
        {
            if (this.icdoPayeeAccount.dro_application_detail_id != 0)
            {
                DataTable ldtbList = busBase.Select("cdoBenefitCalculationDetail.GetDRODetailsByDetailID", new object[1] { this.icdoPayeeAccount.dro_application_detail_id });
                if (ldtbList.IsNotNull() && ldtbList.Rows.Count > 0)
                {
                    //DataRow ldtrRow = ldtbList.Rows[0];
                    DataRow ldtrRow;
                    if (this.icdoPayeeAccount.dro_calculation_detail_id == 0)
                    {
                        ldtrRow = (from obj in ldtbList.AsEnumerable()
                                   where obj.Field<Int32>(enmPayeeAccount.payee_account_id.ToString()) == this.icdoPayeeAccount.payee_account_id
                                   select obj).FirstOrDefault();
                    }
                    else
                    {
                        ldtrRow = (from obj in ldtbList.AsEnumerable()
                                   where obj.Field<Int32>(enmPayeeAccount.payee_account_id.ToString()) == this.icdoPayeeAccount.payee_account_id
                                   && obj.Field<Int32>("QDRO_CALCULATION_DETAIL_ID") == this.icdoPayeeAccount.dro_calculation_detail_id
                                   select obj).FirstOrDefault();
                    }

                    if (ldtrRow["QDRO_CALCULATION_HEADER_ID"] != DBNull.Value)
                        this.icdoPayeeAccount.iintDROCalculationID = Convert.ToInt32(ldtrRow["QDRO_CALCULATION_HEADER_ID"]);

                    if (ldtrRow["DRO_COMMENCEMENT_DATE"] != DBNull.Value)
                        this.icdoPayeeAccount.idtRetireMentDate = Convert.ToDateTime(ldtrRow["DRO_COMMENCEMENT_DATE"]);

                    if (ldtrRow["PLAN_ID"] != DBNull.Value)
                        this.icdoPayeeAccount.iintPlanId = Convert.ToInt32(ldtrRow["PLAN_ID"]);
                    //LA Sunset - Payment Directives
                    if (ldtrRow["PLAN_CODE"] != DBNull.Value)
                        this.icdoPayeeAccount.istrPlanCode = Convert.ToString(ldtrRow["PLAN_CODE"]);

                    if (ldtrRow["PLAN_NAME"] != DBNull.Value)
                        this.icdoPayeeAccount.istrPlanDescription = Convert.ToString(ldtrRow["PLAN_NAME"]);

                    if (ldtrRow["QDRO_APPLICATION_ID"] != DBNull.Value)
                        this.icdoPayeeAccount.iintDROApplicationID = Convert.ToInt32(ldtrRow["QDRO_APPLICATION_ID"]);

                    if (ldtrRow["BENEFIT_OPTION_VALUE"] != DBNull.Value && ldtrRow["BENEFIT_OPTION_ID"] != DBNull.Value)
                    {
                        this.icdoPayeeAccount.istrBenefitOptionValue = Convert.ToString(ldtrRow["BENEFIT_OPTION_VALUE"]);
                        this.icdoPayeeAccount.istrBenefitOption = busGlobalFunctions.GetCodeValueDescriptionByValue(Convert.ToInt32(ldtrRow["BENEFIT_OPTION_ID"]), Convert.ToString(ldtrRow["BENEFIT_OPTION_VALUE"])).description;
                    }
                }
            }
        }
        #endregion

        #region CheckACHDetails
        public bool CheckACHDetails()
        {
            base.LoadPayeeAccountAchDetails();
            LoadNextBenefitPaymentDate();
            if (iclbPayeeAccountAchDetail != null && iclbPayeeAccountAchDetail.Count > 0)
            {
                iclbPayeeAccountAchDetail = (from item in iclbPayeeAccountAchDetail
                                             where busGlobalFunctions.CheckDateOverlapping(idtNextBenefitPaymentDate,
                                             item.icdoPayeeAccountAchDetail.ach_start_date, item.icdoPayeeAccountAchDetail.ach_end_date)
                                             && item.icdoPayeeAccountAchDetail.pre_note_flag != busConstant.FLAG_YES
                                             && item.icdoPayeeAccountAchDetail.pre_note_completion_date != DateTime.MinValue
                                             select item).ToList().ToCollection<busPayeeAccountAchDetail>();
                if (iclbPayeeAccountAchDetail.Count > 0)
                    return true;
                else
                    return false;
            }
            return false;
        }
        #endregion



        #region Overriden Methods

        [NonSerialized]
        bool lblnHasChanged;
        public override int PersistChanges()
        {
            int lintNoRows = base.PersistChanges();
            if (IsPayeeAcoountChildForms())
            {
                if (lintNoRows == 0)
                {
                    this.iarrChangeLog.Clear();
                    this.lblnHasChanged = false;
                }
                else
                {
                    this.lblnHasChanged = true;
                }
            }
            return lintNoRows;
        }

        public override void AfterPersistChanges()
        {
            if (this.iarrChangeLog.Count == 0 && !this.lblnHasChanged && IsPayeeAcoountChildForms())
            {
                iobjPassInfo.idictParams["SaveMesssagePayeeAccount"] = "false";
                return;
            }
                
            //PIR-527
            this.ValidateSoftErrors();
            LoadSoftErrors();

            this.ValidateHardErrors(utlPageMode.All);
            if (iarrErrors.Count == 0)
            {
                switch (astrCheckCurrentPage)
                {
                    case busConstant.PAYEE_ACCOUNT_TAXWITHHOLDING_MAINTENANCE:
                        ProcessTaxWithHoldingDetails();
                        //Ticket No 151428
                        //CreateReviewPayeeAccountStatus();
                        break;
                    case busConstant.PAYEE_ACCOUNT_FED_WIZARD_TAXWITHHOLDING_MAINTENANCE:

                        busPayeeAccountTaxWithholding lbusPayeeAccountTaxWithholding = new busPayeeAccountTaxWithholding { icdoPayeeAccountTaxWithholding = new cdoPayeeAccountTaxWithholding() };
                        this.WizardTaxWithholdingSave(lbusPayeeAccountTaxWithholding);

                        if (lbusPayeeAccountTaxWithholding != null)
                        {
                            if (lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.payee_account_tax_withholding_id == 0)
                            {
                                lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.Insert();

                                this.iclbPayeeAccountTaxWithholding.Add(lbusPayeeAccountTaxWithholding);
                            }
                                                       
                            this.ProcessTaxWithHoldingDetails(true);
                            this.LoadPayeeAccountTaxWithholdings();
                            this.LoadBreakDownDetails();
                            CreateReviewPayeeAccountStatus();
                        }

                        break;
                    case busConstant.PAYEE_ACCOUNT_STATE_WIZARD_TAXWITHHOLDING_MAINTENANCE:

                        busPayeeAccountTaxWithholding lbusPayeeAccountStateTaxWithholding = new busPayeeAccountTaxWithholding { icdoPayeeAccountTaxWithholding = new cdoPayeeAccountTaxWithholding() };
                        this.WizardTaxWithholdingSave(lbusPayeeAccountStateTaxWithholding);

                        if (lbusPayeeAccountStateTaxWithholding != null)
                        {
                            if (lbusPayeeAccountStateTaxWithholding.icdoPayeeAccountTaxWithholding.payee_account_tax_withholding_id == 0)
                            {
                                lbusPayeeAccountStateTaxWithholding.icdoPayeeAccountTaxWithholding.Insert();

                                this.iclbPayeeAccountTaxWithholding.Add(lbusPayeeAccountStateTaxWithholding);
                            }

                            this.ProcessTaxWithHoldingDetails(true);
                            this.LoadPayeeAccountTaxWithholdings();
                            this.LoadBreakDownDetails();
                            CreateReviewPayeeAccountStatus();
                            GeneratePaymentDirectiveForWizard();
                            InsertPersonNotesFromWizard();
                            UpdatePacketTrackingStatusFromWizard();

                        }
                        break;
                    case busConstant.PAYEE_ACCOUNT_ROLLOVER_MAINTENANCE:
                        ProcessRolloverDetails();
                        CreateReviewPayeeAccountStatus();
                        break;
                    case busConstant.PAYEE_ACCOUNT_DEDUCTION_MAINTENANCE:
                        CreateReviewPayeeAccountStatus();
                        break;
                    case busConstant.PAYEE_ACCOUNT_STATUS_MAINTENANCE:
                        CreateReactivatioRetroPaymentItem();
                        CancelAllPayeeSameApp();
                        SuspendAlternatePayeeAccounts();
                        break;
                    //Ticket 69506
                    case busConstant.PAYEE_ACCOUNT_ACH_MAINTENANCE:

                        foreach (busPayeeAccountAchDetail lbusPayeeAccountAchDetail in this.iclbPayeeAccountAchDetail)
                        {
                            if (lbusPayeeAccountAchDetail.icdoPayeeAccountAchDetail.ach_end_date == DateTime.MinValue)
                            {
                                CreateReviewPayeeAccountStatus();

                            }

                        }
                        break;
                    case busConstant.PAYEE_ACCOUNT_ACH_WIZARD_MAINTENANCE:
                        if(this.istrWizardPaymentMethod != "CHK")
                        {
                            foreach (busPayeeAccountAchDetail lbusPayeeAccountAchDetail in this.iclbPayeeAccountAchDetail)
                            {
                                if (lbusPayeeAccountAchDetail.icdoPayeeAccountAchDetail.payee_account_ach_detail_id == 0)
                                {
                                    lbusPayeeAccountAchDetail.icdoPayeeAccountAchDetail.Insert();

                                    if (lbusPayeeAccountAchDetail.icdoPayeeAccountAchDetail.ach_end_date == DateTime.MinValue)
                                    {
                                        CreateReviewPayeeAccountStatus();

                                    }

                                }


                            }

                        }
                       
                        break;
                    case busConstant.PAYEE_ACCOUNT_WIRE_MAINTENANCE:

                        foreach (busPayeeAccountWireDetail lbusPayeeAccountWireDetail in this.iclbPayeeAccountWireDetail)
                        {
                            if (lbusPayeeAccountWireDetail.icdoPayeeAccountWireDetail.wire_end_date == DateTime.MinValue)
                            {
                                CreateReviewPayeeAccountStatus();

                            }

                        }
                        break;

                    //RID 83533
                    case busConstant.WITHHOLDING_INFORMATION_MAINTENANCE:
                        if (this.iclbPayeeAccountStatus.Count > 0)
                        {
                            if (this.iclbPayeeAccountStatus.FirstOrDefault().icdoPayeeAccountStatus.status_value == busConstant.PAYEE_ACCOUNT_STATUS_APPROVED
                                || this.iclbPayeeAccountStatus.FirstOrDefault().icdoPayeeAccountStatus.status_value == busConstant.PAYEE_ACCOUNT_STATUS_RECEIVING)
                            {
                                CreateReviewPayeeAccountStatus();
                            }
                        }
                        break;

                }

                if (aboolTransChange)
                {
                    LoadPayeeAccountStatuss();
                    GetCuurentPayeeAccountStatus();
                }

                if (iobjPassInfo.istrFormName == busConstant.PAYEE_ACCOUNT_MAINTENANCE && this.iclbIAPHardshipPayback.IsNotNull() && this.iclbIAPHardshipPayback.Count() > 0)
                {
                    this.LoadPayeeAccountIAPPaybacks();
                }
            }

            base.AfterPersistChanges();
            if (this.iarrChangeLog.Count == 0)
            {
                iobjPassInfo.idictParams["SaveMesssagePayeeAccount"] = "false";
            }
        }

        private bool IsPayeeAcoountChildForms()
        {
            if (iobjPassInfo.istrFormName == busConstant.PAYEE_ACCOUNT_TAXWITHHOLDING_MAINTENANCE || iobjPassInfo.istrFormName == busConstant.PAYEE_ACCOUNT_ACH_MAINTENANCE
                || iobjPassInfo.istrFormName == busConstant.PAYEE_ACCOUNT_WIRE_MAINTENANCE || iobjPassInfo.istrFormName == busConstant.PAYEE_ACCOUNT_ROLLOVER_MAINTENANCE
                || iobjPassInfo.istrFormName == busConstant.PAYEE_ACCOUNT_DEDUCTION_MAINTENANCE || iobjPassInfo.istrFormName == busConstant.PAYEE_ACCOUNT_STATUS_MAINTENANCE
                || iobjPassInfo.istrFormName == busConstant.WITHHOLDING_INFORMATION_MAINTENANCE)
                return true;
            else
                return false;
        }
        public override void ValidateHardErrors(utlPageMode aenmPageMode)
        {

            base.ValidateHardErrors(aenmPageMode);
            utlError lobjError = null;
            if (this.iarrErrors.IsNull())
                this.iarrErrors = new ArrayList();

            if (astrCheckCurrentPage == busConstant.PAYEE_ACCOUNT_TAXWITHHOLDING_MAINTENANCE)
            {
                if (ProcessTaxWithHoldingDetailsForValidation())
                {
                    lobjError = AddError(6188, "");
                    this.iarrErrors.Add(lobjError);
                }
            }


            if (astrCheckCurrentPage == busConstant.PAYEE_ACCOUNT_FED_WIZARD_TAXWITHHOLDING_MAINTENANCE || astrCheckCurrentPage == busConstant.PAYEE_ACCOUNT_STATE_WIZARD_TAXWITHHOLDING_MAINTENANCE)
            {
                this.iarrErrors = WizardTaxWithholdingValidate();
            }

            if (astrCheckCurrentPage == busConstant.PAYEE_ACCOUNT_ACH_WIZARD_MAINTENANCE)
            {
                WizardACHDetailsValidate();

            }



            //RID 83533
            if (iobjPassInfo.istrFormName == busConstant.WITHHOLDING_INFORMATION_MAINTENANCE || astrCheckCurrentPage == busConstant.WITHHOLDING_INFORMATION_MAINTENANCE)
            {
                if (this.iclbWithholdingInformation.Count > 0)
                {

                    int iintCount = (from item in this.iclbWithholdingInformation
                                     where (item.icdoWithholdingInformation.withholding_percentage <= 0
                                     || item.icdoWithholdingInformation.withholding_percentage > 100)
                                     select item).Count();

                    if (iintCount > 0)
                    {
                        lobjError = AddError(6142, "");
                        this.iarrErrors.Add(lobjError);
                    }


                }
            }
        }

        public override busBase GetCorPerson()
        {
            ibusParticipant.LoadPersonAddresss();
            ibusParticipant.LoadPersonContacts();
            ibusParticipant.LoadCorrAddress();
            return this.ibusParticipant;
        }

        public override void LoadCorresProperties(string astrTemplateName)
        {
            base.LoadCorresProperties(astrTemplateName);
            DateTime ldtCurrentDate = System.DateTime.Now;
            this.istrCurrentDate = busGlobalFunctions.ConvertDateIntoDifFormat(ldtCurrentDate);

            DateTime ldtRetirementDate;
            if (this.icdoPayeeAccount.idtRetireMentDate == DateTime.MinValue)
            {
                ldtRetirementDate = this.icdoPayeeAccount.benefit_begin_date;
            }
            else
            {
                ldtRetirementDate = this.icdoPayeeAccount.idtRetireMentDate;
            }
            this.istrRetirementDate = busGlobalFunctions.ConvertDateIntoDifFormat(ldtRetirementDate); //Payee-0014 ,  DIS-0012
            this.aintRetirementDateYear = ldtRetirementDate.Year;
            this.idtRetirementDate = ldtRetirementDate;
            if (this.icdoPayeeAccount.account_relation_value == busConstant.PERSON_TYPE_PARTICIPANT)
            {
                aintPatrticpant = 1;
                if (ibusParticipant != null)
                {
                    if (ibusParticipant.icdoPerson.health_eligible_flag == busConstant.Flag_Yes)
                    {
                        ainthealthEligibleFlag = 1;
                    }
                    else
                    {
                        ainthealthEligibleFlag = 2;
                    }
                }
            }

            //Ticket 95921
            if (ibusParticipant != null && ibusParticipant.icdoPerson.retirement_health_date != null && ibusParticipant.icdoPerson.retirement_health_date != DateTime.MinValue)
            {
                aintHasRetirementHealthDate = 1;
            }
            else
            {
                aintHasRetirementHealthDate = 0;
            }

            if (this.icdoPayeeAccount.retiree_incr_flag == busConstant.Flag_Yes)
            {
                aintretireeincr = 1;
            }

            if (astrTemplateName == busConstant.QDRO_FOR_SUPPORT)
            {
                ibusParticipant = ibusPayee;
                if (iclbPayeeAccountDeduction != null)
                {
                    istrChildFullName = iclbPayeeAccountDeduction[0].icdoPayeeAccountDeduction.istrPersonName;
                    LoadNextBenefitPaymentDate();
                    iclbPayeeAccountDeduction = iclbPayeeAccountDeduction.Where(
                        item => item.icdoPayeeAccountDeduction.deduction_type_value == busConstant.DeductionTypeValueChildSupport).OrderByDescending(
                        item => item.icdoPayeeAccountDeduction.start_date).ToList().ToCollection();

                    foreach (busPayeeAccountDeduction lbusPayeeAccountDeduction in iclbPayeeAccountDeduction)
                    {
                        if ((idtNextBenefitPaymentDate >= lbusPayeeAccountDeduction.icdoPayeeAccountDeduction.start_date &&
                                (lbusPayeeAccountDeduction.icdoPayeeAccountDeduction.end_date == DateTime.MinValue ||
                                idtNextBenefitPaymentDate < lbusPayeeAccountDeduction.icdoPayeeAccountDeduction.end_date)) ||
                                (idtNextBenefitPaymentDate <= lbusPayeeAccountDeduction.icdoPayeeAccountDeduction.start_date && (lbusPayeeAccountDeduction.icdoPayeeAccountDeduction.end_date == DateTime.MinValue ||
                                    lbusPayeeAccountDeduction.icdoPayeeAccountDeduction.start_date != lbusPayeeAccountDeduction.icdoPayeeAccountDeduction.end_date)))
                        {
                            this.istrChildSupportBenefitStartDate = busGlobalFunctions.ConvertDateIntoDifFormat(lbusPayeeAccountDeduction.icdoPayeeAccountDeduction.start_date);
                            break;
                        }
                    }
                }
            }

            if (astrTemplateName == busConstant.LUMP_SUM_DISTRIBUTION_ELECTION_FROM_PAYEE)
            {
                busBenefitCalculationDetail lbusBenefitCalculationDetail = new busBenefitCalculationDetail { icdoBenefitCalculationDetail = new cdoBenefitCalculationDetail() };
                busBenefitApplicationDetail lbusBenefitApplicationDetail = new busBenefitApplicationDetail { icdoBenefitApplicationDetail = new cdoBenefitApplicationDetail() };

                if (lbusBenefitCalculationDetail.FindBenefitCalculationDetail(this.icdoPayeeAccount.benefit_calculation_detail_id))
                {
                    this.ibusBenefitCalculationHeader = new busBenefitCalculationHeader { icdoBenefitCalculationHeader = new cdoBenefitCalculationHeader() };
                    this.ibusBenefitCalculationHeader.FindBenefitCalculationHeader(lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.benefit_calculation_header_id);
                    this.ibusBenefitCalculationHeader.iclbBenefitCalculationDetail = new Collection<busBenefitCalculationDetail>();
                    this.ibusBenefitCalculationHeader.iclbBenefitCalculationDetail.Add(lbusBenefitCalculationDetail);
                    this.ibusBenefitCalculationHeader.GetDistributionType();
                    istrDistributionType = this.ibusBenefitCalculationHeader.istrDistributionType;
                }
                LoadBreakDownDetails();
                if (icdoPayeeAccount.iintPlanId != 1)
                {
                    if (ibusPayeeBenefitAccount == null)
                    {
                        ibusPayeeBenefitAccount = new busPayeeBenefitAccount { icdoPayeeBenefitAccount = new cdoPayeeBenefitAccount() };
                        ibusPayeeBenefitAccount.FindPayeeBenefitAccount(icdoPayeeAccount.payee_benefit_account_id);
                    }
                    if (ibusPayeeBenefitAccount.icdoPayeeBenefitAccount.funds_type_value == busConstant.UVHP)
                    {
                        aintCheckUVHP = 1;
                    }
                }
            }
            #region Payee-0001
            // confirm from where this corr will get generated -Review
            if (astrTemplateName == busConstant.REEMPLOYMENT_NOTIFICATION_FORM)
            {
                //  DateTime ldtLastPaymentDate = idtLastBenefitPaymentDate.AddMonths(1).AddDays(-1);

                DataTable ldtbEEInfo = busBase.Select("cdoPayeeAccount.GetEEderived", new object[1] { this.icdoPayeeAccount.payee_account_id });
                if (ldtbEEInfo != null && ldtbEEInfo.Rows.Count > 0)
                {
                    LaodEEDerivedAMt(ldtbEEInfo.Rows[0]);
                }

                //  if (ldtbEndDate.Rows.Count > 0 && ldtbEndDate.Rows[0][0] != DBNull.Value)
                //  {
                //      DateTime ldtEndDate = idtLastBenefitPaymentDate;
                //      this.istrEndDate = busGlobalFunctions.ConvertDateIntoDifFormat(Convert.ToDateTime(ldtbEndDate.Rows[0]["END_DATE"]));
                //  }
            }
            #endregion

            if (astrTemplateName == busConstant.IAP_HARDSHIP_PAYMENT_CONFIRMATION || astrTemplateName == busConstant.CONFIRMATION_STATE_CHANGE_LETTER)
            {
                LoadBreakDownDetails();
                LoadPayeeAccountAchDetails();
                LoadPaymentDirectives();
                if (idtLatestPaymentDirectiveCycleDate != DateTime.MinValue)
                    istrWithdrawalPaymentDate = busGlobalFunctions.ConvertDateIntoDifFormat(idtLatestPaymentDirectiveCycleDate);
                else
                    istrWithdrawalPaymentDate = busGlobalFunctions.ConvertDateIntoDifFormat(idtNextBenefitPaymentDate);

                istrACH = "N";
                if (!iclbPayeeAccountAchDetail.IsNullOrEmpty())
                {
                    iclbPayeeAccountAchDetail = this.iclbPayeeAccountAchDetail.AsEnumerable().Where(o => (o.icdoPayeeAccountAchDetail.ach_end_date == DateTime.MinValue ||
                                    o.icdoPayeeAccountAchDetail.ach_end_date >= idtNextBenefitPaymentDate) && (o.icdoPayeeAccountAchDetail.pre_note_completion_date != DateTime.MinValue ||
                                    o.icdoPayeeAccountAchDetail.pre_note_flag == busConstant.Flag_Yes)).ToList().ToCollection<busPayeeAccountAchDetail>();
                    if (iclbPayeeAccountAchDetail.Count > 0)
                    {
                        aintAchPresent = 0;
                        istrACH = "N";
                    }
                    else
                    {
                        aintAchPresent = 1;
                        istrACH = "Y";
                    }
                }
                else
                {
                    aintAchPresent = 1;
                    istrACH = "Y";
                }

            }

            #region Payee-0003 Payee-0013 payee-0023
            //Payee-0013 confirm from where this corr will get generated
            if (astrTemplateName == busConstant.REEMPLOYMENT_WITHIN_TWO_MONTHS_OF_RETIREMENT || astrTemplateName == busConstant.CONFIRMATION_OF_ANNUITY_PAYMENT_TO_PAYEE || astrTemplateName == busConstant.RETIREE_INCREASE || astrTemplateName == busConstant.DISABILITY_PENSION_BENEFIT_CONFIRMATION)
            {
                this.istrNextBenefitPaymentDate = busGlobalFunctions.ConvertDateIntoDifFormat(idtNextBenefitPaymentDate); // Payee-0003 Payee-0013 payee-0023
                this.istrPaymentDate = busGlobalFunctions.ConvertDateIntoDifFormat(idtNextBenefitPaymentDate);
                istrMonthYear = Convert.ToString(idtNextBenefitPaymentDate.Year);

                //PIR 977
                istrCurrentDatePlus32Days = string.Format("{0:MMMM d, yyyy}", DateTime.Now.AddDays(32));

                // pir-713                
                if (iclbPayeeAccountRetroPayment != null)
                {
                    foreach (busPayeeAccountRetroPayment lobjPayeeAccountRetroPayment in iclbPayeeAccountRetroPayment)
                    {
                        if (lobjPayeeAccountRetroPayment.icdoPayeeAccountRetroPayment.gross_payment_amount > 0)
                        {
                            idecRetroGrossAmount = lobjPayeeAccountRetroPayment.icdoPayeeAccountRetroPayment.gross_payment_amount;
                        }
                    }
                }
            }
            #endregion

            #region Payee-0004-Payee-0050
            if (astrTemplateName == busConstant.RETIREE_DEATH_NOTIFICATION_OF_NO_CONTINUING_BENEFITS_AND_ACH_REVERSALS_OF_OP || astrTemplateName == busConstant.QDRO_BENEFIT_CONFIRMATION || astrTemplateName == busConstant.IAP_QDRO_PAYMENT_NOTIFICATION || astrTemplateName == busConstant.REJECTION_OF_STATE_TAX || astrTemplateName == busConstant.CONFIRMATION_STATE_CHANGE_LETTER)
            {
                istrIsReclaimedFail = "NA";
                if (this.ibusParticipant.icdoPerson.date_of_death != DateTime.MinValue)
                {
                    DataTable ldtPaymentHistory = Select("cdoPaymentHistoryDetail.GetRetireeDeathPaymentHistoryGrossAmt",
                                    new object[2] { icdoPayeeAccount.payee_account_id, this.ibusParticipant.icdoPerson.date_of_death });

                    if (ldtPaymentHistory.Rows.Count > 0)
                    {
                        //Ticket 83769
                        object grossAmt = ldtPaymentHistory.Rows[0]["GROSS_AMOUNT"];
                        if (grossAmt != DBNull.Value)
                        {
                            this.idecGrossBenefitAmt = Convert.ToDecimal(ldtPaymentHistory.Rows[0]["GROSS_AMOUNT"]);
                            istrMonthEndDate = busGlobalFunctions.ConvertDateIntoDifFormat(busGlobalFunctions.GetLastDayofMonth(this.ibusParticipant.icdoPerson.date_of_death));
                            istrFollowingMonthDate = busGlobalFunctions.ConvertDateIntoDifFormat(busGlobalFunctions.GetFirstDayofMonthAfterGivenDate(this.ibusParticipant.icdoPerson.date_of_death));
                        }
                    }
                }

                DataTable ldtDistributionStatus = Select("cdoPayeeAccount.GetDistributionStatusValue", new object[1] { icdoPayeeAccount.payee_account_id });
                if (ldtDistributionStatus.Rows.Count > 0)
                {
                    string lstrStatus1 = Convert.ToString(ldtDistributionStatus.Rows[0]["DISTRIBUTION_STATUS_VALUE"]);
                    //Ticket# 83769
                    //string lstrStatus2 = Convert.ToString(ldtDistributionStatus.Rows[1]["DISTRIBUTION_STATUS_VALUE"]);

                    //Ticket# 75893
                    //if (lstrStatus1 == "OUTS" && lstrStatus2 == "RCMD")
                    //{
                    //    iblnIsRaclaimedFail = busConstant.BOOL_TRUE;
                    //}
                    istrDistrbutionStatus = lstrStatus1;
                    if (istrDistrbutionStatus != "CNLD" && istrDistrbutionStatus == "OVRP")
                    {
                        //rid 81162                          
                        istrIsReclaimedFail = "Y";
                        Collection<PayeeOverPayment> lclbPayeeOverPayment = new Collection<PayeeOverPayment>();
                        foreach (busPaymentHistoryHeader phh in iclbPaymentHistoryHeader)
                        {
                            if (phh.FindPaymentHistoryHeader(phh.icdoPaymentHistoryHeader.payment_history_header_id))
                            {
                                PayeeOverPayment pop = new PayeeOverPayment();
                                phh.LoadPaymentHistoryDistributions();
                                pop.PaymentHistoryHeaderID = phh.iclbPaymentHistoryDistribution.FirstOrDefault().icdoPaymentHistoryDistribution.payment_history_header_id;
                                pop.PaymentTypeValue = phh.iclbPaymentHistoryDistribution.FirstOrDefault().icdoPaymentHistoryDistribution.distribution_status_value;
                                pop.NetAmount = phh.iclbPaymentHistoryDistribution.FirstOrDefault().icdoPaymentHistoryDistribution.net_amount;
                                lclbPayeeOverPayment.Add(pop);
                            }
                        }

                        //to validate the sorting based on payment history header id.
                        int hid = lclbPayeeOverPayment.Where(x => x.PaymentTypeValue == "OVRP").OrderByDescending(x => x.PaymentHistoryHeaderID).FirstOrDefault().PaymentHistoryHeaderID;
                        idecNetBenefitAmt = lclbPayeeOverPayment.Where(x => x.PaymentTypeValue == "OVRP").OrderByDescending(x => x.PaymentHistoryHeaderID).FirstOrDefault().NetAmount;
                    }
                    if (istrDistrbutionStatus == "RCMD") { istrIsReclaimedFail = "N"; }
                }
                DataTable ldtReportedByName = Select("cdoDeathNotification.GetReportedByName", new object[1] { this.icdoPayeeAccount.person_id });
                if (ldtReportedByName.Rows.Count > 0)
                {
                    istrReportedBy = Convert.ToString(ldtReportedByName.Rows[0]["REPORTED_BY"]);
                    if (istrReportedBy.IsNotNullOrEmpty())
                    {
                        iblnIsReportedBy = busConstant.BOOL_TRUE;
                        istrReportedByInProper = istrReportedBy;
                    }
                }

                busPerson lobjPerson = new busPerson();
                if (lobjPerson.FindPerson(this.ibusPayee.icdoPerson.person_id))
                {
                    lobjPerson.ibusPersonAddress = new busPersonAddress() { icdoPersonAddress = new cdoPersonAddress() };
                    lobjPerson.ibusPersonAddress.LoadActiveAddress(this.ibusPayee.icdoPerson.person_id);
                    lobjPerson.LoadActiveAddressOfMember();
                }

                istrStdPayeeFullName = this.ibusPayee.icdoPerson.istrFullName;
                istrStdPayeeNameInProperCase = this.ibusPayee.icdoPerson.istrFullName;
                istrDOD = lobjPerson.icdoPerson.date_of_death.ToString("MMMM dd, yyyy");

                istrAddress1 = lobjPerson.ibusPersonAddressForCorr.icdoPersonAddress.addr_line_1;
                istrAddress2 = lobjPerson.ibusPersonAddressForCorr.icdoPersonAddress.addr_line_2;
                istrCity1 = lobjPerson.ibusPersonAddressForCorr.icdoPersonAddress.addr_city;
                istrState = lobjPerson.ibusPersonAddressForCorr.icdoPersonAddress.addr_state_value;
                istrZipCode = lobjPerson.ibusPersonAddressForCorr.icdoPersonAddress.addr_country_value == "0001" ? lobjPerson.ibusPersonAddressForCorr.icdoPersonAddress.addr_zip_code : lobjPerson.ibusPersonAddressForCorr.icdoPersonAddress.foreign_postal_code;
                istrZipCode4 = string.IsNullOrEmpty(lobjPerson.ibusPersonAddressForCorr.icdoPersonAddress.addr_zip_4_code) ? "" : "-" + lobjPerson.ibusPersonAddressForCorr.icdoPersonAddress.addr_zip_4_code;
                istrForeignProvince = string.IsNullOrEmpty(lobjPerson.ibusPersonAddressForCorr.icdoPersonAddress.foreign_province) ? "" : "-" + lobjPerson.ibusPersonAddressForCorr.icdoPersonAddress.foreign_province;
                istrFullStateDescription = string.IsNullOrEmpty(lobjPerson.ibusPersonAddressForCorr.icdoPersonAddress.addr_state_description) ? "" : lobjPerson.ibusPersonAddressForCorr.icdoPersonAddress.addr_state_description;
                if (lobjPerson.ibusPersonAddressForCorr.icdoPersonAddress.addr_country_value == "0001")
                {
                    istrPayeeDomesticStateIntlCountry = istrCity1 + " " + istrState + " " + istrZipCode + istrZipCode4;
                    iintPayeeIsUSA = 1;
                }
                else
                {
                    istrCountryDescription = lobjPerson.ibusPersonAddressForCorr.icdoPersonAddress.addr_country_description;
                    istrPayeeDomesticStateIntlCountry = istrCity1 + " " + istrState + " " + istrZipCode + istrForeignProvince;
                    iintPayeeIsUSA = 0;
                }

                istrCountryValue = lobjPerson.ibusPersonAddressForCorr.icdoPersonAddress.addr_country_value;

                //if (ldtReportedByName.Rows[0].ToString()).IsNotNullOrEmpty())
                //    istrReportedBy = Convert.ToString(ldtReportedByName.Rows[0].ToString());                
            }
            #endregion
            #region PAYEE-0057
            if(astrTemplateName == busConstant.ONETIME_PENSION_PAYMENT_LETTER)
            {

                
                busPerson lobjPerson = new busPerson();
                if (lobjPerson.FindPerson(this.ibusPayee.icdoPerson.person_id))
                {
                    lobjPerson.ibusPersonAddress = new busPersonAddress() { icdoPersonAddress = new cdoPersonAddress() };
                    lobjPerson.ibusPersonAddress.LoadActiveAddress(this.ibusPayee.icdoPerson.person_id);
                    lobjPerson.LoadActiveAddressOfMember();
                }

                istrStdPayeeFullName = this.ibusPayee.icdoPerson.istrFullName;
                istrStdPayeeNameInProperCase = this.ibusPayee.icdoPerson.istrFullName;
                istrDOD = lobjPerson.icdoPerson.date_of_death.ToString("MMMM dd, yyyy");

                istrAddress1 = lobjPerson.ibusPersonAddressForCorr.icdoPersonAddress.addr_line_1;
                istrAddress2 = lobjPerson.ibusPersonAddressForCorr.icdoPersonAddress.addr_line_2;
                istrCity1 = lobjPerson.ibusPersonAddressForCorr.icdoPersonAddress.addr_city;
                istrState = lobjPerson.ibusPersonAddressForCorr.icdoPersonAddress.addr_state_value;
                istrZipCode = lobjPerson.ibusPersonAddressForCorr.icdoPersonAddress.addr_country_value == "0001" ? lobjPerson.ibusPersonAddressForCorr.icdoPersonAddress.addr_zip_code : lobjPerson.ibusPersonAddressForCorr.icdoPersonAddress.foreign_postal_code;
                istrZipCode4 = string.IsNullOrEmpty(lobjPerson.ibusPersonAddressForCorr.icdoPersonAddress.addr_zip_4_code) ? "" : "-" + lobjPerson.ibusPersonAddressForCorr.icdoPersonAddress.addr_zip_4_code;
                istrForeignProvince = string.IsNullOrEmpty(lobjPerson.ibusPersonAddressForCorr.icdoPersonAddress.foreign_province) ? "" : "-" + lobjPerson.ibusPersonAddressForCorr.icdoPersonAddress.foreign_province;
                istrFullStateDescription = string.IsNullOrEmpty(lobjPerson.ibusPersonAddressForCorr.icdoPersonAddress.addr_state_description) ? "" : lobjPerson.ibusPersonAddressForCorr.icdoPersonAddress.addr_state_description;
                if (lobjPerson.ibusPersonAddressForCorr.icdoPersonAddress.addr_country_value == "0001")
                {
                    istrPayeeDomesticStateIntlCountry = istrCity1 + " " + istrState + " " + istrZipCode + istrZipCode4;
                    iintPayeeIsUSA = 1;
                }
                else
                {
                    istrCountryDescription = lobjPerson.ibusPersonAddressForCorr.icdoPersonAddress.addr_country_description;
                    istrPayeeDomesticStateIntlCountry = istrCity1 + " " + istrState + " " + istrZipCode + istrForeignProvince;
                    iintPayeeIsUSA = 0;
                }

                istrCountryValue = lobjPerson.ibusPersonAddressForCorr.icdoPersonAddress.addr_country_value;

            }
           




            #endregion
            #region Payee-0004 Payee-0013
            if (astrTemplateName == busConstant.RETIREE_DEATH_NOTIFICATION_OF_NO_CONTINUING_BENEFITS_AND_ACH_REVERSALS_OF_OP || astrTemplateName == busConstant.CONFIRMATION_OF_ANNUITY_PAYMENT_TO_PAYEE)
            {
                istrPaymentDate = busGlobalFunctions.ConvertDateIntoDifFormat(idtLastBenefitPaymentDate.AddMonths(1).AddDays(-1));
            }
            #endregion
            #region Payee-0047
            //Ticket#97167

            if (astrTemplateName == busConstant.CONVERT_MD_TO_RD_CONF_LETTER)
            {
                DataTable ldtbSubTyppVal = busBase.Select("cdoPayeeAccount.CheckIfMDApplicationExists", new object[1] { this.icdoPayeeAccount.person_id });
                if (ldtbSubTyppVal.Rows.Count > 0)
                {
                    if (Convert.ToString(ldtbSubTyppVal.Rows[0][0]) == "N")
                    {
                        aintmdflag = 1;
                    }
                    else
                    {
                        aintmdflag = 0;
                    }
                }

            }
            #endregion

            #region Payee-0005--Payee-0050
            if (astrTemplateName == busConstant.CONFIRMATION_LETTER || astrTemplateName == busConstant.CONVERT_MD_TO_RD_CONF_LETTER || astrTemplateName == busConstant.MINIMUM_DISTRIBUTION_BENEFIT_CONFIRMATION || astrTemplateName == busConstant.DISABILITY_PENSION_BENEFIT_CONFIRMATION || astrTemplateName == busConstant.QDRO_BENEFIT_CONFIRMATION ||
                astrTemplateName == busConstant.DEATH_POST_RETIREMENT_LIFE_ANNUNITY)
            {
                if (ldtRetirementDate != DateTime.MinValue)
                {
                    //PIR-599
                    this.istrBenefirBeginDate = busGlobalFunctions.ConvertDateIntoDifFormat(ldtRetirementDate.AddMonths(2));
                    this.istrBenefirBeginDate = String.Format("{0:MMMM dd, yyyy}", this.istrBenefirBeginDate);
                    this.istrRetirementMonthYear = ldtRetirementDate.ToString("MMMM") + "  " + ldtRetirementDate.Year;
                    DateTime ldtNextMonthAfterRetirementDate = ldtRetirementDate.AddMonths(1);
                    this.istrNextMonthAfterRetirementDate = ldtNextMonthAfterRetirementDate.ToString("MMMM") + "  " + ldtNextMonthAfterRetirementDate.Year;
                }
                LoadPayeeAccountAchDetails();
                istrACH = "N";
                if (!iclbPayeeAccountAchDetail.IsNullOrEmpty())
                {
                    //UAT PIR 1173
                    //iclbPayeeAccountAchDetail = (from item in this.iclbPayeeAccountAchDetail
                    //                             where busGlobalFunctions.CheckDateOverlapping(idtNextBenefitPaymentDate,
                    //                             item.icdoPayeeAccountAchDetail.ach_start_date, item.icdoPayeeAccountAchDetail.ach_end_date)
                    //                             select item).ToList().ToCollection<busPayeeAccountAchDetail>();
                    iclbPayeeAccountAchDetail = this.iclbPayeeAccountAchDetail.AsEnumerable().Where(o => (o.icdoPayeeAccountAchDetail.ach_end_date == DateTime.MinValue ||
                                    o.icdoPayeeAccountAchDetail.ach_end_date >= idtNextBenefitPaymentDate) && (o.icdoPayeeAccountAchDetail.pre_note_completion_date != DateTime.MinValue ||
                                    o.icdoPayeeAccountAchDetail.pre_note_flag == busConstant.Flag_Yes)).ToList().ToCollection<busPayeeAccountAchDetail>();
                    if (iclbPayeeAccountAchDetail.Count > 0)
                    {
                        aintAchPresent = 0;
                        istrACH = "N";
                    }
                    else
                    {
                        aintAchPresent = 1;
                        istrACH = "Y";
                    }
                }
                else
                {
                    aintAchPresent = 1;
                    istrACH = "Y";
                }
                if (iclbWithholdingInformation == null)
                {
                    iclbWithholdingInformation = new Collection<busWithholdingInformation>();
                    LoadWithholdingInformation();

                }
                if (iclbWithholdingInformation.Count > 0)
                {
                    aintWithHoldingPresent = 1;
                }
                busBenefitApplicationDetail lbusBenefitApplicationDetail = new busBenefitApplicationDetail() { icdoBenefitApplicationDetail = new cdoBenefitApplicationDetail() };
                if (lbusBenefitApplicationDetail.FindBenefitApplicationDetail(this.icdoPayeeAccount.benefit_application_detail_id))
                {
                    this.ibusBenefitApplication = new busBenefitApplication { icdoBenefitApplication = new cdoBenefitApplication() };

                    if (this.ibusBenefitApplication.FindBenefitApplication(lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.benefit_application_id))
                    {
                        this.ibusBenefitApplication.ibusPerson = new busPerson { icdoPerson = new cdoPerson() };
                        this.ibusBenefitApplication.ibusPerson.FindPerson(ibusBenefitApplication.icdoBenefitApplication.person_id);
                        this.ibusBenefitApplication.LoadBenefitApplicationDetails();

                        foreach (var lplanbenefitdetailId in this.ibusBenefitApplication.iclbBenefitApplicationDetail)
                        {
                            this.LoadPlanBenefitsForPlan(lplanbenefitdetailId.iintPlan_ID);

                            if (this.iclbcdoPlanBenefit.Where(i => i.icdoPlanBenefitXr.plan_id == 1 && i.icdoPlanBenefitXr.plan_benefit_id == lplanbenefitdetailId.icdoBenefitApplicationDetail.plan_benefit_id).Count() > 0)
                            {
                                strBenefitOptionValueIAP = this.iclbcdoPlanBenefit.Where(i => i.icdoPlanBenefitXr.plan_id == 1 && i.icdoPlanBenefitXr.plan_benefit_id == lplanbenefitdetailId.icdoBenefitApplicationDetail.plan_benefit_id).Select(y => y.icdoPlanBenefitXr.benefit_option_description).SingleOrDefault();
                                aintIAPPlan = lplanbenefitdetailId.iintPlan_ID;
                            }
                        }
                    }
                }


            }
            #endregion

            #region Payee-0006
            if (astrTemplateName == busConstant.IAP_OUTSTANDING_CHECKS)
            {

                GetCollectionPayemntHistoryDistributionDetails(astrTemplateName);
            }
            #endregion

            #region Payee-0007
            // this corr cannot be generated from OPUS (third party will handle it) as per kunal
            if (astrTemplateName == busConstant.NOTIFICATION_OF_ANNUITY_PURCHASE_TO_INSURANCE_AGENCY)
            {

                GetPayemntHistoryDistributionDetails();
                if (this.icdoPayeeAccount.transfer_org_id != 0 || this.icdoPayeeAccount.transfer_org_id.IsNotNull())
                {
                    if (ibusOrganization == null)
                    {
                        ibusOrganization = new busOrganization { icdoOrganization = new cdoOrganization() };
                    }
                    if (this.ibusOrganization.FindOrganization(this.icdoPayeeAccount.transfer_org_id))
                    {
                        this.istrTransferOrgContactName = this.ibusOrganization.icdoOrganization.org_name;
                    }

                }
                if (this.icdoPayeeAccount.transfer_org_id == 0 || this.icdoPayeeAccount.transfer_org_id.IsNull())
                {
                    if (!string.IsNullOrEmpty(this.icdoPayeeAccount.istrPayeeName))
                        this.istrRecepientNameInProperCase = this.icdoPayeeAccount.istrPayeeName;

                }
                else
                {
                    this.istrRecepientNameInProperCase = this.icdoPayeeAccount.transfer_org_contact_name.ToProperCase();
                }
                if (!string.IsNullOrEmpty(this.icdoPayeeAccount.istrBenefitOption) && !string.IsNullOrEmpty(this.icdoPayeeAccount.istrBenefitOptionValue))
                {
                    if (HelperUtil.GetData1ByCodeValue(busConstant.BENEFIT_OPTION_CODE_ID, this.icdoPayeeAccount.istrBenefitOptionValue) == "JS")
                    {
                        this.icdoPayeeAccount.istrBenefitOptionValueData = 1;
                    }


                    if (this.icdoPayeeAccount.istrBenefitOptionValue != busConstant.JOINT_50_PERCENT_SURVIVOR_ANNUITY)
                    {
                        this.icdoPayeeAccount.istrBenefitOptionJNS50 = "N";
                        this.idecFinalMonthlyBenefit = 0.0M;
                    }
                    else
                    {
                        if (this.idecGrossBenefitAmount > 0)
                            this.idecFinalMonthlyBenefit = this.idecGrossBenefitAmount;
                    }


                    if (this.icdoPayeeAccount.istrBenefitOptionValue != busConstant.JOINT_50_PERCENT_SURVIVOR_ANNUITY && (this.icdoPayeeAccount.istrBenefitOptionValue == busConstant.LIFE_ANNUTIY || this.icdoPayeeAccount.istrBenefitOptionValue == busConstant.TEN_YEARS_CERTAIN_AND_LIFE_ANNUTIY) && this.ibusParticipant.icdoPerson.marital_status_value == "M")
                    {
                        aintSpouseConsent = 1;

                    }


                }
                if (ibusPayeeBenefitAccount.icdoPayeeBenefitAccount.gross_amount > 0)
                    idecIAPAmount = ibusPayeeBenefitAccount.icdoPayeeBenefitAccount.gross_amount;

                //if (!string.IsNullOrEmpty(this.icdoPayeeAccount.istrBenefitOptionValue) && this.icdoPayeeAccount.istrBenefitOptionValue == busConstant.JOINT_50_PERCENT_SURVIVOR_ANNUITY)
                //{

                //}
            }
            #endregion
            #region PAYEE-0038
            //Ticket#87536
            if (astrTemplateName == busConstant.DISABILITY_PENSION_BENEFIT_CONFIRMATION)
            {
                //if (ibusPayeeBenefitAccount.icdoPayeeBenefitAccount.gross_amount > 0)
                //    idecIAPAmount = ibusPayeeBenefitAccount.icdoPayeeBenefitAccount.gross_amount;
                DataTable ldtbGetPersonAcntId = busBase.Select("cdoPersonAccount.GetPersonAccountID", new object[2] { busConstant.IAP_PLAN_ID, this.icdoPayeeAccount.person_id });
                if (ldtbGetPersonAcntId.Rows.Count > 0)
                {
                    var lPersonAcntId = ldtbGetPersonAcntId.Rows[0][0];
                    DataTable ldtbIAPbalance = busBase.Select("cdoPersonAccountRetirementContribution.GetIAPBalance", new object[1] { lPersonAcntId });
                    if (ldtbIAPbalance.Rows.Count > 0)
                    {
                        if (Convert.ToDecimal(ldtbIAPbalance.Rows[0][0]) > 0)
                        {
                            aintIAPflg = 1;

                        }
                        else
                        {
                            aintIAPflg = 0;
                        }


                    }

                }

            }
            #endregion
            #region PAYEE-0008
            if (astrTemplateName == busConstant.NOTIFICATION_OF_HOURS_LETTER_TO_PAYEE)
            {
                // for getting IAP Hours for quarterly allocation
                LoadLocalMPIHours();
            }
            #endregion

            #region Payee-0011
            if (astrTemplateName == busConstant.RETIREMENT_AFFIDAVIT_COVER_LETTER)
            {
                RetirementAffidavitCoverLetter();

            }
            #endregion

            #region Payee-0012
            if (astrTemplateName == busConstant.DISABILITY_RETIREMENT_CONVERSION_CONFIRMATION_LETTER)
            {
                busBenefitApplicationDetail lbusBenefitApplicationDetail = new busBenefitApplicationDetail() { icdoBenefitApplicationDetail = new cdoBenefitApplicationDetail() };
                if (lbusBenefitApplicationDetail.FindBenefitApplicationDetail(this.icdoPayeeAccount.benefit_application_detail_id))
                {
                    this.ibusBenefitApplication = new busBenefitApplication { icdoBenefitApplication = new cdoBenefitApplication() };
                    if (this.ibusBenefitApplication.FindBenefitApplication(lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.benefit_application_id))
                    {
                        if (this.ibusBenefitApplication.icdoBenefitApplication.disability_conversion_date != DateTime.MinValue)
                        {
                            this.ibusBenefitApplication.iblnDisConvDate = true;
                            istrDisabilityConvDate = busGlobalFunctions.ConvertDateIntoDifFormat(this.ibusBenefitApplication.icdoBenefitApplication.disability_conversion_date);
                        }
                    }
                }
            }
            #endregion


            //#region PAYEE-0043
            //if (astrTemplateName == busConstant.CONVERT_TO_LIFE_ANNUNITY_LETTER)
            //{
            //    // this.FindPayeeAccount(this.ibusBenefitCalculationHeader.icdoBenefitCalculationHeader.payee_account_id);


            //    busBenefitApplicationDetail lbusBenefitApplicationDetail = new busBenefitApplicationDetail() { icdoBenefitApplicationDetail = new cdoBenefitApplicationDetail() };
            //    if (lbusBenefitApplicationDetail.FindBenefitApplicationDetail(this.icdoPayeeAccount.benefit_application_detail_id))
            //    {
            //        this.ibusBenefitApplication = new busBenefitApplication { icdoBenefitApplication = new cdoBenefitApplication() };

            //        if (this.ibusBenefitApplication.FindBenefitApplication(lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.benefit_application_id))
            //        {
            //            this.ibusBenefitApplication.LoadBenefitApplicationDetails();

            //            foreach (var _benefitApplicationdetail in this.ibusBenefitApplication.iclbBenefitApplicationDetail)
            //            {
            //                this.icdoPayeeAccount.istrBenefitOption = _benefitApplicationdetail.istrPlanBenefitDescription;
            //            }

            //            this.ibusBenefitApplication.ibusPerson = new busPerson { icdoPerson = new cdoPerson() };
            //            this.ibusBenefitApplication.ibusPerson.FindPerson(ibusBenefitApplication.icdoBenefitApplication.person_id);

            //            istrAnnunityName = this.ibusBenefitApplication.ibusPerson.icdoPerson.first_name + " " + this.ibusBenefitApplication.ibusPerson.icdoPerson.last_name;
            //            istrAnnunityName = istrAnnunityName.ToProperCase();

            //            LoadBreakDownDetails();
            //    }
            //}
            //#endregion

            #region Payee-0013
            if (astrTemplateName == busConstant.CONFIRMATION_OF_ANNUITY_PAYMENT_TO_PAYEE)
            {
                //if (this.icdoPayeeAccount.transfer_org_id != 0 || this.icdoPayeeAccount.transfer_org_id.IsNotNull())
                //{
                //if (!string.IsNullOrEmpty(icdoPayeeAccount.transfer_org_contact_name))
                //    this.istrTransferOrgContactName = icdoPayeeAccount.transfer_org_contact_name;
                this.ibusOrganization = new busOrganization { icdoOrganization = new cdoOrganization() };




                //  this.istrTransferOrgContactName = istrRolloverOrgName;
                if (this.icdoPayeeAccount.transfer_org_id != 0 || this.icdoPayeeAccount.transfer_org_id.IsNotNull())
                {
                    if (this.ibusOrganization.FindOrganization(this.icdoPayeeAccount.transfer_org_id))
                    {
                        this.istrTransferOrgContactName = this.ibusOrganization.icdoOrganization.org_name;
                    }
                }
                //  }
                GetPayemntHistoryDistributionDetails();
                istrRetroStartDate = this.istrRetirementDate;
            }
            #endregion

            #region Payee-0015
            // confirm from where this corr will get generated
            if (astrTemplateName == busConstant.ROLLOVER_VERIFICATION_FORM)
            {
                RolloverVerification();

            }
            #endregion

            #region PAYEE-0016
            if (astrTemplateName == busConstant.VERIFICATION_OF_HOURS_LETTER_TO_EMPLOYER)
            {
                // for getting IAP Hours and Ending Date 
                LoadLocalMPIHours();
            }
            #endregion

            #region RETR-0042
            if (astrTemplateName == busConstant.IAP_ANNUITY_QUOTE_CONFIRMATION_OF_ANNUITY_PAYMENT_TO_PAYEE)
            {
                RolloverVerification();
                this.istrNextBenefitPaymentDate = busGlobalFunctions.ConvertDateIntoDifFormat(idtNextBenefitPaymentDate);
                LoadBreakDownDetails();
                //Ticket#129961
                if (idecNextGrossPaymentRollOver == 0)
                {
                    //Ticket#129961
                    idecPaymentHistoryDetailGrossAmount = idecNextGrossPaymentACH; //this.ibusPayeeBenefitAccount.icdoPayeeBenefitAccount.gross_amount;
                }
                else
                {
                    idecPaymentHistoryDetailGrossAmount = idecNextGrossPaymentRollOver;
                }

                if (this.iclbPayeeAccountRolloverDetail.Where(i => i.icdoPayeeAccountRolloverDetail.status_value == "ACTV").Count() > 0)
                {
                    istrRolloverOrgName = this.iclbPayeeAccountRolloverDetail.Where(i => i.icdoPayeeAccountRolloverDetail.status_value == "ACTV").Select(y => y.istrPayableTo).SingleOrDefault();


                }
                else
                {
                    istrRolloverOrgName = "";

                }

                if (this.ibusPayeeBenefitAccount.icdoPayeeBenefitAccount.funds_type_value.IsNotNullOrEmpty())
                {
                    istrFundTypeorPlanCode = this.ibusPayeeBenefitAccount.icdoPayeeBenefitAccount.funds_type_description;

                }
                else
                {
                    //Ticket#129961
                    istrFundTypeorPlanCode = this.icdoPayeeAccount.istrPlanCode;

                }
                //Ticket#140460 
                if (this.ibusPayee == null && this.icdoPayeeAccount.org_id > 0)
                {
                    if (this.ibusOrganization.FindOrganization(this.icdoPayeeAccount.org_id))
                    {
                        this.istrPayeeFullName = this.ibusOrganization.icdoOrganization.org_name;
                    }
                }
                else
                {
                    this.istrPayeeFullName = this.ibusPayee.icdoPerson.first_name + " " + this.ibusPayee.icdoPerson.last_name;
                }


            }
            #endregion

            #region RETR-0015
            if (astrTemplateName == busConstant.RETIREE_DEATH_LETTER_TO_SURVIVING_SPOUSE_TO_START_ANNUITY)
            {
                if (this.ibusParticipant.icdoPerson.date_of_death != DateTime.MinValue)
                {
                    istrDOD = ibusParticipant.icdoPerson.date_of_death.ToString("MMMM dd, yyyy");
                }
                if (icdoPayeeAccount.istrBenefitOptionValue.Contains("50"))
                    istrBenefitOptionPercent = "50%";
                else if (icdoPayeeAccount.istrBenefitOptionValue.Contains("75"))
                    istrBenefitOptionPercent = "75%";
                else if (icdoPayeeAccount.istrBenefitOptionValue.Contains("100"))
                    istrBenefitOptionPercent = "100%";
            }
            #endregion

            #region Payee-0017 or DRO-0020

            //from where this corr will get generated
            if (astrTemplateName == busConstant.IRS_LEVY || astrTemplateName == busConstant.QDRO_FOR_SUPPORT)
            {
                if (!this.iclbPayeeAccountPaymentItemType.IsNullOrEmpty())
                {
                    if (this.iclbPaymentItemType.IsNullOrEmpty())
                    {
                        this.LoadPaymentItemType();
                    }

                    if (astrTemplateName == busConstant.IRS_LEVY)
                    {
                        this.iclbPayeeAccountPaymentItemType = (from item in this.iclbPayeeAccountPaymentItemType
                                                                where item.icdoPayeeAccountPaymentItemType.payment_item_type_id ==
                                                                this.iclbPaymentItemType.Where(o => o.icdoPaymentItemType.item_type_code == busConstant.ITEM41).FirstOrDefault().icdoPaymentItemType.payment_item_type_id
                                                                select item).ToList().ToCollection<busPayeeAccountPaymentItemType>();

                        if (this.iclbPayeeAccountPaymentItemType.Count > 0)
                        {
                            idecLevyAmount = this.iclbPayeeAccountPaymentItemType.First().icdoPayeeAccountPaymentItemType.amount;
                            idecDefaultPayment = idecGrossAmount - idecLevyAmount;
                        }
                    }
                    else
                    {
                        this.iclbPayeeAccountPaymentItemType = (from item in this.iclbPayeeAccountPaymentItemType
                                                                where item.icdoPayeeAccountPaymentItemType.payment_item_type_id ==
                                                                this.iclbPaymentItemType.Where(o => o.icdoPaymentItemType.item_type_code == busConstant.ITEM42).FirstOrDefault().icdoPaymentItemType.payment_item_type_id
                                                                select item).ToList().ToCollection<busPayeeAccountPaymentItemType>();

                        foreach (busPayeeAccountPaymentItemType lbusPayeeAccountPaymentItemType in this.iclbPayeeAccountPaymentItemType)
                        {
                            if ((idtNextBenefitPaymentDate >= lbusPayeeAccountPaymentItemType.icdoPayeeAccountPaymentItemType.start_date &&
                                                            (lbusPayeeAccountPaymentItemType.icdoPayeeAccountPaymentItemType.end_date == DateTime.MinValue ||
                                                            idtNextBenefitPaymentDate < lbusPayeeAccountPaymentItemType.icdoPayeeAccountPaymentItemType.end_date)) ||
                                                            (idtNextBenefitPaymentDate <= lbusPayeeAccountPaymentItemType.icdoPayeeAccountPaymentItemType.start_date && (lbusPayeeAccountPaymentItemType.icdoPayeeAccountPaymentItemType.end_date == DateTime.MinValue ||
                                                                lbusPayeeAccountPaymentItemType.icdoPayeeAccountPaymentItemType.start_date != lbusPayeeAccountPaymentItemType.icdoPayeeAccountPaymentItemType.end_date)))
                            {
                                idecDefaultPayment = lbusPayeeAccountPaymentItemType.icdoPayeeAccountPaymentItemType.amount;
                                break;
                            }
                        }
                    }
                }
            }
            #endregion

            idecMonthlyBenefitPlusRetroActive = idecNextGrossPaymentACH + idecRetroAdjustmentAmount;

            #region PAYEE-0036 & PAYEE-0037
            if (astrTemplateName == "PAYEE-0037" || astrTemplateName == "PAYEE-0036" || astrTemplateName == "PAYEE-0038")
            {
                this.ibusParticipant.LoadCorrAddress();
            }
            #endregion
            //Ticket 75270 & 75865
            //Ticket#122350
            if (astrTemplateName == busConstant.DEATH_POST_RETIREMENT_LIFE_ANNUNITY || astrTemplateName == busConstant.CONVERT_TO_LIFE_ANNUNITY_LETTER || astrTemplateName == busConstant.MINIMUM_DISTRIBUTION_BENEFIT_CONFIRMATION || astrTemplateName == busConstant.QDRO_BENEFIT_CONFIRMATION)
            {

                if (astrTemplateName == busConstant.DEATH_POST_RETIREMENT_LIFE_ANNUNITY || astrTemplateName == busConstant.MINIMUM_DISTRIBUTION_BENEFIT_CONFIRMATION || astrTemplateName == busConstant.QDRO_BENEFIT_CONFIRMATION)
                {
                    GetPayeeDemographicDetails();
                    istrRetro = "N";
                    if (idecRetroAdjustmentAmount > 0)
                    {
                        istrCheckPayeeRetroAdjustAmount = "Y";
                        istrRetro = "Y";
                    }
                }
                busBenefitApplicationDetail lbusBenefitApplicationDetail = new busBenefitApplicationDetail() { icdoBenefitApplicationDetail = new cdoBenefitApplicationDetail() };
                if (lbusBenefitApplicationDetail.FindBenefitApplicationDetail(this.icdoPayeeAccount.benefit_application_detail_id))
                {
                    this.ibusBenefitApplication = new busBenefitApplication { icdoBenefitApplication = new cdoBenefitApplication() };

                    if (this.ibusBenefitApplication.FindBenefitApplication(lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.benefit_application_id))
                    {
                        this.ibusBenefitApplication.ibusPerson = new busPerson { icdoPerson = new cdoPerson() };
                        this.ibusBenefitApplication.ibusPerson.FindPerson(ibusBenefitApplication.icdoBenefitApplication.person_id);
                        this.ibusBenefitApplication.LoadBenefitApplicationDetails();

                        istrIAP = "N";
                        foreach (var lbenefitApplicationdetail in this.ibusBenefitApplication.iclbBenefitApplicationDetail)
                        {
                            if (lbenefitApplicationdetail.iintPlan_ID == this.icdoPayeeAccount.iintPlanId)
                            {
                                this.icdoPayeeAccount.istrBenefitOption = lbenefitApplicationdetail.istrPlanBenefitDescription;
                                istrAnnunityName = lbenefitApplicationdetail.icdoBenefitApplicationDetail.istrFullName;
                            }
                            if (lbenefitApplicationdetail.iintPlan_ID == busConstant.IAP_PLAN_ID)
                            {
                                istrIAP = "Y";  //rid 69692
                            }
                        }

                        if (astrTemplateName == busConstant.DEATH_POST_RETIREMENT_LIFE_ANNUNITY)
                        {
                            istrAnnunityName = this.ibusBenefitApplication.ibusPerson.icdoPerson.first_name + " " + this.ibusBenefitApplication.ibusPerson.icdoPerson.last_name;
                            istrAnnunityName = istrAnnunityName.ToProperCase();
                        }

                        istrRetroStartDate = this.icdoPayeeAccount.benefit_begin_date.ToShortDateString();
                    }

                    LoadBreakDownDetails();
                }



            }

            #region Payee-0022
            // confirm from where this corr will get generated
            if (astrTemplateName == busConstant.REPAYMENT_SCHEDULE)
            {
                busBenefitApplicationDetail lbusBenefitApplicationDetail = new busBenefitApplicationDetail() { icdoBenefitApplicationDetail = new cdoBenefitApplicationDetail() };
                if (lbusBenefitApplicationDetail.FindBenefitApplicationDetail(this.icdoPayeeAccount.benefit_application_detail_id))
                {
                    this.ibusBenefitApplication = new busBenefitApplication { icdoBenefitApplication = new cdoBenefitApplication() };
                    if (this.ibusBenefitApplication.FindBenefitApplication(lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.benefit_application_id))
                    {
                        this.idtOriginalRetirementDate = this.ibusBenefitApplication.icdoBenefitApplication.retirement_date;
                        this.idtMinimumDistributionDate = this.ibusBenefitApplication.icdoBenefitApplication.min_distribution_date;
                        this.idtAdjustedRetirementDate = this.ibusBenefitApplication.icdoBenefitApplication.retirement_date;
                    }
                }

                if (!this.iclbPayeeAccountRetroPayment.IsNullOrEmpty())
                {
                    this.idtPaymentAdjustmentDate = this.iclbPayeeAccountRetroPayment.First().icdoPayeeAccountRetroPayment.start_date;

                }

                decimal ldecEEContributionAmt = busConstant.ZERO_DECIMAL; ;
                decimal ldecEEIntAmt = busConstant.ZERO_DECIMAL;
                decimal ldecTotalAmount = busConstant.ZERO_DECIMAL;
                int lintPersonId = busConstant.ZERO_INT;
                DateTime ldtDOB;
                decimal ldecAgeIndec = busConstant.ZERO_DECIMAL;
                decimal ldecEEDerivedBenefit = busConstant.ZERO_DECIMAL;




                if (!iclbPayeeAccountBenefitOverpayment.IsNullOrEmpty())
                {
                    if (this.icdoPayeeAccount.nontaxable_beginning_balance > 0 || this.icdoPayeeAccount.remaining_non_taxable_from_conversion > 0)
                    {
                        DataTable ldtbEEAmtAndEEContribution = busBase.Select("cdoPayeeAccount.GetEEAmtAndEEContribution", new object[1] { this.icdoPayeeAccount.payee_account_id });
                        if (ldtbEEAmtAndEEContribution.Rows.Count > 0 && ldtbEEAmtAndEEContribution.Rows[0][0] != DBNull.Value)
                        {
                            ldecEEContributionAmt = Convert.ToDecimal(ldtbEEAmtAndEEContribution.Rows[0]["EE_CONTRIBUTION_AMOUNT"]);
                            ldecEEIntAmt = Convert.ToDecimal(ldtbEEAmtAndEEContribution.Rows[0]["EE_INT_AMOUNT"]);
                            ldecTotalAmount = ldecEEContributionAmt + ldecEEIntAmt;
                            lintPersonId = Convert.ToInt32(ldtbEEAmtAndEEContribution.Rows[0]["PERSON_ID"]);
                        }
                        busPerson lbusPerson = new busPerson();
                        lbusPerson.FindPerson(lintPersonId);
                        ldtDOB = Convert.ToDateTime(lbusPerson.icdoPerson.date_of_birth.ToString());
                        ldecAgeIndec = busGlobalFunctions.CalculatePersonAgeInDec(ldtDOB, ldtRetirementDate);

                        ldecEEDerivedBenefit = GetEEDerivedBenefit(ldecTotalAmount, ldecAgeIndec, ldtRetirementDate);


                    }

                    #region Load Hours
                    utlConnection utlLegacyDBConnetion = HelperFunction.GetDBConnectionProperties("Legacy");
                    string lstrLegacyDBConnetion = utlLegacyDBConnetion.istrConnectionString;

                    SqlParameter[] lsqlParameters = new SqlParameter[2];
                    SqlParameter param1 = new SqlParameter("@SSN", DbType.String);
                    SqlParameter param2 = new SqlParameter("@RETIREMENT_DATE", DbType.DateTime);

                    param1.Value = this.ibusPayee.icdoPerson.ssn;
                    lsqlParameters[0] = param1;

                    param2.Value = ldtRetirementDate;
                    lsqlParameters[1] = param2;

                    DateTime ldtLastWorkingDate = new DateTime();
                    string lstrEmpName = string.Empty;

                    Dictionary<int, Dictionary<int, decimal>> ldictHoursAfterRetirement = new Dictionary<int, Dictionary<int, decimal>>();
                    ldictHoursAfterRetirement = ibusCalculation.LoadMPIHoursAfterRetirementDate(this.ibusPayee.icdoPerson.ssn, ldtRetirementDate, icdoPayeeAccount.iintPlanId, ref ldtLastWorkingDate, ref lstrEmpName);
                    this.istrEmployerName = lstrEmpName;
                    #endregion


                    if (!iclbPayeeAccountBenefitOverpayment.First().iclbRepaymentSchedule.IsNullOrEmpty())
                    {

                        idecOverPaymentRepaid = iclbPayeeAccountBenefitOverpayment.First().iclbRepaymentSchedule.First().icdoRepaymentSchedule.reimbursement_amount_paid;
                        idtEstimatedEndDate = iclbPayeeAccountBenefitOverpayment.First().iclbRepaymentSchedule.Last().icdoRepaymentSchedule.estimated_end_date;
                        iclbPayeeAccountBenefitOverpayment.First().LoadRepaymentScheduleForCorr(ldecEEDerivedBenefit, idecNextGrossPaymentACH, ldictHoursAfterRetirement, this.ibusPayee);
                        if (iclbPayeeAccountBenefitOverpayment.First().iclbRepaymentSchedule.Count() > 0)
                        {
                            idecFlatPercent = (from item in iclbPayeeAccountBenefitOverpayment.First().iclbRepaymentSchedule
                                               select item.icdoRepaymentSchedule.idecFlatPercent).First();

                            idecMonthlyAmtOfReduction = (from item in iclbPayeeAccountBenefitOverpayment.First().iclbRepaymentSchedule
                                                         select item.icdoRepaymentSchedule.idecMonthlyAmtOfReduction).First();

                            idecSumEEDerived = (from item in iclbPayeeAccountBenefitOverpayment.First().iclbRepaymentSchedule
                                                select item.icdoRepaymentSchedule.idecEEDerived).Sum();

                            idecSumERDerived = (from item in iclbPayeeAccountBenefitOverpayment.First().iclbRepaymentSchedule
                                                select item.icdoRepaymentSchedule.idecERDerived).Sum();

                            idecSumTotal = (from item in iclbPayeeAccountBenefitOverpayment.First().iclbRepaymentSchedule
                                            select item.icdoRepaymentSchedule.idecTotal).Sum();

                            idecSumPayableForTheMonth = (from item in iclbPayeeAccountBenefitOverpayment.First().iclbRepaymentSchedule
                                                         select item.icdoRepaymentSchedule.idecPayableForTheMonth).Sum();

                            idecSumReimbrAmtInCurrentMonth = (from item in iclbPayeeAccountBenefitOverpayment.First().iclbRepaymentSchedule
                                                              select item.icdoRepaymentSchedule.idecReimbrAmtInCurrentMonth).Sum();
                        }

                    }

                    iclbPayeeAccountBenefitOverpayment.First().LoadBenefitMonthwiseAdjustmentDetailForCorr(ldecEEDerivedBenefit);

                    this.idecSumEEDerivedShudHvPaid = (from item in iclbPayeeAccountBenefitOverpayment.First().iclbBenefitMonthwiseAdjustmentDetail
                                                       select item.icdoBenefitMonthwiseAdjustmentDetail.idecEEDerivedShouldHavePaid).Sum();
                    this.idecSumERDerivedShudHvPaid = (from item in iclbPayeeAccountBenefitOverpayment.First().iclbBenefitMonthwiseAdjustmentDetail
                                                       select item.icdoBenefitMonthwiseAdjustmentDetail.idecERDerivedShouldHavePaid).Sum();

                    this.idecSumTotalShudHvPaid = (from item in iclbPayeeAccountBenefitOverpayment.First().iclbBenefitMonthwiseAdjustmentDetail
                                                   select item.icdoBenefitMonthwiseAdjustmentDetail.idecTotalShouldHavePaid).Sum();

                    this.idecSumActuallyPaidForMonth = (from item in iclbPayeeAccountBenefitOverpayment.First().iclbBenefitMonthwiseAdjustmentDetail
                                                        select item.icdoBenefitMonthwiseAdjustmentDetail.idecAcctualPaidForTheMonth).Sum();

                    this.idecSumOverUnderPaymentPerMonth = (from item in iclbPayeeAccountBenefitOverpayment.First().iclbBenefitMonthwiseAdjustmentDetail
                                                            select item.icdoBenefitMonthwiseAdjustmentDetail.idecOverUnderPaymentPerMonth).Sum();


                    idecGrandTotal = idecSumTotalShudHvPaid + idecSumTotal;
                    idecGrandTotalPayableForMonth = idecSumActuallyPaidForMonth + idecSumPayableForTheMonth;
                    idecGrandTotalReimbrAmt = idecSumOverUnderPaymentPerMonth - idecSumReimbrAmtInCurrentMonth;
                }

            }

            #endregion

            #region Payee-0025
            // confirm from where this corr will get generated
            if (astrTemplateName == busConstant.NOTIFICATION_OF_CHANGE_ACH)
            {
                LoadPayeeAccountAchDetails();
                if (!iclbPayeeAccountAchDetail.IsNullOrEmpty())
                {
                    iclbPayeeAccountAchDetail = (from item in this.iclbPayeeAccountAchDetail
                                                 where busGlobalFunctions.CheckDateOverlapping(idtNextBenefitPaymentDate,
                                                 item.icdoPayeeAccountAchDetail.ach_start_date, item.icdoPayeeAccountAchDetail.ach_end_date)
                                                 select item).ToList().ToCollection<busPayeeAccountAchDetail>();

                    istrAccountNumber = iclbPayeeAccountAchDetail.Select(o => o.icdoPayeeAccountAchDetail.account_number).FirstOrDefault();
                    iintRoutingNumber = iclbPayeeAccountAchDetail.Select(o => o.icdoPayeeAccountAchDetail.iintRoutingNumber).FirstOrDefault();
                }
            }
            #endregion

            #region Payee-0026
            // confirm from where this corr will get generated
            if (astrTemplateName == busConstant.OVERPAYMENT_REPAID_CONFIRMATION)
            {
                if (iclbPayeeAccountBenefitOverpayment != null && iclbPayeeAccountBenefitOverpayment.Count > 0)
                {
                    if (!iclbPayeeAccountBenefitOverpayment.First().iclbRepaymentSchedule.IsNullOrEmpty() && iclbPayeeAccountBenefitOverpayment.First().iclbRepaymentSchedule.Count > 0)
                    {
                        idecOverPaymentRepaid = iclbPayeeAccountBenefitOverpayment.First().iclbRepaymentSchedule.First().icdoRepaymentSchedule.reimbursement_amount_paid;
                    }
                    if (iclbPayeeAccountBenefitOverpayment.First().iclbRepaymentSchedule.First().icdoRepaymentSchedule.effective_date.Year > DateTime.Now.Year)
                    {
                        aintOverPaymentPriorPlanYear = 1;
                    }
                }
            }
            #endregion

            #region Payee-0027
            // confirm from where this corr will get generated
            if (astrTemplateName == busConstant.PENSION_INCOME_VERIFICATION)
            {
                if (this.ibusParticipant.IsNotNull())
                {
                    if (this.ibusParticipant.icdoPerson.idtDateofBirth != DateTime.MinValue)
                    {
                        istrBirthMonthAndYear = string.Format("{0:MMMM, yyyy}", this.ibusParticipant.icdoPerson.idtDateofBirth);
                    }
                }
            }
            #endregion

            #region Payee-0031
            if (astrTemplateName == busConstant.IAP_REPAYMENT_AUTHORIZATION_LETTER || astrTemplateName == busConstant.CONFIRMATION_STATE_CHANGE_LETTER)
            {
                DateTime idtPaymentCuttOffDate = busPayeeAccountHelper.GetPaymentSetUpCuttOffDate(icdoPayeeAccount.iintPlanId);
                istrPaymentCuttOffDate = busGlobalFunctions.ConvertDateIntoDifFormat(idtPaymentCuttOffDate);

                if (idtNextBenefitPaymentDate == DateTime.MinValue)
                    LoadNextBenefitPaymentDate();
                GetCollectionPayemntHistoryDistributionDetails(astrTemplateName);
                if (iclbPayeeAccountBenefitOverpayment != null && iclbPayeeAccountBenefitOverpayment.Count > 0)
                {
                    if (!iclbPayeeAccountBenefitOverpayment.First().iclbRepaymentSchedule.IsNullOrEmpty() && iclbPayeeAccountBenefitOverpayment.First().iclbRepaymentSchedule.Count > 0)
                    {
                        idecOverPaymentRepaid = iclbPayeeAccountBenefitOverpayment.First().iclbRepaymentSchedule.First().icdoRepaymentSchedule.reimbursement_amount_paid;
                    }
                }

            }
            #endregion

            #region Payee-0032
            if (astrTemplateName == busConstant.IAP_REPAYMENT_AUTHORIZATION_FORM)
            {
                DataTable ltblRepaymentSchedules = Select("cdoRepaymentSchedule.GetLatestAmountNEstEndDate", new object[1] { icdoPayeeAccount.payee_account_id });
                if (ltblRepaymentSchedules.Rows.Count > 0)
                {
                    idecNextAmtDue = Convert.ToDecimal(ltblRepaymentSchedules.Rows[0][enmRepaymentSchedule.next_amount_due.ToString().ToUpper()]);
                    idtEstimatedEndDate = Convert.ToDateTime(ltblRepaymentSchedules.Rows[0][enmRepaymentSchedule.estimated_end_date.ToString().ToUpper()]);

                }
                idtEstimatedEndDate = idtEstimatedEndDate.AddMonths(1);
                istrMonthAftrEstimEndDate = busGlobalFunctions.ConvertDateIntoDifFormat(idtEstimatedEndDate);
            }
            #endregion

            #region Payee-0009
            if (astrTemplateName == busConstant.NOTIFICATION_OF_IAP_PAYMENTS_TO_PAYEE)
            {
                DateTime ldt30DaysAftrCurrDate = (System.DateTime.Now).AddDays(30);
                istr30DaysAfterCurrDate = busGlobalFunctions.ConvertDateIntoDifFormat(ldt30DaysAftrCurrDate);
            }
            #endregion
            #region PAYEE-0020
            if (astrTemplateName == busConstant.PENSION_ADJUSTMENT_NOTIFICATION)
            {
                LoadPayeeAccountRetroPayments();
                busPayeeAccountRetroPayment tbusPayeeAccountRetroPayment = (from item in iclbPayeeAccountRetroPayment
                                                                            where busGlobalFunctions.CheckDateOverlapping(idtNextBenefitPaymentDate,
                                                                            item.icdoPayeeAccountRetroPayment.start_date, item.icdoPayeeAccountRetroPayment.end_date)
                                                                            && item.icdoPayeeAccountRetroPayment.is_overpayment_flag != busConstant.Flag_Yes
                                                                            select item).FirstOrDefault();
                if (tbusPayeeAccountRetroPayment != null)
                {
                    this.istrReasonForUnderPayment = tbusPayeeAccountRetroPayment.icdoPayeeAccountRetroPayment.retro_payment_type_description;

                    busBenefitCalculationDetail lbusBenefitCalculationDetail = new busBenefitCalculationDetail();
                    if (lbusBenefitCalculationDetail.FindBenefitCalculationDetail(this.icdoPayeeAccount.benefit_calculation_detail_id))
                    {
                        this.idecFinalAccuredBenefitAmount = lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.unreduced_benefit_amount;
                    }
                    this.LoadBreakDownDetails();
                    this.idecMonthlyBenefitPlusRetroActive = this.idecNextGrossPaymentACH + this.idecRetroAdjustmentAmount;

                    this.LoadNextBenefitPaymentDate();
                    if (this.idtNextBenefitPaymentDate != DateTime.MinValue)
                    {
                        this.istrNextBenefitPaymentDate = busGlobalFunctions.ConvertDateIntoDifFormat(this.idtNextBenefitPaymentDate);
                    }
                }
            }
            #endregion
            //ChangeID: 58624
            #region PAYEE-0039

            if (astrTemplateName == busConstant.RETROACTIVE_BENEFIT_INCREASE_NOTICE)
            {
                if (this.idecNextGrossPaymentACH - this.idecPreviousMonthlyGrossAmt > 0)
                {
                    this.idecChangeInMonthlyGrossAmt = this.idecNextGrossPaymentACH - this.idecPreviousMonthlyGrossAmt;
                }
                else
                {
                    this.idecChangeInMonthlyGrossAmt = 0;
                }

                this.iintMonthDiff = busGlobalFunctions.GetMonthsBetweenTwoDates(Convert.ToDateTime(istrRetirementDate), idtLastBenefitPaymentDate.AddMonths(1));
                if (idtLastBenefitPaymentDate != DateTime.MinValue)
                    istrLastBenefitPaymentDate = busGlobalFunctions.ConvertDateIntoDifFormat(idtLastBenefitPaymentDate);
            }
            #endregion

            if (astrTemplateName == busConstant.SSA_DISABILITY_STOP_OVERPAYMENT)
            {
                DataTable ldtbStatus = busBase.Select("cdoPayeeAccountStatus.GetLatestStatusEffectiveDate", new object[1] { this.icdoPayeeAccount.payee_account_id });
                if (ldtbStatus.Rows.Count > 0 && !Convert.ToBoolean(ldtbStatus.Rows[0][0].IsDBNull()))
                {
                    //if (Convert.ToString(ldtbStatus.Rows[0]["STATUS_VALUE"]) == busConstant.PAYEE_ACCOUNT_STATUS_COMPLETED)
                    //{
                    istrStatusEffectiveDate = busGlobalFunctions.ConvertDateIntoDifFormat(Convert.ToDateTime(ldtbStatus.Rows[0]["STATUS_EFFECTIVE_DATE"]));
                    //}
                }
                if (icdoPayeeAccount.account_relation_value == busConstant.PERSON_TYPE_PARTICIPANT)
                {
                    aintPatrticpant = 1;
                }
                if (iclbPayeeAccountBenefitOverpayment != null && iclbPayeeAccountBenefitOverpayment.Count > 0)
                {
                    aintNoOverPayement = 1;
                }
                if (idtLastBenefitPaymentDate != DateTime.MinValue)
                    istrLastBenefitPaymentDate = busGlobalFunctions.ConvertDateIntoDifFormat(idtLastBenefitPaymentDate);
                LoadBreakDownDetails();
            }
            if (astrTemplateName == busConstant.LOCAL_PLAN_RE_EMPLOYMENT)
            {
                busPerson lbusPerson = new busPerson();
                if (icdoPayeeAccount.person_id != 0)
                {
                    lbusPerson.FindPerson(icdoPayeeAccount.person_id);
                    DateTime ldtDOB = Convert.ToDateTime(lbusPerson.icdoPerson.date_of_birth.ToString());
                    ldecAgeIndec = busGlobalFunctions.CalculatePersonAgeInDec(ldtDOB, ldtRetirementDate);
                    lintAgeIndec = Convert.ToInt32(Math.Floor(ldecAgeIndec));
                }
                LoadLocalMPIHours();
            }





            #endregion
        }




        public void LaodEEDerivedAMt(DataRow adtPerson)
        {
            string lstrRuleCorrespondence = string.Empty;
            decimal ldecTotalMEA = decimal.Zero;
            decimal ldecTotalTaxable = decimal.Zero;
            int lintBenefitAppID;
            int lintBenefitCalculationHeaderId = 0;
            int lintPersonAccountID;
            int lintBenefeciaryPersonID = 0;
            DateTime adtBatchRunDate = new DateTime();
            adtBatchRunDate = DateTime.Now;
            string lstrSSN = string.Empty;
            DateTime ldtRetirementDate = new DateTime();
            DateTime ldtDOB = new DateTime();
            DateTime ldtDisabilityCertificationDate = new DateTime();
            DateTime ldtBenDOB = new DateTime();
            //DateTime ldtReEmployedAsOfDate = new DateTime();
            //DataTime lstSSAApplicationDate = new DataTime
            decimal ldecAge = decimal.Zero;
            decimal ldecAgeIndec = decimal.Zero;
            decimal ldecBeneficiaryAgeAtRetr = decimal.Zero;

            string lstrBenefitTypeValue = string.Empty;
            string lstrBenefitSubTypeValue = string.Empty;
            string lstrBenefitOptionValue = string.Empty;
            string lstrDecryptedDOB = string.Empty;

            string lstrDisabilityConversionFlag = busConstant.FLAG_NO;
            bool lblnMarkReemployed = false;
            decimal ldecVestedEEContributions = decimal.Zero;
            decimal ldecVestedEEInterest = decimal.Zero;
            decimal ldecEEDerivedBenefit = decimal.Zero;
            int lintPlanID = this.icdoPayeeAccount.iintPlanId;
            busPayeeAccountStatus lbusPayeeAccountStatus = null;


            //lbusPayeeAccount = new busPayeeAccount { icdoPayeeAccount = new cdoPayeeAccount() };
            //lbusPayeeAccount.icdoPayeeAccount.LoadData(adtPerson);
            DateTime ldt1986Date = new DateTime(1986, 08, 01);

            if (this.icdoPayeeAccount.idtRetireMentDate == DateTime.MinValue)
            {
                ldtRetirementDate = this.icdoPayeeAccount.benefit_begin_date;
            }
            else
            {
                ldtRetirementDate = this.icdoPayeeAccount.idtRetireMentDate;
            }

            ldtDOB = Convert.ToDateTime(adtPerson[enmPerson.date_of_birth.ToString()]);
            lstrBenefitTypeValue = Convert.ToString(adtPerson[enmBenefitApplication.benefit_type_value.ToString()]);
            lstrBenefitSubTypeValue = Convert.ToString(adtPerson[enmBenefitApplicationDetail.benefit_subtype_value.ToString()]);
            lstrDisabilityConversionFlag = Convert.ToString(adtPerson[enmPayeeAccount.disability_conversion_flag.ToString()]);
            lintBenefitAppID = Convert.ToInt32(adtPerson[enmBenefitApplication.benefit_application_id.ToString()]);
            if (!string.IsNullOrEmpty(Convert.ToString(adtPerson[enmBenefitCalculationHeader.benefit_calculation_header_id.ToString()])))
            {
                lintBenefitCalculationHeaderId = Convert.ToInt32(adtPerson[enmBenefitCalculationHeader.benefit_calculation_header_id.ToString()]);
            }
            if (!string.IsNullOrEmpty(Convert.ToString(adtPerson[enmBenefitApplicationDetail.joint_annuitant_id.ToString()])))
            {
                lintBenefeciaryPersonID = Convert.ToInt32(adtPerson[enmBenefitApplicationDetail.joint_annuitant_id.ToString()]);
                if (!string.IsNullOrEmpty(Convert.ToString(adtPerson["BEN_DOB"])))
                {
                    lstrDecryptedDOB = Convert.ToString(adtPerson["BEN_DOB"]);
                    if (!string.IsNullOrEmpty(lstrDecryptedDOB))
                    {
                        ldtBenDOB = Convert.ToDateTime(lstrDecryptedDOB);
                        ldecBeneficiaryAgeAtRetr = busGlobalFunctions.CalculatePersonAge(ldtBenDOB, ldtRetirementDate);
                    }
                }
            }
            lintPersonAccountID = Convert.ToInt32(adtPerson[enmPersonAccount.person_account_id.ToString()]);
            ldtDisabilityCertificationDate = this.icdoPayeeAccount.benefit_begin_date;
            ldecAge = busGlobalFunctions.CalculatePersonAge(ldtDOB, adtBatchRunDate);
            ldecAgeIndec = busGlobalFunctions.CalculatePersonAgeInDec(ldtDOB, ldtRetirementDate);
            lintPlanID = Convert.ToInt32(adtPerson[enmPlanBenefitXr.plan_id.ToString()]);
            lstrBenefitOptionValue = Convert.ToString(adtPerson[enmPlanBenefitXr.benefit_option_value.ToString()]);
            ldecEEDerivedBenefit = this.icdoPayeeAccount.ee_derived_benefit_amount;
            //if (ldecAge > 65 && this.icdoPayeeAccount.reemployed_flag == busConstant.FLAG_YES)
            //{
            //    return string.Empty;
            //}
            if (lintPlanID == busConstant.MPIPP_PLAN_ID && this.icdoPayeeAccount.ee_derived_benefit_amount == decimal.Zero)
            {
                if (!string.IsNullOrEmpty(Convert.ToString(adtPerson[enmPayeeBenefitAccount.starting_nontaxable_amount.ToString()])))
                {
                    ldecVestedEEContributions = Convert.ToDecimal(adtPerson[enmPayeeBenefitAccount.starting_nontaxable_amount.ToString()]);
                }
                if (!string.IsNullOrEmpty(Convert.ToString(adtPerson[enmPayeeBenefitAccount.starting_taxable_amount.ToString()])))
                {
                    ldecVestedEEInterest = Convert.ToDecimal(adtPerson[enmPayeeBenefitAccount.starting_taxable_amount.ToString()]);
                }
                if (lintBenefitCalculationHeaderId > 0)
                {
                    if (!string.IsNullOrEmpty(Convert.ToString(adtPerson[enmBenefitCalculationDetail.ee_derived_benefit_amount.ToString()])))
                    {
                        ldecEEDerivedBenefit = GetEEDerivedToBePaid(Convert.ToDecimal(adtPerson[enmBenefitCalculationDetail.ee_derived_benefit_amount.ToString()])
                             , lstrBenefitSubTypeValue, ldecAgeIndec, ldecBeneficiaryAgeAtRetr);


                    }
                }
                else
                {
                    if (ldecVestedEEContributions + ldecVestedEEInterest == decimal.Zero)
                    {
                        DataTable ldtbEEAmtAndEEContribution = busBase.Select("cdoPersonAccountRetirementContribution.GetVestedEEContribution", new object[1] { lintPersonAccountID });
                        if (ldtbEEAmtAndEEContribution.IsNotNull() && ldtbEEAmtAndEEContribution.Rows.Count > 0 && ldtbEEAmtAndEEContribution.Rows[0][0] != DBNull.Value)
                        {
                            ldecVestedEEContributions = Convert.ToDecimal(ldtbEEAmtAndEEContribution.Rows[0]["EE_CONTRIBUTION_AMOUNT"]);
                            ldecVestedEEInterest = Convert.ToDecimal(ldtbEEAmtAndEEContribution.Rows[0]["EE_INT_AMOUNT"]);
                        }
                    }
                    if (ldecVestedEEContributions + ldecVestedEEInterest > decimal.Zero)
                    {
                        ldecEEDerivedBenefit = GetEEDerivedBenefit(ldecVestedEEContributions + ldecVestedEEInterest, ldecAgeIndec, ldtRetirementDate, lstrBenefitSubTypeValue, ldecBeneficiaryAgeAtRetr);
                    }
                }
                this.icdoPayeeAccount.ee_derived_benefit_amount = ldecEEDerivedBenefit;
                if (ldecBeneficiaryAgeAtRetr < 65 && icdoPayeeAccount.retirement_type_value == busConstant.RETIREMENT_TYPE_UNREDUCED_EARLY)
                {
                    aintIsRetrUnreducesLess65 = 1;
                }
            }
        }

        #region Public Methods

        //public void LoadOverriddenAmount()
        //{
        //    //Payment Adjustments
        //    if (icdoPayeeAccount.benefit_calculation_detail_id > 0)
        //    {
        //        DataTable ldtBenefitCalculationOptions = Select("cdoPayeeAccount.GetCalculationOptionsFromDetailId", new object[1] { icdoPayeeAccount.benefit_calculation_detail_id });

        //        if (ldtBenefitCalculationOptions != null && ldtBenefitCalculationOptions.Rows.Count > 0)
        //        {
        //            busBenefitCalculationOptions lbusBenefitCalculationOptions = new busBenefitCalculationOptions { icdoBenefitCalculationOptions = new cdoBenefitCalculationOptions() };

        //            lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.LoadData(ldtBenefitCalculationOptions.Rows[0]);
        //            icdoPayeeAccount.idecOverriddenBenefitAmt = lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.overridden_benefit_amount;

        //        }

        //    }
        //}

        public bool ShowReleaseWithholding()
        {

            DataTable ldtblOpenWithholdingInformation = Select("cdoDroApplication.CheckOpenWithholdingInformation", new object[1] { this.icdoPayeeAccount.person_id });
            if (ldtblOpenWithholdingInformation != null && ldtblOpenWithholdingInformation.Rows.Count > 0)
            {
                return true;
            }

            return false;
        }


        public int ManagePayeeAccount(int aintPayeeAccountId, int aintPersonId, int aintOrgId, int aintBenefitApplicationDetailId, int aintBenefitCalculationDetailId, int aintDROApplicationDetailId, int aintDROCalculationDetailId,
                                      int aintPayeeBenefitAccountId, string astrBenefitAccountTypeValue, string astrRetirementTypeValue, DateTime adtBenefitBeginDate, DateTime adtBenefitEndDate,
                                      string astrAccountRelationshipValue, string astrFamilyRelationValue, Decimal adecMinimumGuaranteeAmount, Decimal adecNonTaxableBeginningBalance, int aintPlanBenefitId,
                                      DateTime adtTermCertainEndDate, string astrRetIncreaseFlag = busConstant.FLAG_NO, string astrDisbConvFlag = busConstant.FLAG_NO, bool ablnAdjustmentPaymentFlag = false, int aintReferenceId = 0, string astrOneTimePaymentFlag = busConstant.FLAG_NO)
        {
            if ((aintPayeeBenefitAccountId != 0) &&
               (!string.IsNullOrEmpty(astrBenefitAccountTypeValue)) &&
               //  (!string.IsNullOrEmpty(astrRetirementTypeValue)) &&  //temporarily commented by aarti will talk to abhishek on this (for pre death)
               (adtBenefitBeginDate != DateTime.MinValue || aintPayeeAccountId > 0) &&
               (!string.IsNullOrEmpty(astrAccountRelationshipValue)))
            {
                if (aintPayeeAccountId > 0)
                    this.FindPayeeAccount(aintPayeeAccountId);

                this.icdoPayeeAccount.person_id = aintPersonId;
                //  this.icdoPayeeAccount.payee_account_id = aintPayeeAccountId;
                this.icdoPayeeAccount.org_id = aintOrgId;
                this.icdoPayeeAccount.benefit_application_detail_id = aintBenefitApplicationDetailId;
                this.icdoPayeeAccount.benefit_calculation_detail_id = aintBenefitCalculationDetailId;
                this.icdoPayeeAccount.dro_application_detail_id = aintDROApplicationDetailId;
                this.icdoPayeeAccount.dro_calculation_detail_id = aintDROCalculationDetailId;
                this.icdoPayeeAccount.payee_benefit_account_id = aintPayeeBenefitAccountId;
                this.icdoPayeeAccount.benefit_account_type_value = astrBenefitAccountTypeValue;
                this.icdoPayeeAccount.retirement_type_value = astrRetirementTypeValue;

                this.icdoPayeeAccount.benefit_begin_date = adtBenefitBeginDate == DateTime.MinValue ?
                    this.icdoPayeeAccount.benefit_begin_date : adtBenefitBeginDate;

                this.icdoPayeeAccount.benefit_end_date = adtBenefitEndDate;
                this.icdoPayeeAccount.account_relation_value = astrAccountRelationshipValue;
                this.icdoPayeeAccount.family_relation_value = astrFamilyRelationValue;
                this.icdoPayeeAccount.minimum_guarantee_amount = adecMinimumGuaranteeAmount;
                this.icdoPayeeAccount.nontaxable_beginning_balance = adecNonTaxableBeginningBalance;
                this.icdoPayeeAccount.term_certain_end_date = adtTermCertainEndDate;
                this.icdoPayeeAccount.plan_benefit_id = aintPlanBenefitId;
                this.icdoPayeeAccount.reference_id = aintReferenceId;
                this.icdoPayeeAccount.retiree_incr_flag = astrRetIncreaseFlag;
                this.icdoPayeeAccount.onetime_payment_flag = astrOneTimePaymentFlag;
                if (astrBenefitAccountTypeValue == busConstant.BENEFIT_TYPE_DISABILITY)
                {
                    this.icdoPayeeAccount.disability_conversion_flag = astrDisbConvFlag;
                }

                if (ablnAdjustmentPaymentFlag)
                {
                    this.icdoPayeeAccount.adjustment_payment_eligible_flag = busConstant.FLAG_YES;
                }
                //PIR-829
                busBenefitCalculationDetail lbusBenefitCalculationDetail = new busBenefitCalculationDetail { icdoBenefitCalculationDetail = new cdoBenefitCalculationDetail() };
                busQdroCalculationDetail lbusQdroCalculationDetail = new busQdroCalculationDetail { icdoQdroCalculationDetail = new cdoQdroCalculationDetail() };
                if (lbusBenefitCalculationDetail.FindBenefitCalculationDetail(this.icdoPayeeAccount.benefit_calculation_detail_id))
                {
                    this.ibusBenefitCalculationHeader = new busBenefitCalculationHeader { icdoBenefitCalculationHeader = new cdoBenefitCalculationHeader() };
                    this.ibusBenefitCalculationHeader.FindBenefitCalculationHeader(lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.benefit_calculation_header_id);
                }
                if (lbusQdroCalculationDetail.FindQdroCalculationDetail(this.icdoPayeeAccount.dro_calculation_detail_id))
                {
                    this.ibusQDROCalculationHeader = new busQdroCalculationHeader { icdoQdroCalculationHeader = new cdoQdroCalculationHeader() };
                    this.ibusQDROCalculationHeader.FindQdroCalculationHeader(lbusQdroCalculationDetail.icdoQdroCalculationDetail.qdro_calculation_header_id);
                }
                if ((this.ibusBenefitCalculationHeader != null && this.ibusBenefitCalculationHeader.icdoBenefitCalculationHeader.calculation_type_value == busConstant.BenefitCalculation.CALCULATION_TYPE_ADJUSTMENT) || (this.ibusQDROCalculationHeader != null && this.ibusQDROCalculationHeader.icdoQdroCalculationHeader.calculation_type_value == busConstant.BenefitCalculation.CALCULATION_TYPE_ADJUSTMENT))
                {
                    this.icdoPayeeAccount.adjustment_payment_eligible_flag = busConstant.FLAG_NO; //PIR 534-As after manual adjustment, IAP adjustment batch should not pick it again.
                }

                //PIR 1051
                if (this.icdoPayeeAccount.reemployed_flag == busConstant.FLAG_YES &&
                    (astrBenefitAccountTypeValue == busConstant.BENEFIT_TYPE_RETIREMENT || astrBenefitAccountTypeValue == busConstant.BENEFIT_TYPE_DISABILITY) && aintPayeeAccountId > 0)
                {
                    this.icdoPayeeAccount.reemployed_flag = null;
                    this.icdoPayeeAccount.reemployed_flag_as_of_date = DateTime.MinValue;

                    cdoReemploymentHistory lcdoLatestReemploymentHistory = new cdoReemploymentHistory();
                    if (this.iclcReemploymentHistory != null && this.iclcReemploymentHistory.Count() > 0 &&
                        this.iclcReemploymentHistory.Where(item => item.resume_benefit_date == DateTime.MinValue).Count() > 0)
                    {
                        lcdoLatestReemploymentHistory = this.iclcReemploymentHistory.Where(item => item.resume_benefit_date == DateTime.MinValue).OrderByDescending(item => item.reemployment_history_id)
                            .FirstOrDefault();
                        lcdoLatestReemploymentHistory.resume_benefit_date = idtNextBenefitPaymentDate;
                        lcdoLatestReemploymentHistory.Update();
                    }
                }

                if (aintPayeeAccountId == 0)
                {
                    if (this.icdoPayeeAccount.Insert() == 1)
                    {
                        return this.icdoPayeeAccount.payee_account_id;
                    }
                }
                else
                {
                    this.icdoPayeeAccount.Update();
                    return this.icdoPayeeAccount.payee_account_id;
                }
            }

            return 0;
        }


        //Get payment item type id by passing Item code
        public int GetPaymentItemTypeIDByItemCode(string astrItemTypeCode)
        {
            int lintPaymentItemTypeID = 0;
            if (iclbPaymentItemType == null)
                LoadPaymentItemType();
            lintPaymentItemTypeID = iclbPaymentItemType.Where(o => o.icdoPaymentItemType.item_type_code == astrItemTypeCode).Select(o => o.icdoPaymentItemType.payment_item_type_id).FirstOrDefault();
            return lintPaymentItemTypeID;
        }

        //Get payment item type id by passing Item code
        public string GetPaymentItemItemCodeByPaymentItemTypeID(int aintTypeId)
        {
            string lstrItemTypeCode = string.Empty;
            if (iclbPaymentItemType == null)
                LoadPaymentItemType();
            lstrItemTypeCode = iclbPaymentItemType.Where(o => o.icdoPaymentItemType.payment_item_type_id == aintTypeId).Select(o => o.icdoPaymentItemType.item_type_code).FirstOrDefault();
            return lstrItemTypeCode;
        }

        //Load Payment Item Types
        public void LoadPaymentItemType()
        {
            if (this.iclbPaymentItemType.IsNullOrEmpty())
            {
                if (idtbPaymentItemType == null)
                    idtbPaymentItemType = iobjPassInfo.isrvDBCache.GetCacheData("sgt_payment_item_type", null);

                this.iclbPaymentItemType = GetCollection<busPaymentItemType>(idtbPaymentItemType, "icdoPaymentItemType");
            }
        }

        //Load Retro Item Types
        public void LoadRetroItemType()
        {
            if (this.iclbRetroItemType.IsNullOrEmpty())
            {
                if (idtbRetroItemType == null)
                    idtbRetroItemType = iobjPassInfo.isrvDBCache.GetCacheData("SGT_RETRO_ITEM_TYPE", null);

                this.iclbRetroItemType = GetCollection<busRetroItemType>(idtbRetroItemType, "icdoRetroItemType");
            }
        }
        //public void LoadPayeeAccountPaymentItemTypesActives()
        //{
        //    LoadPayeeAccountPaymentItemTypes();
        //    foreach (busPayeeAccountPaymentItemType lobjPayeeAccountItemType in iclbPayeeAccountPaymentItemType)
        //    {

        //        if (lobjPayeeAccountItemType.ibusPaymentItemType == null)
        //        {
        //            lobjPayeeAccountItemType.LoadPaymentItemType(); //R3view -- change this method get from db cache
        //        }

        //    }
        //    iclbPayeeAccountPaymentItemTypeActive = (from obj in iclbPayeeAccountPaymentItemType.AsEnumerable()
        //                                                                                        where obj.icdoPayeeAccountPaymentItemType.start_date < idtNextBenefitPaymentDate
        //                                                                                                                 && obj.icdoPayeeAccountPaymentItemType.end_date > idtNextBenefitPaymentDate
        //                                                                                        select obj).ToList < busPayeeAccountPaymentItemType>().ToCollection();


        //}
        /// <summary>
        /// Loading PayeeAccountPaymentItemType + PaymentItemType + org
        /// </summary>
        public void LoadPayeeAccountPaymentItemType()
        {
            this.iclbPayeeAccountPaymentItemType = new Collection<busPayeeAccountPaymentItemType>();
            DataTable ldtbPayeeAccountPaymentItemType = Select("cdoPayeeAccountPaymentItemType.LoadPayeeAccountPaymentItemType", new object[1] { icdoPayeeAccount.payee_account_id });

            foreach (DataRow ldtrPayeeAccountPaymentItemType in ldtbPayeeAccountPaymentItemType.Rows)
            {
                busPayeeAccountPaymentItemType lobjPayeeAccountPaymentItemType = new busPayeeAccountPaymentItemType();
                lobjPayeeAccountPaymentItemType.ibusPaymentItemType = new busPaymentItemType();
                lobjPayeeAccountPaymentItemType.ibusVendor = new busOrganization();
                lobjPayeeAccountPaymentItemType.icdoPayeeAccountPaymentItemType = new cdoPayeeAccountPaymentItemType();
                lobjPayeeAccountPaymentItemType.ibusPaymentItemType.icdoPaymentItemType = new cdoPaymentItemType();
                lobjPayeeAccountPaymentItemType.ibusVendor.icdoOrganization = new cdoOrganization();

                lobjPayeeAccountPaymentItemType.icdoPayeeAccountPaymentItemType.LoadData(ldtrPayeeAccountPaymentItemType);
                lobjPayeeAccountPaymentItemType.icdoPayeeAccountPaymentItemType.update_seq = Convert.ToInt32(ldtrPayeeAccountPaymentItemType["papit_update_seq"]);
                lobjPayeeAccountPaymentItemType.ibusPaymentItemType.icdoPaymentItemType.LoadData(ldtrPayeeAccountPaymentItemType);
                lobjPayeeAccountPaymentItemType.ibusVendor.icdoOrganization.LoadData(ldtrPayeeAccountPaymentItemType);

                this.iclbPayeeAccountPaymentItemType.Add(lobjPayeeAccountPaymentItemType);
            }
        }

        public void LoadParticipantAddress()
        {
            this.iclbParticipantAddress = new Collection<busPersonAddress>();
            DataTable ldtbParticipantAddress = Select("cdoPersonAddress.GetParticipantAddress", new object[1] { icdoPayeeAccount.person_id });
            
            foreach (DataRow ldtrParticipantAddress in ldtbParticipantAddress.Rows)
            {
                busPersonAddress lobjPersonAddress = new busPersonAddress() { icdoPersonAddress = new cdoPersonAddress() };
                lobjPersonAddress.icdoPersonAddress.LoadData(ldtrParticipantAddress);
                lobjPersonAddress.icdoPersonAddress.ContactName = Convert.ToString(ldtrParticipantAddress["CO"]);
                this.iclbParticipantAddress.Add(lobjPersonAddress);
            }

        }

        public void LoadPayeeAccountPaymentItemType1and2()
        {
            this.iclbPayeeAccountPaymentItemType = new Collection<busPayeeAccountPaymentItemType>();
            DataTable ldtbPayeeAccountPaymentItemType = Select("cdoPayeeAccountPaymentItemType.LoadPayeeAccPaymentItemType1and2", new object[1] { icdoPayeeAccount.payee_account_id });

            foreach (DataRow ldtrPayeeAccountPaymentItemType in ldtbPayeeAccountPaymentItemType.Rows)
            {
                busPayeeAccountPaymentItemType lobjPayeeAccountPaymentItemType = new busPayeeAccountPaymentItemType();
                lobjPayeeAccountPaymentItemType.ibusPaymentItemType = new busPaymentItemType();
                lobjPayeeAccountPaymentItemType.ibusVendor = new busOrganization();
                lobjPayeeAccountPaymentItemType.icdoPayeeAccountPaymentItemType = new cdoPayeeAccountPaymentItemType();
                lobjPayeeAccountPaymentItemType.ibusPaymentItemType.icdoPaymentItemType = new cdoPaymentItemType();
                lobjPayeeAccountPaymentItemType.ibusVendor.icdoOrganization = new cdoOrganization();

                lobjPayeeAccountPaymentItemType.icdoPayeeAccountPaymentItemType.LoadData(ldtrPayeeAccountPaymentItemType);
                lobjPayeeAccountPaymentItemType.icdoPayeeAccountPaymentItemType.update_seq = Convert.ToInt32(ldtrPayeeAccountPaymentItemType["papit_update_seq"]);
                lobjPayeeAccountPaymentItemType.ibusPaymentItemType.icdoPaymentItemType.LoadData(ldtrPayeeAccountPaymentItemType);
                lobjPayeeAccountPaymentItemType.ibusVendor.icdoOrganization.LoadData(ldtrPayeeAccountPaymentItemType);

                this.iclbPayeeAccountPaymentItemType.Add(lobjPayeeAccountPaymentItemType);
            }
        }

        public void LoadPayeeAccountPaymentItemTypeFromPaymentHistoryDetail(int aintPaymentHistoryHeaderID)
        {
            this.iclbPayeeAccountPaymentItemType = new Collection<busPayeeAccountPaymentItemType>();
            DataTable ldtbPayeeAccountPaymentItemTypeFromPaymentHistoryDetail = Select("cdoPaymentHistoryDetail.LoadPayeeAccountHistoryDetails", new object[1] { aintPaymentHistoryHeaderID });

            foreach (DataRow ldtrPayeeAccountPaymentItemType in ldtbPayeeAccountPaymentItemTypeFromPaymentHistoryDetail.Rows)
            {
                busPayeeAccountPaymentItemType lobjPayeeAccountPaymentItemType = new busPayeeAccountPaymentItemType();
                lobjPayeeAccountPaymentItemType.ibusPaymentItemType = new busPaymentItemType();
                lobjPayeeAccountPaymentItemType.ibusVendor = new busOrganization();
                lobjPayeeAccountPaymentItemType.icdoPayeeAccountPaymentItemType = new cdoPayeeAccountPaymentItemType();
                lobjPayeeAccountPaymentItemType.ibusPaymentItemType.icdoPaymentItemType = new cdoPaymentItemType();
                lobjPayeeAccountPaymentItemType.ibusVendor.icdoOrganization = new cdoOrganization();

                lobjPayeeAccountPaymentItemType.icdoPayeeAccountPaymentItemType.LoadData(ldtrPayeeAccountPaymentItemType);
                lobjPayeeAccountPaymentItemType.icdoPayeeAccountPaymentItemType.update_seq = Convert.ToInt32(ldtrPayeeAccountPaymentItemType["papit_update_seq"]);
                lobjPayeeAccountPaymentItemType.ibusPaymentItemType.icdoPaymentItemType.LoadData(ldtrPayeeAccountPaymentItemType);
                lobjPayeeAccountPaymentItemType.ibusVendor.icdoOrganization.LoadData(ldtrPayeeAccountPaymentItemType);
                this.iclbPayeeAccountPaymentItemType.Add(lobjPayeeAccountPaymentItemType);
            }
        }

        //public ArrayList btn_CalculatingTaxWithHolding()
        //{
        //    ArrayList larrList = new ArrayList();
        //    utlError lobjError = null;


        //    this.LoadPayeeAccountTaxWithholdings();



        //    ////  ibusPayeeAccount = new busPayeeAccount();
        //    ////  ibusPayeeAccount.CalculateTaxForBenefit(this,false);
        //    //DateTime adtPaymentDate = DateTime.ParseExact("" + istrTaxYear + "-12-01", "yyyy-MM-dd", System.Globalization.CultureInfo.InvariantCulture);

        //    //decimal adecTaxableAmount = this.idecMonthlyGrossAmount - this.idecExclusionAmount;

        //    //if (this.istrStateStatus == "" || this.istrStateStatus == null)
        //    //{

        //    //    lobjError = AddError(0, " Select State Tax Identifier.");
        //    //    larrList.Add(lobjError);
        //    //    return larrList;

        //    //}

        //    //if ((this.istrMtlStatus == "" || this.istrMtlStatus == null) && this.istrStateStatus != "VAST")
        //    //{

        //    //    lobjError = AddError(0, " Select Marital Status.");
        //    //    larrList.Add(lobjError);
        //    //    return larrList;

        //    //}

        //    //if (iintpersonal_exemptions > 0)
        //    //{

        //    //    this.icdoPayeeAccountTaxWithholding.personal_exemptions = iintpersonal_exemptions;

        //    //}

        //    //if (iintage_and_blindness_exemptions > 0)
        //    //{

        //    //    this.icdoPayeeAccountTaxWithholding.age_and_blindness_exemptions = iintage_and_blindness_exemptions;
        //    //}


        //    //busPayeeAccountHelper.CalculateFedOrStateTax(adecTaxableAmount, iintFedAllowanceNumber, adtPaymentDate, this.istrFedStatus, "FDRL", idecFedAdditionalTaxAmount, this, true, "Y");

        //    //if (istrStateStatus != "" || istrStateStatus != "null")
        //    //{
        //    //    busPayeeAccountHelper.CalculateFedOrStateTax(adecTaxableAmount, iintStateAllowanceNumber, adtPaymentDate, this.istrMtlStatus, this.istrStateStatus, idecStateAdditionalTaxAmount, this, true, null);

        //    //}
        //    larrList.Add(this);
        //    return larrList;

        //}

        public void LoadPayeeAccountTaxWithHoldingHistory()
        {
            DataTable ldtbList = Select<cdoPayeeAccountTaxWithholding>(
                               new string[1] { "payee_account_id" },
                               new object[1] { icdoPayeeAccount.payee_account_id }, null, "start_date desc");
            this.iclbTaxWithHoldingHistory = GetCollection<busPayeeAccountTaxWithholding>(ldtbList, "icdoPayeeAccountTaxWithholding");
            this.iclbFederalTaxWithholding = iclbTaxWithHoldingHistory.Where(o => o.icdoPayeeAccountTaxWithholding.tax_identifier_value == busConstant.FEDRAL_STATE_TAX).ToList().ToCollection();
            this.iclbStateTaxWithholding = iclbTaxWithHoldingHistory.Where(o => o.icdoPayeeAccountTaxWithholding.tax_identifier_value == busConstant.CA_STATE_TAX).ToList().ToCollection();
        }


        public bool IsPayeeAccountStatusProcessedORRecieving()
        {
            DataTable ldtb = this.iobjPassInfo.isrvDBCache.GetCodeDescription(2203, ibusCurrentActivePayeeAccount.icdoPayeeAccountStatus.status_value);
            if (ldtb.Rows.Count > 0)
            {
                if ((ldtb.Rows[0]["CODE_VALUE"].ToString() == "RECV") || (ldtb.Rows[0]["CODE_VALUE"].ToString() == "CMPL"))
                {
                    return true;
                }
            }
            return false;
        }

        public void LoadActivePayeeStatusAsofNextBenefitPaymentDate()
        {
            if (idtNextBenefitPaymentDate == DateTime.MinValue)
                LoadNextBenefitPaymentDate();

            LoadPayeeAccountStatuss();

            if (iclbPayeeAccountStatus.Count > 0)
            {
                ibusCurrentActivePayeeAccount = iclbPayeeAccountStatus.FirstOrDefault();
            }

            //If there is no record as of next benefit payment date, assign the default object
            if (ibusCurrentActivePayeeAccount.IsNull())
                ibusCurrentActivePayeeAccount = new busPayeeAccountStatus { icdoPayeeAccountStatus = new cdoPayeeAccountStatus() };
        }

        public int CreatePayeeAccountPaymentItemType(string astrItemCode, decimal adecAmount, string astrAccountNo, int aintVendorOrgID,
                                                     DateTime adteStartDate, DateTime adtEndDate, string astrReIssueFlag, bool ablnForceInsert, bool ablnCheckVendorOrg = false, int aintPayeeAccountPaymentItemTypeID = 0)
        {
            int lintPayeeAccountPIT = 0;
            int lintPaymentItemTypeID = GetPaymentItemTypeIDByItemCode(astrItemCode);

            if ((lintPaymentItemTypeID != 0) &&
                (adteStartDate != DateTime.MinValue) &&
                (icdoPayeeAccount.payee_account_id != 0))
            {
                bool lblnCreate = false;
                if (ablnForceInsert)
                {
                    lblnCreate = true;
                }
                //Below block is for handling PAPIT creation of same item for multiple vendor org id
                // Talk to Vinovin IF WE ARE GOING TO NEED THIS 
                else if (ablnCheckVendorOrg)
                {
                    #region  //Below block is for handling PAPIT creation of same item for multiple vendor org id -- COMMENTED FOR NOW
                    //if (idtNextBenefitPaymentDate == DateTime.MinValue)
                    //    LoadNexBenefitPaymentDate();
                    //if (iclbPayeeAccountPaymentItemType == null)
                    //    LoadPayeeAccountPaymentItemType();
                    //busPayeeAccountPaymentItemType lobjPayeeAccountItemType
                    //    = iclbPayeeAccountPaymentItemType.Where(o => o.icdoPayeeAccountPaymentItemType.payment_item_type_id == lintPaymentItemTypeID &&
                    //                                                 o.icdoPayeeAccountPaymentItemType.payee_account_id == icdoPayeeAccount.payee_account_id &&
                    //                                                 o.icdoPayeeAccountPaymentItemType.end_date_no_null >= idtNextBenefitPaymentDate &&
                    //                                                 o.icdoPayeeAccountPaymentItemType.vendor_org_id == aintVendorOrgID).FirstOrDefault();

                    //if (lobjPayeeAccountItemType != null)
                    //{
                    //    //as per meeting with satya on Aug 13,2010 : need to set to null, if modified from screen
                    //    lobjPayeeAccountItemType.icdoPayeeAccountPaymentItemType.batch_schedule_id = iintBatchScheudleID;

                    //    //added for UCS - 079, after recalculation is done, if an item have amount as zero, we need to enddate the existing one
                    //    if (adecAmount == 0.0M)
                    //    {
                    //        busPaymentItemType lobjPaymentItemType = new busPaymentItemType();
                    //        lobjPaymentItemType.FindPaymentItemType(lobjPayeeAccountItemType.icdoPayeeAccountPaymentItemType.payment_item_type_id);
                    //        if (lobjPayeeAccountItemType.icdoPayeeAccountPaymentItemType.start_date < idtNextBenefitPaymentDate)
                    //        {
                    //            lobjPayeeAccountItemType.icdoPayeeAccountPaymentItemType.end_date = idtNextBenefitPaymentDate.AddDays(-1);
                    //            lobjPayeeAccountItemType.icdoPayeeAccountPaymentItemType.Update();
                    //        }
                    //        else
                    //        {
                    //            if (iclbTaxWithholingHistory == null)
                    //                LoadTaxWithHoldingHistory();
                    //            foreach (busPayeeAccountTaxWithholding lobjtaxwithholding in iclbTaxWithholingHistory)
                    //            {
                    //                lobjtaxwithholding.LoadTaxWithHoldingTaxItems();
                    //                foreach (busPayeeAccountTaxWithholdingItemDetail lobjTaxWithholdingItemDetail in lobjtaxwithholding.iclbTaxWithHoldingTaxItems)
                    //                    if (lobjTaxWithholdingItemDetail.icdoPayeeAccountTaxWithholdingItemDetail.payee_account_payment_item_type_id ==
                    //                        lobjPayeeAccountItemType.icdoPayeeAccountPaymentItemType.payee_account_payment_item_type_id)
                    //                        lobjTaxWithholdingItemDetail.icdoPayeeAccountTaxWithholdingItemDetail.Delete();
                    //            }
                    //            lobjPayeeAccountItemType.icdoPayeeAccountPaymentItemType.Delete();
                    //        }
                    //    }
                    //    else
                    //        if (lobjPayeeAccountItemType.icdoPayeeAccountPaymentItemType.start_date < idtNextBenefitPaymentDate)
                    //        {
                    //            if (ibusPayeeAccountActiveStatus == null)
                    //                LoadActivePayeeStatusAsofNextBenefitPaymentDate();
                    //            if (lobjPayeeAccountItemType.icdoPayeeAccountPaymentItemType.start_date == adteStartDate)
                    //            {
                    //                if (IsPayeeAccountStatusProcessedORRecieving())
                    //                {
                    //                    return 0;
                    //                }
                    //                else
                    //                {
                    //                    lobjPayeeAccountItemType.icdoPayeeAccountPaymentItemType.amount = adecAmount;
                    //                    lobjPayeeAccountItemType.icdoPayeeAccountPaymentItemType.Update();
                    //                    lblnCreate = false;
                    //                    return lobjPayeeAccountItemType.icdoPayeeAccountPaymentItemType.payee_account_payment_item_type_id;
                    //                }
                    //            }
                    //            else
                    //            {
                    //                lobjPayeeAccountItemType.icdoPayeeAccountPaymentItemType.end_date = adteStartDate.AddDays(-1);
                    //                lobjPayeeAccountItemType.icdoPayeeAccountPaymentItemType.Update();
                    //                lblnCreate = true;
                    //            }
                    //        }
                    //        else
                    //        {
                    //            lobjPayeeAccountItemType.icdoPayeeAccountPaymentItemType.amount = adecAmount;
                    //            lobjPayeeAccountItemType.icdoPayeeAccountPaymentItemType.Update();
                    //            lblnCreate = false;
                    //            return lobjPayeeAccountItemType.icdoPayeeAccountPaymentItemType.payee_account_payment_item_type_id;
                    //        }
                    //}
                    //else
                    //{
                    //    lblnCreate = true;
                    //}

                    #endregion
                }

                else
                {
                    #region Search if Payment Item Already Exists
                    if (idtNextBenefitPaymentDate == DateTime.MinValue)
                        LoadNextBenefitPaymentDate();
                    if (iclbPayeeAccountPaymentItemType == null)
                        LoadPayeeAccountPaymentItemType();

                    busPayeeAccountPaymentItemType lobjPayeeAccountPayeeItemType = new busPayeeAccountPaymentItemType { icdoPayeeAccountPaymentItemType = new cdoPayeeAccountPaymentItemType() };

                    if (aintPayeeAccountPaymentItemTypeID > 0)
                        lobjPayeeAccountPayeeItemType = iclbPayeeAccountPaymentItemType.Where(o => o.icdoPayeeAccountPaymentItemType.payee_account_payment_item_type_id == aintPayeeAccountPaymentItemTypeID).FirstOrDefault();
                    else

                        lobjPayeeAccountPayeeItemType = iclbPayeeAccountPaymentItemType.Where(o => o.icdoPayeeAccountPaymentItemType.payment_item_type_id == lintPaymentItemTypeID &&
                                                                       o.icdoPayeeAccountPaymentItemType.payee_account_id == icdoPayeeAccount.payee_account_id &&
                                                                       (o.icdoPayeeAccountPaymentItemType.end_date == DateTime.MinValue || o.icdoPayeeAccountPaymentItemType.end_date >= idtNextBenefitPaymentDate)).FirstOrDefault();

                    if (lobjPayeeAccountPayeeItemType != null)
                    {
                        #region Payment Item Type Found
                        //added, after recalculation is done, if an item have amount as zero, we need to enddate the existing one
                        if (adecAmount == 0.0M)
                        {
                            busPaymentItemType lobjPaymentItemType = new busPaymentItemType();
                            lobjPaymentItemType.FindPaymentItemType(lobjPayeeAccountPayeeItemType.icdoPayeeAccountPaymentItemType.payment_item_type_id);

                            if (lobjPayeeAccountPayeeItemType.icdoPayeeAccountPaymentItemType.start_date < idtNextBenefitPaymentDate)
                            {
                                // lobjPayeeAccountPayeeItemType.icdoPayeeAccountPaymentItemType.amount = adecAmount; //ask to abhishek
                                lobjPayeeAccountPayeeItemType.icdoPayeeAccountPaymentItemType.end_date = idtNextBenefitPaymentDate.AddDays(-1);
                                lobjPayeeAccountPayeeItemType.icdoPayeeAccountPaymentItemType.Update();
                            }
                            else //R3view with Vinovin If we need to do this.
                            {
                                if (iclbTaxWithHoldingHistory == null)
                                    LoadPayeeAccountTaxWithHoldingHistory();
                                foreach (busPayeeAccountTaxWithholding lobjtaxwithholding in iclbTaxWithHoldingHistory)
                                {
                                    lobjtaxwithholding.LoadPayeeAccountTaxWithholdingItemDetails();
                                    foreach (busPayeeAccountTaxWithholdingItemDetail lobjTaxWithholdingItemDetail in lobjtaxwithholding.iclbPayeeAccountTaxWithholdingItemDetail)
                                        if (lobjTaxWithholdingItemDetail.icdoPayeeAccountTaxWithholdingItemDetail.payee_account_payment_item_type_id ==
                                            lobjPayeeAccountPayeeItemType.icdoPayeeAccountPaymentItemType.payee_account_payment_item_type_id)
                                            lobjTaxWithholdingItemDetail.icdoPayeeAccountTaxWithholdingItemDetail.Delete();
                                }
                                lobjPayeeAccountPayeeItemType.icdoPayeeAccountPaymentItemType.Delete();
                            }
                        }
                        else if (lobjPayeeAccountPayeeItemType.icdoPayeeAccountPaymentItemType.start_date < idtNextBenefitPaymentDate)
                        {
                            if (ibusCurrentActivePayeeAccount == null)
                                LoadActivePayeeStatusAsofNextBenefitPaymentDate();
                            if (lobjPayeeAccountPayeeItemType.icdoPayeeAccountPaymentItemType.start_date == adteStartDate)
                            {
                                if (IsPayeeAccountStatusProcessedORRecieving())
                                {
                                    return 0;
                                }
                                else
                                {
                                    lobjPayeeAccountPayeeItemType.icdoPayeeAccountPaymentItemType.amount = adecAmount;
                                    lobjPayeeAccountPayeeItemType.icdoPayeeAccountPaymentItemType.payment_item_type_id = lintPaymentItemTypeID;
                                    //R3view the Following 2 Lines with Vinovin
                                    lobjPayeeAccountPayeeItemType.icdoPayeeAccountPaymentItemType.start_date = adteStartDate;
                                    lobjPayeeAccountPayeeItemType.icdoPayeeAccountPaymentItemType.end_date = adtEndDate;
                                    lobjPayeeAccountPayeeItemType.icdoPayeeAccountPaymentItemType.Update();
                                    lblnCreate = false;
                                    return lobjPayeeAccountPayeeItemType.icdoPayeeAccountPaymentItemType.payee_account_payment_item_type_id;
                                }
                            }
                            else
                            {
                                lobjPayeeAccountPayeeItemType.icdoPayeeAccountPaymentItemType.end_date = adteStartDate.AddDays(-1);
                                lobjPayeeAccountPayeeItemType.icdoPayeeAccountPaymentItemType.Update();
                                lblnCreate = true;
                            }
                        }
                        else
                        {
                            lobjPayeeAccountPayeeItemType.icdoPayeeAccountPaymentItemType.amount = adecAmount;
                            lobjPayeeAccountPayeeItemType.icdoPayeeAccountPaymentItemType.payment_item_type_id = lintPaymentItemTypeID;
                            //R3view the Following 2 Lines with Vinovin
                            lobjPayeeAccountPayeeItemType.icdoPayeeAccountPaymentItemType.start_date = adteStartDate;
                            lobjPayeeAccountPayeeItemType.icdoPayeeAccountPaymentItemType.end_date = adtEndDate;
                            lobjPayeeAccountPayeeItemType.icdoPayeeAccountPaymentItemType.Update();
                            lblnCreate = false;
                            return lobjPayeeAccountPayeeItemType.icdoPayeeAccountPaymentItemType.payee_account_payment_item_type_id;
                        }
                        #endregion
                    }
                    else
                    {
                        lblnCreate = true;
                    }
                    #endregion
                }

                if ((lblnCreate) && (adecAmount > 0))
                {
                    busPayeeAccountPaymentItemType lbusPayeeAccountPayementItemType = CreatePayeeAccountPaymentItemType(lintPaymentItemTypeID, adecAmount, astrAccountNo, aintVendorOrgID, adteStartDate, adtEndDate, astrReIssueFlag);
                    lbusPayeeAccountPayementItemType.icdoPayeeAccountPaymentItemType.Insert();
                    return lbusPayeeAccountPayementItemType.icdoPayeeAccountPaymentItemType.payee_account_payment_item_type_id;
                }
            }
            return 0;
        }

        public busPayeeAccountPaymentItemType CreatePayeeAccountPaymentItemType(int aintPaymentItemTypeID, decimal adecAmount, string astrAccountNo, int aintVendorOrgID,
                                                                               DateTime adteStartDate, DateTime adtEndDate, string astrReIssueFlag)
        {
            busPayeeAccountPaymentItemType lbusPayeeAccountItemType = new busPayeeAccountPaymentItemType { icdoPayeeAccountPaymentItemType = new cdoPayeeAccountPaymentItemType() };
            lbusPayeeAccountItemType.icdoPayeeAccountPaymentItemType.payee_account_id = icdoPayeeAccount.payee_account_id;
            lbusPayeeAccountItemType.icdoPayeeAccountPaymentItemType.payment_item_type_id = aintPaymentItemTypeID;
            lbusPayeeAccountItemType.icdoPayeeAccountPaymentItemType.amount = adecAmount;
            lbusPayeeAccountItemType.icdoPayeeAccountPaymentItemType.account_number = astrAccountNo;
            lbusPayeeAccountItemType.icdoPayeeAccountPaymentItemType.vendor_org_id = aintVendorOrgID;
            lbusPayeeAccountItemType.icdoPayeeAccountPaymentItemType.start_date = adteStartDate;
            lbusPayeeAccountItemType.icdoPayeeAccountPaymentItemType.end_date = adtEndDate;
            lbusPayeeAccountItemType.icdoPayeeAccountPaymentItemType.reissue_item_flag = astrReIssueFlag;
            return lbusPayeeAccountItemType;
        }


        public void CreateApprovedPayeeAccountStatus(string lstrModifiedBy)
        {
            busPayeeAccountStatus lbusPayeeAccountStatus = new busPayeeAccountStatus { icdoPayeeAccountStatus = new cdoPayeeAccountStatus() };

            lbusPayeeAccountStatus.icdoPayeeAccountStatus.modified_by = lstrModifiedBy;
            lbusPayeeAccountStatus.icdoPayeeAccountStatus.created_by = lstrModifiedBy;
            lbusPayeeAccountStatus.icdoPayeeAccountStatus.payee_account_id = icdoPayeeAccount.payee_account_id;
            lbusPayeeAccountStatus.icdoPayeeAccountStatus.status_value = busConstant.PAYEE_ACCOUNT_STATUS_APPROVED;
            lbusPayeeAccountStatus.icdoPayeeAccountStatus.status_effective_date = DateTime.Now;
            lbusPayeeAccountStatus.icdoPayeeAccountStatus.Insert();
        }


        // Inserting a Review record changes the Payee Account Status to Review        
        public void CreateReviewPayeeAccountStatus(bool ablnFromApprovedCalc = false) //PIR 1055
        {
            string lstrStatus = string.Empty;
            LoadActivePayeeStatusAsofNextBenefitPaymentDate();

            //PIR 853
            if (ibusPayee == null && icdoPayeeAccount.person_id > 0)
            {
                ibusPayee = new busPerson { icdoPerson = new cdoPerson() };
                ibusPayee.FindPerson(icdoPayeeAccount.person_id);
            }

            if (ibusPayee != null && ibusPayee.icdoPerson.date_of_death != DateTime.MinValue && ibusCurrentActivePayeeAccount != null &&
                (ibusCurrentActivePayeeAccount.icdoPayeeAccountStatus.status_value == busConstant.PAYEE_ACCOUNT_STATUS_SUSPENDED ||
                ibusCurrentActivePayeeAccount.icdoPayeeAccountStatus.status_value == busConstant.PAYEE_ACCOUNT_STATUS_COMPLETED))
            {
                return;
            }

            if (ibusCurrentActivePayeeAccount == null)
            {
                CreateReviewStatus();
            }
            else
            {
                if (IsReviewStatusAllowed(ablnFromApprovedCalc))  //PIR 1055
                {
                    CreateReviewStatus();
                }
                else if (ibusCurrentActivePayeeAccount.icdoPayeeAccountStatus.status_value == busConstant.PAYEE_ACCOUNT_STATUS_REVIEW)
                {
                    ibusCurrentActivePayeeAccount.icdoPayeeAccountStatus.status_effective_date = DateTime.Now;
                    ibusCurrentActivePayeeAccount.icdoPayeeAccountStatus.modified_date = DateTime.Now;
                    ibusCurrentActivePayeeAccount.icdoPayeeAccountStatus.modified_by = iobjPassInfo.istrUserID;
                    ibusCurrentActivePayeeAccount.icdoPayeeAccountStatus.Update();
                }
            }

            //U24074
            if (icdoPayeeAccount.adverse_interest_flag == busConstant.FLAG_YES)
            {
                icdoPayeeAccount.adverse_interest_flag = busConstant.FLAG_NO;
                icdoPayeeAccount.Update();
            }
        }
        public void CreateReviewPayeeAccountStatusAftComplte()
        {
            string lstrStatus = string.Empty;
            LoadActivePayeeStatusAsofNextBenefitPaymentDate();

            if (ibusCurrentActivePayeeAccount == null)
            {
                CreateReviewStatus();
            }
            else
            {
                if (IsReviewStatusAllowedAftCMPL())
                {
                    CreateReviewStatus();
                }
                else if (ibusCurrentActivePayeeAccount.icdoPayeeAccountStatus.status_value == busConstant.PAYEE_ACCOUNT_STATUS_REVIEW)
                {
                    ibusCurrentActivePayeeAccount.icdoPayeeAccountStatus.status_effective_date = DateTime.Now;
                    ibusCurrentActivePayeeAccount.icdoPayeeAccountStatus.modified_date = DateTime.Now;
                    ibusCurrentActivePayeeAccount.icdoPayeeAccountStatus.modified_by = iobjPassInfo.istrUserID;
                    ibusCurrentActivePayeeAccount.icdoPayeeAccountStatus.Update();
                }
            }
        }
        public bool IsReviewStatusAllowed(bool ablnFromApprovedCalc = false)//PIR 1055
        {
            string lstrStatus = string.Empty;
            bool lblnIsReviewStatusAllowed = true;

            if (ibusCurrentActivePayeeAccount == null)
                LoadActivePayeeStatusAsofNextBenefitPaymentDate();



            if (ibusCurrentActivePayeeAccount != null)
            {
                lstrStatus = ibusCurrentActivePayeeAccount.icdoPayeeAccountStatus.status_value;
                //PIR 1055
                if (ablnFromApprovedCalc)
                {
                    if (lstrStatus == busConstant.PAYEE_ACCOUNT_STATUS_CANCELLED || lstrStatus == busConstant.PAYEE_ACCOUNT_STATUS_REVIEW ||
                        (icdoPayeeAccount.iintPlanId != busConstant.IAP_PLAN_ID && lstrStatus == busConstant.PAYEE_ACCOUNT_STATUS_COMPLETED))
                    {
                        lblnIsReviewStatusAllowed = false;
                    }

                    //10 Percent
                    if (icdoPayeeAccount.iintPlanId != busConstant.IAP_PLAN_ID && lstrStatus == busConstant.PAYEE_ACCOUNT_STATUS_COMPLETED
                        && icdoPayeeAccount.istrBenefitOptionValue == busConstant.LUMP_SUM && icdoPayeeAccount.retiree_incr_flag != busConstant.FLAG_YES &&
                        (icdoPayeeAccount.benefit_account_type_value == busConstant.BENEFIT_TYPE_DEATH_PRE_RETIREMENT || icdoPayeeAccount.benefit_account_type_value == busConstant.BENEFIT_TYPE_RETIREMENT)
                        && icdoPayeeAccount.istrDeathNotificationStatus != busConstant.NOTIFICATION_STATUS_CERTIFIED)
                    {
                        lblnIsReviewStatusAllowed = true;
                    }
                }
                else
                {
                    //Check for the Active status,if it is not review and then allow to change the status to review
                    if (lstrStatus == busConstant.PAYEE_ACCOUNT_STATUS_REVIEW || lstrStatus == busConstant.PAYEE_ACCOUNT_STATUS_CANCELLED
                        || lstrStatus == busConstant.PAYEE_ACCOUNT_STATUS_COMPLETED || lstrStatus == busConstant.PAYEE_ACCOUNT_STATUS_SUSPENDED)
                    {
                        lblnIsReviewStatusAllowed = false;
                    }
                }
            }
            return lblnIsReviewStatusAllowed;
        }
        public bool IsReviewStatusAllowedAftCMPL()
        {
            string lstrStatus = string.Empty;
            bool lblnIsReviewStatusAllowed = true;

            if (ibusCurrentActivePayeeAccount == null)
                LoadActivePayeeStatusAsofNextBenefitPaymentDate();

            if (ibusCurrentActivePayeeAccount != null)
            {
                //Check for the Active status,if it is not review and then allow to change the status to review
                lstrStatus = ibusCurrentActivePayeeAccount.icdoPayeeAccountStatus.status_value;
                if (lstrStatus == busConstant.PAYEE_ACCOUNT_STATUS_REVIEW || lstrStatus == busConstant.PAYEE_ACCOUNT_STATUS_CANCELLED
                     || lstrStatus == busConstant.PAYEE_ACCOUNT_STATUS_SUSPENDED)
                {
                    lblnIsReviewStatusAllowed = false;
                }
            }
            return lblnIsReviewStatusAllowed;
        }

        public void CreateReviewStatus()
        {
            busPayeeAccountStatus lbusPayeeAccountStatus = new busPayeeAccountStatus { icdoPayeeAccountStatus = new cdoPayeeAccountStatus() };

            lbusPayeeAccountStatus.icdoPayeeAccountStatus.payee_account_id = icdoPayeeAccount.payee_account_id;
            lbusPayeeAccountStatus.icdoPayeeAccountStatus.status_value = busConstant.PAYEE_ACCOUNT_STATUS_REVIEW;

            //Ticket#69506
            if (astrCheckCurrentPage == busConstant.PAYEE_ACCOUNT_ACH_MAINTENANCE)
            {
                lbusPayeeAccountStatus.icdoPayeeAccountStatus.review_status_reason_value = busConstant.PAYEE_REVIEW_STATUS_REASON_VALUE;
            }

            #region Commented Code
            //if (icdoPayeeAccount.benefit_account_type_value == busConstant.ApplicationBenefitTypeRefund)
            //{
            //    lbusPayeeAccountStatus.icdoPayeeAccountStatus.status_value = busConstant.PayeeAccountStatusRefundReview;
            //}
            //else if (icdoPayeeAccount.benefit_account_type_value == busConstant.ApplicationBenefitTypeRetirement)
            //{
            //    lbusPayeeAccountStatus.icdoPayeeAccountStatus.status_value = busConstant.PayeeAccountStatusRetirementReview;
            //}
            //else if (icdoPayeeAccount.benefit_account_type_value == busConstant.ApplicationBenefitTypeDisability)
            //{
            //    lbusPayeeAccountStatus.icdoPayeeAccountStatus.status_value = busConstant.PayeeAccountStatusDisabilityReview;
            //}
            //else if (icdoPayeeAccount.benefit_account_type_value == busConstant.ApplicationBenefitTypePreRetirementDeath)
            //{
            //    lbusPayeeAccountStatus.icdoPayeeAccountStatus.status_value = busConstant.PayeeAccountStatusPreDeathReview;
            //}
            //else if (icdoPayeeAccount.benefit_account_type_value == busConstant.ApplicationBenefitTypePostRetirementDeath)
            //{
            //    lbusPayeeAccountStatus.icdoPayeeAccountStatus.status_value = busConstant.PayeeAccountStatusPostDeathReview;
            //}
            #endregion
            lbusPayeeAccountStatus.icdoPayeeAccountStatus.status_effective_date = DateTime.Now;
            lbusPayeeAccountStatus.icdoPayeeAccountStatus.Insert();
        }

        //Kept specially for now inthe case of one special condition in Disability
        public int CreateRetroPayments(busPayeeAccount abusPayeeAccount, Decimal adecTaxableAmt, Decimal adecNonTaxableAmt, DateTime adtPaymentDate, DateTime adtRetirementDate, int aintPayeeAccountID, string astrRetroPaymentType = null, Collection<busBenefitMonthwiseAdjustmentDetail> aclbBenefitMonthwiseAdjustmentDetail = null)
        {
            //Create Retro Payment Items 
            if (abusPayeeAccount.iclbRetroItemType.IsNullOrEmpty())
                abusPayeeAccount.LoadRetroItemType();
            if (abusPayeeAccount.iclbPaymentItemType.IsNullOrEmpty())
                abusPayeeAccount.LoadPaymentItemType();

            int lintPayeeAccountRetroPaymentId = 0;
            string istrCorrespondingInitialRetroItemCodeTaxable = string.Empty;
            string istrCorrespondingInitialRetroItemCodeNonTaxable = string.Empty;

            int lintOriginalPaymentTypeIdTaxable = 0;
            int lintOriginalPaymentTypeIdNonTaxable = 0;

            int lintPayeeAccountPaymentTypeIdTaxable = 0;
            int lintPayeeAccountPaymentTypeIdNonTaxable = 0;

            int lintPaymentTypeIdRetroTaxable = 0;
            int lintPaymentTypeIdRetroNonTaxable = 0;

            int lintPayeeAccountRetroTaxablePaymentDetailId = 0;
            int lintPayeeAccountRetroNonTaxablePaymentDetailId = 0;


            if (adecTaxableAmt > 0.0M)
            {
                //Taxable Section For Retro
                istrCorrespondingInitialRetroItemCodeTaxable = abusPayeeAccount.iclbRetroItemType.Where(item => item.icdoRetroItemType.from_item_type == busConstant.ITEM1 && item.icdoRetroItemType.retro_payment_type_value == busConstant.RETRO_PAYMENT_INITIAL).First().icdoRetroItemType.to_item_type;
                lintPayeeAccountPaymentTypeIdTaxable = abusPayeeAccount.CreatePayeeAccountPaymentItemType(istrCorrespondingInitialRetroItemCodeTaxable, adecTaxableAmt, string.Empty, 0, adtPaymentDate, adtPaymentDate.GetLastDayofMonth(), String.Empty, false);

                lintOriginalPaymentTypeIdTaxable = abusPayeeAccount.iclbPaymentItemType.Where(item => item.icdoPaymentItemType.item_type_code == busConstant.ITEM1).First().icdoPaymentItemType.payment_item_type_id;
                lintPaymentTypeIdRetroTaxable = abusPayeeAccount.iclbPaymentItemType.Where(item => item.icdoPaymentItemType.item_type_code == istrCorrespondingInitialRetroItemCodeTaxable).First().icdoPaymentItemType.payment_item_type_id;

            }

            if (adecNonTaxableAmt > 0.0M)
            {
                //Non-Taxable Section for Retro
                istrCorrespondingInitialRetroItemCodeNonTaxable = abusPayeeAccount.iclbRetroItemType.Where(item => item.icdoRetroItemType.from_item_type == busConstant.ITEM2 && item.icdoRetroItemType.retro_payment_type_value == busConstant.RETRO_PAYMENT_INITIAL).First().icdoRetroItemType.to_item_type;
                lintPayeeAccountPaymentTypeIdNonTaxable = abusPayeeAccount.CreatePayeeAccountPaymentItemType(istrCorrespondingInitialRetroItemCodeNonTaxable, adecNonTaxableAmt, string.Empty, 0, adtPaymentDate, adtPaymentDate.GetLastDayofMonth(), String.Empty, true, false);

                lintOriginalPaymentTypeIdNonTaxable = abusPayeeAccount.iclbPaymentItemType.Where(item => item.icdoPaymentItemType.item_type_code == busConstant.ITEM2).First().icdoPaymentItemType.payment_item_type_id;
                lintPaymentTypeIdRetroNonTaxable = abusPayeeAccount.iclbPaymentItemType.Where(item => item.icdoPaymentItemType.item_type_code == istrCorrespondingInitialRetroItemCodeNonTaxable).First().icdoPaymentItemType.payment_item_type_id;
            }

            //Retro Summary Table Entry 
            this.LoadPayeeAccountRetroPayments();
            busPayeeAccountRetroPayment lbusPayeeAccountRetroPayment = new busPayeeAccountRetroPayment();
            if (astrRetroPaymentType != null)
            {
                lintPayeeAccountRetroPaymentId = lbusPayeeAccountRetroPayment.CreatePayeeAccountRetroPayment(aintPayeeAccountID, astrRetroPaymentType, adtRetirementDate, adtRetirementDate.AddMonths(busGlobalFunctions.GetMonthsBetweenTwoDates(adtRetirementDate, adtPaymentDate)),
                                                adtPaymentDate, adtPaymentDate.GetLastDayofMonth(), busConstant.PAYMENT_OPTION_REGULAR, (adecTaxableAmt) + (adecNonTaxableAmt),
                                                (adecTaxableAmt) + (adecNonTaxableAmt), string.Empty, iclbPayeeAccountRetroPayment, null);
            }
            else
            {
                lintPayeeAccountRetroPaymentId = lbusPayeeAccountRetroPayment.CreatePayeeAccountRetroPayment(aintPayeeAccountID, busConstant.RETRO_PAYMENT_INITIAL, adtRetirementDate, adtRetirementDate.AddMonths(busGlobalFunctions.GetMonthsBetweenTwoDates(adtRetirementDate, adtPaymentDate)),
                                                 adtPaymentDate, adtPaymentDate.GetLastDayofMonth(), busConstant.PAYMENT_OPTION_REGULAR, (adecTaxableAmt) + (adecNonTaxableAmt),
                                                 (adecTaxableAmt) + (adecNonTaxableAmt), string.Empty, iclbPayeeAccountRetroPayment, null);
            }

            //Retro Item Detail Table Entries
            LoadPayeeAccountRetroPaymentDetails();
            busPayeeAccountRetroPaymentDetail lbusPayeeAccountRetroPaymentDetail = new busPayeeAccountRetroPaymentDetail();
            if (adecTaxableAmt > 0.0M)
                lintPayeeAccountRetroTaxablePaymentDetailId = lbusPayeeAccountRetroPaymentDetail.CreatePayeeAccountRetroPaymentDetail(lintPayeeAccountRetroPaymentId,
                                                            lintPaymentTypeIdRetroTaxable, lintPayeeAccountPaymentTypeIdTaxable, adecTaxableAmt, 0,
                                                            lintOriginalPaymentTypeIdTaxable, iclbPayeeAccountRetroPayment);

            lbusPayeeAccountRetroPaymentDetail = new busPayeeAccountRetroPaymentDetail();
            if (adecNonTaxableAmt > 0.0M)
                lintPayeeAccountRetroNonTaxablePaymentDetailId = lbusPayeeAccountRetroPaymentDetail.CreatePayeeAccountRetroPaymentDetail(lintPayeeAccountRetroPaymentId,
                                                                lintPaymentTypeIdRetroNonTaxable, lintPayeeAccountPaymentTypeIdNonTaxable, adecNonTaxableAmt, 0,
                                                                lintOriginalPaymentTypeIdNonTaxable, iclbPayeeAccountRetroPayment);


            #region Insert into Benefit Monthwise Adjustment Detail
            if (aclbBenefitMonthwiseAdjustmentDetail != null && aclbBenefitMonthwiseAdjustmentDetail.Count > 0)
            {
                foreach (busBenefitMonthwiseAdjustmentDetail lbusBenefitMonthwiseAdjustmentDetail in aclbBenefitMonthwiseAdjustmentDetail)
                {
                    if (lbusBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.benefit_monthwise_adjustment_detail_id == 0)
                    {
                        if (lintPayeeAccountRetroPaymentId > 0)
                        {
                            lbusBenefitMonthwiseAdjustmentDetail.CreateMonthwiseAdjustmentDetail(lintPayeeAccountRetroPaymentId, lbusBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.payment_date,
                                lbusBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.taxable_amount_to_be_paid, lbusBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.non_taxable_amount_to_be_paid,
                                lbusBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.taxable_amount_paid, lbusBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.non_taxable_amount_paid, lbusBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.hours,
                                lbusBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.suspended_flag, lbusBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.payment_history_header_id, lbusBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.amount_repaid);

                        }
                    }
                    else
                    {
                        lbusBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.Update();
                    }

                }
            }
            #endregion Insert into Benefit Monthwise Adjustment Detail

            return lintPayeeAccountRetroPaymentId;
        }


        public void CreateRetroPayments(busPayeeAccount abusPayeeAccount, DateTime adtPaymentDate, DateTime adtRetirementDate, int aintPayeeAccountID, string RETRO_PAYMENT_TYPE, Collection<busBenefitMonthwiseAdjustmentDetail> aclbBenefitMonthwiseAdjustmentDetail = null)
        {
            if (idtNextBenefitPaymentDate == DateTime.MinValue)
                LoadNextBenefitPaymentDate();
            //Create Retro Payment Items 
            if (abusPayeeAccount.iclbRetroItemType.IsNullOrEmpty())
                abusPayeeAccount.LoadRetroItemType();
            if (abusPayeeAccount.iclbPayeeAccountPaymentItemType.IsNullOrEmpty())
                abusPayeeAccount.LoadPayeeAccountPaymentItemType();

            int lintPayeeAccountRetroPaymentId = 0;
            string istrCorrespondingInitialRetroItemCodeTaxable = string.Empty;
            string istrCorrespondingInitialRetroItemCodeNonTaxable = string.Empty;
            int lintOriginalPaymentTypeIdTaxable = 0;
            int lintPayeeAccountPaymentTypeIdTaxable = 0;
            int lintPaymentTypeIdRetroTaxable = 0;
            int lintPayeeAccountRetroTaxablePaymentDetailId = 0;

            iclbPayeeAccountPaymentItemTypeActive = (from item in this.iclbPayeeAccountPaymentItemType
                                                     where busGlobalFunctions.CheckDateOverlapping(idtNextBenefitPaymentDate,
                                                     item.icdoPayeeAccountPaymentItemType.start_date, item.icdoPayeeAccountPaymentItemType.end_date)
                                                     && item.ibusPaymentItemType.icdoPaymentItemType.allow_rollover_code_value != busConstant.RolloverItemReductionCheck
                                                     select item).ToList().ToCollection<busPayeeAccountPaymentItemType>();

            //R3view - For IAP this will be friday so we might have to Write a code.
            //int lintDiffinMonths = adtPaymentDate.Month - adtRetirementDate.Month;
            int lintDiffinMonths = busGlobalFunctions.GetMonthsBetweenTwoDates(adtRetirementDate, adtPaymentDate);
            decimal adecAllTaxble = (from obj in iclbPayeeAccountPaymentItemTypeActive.AsEnumerable()
                                     where obj.ibusPaymentItemType.icdoPaymentItemType.base_amount_flag == busConstant.FLAG_YES

                                     && obj.ibusPaymentItemType.icdoPaymentItemType.item_type_direction == 1
                                     select obj.icdoPayeeAccountPaymentItemType.amount).Sum();
            this.LoadPayeeAccountRetroPayments();
            busPayeeAccountRetroPayment lbusPayeeAccountRetroPayment = new busPayeeAccountRetroPayment();
            lintPayeeAccountRetroPaymentId = lbusPayeeAccountRetroPayment.CreatePayeeAccountRetroPayment(aintPayeeAccountID, RETRO_PAYMENT_TYPE, adtRetirementDate, adtRetirementDate.AddMonths(lintDiffinMonths).AddDays(-1),
                                             adtPaymentDate, adtPaymentDate.GetLastDayofMonth(), busConstant.PAYMENT_OPTION_REGULAR, (adecAllTaxble * lintDiffinMonths),
                                             (adecAllTaxble * lintDiffinMonths), string.Empty, iclbPayeeAccountRetroPayment, null);

            foreach (busPayeeAccountPaymentItemType aibusPayeeAccountPaymentItemType in iclbPayeeAccountPaymentItemTypeActive)
            {
                if (abusPayeeAccount.iclbRetroItemType.Where(item => item.icdoRetroItemType.from_item_type == aibusPayeeAccountPaymentItemType.ibusPaymentItemType.icdoPaymentItemType.item_type_code && item.icdoRetroItemType.retro_payment_type_value == RETRO_PAYMENT_TYPE).Count() > 0)
                {
                    istrCorrespondingInitialRetroItemCodeTaxable = abusPayeeAccount.iclbRetroItemType.Where(item => item.icdoRetroItemType.from_item_type == aibusPayeeAccountPaymentItemType.ibusPaymentItemType.icdoPaymentItemType.item_type_code && item.icdoRetroItemType.retro_payment_type_value == RETRO_PAYMENT_TYPE).First().icdoRetroItemType.to_item_type;
                    lintPayeeAccountPaymentTypeIdTaxable = abusPayeeAccount.CreatePayeeAccountPaymentItemType(istrCorrespondingInitialRetroItemCodeTaxable, aibusPayeeAccountPaymentItemType.icdoPayeeAccountPaymentItemType.amount * lintDiffinMonths, string.Empty, 0, adtPaymentDate, adtPaymentDate.GetLastDayofMonth(), String.Empty, false);

                    lintOriginalPaymentTypeIdTaxable = abusPayeeAccount.iclbPaymentItemType.Where(item => item.icdoPaymentItemType.item_type_code == aibusPayeeAccountPaymentItemType.ibusPaymentItemType.icdoPaymentItemType.item_type_code).First().icdoPaymentItemType.payment_item_type_id;
                    lintPaymentTypeIdRetroTaxable = abusPayeeAccount.iclbPaymentItemType.Where(item => item.icdoPaymentItemType.item_type_code == istrCorrespondingInitialRetroItemCodeTaxable).First().icdoPaymentItemType.payment_item_type_id;

                    if (aibusPayeeAccountPaymentItemType.icdoPayeeAccountPaymentItemType.amount > 0.0M)
                    {
                        LoadPayeeAccountRetroPaymentDetails();
                        busPayeeAccountRetroPaymentDetail lbusPayeeAccountRetroPaymentDetail = new busPayeeAccountRetroPaymentDetail();
                        lintPayeeAccountRetroTaxablePaymentDetailId = lbusPayeeAccountRetroPaymentDetail.CreatePayeeAccountRetroPaymentDetail(lintPayeeAccountRetroPaymentId,
                                                                     lintPaymentTypeIdRetroTaxable, lintPayeeAccountPaymentTypeIdTaxable,
                                                                     aibusPayeeAccountPaymentItemType.icdoPayeeAccountPaymentItemType.amount * lintDiffinMonths,
                                                                     0, lintOriginalPaymentTypeIdTaxable, iclbPayeeAccountRetroPayment);
                    }
                }
            }

            #region Insert into Benefit Monthwise Adjustment Detail
            if (aclbBenefitMonthwiseAdjustmentDetail != null && aclbBenefitMonthwiseAdjustmentDetail.Count > 0)
            {
                foreach (busBenefitMonthwiseAdjustmentDetail lbusBenefitMonthwiseAdjustmentDetail in aclbBenefitMonthwiseAdjustmentDetail)
                {
                    if (lbusBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.benefit_monthwise_adjustment_detail_id == 0)
                    {
                        if (lintPayeeAccountRetroPaymentId > 0)
                        {
                            lbusBenefitMonthwiseAdjustmentDetail.CreateMonthwiseAdjustmentDetail(lintPayeeAccountRetroPaymentId, lbusBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.payment_date,
                                lbusBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.taxable_amount_to_be_paid, lbusBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.non_taxable_amount_to_be_paid,
                                lbusBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.taxable_amount_paid, lbusBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.non_taxable_amount_paid, lbusBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.hours,
                                lbusBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.suspended_flag, lbusBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.payment_history_header_id, lbusBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.amount_repaid);

                        }
                    }
                    else
                    {
                        lbusBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.Update();
                    }

                }
            }
            #endregion Insert into Benefit Monthwise Adjustment Detail

            this.ProcessTaxWithHoldingDetails();
        }

        //For Payments Adjustment
        public int CreateRetroPayments(busPayeeAccount abusPayeeAccount, DateTime adtPaymentDate, DateTime adtEffectiveStartDate, DateTime adtEffectiveEndDate,
            decimal adecTaxableAmount, decimal adecNonTaxableAmount, ref Collection<busBenefitMonthwiseAdjustmentDetail> aclbBenefitMonthwiseAdjustmentDetail, string astrRetroPaymentType, Collection<busPayeeAccountRetroPayment> aclbbusPayeeAccountRetroPayment = null)
        {
            if (idtNextBenefitPaymentDate == DateTime.MinValue)
                LoadNextBenefitPaymentDate();

            //Create Retro Payment Items 
            if (abusPayeeAccount.iclbRetroItemType.IsNullOrEmpty())
                abusPayeeAccount.LoadRetroItemType();
            if (abusPayeeAccount.iclbPaymentItemType.IsNullOrEmpty())
                abusPayeeAccount.LoadPaymentItemType();
            if (abusPayeeAccount.iclbPayeeAccountPaymentItemType.IsNullOrEmpty())
                abusPayeeAccount.LoadPayeeAccountPaymentItemType();
            if (abusPayeeAccount.iclbPayeeAccountRetroPayment.IsNullOrEmpty())
                abusPayeeAccount.LoadPayeeAccountRetroPayments();

            string lstrCorrespondingInitialRetroItemCodeTaxable = string.Empty;
            string lstrCorrespondingInitialRetroItemCodeNonTaxable = string.Empty;
            int lintOriginalPaymentTypeIdTaxable = 0;
            int lintOriginalPaymentTypeIdNonTaxable = 0;

            int lintPaymentTypeIdTaxable = 0;
            int lintPaymentTypeIdNonTaxable = 0;
            int lintPayeeAccountRetroPaymentId = 0;
            int lintTaxablePayeeAccountPaymentItemTypeId = 0;
            int lintNonTaxablePayeeAccountPaymentItemTypeId = 0;

            abusPayeeAccount.iclbPayeeAccountPaymentItemTypeActive = (from item in this.iclbPayeeAccountPaymentItemType
                                                                      where busGlobalFunctions.CheckDateOverlapping(idtNextBenefitPaymentDate,
                                                                      item.icdoPayeeAccountPaymentItemType.start_date, item.icdoPayeeAccountPaymentItemType.end_date)
                                                                      && item.ibusPaymentItemType.icdoPaymentItemType.allow_rollover_code_value != busConstant.RolloverItemReductionCheck
                                                                      select item).ToList().ToCollection<busPayeeAccountPaymentItemType>();

            if (adecTaxableAmount > 0.0M)
            {
                //Taxable Section For Retro
                if (abusPayeeAccount.icdoPayeeAccount.iintPlanId == busConstant.IAP_PLAN_ID)
                {
                    lstrCorrespondingInitialRetroItemCodeTaxable = abusPayeeAccount.iclbRetroItemType.Where(item => item.icdoRetroItemType.from_item_type == busConstant.ITEM21 && item.icdoRetroItemType.retro_payment_type_value == busConstant.RETRO_PAYMENT_INITIAL).First().icdoRetroItemType.to_item_type;

                    lintOriginalPaymentTypeIdTaxable = abusPayeeAccount.iclbPaymentItemType.Where(item => item.icdoPaymentItemType.item_type_code == busConstant.ITEM21).First().icdoPaymentItemType.payment_item_type_id;
                    lintPaymentTypeIdTaxable = abusPayeeAccount.iclbPaymentItemType.Where(item => item.icdoPaymentItemType.item_type_code == lstrCorrespondingInitialRetroItemCodeTaxable).First().icdoPaymentItemType.payment_item_type_id;

                }
                else
                {
                    lstrCorrespondingInitialRetroItemCodeTaxable = abusPayeeAccount.iclbRetroItemType.Where(item => item.icdoRetroItemType.from_item_type == busConstant.ITEM1 && item.icdoRetroItemType.retro_payment_type_value == busConstant.RETRO_PAYMENT_INITIAL).First().icdoRetroItemType.to_item_type;

                    lintOriginalPaymentTypeIdTaxable = abusPayeeAccount.iclbPaymentItemType.Where(item => item.icdoPaymentItemType.item_type_code == busConstant.ITEM1).First().icdoPaymentItemType.payment_item_type_id;
                    lintPaymentTypeIdTaxable = abusPayeeAccount.iclbPaymentItemType.Where(item => item.icdoPaymentItemType.item_type_code == lstrCorrespondingInitialRetroItemCodeTaxable).First().icdoPaymentItemType.payment_item_type_id;
                }

                decimal ldecTotalTaxableAmount = 0;
                if (abusPayeeAccount.iclbPayeeAccountPaymentItemTypeActive.Count > 0 && abusPayeeAccount.iclbPayeeAccountPaymentItemTypeActive.Where(item => item.icdoPayeeAccountPaymentItemType.payment_item_type_id == lintPaymentTypeIdTaxable).Count() > 0)
                {
                    busPayeeAccountPaymentItemType lbusPayeeAccountPaymentItemType = new busPayeeAccountPaymentItemType { icdoPayeeAccountPaymentItemType = new cdoPayeeAccountPaymentItemType() };
                    lbusPayeeAccountPaymentItemType = iclbPayeeAccountPaymentItemTypeActive.Where(item => item.icdoPayeeAccountPaymentItemType.payment_item_type_id == lintPaymentTypeIdTaxable).FirstOrDefault();

                    ldecTotalTaxableAmount = lbusPayeeAccountPaymentItemType.icdoPayeeAccountPaymentItemType.amount + adecTaxableAmount;

                }
                else
                {
                    //PROD PIR 490 -- Need to review
                    decimal idecTaxAmount = 0M;
                    if (adecNonTaxableAmount < 0)
                    {
                        idecTaxAmount = adecTaxableAmount + adecNonTaxableAmount;
                        ldecTotalTaxableAmount = idecTaxAmount;
                    }
                    else
                        ldecTotalTaxableAmount = adecTaxableAmount;
                }

                lintTaxablePayeeAccountPaymentItemTypeId = abusPayeeAccount.CreatePayeeAccountPaymentItemType(lstrCorrespondingInitialRetroItemCodeTaxable, ldecTotalTaxableAmount, null, 0, abusPayeeAccount.idtNextBenefitPaymentDate,
                    abusPayeeAccount.idtNextBenefitPaymentDate.GetLastDayofMonth(), busConstant.FLAG_NO, false);
            }

            if (adecNonTaxableAmount > 0.0M)
            {
                //Non-Taxable Section for Retro
                lstrCorrespondingInitialRetroItemCodeNonTaxable = abusPayeeAccount.iclbRetroItemType.Where(item => item.icdoRetroItemType.from_item_type == busConstant.ITEM2 && item.icdoRetroItemType.retro_payment_type_value == busConstant.RETRO_PAYMENT_INITIAL).First().icdoRetroItemType.to_item_type;

                lintOriginalPaymentTypeIdNonTaxable = abusPayeeAccount.iclbPaymentItemType.Where(item => item.icdoPaymentItemType.item_type_code == busConstant.ITEM2).First().icdoPaymentItemType.payment_item_type_id;
                lintPaymentTypeIdNonTaxable = abusPayeeAccount.iclbPaymentItemType.Where(item => item.icdoPaymentItemType.item_type_code == lstrCorrespondingInitialRetroItemCodeNonTaxable).First().icdoPaymentItemType.payment_item_type_id;

                decimal ldecTotalNonTaxableAmount = 0;
                if (abusPayeeAccount.iclbPayeeAccountPaymentItemTypeActive.Count > 0 && abusPayeeAccount.iclbPayeeAccountPaymentItemTypeActive.Where(item => item.icdoPayeeAccountPaymentItemType.payment_item_type_id == lintPaymentTypeIdNonTaxable).Count() > 0)
                {
                    busPayeeAccountPaymentItemType lbusPayeeAccountPaymentItemType = new busPayeeAccountPaymentItemType { icdoPayeeAccountPaymentItemType = new cdoPayeeAccountPaymentItemType() };
                    lbusPayeeAccountPaymentItemType = abusPayeeAccount.iclbPayeeAccountPaymentItemTypeActive.Where(item => item.icdoPayeeAccountPaymentItemType.payment_item_type_id == lintPaymentTypeIdNonTaxable).FirstOrDefault();

                    ldecTotalNonTaxableAmount = lbusPayeeAccountPaymentItemType.icdoPayeeAccountPaymentItemType.amount + adecNonTaxableAmount;
                }
                else
                {
                    ldecTotalNonTaxableAmount = adecNonTaxableAmount;
                }

                lintNonTaxablePayeeAccountPaymentItemTypeId = abusPayeeAccount.CreatePayeeAccountPaymentItemType(lstrCorrespondingInitialRetroItemCodeNonTaxable, ldecTotalNonTaxableAmount, null, 0, abusPayeeAccount.idtNextBenefitPaymentDate,
                   abusPayeeAccount.idtNextBenefitPaymentDate.GetLastDayofMonth(), busConstant.FLAG_NO, false);
            }


            //Retro Summary Table Entry 

            if (abusPayeeAccount.iclbPayeeAccountRetroPayment.Where(item => item.icdoPayeeAccountRetroPayment.retro_payment_type_value == busConstant.RETRO_PAYMENT_INITIAL &&
                item.icdoPayeeAccountRetroPayment.start_date == abusPayeeAccount.idtNextBenefitPaymentDate &&
                item.icdoPayeeAccountRetroPayment.end_date == abusPayeeAccount.idtNextBenefitPaymentDate.GetLastDayofMonth()).Count() > 0 && astrRetroPaymentType == busConstant.RETRO_PAYMENT_INITIAL)
            {

                busPayeeAccountRetroPayment lbusPayeeAccountRetroPayment = new busPayeeAccountRetroPayment { icdoPayeeAccountRetroPayment = new cdoPayeeAccountRetroPayment() };
                lbusPayeeAccountRetroPayment = abusPayeeAccount.iclbPayeeAccountRetroPayment.Where(item => item.icdoPayeeAccountRetroPayment.retro_payment_type_value == busConstant.RETRO_PAYMENT_INITIAL &&
                item.icdoPayeeAccountRetroPayment.start_date == abusPayeeAccount.idtNextBenefitPaymentDate &&
                item.icdoPayeeAccountRetroPayment.end_date == abusPayeeAccount.idtNextBenefitPaymentDate.GetLastDayofMonth()).FirstOrDefault();

                lbusPayeeAccountRetroPayment.icdoPayeeAccountRetroPayment.gross_payment_amount += (adecTaxableAmount + adecNonTaxableAmount);
                lbusPayeeAccountRetroPayment.icdoPayeeAccountRetroPayment.net_payment_amount += (adecTaxableAmount + adecNonTaxableAmount);
                lintPayeeAccountRetroPaymentId = lbusPayeeAccountRetroPayment.icdoPayeeAccountRetroPayment.payee_account_retro_payment_id;

                lbusPayeeAccountRetroPayment.icdoPayeeAccountRetroPayment.Update();

                lbusPayeeAccountRetroPayment.LoadPayeeAccountRetroPaymentDetails();

                if (lbusPayeeAccountRetroPayment.iclbPayeeAccountRetroPaymentDetail.Where(item => item.icdoPayeeAccountRetroPaymentDetail.payment_item_type_id == lintPaymentTypeIdTaxable).Count() > 0)
                {
                    busPayeeAccountRetroPaymentDetail lbusPayeeAccountRetroPaymentDetail = new busPayeeAccountRetroPaymentDetail { icdoPayeeAccountRetroPaymentDetail = new cdoPayeeAccountRetroPaymentDetail() };
                    lbusPayeeAccountRetroPaymentDetail = lbusPayeeAccountRetroPayment.iclbPayeeAccountRetroPaymentDetail.Where(item => item.icdoPayeeAccountRetroPaymentDetail.payment_item_type_id == lintPaymentTypeIdTaxable).FirstOrDefault();
                    lbusPayeeAccountRetroPaymentDetail.icdoPayeeAccountRetroPaymentDetail.amount += adecTaxableAmount;
                    lbusPayeeAccountRetroPaymentDetail.icdoPayeeAccountRetroPaymentDetail.Update();
                }

                if (lbusPayeeAccountRetroPayment.iclbPayeeAccountRetroPaymentDetail.Where(item => item.icdoPayeeAccountRetroPaymentDetail.payment_item_type_id == lintPaymentTypeIdNonTaxable).Count() > 0)
                {
                    busPayeeAccountRetroPaymentDetail lbusPayeeAccountRetroPaymentDetail = new busPayeeAccountRetroPaymentDetail { icdoPayeeAccountRetroPaymentDetail = new cdoPayeeAccountRetroPaymentDetail() };
                    lbusPayeeAccountRetroPaymentDetail = lbusPayeeAccountRetroPayment.iclbPayeeAccountRetroPaymentDetail.Where(item => item.icdoPayeeAccountRetroPaymentDetail.payment_item_type_id == lintPaymentTypeIdNonTaxable).FirstOrDefault();
                    lbusPayeeAccountRetroPaymentDetail.icdoPayeeAccountRetroPaymentDetail.amount += adecNonTaxableAmount;
                    lbusPayeeAccountRetroPaymentDetail.icdoPayeeAccountRetroPaymentDetail.Update();
                }
            }
            else
            {

                busPayeeAccountRetroPayment lbusPayeeAccountRetroPayment = new busPayeeAccountRetroPayment();
                lintPayeeAccountRetroPaymentId = lbusPayeeAccountRetroPayment.CreatePayeeAccountRetroPayment(abusPayeeAccount.icdoPayeeAccount.payee_account_id, astrRetroPaymentType,
                    adtEffectiveStartDate, adtEffectiveEndDate, adtPaymentDate,
                    adtPaymentDate.GetLastDayofMonth(), busConstant.PAYMENT_OPTION_REGULAR, (adecTaxableAmount) + (adecNonTaxableAmount),
                                                 (adecTaxableAmount) + (adecNonTaxableAmount), string.Empty, aclbbusPayeeAccountRetroPayment, busConstant.FLAG_NO);

                if (aclbbusPayeeAccountRetroPayment != null && aclbbusPayeeAccountRetroPayment.Count > 0)
                {
                    aclbbusPayeeAccountRetroPayment.FirstOrDefault().LoadPayeeAccountRetroPaymentDetails();
                }
                //Retro Item Detail Table Entries
                busPayeeAccountRetroPaymentDetail lbusPayeeAccountRetroPaymentDetail = new busPayeeAccountRetroPaymentDetail();
                if (adecTaxableAmount > 0.0M)
                {
                    if (adecNonTaxableAmount < 0)
                        adecTaxableAmount = adecTaxableAmount + adecNonTaxableAmount; // Need to review and test PROD PIR 490
                    lbusPayeeAccountRetroPaymentDetail.CreatePayeeAccountRetroPaymentDetail(lintPayeeAccountRetroPaymentId,
                                                                lintPaymentTypeIdTaxable, lintTaxablePayeeAccountPaymentItemTypeId, adecTaxableAmount, 0,
                                                                lintOriginalPaymentTypeIdTaxable, aclbbusPayeeAccountRetroPayment);
                }
                lbusPayeeAccountRetroPaymentDetail = new busPayeeAccountRetroPaymentDetail();
                if (adecNonTaxableAmount > 0.0M)
                    lbusPayeeAccountRetroPaymentDetail.CreatePayeeAccountRetroPaymentDetail(lintPayeeAccountRetroPaymentId,
                                                                    lintPaymentTypeIdNonTaxable, lintNonTaxablePayeeAccountPaymentItemTypeId, adecNonTaxableAmount, 0,
                                                                    lintOriginalPaymentTypeIdNonTaxable, aclbbusPayeeAccountRetroPayment);
            }
            return lintPayeeAccountRetroPaymentId;
        }

        //For Payments Adjustment
        public int CreateOverPayments(busPayeeAccount abusPayeeAccount, DateTime adtPaymentDate, DateTime adtEffectiveStartDate, DateTime adtEffectiveEndDate,
            decimal adecTaxableAmount, decimal adecNonTaxableAmount, string astrRetroPaymentType, Collection<busPayeeAccountRetroPayment> aclbbusPayeeAccountRetroPayment = null)
        {
            int lintPayeeAccountRetroPaymentId = 0;
            int lintPaymentTypeIdTaxable = abusPayeeAccount.GetPaymentItemTypeIDByItemCode(busConstant.ITEM1);
            int lintPaymentTypeIdNonTaxable = abusPayeeAccount.GetPaymentItemTypeIDByItemCode(busConstant.ITEM2);

            //Retro Summary Table Entry 
            busPayeeAccountRetroPayment lbusPayeeAccountRetroPayment = new busPayeeAccountRetroPayment();
            if (adecTaxableAmount > 0.0M || adecNonTaxableAmount > 0.0M)
            {
                lintPayeeAccountRetroPaymentId = lbusPayeeAccountRetroPayment.CreatePayeeAccountRetroPayment(abusPayeeAccount.icdoPayeeAccount.payee_account_id, astrRetroPaymentType, adtEffectiveStartDate, adtEffectiveEndDate, adtPaymentDate,
                                                 adtPaymentDate.GetLastDayofMonth(), busConstant.PAYMENT_OPTION_REGULAR, (adecTaxableAmount) + (adecNonTaxableAmount),
                                                 (adecTaxableAmount) + (adecNonTaxableAmount), string.Empty, aclbbusPayeeAccountRetroPayment, busConstant.FLAG_YES);
            }


            //Retro Item Detail Table Entries

            busPayeeAccountRetroPaymentDetail lbusPayeeAccountRetroPaymentDetail = new busPayeeAccountRetroPaymentDetail();
            if (adecTaxableAmount > 0.0M)
                lbusPayeeAccountRetroPaymentDetail.CreatePayeeAccountRetroPaymentDetail(lintPayeeAccountRetroPaymentId,
                                                            lintPaymentTypeIdTaxable, 0, adecTaxableAmount, 0,
                                                            lintPaymentTypeIdTaxable, aclbbusPayeeAccountRetroPayment);

            if (adecNonTaxableAmount > 0.0M)
                lbusPayeeAccountRetroPaymentDetail.CreatePayeeAccountRetroPaymentDetail(lintPayeeAccountRetroPaymentId,
                                                                lintPaymentTypeIdNonTaxable, 0, adecNonTaxableAmount, 0,
                                                                lintPaymentTypeIdNonTaxable, aclbbusPayeeAccountRetroPayment);

            return lintPayeeAccountRetroPaymentId;
        }

        //Payment Adjustment
        public void CreatePayeeAccountMinimumGuaranteeHistory(int aintPayeeAccountId, decimal adecOldMGAmount, decimal OldNonTaxableBeginningBalance, DateTime adtChangeDate)
        {
            cdoPayeeAccountMinimumGuaranteeHistory lcdoPayeeAccountMinimumGuaranteeHistory = new cdoPayeeAccountMinimumGuaranteeHistory();
            lcdoPayeeAccountMinimumGuaranteeHistory.payee_account_id = aintPayeeAccountId;
            lcdoPayeeAccountMinimumGuaranteeHistory.old_minimum_guarantee_amount = adecOldMGAmount;
            lcdoPayeeAccountMinimumGuaranteeHistory.old_non_taxable_beginning_amount = OldNonTaxableBeginningBalance;
            lcdoPayeeAccountMinimumGuaranteeHistory.change_date = adtChangeDate;
            lcdoPayeeAccountMinimumGuaranteeHistory.Insert();
        }


        /// <summary>
        /// Get Marital Status By Tax Identifier
        /// </summary>
        /// <param name="astrCodeValue"></param>
        /// <returns></returns>
        public Collection<cdoCodeValue> GetMaritalStatusByTaxIdentifier(string astrCodeValue)
        {
            Collection<cdoCodeValue> lclbMaritalStatus = new Collection<cdoCodeValue>();

            if (astrCodeValue.IsNotNullOrEmpty())
            {
                DataTable ldtbResultMaritalStatus = busBase.Select("cdoPayeeAccount.GetMaritalStatus", new object[1] { astrCodeValue });
                if (ldtbResultMaritalStatus.IsNotNull() && ldtbResultMaritalStatus.Rows.Count > 0)
                {
                    lclbMaritalStatus = doBase.GetCollection<cdoCodeValue>(ldtbResultMaritalStatus);
                }
            }
            return lclbMaritalStatus;
        }

        public cdoOrgAddress GetOrganizationAddress(string astrMPIOrgID)
        {
            cdoOrgAddress lcdoOrgAddress = new cdoOrgAddress();
            if (astrMPIOrgID.IsNotNullOrEmpty())
            {
                DataTable ldtbOrgAddressResult = busBase.Select("cdoOrganization.GetOrgDetailsWithAddress", new object[1] { astrMPIOrgID });
                if (ldtbOrgAddressResult.IsNotNull() && ldtbOrgAddressResult.Rows.Count > 0)
                {
                    foreach (DataRow drOrgAddress in ldtbOrgAddressResult.Rows)
                    {
                        lcdoOrgAddress.LoadData(drOrgAddress);
                        lcdoOrgAddress.istrOrgName = Convert.ToString(drOrgAddress["ORG_NAME"]);
                        lcdoOrgAddress.istrContactName = Convert.ToString(drOrgAddress["CO"]);
                    }
                }
            }
            return lcdoOrgAddress;
        }
        public Collection<cdoCodeValue> GetTaxIdentifierStatesandFedral()
        {
            Collection<cdoCodeValue> lclbTaxIdentifierStatesandFedral = new Collection<cdoCodeValue>();


            DataTable ldtbTaxIdentifierStatesandFedral = busBase.Select("cdoPayeeAccount.LoadTaxIdentifiersvalues", new object[1] { icdoPayeeAccount.payee_account_id });
            if (ldtbTaxIdentifierStatesandFedral.IsNotNull() && ldtbTaxIdentifierStatesandFedral.Rows.Count > 0)
            {
                lclbTaxIdentifierStatesandFedral = doBase.GetCollection<cdoCodeValue>(ldtbTaxIdentifierStatesandFedral);
            }

            return lclbTaxIdentifierStatesandFedral;
        }
        public void LoadNonTaxableAmount()
        {
            if (idtNextBenefitPaymentDate == DateTime.MinValue)
                LoadNextBenefitPaymentDate();
            LoadNonTaxableAmount(idtNextBenefitPaymentDate);
        }

        public void LoadNonTaxableAmount(DateTime adtEffectiveDate)
        {
            idecNontaxableAmount = 0.00m;
            if (iclbPayeeAccountPaymentItemType == null)
            {
                LoadPayeeAccountPaymentItemType();
            }

            idecNontaxableAmount = iclbPayeeAccountPaymentItemType.Where(o =>
                o.ibusPaymentItemType.icdoPaymentItemType.item_type_direction == 1 &&
                o.ibusPaymentItemType.icdoPaymentItemType.payment_1099r_flag == busConstant.Flag_Yes &&
                o.ibusPaymentItemType.icdoPaymentItemType.taxable_item_flag == busConstant.FLAG_NO &&
                busGlobalFunctions.CheckDateOverlapping(adtEffectiveDate, o.icdoPayeeAccountPaymentItemType.start_date, o.icdoPayeeAccountPaymentItemType.end_date)).
                Select(o => o.icdoPayeeAccountPaymentItemType.amount).Sum();
        }

        /* This method is to get the Total Taxable Amount for the special tax treatment from Payment Item Type
          1.Load all Item Types for the Payee Account         
          3.Sum all the Items which are having taxable indicator "Y" and special tax treatment indicator as Taxes should be calculated using Fed tax table . .*/
        public void LoadTaxableAmountForVariableTax(DateTime adtEffectiveDate)
        {
            idecTotalTaxableAmountForVariableTax = 0.00M;
            idecTotalTaxableAmountForVariableTaxRetro = 0.0m;
            LoadPayeeAccountPaymentItemType();
            LoadRetroItemTypeInitialAndReactivation();
            // Active Payee Account Payment Item type
            iclbPayeeAccountPaymentItemTypeActive = (from item in this.iclbPayeeAccountPaymentItemType
                                                     where busGlobalFunctions.CheckDateOverlapping(adtEffectiveDate,
                                                     item.icdoPayeeAccountPaymentItemType.start_date, item.icdoPayeeAccountPaymentItemType.end_date)
                                                     select item).ToList().ToCollection<busPayeeAccountPaymentItemType>();
            if (iclbPayeeAccountPaymentItemTypeActive.Count() > 0 && iclbPayeeAccountPaymentItemTypeActive.First().icdoPayeeAccountPaymentItemType.reissue_item_flag == busConstant.Flag_Yes)
            {
                istrReissueFlag = busConstant.FLAG_YES;
            }
            foreach (busPayeeAccountPaymentItemType lobjPayeeAccountItemType in iclbPayeeAccountPaymentItemTypeActive)
            {
                //Take only the items which are effective for the next benfit payment date
                //if (busGlobalFunctions.CheckDateOverlapping(adtEffectiveDate, lobjPayeeAccountItemType.icdoPayeeAccountPaymentItemType.start_date,
                //lobjPayeeAccountItemType.icdoPayeeAccountPaymentItemType.end_date))
                //{
                if (lobjPayeeAccountItemType.ibusPaymentItemType == null)
                {
                    lobjPayeeAccountItemType.LoadPaymentItemType();
                }
                bool lblnIsInitialRetropaymentItem = false;
                if (iclbRetroItemTypeInitialAndReac.Where(o =>
                     o.icdoRetroItemType.to_item_type == lobjPayeeAccountItemType.ibusPaymentItemType.icdoPaymentItemType.item_type_code &&
                     (o.icdoRetroItemType.retro_payment_type_value == busConstant.RETRO_PAYMENT_INITIAL ||
                     o.icdoRetroItemType.retro_payment_type_value == busConstant.RETRO_PAYMENT_REACTIVATION)).Count() > 0)
                {
                    lblnIsInitialRetropaymentItem = true;
                }

                if (!lblnIsInitialRetropaymentItem)
                {
                    //Take only Items which are having taxable indicator "Y" and special tax treatment indicator as Taxes should be calculated using Fed tax table .*/
                    if ((lobjPayeeAccountItemType.ibusPaymentItemType.icdoPaymentItemType.taxable_item_flag == busConstant.Flag_Yes)
                        && (lobjPayeeAccountItemType.ibusPaymentItemType.icdoPaymentItemType.special_tax_treatment_code_value == busConstant.SpecialTaxIdendtifierFedTax
                        || lobjPayeeAccountItemType.ibusPaymentItemType.icdoPaymentItemType.allow_rollover_code_value == busConstant.RolloverItemReductionCheck))
                    {
                        idecTotalTaxableAmountForVariableTax += lobjPayeeAccountItemType.icdoPayeeAccountPaymentItemType.amount *
                            lobjPayeeAccountItemType.ibusPaymentItemType.icdoPaymentItemType.item_type_direction;
                    }
                }
                else
                {
                    if ((lobjPayeeAccountItemType.ibusPaymentItemType.icdoPaymentItemType.taxable_item_flag == busConstant.Flag_Yes)
                       && (lobjPayeeAccountItemType.ibusPaymentItemType.icdoPaymentItemType.special_tax_treatment_code_value == busConstant.SpecialTaxIdendtifierFedTax
                       || lobjPayeeAccountItemType.ibusPaymentItemType.icdoPaymentItemType.allow_rollover_code_value == busConstant.RolloverItemReductionCheck))
                    {
                        idecTotalTaxableAmountForVariableTaxRetro += lobjPayeeAccountItemType.icdoPayeeAccountPaymentItemType.amount *
                            lobjPayeeAccountItemType.ibusPaymentItemType.icdoPaymentItemType.item_type_direction;
                    }

                }
                //}
            }
        }

        public void LoadRetroItemTypeInitialAndReactivation()
        {
            DataTable ldtbList = Select("cdoRetroItemType.LoadTypeInitialAndReactivation", new object[0] { });
            iclbRetroItemTypeInitialAndReac = GetCollection<busRetroItemType>(ldtbList, "icdoRetroItemType");
        }

        #region After Persist


        public override void BeforePersistChanges()
        {
            this.ValidateHardErrors(utlPageMode.All);
            if (iarrErrors.Count == 0)
            {
                switch (astrCheckCurrentPage)
                {
                    case busConstant.PAYEE_ACCOUNT_DEDUCTION_MAINTENANCE:
                        ProcessDeductionDetails();
                        break;
                    case busConstant.PAYEE_ACCOUNT_ROLLOVER_MAINTENANCE:
                        ChangeContactName();
                        break;
                }
                if (this.icdoPayeeAccount.transfer_org_id != 0)
                {
                    //Safe check value cannot be null
                    if (icdoPayeeAccount.ihstOldValues["transfer_org_id"] != null)
                    {
                        int ainttransferorgid = Convert.ToInt32(icdoPayeeAccount.ihstOldValues["transfer_org_id"]);
                        if (this.icdoPayeeAccount.transfer_org_id != ainttransferorgid)
                        {
                            CreateReviewPayeeAccountStatus();
                            aboolTransChange = true;
                        }
                    }
                }
                //PIR 389
                if (this.icdoPayeeAccount.ihstOldValues.Count > 0
                   && Convert.ToString(this.icdoPayeeAccount.ihstOldValues["verified_flag"]) == busConstant.FLAG_YES
                   && (this.icdoPayeeAccount.verified_flag == busConstant.FLAG_NO || this.icdoPayeeAccount.verified_flag.IsNullOrEmpty()))
                {
                    CreateReviewPayeeAccountStatus();
                    aboolTransChange = true;
                }

                //LA Sunset - Payment Directives
                if (this.icdoPayeeAccount.ihstOldValues.Count > 0
                 && Convert.ToString(this.icdoPayeeAccount.ihstOldValues["verified_flag"]) != busConstant.FLAG_YES
                 && this.icdoPayeeAccount.verified_flag == busConstant.FLAG_YES && this.icdoPayeeAccount.verified_flag != Convert.ToString(this.icdoPayeeAccount.ihstOldValues["verified_flag"]))
                {
                    this.icdoPayeeAccount.verified_by = iobjPassInfo.istrUserID;
                    this.icdoPayeeAccount.verified_date = DateTime.Now;

                    if (iclbPaymentDirectives != null && iclbPaymentDirectives.Where(item => item.icdoPaymentDirectives.payment_cycle_date >= idtNextBenefitPaymentDate).Count() > 0)
                    {
                        iclbPaymentDirectives.Where(item => item.icdoPaymentDirectives.payment_cycle_date >= idtNextBenefitPaymentDate).FirstOrDefault().icdoPaymentDirectives.verified_by
                            = iobjPassInfo.istrUserID;

                        iclbPaymentDirectives.Where(item => item.icdoPaymentDirectives.payment_cycle_date >= idtNextBenefitPaymentDate).FirstOrDefault().icdoPaymentDirectives.verified_date
                            = DateTime.Now;

                        iclbPaymentDirectives.Where(item => item.icdoPaymentDirectives.payment_cycle_date >= idtNextBenefitPaymentDate).FirstOrDefault().icdoPaymentDirectives.Update();
                    }
                }
            }


            if (iobjPassInfo.istrFormName == busConstant.PAYEE_ACCOUNT_ACH_MAINTENANCE || (iobjPassInfo.istrFormName == busConstant.PAYEE_ACCOUNT_ACH_WIZARD_MAINTENANCE && this.istrWizardPaymentMethod != "CHK"))
            {
                //if (iobjPassInfo.istrFormName == busConstant.PAYEE_ACCOUNT_ACH_WIZARD_MAINTENANCE)
                //{
                //    AssigningPayeeAccountACHWizardDetails();

                //}

                if (this.iclbPayeeAccountAchDetail.IsNotNull() && this.iclbPayeeAccountAchDetail.Count > 0)
                {
                    foreach (busPayeeAccountAchDetail lbusPayeeAccountAchDetail in this.iclbPayeeAccountAchDetail)
                    {
                        //if (lbusPayeeAccountAchDetail.icdoPayeeAccountAchDetail.bank_org_id == 0 || lbusPayeeAccountAchDetail.icdoPayeeAccountAchDetail.bank_org_id.IsNull())
                        //{
                        if (lbusPayeeAccountAchDetail.icdoPayeeAccountAchDetail.ach_end_date == DateTime.MinValue || lbusPayeeAccountAchDetail.icdoPayeeAccountAchDetail.ach_end_date > DateTime.Now)
                        {
                            bool lblnFlag = false;
                            busOrganization lbusOrganization = new busOrganization { icdoOrganization = new cdoOrganization() };
                            if (lbusOrganization.FindOrganization(lbusPayeeAccountAchDetail.icdoPayeeAccountAchDetail.bank_org_id))
                            {
                                if ((lbusOrganization.icdoOrganization.routing_number != lbusPayeeAccountAchDetail.icdoPayeeAccountAchDetail.istrRoutingNumber
                                    && lbusOrganization.icdoOrganization.org_name != lbusPayeeAccountAchDetail.icdoPayeeAccountAchDetail.istrOrgName))
                                {
                                    lblnFlag = true;
                                }
                            }
                            else if (lbusPayeeAccountAchDetail.icdoPayeeAccountAchDetail.bank_org_id == 0 || lbusPayeeAccountAchDetail.icdoPayeeAccountAchDetail.bank_org_id.IsNull())
                            {
                                lblnFlag = true;
                            }

                            if (lblnFlag)
                            {
                                if (lbusPayeeAccountAchDetail.icdoPayeeAccountAchDetail.istrOrgName.IsNotNull() && lbusPayeeAccountAchDetail.icdoPayeeAccountAchDetail.istrRoutingNumber.IsNotNull())
                                {
                                    DataTable ldtbOrgIdResult = busBase.Select("cdoOrganization.GetOrgIdByRoutingNumberAndOrgName", new object[2] { lbusPayeeAccountAchDetail.icdoPayeeAccountAchDetail.istrOrgName, lbusPayeeAccountAchDetail.icdoPayeeAccountAchDetail.istrRoutingNumber });
                                    if (ldtbOrgIdResult.IsNotNull() && ldtbOrgIdResult.Rows.Count > 0 && Convert.ToString(ldtbOrgIdResult.Rows[0]).IsNotNullOrEmpty())
                                    {
                                        lbusPayeeAccountAchDetail.icdoPayeeAccountAchDetail.bank_org_id = Convert.ToInt32(ldtbOrgIdResult.Rows[0]["ORG_ID"]);
                                    }
                                }
                            }
                        }
                        //}
                    }
                }
            }
            else if (iobjPassInfo.istrFormName == busConstant.PAYEE_ACCOUNT_WIRE_MAINTENANCE)
            {
                if (this.iclbPayeeAccountWireDetail.IsNotNull() && this.iclbPayeeAccountWireDetail.Count > 0)
                {
                    foreach (busPayeeAccountWireDetail lbusPayeeAccountWireDetail in this.iclbPayeeAccountWireDetail)
                    {
                        //if (lbusPayeeAccountAchDetail.icdoPayeeAccountAchDetail.bank_org_id == 0 || lbusPayeeAccountAchDetail.icdoPayeeAccountAchDetail.bank_org_id.IsNull())
                        //{
                        if (lbusPayeeAccountWireDetail.icdoPayeeAccountWireDetail.wire_end_date == DateTime.MinValue || lbusPayeeAccountWireDetail.icdoPayeeAccountWireDetail.wire_end_date > DateTime.Now)
                        {
                            bool lblnFlag = false;
                            busOrganization lbusOrganization = new busOrganization { icdoOrganization = new cdoOrganization() };
                            if (lbusOrganization.FindOrganization(lbusPayeeAccountWireDetail.icdoPayeeAccountWireDetail.bank_org_id))
                            {
                                if ((lbusOrganization.icdoOrganization.routing_number != lbusPayeeAccountWireDetail.icdoPayeeAccountWireDetail.istrAbaSwiftBankCode
                                    && lbusOrganization.icdoOrganization.org_name != lbusPayeeAccountWireDetail.icdoPayeeAccountWireDetail.istrOrgName
                                    ))
                                {
                                    lblnFlag = true;
                                }
                            }
                            else if (lbusPayeeAccountWireDetail.icdoPayeeAccountWireDetail.bank_org_id == 0 || lbusPayeeAccountWireDetail.icdoPayeeAccountWireDetail.bank_org_id.IsNull())
                            {
                                lblnFlag = true;
                            }

                            if (lblnFlag)
                            {
                                if (lbusPayeeAccountWireDetail.icdoPayeeAccountWireDetail.istrOrgName.IsNotNull() && lbusPayeeAccountWireDetail.icdoPayeeAccountWireDetail.istrAbaSwiftBankCode.IsNotNull())
                                {
                                    DataTable ldtbOrgIdResult = busBase.Select("cdoOrganization.GetOrgIdByRoutingNumberAndOrgName", new object[2] { lbusPayeeAccountWireDetail.icdoPayeeAccountWireDetail.istrOrgName, lbusPayeeAccountWireDetail.icdoPayeeAccountWireDetail.istrAbaSwiftBankCode });
                                    if (ldtbOrgIdResult.IsNotNull() && ldtbOrgIdResult.Rows.Count > 0 && Convert.ToString(ldtbOrgIdResult.Rows[0]).IsNotNullOrEmpty())
                                    {
                                        lbusPayeeAccountWireDetail.icdoPayeeAccountWireDetail.bank_org_id = Convert.ToInt32(ldtbOrgIdResult.Rows[0]["ORG_ID"]);
                                    }
                                }
                            }
                        }
                        //}
                    }
                }
            }

            //LA Sunset - Payment Directives
            else if (iobjPassInfo.istrFormName == busConstant.PAYEE_ACCOUNT_STATUS_MAINTENANCE)
            {
                if (iclbPayeeAccountStatus != null && iclbPayeeAccountStatus.Count > 0
                    && iclbPayeeAccountStatus.OrderByDescending(item => item.icdoPayeeAccountStatus.status_effective_date).FirstOrDefault().icdoPayeeAccountStatus.status_value == busConstant.PAYEE_ACCOUNT_STATUS_APPROVED)
                {
                    if (iclbPaymentDirectives != null && iclbPaymentDirectives.Where(item => item.icdoPaymentDirectives.payment_cycle_date >= idtNextBenefitPaymentDate).Count() > 0)
                    {
                        iclbPaymentDirectives.Where(item => item.icdoPaymentDirectives.payment_cycle_date >= idtNextBenefitPaymentDate).FirstOrDefault().icdoPaymentDirectives.approved_by
                            = iobjPassInfo.istrUserID;
                        iclbPaymentDirectives.Where(item => item.icdoPaymentDirectives.payment_cycle_date >= idtNextBenefitPaymentDate).FirstOrDefault().icdoPaymentDirectives.approved_date
                            = DateTime.Now;
                        iclbPaymentDirectives.Where(item => item.icdoPaymentDirectives.payment_cycle_date >= idtNextBenefitPaymentDate).FirstOrDefault().icdoPaymentDirectives.payee_account_status
                            = "Approved";
                        iclbPaymentDirectives.Where(item => item.icdoPaymentDirectives.payment_cycle_date >= idtNextBenefitPaymentDate).FirstOrDefault().icdoPaymentDirectives.Update();
                    }
                    else if (this.icdoPayeeAccount.include_in_adhoc_flag == busConstant.FLAG_YES && this.icdoPayeeAccount.iintPlanId == 1 //Fixing issue payment directive payee account status was not updating for IAP adhoc payee accounts 
                        && (iclbPaymentDirectives != null
                        && iclbPaymentDirectives.Where(item => (item.icdoPaymentDirectives.is_deleted == busConstant.FLAG_NO && item.icdoPaymentDirectives.payment_cycle_date >= DateTime.Now)).Count() > 0))
                    {
                        iclbPaymentDirectives.Where(item => item.icdoPaymentDirectives.is_deleted == busConstant.FLAG_NO && item.icdoPaymentDirectives.payment_cycle_date >= DateTime.Now).FirstOrDefault().icdoPaymentDirectives.approved_by
                            = iobjPassInfo.istrUserID;
                        iclbPaymentDirectives.Where(item => item.icdoPaymentDirectives.is_deleted == busConstant.FLAG_NO && item.icdoPaymentDirectives.payment_cycle_date >= DateTime.Now).FirstOrDefault().icdoPaymentDirectives.approved_date
                            = DateTime.Now;
                        iclbPaymentDirectives.Where(item => item.icdoPaymentDirectives.is_deleted == busConstant.FLAG_NO && item.icdoPaymentDirectives.payment_cycle_date >= DateTime.Now).FirstOrDefault().icdoPaymentDirectives.payee_account_status
                            = "Approved";
                        iclbPaymentDirectives.Where(item => item.icdoPaymentDirectives.is_deleted == busConstant.FLAG_NO && item.icdoPaymentDirectives.payment_cycle_date >= DateTime.Now).FirstOrDefault().icdoPaymentDirectives.Update();
                    }
                }
            }
            //6/15/2020 - IAP Payback
            else if (iobjPassInfo.istrFormName == busConstant.PAYEE_ACCOUNT_MAINTENANCE && this.iclbIAPHardshipPayback.Where(item => item.icdoIapHardshipPayback.iap_hardship_payback_id == 0).Count() > 0)
            {
                ProcessIAPHardshipPayback();
            }

            base.BeforePersistChanges();

        }

        public void CancelAllPayeeSameApp()
        {
            if (iclbPayeeAccountStatus == null)
                LoadPayeeAccountStatuss();
            if (iclbPayeeAccountStatus.Count > 0)
            {
                busPayeeAccountStatus lobjbusPayeeAccountStatusLstRecord = (from obj in iclbPayeeAccountStatus.AsEnumerable()
                                                                            where obj.icdoPayeeAccountStatus.status_effective_date.Date == iclbPayeeAccountStatus.Max(item => item.icdoPayeeAccountStatus.status_effective_date.Date)
                                                                            && obj.icdoPayeeAccountStatus.status_value == busConstant.PAYEE_ACCOUNT_STATUS_CANCELLED
                                                                            select obj).FirstOrDefault();
                if (lobjbusPayeeAccountStatusLstRecord != null)
                {
                    if (icdoPayeeAccount.benefit_application_detail_id != 0 && icdoPayeeAccount.retiree_incr_flag != busConstant.FLAG_YES)
                    {
                        LoadBenefitDetails();
                        busBenefitApplication lbusBenefitApplication = new busBenefitApplication();
                        lbusBenefitApplication.LoadPayeeAccountStatusByApplicationID(icdoPayeeAccount.iintBenefitApplicationID); // PROD PIR 792 Query change for same plan benefit id

                        foreach (busPayeeAccountStatus lobjPayeeAccountStatus in lbusBenefitApplication.iclbPayeeAccountStatusByApplication)
                        {
                            if (this.icdoPayeeAccount.plan_benefit_id == lobjPayeeAccountStatus.icdoPayeeAccountStatus.PLAN_BENEFIT_ID) // PROD PIR 792
                            {
                                lobjPayeeAccountStatus.icdoPayeeAccountStatus.status_value = busConstant.PAYEE_ACCOUNT_STATUS_CANCELLED;
                                lobjPayeeAccountStatus.icdoPayeeAccountStatus.status_effective_date = DateTime.Now;
                                lobjPayeeAccountStatus.icdoPayeeAccountStatus.Insert();
                            }
                        }

                    }
                    else if (icdoPayeeAccount.retiree_incr_flag != busConstant.FLAG_YES)
                    {
                        LoadDRODetails();
                        // For Cancel Payee Account Status..
                        busQdroApplication lbusQdroApplication = new busQdroApplication();
                        lbusQdroApplication.LoadPayeeAccountStatusByApplicationID(icdoPayeeAccount.iintDROApplicationID); // PROD PIR 792 Query change for same plan benefit id

                        foreach (busPayeeAccountStatus lobjPayeeAccountStatus in lbusQdroApplication.iclbPayeeAccountStatusByApplication)
                        {
                            if (this.icdoPayeeAccount.plan_benefit_id == lobjPayeeAccountStatus.icdoPayeeAccountStatus.PLAN_BENEFIT_ID) // PROD PIR 792
                            {
                                lobjPayeeAccountStatus.icdoPayeeAccountStatus.status_value = busConstant.PAYEE_ACCOUNT_STATUS_CANCELLED;
                                lobjPayeeAccountStatus.icdoPayeeAccountStatus.status_effective_date = DateTime.Now;
                                lobjPayeeAccountStatus.icdoPayeeAccountStatus.Insert();
                            }
                        }
                    }
                    // Initiate workflow if distribution status value 'OUTS' or 'CLRD' and payee account status cancelled
                    DataTable ldtOutsdorCleardDistribution = busBase.Select("cdoPaymentHistoryHeader.GetOutsandClrdDistributionByPayeeAccountID", new Object[1] { this.icdoPayeeAccount.payee_account_id });
                    if (ldtOutsdorCleardDistribution != null && ldtOutsdorCleardDistribution.Rows.Count > 0 && ldtOutsdorCleardDistribution.Rows[0][0] != DBNull.Value)
                    {
                        ///Code to initiate new workflow
                        Hashtable lhstRequestParams = new Hashtable();
                        lhstRequestParams.Add("PayeeAccountId", this.icdoPayeeAccount.payee_account_id);
                        lhstRequestParams.Add("PaymentDateFrom", string.Format("{0:MM/dd/yyyy}", Convert.ToDateTime(ldtOutsdorCleardDistribution.Rows[0][0])));
                        lhstRequestParams.Add("PaymentDateTo", string.Format("{0:MM/dd/yyyy}", DateTime.Now));

                        busWorkflowHelper.InitializeWorkflow(busConstant.PROCESS_STOP_REISSUE_OR_RECLAMATION, this.icdoPayeeAccount.person_id,
                                                                    0, 0, lhstRequestParams);
                    }
                }
            }
        }

        public void SuspendAlternatePayeeAccounts()
        {
            if (this.icdoPayeeAccount.account_relation_value == "PART")
            {
                if (iclbPayeeAccountStatus == null)
                    LoadPayeeAccountStatuss();
                if (iclbPayeeAccountStatus.Count > 0)
                {
                    busPayeeAccountStatus lobjbusPayeeAccountStatusLstRecord = iclbPayeeAccountStatus.OrderByDescending(item => item.icdoPayeeAccountStatus.status_effective_date).FirstOrDefault();

                    if (lobjbusPayeeAccountStatusLstRecord.icdoPayeeAccountStatus.status_value == busConstant.PAYEE_ACCOUNT_STATUS_SUSPENDED && lobjbusPayeeAccountStatusLstRecord.icdoPayeeAccountStatus.suspension_status_reason_value == "DSBN")
                    {
                        DataTable ldtDroApp = Select("cdoDroBenefitDetails.GetDisabledAlternatePayees", new object[1] { this.icdoPayeeAccount.person_id });
                        if (ldtDroApp.Rows.Count > 0)
                        {
                            busPayeeAccount lbusPayeeAccount = null;
                            busPayeeAccountStatus lbusPayeeAccountStatus = null;
                            foreach (DataRow ldtRow in ldtDroApp.Rows)
                            {
                                lbusPayeeAccount = new busPayeeAccount { icdoPayeeAccount = new cdoPayeeAccount() };
                                lbusPayeeAccount.icdoPayeeAccount.LoadData(ldtRow);
                                lbusPayeeAccountStatus = new busPayeeAccountStatus { icdoPayeeAccountStatus = new cdoPayeeAccountStatus() };
                                lbusPayeeAccountStatus.InsertValuesInPayeeAccountStatus(lbusPayeeAccount.icdoPayeeAccount.payee_account_id, busConstant.PAYEE_ACCOUNT_STATUS_SUSPENDED, DateTime.Now, lobjbusPayeeAccountStatusLstRecord.icdoPayeeAccountStatus.suspension_status_reason_value);
                            }
                        }
                    }
                }
            }
        }


        public void CreateReactivatioRetroPaymentItem()
        {
            LoadBenefitDetails();
            if (this.icdoPayeeAccount.istrBenefitOption != busConstant.LUMP_SUM_DESCRIPTION && this.icdoPayeeAccount.iintPlanId != busConstant.IAP_PLAN_ID)
            {
                if (iclbPayeeAccountStatus == null)
                    LoadPayeeAccountStatuss();
                if (iclbPayeeAccountStatus.Count > 0)
                {
                    //PIR-920

                    busPayeeAccountStatus lbusPayeeAccountSecondLastSuspendedRecord = null;
                    Collection<busPayeeAccountStatus> lclbPayeeAccountStatusSuspended = null;

                    lclbPayeeAccountStatusSuspended = (from obj in iclbPayeeAccountStatus.AsEnumerable()
                                                       where obj.icdoPayeeAccountStatus.status_value == busConstant.PAYEE_ACCOUNT_STATUS_SUSPENDED
                                                       select obj).ToList().ToCollection<busPayeeAccountStatus>();

                    if (lclbPayeeAccountStatusSuspended.Count > 1)
                    {
                        lbusPayeeAccountSecondLastSuspendedRecord = (from obj in lclbPayeeAccountStatusSuspended.AsEnumerable()
                                                                     where obj.icdoPayeeAccountStatus.status_value == busConstant.PAYEE_ACCOUNT_STATUS_SUSPENDED
                                                                     orderby obj.icdoPayeeAccountStatus.status_effective_date descending
                                                                     select obj).Skip(1).FirstOrDefault();
                    }

                    busPayeeAccountStatus lobjbusPayeeAccountStatusLstRecord = (from obj in iclbPayeeAccountStatus.AsEnumerable()
                                                                                where obj.icdoPayeeAccountStatus.status_effective_date == iclbPayeeAccountStatus.Max(item => item.icdoPayeeAccountStatus.status_effective_date)
                                                                                && obj.icdoPayeeAccountStatus.status_value == busConstant.PAYEE_ACCOUNT_STATUS_REVIEW
                                                                                select obj).FirstOrDefault();
                    //PIR-920
                    busPayeeAccountStatus lbusPayeeAccountApprRecvAfterSecondLastSuspendedStatus = null;
                    DateTime ldtSecondLastSuspendedStausChangedate = DateTime.MinValue;

                    if (lbusPayeeAccountSecondLastSuspendedRecord != null)
                    {
                        ldtSecondLastSuspendedStausChangedate = lbusPayeeAccountSecondLastSuspendedRecord.icdoPayeeAccountStatus.status_effective_date;

                        lbusPayeeAccountApprRecvAfterSecondLastSuspendedStatus = (from obj in iclbPayeeAccountStatus.AsEnumerable()
                                                                                  where obj.icdoPayeeAccountStatus.status_effective_date > ldtSecondLastSuspendedStausChangedate
                                                                                  && (obj.icdoPayeeAccountStatus.status_value == busConstant.PAYEE_ACCOUNT_STATUS_RECEIVING //Ticket - 71424                                                                                  
                                                                                  )
                                                                                  select obj).FirstOrDefault();
                    }

                    if (lobjbusPayeeAccountStatusLstRecord != null)
                    {
                        DataTable ldtbPayeeAccountStatusSecondLastRecord = busBase.Select("cdoPayeeAccountStatus.GetSecondLastStatusForRetroReactivation", new object[1] { this.icdoPayeeAccount.payee_account_id });

                        if (ldtbPayeeAccountStatusSecondLastRecord != null && ldtbPayeeAccountStatusSecondLastRecord.Rows.Count > 0 && ldtbPayeeAccountStatusSecondLastRecord.Rows[0][0] != DBNull.Value)
                        {
                            //PIR-920
                            if (lbusPayeeAccountSecondLastSuspendedRecord != null && lbusPayeeAccountApprRecvAfterSecondLastSuspendedStatus == null)
                            {
                                idtSuspendedStatusEffectiveDate = ldtSecondLastSuspendedStausChangedate;
                            }
                            else
                            {
                                idtSuspendedStatusEffectiveDate = Convert.ToDateTime(ldtbPayeeAccountStatusSecondLastRecord.Rows[0][0]);
                            }

                            //PIR-920
                            string lstrSuspensionReason = string.Empty;
                            lstrSuspensionReason = Convert.ToString(ldtbPayeeAccountStatusSecondLastRecord.Rows[0][1]);
                            DateTime ldtLastPaymentDate = GetLastPaymentDateForReactivationRetro(lobjbusPayeeAccountStatusLstRecord.icdoPayeeAccountStatus.status_effective_date);
                            busCalculation lbusCalculation = new busCalculation();
                            Collection<busBenefitMonthwiseAdjustmentDetail> lclbBenefitMonthwiseAdjustmentDetail = new Collection<busBenefitMonthwiseAdjustmentDetail>();

                            if (lstrSuspensionReason == "ACHR")
                                lclbBenefitMonthwiseAdjustmentDetail = lbusCalculation.GetAmountActuallyPaid(this, idtSuspendedStatusEffectiveDate.GetFirstDayofMonth(), ldtLastPaymentDate);
                            else
                                lclbBenefitMonthwiseAdjustmentDetail = lbusCalculation.GetAmountActuallyPaid(this, idtSuspendedStatusEffectiveDate.GetLastDayofMonth().AddDays(1), ldtLastPaymentDate);

                            lbusCalculation.CalculateAmountShouldHaveBeenPaid(this, ref lclbBenefitMonthwiseAdjustmentDetail);

                            lbusCalculation.CreateOverpaymentUnderPayment(this, lclbBenefitMonthwiseAdjustmentDetail, busConstant.RETRO_PAYMENT_REACTIVATION);
                        }
                    }
                }
            }

        }

        public DateTime GetLastPaymentDateForReactivationRetro(DateTime adtLastPaymentDate)
        {
            DateTime ldtLastPaymentDate = new DateTime();
            LoadNextBenefitPaymentDate();

            //if (adtLastPaymentDate.GetFirstDayofMonth() < idtLastBenefitPaymentDate)
            //{
            //    ldtLastPaymentDate = adtLastPaymentDate.GetFirstDayofMonth();
            //}
            //else
            //{
            ldtLastPaymentDate = idtLastBenefitPaymentDate;//PIR-919
            //}

            return ldtLastPaymentDate;
        }



        public void ProcessRolloverDetails(DateTime? adtPaymentForReissue = null, int aintRecipientRolloverOrgId = 0)
        {
            LoadActiveRolloverDetail();
            //Payment Adjustments - Payee To Rollover Organization Part
            if (aintRecipientRolloverOrgId > 0 && adtPaymentForReissue != null)
            {
                if (iclbActiveRolloverDetails.Where(item => item.icdoPayeeAccountRolloverDetail.rollover_org_id == aintRecipientRolloverOrgId).Count() > 0)
                {
                    Collection<busPayeeAccountRolloverDetail> lclbTempRolloverDetails = new Collection<busPayeeAccountRolloverDetail>();
                    lclbTempRolloverDetails = iclbActiveRolloverDetails.Where(item => item.icdoPayeeAccountRolloverDetail.rollover_org_id == aintRecipientRolloverOrgId).ToList().ToCollection();
                    iclbActiveRolloverDetails.Clear();
                    iclbActiveRolloverDetails = lclbTempRolloverDetails;
                    idtNextBenefitPaymentDate = Convert.ToDateTime(adtPaymentForReissue);
                    istrReissueFlag = busConstant.FLAG_YES;
                }
            }

            foreach (busPayeeAccountRolloverDetail lbusPayeeAccountRolloverDetail in iclbActiveRolloverDetails)
            {
                lbusPayeeAccountRolloverDetail.iclbPayeeAccountRolloverItemDetail = LoadPayeeAccountRolloverItemDetailsWithPayee_Account_Rollover_ID(lbusPayeeAccountRolloverDetail.icdoPayeeAccountRolloverDetail.payee_account_rollover_detail_id);
                foreach (busPayeeAccountRolloverItemDetail lbusPayeeAccountRolloverItemDetail in lbusPayeeAccountRolloverDetail.iclbPayeeAccountRolloverItemDetail)
                {
                    if (lbusPayeeAccountRolloverItemDetail.icdoPayeeAccountRolloverItemDetail.payee_account_payment_item_type_id != 0)
                    {
                        int aintPayeeAccountPaymentItemTypeId = lbusPayeeAccountRolloverItemDetail.icdoPayeeAccountRolloverItemDetail.payee_account_payment_item_type_id;
                        //lbusPayeeAccountRolloverItemDetail.ibusPayeeAccountPaymentItemType = (from item in this.iclbPayeeAccountPaymentItemType
                        //                                                                      where item.icdoPayeeAccountPaymentItemType.payee_account_payment_item_type_id == aintPayeeAccountPaymentItemTypeId
                        //                                                                      select item).FirstOrDefault();
                        if (lbusPayeeAccountRolloverItemDetail.icdoPayeeAccountRolloverItemDetail.payee_account_payment_item_type_id != 0)
                        {
                            lbusPayeeAccountRolloverItemDetail.ibusPayeeAccountPaymentItemType = new busPayeeAccountPaymentItemType();
                            if (lbusPayeeAccountRolloverItemDetail.ibusPayeeAccountPaymentItemType.FindPayeeAccountPaymentItemType(aintPayeeAccountPaymentItemTypeId))
                                lbusPayeeAccountRolloverItemDetail.ibusPayeeAccountPaymentItemType.icdoPayeeAccountPaymentItemType.Delete();
                        }
                    }
                    lbusPayeeAccountRolloverItemDetail.icdoPayeeAccountRolloverItemDetail.Delete();
                }
            }


            foreach (busPayeeAccountRolloverDetail lbusPayeeAccountRolloverDetail in iclbActiveRolloverDetails)
            {
                lbusPayeeAccountRolloverDetail.LoadPayeeAccountRolloverItemDetails();
                busPayeeAccountPaymentItemType lbusPayeeAccountPaymentItemType = new busPayeeAccountPaymentItemType { icdoPayeeAccountPaymentItemType = new cdoPayeeAccountPaymentItemType() };

                if (lbusPayeeAccountRolloverDetail.icdoPayeeAccountRolloverDetail.status_value == busConstant.PayeeAccountRolloverDetailStatusProcessed)
                {
                    if (idtNextBenefitPaymentDate == null)
                        LoadNextBenefitPaymentDate();
                    if (lbusPayeeAccountPaymentItemType.FindPayeeAccountPaymentItemType(lbusPayeeAccountRolloverDetail.iclbPayeeAccountRolloverItemDetail.First().icdoPayeeAccountRolloverItemDetail.payee_account_payment_item_type_id))
                    {
                        lbusPayeeAccountPaymentItemType.icdoPayeeAccountPaymentItemType.end_date = idtNextBenefitPaymentDate.AddDays(-1);
                        lbusPayeeAccountPaymentItemType.icdoPayeeAccountPaymentItemType.Update();
                    }
                }
                else
                {

                    CreateOrUpdateRolloverDetails(lbusPayeeAccountRolloverDetail);
                }
            }

        }

        public void ProcessTaxWithHoldingDetails(bool ablnActiveRetireeBatch = false, DateTime? adtPaymentForReissue = null)
        {
            if (adtPaymentForReissue != null)
            {
                idtNextBenefitPaymentDate = Convert.ToDateTime(adtPaymentForReissue);
                istrReissueFlag = busConstant.FLAG_YES;
            }

            if (this.iclbPayeeAccountTaxWithholding == null)
                LoadPayeeAccountTaxWithholdings();
            iclbPayeeAccountTaxWithholdingActive = (from item in this.iclbPayeeAccountTaxWithholding
                                                    where !busGlobalFunctions.CheckDateOverlapping(idtBenefitPaymentDateForTaxWithholding =
                                                    item.icdoPayeeAccountTaxWithholding.start_date > idtNextBenefitPaymentDate ? item.icdoPayeeAccountTaxWithholding.start_date : idtNextBenefitPaymentDate,
                                                    item.icdoPayeeAccountTaxWithholding.start_date, item.icdoPayeeAccountTaxWithholding.end_date)
                                                    select item).ToList().ToCollection<busPayeeAccountTaxWithholding>();
            foreach (busPayeeAccountTaxWithholding lbusPayeeAccountTaxWithholding in iclbPayeeAccountTaxWithholdingActive)
            {
                lbusPayeeAccountTaxWithholding.LoadPayeeAccountTaxWithholdingItemDetails();
                busPayeeAccountPaymentItemType lbusPayeeAccountPaymentItemType = new busPayeeAccountPaymentItemType { icdoPayeeAccountPaymentItemType = new cdoPayeeAccountPaymentItemType() };
                if (!lbusPayeeAccountTaxWithholding.iclbPayeeAccountTaxWithholdingItemDetail.IsNullOrEmpty())
                {
                    if (lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.end_date < idtNextBenefitPaymentDate)
                    {
                        if (lbusPayeeAccountPaymentItemType.FindPayeeAccountPaymentItemType(lbusPayeeAccountTaxWithholding.iclbPayeeAccountTaxWithholdingItemDetail.First().icdoPayeeAccountTaxWithholdingItemDetail.payee_account_payment_item_type_id))
                        {
                            lbusPayeeAccountPaymentItemType.icdoPayeeAccountPaymentItemType.end_date = lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.end_date;
                            lbusPayeeAccountPaymentItemType.icdoPayeeAccountPaymentItemType.Update();
                        }
                    }
                }
            }
            iclbPayeeAccountTaxWithholdingActive = (from item in this.iclbPayeeAccountTaxWithholding
                                                    where busGlobalFunctions.CheckDateOverlapping(idtBenefitPaymentDateForTaxWithholding =
                                                    item.icdoPayeeAccountTaxWithholding.start_date > idtNextBenefitPaymentDate ? item.icdoPayeeAccountTaxWithholding.start_date : idtNextBenefitPaymentDate,
                                                    item.icdoPayeeAccountTaxWithholding.start_date, item.icdoPayeeAccountTaxWithholding.end_date)
                                                    select item).ToList().ToCollection<busPayeeAccountTaxWithholding>();

            foreach (busPayeeAccountTaxWithholding lbusPayeeAccountTaxWithholding in iclbPayeeAccountTaxWithholdingActive)
            {
                if (lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.start_date > idtNextBenefitPaymentDate)
                    idtBenefitPaymentDateForTaxWithholding = lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.start_date;
                else
                    idtBenefitPaymentDateForTaxWithholding = idtNextBenefitPaymentDate;

                lbusPayeeAccountTaxWithholding.LoadPayeeAccountTaxWithholdingItemDetails();
                busPayeeAccountPaymentItemType lbusPayeeAccountPaymentItemType = new busPayeeAccountPaymentItemType { icdoPayeeAccountPaymentItemType = new cdoPayeeAccountPaymentItemType() };

                if (lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.tax_option_value == busConstant.NO_FEDRAL_TAX
                    || lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.tax_option_value == busConstant.NO_STATE_TAX)
                {
                    if (lbusPayeeAccountTaxWithholding.iclbPayeeAccountTaxWithholdingItemDetail != null && lbusPayeeAccountTaxWithholding.iclbPayeeAccountTaxWithholdingItemDetail.Count > 0)
                    {
                        foreach (busPayeeAccountTaxWithholdingItemDetail lbusPayeeAccountTaxWithholdingItemDetail in lbusPayeeAccountTaxWithholding.iclbPayeeAccountTaxWithholdingItemDetail)
                        {
                            if (lbusPayeeAccountTaxWithholdingItemDetail.icdoPayeeAccountTaxWithholdingItemDetail.payee_account_payment_item_type_id != 0)
                            {
                                busPayeeAccountPaymentItemType lobjPayeeAccountPaymentItemType = new busPayeeAccountPaymentItemType();
                                if (lobjPayeeAccountPaymentItemType.FindPayeeAccountPaymentItemType(lbusPayeeAccountTaxWithholdingItemDetail.icdoPayeeAccountTaxWithholdingItemDetail.payee_account_payment_item_type_id))
                                {
                                    lobjPayeeAccountPaymentItemType.icdoPayeeAccountPaymentItemType.Delete();
                                }
                            }
                            lbusPayeeAccountTaxWithholdingItemDetail.icdoPayeeAccountTaxWithholdingItemDetail.Delete();
                        }
                    }
                    lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.idecCalculatedTaxAmount = Decimal.Zero;
                }

                CalculateTaxForBenefit(lbusPayeeAccountTaxWithholding, false, ablnActiveRetireeBatch);
            }

        }
        public bool ProcessTaxWithHoldingDetailsForValidation()
        {
            decimal idecFinalAmount = 0.0M;
            if (this.iclbPayeeAccountTaxWithholding == null)
                LoadPayeeAccountTaxWithholdings();
            iclbPayeeAccountTaxWithholdingActive = (from item in this.iclbPayeeAccountTaxWithholding
                                                    where !busGlobalFunctions.CheckDateOverlapping(idtBenefitPaymentDateForTaxWithholding =
                                                    item.icdoPayeeAccountTaxWithholding.start_date > idtNextBenefitPaymentDate ? item.icdoPayeeAccountTaxWithholding.start_date : idtNextBenefitPaymentDate,
                                                    item.icdoPayeeAccountTaxWithholding.start_date, item.icdoPayeeAccountTaxWithholding.end_date)
                                                    select item).ToList().ToCollection<busPayeeAccountTaxWithholding>();

            iclbPayeeAccountTaxWithholdingActive = (from item in this.iclbPayeeAccountTaxWithholding
                                                    where busGlobalFunctions.CheckDateOverlapping(idtBenefitPaymentDateForTaxWithholding =
                                                    item.icdoPayeeAccountTaxWithholding.start_date > idtNextBenefitPaymentDate ? item.icdoPayeeAccountTaxWithholding.start_date : idtNextBenefitPaymentDate,
                                                    item.icdoPayeeAccountTaxWithholding.start_date, item.icdoPayeeAccountTaxWithholding.end_date)
                                                    select item).ToList().ToCollection<busPayeeAccountTaxWithholding>();
            iclbPayeeAccountPaymentItemTypeActive = (from item in this.iclbPayeeAccountPaymentItemType
                                                     where busGlobalFunctions.CheckDateOverlapping(idtNextBenefitPaymentDate,
                                                     item.icdoPayeeAccountPaymentItemType.start_date, item.icdoPayeeAccountPaymentItemType.end_date)
                                                     select item).ToList().ToCollection<busPayeeAccountPaymentItemType>();

            decimal idecNextMonthTaxableForval =
                 (from obj in iclbPayeeAccountPaymentItemTypeActive.AsEnumerable()
                  where obj.ibusPaymentItemType.icdoPaymentItemType.item_type_code == busConstant.ITEM1 ||
                  obj.ibusPaymentItemType.icdoPaymentItemType.item_type_code == busConstant.ITEM21 ||
                  obj.ibusPaymentItemType.icdoPaymentItemType.item_type_code == busConstant.ITEM48
                  select obj.icdoPayeeAccountPaymentItemType.amount).Sum() +
                                       (from obj in iclbPayeeAccountPaymentItemTypeActive.AsEnumerable()
                                        where
                                         obj.ibusPaymentItemType.icdoPaymentItemType.allow_rollover_code_value == "RRED" && obj.ibusPaymentItemType.icdoPaymentItemType.taxable_item_flag == busConstant.Flag_Yes
                                        select obj.icdoPayeeAccountPaymentItemType.amount * obj.ibusPaymentItemType.icdoPaymentItemType.item_type_direction).Sum()
                                    ;


            foreach (busPayeeAccountTaxWithholding lbusPayeeAccountTaxWithholding in iclbPayeeAccountTaxWithholdingActive)
            {
                if (lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.start_date > idtNextBenefitPaymentDate)
                    idtBenefitPaymentDateForTaxWithholding = lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.start_date;
                else
                    idtBenefitPaymentDateForTaxWithholding = idtNextBenefitPaymentDate;

                lbusPayeeAccountTaxWithholding.LoadPayeeAccountTaxWithholdingItemDetails();
                busPayeeAccountPaymentItemType lbusPayeeAccountPaymentItemType = new busPayeeAccountPaymentItemType { icdoPayeeAccountPaymentItemType = new cdoPayeeAccountPaymentItemType() };
                CalculateTaxForBenefitForValidation(lbusPayeeAccountTaxWithholding, ref idecFinalAmount);
            }
            if (idecFinalAmount > 0)
            {


                if (idecFinalAmount > idecNextMonthTaxableForval)
                {
                    return true;

                }
                //else
                //{
                //return false;
                //}
            }
            return false;

        }
        public void ProcessDeductionDetails()
        {
            if (this.iclbPayeeAccountDeduction == null)
                LoadPayeeAccountDeduction();

            if (idtNextBenefitPaymentDate == DateTime.MinValue)
                LoadNextBenefitPaymentDate();

            iclbPayeeAccountDeductionActive = (from item in this.iclbPayeeAccountDeduction
                                               where !busGlobalFunctions.CheckDateOverlapping(idtBenefitPaymentDateForTaxWithholding =
                                               item.icdoPayeeAccountDeduction.start_date > idtNextBenefitPaymentDate ? item.icdoPayeeAccountDeduction.start_date : idtNextBenefitPaymentDate,
                                               item.icdoPayeeAccountDeduction.start_date, item.icdoPayeeAccountDeduction.end_date)
                                               select item).ToList().ToCollection<busPayeeAccountDeduction>();

            foreach (busPayeeAccountDeduction lbusPayeeAccountDeduction in iclbPayeeAccountDeductionActive)
            {
                busPayeeAccountPaymentItemType lbusPayeeAccountPaymentItemType = new busPayeeAccountPaymentItemType { icdoPayeeAccountPaymentItemType = new cdoPayeeAccountPaymentItemType() };
                if (lbusPayeeAccountDeduction.IsNotNull())
                {
                    if (lbusPayeeAccountDeduction.icdoPayeeAccountDeduction.end_date < idtNextBenefitPaymentDate)
                    {
                        if (lbusPayeeAccountPaymentItemType.FindPayeeAccountPaymentItemType(lbusPayeeAccountDeduction.icdoPayeeAccountDeduction.payee_account_payment_item_type_id))
                        {
                            lbusPayeeAccountPaymentItemType.icdoPayeeAccountPaymentItemType.end_date = lbusPayeeAccountDeduction.icdoPayeeAccountDeduction.end_date;
                            lbusPayeeAccountPaymentItemType.icdoPayeeAccountPaymentItemType.Update();
                        }
                    }
                }
            }

            iclbPayeeAccountDeductionActive = (from item in this.iclbPayeeAccountDeduction
                                               where busGlobalFunctions.CheckDateOverlapping(idtBenefitPaymentDateForTaxWithholding =
                                               item.icdoPayeeAccountDeduction.start_date > idtNextBenefitPaymentDate ? item.icdoPayeeAccountDeduction.start_date : idtNextBenefitPaymentDate,
                                               item.icdoPayeeAccountDeduction.start_date, item.icdoPayeeAccountDeduction.end_date)
                                               select item).ToList().ToCollection<busPayeeAccountDeduction>();

            foreach (busPayeeAccountDeduction lbusPayeeAccountDeduction in iclbPayeeAccountDeductionActive)
            {
                if (lbusPayeeAccountDeduction.icdoPayeeAccountDeduction.start_date > idtNextBenefitPaymentDate)
                    idtBenefitPaymentDateForDeduction = lbusPayeeAccountDeduction.icdoPayeeAccountDeduction.start_date;
                else
                    idtBenefitPaymentDateForDeduction = idtNextBenefitPaymentDate;

                busPayeeAccountPaymentItemType lbusPayeeAccountPaymentItemType = new busPayeeAccountPaymentItemType { icdoPayeeAccountPaymentItemType = new cdoPayeeAccountPaymentItemType() };

                if (lbusPayeeAccountDeduction.IsNotNull())
                {
                    if (lbusPayeeAccountDeduction.icdoPayeeAccountDeduction.start_date.Date >= DateTime.Now.Date)
                        CreateOrUpdatePaymentItemTypeForDeduction(lbusPayeeAccountDeduction);
                }
                else
                    CreateOrUpdatePaymentItemTypeForDeduction(lbusPayeeAccountDeduction);
            }
        }

        //6/15/2020 - IAP Payback
        public void ProcessIAPHardshipPayback()
        {
            if (iclbIAPHardshipPayback.Count > 0)
            {
                busPersonAccount ibusPersonAccount = new busPersonAccount();
                DataTable ldtbList = busBase.Select("cdoPersonAccountRetirementContribution.GetIAPRetirementContributionbyPerson", new object[1] { this.icdoPayeeAccount.person_id });
                iclbPersonAccountRetirementContribution = GetCollection<busPersonAccountRetirementContribution>(ldtbList, "icdoPersonAccountRetirementContribution");

                foreach (busIapHardshipPayback ibusIapHardshipPayback in iclbIAPHardshipPayback)
                {
                    if (ibusIapHardshipPayback.icdoIapHardshipPayback.iap_hardship_payback_id == 0)
                    {
                        busPersonAccountRetirementContribution lobjRetrContribution = new busPersonAccountRetirementContribution { icdoPersonAccountRetirementContribution = new cdoPersonAccountRetirementContribution() };

                        if (ibusIapHardshipPayback.icdoIapHardshipPayback.check_amount != 0)
                        {
                            DataTable ldtbIAPBalance = new DataTable();
                            DataTable ldtbEmergencyPaymentSetupValue = new DataTable();
                            decimal idecFactor = 0;

                            switch (istrCOVIDOptionValue) //Paybacks should be posted back accoriding to the option selected in the benefit application and ratio to be applied based on options (if multiple plans)
                            {
                                case busConstant.COVID_IAP_ONLY_OPTION:
                                    lobjRetrContribution.InsertPersonAccountRetirementContirbution(this.ibusPayeeBenefitAccount.icdoPayeeBenefitAccount.person_account_id, ibusIapHardshipPayback.icdoIapHardshipPayback.check_date, ibusIapHardshipPayback.icdoIapHardshipPayback.payment_posted_date, this.icdoPayeeAccount.idtRetireMentDate.Year, adecIAPBalanceAmount: ibusIapHardshipPayback.icdoIapHardshipPayback.check_amount,
                                    astrTransactionType: busConstant.RCTransactionTypePayment, astrContributionType: busConstant.RCContributionTypeAllocation1);
                                    break;

                                case busConstant.COVID_L161_SPL_AC_ONLY_OPTION:
                                    lobjRetrContribution.InsertPersonAccountRetirementContirbution(this.ibusPayeeBenefitAccount.icdoPayeeBenefitAccount.person_account_id, ibusIapHardshipPayback.icdoIapHardshipPayback.check_date, ibusIapHardshipPayback.icdoIapHardshipPayback.payment_posted_date, this.icdoPayeeAccount.idtRetireMentDate.Year, adec161SplAccountBalance: ibusIapHardshipPayback.icdoIapHardshipPayback.check_amount,
                                    astrTransactionType: busConstant.RCTransactionTypePayment, astrContributionType: busConstant.RCContributionTypeAllocation1);
                                    break;

                                case busConstant.COVID_L52_SPL_AC_ONLY_OPTION:
                                    lobjRetrContribution.InsertPersonAccountRetirementContirbution(this.ibusPayeeBenefitAccount.icdoPayeeBenefitAccount.person_account_id, ibusIapHardshipPayback.icdoIapHardshipPayback.check_date, ibusIapHardshipPayback.icdoIapHardshipPayback.payment_posted_date, this.icdoPayeeAccount.idtRetireMentDate.Year, adec52SplAccountBalance: ibusIapHardshipPayback.icdoIapHardshipPayback.check_amount,
                                    astrTransactionType: busConstant.RCTransactionTypePayment, astrContributionType: busConstant.RCContributionTypeAllocation1);
                                    break;

                                case busConstant.COVID_L52_L161_SPL_AC_ONLY_OPTION:
                                    ldtbEmergencyPaymentSetupValue = busBase.Select("cdoEmergencyPaymentSetupValue.GetEmergencyPaymentSetupValue", new object[1] { DateTime.Now });
                                    ldtbIAPBalance = busBase.Select("cdoPersonAccountRetirementContribution.GetIAPBalanceAsofYear",
                                                   new object[2] { this.ibusPayeeBenefitAccount.icdoPayeeBenefitAccount.person_account_id, Convert.ToInt32(ldtbEmergencyPaymentSetupValue.Rows[0]["IAP_BALANCE_AS_OF_YEAR"]) });
                                    idecFactor = ibusIapHardshipPayback.icdoIapHardshipPayback.check_amount / Math.Round((Convert.ToDecimal(ldtbIAPBalance.Rows[0]["LOCAL52_SPECIAL_ACCT_BAL_AMOUNT"]) + Convert.ToDecimal(ldtbIAPBalance.Rows[0]["LOCAL161_SPECIAL_ACCT_BAL_AMOUNT"])), 2);
                                    lobjRetrContribution.InsertPersonAccountRetirementContirbution(this.ibusPayeeBenefitAccount.icdoPayeeBenefitAccount.person_account_id, ibusIapHardshipPayback.icdoIapHardshipPayback.check_date, ibusIapHardshipPayback.icdoIapHardshipPayback.payment_posted_date, this.icdoPayeeAccount.idtRetireMentDate.Year, adec52SplAccountBalance: Convert.ToDecimal(ldtbIAPBalance.Rows[0]["LOCAL52_SPECIAL_ACCT_BAL_AMOUNT"]) * idecFactor, adec161SplAccountBalance: Convert.ToDecimal(ldtbIAPBalance.Rows[0]["LOCAL161_SPECIAL_ACCT_BAL_AMOUNT"]) * idecFactor,
                                    astrTransactionType: busConstant.RCTransactionTypePayment, astrContributionType: busConstant.RCContributionTypeAllocation1);
                                    break;

                                case busConstant.COVID_ALL_OPTION:
                                    ldtbEmergencyPaymentSetupValue = busBase.Select("cdoEmergencyPaymentSetupValue.GetEmergencyPaymentSetupValue", new object[1] { DateTime.Now });
                                    ldtbIAPBalance = busBase.Select("cdoPersonAccountRetirementContribution.GetIAPBalanceAsofYear",
                                                   new object[2] { this.ibusPayeeBenefitAccount.icdoPayeeBenefitAccount.person_account_id, Convert.ToInt32(ldtbEmergencyPaymentSetupValue.Rows[0]["IAP_BALANCE_AS_OF_YEAR"]) });
                                    idecFactor = ibusIapHardshipPayback.icdoIapHardshipPayback.check_amount / Math.Round((Convert.ToDecimal(ldtbIAPBalance.Rows[0]["IAP_BALANCE_AMOUNT"]) + Convert.ToDecimal(ldtbIAPBalance.Rows[0]["LOCAL52_SPECIAL_ACCT_BAL_AMOUNT"]) + Convert.ToDecimal(ldtbIAPBalance.Rows[0]["LOCAL161_SPECIAL_ACCT_BAL_AMOUNT"])), 2);
                                    lobjRetrContribution.InsertPersonAccountRetirementContirbution(this.ibusPayeeBenefitAccount.icdoPayeeBenefitAccount.person_account_id, ibusIapHardshipPayback.icdoIapHardshipPayback.check_date, ibusIapHardshipPayback.icdoIapHardshipPayback.payment_posted_date, this.icdoPayeeAccount.idtRetireMentDate.Year, adecIAPBalanceAmount: Convert.ToDecimal(ldtbIAPBalance.Rows[0]["IAP_BALANCE_AMOUNT"]) * idecFactor, adec52SplAccountBalance: Convert.ToDecimal(ldtbIAPBalance.Rows[0]["LOCAL52_SPECIAL_ACCT_BAL_AMOUNT"]) * idecFactor, adec161SplAccountBalance: Convert.ToDecimal(ldtbIAPBalance.Rows[0]["LOCAL161_SPECIAL_ACCT_BAL_AMOUNT"]) * idecFactor,
                                    astrTransactionType: busConstant.RCTransactionTypePayment, astrContributionType: busConstant.RCContributionTypeAllocation1);
                                    break;
                            }

                            //lobjRetrContribution.InsertPersonAccountRetirementContirbution(this.ibusPayeeBenefitAccount.icdoPayeeBenefitAccount.person_account_id, ibusIapHardshipPayback.icdoIapHardshipPayback.check_date, ibusIapHardshipPayback.icdoIapHardshipPayback.payment_posted_date, this.icdoPayeeAccount.idtRetireMentDate.Year, adecIAPBalanceAmount: ibusIapHardshipPayback.icdoIapHardshipPayback.check_amount,
                            //astrTransactionType: busConstant.RCTransactionTypePayment, astrContributionType: busConstant.RCContributionTypeAllocation1);
                        }
                    }
                }
            }
        }
        #endregion

        public void LoadPayeeAccount()
        {
            DataTable ldtbPayeeAccount = busBase.Select("cdoPayeeAccount.LoadPayeeAccount", new object[1] { this.icdoPayeeAccount.payee_account_id });
            iclbPayeeAccount = GetCollection<busPayeeAccount>(ldtbPayeeAccount, "icdoPayeeAccount");
        }

        public Collection<busPayeeAccount> LoadRetireeIncPayeeAccount(int aintReferencePayeeAccountID)
        {
            Collection<busPayeeAccount> lclbPayeeAccount = new Collection<busPayeeAccount>();
            DataTable ldtbList = Select<cdoPayeeAccount>(
               new string[1] { enmPayeeAccount.reference_id.ToString() },
               new object[1] { aintReferencePayeeAccountID }, null, null);

            lclbPayeeAccount = GetCollection<busPayeeAccount>(ldtbList, "icdoPayeeAccount");

            if (lclbPayeeAccount != null)
                return lclbPayeeAccount;
            else
                return null;

        }

        //Change to fetch retiree increases as from conversion data is not properly set up : Reference Id not set up for many conversion records
        public Collection<busPayeeAccount> LoadRetireeIncFromAppDetail(int aintReferencePayeeAccountID)
        {
            DataTable ldtbList = busBase.Select("cdoPayeeAccount.GetRetireeIncPayeeFromAppDetail", new object[1] { aintReferencePayeeAccountID });

            Collection<busPayeeAccount> lclbPayeeAccount = GetCollection<busPayeeAccount>(ldtbList, "icdoPayeeAccount");

            if (lclbPayeeAccount != null)
                return lclbPayeeAccount;
            else
                return null;

        }
        /// <summary>
        /// Calculate TaxForBenefit
        /// </summary>
        /// <param name="lbusPayeeAccountTaxWithholding"></param>
        public void CalculateTaxForBenefit(busPayeeAccountTaxWithholding lbusPayeeAccountTaxWithholding, bool ablnUpdateTaxBatchFalg = busConstant.BOOL_FALSE, bool ablnActiveRetireeBatch = false) //PROD PIR 842
        {
            decimal idecFinalAmount = 0.0M;
            int iintMonthDifference = 0;
            string astrRetroPaymentType = string.Empty;
            string astrOrgRetroPaymentType = string.Empty;
            string strAccountNumber = string.Empty;

            LoadTaxableAmountForVariableTax(idtBenefitPaymentDateForTaxWithholding);

            if (idtStatusEffectiveDate == DateTime.MinValue)
                LoadPayeeAccountStatuss();

            if (this.iclbPayeeAccountStatus.Count > 0 && this.iclbPayeeAccountStatus.FirstOrDefault().icdoPayeeAccountStatus.status_effective_date != DateTime.MinValue) // ask to vinovin about this condition
                idtStatusEffectiveDate = this.iclbPayeeAccountStatus.FirstOrDefault().icdoPayeeAccountStatus.status_effective_date;


            if ((lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.tax_option_value == busConstant.FedTaxOptionFedTaxBasedOnIRS) ||
                 (lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.tax_option_value == busConstant.FedTaxOptionFedTaxBasedOnIRSAndAdditional) ||
                (lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.tax_option_value == busConstant.StateTaxOptionFedTaxBasedOnIRS) ||
                (lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.tax_option_value == busConstant.StateTaxOptionFedTaxBasedOnIRSAndAdditional ||
                lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.tax_option_value == busConstant.FLAT_DOLLAR)) //PIR 909
            {
                if (idtStatusEffectiveDate != DateTime.MinValue)
                {
                    if (icdoPayeeAccount.benefit_account_type_value != busConstant.BENEFIT_TYPE_WITHDRAWAL)
                        idecTotalTaxableAmount = idecTotalTaxableAmountForVariableTax;
                    else
                    {// for benefit type withdrawal
                        LoadNonTaxableAmount();
                        idecTotalTaxableAmount = ibusPayeeBenefitAccount.icdoPayeeBenefitAccount.gross_amount - idecNontaxableAmount - idecTotalRolledOverAmount;
                    }

                    idecFinalAmount = busPayeeAccountHelper.CalculateFedOrStateTax(idecTotalTaxableAmount, lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.tax_allowance,
                                                                 idtNextBenefitPaymentDate, lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.marital_status_value,
                                                                 lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.tax_identifier_value,
                                                                 lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.additional_tax_amount, lbusPayeeAccountTaxWithholding, false, null, ablnActiveRetireeBatch);
                    CreateorUpdatePaymentItemForFedOrStateTax(lbusPayeeAccountTaxWithholding, idecFinalAmount);
                }

                if (icdoPayeeAccount.benefit_account_type_value != busConstant.BENEFIT_TYPE_DISABILITY)
                {
                    if (this.icdoPayeeAccount.idtRetireMentDate == DateTime.MinValue)
                    {
                        LoadBenefitDetails();
                        LoadDRODetails();
                    }
                    //Prod PIR 101
                    if (this.icdoPayeeAccount.benefit_account_type_value == busConstant.BENEFIT_TYPE_DEATH_POST_RETIREMENT || this.icdoPayeeAccount.retiree_incr_flag == busConstant.FLAG_YES)
                    {
                        if (this.idtSuspendedStatusEffectiveDate != DateTime.MinValue) // Reactivation retro tax calulation
                            iintMonthDifference = busGlobalFunctions.GetMonthsBetweenTwoDates(this.idtSuspendedStatusEffectiveDate, idtNextBenefitPaymentDate);
                        else
                            iintMonthDifference = busGlobalFunctions.GetMonthsBetweenTwoDates(this.icdoPayeeAccount.benefit_begin_date, idtNextBenefitPaymentDate);
                    }
                    else
                    {
                        if (this.idtSuspendedStatusEffectiveDate != DateTime.MinValue) // Reactivation retro tax calulation
                            iintMonthDifference = busGlobalFunctions.GetMonthsBetweenTwoDates(this.idtSuspendedStatusEffectiveDate, idtNextBenefitPaymentDate);
                        else
                            iintMonthDifference = busGlobalFunctions.GetMonthsBetweenTwoDates(this.icdoPayeeAccount.idtRetireMentDate, idtNextBenefitPaymentDate);
                    }
                }
                else
                {
                    //PIR 889
                    //iintMonthDifference = busGlobalFunctions.GetMonthsBetweenTwoDates(this.icdoPayeeAccount.idtRetireMentDate, idtNextBenefitPaymentDate);
                    if (this.idtSuspendedStatusEffectiveDate != DateTime.MinValue) // Reactivation retro tax calulation
                        iintMonthDifference = busGlobalFunctions.GetMonthsBetweenTwoDates(this.idtSuspendedStatusEffectiveDate, idtNextBenefitPaymentDate);
                    else
                        iintMonthDifference = busGlobalFunctions.GetMonthsBetweenTwoDates(this.icdoPayeeAccount.idtRetireMentDate, idtNextBenefitPaymentDate);

                    int iintRetirementYear = this.icdoPayeeAccount.idtRetireMentDate.Year;
                    int iintPaymentYear = idtNextBenefitPaymentDate.Year;
                    DataTable ldtbList = busBase.Select("cdoPayeeAccountTaxWithholding.GetSuspendibleMonth", new object[3] { this.icdoPayeeAccount.payee_account_id, iintPaymentYear, iintRetirementYear });
                    if (ldtbList != null && ldtbList.Rows.Count > 0)
                    {
                        // PROD PIR 287 
                        if (ldtbList.Rows[0]["RETROACTIVE_AMOUNT"] != DBNull.Value && Convert.ToDecimal(ldtbList.Rows[0]["RETROACTIVE_AMOUNT"]) > 0
                            && ldtbList.Rows[0]["SUM_SUSPENDIBLE_MONTHS_COUNT"] != DBNull.Value && Convert.ToDecimal(ldtbList.Rows[0]["SUM_SUSPENDIBLE_MONTHS_COUNT"]) > 0)
                        {
                            iintMonthDifference = iintMonthDifference - Convert.ToInt32(ldtbList.Rows[0]["SUM_SUSPENDIBLE_MONTHS_COUNT"]);
                        }
                    }
                }

                if (iclbPayeeAccountRetroPayment == null)
                    LoadPayeeAccountRetroPayments();
                if (iclbPayeeAccountRetroPayment.Count > 0 && istrReissueFlag != busConstant.FLAG_YES)
                {
                    int iintPayeeAccountRetroPaymentID = 0;
                    int iintFromCodePaymentItemTypeID = 0;
                    int iintToCodePaymentItemTypeID = 0;
                    int iintVendorOrganizationID = 0;
                    Collection<busPayeeAccountRetroPayment> iclbPayeeAccountRetroPaymentActive = (from obj in iclbPayeeAccountRetroPayment.AsEnumerable()
                                                                                                  where busGlobalFunctions.CheckDateOverlapping(idtNextBenefitPaymentDate,
                                                                                                  obj.icdoPayeeAccountRetroPayment.start_date, obj.icdoPayeeAccountRetroPayment.end_date)

                                                                                                  && busGlobalFunctions.CheckDateOverlapping(obj.icdoPayeeAccountRetroPayment.start_date
                                                                                                   , lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.start_date, lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.end_date)
                                                                                                  select obj).ToList().ToCollection<busPayeeAccountRetroPayment>();
                    foreach (busPayeeAccountRetroPayment lobjPayeeAccountRetroPayment in iclbPayeeAccountRetroPaymentActive)
                    {
                        LoadPayeeAccountPaymentItemType();
                        iintPayeeAccountRetroPaymentID = lobjPayeeAccountRetroPayment.icdoPayeeAccountRetroPayment.payee_account_retro_payment_id;

                        astrRetroPaymentType = (from obj in iclbPayeeAccountRetroPaymentActive.AsEnumerable()
                                                where
                                                obj.icdoPayeeAccountRetroPayment.payee_account_retro_payment_id == lobjPayeeAccountRetroPayment.icdoPayeeAccountRetroPayment.payee_account_retro_payment_id
                                                select obj.icdoPayeeAccountRetroPayment.retro_payment_type_value).FirstOrDefault();

                        astrOrgRetroPaymentType = astrRetroPaymentType;

                        if (astrRetroPaymentType != busConstant.RETRO_PAYMENT_REACTIVATION)
                        {
                            astrRetroPaymentType = busConstant.RETRO_PAYMENT_INITIAL;
                        }

                        if (iclbRetroItemType == null)
                        {
                            this.LoadRetroItemType();
                        }

                        if (iclbPaymentItemType == null)
                            LoadPaymentItemType();

                        //rid 80130 - to correct the regular reactivation retro for both federal and state tax calculation.
                        if (astrOrgRetroPaymentType == busConstant.RETRO_PAYMENT_REACTIVATION)
                        {
                            ablnUpdateTaxBatchFalg = true;
                        }

                        ///PROD PIR 842
                        /// Getting only month difference from reactivation retro start date.
                        if (ablnUpdateTaxBatchFalg && astrOrgRetroPaymentType == busConstant.RETRO_PAYMENT_REACTIVATION)
                            iintMonthDifference = busGlobalFunctions.GetMonthsBetweenTwoDates(lobjPayeeAccountRetroPayment.icdoPayeeAccountRetroPayment.effective_start_date, idtNextBenefitPaymentDate);

                        if (lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.tax_option_value == busConstant.FedTaxOptionFedTaxBasedOnIRS ||
                             lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.tax_option_value == busConstant.FedTaxOptionFedTaxBasedOnIRSAndAdditional ||
                             (lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.tax_option_value == busConstant.FLAT_DOLLAR &&
                             lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.tax_identifier_value == busConstant.FEDRAL_STATE_TAX)) //PIR 909
                        {

                            string astrinretroitemFedralcodeTo = (iclbRetroItemType.Where(item => item.icdoRetroItemType.from_item_type == busConstant.ITEM13 && item.icdoRetroItemType.retro_payment_type_value == astrRetroPaymentType && item.icdoRetroItemType.payment_option_value == lobjPayeeAccountRetroPayment.icdoPayeeAccountRetroPayment.payment_option_value).First().icdoRetroItemType.to_item_type);
                            iintFromCodePaymentItemTypeID = (iclbPaymentItemType.Where(item => item.icdoPaymentItemType.item_type_code == busConstant.ITEM13).First().icdoPaymentItemType.payment_item_type_id);
                            iintToCodePaymentItemTypeID = (iclbPaymentItemType.Where(item => item.icdoPaymentItemType.item_type_code == astrinretroitemFedralcodeTo).First().icdoPaymentItemType.payment_item_type_id);
                            //if(lobjPayeeAccountRetroPayment.iclbPayeeAccountRetroPaymentDetail==null)
                            LoadPayeeAccountRetroPaymentDetails();
                            busPayeeAccountRetroPaymentDetail lbusPayeeAccountRetroPaymentDetail = (from obj in lobjPayeeAccountRetroPayment.iclbPayeeAccountRetroPaymentDetail.AsEnumerable()
                                                                                                    where obj.icdoPayeeAccountRetroPaymentDetail.payment_item_type_id == iintToCodePaymentItemTypeID
                                                                                                    select obj).FirstOrDefault();
                            iintVendorOrganizationID = GetFedTaxOrganization();

                            if (lbusPayeeAccountRetroPaymentDetail == null)
                            {

                                int iintPayeeAccountPaymentItemTypeId = 0;
                                if (astrOrgRetroPaymentType != busConstant.RETRO_PAYMENT_REACTIVATION && astrOrgRetroPaymentType != busConstant.RETRO_PAYMENT_INITIAL)
                                {
                                    idecFinalAmount = busPayeeAccountHelper.CalculateFedOrStateTax(idecTotalTaxableAmountForVariableTaxRetro, lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.tax_allowance,
                                                           idtNextBenefitPaymentDate, lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.marital_status_value,
                                                           lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.tax_identifier_value,
                                                           lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.additional_tax_amount, lbusPayeeAccountTaxWithholding, false, null, ablnActiveRetireeBatch);
                                    iintPayeeAccountPaymentItemTypeId = CreatePayeeAccountPaymentItemType(astrinretroitemFedralcodeTo, idecFinalAmount, string.Empty, iintVendorOrganizationID, idtNextBenefitPaymentDate, idtNextBenefitPaymentDate.GetLastDayofMonth(),
                                        istrReissueFlag, false);
                                    LoadPayeeAccountRetroPaymentDetails();
                                    lbusPayeeAccountRetroPaymentDetail = new busPayeeAccountRetroPaymentDetail();
                                    lbusPayeeAccountRetroPaymentDetail.CreatePayeeAccountRetroPaymentDetail(iintPayeeAccountRetroPaymentID, iintToCodePaymentItemTypeID, iintPayeeAccountPaymentItemTypeId, idecFinalAmount
                                          , 0, iintFromCodePaymentItemTypeID, iclbPayeeAccountRetroPayment);
                                }
                                else
                                {

                                    iintPayeeAccountPaymentItemTypeId = CreatePayeeAccountPaymentItemType(astrinretroitemFedralcodeTo, idecFinalAmount * iintMonthDifference, string.Empty, iintVendorOrganizationID, idtNextBenefitPaymentDate, idtNextBenefitPaymentDate.GetLastDayofMonth(),
                                         istrReissueFlag, false);
                                    LoadPayeeAccountRetroPaymentDetails();
                                    lbusPayeeAccountRetroPaymentDetail = new busPayeeAccountRetroPaymentDetail();
                                    lbusPayeeAccountRetroPaymentDetail.CreatePayeeAccountRetroPaymentDetail(iintPayeeAccountRetroPaymentID, iintToCodePaymentItemTypeID, iintPayeeAccountPaymentItemTypeId, idecFinalAmount * iintMonthDifference
                                          , 0, iintFromCodePaymentItemTypeID, iclbPayeeAccountRetroPayment);
                                }

                                //Payment Adjustments
                                if (istrReissueFlag == busConstant.FLAG_YES)
                                {
                                    InsertTaxPaymentItemsInReissueItemDetail(iintPaymentReissueDetailId, iintPayeeAccountPaymentItemTypeId);
                                }
                            }
                            else
                            {

                                busPayeeAccountPaymentItemType lbusPayeeAccountPaymentItemType = (from obj in iclbPayeeAccountPaymentItemType.AsEnumerable()
                                                                                                  where obj.icdoPayeeAccountPaymentItemType.payee_account_payment_item_type_id == lbusPayeeAccountRetroPaymentDetail.icdoPayeeAccountRetroPaymentDetail.payee_account_payment_item_type_id
                                                                                                  select obj).FirstOrDefault();
                                if (lbusPayeeAccountPaymentItemType != null)
                                {
                                    if (astrOrgRetroPaymentType != busConstant.RETRO_PAYMENT_REACTIVATION && astrOrgRetroPaymentType != busConstant.RETRO_PAYMENT_INITIAL)
                                    {
                                        idecFinalAmount = busPayeeAccountHelper.CalculateFedOrStateTax(idecTotalTaxableAmountForVariableTaxRetro, lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.tax_allowance,
                                                               idtNextBenefitPaymentDate, lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.marital_status_value,
                                                               lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.tax_identifier_value,
                                                               lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.additional_tax_amount, lbusPayeeAccountTaxWithholding, false, null, ablnActiveRetireeBatch);
                                        lbusPayeeAccountPaymentItemType.icdoPayeeAccountPaymentItemType.amount = idecFinalAmount;
                                        lbusPayeeAccountPaymentItemType.icdoPayeeAccountPaymentItemType.Update();
                                        lbusPayeeAccountRetroPaymentDetail.icdoPayeeAccountRetroPaymentDetail.amount = idecFinalAmount;

                                        //PIR 945
                                        if (lbusPayeeAccountRetroPaymentDetail.icdoPayeeAccountRetroPaymentDetail.amount != decimal.Zero)
                                            lbusPayeeAccountRetroPaymentDetail.icdoPayeeAccountRetroPaymentDetail.Update();
                                        else
                                        {
                                            lbusPayeeAccountRetroPaymentDetail.icdoPayeeAccountRetroPaymentDetail.Delete();
                                            lbusPayeeAccountPaymentItemType.icdoPayeeAccountPaymentItemType.Delete();
                                        }
                                    }
                                    else
                                    {
                                        lbusPayeeAccountPaymentItemType.icdoPayeeAccountPaymentItemType.amount = idecFinalAmount * iintMonthDifference;
                                        lbusPayeeAccountPaymentItemType.icdoPayeeAccountPaymentItemType.Update();
                                        lbusPayeeAccountRetroPaymentDetail.icdoPayeeAccountRetroPaymentDetail.amount = idecFinalAmount * iintMonthDifference;

                                        //PIR 945
                                        if (lbusPayeeAccountRetroPaymentDetail.icdoPayeeAccountRetroPaymentDetail.amount != decimal.Zero)
                                            lbusPayeeAccountRetroPaymentDetail.icdoPayeeAccountRetroPaymentDetail.Update();
                                        else
                                        {
                                            lbusPayeeAccountRetroPaymentDetail.icdoPayeeAccountRetroPaymentDetail.Delete();
                                            lbusPayeeAccountPaymentItemType.icdoPayeeAccountPaymentItemType.Delete();
                                        }
                                    }
                                }
                            }
                        }
                        if (lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.tax_option_value == busConstant.StateTaxOptionFedTaxBasedOnIRS ||
                            lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.tax_option_value == busConstant.StateTaxOptionFedTaxBasedOnIRSAndAdditional ||
                             (lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.tax_option_value == busConstant.FLAT_DOLLAR &&
                             lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.tax_identifier_value == busConstant.CA_STATE_TAX)) //PIR 909
                        {
                            string astrinstateretroitemcodeTo = (iclbRetroItemType.Where(item => item.icdoRetroItemType.from_item_type == busConstant.ITEM14 && item.icdoRetroItemType.retro_payment_type_value == astrRetroPaymentType && item.icdoRetroItemType.payment_option_value == lobjPayeeAccountRetroPayment.icdoPayeeAccountRetroPayment.payment_option_value).First().icdoRetroItemType.to_item_type);
                            iintFromCodePaymentItemTypeID = (iclbPaymentItemType.Where(item => item.icdoPaymentItemType.item_type_code == busConstant.ITEM14).First().icdoPaymentItemType.payment_item_type_id);
                            iintToCodePaymentItemTypeID = (iclbPaymentItemType.Where(item => item.icdoPaymentItemType.item_type_code == astrinstateretroitemcodeTo).First().icdoPaymentItemType.payment_item_type_id);
                            //if (lobjPayeeAccountRetroPayment.iclbPayeeAccountRetroPaymentDetail == null)
                            LoadPayeeAccountRetroPaymentDetails();
                            busPayeeAccountRetroPaymentDetail lbusPayeeAccountRetroPaymentDetail = (from obj in lobjPayeeAccountRetroPayment.iclbPayeeAccountRetroPaymentDetail.AsEnumerable()
                                                                                                    where obj.icdoPayeeAccountRetroPaymentDetail.payment_item_type_id == iintToCodePaymentItemTypeID
                                                                                                    select obj).FirstOrDefault();
                            iintVendorOrganizationID = GetStateTaxOrganization(lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.tax_identifier_value);
                            if (lbusPayeeAccountRetroPaymentDetail == null)
                            {
                                int iintPayeeAccountPaymentItemTypeId = 0;
                                if (astrOrgRetroPaymentType != busConstant.RETRO_PAYMENT_REACTIVATION && astrOrgRetroPaymentType != busConstant.RETRO_PAYMENT_INITIAL)
                                {
                                    idecFinalAmount = busPayeeAccountHelper.CalculateFedOrStateTax(idecTotalTaxableAmountForVariableTaxRetro, lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.tax_allowance,
                                                           idtNextBenefitPaymentDate, lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.marital_status_value,
                                                           lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.tax_identifier_value,
                                                           lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.additional_tax_amount, lbusPayeeAccountTaxWithholding, false, null, ablnActiveRetireeBatch);
                                    iintPayeeAccountPaymentItemTypeId = CreatePayeeAccountPaymentItemType(astrinstateretroitemcodeTo, idecFinalAmount, string.Empty, iintVendorOrganizationID, idtNextBenefitPaymentDate, idtNextBenefitPaymentDate.GetLastDayofMonth(),
                                        istrReissueFlag, false);
                                    LoadPayeeAccountRetroPaymentDetails();
                                    lbusPayeeAccountRetroPaymentDetail = new busPayeeAccountRetroPaymentDetail();
                                    lbusPayeeAccountRetroPaymentDetail.CreatePayeeAccountRetroPaymentDetail(iintPayeeAccountRetroPaymentID, iintToCodePaymentItemTypeID,
                                                                iintPayeeAccountPaymentItemTypeId, idecFinalAmount, 0, iintFromCodePaymentItemTypeID,
                                                                iclbPayeeAccountRetroPayment);
                                }
                                else
                                {
                                    iintPayeeAccountPaymentItemTypeId = CreatePayeeAccountPaymentItemType(astrinstateretroitemcodeTo, idecFinalAmount * iintMonthDifference, string.Empty, iintVendorOrganizationID, idtNextBenefitPaymentDate, idtNextBenefitPaymentDate.GetLastDayofMonth(),
                                      istrReissueFlag, false);
                                    LoadPayeeAccountRetroPaymentDetails();
                                    lbusPayeeAccountRetroPaymentDetail = new busPayeeAccountRetroPaymentDetail();
                                    lbusPayeeAccountRetroPaymentDetail.CreatePayeeAccountRetroPaymentDetail(iintPayeeAccountRetroPaymentID, iintToCodePaymentItemTypeID,
                                                                iintPayeeAccountPaymentItemTypeId, idecFinalAmount * iintMonthDifference, 0, iintFromCodePaymentItemTypeID,
                                                                iclbPayeeAccountRetroPayment);
                                }


                                //Payment Adjustments
                                if (istrReissueFlag == busConstant.FLAG_YES)
                                {
                                    InsertTaxPaymentItemsInReissueItemDetail(iintPaymentReissueDetailId, iintPayeeAccountPaymentItemTypeId);
                                }
                            }
                            else
                            {

                                busPayeeAccountPaymentItemType lbusPayeeAccountPaymentItemType = (from obj in iclbPayeeAccountPaymentItemType.AsEnumerable()
                                                                                                  where obj.icdoPayeeAccountPaymentItemType.payee_account_payment_item_type_id == lbusPayeeAccountRetroPaymentDetail.icdoPayeeAccountRetroPaymentDetail.payee_account_payment_item_type_id
                                                                                                  select obj).FirstOrDefault();
                                if (lbusPayeeAccountPaymentItemType.IsNotNull())
                                {
                                    if (astrOrgRetroPaymentType != busConstant.RETRO_PAYMENT_REACTIVATION && astrOrgRetroPaymentType != busConstant.RETRO_PAYMENT_INITIAL)
                                    {
                                        idecFinalAmount = busPayeeAccountHelper.CalculateFedOrStateTax(idecTotalTaxableAmountForVariableTaxRetro, lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.tax_allowance,
                                                               idtNextBenefitPaymentDate, lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.marital_status_value,
                                                               lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.tax_identifier_value,
                                                               lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.additional_tax_amount, lbusPayeeAccountTaxWithholding, false, null, ablnActiveRetireeBatch);
                                        lbusPayeeAccountPaymentItemType.icdoPayeeAccountPaymentItemType.amount = idecFinalAmount;
                                        lbusPayeeAccountPaymentItemType.icdoPayeeAccountPaymentItemType.Update();
                                        lbusPayeeAccountRetroPaymentDetail.icdoPayeeAccountRetroPaymentDetail.amount = idecFinalAmount;

                                        //PIR 945
                                        if (lbusPayeeAccountRetroPaymentDetail.icdoPayeeAccountRetroPaymentDetail.amount != decimal.Zero)
                                            lbusPayeeAccountRetroPaymentDetail.icdoPayeeAccountRetroPaymentDetail.Update();
                                        else
                                        {
                                            lbusPayeeAccountRetroPaymentDetail.icdoPayeeAccountRetroPaymentDetail.Delete();
                                            lbusPayeeAccountPaymentItemType.icdoPayeeAccountPaymentItemType.Delete();
                                        }
                                    }
                                    else
                                    {
                                        lbusPayeeAccountPaymentItemType.icdoPayeeAccountPaymentItemType.amount = idecFinalAmount * iintMonthDifference;
                                        lbusPayeeAccountPaymentItemType.icdoPayeeAccountPaymentItemType.Update();
                                        lbusPayeeAccountRetroPaymentDetail.icdoPayeeAccountRetroPaymentDetail.amount = idecFinalAmount * iintMonthDifference;
                                        //PIR 945
                                        if (lbusPayeeAccountRetroPaymentDetail.icdoPayeeAccountRetroPaymentDetail.amount != decimal.Zero)
                                            lbusPayeeAccountRetroPaymentDetail.icdoPayeeAccountRetroPaymentDetail.Update();
                                        else
                                        {
                                            lbusPayeeAccountRetroPaymentDetail.icdoPayeeAccountRetroPaymentDetail.Delete();
                                            lbusPayeeAccountPaymentItemType.icdoPayeeAccountPaymentItemType.Delete();
                                        }
                                    }
                                }
                            }
                            lobjPayeeAccountRetroPayment.icdoPayeeAccountRetroPayment.net_payment_amount = lobjPayeeAccountRetroPayment.icdoPayeeAccountRetroPayment.net_payment_amount - (idecFinalAmount * iintMonthDifference);
                            lobjPayeeAccountRetroPayment.icdoPayeeAccountRetroPayment.Update();
                        }
                    }
                    ///updating retro net amount
                    ///
                    LoadPayeeAccountRetroPaymentDetails();
                    foreach (busPayeeAccountRetroPayment lobjPayeeAccountRetroPayment in iclbPayeeAccountRetroPaymentActive)
                    {
                        decimal adecRetroTaxableAmount = 0.00m;
                        //temp code
                        adecRetroTaxableAmount = (from obj in lobjPayeeAccountRetroPayment.iclbPayeeAccountRetroPaymentDetail.AsEnumerable()
                                                  where obj.icdoPayeeAccountRetroPaymentDetail.payment_item_type_id == 15 || obj.icdoPayeeAccountRetroPaymentDetail.payment_item_type_id == 16
                                                  || obj.icdoPayeeAccountRetroPaymentDetail.payment_item_type_id == 35 || obj.icdoPayeeAccountRetroPaymentDetail.payment_item_type_id == 36
                                                  || obj.icdoPayeeAccountRetroPaymentDetail.payment_item_type_id == 19 || obj.icdoPayeeAccountRetroPaymentDetail.payment_item_type_id == 20 //rid 81331
                                                  || obj.icdoPayeeAccountRetroPaymentDetail.payment_item_type_id == 39 || obj.icdoPayeeAccountRetroPaymentDetail.payment_item_type_id == 40 //rid 81331                                                
                                                  select obj.icdoPayeeAccountRetroPaymentDetail.amount).Sum();
                        lobjPayeeAccountRetroPayment.icdoPayeeAccountRetroPayment.net_payment_amount = lobjPayeeAccountRetroPayment.icdoPayeeAccountRetroPayment.gross_payment_amount - adecRetroTaxableAmount;
                        lobjPayeeAccountRetroPayment.icdoPayeeAccountRetroPayment.Update();
                    }

                }

            }
            else if (lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.tax_option_value == busConstant.FLAT_PERCENT) // ask to abhishek
            {
                idecFinalAmount = (idecTotalTaxableAmountForVariableTax - idecTotalTaxableRolledOverAmount) * lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.tax_percentage / 100;
                CreateorUpdatePaymentItemForFedOrStateTax(lbusPayeeAccountTaxWithholding, idecFinalAmount);
            }
            //PIR 909
            //else if (lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.tax_option_value == busConstant.FLAT_DOLLAR)
            //{
            //    idecFinalAmount = lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.additional_tax_amount;
            //    CreateorUpdatePaymentItemForFedOrStateTax(lbusPayeeAccountTaxWithholding, idecFinalAmount);
            //}

            GetCalculatedTaxAmount();
        }
        public void CalculateTaxForBenefitForValidation(busPayeeAccountTaxWithholding lbusPayeeAccountTaxWithholding, ref decimal idecFinalAmount)
        {


            string astrRetroPaymentType = string.Empty;
            string astrOrgRetroPaymentType = string.Empty;
            string strAccountNumber = string.Empty;

            LoadTaxableAmountForVariableTax(idtBenefitPaymentDateForTaxWithholding);

            if (idtStatusEffectiveDate == DateTime.MinValue)
                LoadPayeeAccountStatuss();

            if (this.iclbPayeeAccountStatus.Count > 0 && this.iclbPayeeAccountStatus.FirstOrDefault().icdoPayeeAccountStatus.status_effective_date != DateTime.MinValue) // ask to vinovin about this condition
                idtStatusEffectiveDate = this.iclbPayeeAccountStatus.FirstOrDefault().icdoPayeeAccountStatus.status_effective_date;


            if ((lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.tax_option_value == busConstant.FedTaxOptionFedTaxBasedOnIRS) ||
                 (lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.tax_option_value == busConstant.FedTaxOptionFedTaxBasedOnIRSAndAdditional) ||
                (lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.tax_option_value == busConstant.StateTaxOptionFedTaxBasedOnIRS) ||
                (lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.tax_option_value == busConstant.StateTaxOptionFedTaxBasedOnIRSAndAdditional))
            {
                if (idtStatusEffectiveDate != DateTime.MinValue)
                {
                    if (icdoPayeeAccount.benefit_account_type_value != busConstant.BENEFIT_TYPE_WITHDRAWAL)
                        idecTotalTaxableAmount = idecTotalTaxableAmountForVariableTax;
                    else
                    {// for benefit type withdrawal
                        LoadNonTaxableAmount();
                        idecTotalTaxableAmount = ibusPayeeBenefitAccount.icdoPayeeBenefitAccount.gross_amount - idecNontaxableAmount - idecTotalRolledOverAmount;
                    }

                    idecFinalAmount += busPayeeAccountHelper.CalculateFedOrStateTax(idecTotalTaxableAmount, lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.tax_allowance,
                                                                 idtNextBenefitPaymentDate, lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.marital_status_value,
                                                                 lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.tax_identifier_value,
                                                                 lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.additional_tax_amount,
                                                                 lbusPayeeAccountTaxWithholding);

                }

            }
            else if (lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.tax_option_value == busConstant.FLAT_PERCENT) // ask to abhishek
            {
                idecFinalAmount += (idecTotalTaxableAmountForVariableTax - idecTotalTaxableRolledOverAmount) * lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.tax_percentage / 100;

            }
            else if (lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.tax_option_value == busConstant.FLAT_DOLLAR)
            {
                if (lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.tax_identifier_value == busConstant.VA_STATE_TAX)
                    idecFinalAmount += lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.voluntary_withholding;
                else
                    idecFinalAmount += lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.additional_tax_amount;

            }


        }

        /// <summary>
        /// Create Payment Item For FedOrStateTax
        /// </summary>
        /// <param name="lbusPayeeAccountTaxWithholding"></param>
        /// <param name="idecFinalAmount"></param>
        private void CreateorUpdatePaymentItemForFedOrStateTax(busPayeeAccountTaxWithholding lbusPayeeAccountTaxWithholding, decimal idecFinalAmount)
        {
            int iintPayeeAccountPaymentItemID = 0;
            int iintorganization = 0;
            string astrItemCode = string.Empty;
            bool lblnRetireePayeeAccount = false;

            LoadPayeeAccountPaymentItemType();

            if (!iclbPayeeAccountPaymentItemType.Where(item => item.icdoPayeeAccountPaymentItemType.payment_item_type_id == 48).IsNullOrEmpty())
            {
                lblnRetireePayeeAccount = true;
            }

            if (lblnRetireePayeeAccount)
            {
                if (lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.tax_identifier_value == busConstant.FEDRAL_STATE_TAX)
                    astrItemCode = busConstant.ITEM51;
                else
                    astrItemCode = busConstant.ITEM52;
            }
            else
            {
                if (lbusPayeeAccountTaxWithholding.iclbPayeeAccountTaxWithholdingItemDetail.IsNullOrEmpty())
                    lbusPayeeAccountTaxWithholding.LoadPayeeAccountTaxWithholdingItemDetails();

                if (icdoPayeeAccount.istrBenefitOption != busConstant.LUMP_SUM_DESCRIPTION)
                {
                    if (lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.tax_identifier_value == busConstant.FEDRAL_STATE_TAX)
                        astrItemCode = busConstant.ITEM13;
                    else
                        astrItemCode = busConstant.ITEM14;
                }
                else
                {
                    if (lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.tax_identifier_value == busConstant.FEDRAL_STATE_TAX)
                        astrItemCode = busConstant.ITEM33;
                    else
                        astrItemCode = busConstant.ITEM34;
                }
            }

            if (lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.tax_identifier_value == busConstant.FEDRAL_STATE_TAX)
                iintorganization = GetFedTaxOrganization();
            else
                iintorganization = GetStateTaxOrganization(lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.tax_identifier_value);

            DateTime idtPaymentItemTypeStartDate = lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.start_date;
            if (lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.start_date.Day != 1)
            {
                idtPaymentItemTypeStartDate = lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.start_date.AddMonths(1).GetFirstDayofMonth();
            }

            if (idtNextBenefitPaymentDate == DateTime.MinValue)
            {
                LoadNextBenefitPaymentDate();
            }

            idtPaymentItemTypeStartDate = idtBenefitPaymentDateForTaxWithholding;

            iintPayeeAccountPaymentItemID = CreatePayeeAccountPaymentItemType(astrItemCode, idecFinalAmount, String.Empty, iintorganization,
                   idtPaymentItemTypeStartDate, lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.end_date, istrReissueFlag, false, false,
                   lbusPayeeAccountTaxWithholding.iclbPayeeAccountTaxWithholdingItemDetail.IsNullOrEmpty() ? 0 : lbusPayeeAccountTaxWithholding.iclbPayeeAccountTaxWithholdingItemDetail.First().icdoPayeeAccountTaxWithholdingItemDetail.payee_account_payment_item_type_id);


            //Payment Adjustments
            if (istrReissueFlag == busConstant.FLAG_YES)
            {
                InsertTaxPaymentItemsInReissueItemDetail(iintPaymentReissueDetailId, iintPayeeAccountPaymentItemID);
            }

            busPaymentItemType lobjPaymentItemType = new busPaymentItemType();
            lobjPaymentItemType.FindPaymentItemTypeByItemCode(astrItemCode);
            if (iintPayeeAccountPaymentItemID > 0)
            {
                lbusPayeeAccountTaxWithholding.CreateorUpdatePayeeAccoutTaxWithholdingDetail(lobjPaymentItemType.icdoPaymentItemType.payment_item_type_id, idecFinalAmount, iintPayeeAccountPaymentItemID,
                                                                                             lbusPayeeAccountTaxWithholding.iclbPayeeAccountTaxWithholdingItemDetail.IsNullOrEmpty() ? 0 : lbusPayeeAccountTaxWithholding.iclbPayeeAccountTaxWithholdingItemDetail.First().icdoPayeeAccountTaxWithholdingItemDetail.payee_account_tax_withholding_item_dtl_id);
            }
        }


        public void LoadPayeeAccountDeduction()
        {
            DataTable ldtbList = Select<cdoPayeeAccountDeduction>(
                new string[1] { enmPayeeAccountDeduction.payee_account_id.ToString() },
                new object[1] { icdoPayeeAccount.payee_account_id }, null, null);
            iclbPayeeAccountDeduction = GetCollection<busPayeeAccountDeduction>(ldtbList, "icdoPayeeAccountDeduction");

            if (this.iclbPayeeAccountDeduction.Count > 0)
            {
                foreach (busPayeeAccountDeduction lbusPayeeAccountDeduction in this.iclbPayeeAccountDeduction)
                {
                    DataTable ldtbOrgDetails = busBase.Select("cdoOrganization.GetOrgDetailsByOrganizationId", new object[1] { lbusPayeeAccountDeduction.icdoPayeeAccountDeduction.org_id });
                    if (ldtbOrgDetails.Rows.Count > 0 && ldtbOrgDetails.IsNotNull())
                    {
                        DataRow ldtrRow = ldtbOrgDetails.Rows[0];
                        lbusPayeeAccountDeduction.icdoPayeeAccountDeduction.istrOrgMPID = Convert.ToString(ldtrRow["MPI_ORG_ID"]);
                        lbusPayeeAccountDeduction.icdoPayeeAccountDeduction.istrOrgName = Convert.ToString(ldtrRow["ORG_NAME"]);
                    }
                    else
                    {
                        lbusPayeeAccountDeduction.icdoPayeeAccountDeduction.istrOrgMPID = string.Empty;
                        lbusPayeeAccountDeduction.icdoPayeeAccountDeduction.istrOrgName = string.Empty;
                    }

                    DataTable ldtbPersonDetails = busBase.Select("cdoPerson.GetPersonDetailsByPersonID", new object[1] { lbusPayeeAccountDeduction.icdoPayeeAccountDeduction.person_id });
                    if (ldtbPersonDetails.Rows.Count > 0 && ldtbPersonDetails.IsNotNull())
                    {
                        DataRow ldtrRow = ldtbPersonDetails.Rows[0];
                        lbusPayeeAccountDeduction.icdoPayeeAccountDeduction.istrPersonMPID = Convert.ToString(ldtrRow["MPI_PERSON_ID"]);
                        lbusPayeeAccountDeduction.icdoPayeeAccountDeduction.istrPersonName = Convert.ToString(ldtrRow["FULLNAME"]);
                    }
                    else
                    {
                        lbusPayeeAccountDeduction.icdoPayeeAccountDeduction.istrPersonMPID = string.Empty;
                        lbusPayeeAccountDeduction.icdoPayeeAccountDeduction.istrPersonName = string.Empty;
                    }
                }
            }
        }

        public void InsertTaxPaymentItemsInReissueItemDetail(int aPaymentReissueDetailId, int aPayeeAccountPaymentTypeId)
        {
            if (aPaymentReissueDetailId > 0)
            {
                busPaymentReissueDetail lbusPaymentReissueDetail = new busPaymentReissueDetail();

                lbusPaymentReissueDetail.InsertIntoPaymentReissueItemDetail(aPaymentReissueDetailId, aPayeeAccountPaymentTypeId);
            }
        }

        public ArrayList btn_DeleteWithHoldingClick(int aintpayee_account_tax_withholding_id)
        {
            ArrayList arr = new ArrayList();

            if (astrCheckCurrentPage == busConstant.PAYEE_ACCOUNT_TAXWITHHOLDING_MAINTENANCE)
            {
                busPayeeAccountTaxWithholding iobjbusPayeeAccountTaxWithholding = (from obj in iclbPayeeAccountTaxWithholding.AsEnumerable()
                                                                                   where obj.icdoPayeeAccountTaxWithholding.payee_account_tax_withholding_id == aintpayee_account_tax_withholding_id
                                                                                   select obj).FirstOrDefault();
                if (iobjbusPayeeAccountTaxWithholding != null)
                {
                    iobjbusPayeeAccountTaxWithholding.iclbPayeeAccountTaxWithholdingItemDetail = LoadPayeeAccountTaxWithholdingItemDetailWithpayee_account_tax_withholding_id(aintpayee_account_tax_withholding_id);
                    foreach (busPayeeAccountTaxWithholdingItemDetail ibusPayeeAccountTaxWithholdingItemDetail in iobjbusPayeeAccountTaxWithholding.iclbPayeeAccountTaxWithholdingItemDetail)
                    {
                        if (ibusPayeeAccountTaxWithholdingItemDetail.icdoPayeeAccountTaxWithholdingItemDetail.payee_account_payment_item_type_id != 0)
                        {
                            int aintPayeeAccountPaymentItemTypeId = ibusPayeeAccountTaxWithholdingItemDetail.icdoPayeeAccountTaxWithholdingItemDetail.payee_account_payment_item_type_id;
                            ibusPayeeAccountTaxWithholdingItemDetail.ibusPayeeAccountPaymentItemType = new busPayeeAccountPaymentItemType();
                            if (!(ibusPayeeAccountTaxWithholdingItemDetail.ibusPayeeAccountPaymentItemType.FindPayeeAccountPaymentItemType(aintPayeeAccountPaymentItemTypeId)))
                            {
                                ibusPayeeAccountTaxWithholdingItemDetail.ibusPayeeAccountPaymentItemType = null;
                            }
                        }
                    }
                    foreach (busPayeeAccountTaxWithholdingItemDetail ibusPayeeAccountTaxWithholdingItemDetail in iobjbusPayeeAccountTaxWithholding.iclbPayeeAccountTaxWithholdingItemDetail)
                    {
                        if (ibusPayeeAccountTaxWithholdingItemDetail.ibusPayeeAccountPaymentItemType != null)
                        {
                            ibusPayeeAccountTaxWithholdingItemDetail.ibusPayeeAccountPaymentItemType.icdoPayeeAccountPaymentItemType.Delete();

                        }
                        ibusPayeeAccountTaxWithholdingItemDetail.icdoPayeeAccountTaxWithholdingItemDetail.Delete();
                    }
                    iobjbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.Delete();
                }

                iclbPayeeAccountTaxWithholding.Remove(iobjbusPayeeAccountTaxWithholding);
                CreateReviewPayeeAccountStatus();
            }
            if (astrCheckCurrentPage == busConstant.PAYEE_ACCOUNT_ROLLOVER_MAINTENANCE)
            {
                busPayeeAccountRolloverDetail iobjPayeeAccountRolloverDetail = (from obj in iclbPayeeAccountRolloverDetail.AsEnumerable()
                                                                                where obj.icdoPayeeAccountRolloverDetail.payee_account_rollover_detail_id == aintpayee_account_tax_withholding_id
                                                                                select obj).FirstOrDefault();
                if (iobjPayeeAccountRolloverDetail != null)
                {
                    iobjPayeeAccountRolloverDetail.iclbPayeeAccountRolloverItemDetail = LoadPayeeAccountRolloverItemDetailsWithPayee_Account_Rollover_ID(aintpayee_account_tax_withholding_id);
                    foreach (busPayeeAccountRolloverItemDetail lbusPayeeAccountRolloverItemDetail in iobjPayeeAccountRolloverDetail.iclbPayeeAccountRolloverItemDetail)
                    {
                        if (lbusPayeeAccountRolloverItemDetail.icdoPayeeAccountRolloverItemDetail.payee_account_payment_item_type_id != 0)
                        {
                            int aintPayeeAccountPaymentItemTypeId = lbusPayeeAccountRolloverItemDetail.icdoPayeeAccountRolloverItemDetail.payee_account_payment_item_type_id;
                            lbusPayeeAccountRolloverItemDetail.ibusPayeeAccountPaymentItemType = new busPayeeAccountPaymentItemType();
                            if (!(lbusPayeeAccountRolloverItemDetail.ibusPayeeAccountPaymentItemType.FindPayeeAccountPaymentItemType(aintPayeeAccountPaymentItemTypeId)))
                            {
                                lbusPayeeAccountRolloverItemDetail.ibusPayeeAccountPaymentItemType = null;
                            }
                        }
                    }
                    foreach (busPayeeAccountRolloverItemDetail lbusPayeeAccountRolloverItemDetail in iobjPayeeAccountRolloverDetail.iclbPayeeAccountRolloverItemDetail)
                    {
                        if (lbusPayeeAccountRolloverItemDetail.ibusPayeeAccountPaymentItemType != null)
                        {
                            lbusPayeeAccountRolloverItemDetail.ibusPayeeAccountPaymentItemType.icdoPayeeAccountPaymentItemType.Delete();

                        }
                        lbusPayeeAccountRolloverItemDetail.icdoPayeeAccountRolloverItemDetail.Delete();
                    }
                    iobjPayeeAccountRolloverDetail.icdoPayeeAccountRolloverDetail.Delete();
                }
                iclbPayeeAccountRolloverDetail.Remove(iobjPayeeAccountRolloverDetail);
                ProcessTaxWithHoldingDetails();
                CreateReviewPayeeAccountStatus();
            }

            if (astrCheckCurrentPage == busConstant.PAYEE_ACCOUNT_DEDUCTION_MAINTENANCE)
            {
                busPayeeAccountDeduction iobjPayeeAccountDeduction = (from obj in iclbPayeeAccountDeduction.AsEnumerable()
                                                                      where obj.icdoPayeeAccountDeduction.payee_account_deduction_id == aintpayee_account_tax_withholding_id
                                                                      select obj).FirstOrDefault();
                if (iobjPayeeAccountDeduction != null)
                {
                    if (iobjPayeeAccountDeduction.icdoPayeeAccountDeduction.payee_account_payment_item_type_id != 0)
                    {
                        int aintPayeeAccountPaymentItemTypeId = iobjPayeeAccountDeduction.icdoPayeeAccountDeduction.payee_account_payment_item_type_id;
                        iobjPayeeAccountDeduction.ibusPayeeAccountPaymentItemType = new busPayeeAccountPaymentItemType();
                        iobjPayeeAccountDeduction.ibusPayeeAccountPaymentItemType.FindPayeeAccountPaymentItemType(aintPayeeAccountPaymentItemTypeId);
                        if (iobjPayeeAccountDeduction.ibusPayeeAccountPaymentItemType != null)
                        {
                            iobjPayeeAccountDeduction.ibusPayeeAccountPaymentItemType.icdoPayeeAccountPaymentItemType.Delete();
                        }
                    }
                    iobjPayeeAccountDeduction.icdoPayeeAccountDeduction.Delete();
                }
                iclbPayeeAccountDeduction.Remove(iobjPayeeAccountDeduction);
                CreateReviewPayeeAccountStatus();
            }

            arr.Add(this);
            return arr;
        }

        public Collection<busPayeeAccountTaxWithholdingItemDetail> LoadPayeeAccountTaxWithholdingItemDetailWithpayee_account_tax_withholding_id(int aintpayee_account_tax_withholding_id)
        {

            DataTable ldtbList = Select<cdoPayeeAccountTaxWithholdingItemDetail>(
                new string[1] { enmPayeeAccountTaxWithholdingItemDetail.payee_account_tax_withholding_id.ToString() },
                new object[1] { aintpayee_account_tax_withholding_id }, null, null);

            return GetCollection<busPayeeAccountTaxWithholdingItemDetail>(ldtbList, "icdoPayeeAccountTaxWithholdingItemDetail");
        }

        public Collection<busPayeeAccountRolloverItemDetail> LoadPayeeAccountRolloverItemDetailsWithPayee_Account_Rollover_ID(int aintpayee_account_rollover_details_id)
        {
            DataTable ldtblist = Select<cdoPayeeAccountRolloverItemDetail>(new string[1] { enmPayeeAccountRolloverItemDetail.payee_account_rollover_detail_id.ToString() },
                new object[1] { aintpayee_account_rollover_details_id }, null, null);
            return GetCollection<busPayeeAccountRolloverItemDetail>(ldtblist, "icdoPayeeAccountRolloverItemDetail");
        }

        private void CreateOrUpdateRolloverDetails(busPayeeAccountRolloverDetail lbusPayeeAccountRolloverDetail)
        {
            //this bus AmountDetails Mus BeforePersistChanges loaded
            LoadTotalRolloverAmount();
            LoadPayeeAccountPaymentItemType();

            // Active Payee Account Payment Item type
            iclbPayeeAccountPaymentItemTypeActive = (from item in this.iclbPayeeAccountPaymentItemType
                                                     where busGlobalFunctions.CheckDateOverlapping(idtNextBenefitPaymentDate,
                                                     item.icdoPayeeAccountPaymentItemType.start_date, item.icdoPayeeAccountPaymentItemType.end_date)
                                                     select item).ToList().ToCollection<busPayeeAccountPaymentItemType>();

            Collection<busPayeeAccountPaymentItemType> lclbRolloverItems = new Collection<busPayeeAccountPaymentItemType>();

            foreach (busPayeeAccountPaymentItemType lobjPaymentItemType in iclbPayeeAccountPaymentItemTypeActive) // Collection of Taxable and non taxable payment item type
            {
                if (lobjPaymentItemType.ibusPaymentItemType.icdoPaymentItemType.allow_rollover_code_value == busConstant.PayeeAccountAllowRollover)
                {

                    if (lbusPayeeAccountRolloverDetail.icdoPayeeAccountRolloverDetail.rollover_option_value == busConstant.PayeeAccountRolloverOptionAmountOfTaxable)
                    {
                        LoadRolloverItems(lclbRolloverItems, lobjPaymentItemType, lbusPayeeAccountRolloverDetail);
                        if (lclbRolloverItems.Count > 0)
                            break;
                    }
                    else
                    {
                        LoadRolloverItems(lclbRolloverItems, lobjPaymentItemType, lbusPayeeAccountRolloverDetail);
                    }
                }
            }

            foreach (busPayeeAccountPaymentItemType lobjRolloverItems in lclbRolloverItems) // Collection of Taxable and non taxable amount
            {
                decimal ldecRolloveramount = 0.00m;
                //decimal ldecDollorOfGrossAmt = 0.00m;
                decimal ldecRemainingDollorOfGrossAmt = 0.00M;


                if (lobjRolloverItems.ibusPaymentItemType.icdoPaymentItemType.taxable_item_flag == busConstant.Flag_Yes)
                {
                    // % of Taxable Amount 
                    if (lbusPayeeAccountRolloverDetail.icdoPayeeAccountRolloverDetail.rollover_option_value == busConstant.PayeeAccountRolloverOptionPercentageOfTaxable)
                    {
                        ldecRolloveramount = GetRolloverAmount(lobjRolloverItems, lbusPayeeAccountRolloverDetail);
                    }

                    // $ of GROSS Amount 
                    if (lbusPayeeAccountRolloverDetail.icdoPayeeAccountRolloverDetail.rollover_option_value == busConstant.PayeeAccountRolloverOptionDollorOfGross)
                    {
                        if (lbusPayeeAccountRolloverDetail.icdoPayeeAccountRolloverDetail.amount > lobjRolloverItems.icdoPayeeAccountPaymentItemType.amount)
                        {
                            ldecRolloveramount = lobjRolloverItems.icdoPayeeAccountPaymentItemType.amount;
                            ldecRemainingDollorOfGrossAmt = lbusPayeeAccountRolloverDetail.icdoPayeeAccountRolloverDetail.amount - ldecRolloveramount;
                        }
                        else
                        {
                            ldecRolloveramount = lbusPayeeAccountRolloverDetail.icdoPayeeAccountRolloverDetail.amount;
                        }
                    }

                    if (lbusPayeeAccountRolloverDetail.icdoPayeeAccountRolloverDetail.rollover_option_value == busConstant.PayeeAccountRolloverOptionAmountOfTaxable)
                    {
                        ldecRolloveramount = lobjRolloverItems.icdoPayeeAccountPaymentItemType.amount;
                    }

                    if (lbusPayeeAccountRolloverDetail.icdoPayeeAccountRolloverDetail.rollover_option_value == busConstant.PayeeAccountRolloverOptionAllOfGross ||
                        lbusPayeeAccountRolloverDetail.icdoPayeeAccountRolloverDetail.rollover_option_value == busConstant.PayeeAccountRolloverOptionAllOfTaxable)
                    {
                        LoadTotalRolloverAmount();
                        ldecRolloveramount = lobjRolloverItems.icdoPayeeAccountPaymentItemType.amount - idecTotalTaxableRolledOverAmount;
                    }
                }
                else
                {
                    if (lbusPayeeAccountRolloverDetail.icdoPayeeAccountRolloverDetail.rollover_option_value == busConstant.PayeeAccountRolloverOptionAllOfGross)
                    {
                        ldecRolloveramount = lobjRolloverItems.icdoPayeeAccountPaymentItemType.amount;
                    }
                }

                if (ldecRolloveramount > 0)
                {
                    //int intpayee_account_payment_item_type_id = 0;
                    string astritemCode = string.Empty;
                    decimal ldecamount = 0.00m;

                    if (idtNextBenefitPaymentDate == null)
                        LoadNextBenefitPaymentDate();

                    if (lobjRolloverItems.ibusPaymentItemType.icdoPaymentItemType.taxable_item_flag == busConstant.Flag_Yes &&
                        lbusPayeeAccountRolloverDetail.icdoPayeeAccountRolloverDetail.rollover_option_value != busConstant.PayeeAccountRolloverOptionDollorOfGross) // Rollover taxable Amount
                    {
                        astritemCode = lobjRolloverItems.ibusPaymentItemType.icdoPaymentItemType.item_type_code;
                        ldecamount = ldecRolloveramount;
                    }
                    else
                    {
                        astritemCode = lobjRolloverItems.ibusPaymentItemType.icdoPaymentItemType.item_type_code;
                        ldecamount = ldecRolloveramount;
                    }

                    if (lbusPayeeAccountRolloverDetail.icdoPayeeAccountRolloverDetail.rollover_option_value == busConstant.PayeeAccountRolloverOptionDollorOfGross)
                    {
                        lobjRolloverItems.icdoPayeeAccountPaymentItemType.payee_account_payment_item_type_id = CreatePayeeAccountPaymentItemType(lobjRolloverItems.ibusPaymentItemType.icdoPaymentItemType.item_type_code,
                        ldecRolloveramount, lbusPayeeAccountRolloverDetail.icdoPayeeAccountRolloverDetail.account_number, 0, idtNextBenefitPaymentDate,
                        DateTime.MinValue, istrReissueFlag, true);

                        if (lobjRolloverItems.icdoPayeeAccountPaymentItemType.payee_account_payment_item_type_id > 0)
                        {
                            lbusPayeeAccountRolloverDetail.InsertIntoRolloverItemDetail(lobjRolloverItems);
                        }

                        if (ldecRemainingDollorOfGrossAmt > 0)
                        {
                            if (this.icdoPayeeAccount.istrBenefitOption == busConstant.LUMP_SUM_DESCRIPTION)
                                astritemCode = busConstant.ITEM26;
                            else
                                astritemCode = busConstant.ITEM6;

                            lobjRolloverItems.icdoPayeeAccountPaymentItemType.payee_account_payment_item_type_id = CreatePayeeAccountPaymentItemType(astritemCode,
                            ldecRemainingDollorOfGrossAmt, lbusPayeeAccountRolloverDetail.icdoPayeeAccountRolloverDetail.account_number, 0, idtNextBenefitPaymentDate,
                            DateTime.MinValue, istrReissueFlag, true);
                            if (lobjRolloverItems.icdoPayeeAccountPaymentItemType.payee_account_payment_item_type_id > 0)
                            {
                                lbusPayeeAccountRolloverDetail.InsertIntoRolloverItemDetail(lobjRolloverItems);
                            }
                        }

                    }
                    if (lbusPayeeAccountRolloverDetail.icdoPayeeAccountRolloverDetail.rollover_option_value != busConstant.PayeeAccountRolloverOptionDollorOfGross)
                    {
                        // For Inserting Rollover Item detail and payee account payment item type
                        lobjRolloverItems.icdoPayeeAccountPaymentItemType.payee_account_payment_item_type_id = CreatePayeeAccountPaymentItemType(astritemCode,
                        ldecRolloveramount, lbusPayeeAccountRolloverDetail.icdoPayeeAccountRolloverDetail.account_number, 0, idtNextBenefitPaymentDate,
                        DateTime.MinValue, istrReissueFlag, true);
                        if (lobjRolloverItems.icdoPayeeAccountPaymentItemType.payee_account_payment_item_type_id > 0)
                        {
                            lbusPayeeAccountRolloverDetail.InsertIntoRolloverItemDetail(lobjRolloverItems);
                        }
                    }

                }
            }
            ProcessTaxWithHoldingDetails();
        }

        private void LoadRolloverItems(Collection<busPayeeAccountPaymentItemType> aclbRolloverItems, busPayeeAccountPaymentItemType aobjPaymentItemType, busPayeeAccountRolloverDetail lbusPayeeAccountRolloverDetail)
        {
            bool lblnItemExists = false;
            if (aobjPaymentItemType.ibusPaymentItemType == null)
                aobjPaymentItemType.LoadPaymentItemType();
            busPayeeAccountPaymentItemType lobjRolloverItem = new busPayeeAccountPaymentItemType();

            if (aclbRolloverItems.Count == 0)
            {
                GroupRolloverItems(aobjPaymentItemType, lobjRolloverItem, lbusPayeeAccountRolloverDetail);
                aclbRolloverItems.Add(lobjRolloverItem);
            }
            else
            {
                foreach (busPayeeAccountPaymentItemType lobjRolloverItems in aclbRolloverItems)
                {
                    if (aobjPaymentItemType.ibusPaymentItemType.icdoPaymentItemType.rollover_item_code
                            == lobjRolloverItems.ibusPaymentItemType.icdoPaymentItemType.item_type_code)
                    {
                        GroupRolloverItems(aobjPaymentItemType, lobjRolloverItems, lbusPayeeAccountRolloverDetail);
                        lblnItemExists = true;
                        break;
                    }
                }
                if (!lblnItemExists)
                {
                    GroupRolloverItems(aobjPaymentItemType, lobjRolloverItem, lbusPayeeAccountRolloverDetail);
                    aclbRolloverItems.Add(lobjRolloverItem);
                }
            }
        }

        private void GroupRolloverItems(busPayeeAccountPaymentItemType aobjRolloverFromItem, busPayeeAccountPaymentItemType aobjRolloverToItem, busPayeeAccountRolloverDetail lbusPayeeAccountRolloverDetail)
        {
            //if (aobjRolloverToItem.icdoPayeeAccountPaymentItemType == null)
            aobjRolloverToItem.icdoPayeeAccountPaymentItemType = new cdoPayeeAccountPaymentItemType();
            //Find the Rollover items from the existing payment item types
            if (aobjRolloverToItem.ibusPaymentItemType == null)
            {
                aobjRolloverToItem.ibusPaymentItemType = new busPaymentItemType();
            }
            aobjRolloverToItem.ibusPaymentItemType.FindPaymentItemTypeByItemCode(aobjRolloverFromItem.ibusPaymentItemType.icdoPaymentItemType.rollover_item_code);
            aobjRolloverToItem.icdoPayeeAccountPaymentItemType.payment_item_type_id = aobjRolloverToItem.ibusPaymentItemType.icdoPaymentItemType.payment_item_type_id;
            //If All of Gross or All of Taxable option is selected , for each item type and accumulate it and multiply by item_direction 
            aobjRolloverToItem.icdoPayeeAccountPaymentItemType.payee_account_id = aobjRolloverFromItem.icdoPayeeAccountPaymentItemType.payee_account_id;

            if ((lbusPayeeAccountRolloverDetail.icdoPayeeAccountRolloverDetail.rollover_option_value == busConstant.PayeeAccountRolloverOptionAllOfGross) ||
                (lbusPayeeAccountRolloverDetail.icdoPayeeAccountRolloverDetail.rollover_option_value == busConstant.PayeeAccountRolloverOptionAllOfTaxable) ||
                (lbusPayeeAccountRolloverDetail.icdoPayeeAccountRolloverDetail.rollover_option_value == busConstant.PayeeAccountRolloverOptionDollorOfGross))
            {
                aobjRolloverToItem.icdoPayeeAccountPaymentItemType.amount += aobjRolloverFromItem.icdoPayeeAccountPaymentItemType.amount * aobjRolloverFromItem.ibusPaymentItemType.icdoPaymentItemType.item_type_direction;
            }
            //If % of taxable is selected
            else if (lbusPayeeAccountRolloverDetail.icdoPayeeAccountRolloverDetail.rollover_option_value == busConstant.PayeeAccountRolloverOptionPercentageOfTaxable)
            {
                if ((aobjRolloverFromItem.icdoPayeeAccountPaymentItemType.amount > 0.00M) && (lbusPayeeAccountRolloverDetail.icdoPayeeAccountRolloverDetail.percent_of_taxable > 0.00M))
                {
                    aobjRolloverToItem.icdoPayeeAccountPaymentItemType.amount += aobjRolloverFromItem.icdoPayeeAccountPaymentItemType.amount * aobjRolloverFromItem.ibusPaymentItemType.icdoPaymentItemType.item_type_direction;
                }
            }
            //If $ of taxable Amount is selected 
            else if (lbusPayeeAccountRolloverDetail.icdoPayeeAccountRolloverDetail.rollover_option_value == busConstant.PayeeAccountRolloverOptionAmountOfTaxable)
            {
                aobjRolloverToItem.icdoPayeeAccountPaymentItemType.amount = lbusPayeeAccountRolloverDetail.icdoPayeeAccountRolloverDetail.amount;
            }
        }
        public void ChangeContactName()
        {
            foreach (busPayeeAccountRolloverDetail lobjRolloverDetail in iclbPayeeAccountRolloverDetail)
            {
                if (lobjRolloverDetail.icdoPayeeAccountRolloverDetail.status_value
                            == busConstant.PayeeAccountRolloverDetailStatusActive)
                {
                    if (lobjRolloverDetail.icdoPayeeAccountRolloverDetail.send_to_participant != "Y")
                    {
                        if (lobjRolloverDetail.icdoPayeeAccountRolloverDetail.contact_name.IsNotNullOrEmpty())
                        {
                            if (!(lobjRolloverDetail.icdoPayeeAccountRolloverDetail.contact_name.Contains("ATTN")))
                            {
                                lobjRolloverDetail.icdoPayeeAccountRolloverDetail.contact_name = "ATTN: " + lobjRolloverDetail.icdoPayeeAccountRolloverDetail.contact_name.Trim();

                            }
                        }
                    }
                }
            }
        }
        public void LoadActiveRolloverDetail()
        {
            if (iclbPayeeAccountRolloverDetail == null)
            {
                LoadPayeeAccountRolloverDetails();
            }

            iclbActiveRolloverDetails = new Collection<busPayeeAccountRolloverDetail>();
            Collection<busPayeeAccountRolloverDetail> lclbRolloverOptionAllOfGross = new Collection<busPayeeAccountRolloverDetail>();

            foreach (busPayeeAccountRolloverDetail lobjRolloverDetail in iclbPayeeAccountRolloverDetail)
            {
                if (lobjRolloverDetail.icdoPayeeAccountRolloverDetail.status_value
                            == busConstant.PayeeAccountRolloverDetailStatusActive)
                {
                    if (lobjRolloverDetail.icdoPayeeAccountRolloverDetail.rollover_option_value == busConstant.PayeeAccountRolloverOptionAllOfGross)
                    {
                        lclbRolloverOptionAllOfGross.Add(lobjRolloverDetail);
                    }
                    else
                    {
                        //Take only the details which are active
                        iclbActiveRolloverDetails.Add(lobjRolloverDetail);
                    }
                }
            }

            foreach (busPayeeAccountRolloverDetail lobjRolloverDetail in lclbRolloverOptionAllOfGross)
            {
                iclbActiveRolloverDetails.Add(lobjRolloverDetail);
            }
        }

        private decimal GetRolloverAmount(busPayeeAccountPaymentItemType lobjRolloverItems, busPayeeAccountRolloverDetail lbusPayeeAccountRolloverDetail)
        {
            decimal ldecRolloveramount = 0.00m;
            if (iclbActiveRolloverDetails == null)
                LoadActiveRolloverDetail();
            // (busPayeeAccountRolloverDetail lobjPayeeAccountRolloverDetail in iclbPayeeAccountRolloverDetail)
            //{
            int lintActivePercentageRolloverDetail = iclbActiveRolloverDetails.Where(o => o.icdoPayeeAccountRolloverDetail.payee_account_rollover_detail_id
                != lbusPayeeAccountRolloverDetail.icdoPayeeAccountRolloverDetail.payee_account_rollover_detail_id && o.icdoPayeeAccountRolloverDetail.rollover_option_value == busConstant.PayeeAccountRolloverOptionPercentageOfTaxable).Count();
            int lintActiveAmountRolloverDetail = iclbActiveRolloverDetails.Where(o => o.icdoPayeeAccountRolloverDetail.payee_account_rollover_detail_id
               != lbusPayeeAccountRolloverDetail.icdoPayeeAccountRolloverDetail.payee_account_rollover_detail_id && o.icdoPayeeAccountRolloverDetail.rollover_option_value == busConstant.PayeeAccountRolloverOptionAmountOfTaxable).Count();
            decimal ldecActivePercentageRolloverDetail = iclbActiveRolloverDetails.Where(o => o.icdoPayeeAccountRolloverDetail.payee_account_rollover_detail_id
                != lbusPayeeAccountRolloverDetail.icdoPayeeAccountRolloverDetail.payee_account_rollover_detail_id && o.icdoPayeeAccountRolloverDetail.rollover_option_value == busConstant.PayeeAccountRolloverOptionPercentageOfTaxable)
                .Select(o => o.icdoPayeeAccountRolloverDetail.percent_of_taxable).FirstOrDefault();
            LoadTotalRolloverAmount();
            if (lbusPayeeAccountRolloverDetail.icdoPayeeAccountRolloverDetail.rollover_option_value == busConstant.PayeeAccountRolloverOptionPercentageOfTaxable) // % of Taxable Amount
            {
                if (lintActivePercentageRolloverDetail > 0)
                {


                    if (idecTotalTaxableRolledOverAmount > 0.0m && (ldecActivePercentageRolloverDetail + lbusPayeeAccountRolloverDetail.icdoPayeeAccountRolloverDetail.percent_of_taxable) == 100)
                        ldecRolloveramount = lobjRolloverItems.icdoPayeeAccountPaymentItemType.amount - idecTotalTaxableRolledOverAmount;
                    else
                        ldecRolloveramount = ((lobjRolloverItems.icdoPayeeAccountPaymentItemType.amount - idecTotalTaxableRolledOverAmount) * lbusPayeeAccountRolloverDetail.icdoPayeeAccountRolloverDetail.percent_of_taxable) / 100;
                }
                else
                {
                    if (lintActiveAmountRolloverDetail > 0)
                    {

                        ldecRolloveramount = ((lobjRolloverItems.icdoPayeeAccountPaymentItemType.amount - idecTotalTaxableRolledOverAmount) * lbusPayeeAccountRolloverDetail.icdoPayeeAccountRolloverDetail.percent_of_taxable) / 100;
                    }
                    else
                    {
                        ldecRolloveramount = ((lobjRolloverItems.icdoPayeeAccountPaymentItemType.amount - idecTotalTaxableRolledOverAmount) * lbusPayeeAccountRolloverDetail.icdoPayeeAccountRolloverDetail.percent_of_taxable) / 100;
                    }
                }
            }
            if (lbusPayeeAccountRolloverDetail.icdoPayeeAccountRolloverDetail.rollover_option_value == busConstant.PayeeAccountRolloverOptionAmountOfTaxable) // $ of Taxable Amount
            {
                ldecRolloveramount = ((lobjRolloverItems.icdoPayeeAccountPaymentItemType.amount - idecTotalTaxableRolledOverAmount) * lbusPayeeAccountRolloverDetail.icdoPayeeAccountRolloverDetail.percent_of_taxable) / 100;
            }

            //}
            return ldecRolloveramount;
        }
        #region Load Payement Breakdown
        public void LoadBreakDownDetails(int aintPaymentHistoryHeaderID = 0)
        {
            decimal idecRemainingPercentage = 100M;
            if (aintPaymentHistoryHeaderID == 0)
                LoadPayeeAccountPaymentItemType();
            else
                LoadPayeeAccountPaymentItemTypeFromPaymentHistoryDetail(aintPaymentHistoryHeaderID);
            if (iclbWithholdingInformation == null)
            {
                LoadWithholdingInformation();
            }
            // PIR-391
            busWithholdingInformation lbusWithholdingInformation = (from item in iclbWithholdingInformation
                                                                    where busGlobalFunctions.CheckDateOverlapping(idtNextBenefitPaymentDate,
                                                                    item.icdoWithholdingInformation.withholding_date_from, item.icdoWithholdingInformation.withholding_date_to)
                                                                    && item.icdoWithholdingInformation.withholding_date_from != item.icdoWithholdingInformation.withholding_date_to
                                                                    select item).FirstOrDefault();

            if (lbusWithholdingInformation != null && aintPaymentHistoryHeaderID == 0) //PIR 1071
            {
                if (lbusWithholdingInformation.icdoWithholdingInformation.withholding_percentage != null)
                    idecRemainingPercentage = (idecRemainingPercentage - lbusWithholdingInformation.icdoWithholdingInformation.withholding_percentage) / 100M;

                //PIR 990
                idecWithholdingPercentage = 0;
                if (lbusWithholdingInformation.icdoWithholdingInformation.withholding_percentage != null)
                    idecWithholdingPercentage = lbusWithholdingInformation.icdoWithholdingInformation.withholding_percentage;
            }
            else
            {
                idecRemainingPercentage = 1M;
            }
            // Active Payee Account Payment Item type
            iclbPayeeAccountPaymentItemTypeActive = (from item in this.iclbPayeeAccountPaymentItemType
                                                     where busGlobalFunctions.CheckDateOverlapping(idtNextBenefitPaymentDate,
                                                     item.icdoPayeeAccountPaymentItemType.start_date, item.icdoPayeeAccountPaymentItemType.end_date)
                                                     select item).ToList().ToCollection<busPayeeAccountPaymentItemType>();
            istrPayeeBreakDownChequeAChHeader = "Check";
            if (iclbPayeeAccountAchDetail != null)
            {
                iclbPayeeAccountAchDetail = (from item in this.iclbPayeeAccountAchDetail
                                             where busGlobalFunctions.CheckDateOverlapping(idtNextBenefitPaymentDate,
                                             item.icdoPayeeAccountAchDetail.ach_start_date, item.icdoPayeeAccountAchDetail.ach_end_date)
                                             && item.icdoPayeeAccountAchDetail.pre_note_flag != busConstant.FLAG_YES
                                             && item.icdoPayeeAccountAchDetail.pre_note_completion_date != DateTime.MinValue
                                             select item).ToList().ToCollection<busPayeeAccountAchDetail>();
                if (iclbPayeeAccountAchDetail.Count > 0)
                {
                    istrPayeeBreakDownChequeAChHeader = "ACH";
                }
            }
            idecRetroSpkAmount = GetPayeeAccountRetroPaymentForPaymentItemTypeCode(busConstant.ITEM2, iclbPayeeAccountPaymentItemTypeActive, busConstant.PAYMENT_OPTION_SPECIAL_CHECK) + GetPayeeAccountRetroPaymentForPaymentItemTypeCode(busConstant.ITEM1, iclbPayeeAccountPaymentItemTypeActive, busConstant.PAYMENT_OPTION_SPECIAL_CHECK);


            idecFederalTaxWithHolding = (from obj in iclbPayeeAccountPaymentItemTypeActive.AsEnumerable()
                                         where obj.ibusPaymentItemType.icdoPaymentItemType.payee_detail_group_value == "FEDX"
                                         //obj.ibusPaymentItemType.icdoPaymentItemType.item_type_code == busConstant.ITEM13
                                         select (obj.icdoPayeeAccountPaymentItemType.amount * idecRemainingPercentage).RoundToTwoDecimalPoints() * obj.ibusPaymentItemType.icdoPaymentItemType.item_type_direction).Sum();//PIR 994

            idecCorrFederalTaxWithHolding = Math.Abs(idecFederalTaxWithHolding);

            idecStateTaxWithHolding = (from obj in iclbPayeeAccountPaymentItemTypeActive.AsEnumerable()
                                       where obj.ibusPaymentItemType.icdoPaymentItemType.payee_detail_group_value == "STTX"
                                       //obj.ibusPaymentItemType.icdoPaymentItemType.item_type_code == busConstant.ITEM14
                                       select (obj.icdoPayeeAccountPaymentItemType.amount * idecRemainingPercentage).RoundToTwoDecimalPoints() * obj.ibusPaymentItemType.icdoPaymentItemType.item_type_direction).Sum();//PIR 994

            idecCorrStateTaxWithHolding = Math.Abs(idecStateTaxWithHolding);

            idecDeduction = (from obj in iclbPayeeAccountPaymentItemTypeActive.AsEnumerable()
                             where (obj.ibusPaymentItemType.icdoPaymentItemType.payee_detail_group_value != "FEDX"
                             && obj.ibusPaymentItemType.icdoPaymentItemType.payee_detail_group_value != "STTX")
                             && obj.ibusPaymentItemType.icdoPaymentItemType.item_type_direction == -1
                             && obj.ibusPaymentItemType.icdoPaymentItemType.allow_rollover_code_value != "RRED"
                             && obj.ibusPaymentItemType.icdoPaymentItemType.item_type_code != busConstant.ITEM53
                             select (obj.icdoPayeeAccountPaymentItemType.amount * idecRemainingPercentage).RoundToTwoDecimalPoints() * obj.ibusPaymentItemType.icdoPaymentItemType.item_type_direction).Sum();//PIR 994
            idecNextGrossPaymentACH = ((from obj in iclbPayeeAccountPaymentItemTypeActive.AsEnumerable()
                                        where (obj.ibusPaymentItemType.icdoPaymentItemType.base_amount_flag == busConstant.FLAG_YES
                                        && obj.ibusPaymentItemType.icdoPaymentItemType.item_type_direction == 1)
                                        || obj.ibusPaymentItemType.icdoPaymentItemType.item_type_code == busConstant.ITEM21
                                       || obj.ibusPaymentItemType.icdoPaymentItemType.item_type_code == busConstant.ITEM22
                                       || obj.ibusPaymentItemType.icdoPaymentItemType.item_type_code == busConstant.ITEM48
                                        select (obj.icdoPayeeAccountPaymentItemType.amount * idecRemainingPercentage).RoundToTwoDecimalPoints()).Sum()//PIR 994
                                       +
                                       (from obj in iclbPayeeAccountPaymentItemTypeActive.AsEnumerable()
                                        where
                                         obj.ibusPaymentItemType.icdoPaymentItemType.allow_rollover_code_value == "RRED"
                                        select (obj.icdoPayeeAccountPaymentItemType.amount * idecRemainingPercentage).RoundToTwoDecimalPoints() * obj.ibusPaymentItemType.icdoPaymentItemType.item_type_direction).Sum());//PIR 994
            if (idecNextGrossPaymentACH < 0)
                idecNextGrossPaymentACH = 0;

            idecNextNetPaymentACH = ((from obj in iclbPayeeAccountPaymentItemTypeActive.AsEnumerable()
                                      select (obj.icdoPayeeAccountPaymentItemType.amount * idecRemainingPercentage).RoundToTwoDecimalPoints() * obj.ibusPaymentItemType.icdoPaymentItemType.item_type_direction).Sum() - (idecRetroSpkAmount * idecRemainingPercentage).RoundToTwoDecimalPoints());//PIR 994
            if (idecNextNetPaymentACH < 0)
                idecNextNetPaymentACH = 0;
            idecRetroAdjustmentAmount = (GetPayeeAccountRetroPaymentForPaymentItemTypeCode(busConstant.ITEM2, iclbPayeeAccountPaymentItemTypeActive, busConstant.PAYMENT_OPTION_REGULAR) + GetPayeeAccountRetroPaymentForPaymentItemTypeCode(busConstant.ITEM1, iclbPayeeAccountPaymentItemTypeActive, busConstant.PAYMENT_OPTION_REGULAR)) * idecRemainingPercentage;
            idecNextGrossPaymentRollOver = ((from obj in iclbPayeeAccountPaymentItemTypeActive.AsEnumerable()
                                             where obj.ibusPaymentItemType.icdoPaymentItemType.allow_rollover_code_value == busConstant.RolloverItemReductionCheck
                                             select (obj.icdoPayeeAccountPaymentItemType.amount * idecRemainingPercentage).RoundToTwoDecimalPoints()).Sum());//PIR 994


            idecNextNetPaymentRollOver = ((from obj in iclbPayeeAccountPaymentItemTypeActive.AsEnumerable()
                                           where obj.ibusPaymentItemType.icdoPaymentItemType.allow_rollover_code_value == busConstant.RolloverItemReductionCheck
                                           select (obj.icdoPayeeAccountPaymentItemType.amount * idecRemainingPercentage).RoundToTwoDecimalPoints()).Sum());//PIR 994

            idecNextMonthTaxable = ((from obj in iclbPayeeAccountPaymentItemTypeActive.AsEnumerable()
                                     where obj.ibusPaymentItemType.icdoPaymentItemType.item_type_code == busConstant.ITEM1 ||
                                     obj.ibusPaymentItemType.icdoPaymentItemType.item_type_code == busConstant.ITEM21 ||
                                     obj.ibusPaymentItemType.icdoPaymentItemType.item_type_code == busConstant.ITEM48
                                     select (obj.icdoPayeeAccountPaymentItemType.amount * idecRemainingPercentage).RoundToTwoDecimalPoints()).Sum() + (GetPayeeAccountRetroPaymentForPaymentItemTypeCode(busConstant.ITEM1, iclbPayeeAccountPaymentItemTypeActive, busConstant.PAYMENT_OPTION_REGULAR) * idecRemainingPercentage).RoundToTwoDecimalPoints()
                                    +
                                       (from obj in iclbPayeeAccountPaymentItemTypeActive.AsEnumerable()
                                        where
                                         obj.ibusPaymentItemType.icdoPaymentItemType.allow_rollover_code_value == "RRED" && obj.ibusPaymentItemType.icdoPaymentItemType.taxable_item_flag == busConstant.Flag_Yes
                                        select (obj.icdoPayeeAccountPaymentItemType.amount * idecRemainingPercentage).RoundToTwoDecimalPoints() * obj.ibusPaymentItemType.icdoPaymentItemType.item_type_direction).Sum())//PIR 994
                                    ;
            idecNextMonthNonTaxable = ((from obj in iclbPayeeAccountPaymentItemTypeActive.AsEnumerable()
                                        where obj.ibusPaymentItemType.icdoPaymentItemType.item_type_code == busConstant.ITEM2 || obj.ibusPaymentItemType.icdoPaymentItemType.item_type_code == busConstant.ITEM22
                                        select (obj.icdoPayeeAccountPaymentItemType.amount * idecRemainingPercentage).RoundToTwoDecimalPoints()).Sum() + (GetPayeeAccountRetroPaymentForPaymentItemTypeCode(busConstant.ITEM2, iclbPayeeAccountPaymentItemTypeActive, busConstant.PAYMENT_OPTION_REGULAR) * idecRemainingPercentage).RoundToTwoDecimalPoints()
                                       +
                                        (from obj in iclbPayeeAccountPaymentItemTypeActive.AsEnumerable()
                                         where obj.ibusPaymentItemType.icdoPaymentItemType.allow_rollover_code_value == "RRED" && obj.ibusPaymentItemType.icdoPaymentItemType.taxable_item_flag == busConstant.FLAG_NO
                                         select (obj.icdoPayeeAccountPaymentItemType.amount * idecRemainingPercentage).RoundToTwoDecimalPoints() * obj.ibusPaymentItemType.icdoPaymentItemType.item_type_direction).Sum());//PIR 994


            idecPensionReceivable = ((from obj in iclbPayeeAccountPaymentItemTypeActive.AsEnumerable()
                                      where obj.ibusPaymentItemType.icdoPaymentItemType.item_type_code == busConstant.ITEM53
                                      select (obj.icdoPayeeAccountPaymentItemType.amount * idecRemainingPercentage).RoundToTwoDecimalPoints() * obj.ibusPaymentItemType.icdoPaymentItemType.item_type_direction).Sum());//PIR 994


            idecGrossAmountAfterRollover = idecGrossAmount - idecNextGrossPaymentRollOver;

            idecIndividualAccPlanBalance = idecNextNetPaymentRollOver + idecNextMonthTaxable;


            //idtLastBenefitPaymentDate = busPayeeAccountHelper.GetLastBenefitPaymentDate(this.icdoPayeeAccount.iintPlanId);
            //string astrScheduleType = string.Empty;
            //if (this.icdoPayeeAccount.iintPlanId == busConstant.IAP_PLAN_ID)
            //    astrScheduleType = busConstant.PaymentScheduleScheduleTypeWeekly;
            //else
            //    astrScheduleType = busConstant.PaymentScheduleScheduleTypeMonthly;

            //DataTable ldtbGrossBenefitAmount = busBase.Select("cdoPaymentSchedule.GetGrossBenefitAmount", new object[3] { idtLastBenefitPaymentDate, icdoPayeeAccount.payee_account_id, astrScheduleType });
            //if (ldtbGrossBenefitAmount.Rows.Count > 0)
            //{
            //    idecGrossBenefitAmount = Convert.ToDecimal(ldtbGrossBenefitAmount.Rows[0]["GROSS_BENEFIT_AMOUNT"]);

            //}
            //For History Header Maint....
            idecPaymentHistoryDetailGrossAmount = (from obj in iclbPayeeAccountPaymentItemTypeActive.AsEnumerable()
                                                   where obj.ibusPaymentItemType.icdoPaymentItemType.item_type_direction == 1
                                                   select obj.icdoPayeeAccountPaymentItemType.amount).Sum();
            idecPaymentHistoryDetailGrossAmountAfterRollover = idecPaymentHistoryDetailGrossAmount - idecNextGrossPaymentRollOver;

            idecRetroSpkFederalTaxWithHolding = (from obj in iclbPayeeAccountPaymentItemTypeActive.AsEnumerable()
                                                 where obj.ibusPaymentItemType.icdoPaymentItemType.payee_detail_group_value == "FEDX" && (obj.ibusPaymentItemType.icdoPaymentItemType.item_type_code == busConstant.ITEM35 || obj.ibusPaymentItemType.icdoPaymentItemType.item_type_code == busConstant.ITEM39) //rid 81331
                                                 //obj.ibusPaymentItemType.icdoPaymentItemType.item_type_code == busConstant.ITEM13
                                                 select (obj.icdoPayeeAccountPaymentItemType.amount * idecRemainingPercentage).RoundToTwoDecimalPoints() * obj.ibusPaymentItemType.icdoPaymentItemType.item_type_direction).Sum();

            idecRetroSpkStateTaxWithHolding = (from obj in iclbPayeeAccountPaymentItemTypeActive.AsEnumerable()
                                               where obj.ibusPaymentItemType.icdoPaymentItemType.payee_detail_group_value == "STTX" && (obj.ibusPaymentItemType.icdoPaymentItemType.item_type_code == busConstant.ITEM36 || obj.ibusPaymentItemType.icdoPaymentItemType.item_type_code == busConstant.ITEM40) //rid 81331
                                               //obj.ibusPaymentItemType.icdoPaymentItemType.item_type_code == busConstant.ITEM14
                                               select (obj.icdoPayeeAccountPaymentItemType.amount * idecRemainingPercentage).RoundToTwoDecimalPoints() * obj.ibusPaymentItemType.icdoPaymentItemType.item_type_direction).Sum();

            idecRetroSpkNextGrossPaymentACH = ((from obj in iclbPayeeAccountPaymentItemTypeActive.AsEnumerable()
                                                where (obj.ibusPaymentItemType.icdoPaymentItemType.base_amount_flag == busConstant.FLAG_YES
                                                && obj.ibusPaymentItemType.icdoPaymentItemType.item_type_direction == 1 && (obj.ibusPaymentItemType.icdoPaymentItemType.item_type_code == busConstant.ITEM29 || obj.ibusPaymentItemType.icdoPaymentItemType.item_type_code == busConstant.ITEM30))
                                                select (obj.icdoPayeeAccountPaymentItemType.amount * idecRemainingPercentage).RoundToTwoDecimalPoints()).Sum()
                                              );

            if (idecRetroSpkNextGrossPaymentACH < 0)
                idecRetroSpkNextGrossPaymentACH = 0;

            idecRetroSpkNextNetPaymentACH = ((from obj in iclbPayeeAccountPaymentItemTypeActive.AsEnumerable()
                                              where obj.ibusPaymentItemType.icdoPaymentItemType.item_type_code == busConstant.ITEM29 ||
                                                    obj.ibusPaymentItemType.icdoPaymentItemType.item_type_code == busConstant.ITEM30 ||
                                                    obj.ibusPaymentItemType.icdoPaymentItemType.item_type_code == busConstant.ITEM35 ||
                                                    obj.ibusPaymentItemType.icdoPaymentItemType.item_type_code == busConstant.ITEM36 ||
                                                    obj.ibusPaymentItemType.icdoPaymentItemType.item_type_code == busConstant.ITEM39 ||    //rid 81331
                                                    obj.ibusPaymentItemType.icdoPaymentItemType.item_type_code == busConstant.ITEM40       //rid 81331
                                              select (obj.icdoPayeeAccountPaymentItemType.amount * idecRemainingPercentage).RoundToTwoDecimalPoints() * obj.ibusPaymentItemType.icdoPaymentItemType.item_type_direction).Sum());

            if (idecRetroSpkNextNetPaymentACH < 0)
                idecRetroSpkNextNetPaymentACH = 0;

            //10 Percent
            if (icdoPayeeAccount.benefit_account_type_value == busConstant.BENEFIT_TYPE_RETIREMENT || icdoPayeeAccount.benefit_account_type_value == busConstant.BENEFIT_TYPE_DISABILITY)
            {
                DataTable ldtbList = Select("cdoDroApplication.LoadAllExistingQDRO", new object[1] { this.icdoPayeeAccount.person_id });
                if (ldtbList != null && ldtbList.Rows.Count > 0)
                {
                    istrMoreInformation += Convert.ToString(istrMoreInformation).IsNullOrEmpty() ? "QDRO On File." : " QDRO On File.";
                }
            }

            //rid-69692
            idecTotalAmount = idecNextGrossPaymentACH + idecRetroAdjustmentAmount;
        }
        public decimal GetPayeeAccountRetroPaymentForPaymentItemTypeCode(string item_type_code, Collection<busPayeeAccountPaymentItemType> iclbPayeeAccountPaymentItemTypeActive, string PaymentOption)
        {
            if (iclbRetroItemType == null)
            {
                this.LoadRetroItemType();
            }
            decimal RetroSum = (from obj in iclbPayeeAccountPaymentItemTypeActive.AsEnumerable()
                                where obj.ibusPaymentItemType.icdoPaymentItemType.item_type_code ==
                                (iclbRetroItemType.Where(item => item.icdoRetroItemType.from_item_type == item_type_code &&
                 item.icdoRetroItemType.payment_option_value == PaymentOption).First().icdoRetroItemType.to_item_type)
                                select obj.icdoPayeeAccountPaymentItemType.amount).Sum();
            return RetroSum;
        }
        #endregion

        public void LoadTaxableAmountForVariableTax()
        {
            if (idtNextBenefitPaymentDate == DateTime.MinValue)
                LoadNextBenefitPaymentDate();
            LoadTaxableAmountForVariableTax(idtNextBenefitPaymentDate);
        }

        /// <summary>
        /// Payee Account Participant : Check Death Notification 
        /// </summary>
        /// <returns></returns>
        /// 
        public void LoadDeathNotificationStatus()
        {
            if (icdoPayeeAccount.person_id != 0)
            {
                ibusPayee = new busPerson { icdoPerson = new cdoPerson() };
                ibusPayee.FindPerson(this.icdoPayeeAccount.person_id);

                Collection<busDeathNotification> lclbDeathNotifications = new Collection<busDeathNotification>();
                DataTable ldtblist = busPerson.Select("cdoPerson.LoadDeathNotificationDetails", new object[1] { ibusPayee.icdoPerson.person_id });
                lclbDeathNotifications = GetCollection<busDeathNotification>(ldtblist, "icdoDeathNotification");

                if ((lclbDeathNotifications != null && lclbDeathNotifications.Count > 0 &&
                        lclbDeathNotifications.Where(t => t.icdoDeathNotification.death_notification_status_value == busConstant.NOTIFICATION_STATUS_CERTIFIED).Count() > 0
                       && ibusPayee.icdoPerson.date_of_death != DateTime.MinValue) || (lclbDeathNotifications.Count == 0 && ibusPayee.icdoPerson.date_of_death != DateTime.MinValue))
                {
                    icdoPayeeAccount.istrDeathNotificationStatus = "CRTF";
                }
            }
        }

        public ArrayList ReCalculateBenefitForPostRetirement()
        {
            // utlError lobjError = null;

            if (this.iarrErrors.IsNull())
                this.iarrErrors = new ArrayList();

            string lstrBeneficiaryTypeValue = string.Empty;
            string lstrSurvivorRelationship = string.Empty;
            decimal ldecSurvivorPercent = busConstant.ZERO_DECIMAL;


            busPayeeAccount lbusParticipantsPayeeAccount = null;
            DataTable ldtblRefPayeeAccountId = Select("cdoPayeeAccount.GetRefPayeeAccountId", new object[2] {this.icdoPayeeAccount.payee_account_id,
            this.ibusPayeeBenefitAccount.icdoPayeeBenefitAccount.person_id});
            if (ldtblRefPayeeAccountId.Rows.Count > 0)
            {
                lbusParticipantsPayeeAccount = new busPayeeAccount { icdoPayeeAccount = new cdoPayeeAccount() };
                lbusParticipantsPayeeAccount.FindPayeeAccount(Convert.ToInt32(ldtblRefPayeeAccountId.Rows[0][0]));


                string lstrBenefitOptionValue = string.Empty;
                busBenefitCalculationHeader lbusParticipantsBenefitCalculation = null;

                if (lbusParticipantsPayeeAccount != null)
                {
                    lbusParticipantsPayeeAccount.LoadBenefitDetails();

                    lstrBenefitOptionValue = lbusParticipantsPayeeAccount.icdoPayeeAccount.istrBenefitOptionValue;

                    if (lbusParticipantsPayeeAccount.icdoPayeeAccount.benefit_account_type_value == busConstant.BENEFIT_TYPE_RETIREMENT)
                    {
                        lbusParticipantsBenefitCalculation = lbusParticipantsPayeeAccount.ReCalculateBenefitForRetirement(lstrBenefitOptionValue, lblnDoInsert: false, ablnRefreshCalculationFinal: false, ablnPostRetDeath: true);
                    }
                    else if (lbusParticipantsPayeeAccount.icdoPayeeAccount.benefit_account_type_value == busConstant.BENEFIT_TYPE_DISABILITY)
                    {
                        lbusParticipantsBenefitCalculation = lbusParticipantsPayeeAccount.RecalculateParticipantDisabilityBenefits(lstrBenefitOptionValue, lblnDoInsert: false, ablnRefreshCalculationFinal: false);
                    }
                    else if (lbusParticipantsPayeeAccount.icdoPayeeAccount.benefit_account_type_value == busConstant.BENEFIT_TYPE_WITHDRAWAL)
                    {
                        lbusParticipantsBenefitCalculation = lbusParticipantsPayeeAccount.ReCalculateBenefitForWithdrawl(lblnDoInsert: false, ablnRefreshCalculationFinal: false);
                    }
                }

                DataTable ldtbBeneficiaryInformation = busBase.Select("cdoPersonAccountBeneficiary.GetBeneficairyInformation", new Object[3] { lbusParticipantsBenefitCalculation.icdoBenefitCalculationHeader.person_id,
                             lbusParticipantsPayeeAccount.icdoPayeeAccount.iintPlanId, this.icdoPayeeAccount.person_id  });


                if (ldtbBeneficiaryInformation.Rows.Count > 0 && lbusParticipantsBenefitCalculation != null && lbusParticipantsBenefitCalculation.iclbBenefitCalculationDetail != null
                    && lbusParticipantsBenefitCalculation.iclbBenefitCalculationDetail.Count > 0)
                {
                    lstrBeneficiaryTypeValue = Convert.ToString(ldtbBeneficiaryInformation.Rows[0][enmPersonAccountBeneficiary.beneficiary_type_value.ToString().ToUpper()]);
                    lstrSurvivorRelationship = Convert.ToString(ldtbBeneficiaryInformation.Rows[0][enmRelationship.relationship_value.ToString().ToUpper()]);
                    ldecSurvivorPercent = Convert.ToDecimal(ldtbBeneficiaryInformation.Rows[0][enmPersonAccountBeneficiary.dist_percent.ToString().ToUpper()]);
                    busBenefitApplication lbusBenefitApplication = new busBenefitApplication { icdoBenefitApplication = new cdoBenefitApplication() };
                    lbusBenefitApplication = lbusParticipantsBenefitCalculation.ibusBenefitApplication;

                    if (lstrBeneficiaryTypeValue == busConstant.BENEFICIARY_TYPE_PRIMARY)
                    {
                        if (this.icdoPayeeAccount.person_id > 0)
                        {
                            CreatePostRetirementCalculationForPrimaryBen(lbusParticipantsBenefitCalculation.iclbBenefitCalculationDetail.FirstOrDefault(),
                                lbusParticipantsBenefitCalculation.iclbBenefitCalculationDetail.FirstOrDefault().iclbBenefitCalculationOptions.FirstOrDefault(), lbusBenefitApplication, lbusParticipantsPayeeAccount, this.ibusParticipant, this.icdoPayeeAccount.person_id, 0,
                                                            busConstant.BENEFICIARY_TYPE_PRIMARY, lstrSurvivorRelationship, ldecSurvivorPercent, true, decimal.Zero);
                        }
                        else
                        {
                            CreatePostRetirementCalculationForPrimaryBen(lbusParticipantsBenefitCalculation.iclbBenefitCalculationDetail.FirstOrDefault(),
                                lbusParticipantsBenefitCalculation.iclbBenefitCalculationDetail.FirstOrDefault().iclbBenefitCalculationOptions.FirstOrDefault(), lbusBenefitApplication, lbusParticipantsPayeeAccount, this.ibusParticipant, 0, this.icdoPayeeAccount.org_id,
                                                            busConstant.BENEFICIARY_TYPE_PRIMARY, lstrSurvivorRelationship, ldecSurvivorPercent, true, decimal.Zero);
                        }
                    }
                    else
                    {
                        if (this.icdoPayeeAccount.person_id > 0)
                        {
                            CreatePostRetirementCalculationForContingentBen(lbusParticipantsBenefitCalculation.iclbBenefitCalculationDetail.FirstOrDefault(),
                                lbusParticipantsBenefitCalculation.iclbBenefitCalculationDetail.FirstOrDefault().iclbBenefitCalculationOptions.FirstOrDefault(), lbusBenefitApplication, lbusParticipantsPayeeAccount, this.ibusParticipant, this.icdoPayeeAccount.person_id, 0,
                                                      busConstant.BENEFICIARY_TYPE_CONTINGENT, lstrSurvivorRelationship, ldecSurvivorPercent, true, decimal.Zero);
                        }
                        else
                        {
                            CreatePostRetirementCalculationForContingentBen(lbusParticipantsBenefitCalculation.iclbBenefitCalculationDetail.FirstOrDefault(),
                                lbusParticipantsBenefitCalculation.iclbBenefitCalculationDetail.FirstOrDefault().iclbBenefitCalculationOptions.FirstOrDefault(), lbusBenefitApplication, lbusParticipantsPayeeAccount, this.ibusParticipant, 0, this.icdoPayeeAccount.org_id,
                                                      busConstant.BENEFICIARY_TYPE_CONTINGENT, lstrSurvivorRelationship, ldecSurvivorPercent, true, decimal.Zero);
                        }
                    }
                }
            }

            #region Commented Region

            //busBenefitCalculationHeader lbusPrevBenefitHeader = new busBenefitCalculationHeader { icdoBenefitCalculationHeader = new cdoBenefitCalculationHeader() };
            //Collection<busBenefitCalculationOptions> lclbPrevBenefitOptions = new Collection<busBenefitCalculationOptions>();
            //busBenefitCalculationDetail lbusPrevBenefitDetail = new busBenefitCalculationDetail { icdoBenefitCalculationDetail = new cdoBenefitCalculationDetail() };
            //if (lbusPrevBenefitDetail.FindBenefitCalculationDetail(this.icdoPayeeAccount.benefit_calculation_detail_id))
            //{
            //    lbusPrevBenefitHeader.FindBenefitCalculationHeader(lbusPrevBenefitDetail.icdoBenefitCalculationDetail.benefit_calculation_header_id);

            //    DataTable ldtblBenefitOptions = Select("cdoPayeeAccount.GetBenefitOptionsFromDetailId", new object[1] { lbusPrevBenefitDetail.icdoBenefitCalculationDetail.benefit_calculation_detail_id });
            //    if (ldtblBenefitOptions.Rows.Count > 0)
            //    {
            //        lclbPrevBenefitOptions = GetCollection<busBenefitCalculationOptions>(ldtblBenefitOptions, "icdoBenefitCalculationOptions");
            //    }
            //}


            //lintpersonAccountId = lbusPrevBenefitDetail.icdoBenefitCalculationDetail.person_account_id;

            //busBenefitCalculationHeader lbusBenefitCalculationHeader = new busBenefitCalculationHeader { icdoBenefitCalculationHeader = new cdoBenefitCalculationHeader() };

            //lbusBenefitCalculationHeader = lbusPrevBenefitHeader;
            //lbusBenefitCalculationHeader.icdoBenefitCalculationHeader.benefit_calculation_header_id = 0;
            //lbusBenefitCalculationHeader.icdoBenefitCalculationHeader.calculation_type_value = busConstant.BenefitCalculation.CALCULATION_TYPE_ADJUSTMENT;
            //lbusBenefitCalculationHeader.icdoBenefitCalculationHeader.status_value = busConstant.BenefitCalculation.CALCULATION_STATUS_TYPE_PENDING;
            //lbusBenefitCalculationHeader.icdoBenefitCalculationHeader.Insert();

            //lbusBenefitCalculationHeader.iclbBenefitCalculationDetail = new Collection<busBenefitCalculationDetail>();
            //busBenefitCalculationDetail lbusBenefitCalculationDetail = new busBenefitCalculationDetail { icdoBenefitCalculationDetail = new cdoBenefitCalculationDetail() };
            //lbusBenefitCalculationDetail = lbusPrevBenefitDetail;
            //lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.benefit_calculation_header_id = lbusBenefitCalculationHeader.icdoBenefitCalculationHeader.benefit_calculation_header_id;
            //lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.Insert();
            //lbusBenefitCalculationHeader.iclbBenefitCalculationDetail.Add(lbusBenefitCalculationDetail);


            //lbusBenefitCalculationDetail.iclbBenefitCalculationOptions = new Collection<busBenefitCalculationOptions>();
            //busBenefitCalculationOptions lbusBenefitCalculationOptions = new busBenefitCalculationOptions { icdoBenefitCalculationOptions = new cdoBenefitCalculationOptions() };

            //if (lbusParticipantsPayeeAccount.icdoPayeeAccount.iintPlanId != busConstant.IAP_PLAN_ID)
            //{
            //    lbusBenefitCalculationOptions = lclbPrevBenefitOptions.First();
            //    lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.benefit_calculation_detail_id = lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.benefit_calculation_detail_id;
            //}
            //else
            //{
            //    lbusBenefitCalculationOptions = lclbPrevBenefitOptions.Where(item => item.icdoBenefitCalculationOptions.local52_special_acct_bal_flag != busConstant.FLAG_YES
            //        && item.icdoBenefitCalculationOptions.local161_special_acct_bal_flag != busConstant.FLAG_YES).First();
            //    lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.benefit_calculation_detail_id = lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.benefit_calculation_detail_id;
            //}
            //DataTable ldtbBeneficiaryDetails = busBase.Select("cdoPersonAccountBeneficiary.GetBeneficiaryDetails", new Object[1] { lintpersonAccountId });
            //if (ldtbBeneficiaryDetails.Rows.Count > 0)
            //{
            //    foreach (DataRow ldrBeneficiaryDetail in ldtbBeneficiaryDetails.Rows)
            //    {
            //        if (Convert.ToString(ldrBeneficiaryDetail[enmPersonAccountBeneficiary.beneficiary_type_value.ToString().ToUpper()]) == busConstant.BENEFICIARY_TYPE_PRIMARY
            //            && Convert.ToString(ldrBeneficiaryDetail[enmRelationship.beneficiary_person_id.ToString().ToUpper()]).IsNotNullOrEmpty()
            //            && Convert.ToInt32(ldrBeneficiaryDetail[enmRelationship.beneficiary_person_id.ToString().ToUpper()]) == lbusPrevBenefitHeader.icdoBenefitCalculationHeader.beneficiary_person_id)
            //        {
            //            if (lstrBenefitOptionValue == busConstant.TEN_YEARS_CERTAIN_AND_LIFE_ANNUTIY || lstrBenefitOptionValue == busConstant.TWO_YEARS_CERTAIN_AND_LIFE_ANNUITY ||
            //                    lstrBenefitOptionValue == busConstant.THREE_YEARS_CERTAIN_AND_LIFE_ANNUITY || lstrBenefitOptionValue == busConstant.FIVE_YEARS_CERTAIN_AND_LIFE_ANNUTIY)
            //            {
            //                if (lbusParticipantsPayeeAccount.icdoPayeeAccount.iintPlanId != busConstant.IAP_PLAN_ID)
            //                {
            //                    lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.survivor_amount =
            //                        lbusParticipantsBenefitCalculation.iclbBenefitCalculationDetail.First().iclbBenefitCalculationOptions.First().icdoBenefitCalculationOptions.benefit_amount;

            //                    lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.benefit_amount =
            //                        lbusParticipantsBenefitCalculation.iclbBenefitCalculationDetail.First().iclbBenefitCalculationOptions.First().icdoBenefitCalculationOptions.benefit_amount;
            //                }
            //                else
            //                {
            //                    lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.survivor_amount =
            //                        lbusParticipantsBenefitCalculation.iclbBenefitCalculationDetail.Where
            //                        (item => item.icdoBenefitCalculationDetail.l52_spl_acc_flag != busConstant.FLAG_YES &&
            //                            item.icdoBenefitCalculationDetail.l161_spl_acc_flag != busConstant.FLAG_YES).
            //                        First().iclbBenefitCalculationOptions.First().icdoBenefitCalculationOptions.benefit_amount;

            //                    lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.benefit_amount =
            //                        lbusParticipantsBenefitCalculation.iclbBenefitCalculationDetail.Where
            //                        (item => item.icdoBenefitCalculationDetail.l52_spl_acc_flag != busConstant.FLAG_YES &&
            //                            item.icdoBenefitCalculationDetail.l161_spl_acc_flag != busConstant.FLAG_YES).
            //                        First().iclbBenefitCalculationOptions.First().icdoBenefitCalculationOptions.benefit_amount;
            //                }

            //            }
            //            else
            //            {
            //                if (lbusParticipantsPayeeAccount.icdoPayeeAccount.iintPlanId != busConstant.IAP_PLAN_ID)
            //                {
            //                    lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.survivor_amount =
            //                        lbusParticipantsBenefitCalculation.iclbBenefitCalculationDetail.First().iclbBenefitCalculationOptions.First().icdoBenefitCalculationOptions.survivor_amount;

            //                    lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.benefit_amount =
            //                        lbusParticipantsBenefitCalculation.iclbBenefitCalculationDetail.First().iclbBenefitCalculationOptions.First().icdoBenefitCalculationOptions.benefit_amount;
            //                }
            //                else
            //                {
            //                    lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.survivor_amount =
            //                        lbusParticipantsBenefitCalculation.iclbBenefitCalculationDetail.Where
            //                        (item => item.icdoBenefitCalculationDetail.l52_spl_acc_flag != busConstant.FLAG_YES &&
            //                            item.icdoBenefitCalculationDetail.l161_spl_acc_flag != busConstant.FLAG_YES).
            //                        First().iclbBenefitCalculationOptions.First().icdoBenefitCalculationOptions.survivor_amount;

            //                    lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.benefit_amount =
            //                       lbusParticipantsBenefitCalculation.iclbBenefitCalculationDetail.Where
            //                       (item => item.icdoBenefitCalculationDetail.l52_spl_acc_flag != busConstant.FLAG_YES &&
            //                           item.icdoBenefitCalculationDetail.l161_spl_acc_flag != busConstant.FLAG_YES).
            //                       First().iclbBenefitCalculationOptions.First().icdoBenefitCalculationOptions.benefit_amount;
            //                }
            //            }
            //            break;
            //        }
            //        else if (Convert.ToString(ldrBeneficiaryDetail[enmPersonAccountBeneficiary.beneficiary_type_value.ToString().ToUpper()]) == busConstant.BENEFICIARY_TYPE_PRIMARY
            //            && Convert.ToString(ldrBeneficiaryDetail[enmRelationship.beneficiary_org_id.ToString().ToUpper()]).IsNotNullOrEmpty()
            //            && Convert.ToInt32(ldrBeneficiaryDetail[enmRelationship.beneficiary_org_id.ToString().ToUpper()]) == lbusPrevBenefitHeader.icdoBenefitCalculationHeader.organization_id)
            //        {
            //            if (lstrBenefitOptionValue == busConstant.TEN_YEARS_CERTAIN_AND_LIFE_ANNUTIY || lstrBenefitOptionValue == busConstant.TWO_YEARS_CERTAIN_AND_LIFE_ANNUITY ||
            //                   lstrBenefitOptionValue == busConstant.THREE_YEARS_CERTAIN_AND_LIFE_ANNUITY || lstrBenefitOptionValue == busConstant.FIVE_YEARS_CERTAIN_AND_LIFE_ANNUTIY)
            //            {
            //                if (lbusParticipantsPayeeAccount.icdoPayeeAccount.iintPlanId != busConstant.IAP_PLAN_ID)
            //                {
            //                    lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.survivor_amount =
            //                        lbusParticipantsBenefitCalculation.iclbBenefitCalculationDetail.First().iclbBenefitCalculationOptions.First().icdoBenefitCalculationOptions.benefit_amount;

            //                    lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.benefit_amount =
            //                        lbusParticipantsBenefitCalculation.iclbBenefitCalculationDetail.First().iclbBenefitCalculationOptions.First().icdoBenefitCalculationOptions.benefit_amount;
            //                }
            //                else
            //                {
            //                    lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.survivor_amount =
            //                        lbusParticipantsBenefitCalculation.iclbBenefitCalculationDetail.Where
            //                        (item => item.icdoBenefitCalculationDetail.l52_spl_acc_flag != busConstant.FLAG_YES &&
            //                            item.icdoBenefitCalculationDetail.l161_spl_acc_flag != busConstant.FLAG_YES).
            //                        First().iclbBenefitCalculationOptions.First().icdoBenefitCalculationOptions.benefit_amount;

            //                    lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.benefit_amount =
            //                        lbusParticipantsBenefitCalculation.iclbBenefitCalculationDetail.Where
            //                        (item => item.icdoBenefitCalculationDetail.l52_spl_acc_flag != busConstant.FLAG_YES &&
            //                            item.icdoBenefitCalculationDetail.l161_spl_acc_flag != busConstant.FLAG_YES).
            //                        First().iclbBenefitCalculationOptions.First().icdoBenefitCalculationOptions.benefit_amount;
            //                }
            //            }
            //            else
            //            {
            //                if (lbusParticipantsPayeeAccount.icdoPayeeAccount.iintPlanId != busConstant.IAP_PLAN_ID)
            //                {
            //                    lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.survivor_amount =
            //                        lbusParticipantsBenefitCalculation.iclbBenefitCalculationDetail.First().iclbBenefitCalculationOptions.First().icdoBenefitCalculationOptions.survivor_amount;

            //                    lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.benefit_amount =
            //                       lbusParticipantsBenefitCalculation.iclbBenefitCalculationDetail.First().iclbBenefitCalculationOptions.First().icdoBenefitCalculationOptions.benefit_amount;
            //                }
            //                else
            //                {
            //                    lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.survivor_amount =
            //                        lbusParticipantsBenefitCalculation.iclbBenefitCalculationDetail.Where
            //                        (item => item.icdoBenefitCalculationDetail.l52_spl_acc_flag != busConstant.FLAG_YES &&
            //                            item.icdoBenefitCalculationDetail.l161_spl_acc_flag != busConstant.FLAG_YES).
            //                        First().iclbBenefitCalculationOptions.First().icdoBenefitCalculationOptions.survivor_amount;

            //                    lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.benefit_amount =
            //                       lbusParticipantsBenefitCalculation.iclbBenefitCalculationDetail.Where
            //                       (item => item.icdoBenefitCalculationDetail.l52_spl_acc_flag != busConstant.FLAG_YES &&
            //                           item.icdoBenefitCalculationDetail.l161_spl_acc_flag != busConstant.FLAG_YES).
            //                       First().iclbBenefitCalculationOptions.First().icdoBenefitCalculationOptions.benefit_amount;
            //                }
            //            }
            //            break;
            //        }
            //        else if (Convert.ToString(ldrBeneficiaryDetail[enmPersonAccountBeneficiary.beneficiary_type_value.ToString().ToUpper()]) == busConstant.BENEFICIARY_TYPE_CONTINGENT
            //            && Convert.ToString(ldrBeneficiaryDetail[enmRelationship.beneficiary_person_id.ToString().ToUpper()]).IsNotNullOrEmpty()
            //            && Convert.ToInt32(ldrBeneficiaryDetail[enmRelationship.beneficiary_person_id.ToString().ToUpper()]) == lbusPrevBenefitHeader.icdoBenefitCalculationHeader.beneficiary_person_id)
            //        {

            //            lintBeneficiaryPersonId = Convert.ToInt32(ldrBeneficiaryDetail[enmRelationship.beneficiary_person_id.ToString().ToUpper()]);
            //            lstrSurvivorRelationship = Convert.ToString(ldrBeneficiaryDetail[enmRelationship.relationship_value.ToString().ToUpper()]);
            //            ldecSurvivorPercent = Convert.ToDecimal(ldrBeneficiaryDetail[enmPersonAccountBeneficiary.dist_percent.ToString().ToUpper()]);

            //            if (lstrBenefitOptionValue == busConstant.TEN_YEARS_CERTAIN_AND_LIFE_ANNUTIY || lstrBenefitOptionValue == busConstant.TWO_YEARS_CERTAIN_AND_LIFE_ANNUITY ||
            //                    lstrBenefitOptionValue == busConstant.THREE_YEARS_CERTAIN_AND_LIFE_ANNUITY || lstrBenefitOptionValue == busConstant.FIVE_YEARS_CERTAIN_AND_LIFE_ANNUTIY)
            //            {
            //                if (lbusParticipantsPayeeAccount.icdoPayeeAccount.iintPlanId != busConstant.IAP_PLAN_ID)
            //                {
            //                    lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.survivor_amount =
            //                        (lbusParticipantsBenefitCalculation.iclbBenefitCalculationDetail.First().iclbBenefitCalculationOptions.First().icdoBenefitCalculationOptions.benefit_amount / 100) * ldecSurvivorPercent;

            //                    lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.benefit_amount =
            //                        lbusParticipantsBenefitCalculation.iclbBenefitCalculationDetail.First().iclbBenefitCalculationOptions.First().icdoBenefitCalculationOptions.benefit_amount ;
            //                }
            //                else
            //                {
            //                    lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.survivor_amount =
            //                       (lbusParticipantsBenefitCalculation.iclbBenefitCalculationDetail.Where
            //                        (item => item.icdoBenefitCalculationDetail.l52_spl_acc_flag != busConstant.FLAG_YES &&
            //                            item.icdoBenefitCalculationDetail.l161_spl_acc_flag != busConstant.FLAG_YES).
            //                        First().iclbBenefitCalculationOptions.First().icdoBenefitCalculationOptions.benefit_amount / 100) * ldecSurvivorPercent;

            //                    lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.benefit_amount =
            //                       lbusParticipantsBenefitCalculation.iclbBenefitCalculationDetail.Where
            //                        (item => item.icdoBenefitCalculationDetail.l52_spl_acc_flag != busConstant.FLAG_YES &&
            //                            item.icdoBenefitCalculationDetail.l161_spl_acc_flag != busConstant.FLAG_YES).
            //                        First().iclbBenefitCalculationOptions.First().icdoBenefitCalculationOptions.benefit_amount;
            //                }
            //            }
            //            else
            //            {
            //                if (lbusParticipantsPayeeAccount.icdoPayeeAccount.iintPlanId != busConstant.IAP_PLAN_ID)
            //                {
            //                    lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.survivor_amount =
            //                        (lbusParticipantsBenefitCalculation.iclbBenefitCalculationDetail.First().iclbBenefitCalculationOptions.First().icdoBenefitCalculationOptions.survivor_amount / 100) * ldecSurvivorPercent;

            //                    lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.benefit_amount =
            //                      lbusParticipantsBenefitCalculation.iclbBenefitCalculationDetail.First().iclbBenefitCalculationOptions.First().icdoBenefitCalculationOptions.benefit_amount; 

            //                }
            //                else
            //                {
            //                    lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.survivor_amount =
            //                        (lbusParticipantsBenefitCalculation.iclbBenefitCalculationDetail.Where
            //                        (item => item.icdoBenefitCalculationDetail.l52_spl_acc_flag != busConstant.FLAG_YES &&
            //                            item.icdoBenefitCalculationDetail.l161_spl_acc_flag != busConstant.FLAG_YES).
            //                        First().iclbBenefitCalculationOptions.First().icdoBenefitCalculationOptions.survivor_amount / 100) * ldecSurvivorPercent;


            //                    lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.benefit_amount =
            //                        lbusParticipantsBenefitCalculation.iclbBenefitCalculationDetail.Where
            //                        (item => item.icdoBenefitCalculationDetail.l52_spl_acc_flag != busConstant.FLAG_YES &&
            //                            item.icdoBenefitCalculationDetail.l161_spl_acc_flag != busConstant.FLAG_YES).
            //                        First().iclbBenefitCalculationOptions.First().icdoBenefitCalculationOptions.benefit_amount ; 
            //                }
            //            }
            //            break;
            //        }
            //        else if (Convert.ToString(ldrBeneficiaryDetail[enmPersonAccountBeneficiary.beneficiary_type_value.ToString().ToUpper()]) == busConstant.BENEFICIARY_TYPE_CONTINGENT
            //        && Convert.ToString(ldrBeneficiaryDetail[enmRelationship.beneficiary_org_id.ToString().ToUpper()]).IsNotNullOrEmpty()
            //        && Convert.ToInt32(ldrBeneficiaryDetail[enmRelationship.beneficiary_org_id.ToString().ToUpper()]) == lbusPrevBenefitHeader.icdoBenefitCalculationHeader.organization_id)
            //        {
            //            lintBeneficiaryOrgId = Convert.ToInt32(ldrBeneficiaryDetail[enmRelationship.beneficiary_org_id.ToString().ToUpper()]);
            //            lstrSurvivorRelationship = Convert.ToString(ldrBeneficiaryDetail[enmRelationship.relationship_value.ToString().ToUpper()]);
            //            ldecSurvivorPercent = Convert.ToDecimal(ldrBeneficiaryDetail[enmPersonAccountBeneficiary.dist_percent.ToString().ToUpper()]);


            //            if (lstrBenefitOptionValue == busConstant.TEN_YEARS_CERTAIN_AND_LIFE_ANNUTIY || lstrBenefitOptionValue == busConstant.TWO_YEARS_CERTAIN_AND_LIFE_ANNUITY ||
            //                    lstrBenefitOptionValue == busConstant.THREE_YEARS_CERTAIN_AND_LIFE_ANNUITY || lstrBenefitOptionValue == busConstant.FIVE_YEARS_CERTAIN_AND_LIFE_ANNUTIY)
            //            {
            //                if (lbusParticipantsPayeeAccount.icdoPayeeAccount.iintPlanId != busConstant.IAP_PLAN_ID)
            //                {
            //                    lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.survivor_amount =
            //                        (lbusParticipantsBenefitCalculation.iclbBenefitCalculationDetail.First().iclbBenefitCalculationOptions.First().icdoBenefitCalculationOptions.benefit_amount / 100) * ldecSurvivorPercent;

            //                    lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.benefit_amount =
            //                        lbusParticipantsBenefitCalculation.iclbBenefitCalculationDetail.First().iclbBenefitCalculationOptions.First().icdoBenefitCalculationOptions.benefit_amount ;
            //                }
            //                else
            //                {
            //                    lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.survivor_amount =
            //                       (lbusParticipantsBenefitCalculation.iclbBenefitCalculationDetail.Where
            //                        (item => item.icdoBenefitCalculationDetail.l52_spl_acc_flag != busConstant.FLAG_YES &&
            //                            item.icdoBenefitCalculationDetail.l161_spl_acc_flag != busConstant.FLAG_YES).
            //                        First().iclbBenefitCalculationOptions.First().icdoBenefitCalculationOptions.benefit_amount / 100) * ldecSurvivorPercent;

            //                    lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.benefit_amount =
            //                       lbusParticipantsBenefitCalculation.iclbBenefitCalculationDetail.Where
            //                        (item => item.icdoBenefitCalculationDetail.l52_spl_acc_flag != busConstant.FLAG_YES &&
            //                            item.icdoBenefitCalculationDetail.l161_spl_acc_flag != busConstant.FLAG_YES).
            //                        First().iclbBenefitCalculationOptions.First().icdoBenefitCalculationOptions.benefit_amount;
            //                }
            //            }
            //            else
            //            {
            //                if (lbusParticipantsPayeeAccount.icdoPayeeAccount.iintPlanId != busConstant.IAP_PLAN_ID)
            //                {
            //                    lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.survivor_amount =
            //                        (lbusParticipantsBenefitCalculation.iclbBenefitCalculationDetail.First().iclbBenefitCalculationOptions.First().icdoBenefitCalculationOptions.survivor_amount / 100) * ldecSurvivorPercent;

            //                    lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.benefit_amount =
            //                        lbusParticipantsBenefitCalculation.iclbBenefitCalculationDetail.First().iclbBenefitCalculationOptions.First().icdoBenefitCalculationOptions.benefit_amount;

            //                }
            //                else
            //                {
            //                    lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.survivor_amount =
            //                        (lbusParticipantsBenefitCalculation.iclbBenefitCalculationDetail.Where
            //                        (item => item.icdoBenefitCalculationDetail.l52_spl_acc_flag != busConstant.FLAG_YES &&
            //                            item.icdoBenefitCalculationDetail.l161_spl_acc_flag != busConstant.FLAG_YES).
            //                        First().iclbBenefitCalculationOptions.First().icdoBenefitCalculationOptions.survivor_amount / 100) * ldecSurvivorPercent;



            //                    lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.benefit_amount =
            //                        lbusParticipantsBenefitCalculation.iclbBenefitCalculationDetail.Where
            //                        (item => item.icdoBenefitCalculationDetail.l52_spl_acc_flag != busConstant.FLAG_YES &&
            //                            item.icdoBenefitCalculationDetail.l161_spl_acc_flag != busConstant.FLAG_YES).
            //                        First().iclbBenefitCalculationOptions.First().icdoBenefitCalculationOptions.benefit_amount;
            //                }
            //            }
            //            break;
            //        }
            //    }

            //    lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.benefit_calculation_detail_id = lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.benefit_calculation_detail_id;
            //    lbusBenefitCalculationDetail.iclbBenefitCalculationOptions.Add(lbusBenefitCalculationOptions);
            //    lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.Insert();
            //}

            #endregion Commented Region
            #endregion
            return iarrErrors;
        }


        public bool CheckIfDROExistForDeceasedParticipant(int aintParticipantId)
        {
            int lintCount = (int)DBFunction.DBExecuteScalar("cdoDroApplication.CheckIfDROExistForDeceasedParticipant", new object[1] { aintParticipantId },
                iobjPassInfo.iconFramework, iobjPassInfo.itrnFramework);
            if (lintCount > 0)
                return true;
            else
                return false;
        }

        public ArrayList btn_PaySurvivor()
        {
            utlError lobjError = null;

            if (this.iarrErrors.IsNull())
                this.iarrErrors = new ArrayList();

            bool lblnCreateAdjustmentCalculation = false;

            int lintPostRrtmDeathCalc = (int)DBFunction.DBExecuteScalar("cdoBenefitCalculationHeader.GetPostRTMTDeathCalculations", new object[1] { icdoPayeeAccount.payee_account_id },
                iobjPassInfo.iconFramework, iobjPassInfo.itrnFramework);

            if (lintPostRrtmDeathCalc > 0)
            {
                lblnCreateAdjustmentCalculation = true;
            }

            int lintpersonAccountId = 0;
            int lintBeneficiaryPersonId = 0;
            int lintBeneficiaryOrgId = 0;
            string lstrSurvivorRelationship = string.Empty;
            decimal ldecSurvivorPercent = busConstant.ZERO_DECIMAL;
            bool lblnFlagContingent = false;



            this.LoadBenefitDetails();

            busBenefitCalculationOptions lbusBenefitCalculationOptions = null;
            busBenefitCalculationDetail lbusBenefitCalculationDetail = null;
            busBenefitApplicationDetail lbusBenefitApplicationDetail = new busBenefitApplicationDetail { icdoBenefitApplicationDetail = new cdoBenefitApplicationDetail() };


            if (this.ibusPayee.icdoPerson.person_id == this.ibusParticipant.icdoPerson.person_id)
            {

                if (this.icdoPayeeAccount.term_certain_end_date != DateTime.MinValue && this.ibusPayee.icdoPerson.date_of_death != DateTime.MinValue
                    && this.ibusPayee.icdoPerson.date_of_death >= this.icdoPayeeAccount.term_certain_end_date)
                {
                    lobjError = AddError(6190, "");
                    this.iarrErrors.Add(lobjError);
                    return iarrErrors;
                }

                if (lbusBenefitApplicationDetail.FindBenefitApplicationDetail(this.icdoPayeeAccount.benefit_application_detail_id))
                {
                    this.ibusBenefitApplication = new busBenefitApplication { icdoBenefitApplication = new cdoBenefitApplication() };
                    this.ibusBenefitApplication.FindBenefitApplication(lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.benefit_application_id);
                    this.ibusBenefitApplication.ibusPerson = new busPerson();
                    this.ibusBenefitApplication.ibusPerson.FindPerson(this.ibusBenefitApplication.icdoBenefitApplication.person_id);
                }
                if ((lbusBenefitApplicationDetail != null && lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.joint_annuitant_id > 0) ||
                        this.icdoPayeeAccount.term_certain_end_date != DateTime.MinValue || ((this.icdoPayeeAccount.istrBenefitOptionValue == busConstant.LUMP_SUM ||
                        this.icdoPayeeAccount.istrBenefitOptionValue == busConstant.TEN_YEARS_CERTAIN_AND_LIFE_ANNUTIY) && this.icdoPayeeAccount.iintPlanId == busConstant.IAP_PLAN_ID)
                    || this.icdoPayeeAccount.istrBenefitOptionValue == busConstant.LIFE_ANNUTIY)
                {
                    #region Commented by PIR 853
                    /*
                    if (lbusBenefitCalculationDetail.IsNull() && this.icdoPayeeAccount.iintPlanId == busConstant.MPIPP_PLAN_ID)
                    {
                        #region Check Late Hours For Participant
                        //If Late Hour exists
                        if (this.icdoPayeeAccount.benefit_account_type_value == busConstant.BENEFIT_TYPE_RETIREMENT || this.icdoPayeeAccount.benefit_account_type_value == busConstant.BENEFIT_TYPE_DISABILITY
                            || this.icdoPayeeAccount.benefit_account_type_value == busConstant.BENEFIT_TYPE_WITHDRAWAL)
                        {
                            this.ibusBenefitCalculationHeader = new busBenefitCalculationHeader();
                            this.ibusBenefitCalculationHeader = RecalculateBenefitsForLateHours(true);

                            if (this.ibusBenefitCalculationHeader.IsNotNull() && !this.ibusBenefitCalculationHeader.iclbBenefitCalculationDetail.IsNullOrEmpty())
                            {
                                lbusBenefitCalculationDetail = this.ibusBenefitCalculationHeader.iclbBenefitCalculationDetail.FirstOrDefault();
                                lblnCreateAdjustmentCalculation = true;
                                if (this.ibusBenefitCalculationHeader.iclbBenefitCalculationDetail.FirstOrDefault().iclbBenefitCalculationOptions != null && this.ibusBenefitCalculationHeader.iclbBenefitCalculationDetail.FirstOrDefault().iclbBenefitCalculationOptions.Count > 0)
                                    lbusBenefitCalculationOptions = this.ibusBenefitCalculationHeader.iclbBenefitCalculationDetail.FirstOrDefault().iclbBenefitCalculationOptions.FirstOrDefault();
                            }
                        }
                        #endregion

                    }

                    if (lbusBenefitCalculationDetail.IsNull() && this.icdoPayeeAccount.iintPlanId == busConstant.MPIPP_PLAN_ID)
                    {
                        #region Reemployment
                        DataTable ldtReEvaluationTable = ibusCalculation.LoadHoursBetweenTwoDates(this.ibusPayee.icdoPerson.istrSSNNonEncrypted, this.icdoPayeeAccount.idtRetireMentDate, DateTime.Now, busConstant.MPIPP);
                        if (ldtReEvaluationTable != null && ldtReEvaluationTable.Rows.Count > 0)
                        {
                            decimal ldecAge = busGlobalFunctions.CalculatePersonAge(this.ibusPayee.icdoPerson.idtDateofBirth, this.ibusPayee.icdoPerson.date_of_death);
                            busBenefitCalculationHeader lbusBenefitCalculationHeader = new busBenefitCalculationHeader { icdoBenefitCalculationHeader = new cdoBenefitCalculationHeader() };
                            if (ldtReEvaluationTable.Rows.Count > 0)
                            {
                                DataTable ldtPayeeAccountDetails = busBase.Select("cdoPayeeAccount.GetReEmployedParticipantInfo", new object[1] { this.icdoPayeeAccount.payee_account_id });
                                if (ldtPayeeAccountDetails.Rows.Count > 0)
                                {
                                    DateTime ldtBenefitEffectiveDate = this.ibusPayee.icdoPerson.date_of_death;
                                    if (ldtBenefitEffectiveDate.Day != 1)
                                    {
                                        ldtBenefitEffectiveDate = ldtBenefitEffectiveDate.GetFirstDayofMonth().AddMonths(1);
                                    }
                                    if (this.icdoPayeeAccount.benefit_account_type_value == busConstant.BENEFIT_TYPE_RETIREMENT)
                                    {
                                        this.ibusBenefitCalculationHeader = this.ReEvaluateReemployedParticipants(ldtReEvaluationTable, ldtPayeeAccountDetails.Rows[0], ldtBenefitEffectiveDate, DateTime.Now, null, true);
                                        if (this.ibusBenefitCalculationHeader != null && this.ibusBenefitCalculationHeader.iclbBenefitCalculationDetail != null &&
                                            this.ibusBenefitCalculationHeader.iclbBenefitCalculationDetail.Count > 0)
                                        {
                                            lbusBenefitCalculationDetail = this.ibusBenefitCalculationHeader.iclbBenefitCalculationDetail.FirstOrDefault();
                                            if (!lbusBenefitCalculationDetail.iclbBenefitCalculationOptions.IsNullOrEmpty())
                                                lbusBenefitCalculationOptions = lbusBenefitCalculationDetail.iclbBenefitCalculationOptions.FirstOrDefault();

                                        }
                                    }
                                    else if (this.icdoPayeeAccount.benefit_account_type_value == busConstant.BENEFIT_TYPE_DISABILITY)
                                    {
                                        this.ibusBenefitCalculationHeader = RecalculateParticipantDisabilityBenefits(this.icdoPayeeAccount.istrBenefitOptionValue, false, true, true);

                                        //this.ibusBenefitCalculationHeader = this.CreateFinalCalculationForReEmployedDisabledParticipants(ldtReEvaluationTable, ldtPayeeAccountDetails.Rows[0], this.ibusPayee.icdoPerson.date_of_death, DateTime.Now, true);
                                        if (this.ibusBenefitCalculationHeader.iclbBenefitCalculationDetail.Count > 0)
                                        {
                                            lbusBenefitCalculationDetail = this.ibusBenefitCalculationHeader.iclbBenefitCalculationDetail.FirstOrDefault();
                                            if (!lbusBenefitCalculationDetail.iclbBenefitCalculationOptions.IsNullOrEmpty())
                                                lbusBenefitCalculationOptions = lbusBenefitCalculationDetail.iclbBenefitCalculationOptions.FirstOrDefault();

                                        }

                                    }
                                }
                            }
                        }
                        #endregion Reemployment
                    }*/
                    #endregion Commented by PIR 853

                    if (lbusBenefitCalculationDetail.IsNull())
                    {
                        //No Reemployment or Late Hours : Calculation Exist
                        bool lblnIfDROExistForDeceasedParticipant = false;


                        //Scenario UAT PIR 954
                        lblnIfDROExistForDeceasedParticipant = CheckIfDROExistForDeceasedParticipant(icdoPayeeAccount.person_id);

                        lbusBenefitCalculationDetail = new busBenefitCalculationDetail { icdoBenefitCalculationDetail = new cdoBenefitCalculationDetail() };
                        if (!lblnIfDROExistForDeceasedParticipant && lbusBenefitCalculationDetail.FindBenefitCalculationDetail(this.icdoPayeeAccount.benefit_calculation_detail_id))
                        {
                            lbusBenefitCalculationDetail.LoadBenefitCalculationOptionss();
                            if (!lbusBenefitCalculationDetail.iclbBenefitCalculationOptions.IsNullOrEmpty())
                                lbusBenefitCalculationOptions = lbusBenefitCalculationDetail.iclbBenefitCalculationOptions.FirstOrDefault();
                        }
                        else
                        {
                            lbusBenefitCalculationDetail = new busBenefitCalculationDetail { icdoBenefitCalculationDetail = new cdoBenefitCalculationDetail() };
                        }
                    }

                    this.ibusPayee.LoadPersonAccounts();

                    lintpersonAccountId = this.ibusPayee.iclbPersonAccount.Where(item => item.icdoPersonAccount.plan_id == icdoPayeeAccount.iintPlanId).First().icdoPersonAccount.person_account_id;
                    bool lblnPrimaryRecordCreated = false;
                    decimal ldecIAPBalance = decimal.Zero;
                    decimal ldecLocal52SpecialAccountBalance = decimal.Zero;
                    decimal ldecLocal161SpecialAccountBalance = decimal.Zero;
                    DataTable ldtbIAPBalance = busBase.Select("cdoPersonAccountRetirementContribution.GetIAPBalanceAsofYear",
                           new object[2] { lintpersonAccountId,
                                       DateTime.Now.Year});

                    if (ldtbIAPBalance.IsNotNull() && ldtbIAPBalance.Rows.Count > 0)
                    {
                        ldecIAPBalance = Convert.ToDecimal(Convert.ToBoolean(ldtbIAPBalance.Rows[0][0].IsDBNull()) ? busConstant.ZERO_DECIMAL : ldtbIAPBalance.Rows[0][0]);
                        ldecLocal52SpecialAccountBalance = Convert.ToDecimal(Convert.ToBoolean(ldtbIAPBalance.Rows[0][1].IsDBNull()) ? busConstant.ZERO_DECIMAL : ldtbIAPBalance.Rows[0][1]);
                        ldecLocal161SpecialAccountBalance = Convert.ToDecimal(Convert.ToBoolean(ldtbIAPBalance.Rows[0][2].IsDBNull()) ? busConstant.ZERO_DECIMAL : ldtbIAPBalance.Rows[0][2]);
                    }

                    DataTable ldtbBeneficiaryDetails = busBase.Select("cdoPersonAccountBeneficiary.GetBeneficiaryDetails", new Object[1] { lintpersonAccountId });
                    if (ldtbBeneficiaryDetails.Rows.Count > 0 && this.ibusBenefitApplication != null)
                    {
                        foreach (DataRow ldrBeneficiaryDetail in ldtbBeneficiaryDetails.Rows)
                        {
                            #region Beneficiary Type Primary
                            //Ticket#65664
                            if (Convert.ToString(ldrBeneficiaryDetail[enmPersonAccountBeneficiary.beneficiary_type_value.ToString().ToUpper()]) == busConstant.BENEFICIARY_TYPE_PRIMARY
                                && (Convert.ToString(ldrBeneficiaryDetail[enmRelationship.beneficiary_person_id.ToString().ToUpper()]).IsNotNullOrEmpty() || Convert.ToString(ldrBeneficiaryDetail[enmRelationship.beneficiary_org_id.ToString().ToUpper()]).IsNotNullOrEmpty()))
                            {
                                bool lblnInsertPrimaryBen = false;
                                if (this.icdoPayeeAccount.iintPlanId == busConstant.IAP_PLAN_ID)
                                {
                                    if (ldecIAPBalance == decimal.Zero && ldecLocal161SpecialAccountBalance == decimal.Zero && ldecLocal52SpecialAccountBalance == decimal.Zero)
                                    {
                                        lobjError = AddError(5504, "");
                                        this.iarrErrors.Add(lobjError);
                                        return iarrErrors;
                                    }
                                    else
                                    {
                                        lblnInsertPrimaryBen = true;
                                    }

                                }
                                //Ticket#65664
                                int lintbeneficiary_person_id = 0;
                                int lintbeneficiary_Org_id = 0;
                                if (Convert.ToString(ldrBeneficiaryDetail[enmRelationship.beneficiary_person_id.ToString().ToUpper()]).IsNotNullOrEmpty())
                                {
                                    lintbeneficiary_person_id = Convert.ToInt32(ldrBeneficiaryDetail[enmRelationship.beneficiary_person_id.ToString()]);

                                }

                                if (Convert.ToString(ldrBeneficiaryDetail[enmRelationship.beneficiary_org_id.ToString().ToUpper()]).IsNotNullOrEmpty())
                                {
                                    lintbeneficiary_Org_id = Convert.ToInt32(ldrBeneficiaryDetail[enmRelationship.beneficiary_org_id.ToString()]);

                                }

                                if ((lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.joint_annuitant_id == lintbeneficiary_person_id || lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.joint_annuitant_id == lintbeneficiary_Org_id) && this.ibusPayee.icdoPerson.person_id == this.ibusParticipant.icdoPerson.person_id ||
                                     (lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.joint_annuitant_id <= 0 && (this.icdoPayeeAccount.term_certain_end_date != DateTime.MinValue || this.icdoPayeeAccount.istrBenefitOptionValue == busConstant.LIFE_ANNUTIY)))
                                {
                                    lblnInsertPrimaryBen = true;
                                }


                                if (lblnInsertPrimaryBen)
                                {
                                    if (Convert.ToString(ldrBeneficiaryDetail[enmPerson.date_of_death.ToString().ToUpper()]).IsNullOrEmpty())
                                    {
                                        if (Convert.ToString(ldrBeneficiaryDetail[enmRelationship.beneficiary_person_id.ToString().ToUpper()]).IsNotNullOrEmpty())
                                        {


                                            lintBeneficiaryPersonId = Convert.ToInt32(ldrBeneficiaryDetail[enmRelationship.beneficiary_person_id.ToString().ToUpper()]);

                                            if (ldrBeneficiaryDetail["SSN"] == DBNull.Value || Convert.ToString(ldrBeneficiaryDetail["SSN"]).IsNullOrEmpty())
                                            {
                                                lobjError = AddError(6199, "");
                                                this.iarrErrors.Add(lobjError);
                                                return iarrErrors;
                                            }
                                        }
                                        //Ticket#65664
                                        if (Convert.ToString(ldrBeneficiaryDetail[enmRelationship.beneficiary_org_id.ToString().ToUpper()]).IsNotNullOrEmpty())
                                        {
                                            lintBeneficiaryOrgId = Convert.ToInt32(ldrBeneficiaryDetail[enmRelationship.beneficiary_org_id.ToString().ToUpper()]);

                                            if (ldrBeneficiaryDetail["FEDERAL_ID"] == DBNull.Value || Convert.ToString(ldrBeneficiaryDetail["FEDERAL_ID"]).IsNullOrEmpty())
                                            {
                                                lobjError = AddError(6296, "");
                                                this.iarrErrors.Add(lobjError);
                                                return iarrErrors;
                                            }
                                        }

                                        lstrSurvivorRelationship = Convert.ToString(ldrBeneficiaryDetail[enmRelationship.relationship_value.ToString().ToUpper()]);
                                        ldecSurvivorPercent = Convert.ToDecimal(ldrBeneficiaryDetail[enmPersonAccountBeneficiary.dist_percent.ToString().ToUpper()]);
                                        lblnPrimaryRecordCreated = true;
                                        //Ticket#65664
                                        CreatePostRetirementCalculationForPrimaryBen(lbusBenefitCalculationDetail, lbusBenefitCalculationOptions, ibusBenefitApplication, this, this.ibusPayee, lintBeneficiaryPersonId, lintBeneficiaryOrgId,
                                            busConstant.BENEFICIARY_TYPE_PRIMARY, lstrSurvivorRelationship, ldecSurvivorPercent, lblnCreateAdjustmentCalculation, ldecIAPBalance);
                                    }
                                }
                            }
                            #endregion

                            #region Beneficiary Type Contingent
                            //En PIR 66
                            if (!lblnPrimaryRecordCreated && Convert.ToString(ldrBeneficiaryDetail[enmPersonAccountBeneficiary.beneficiary_type_value.ToString().ToUpper()]) == busConstant.BENEFICIARY_TYPE_CONTINGENT)
                            {
                                if (Convert.ToString(ldrBeneficiaryDetail[enmRelationship.beneficiary_person_id.ToString().ToUpper()]).IsNotNullOrEmpty())
                                {
                                    if (ldrBeneficiaryDetail["SSN"] == DBNull.Value || Convert.ToString(ldrBeneficiaryDetail["SSN"]).IsNullOrEmpty())
                                    {
                                        lobjError = AddError(6199, "");
                                        this.iarrErrors.Add(lobjError);
                                        return iarrErrors;
                                    }

                                    if (Convert.ToString(ldrBeneficiaryDetail[enmPerson.date_of_death.ToString().ToUpper()]).IsNullOrEmpty())
                                    {
                                        lintBeneficiaryPersonId = Convert.ToInt32(ldrBeneficiaryDetail[enmRelationship.beneficiary_person_id.ToString().ToUpper()]);
                                        lstrSurvivorRelationship = Convert.ToString(ldrBeneficiaryDetail[enmRelationship.relationship_value.ToString().ToUpper()]);
                                        ldecSurvivorPercent = Convert.ToDecimal(ldrBeneficiaryDetail[enmPersonAccountBeneficiary.dist_percent.ToString().ToUpper()]);
                                        if (lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.plan_id != busConstant.IAP_PLAN_ID)
                                        {
                                            CreatePostRetirementCalculationForContingentBen(lbusBenefitCalculationDetail, lbusBenefitCalculationOptions, ibusBenefitApplication, this, this.ibusPayee, lintBeneficiaryPersonId, 0,
                                                busConstant.BENEFICIARY_TYPE_CONTINGENT, lstrSurvivorRelationship, ldecSurvivorPercent, lblnCreateAdjustmentCalculation, decimal.Zero);
                                        }
                                        else
                                        {
                                            if (ldecIAPBalance == decimal.Zero && ldecLocal161SpecialAccountBalance == decimal.Zero && ldecLocal52SpecialAccountBalance == decimal.Zero)
                                            {

                                                lobjError = AddError(5504, "");
                                                this.iarrErrors.Add(lobjError);
                                                return iarrErrors;
                                            }
                                            else
                                            {
                                                CreatePostRetirementCalculationForContingentBen(lbusBenefitCalculationDetail, lbusBenefitCalculationOptions, ibusBenefitApplication, this, this.ibusPayee, lintBeneficiaryPersonId, 0,
                                                         busConstant.BENEFICIARY_TYPE_CONTINGENT, lstrSurvivorRelationship, ldecSurvivorPercent, lblnCreateAdjustmentCalculation, ldecIAPBalance);
                                            }

                                        }

                                        lblnFlagContingent = true;
                                    }
                                }
                                else if ((Convert.ToString(ldrBeneficiaryDetail[enmRelationship.beneficiary_org_id.ToString().ToUpper()]).IsNotNullOrEmpty()))
                                {
                                    lintBeneficiaryOrgId = Convert.ToInt32(ldrBeneficiaryDetail[enmRelationship.beneficiary_org_id.ToString().ToUpper()]);
                                    lstrSurvivorRelationship = Convert.ToString(ldrBeneficiaryDetail[enmRelationship.relationship_value.ToString().ToUpper()]);
                                    ldecSurvivorPercent = Convert.ToDecimal(ldrBeneficiaryDetail[enmPersonAccountBeneficiary.dist_percent.ToString().ToUpper()]);
                                    if (lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.plan_id != busConstant.IAP_PLAN_ID)
                                    {
                                        CreatePostRetirementCalculationForContingentBen(lbusBenefitCalculationDetail, lbusBenefitCalculationOptions, ibusBenefitApplication, this, this.ibusPayee, 0, lintBeneficiaryOrgId,
                                            busConstant.BENEFICIARY_TYPE_CONTINGENT, lstrSurvivorRelationship, ldecSurvivorPercent, lblnCreateAdjustmentCalculation, ldecIAPBalance);
                                    }
                                    else
                                    {
                                        if (ldecIAPBalance == decimal.Zero && ldecLocal161SpecialAccountBalance == decimal.Zero && ldecLocal52SpecialAccountBalance == decimal.Zero)
                                        {

                                            lobjError = AddError(5504, "");
                                            this.iarrErrors.Add(lobjError);
                                            return iarrErrors;
                                        }
                                        else
                                        {
                                            CreatePostRetirementCalculationForContingentBen(lbusBenefitCalculationDetail, lbusBenefitCalculationOptions, ibusBenefitApplication, this, this.ibusPayee, lintBeneficiaryPersonId, 0,
                                                     busConstant.BENEFICIARY_TYPE_CONTINGENT, lstrSurvivorRelationship, ldecSurvivorPercent, lblnCreateAdjustmentCalculation, ldecIAPBalance);
                                        }
                                    }

                                    lblnFlagContingent = true;
                                }
                                if (!lblnFlagContingent)
                                {
                                    lobjError = AddError(5495, " ");
                                    this.iarrErrors.Add(lobjError);
                                    return iarrErrors;
                                }
                            }

                            #endregion
                        }
                    }
                }
                else
                {
                    lobjError = AddError(5496, " ");
                    this.iarrErrors.Add(lobjError);
                    return iarrErrors;
                }
            }
            else
            {
                DataTable ldtblPayments = Select("cdoPaymentHistoryHeader.GetPaymentsCount", new object[1] { icdoPayeeAccount.payee_account_id });
                if ((ldtblPayments != null && ldtblPayments.Rows.Count > 0
                    && this.icdoPayeeAccount.benefit_account_type_value != busConstant.BENEFIT_TYPE_QDRO) || this.icdoPayeeAccount.benefit_account_type_value == busConstant.BENEFIT_TYPE_QDRO)
                {


                    int lintPlanId = this.icdoPayeeAccount.iintPlanId;

                    if (this.icdoPayeeAccount.term_certain_end_date != DateTime.MinValue && this.ibusPayee.icdoPerson.date_of_death != DateTime.MinValue
                            && this.ibusPayee.icdoPerson.date_of_death >= this.icdoPayeeAccount.term_certain_end_date)
                    {
                        lobjError = AddError(6190, "");
                        this.iarrErrors.Add(lobjError);
                        return iarrErrors;
                    }


                    Collection<busPersonAccountBeneficiary> lclbPersonAccountBeneficiary = GetBeneficiaryDetails(this.ibusPayee.icdoPerson.person_id, this.icdoPayeeAccount.iintPlanId);
                    if (lclbPersonAccountBeneficiary.IsNullOrEmpty())
                    {
                        lobjError = AddError(0, "Plan not added for the beneficiary of the survivor.");
                        this.iarrErrors.Add(lobjError);
                        return iarrErrors;
                    }

                    #region Beneficiary Type BOB
                    foreach (busPersonAccountBeneficiary lbusPersonAccountBeneficiary in lclbPersonAccountBeneficiary)
                    {

                        int lintCount = (int)DBFunction.DBExecuteScalar("cdoBenefitCalculationHeader.GetBOBPayeeAccountInReceivingStatusForGivenPlan", new object[3] { lbusPersonAccountBeneficiary.icdoPersonAccountBeneficiary.iaintBenPersonID,
                              lintPlanId,this.icdoPayeeAccount.benefit_account_type_value  }, iobjPassInfo.iconFramework, iobjPassInfo.itrnFramework);

                        if (lintCount > 0)
                        {
                            lobjError = AddError(6168, " ");
                            this.iarrErrors.Add(lobjError);
                            return iarrErrors;
                        }
                        else
                        {
                            busPerson lbusPersonBeneficiary = new busPerson();
                            if (lbusPersonBeneficiary.FindPerson(lbusPersonAccountBeneficiary.icdoPersonAccountBeneficiary.iaintBenPersonID))
                            {
                                if (lbusPersonBeneficiary.icdoPerson.ssn.IsNullOrEmpty())
                                {
                                    lobjError = AddError(6199, "");
                                    this.iarrErrors.Add(lobjError);
                                    return iarrErrors;
                                }
                            }

                            if (this.icdoPayeeAccount.benefit_account_type_value != busConstant.BENEFIT_TYPE_QDRO)
                            {
                                CreatePayeeAccountForBOB(this, lbusPersonAccountBeneficiary, this.ibusPayee.icdoPerson.person_id, lbusPersonAccountBeneficiary.icdoPersonAccountBeneficiary.iaintBenPersonID, lbusPersonAccountBeneficiary.icdoPersonAccountBeneficiary.iaintBenOrgID,
                                    lbusPersonAccountBeneficiary.icdoPersonAccountBeneficiary.istrRelationShipValue);
                            }
                            else
                            {
                                if (this.icdoPayeeAccount.dro_application_detail_id > 0)
                                {
                                    int lintCountEligibleForContinuance = (int)DBFunction.DBExecuteScalar("cdoDroBenefitDetails.CheckIfEligibleForContinuance", new object[1] { this.icdoPayeeAccount.dro_application_detail_id },
                                         iobjPassInfo.iconFramework, iobjPassInfo.itrnFramework);


                                    CreatePayeeAccountForBOBOfAlternatePayee(this, lbusPersonAccountBeneficiary, this.ibusPayee.icdoPerson.person_id, lbusPersonAccountBeneficiary.icdoPersonAccountBeneficiary.iaintBenPersonID, lbusPersonAccountBeneficiary.icdoPersonAccountBeneficiary.iaintBenOrgID,
                                    lbusPersonAccountBeneficiary.icdoPersonAccountBeneficiary.istrRelationShipValue, lintCountEligibleForContinuance);

                                }
                            }
                        }
                    }
                    #endregion Beneficiary Type BOB

                }
                else
                {
                    //This Scenario will occur when Participant dies and we create survivors payee account and before getting first payment survivor dies,
                    //in that case we Create Post Retirement Calculation Of Contingent Ben of participant

                    this.ibusParticipant.LoadPersonAccounts();

                    DataTable ldtbParticipantPayeeAccount = busBase.Select("cdoPayeeAccount.GetDeceasedParticipantsPayeeAccount", new Object[2] { this.ibusParticipant.icdoPerson.person_id,
                                                                    this.icdoPayeeAccount.iintPlanId});
                    Collection<busPayeeAccount> lclbParticipantPayeeAccount = new Collection<busPayeeAccount>();
                    if (ldtbParticipantPayeeAccount.Rows.Count > 0)
                    {
                        lclbParticipantPayeeAccount = GetCollection<busPayeeAccount>(ldtbParticipantPayeeAccount, "icdoPayeeAccount");

                        if (lclbParticipantPayeeAccount != null && lclbParticipantPayeeAccount.Count > 0)
                        {
                            busWorkflowHelper.InitializeWorkflowIfNotExists(busConstant.POSTRETIREMENT_DEATH_WORKFLOW_NAME, this.ibusParticipant.icdoPerson.person_id, 0, lclbParticipantPayeeAccount.FirstOrDefault().icdoPayeeAccount.payee_account_id, null);
                        }
                    }

                    lobjError = AddError(6201, "");
                    this.iarrErrors.Add(lobjError);
                    return iarrErrors;
                }
            }

            return iarrErrors;
            //}
        }

        public busBenefitCalculationHeader RecalculateBenefitsForLateHours(bool ablnPostRetrDeath = false)
        {
            busBenefitCalculationHeader lbusBenefitCalculationHeader = new busBenefitCalculationHeader();

            utlConnection utlLegacyDBConnetion = HelperFunction.GetDBConnectionProperties("Legacy");
            string lstrLegacyDBConnetion = utlLegacyDBConnetion.istrConnectionString;

            SqlParameter[] lsqlParameters = new SqlParameter[2];
            SqlParameter param1 = new SqlParameter("@SSN", DbType.String);
            SqlParameter param2 = new SqlParameter("@RETIREMENT_DATE", DbType.DateTime);

            param1.Value = this.ibusPayee.icdoPerson.istrSSNNonEncrypted;
            lsqlParameters[0] = param1;

            param2.Value = this.icdoPayeeAccount.idtRetireMentDate;
            lsqlParameters[1] = param2;

            DataTable ldtGetHoursProcessedAfterRetirementDate = busGlobalFunctions.ExecuteSPtoGetDataTable("usp_HoursAfterRetirement", lstrLegacyDBConnetion, null, lsqlParameters);

            if (ldtGetHoursProcessedAfterRetirementDate != null && ldtGetHoursProcessedAfterRetirementDate.Rows.Count > 0)
            {
                if (ldtGetHoursProcessedAfterRetirementDate.Select("toDate" + "<= '" + this.icdoPayeeAccount.idtRetireMentDate + "'").Count() > 0)
                {
                    if (this.icdoPayeeAccount.benefit_account_type_value == busConstant.BENEFIT_TYPE_RETIREMENT)
                    {
                        lbusBenefitCalculationHeader = ReCalculateBenefitForRetirement(this.icdoPayeeAccount.istrBenefitOptionValue, lblnDoInsert: false, ablnRefreshCalculationFinal: false, ablnPostRetDeath: ablnPostRetrDeath);
                    }
                    else if (icdoPayeeAccount.benefit_account_type_value == busConstant.BENEFIT_TYPE_DISABILITY)
                    {
                        lbusBenefitCalculationHeader = RecalculateParticipantDisabilityBenefits(this.icdoPayeeAccount.istrBenefitOptionValue, lblnDoInsert: false, ablnRefreshCalculationFinal: false, ablnPostRetrDeath: ablnPostRetrDeath);
                    }
                    else if (icdoPayeeAccount.benefit_account_type_value == busConstant.BENEFIT_TYPE_WITHDRAWAL)
                    {
                        lbusBenefitCalculationHeader = ReCalculateBenefitForWithdrawl(lblnDoInsert: false, ablnRefreshCalculationFinal: false);
                    }

                }

            }

            return lbusBenefitCalculationHeader;

        }

        public ArrayList CalculateSurvivorAmountForConversion()
        {

            busBenefitApplicationDetail lbusBenefitApplicationDetail = new busBenefitApplicationDetail();

            utlError lobjError = null;

            string lstrBenefitOptionValue = string.Empty;
            decimal ldecSurvivorPercent = busConstant.ZERO_DECIMAL;
            decimal ldecParticipantAmount = busConstant.ZERO_DECIMAL;
            decimal ldecSurvivorAmount = busConstant.ZERO_DECIMAL;

            int lintpersonAccountId = 0;
            int lintBeneficiaryPersonId = 0;
            int lintBeneficiaryOrgId = 0;
            string lstrSurvivorRelationship = string.Empty;
            bool lblnFlagContingent = false;


            #region Compute Survivor Amount
            if (lbusBenefitApplicationDetail.FindBenefitApplicationDetail(icdoPayeeAccount.benefit_application_detail_id))
            {
                this.ibusBenefitApplication = new busBenefitApplication { icdoBenefitApplication = new cdoBenefitApplication() };
                this.ibusBenefitApplication.FindBenefitApplication(lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.benefit_application_id);

                if (this.icdoPayeeAccount.benefit_application_detail_id > 0)
                {

                    lbusBenefitApplicationDetail.LoadBenefitApplication();
                    DataTable ldtbBenefitOptionValue = lbusBenefitApplicationDetail.ibusBenefitApplication.GetPlanAndBenefitOptionValue(this.icdoPayeeAccount.plan_benefit_id);
                    if (ldtbBenefitOptionValue.Rows.Count > 0)
                    {
                        lstrBenefitOptionValue = Convert.ToString(ldtbBenefitOptionValue.Rows[0][1]);
                    }

                    this.LoadNextBenefitPaymentDate();
                    decimal ldecTaxableAmount = decimal.Zero;
                    decimal ldecNonTaxableAmount = decimal.Zero;
                    this.ibusCalculation.GetTaxableAndNonTaxableAmountFromPaymentItemTypes(this, out ldecTaxableAmount, out ldecNonTaxableAmount);
                    ldecParticipantAmount = ldecTaxableAmount + ldecNonTaxableAmount;
                    //DataTable ldtblParticipantAmount = busBase.Select("cdoQdroCalculationHeader.GetBenefitAmount", new object[] { this.icdoPayeeAccount.payee_account_id,
                    //                      this.idtNextBenefitPaymentDate});
                    if (ldecParticipantAmount > 0)
                    {
                        if (lstrBenefitOptionValue == "QJ50" || lstrBenefitOptionValue == "QJSA")
                            ldecSurvivorAmount = (ldecParticipantAmount / 100) * 50;

                        else if (lstrBenefitOptionValue == "JS75")

                            ldecSurvivorAmount = (ldecParticipantAmount / 100) * 75;

                        else if (lstrBenefitOptionValue == "JA66" || lstrBenefitOptionValue == "JS66")

                            ldecSurvivorAmount = (ldecParticipantAmount / 100) * Convert.ToDecimal(66.67);

                        else if (lstrBenefitOptionValue == "J100" || lstrBenefitOptionValue == "JSAA" || lstrBenefitOptionValue == busConstant.TEN_YEARS_CERTAIN_AND_LIFE_ANNUTIY || lstrBenefitOptionValue == busConstant.TWO_YEARS_CERTAIN_AND_LIFE_ANNUITY ||
                            lstrBenefitOptionValue == busConstant.THREE_YEARS_CERTAIN_AND_LIFE_ANNUITY || lstrBenefitOptionValue == busConstant.FIVE_YEARS_CERTAIN_AND_LIFE_ANNUTIY)

                            ldecSurvivorAmount = ldecParticipantAmount;
                    }
                }
            }
            #endregion


            if (this.ibusPayee.icdoPerson.person_id == this.ibusParticipant.icdoPerson.person_id)
            {
                ibusPayee.LoadPersonAccounts();

                lintpersonAccountId = this.ibusPayee.iclbPersonAccount.Where(item => item.icdoPersonAccount.plan_id == this.icdoPayeeAccount.iintPlanId).First().icdoPersonAccount.person_account_id;
                if ((lbusBenefitApplicationDetail != null && lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.joint_annuitant_id > 0) ||
                                 this.icdoPayeeAccount.term_certain_end_date != DateTime.MinValue)
                {
                    DataTable ldtbBeneficiaryDetails = busBase.Select("cdoPersonAccountBeneficiary.GetBeneficiaryDetails", new Object[1] { lintpersonAccountId });
                    if (ldtbBeneficiaryDetails.Rows.Count > 0 && this.ibusBenefitApplication != null)
                    {
                        foreach (DataRow ldrBeneficiaryDetail in ldtbBeneficiaryDetails.Rows)
                        {

                            #region Beneficiary Type Primary

                            if (Convert.ToString(ldrBeneficiaryDetail[enmPersonAccountBeneficiary.beneficiary_type_value.ToString().ToUpper()]) == busConstant.BENEFICIARY_TYPE_PRIMARY
                                && Convert.ToString(ldrBeneficiaryDetail[enmRelationship.beneficiary_person_id.ToString().ToUpper()]).IsNotNullOrEmpty())
                            {
                                bool lblnInsertPrimaryBen = false;
                                if ((lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.joint_annuitant_id == Convert.ToInt32(ldrBeneficiaryDetail[enmRelationship.beneficiary_person_id.ToString().ToUpper()]) && this.ibusPayee.icdoPerson.person_id == this.ibusParticipant.icdoPerson.person_id) ||
                                     (lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.joint_annuitant_id <= 0 && this.icdoPayeeAccount.term_certain_end_date != DateTime.MinValue))
                                {
                                    lblnInsertPrimaryBen = true;

                                    if (lblnInsertPrimaryBen)
                                    {
                                        if (Convert.ToString(ldrBeneficiaryDetail[enmPerson.date_of_death.ToString().ToUpper()]).IsNullOrEmpty())
                                        {

                                            lintBeneficiaryPersonId = Convert.ToInt32(ldrBeneficiaryDetail[enmRelationship.beneficiary_person_id.ToString().ToUpper()]);
                                            lstrSurvivorRelationship = Convert.ToString(ldrBeneficiaryDetail[enmRelationship.relationship_value.ToString().ToUpper()]);
                                            ldecSurvivorPercent = Convert.ToDecimal(ldrBeneficiaryDetail[enmPersonAccountBeneficiary.dist_percent.ToString().ToUpper()]);


                                            if (this.icdoPayeeAccount.iintPlanId != busConstant.IAP_PLAN_ID)
                                            {

                                                InsertBenefitCalculationDetailsForConversion(lbusBenefitApplicationDetail, lintBeneficiaryPersonId, 0, busConstant.BENEFICIARY_TYPE_PRIMARY, lstrSurvivorRelationship, ldecSurvivorPercent, ldecSurvivorAmount, lintpersonAccountId);
                                            }
                                            else
                                            {
                                                //    bool lblnCheck = GetIAPSpecialAccountBalance(lbusBenefitCalculationDetail, lbusBenefitCalculationOptions, lbusBenefitApplicationDetail, lintBeneficiaryPersonId, 0, busConstant.BENEFICIARY_TYPE_PRIMARY, lstrSurvivorRelationship, ldecSurvivorPercent);
                                                //    if (!lblnCheck)
                                                //    {
                                                //        lobjError = AddError(5504, "");
                                                //        this.iarrErrors.Add(lobjError);
                                                return iarrErrors;
                                                //    }
                                            }

                                            //if (lclbLocal52SpAccountPayeeAccount != null)
                                            //{
                                            //    InsertSpecialAccountsCalculationDetails(this.ibusPayee, lintBeneficiaryPersonId, 0, busConstant.BENEFICIARY_TYPE_PRIMARY, lstrSurvivorRelationship, ldecSurvivorPercent,
                                            //                lclbLocal52SpAccountPayeeAccount, lclbLocal161SpAccountPayeeAccount);
                                            //}

                                            //if (lclbLocal161SpAccountPayeeAccount != null)
                                            //{
                                            //    InsertSpecialAccountsCalculationDetails(this.ibusPayee, lintBeneficiaryPersonId, 0, busConstant.BENEFICIARY_TYPE_PRIMARY, lstrSurvivorRelationship, ldecSurvivorPercent,
                                            //                lclbLocal52SpAccountPayeeAccount, lclbLocal161SpAccountPayeeAccount);
                                            //}
                                            break;

                                        }

                                    }
                                }
                                if (!lblnFlagContingent)
                                {
                                    lobjError = AddError(5495, " ");
                                    this.iarrErrors.Add(lobjError);
                                    return iarrErrors;
                                }
                            }
                            #endregion
                            #region Beneficiary Type Contingent
                            if (Convert.ToString(ldrBeneficiaryDetail[enmPersonAccountBeneficiary.beneficiary_type_value.ToString().ToUpper()]) == busConstant.BENEFICIARY_TYPE_CONTINGENT)
                            {
                                if (Convert.ToString(ldrBeneficiaryDetail[enmRelationship.beneficiary_person_id.ToString().ToUpper()]).IsNotNullOrEmpty())
                                {
                                    if (Convert.ToString(ldrBeneficiaryDetail[enmPerson.date_of_death.ToString().ToUpper()]).IsNullOrEmpty())
                                    {

                                        lintBeneficiaryPersonId = Convert.ToInt32(ldrBeneficiaryDetail[enmRelationship.beneficiary_person_id.ToString().ToUpper()]);
                                        lstrSurvivorRelationship = Convert.ToString(ldrBeneficiaryDetail[enmRelationship.relationship_value.ToString().ToUpper()]);
                                        ldecSurvivorPercent = Convert.ToDecimal(ldrBeneficiaryDetail[enmPersonAccountBeneficiary.dist_percent.ToString().ToUpper()]);
                                        if (this.icdoPayeeAccount.iintPlanId != busConstant.IAP_PLAN_ID)
                                        {

                                            InsertBenefitCalculationDetailsForConversion(lbusBenefitApplicationDetail, lintBeneficiaryPersonId, 0, busConstant.BENEFICIARY_TYPE_PRIMARY, lstrSurvivorRelationship, ldecSurvivorPercent, ldecSurvivorAmount, lintpersonAccountId);
                                        }
                                        else
                                        {
                                            //IAP  and Locals

                                        }

                                    }
                                    lblnFlagContingent = true;

                                }
                                else if ((Convert.ToString(ldrBeneficiaryDetail[enmRelationship.beneficiary_org_id.ToString().ToUpper()]).IsNotNullOrEmpty()))
                                {
                                    lintBeneficiaryOrgId = Convert.ToInt32(ldrBeneficiaryDetail[enmRelationship.beneficiary_org_id.ToString().ToUpper()]);
                                    lstrSurvivorRelationship = Convert.ToString(ldrBeneficiaryDetail[enmRelationship.relationship_value.ToString().ToUpper()]);
                                    ldecSurvivorPercent = Convert.ToDecimal(ldrBeneficiaryDetail[enmPersonAccountBeneficiary.dist_percent.ToString().ToUpper()]);
                                    if (this.icdoPayeeAccount.iintPlanId != busConstant.IAP_PLAN_ID)
                                    {
                                        InsertBenefitCalculationDetailsForConversion(lbusBenefitApplicationDetail, 0, lintBeneficiaryOrgId, busConstant.BENEFICIARY_TYPE_CONTINGENT, lstrSurvivorRelationship, ldecSurvivorPercent, ldecSurvivorAmount, lintpersonAccountId);

                                    }
                                    else
                                    {
                                        //IAP  and Locals


                                    }
                                    lblnFlagContingent = true;


                                }
                                if (!lblnFlagContingent)
                                {
                                    lobjError = AddError(5495, " ");
                                    this.iarrErrors.Add(lobjError);
                                    return iarrErrors;
                                }

                            }
                            #endregion
                        }

                    }

                }
            }
            else
            {
                lobjError = AddError(5496, " ");
                this.iarrErrors.Add(lobjError);
                return iarrErrors;
            }
            return iarrErrors;

        }


        public bool GetIAPSpecialAccountBalanceForContingent(busBenefitCalculationDetail abusBenefitCalculationDetail, busBenefitCalculationOptions lbusBenefitCalculationOptions, busBenefitApplicationDetail lbusBenefitApplicationDetail, int aintBeneficiaryPersonId, int aintBeneficiaryOrgId, string astrBeneficiaryTypeValue, string astrSurvivorRelation, decimal adecSurvivorPercentage,
           busPayeeAccount abusParticipantPayeeAccount, busBenefitCalculationHeader aParticipantBenefitCalculationHeader)
        {
            DataTable ldtblLocal52SpAccountPayeeAccount = new DataTable();
            DataTable ldtblLocal161SpAccountPayeeAccount = new DataTable();
            bool lblnIAPFlag = false;
            bool lblnL52Flag = false;
            bool lblnL161Flag = false;

            if (abusBenefitCalculationDetail.icdoBenefitCalculationDetail.plan_id == busConstant.IAP_PLAN_ID)
            {

                if (abusParticipantPayeeAccount.iclbPayeeAccountStatus.Where(item => item.icdoPayeeAccountStatus.status_value == busConstant.PAYEE_ACCOUNT_STATUS_RECEIVING).Count() == 0)
                {
                    lblnIAPFlag = true;
                }

                if (abusParticipantPayeeAccount.ibusPayee.iclbPersonAccount.IsNotNull() && abusParticipantPayeeAccount.ibusPayee.iclbPersonAccount.Where(item => item.icdoPersonAccount.plan_id == busConstant.LOCAL_52_PLAN_ID && item.icdoPersonAccount.special_account == busConstant.FLAG_YES).Count() > 0)
                {
                    ldtblLocal52SpAccountPayeeAccount = Select("cdoBenefitCalculationHeader.GetL52SpAccntPayeeAccount", new object[1] { this.icdoPayeeAccount.person_id });
                    if (ldtblLocal52SpAccountPayeeAccount.Rows.Count == 0)
                    {
                        lblnL52Flag = true;

                    }
                }

                if (abusParticipantPayeeAccount.ibusPayee.iclbPersonAccount.IsNotNull() && abusParticipantPayeeAccount.ibusPayee.iclbPersonAccount.Where(item => item.icdoPersonAccount.plan_id == busConstant.LOCAL_161_PLAN_ID && item.icdoPersonAccount.special_account == busConstant.FLAG_YES).Count() > 0)
                {
                    ldtblLocal161SpAccountPayeeAccount = Select("cdoBenefitCalculationHeader.GetL161SpAccntPayeeAccount", new object[1] { abusParticipantPayeeAccount.icdoPayeeAccount.person_id });
                    if (ldtblLocal161SpAccountPayeeAccount.Rows.Count == 0)
                    {
                        lblnL161Flag = true;

                    }
                }

                if (!lblnL52Flag && !lblnL161Flag && !lblnIAPFlag)
                {
                    return false;
                    //lobjError = AddError(5504, "");
                    //this.iarrErrors.Add(lobjError);
                    //return iarrErrors;
                }
                else
                {
                    busBenefitCalculationPostRetirementDeath lbusBenefitCalculationPostRetirementDeath = null;
                    if (lblnIAPFlag)
                    {
                        if (lbusBenefitCalculationPostRetirementDeath.IsNull())
                        {
                            lbusBenefitCalculationPostRetirementDeath = new busBenefitCalculationPostRetirementDeath { icdoBenefitCalculationHeader = new cdoBenefitCalculationHeader() };
                            lbusBenefitCalculationPostRetirementDeath = CreateHeaderObject(abusParticipantPayeeAccount, aintBeneficiaryPersonId, aintBeneficiaryOrgId, adecSurvivorPercentage);
                        }
                        CreateDetailObjectForIapPlan(lbusBenefitCalculationPostRetirementDeath, abusBenefitCalculationDetail);
                        CreateOptionsObjectForIapPlan(lbusBenefitCalculationPostRetirementDeath, abusBenefitCalculationDetail, aintBeneficiaryPersonId, astrBeneficiaryTypeValue, astrSurvivorRelation, adecSurvivorPercentage);


                    }
                    if (lblnL161Flag)
                    {
                        if (lbusBenefitCalculationPostRetirementDeath.IsNull())
                        {
                            lbusBenefitCalculationPostRetirementDeath = new busBenefitCalculationPostRetirementDeath { icdoBenefitCalculationHeader = new cdoBenefitCalculationHeader() };
                            CreateHeaderObject(abusParticipantPayeeAccount, aintBeneficiaryPersonId, aintBeneficiaryOrgId, adecSurvivorPercentage);
                        }

                    }
                    if (lblnL52Flag)
                    {
                        if (lbusBenefitCalculationPostRetirementDeath.IsNull())
                        {
                            lbusBenefitCalculationPostRetirementDeath = new busBenefitCalculationPostRetirementDeath { icdoBenefitCalculationHeader = new cdoBenefitCalculationHeader() };
                            CreateHeaderObject(abusParticipantPayeeAccount, aintBeneficiaryPersonId, aintBeneficiaryOrgId, adecSurvivorPercentage);
                        }
                    }
                    return true;

                }

            }
            return false;
            //if (ldtblLocal52SpAccountPayeeAccount.Rows.Count > 0)
            //{
            //    lclbLocal52SpAccountPayeeAccount = new Collection<busPayeeAccount>();
            //    lclbLocal52SpAccountPayeeAccount = GetCollection<busPayeeAccount>(ldtblLocal52SpAccountPayeeAccount, "icdoPayeeAccount");
            //}

            //if (ldtblLocal161SpAccountPayeeAccount.Rows.Count > 0)
            //{
            //    lclbLocal161SpAccountPayeeAccount = new Collection<busPayeeAccount>();
            //    lclbLocal161SpAccountPayeeAccount = GetCollection<busPayeeAccount>(ldtblLocal161SpAccountPayeeAccount, "icdoPayeeAccount");
            //}
        }

        public bool GetIAPSpecialAccountBalance(busBenefitCalculationDetail abusBenefitCalculationDetail, busBenefitCalculationOptions lbusBenefitCalculationOptions, busBenefitApplicationDetail lbusBenefitApplicationDetail, int aintBeneficiaryPersonId, int aintBeneficiaryOrgId, string astrBeneficiaryTypeValue, string astrSurvivorRelation, decimal adecSurvivorPercentage
            )
        {
            DataTable ldtblLocal52SpAccountPayeeAccount = new DataTable();
            DataTable ldtblLocal161SpAccountPayeeAccount = new DataTable();
            bool lblnIAPFlag = false;
            bool lblnL52Flag = false;
            bool lblnL161Flag = false;

            if (abusBenefitCalculationDetail.icdoBenefitCalculationDetail.plan_id == busConstant.IAP_PLAN_ID)
            {

                if (this.iclbPayeeAccountStatus.Where(item => item.icdoPayeeAccountStatus.status_value == busConstant.PAYEE_ACCOUNT_STATUS_RECEIVING).Count() == 0)
                {
                    lblnIAPFlag = true;
                }

                if (this.ibusPayee.iclbPersonAccount.IsNotNull() && this.ibusPayee.iclbPersonAccount.Where(item => item.icdoPersonAccount.plan_id == busConstant.LOCAL_52_PLAN_ID && item.icdoPersonAccount.special_account == busConstant.FLAG_YES).Count() > 0)
                {
                    ldtblLocal52SpAccountPayeeAccount = Select("cdoBenefitCalculationHeader.GetL52SpAccntPayeeAccount", new object[1] { this.icdoPayeeAccount.person_id });
                    if (ldtblLocal52SpAccountPayeeAccount.Rows.Count == 0)
                    {
                        lblnL52Flag = true;

                    }
                }

                if (this.ibusPayee.iclbPersonAccount.IsNotNull() && this.ibusPayee.iclbPersonAccount.Where(item => item.icdoPersonAccount.plan_id == busConstant.LOCAL_161_PLAN_ID && item.icdoPersonAccount.special_account == busConstant.FLAG_YES).Count() > 0)
                {
                    ldtblLocal161SpAccountPayeeAccount = Select("cdoBenefitCalculationHeader.GetL161SpAccntPayeeAccount", new object[1] { this.icdoPayeeAccount.person_id });
                    if (ldtblLocal161SpAccountPayeeAccount.Rows.Count == 0)
                    {
                        lblnL161Flag = true;

                    }
                }

                if (!lblnL52Flag && !lblnL161Flag && !lblnIAPFlag)
                {
                    return false;
                    //lobjError = AddError(5504, "");
                    //this.iarrErrors.Add(lobjError);
                    //return iarrErrors;
                }
                else
                {
                    busBenefitCalculationPostRetirementDeath lbusBenefitCalculationPostRetirementDeath = null;
                    if (lblnIAPFlag)
                    {
                        if (lbusBenefitCalculationPostRetirementDeath.IsNull())
                        {
                            lbusBenefitCalculationPostRetirementDeath = new busBenefitCalculationPostRetirementDeath { icdoBenefitCalculationHeader = new cdoBenefitCalculationHeader() };
                            lbusBenefitCalculationPostRetirementDeath = CreateHeaderObject(this, aintBeneficiaryPersonId, aintBeneficiaryOrgId, adecSurvivorPercentage);
                        }
                        CreateDetailObjectForIapPlan(lbusBenefitCalculationPostRetirementDeath, abusBenefitCalculationDetail);
                        CreateOptionsObjectForIapPlan(lbusBenefitCalculationPostRetirementDeath, abusBenefitCalculationDetail, aintBeneficiaryPersonId, astrBeneficiaryTypeValue, astrSurvivorRelation, adecSurvivorPercentage);


                    }
                    if (lblnL161Flag)
                    {
                        if (lbusBenefitCalculationPostRetirementDeath.IsNull())
                        {
                            lbusBenefitCalculationPostRetirementDeath = new busBenefitCalculationPostRetirementDeath { icdoBenefitCalculationHeader = new cdoBenefitCalculationHeader() };
                            CreateHeaderObject(this, aintBeneficiaryPersonId, aintBeneficiaryOrgId, adecSurvivorPercentage);
                        }

                    }
                    if (lblnL52Flag)
                    {
                        if (lbusBenefitCalculationPostRetirementDeath.IsNull())
                        {
                            lbusBenefitCalculationPostRetirementDeath = new busBenefitCalculationPostRetirementDeath { icdoBenefitCalculationHeader = new cdoBenefitCalculationHeader() };
                            CreateHeaderObject(this, aintBeneficiaryPersonId, aintBeneficiaryOrgId, adecSurvivorPercentage);
                        }
                    }
                    return true;

                }

            }
            return false;
            //if (ldtblLocal52SpAccountPayeeAccount.Rows.Count > 0)
            //{
            //    lclbLocal52SpAccountPayeeAccount = new Collection<busPayeeAccount>();
            //    lclbLocal52SpAccountPayeeAccount = GetCollection<busPayeeAccount>(ldtblLocal52SpAccountPayeeAccount, "icdoPayeeAccount");
            //}

            //if (ldtblLocal161SpAccountPayeeAccount.Rows.Count > 0)
            //{
            //    lclbLocal161SpAccountPayeeAccount = new Collection<busPayeeAccount>();
            //    lclbLocal161SpAccountPayeeAccount = GetCollection<busPayeeAccount>(ldtblLocal161SpAccountPayeeAccount, "icdoPayeeAccount");
            //}
        }

        public busBenefitCalculationPostRetirementDeath CreateHeaderObject(busPayeeAccount abusPayeeAccount, int aintBeneficiaryPersonId, int aintBeneficiaryOrgId, decimal adecSurvivorPercentage)
        {
            busBenefitCalculationPostRetirementDeath lbusBenefitCalculationPostRetirementDeath = new busBenefitCalculationPostRetirementDeath { icdoBenefitCalculationHeader = new cdoBenefitCalculationHeader() };

            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.person_id = this.ibusParticipant.icdoPerson.person_id;

            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.calculation_type_id = busConstant.BenefitCalculation.CALCULATION_TYPE_CODE_ID;
            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.calculation_type_value = busConstant.BenefitCalculation.CALCULATION_TYPE_FINAL;
            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.benefit_type_id = busConstant.BENEFIT_TYPE_CODE_ID;
            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.benefit_type_value = busConstant.BENEFIT_TYPE_DEATH_POST_RETIREMENT;//DOPR DDPT
            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.status_id = busConstant.BenefitCalculation.CALCULATION_STATUS_TYPE_CODE_ID;
            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.status_value = busConstant.BenefitCalculation.CALCULATION_STATUS_TYPE_PENDING;
            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.survivor_percentage = adecSurvivorPercentage;
            if (abusPayeeAccount != null)
            {
                {
                    lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.payee_account_id = abusPayeeAccount.icdoPayeeAccount.payee_account_id;
                    lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.retirement_date = abusPayeeAccount.ibusBenefitApplication.icdoBenefitApplication.retirement_date;
                    lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.benefit_application_id = abusPayeeAccount.ibusBenefitApplication.icdoBenefitApplication.benefit_application_id;
                    lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.age = abusPayeeAccount.ibusBenefitCalculationHeader.icdoBenefitCalculationHeader.age;
                    lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.date_of_death = this.ibusPayee.icdoPerson.date_of_death;
                }
                busPerson lbusSurvivorPerson = new busPerson { icdoPerson = new cdoPerson() };
                if (aintBeneficiaryPersonId > 0)
                {
                    if (lbusSurvivorPerson.FindPerson(aintBeneficiaryPersonId))
                    {
                        lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.beneficiary_person_id = aintBeneficiaryPersonId;
                        lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.beneficiary_person_name = lbusSurvivorPerson.icdoPerson.istrFullName;
                        lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.beneficiary_person_date_of_birth = lbusSurvivorPerson.icdoPerson.idtDateofBirth;
                    }
                }
                else
                {
                    busOrganization lbusSurvivorOrg = new busOrganization { icdoOrganization = new cdoOrganization() };
                    if (lbusSurvivorOrg.FindOrganization(aintBeneficiaryOrgId))
                    {
                        lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.organization_id = aintBeneficiaryOrgId;
                    }

                }
                lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.Insert();
                lbusBenefitCalculationPostRetirementDeath.iclbBenefitCalculationDetail = new Collection<busBenefitCalculationDetail>();

            }
            return lbusBenefitCalculationPostRetirementDeath;
        }

        public void CreateDetailObjectForIapPlan(busBenefitCalculationPostRetirementDeath abusBenefitCalculationPostRetirementDeath, busBenefitCalculationDetail abusBenefitCalculationDetail)
        {

            busBenefitCalculationDetail lbusPostRetirementDeathBenefitCalculationDetail = new busBenefitCalculationDetail { icdoBenefitCalculationDetail = new cdoBenefitCalculationDetail() };

            lbusPostRetirementDeathBenefitCalculationDetail.icdoBenefitCalculationDetail.benefit_application_detail_id = this.icdoPayeeAccount.benefit_application_detail_id;
            lbusPostRetirementDeathBenefitCalculationDetail.icdoBenefitCalculationDetail.status_id = busConstant.BenefitCalculation.CALCULATION_STATUS_TYPE_CODE_ID;
            lbusPostRetirementDeathBenefitCalculationDetail.icdoBenefitCalculationDetail.status_value = busConstant.BenefitCalculation.CALCULATION_STATUS_TYPE_PENDING;

            lbusPostRetirementDeathBenefitCalculationDetail.icdoBenefitCalculationDetail.plan_id = this.icdoPayeeAccount.iintPlanId;
            lbusPostRetirementDeathBenefitCalculationDetail.icdoBenefitCalculationDetail.person_account_id = abusBenefitCalculationDetail.icdoBenefitCalculationDetail.person_account_id;

            lbusPostRetirementDeathBenefitCalculationDetail.icdoBenefitCalculationDetail.local52_special_acct_bal_amount = abusBenefitCalculationDetail.icdoBenefitCalculationDetail.local52_special_acct_bal_amount;
            lbusPostRetirementDeathBenefitCalculationDetail.icdoBenefitCalculationDetail.local161_special_acct_bal_amount = abusBenefitCalculationDetail.icdoBenefitCalculationDetail.local161_special_acct_bal_amount;

            lbusPostRetirementDeathBenefitCalculationDetail.icdoBenefitCalculationDetail.ee_flag = abusBenefitCalculationDetail.icdoBenefitCalculationDetail.ee_flag;
            lbusPostRetirementDeathBenefitCalculationDetail.icdoBenefitCalculationDetail.uvhp_flag = abusBenefitCalculationDetail.icdoBenefitCalculationDetail.uvhp_flag;
            lbusPostRetirementDeathBenefitCalculationDetail.icdoBenefitCalculationDetail.l52_spl_acc_flag = busConstant.FLAG_NO;
            lbusPostRetirementDeathBenefitCalculationDetail.icdoBenefitCalculationDetail.l161_spl_acc_flag = busConstant.FLAG_NO;

            abusBenefitCalculationPostRetirementDeath.iclbBenefitCalculationDetail.Add(lbusPostRetirementDeathBenefitCalculationDetail);

            lbusPostRetirementDeathBenefitCalculationDetail.icdoBenefitCalculationDetail.benefit_calculation_header_id = abusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.benefit_calculation_header_id;
            lbusPostRetirementDeathBenefitCalculationDetail.icdoBenefitCalculationDetail.Insert();

        }

        public void CreateOptionsObjectForIapPlan(busBenefitCalculationPostRetirementDeath abusBenefitCalculationPostRetirementDeath, busBenefitCalculationDetail abusBenefitCalculationDetailExisting, int aintBeneficiaryPersonId, string astrBeneficiaryTypeValue, string astrSurvivorRelation, decimal adecSurvivorPercentage)
        {
            #region Benefit Calculation Options

            LoadPaymentHistoryHeaderDetails();
            decimal ldecMinimumGuarentee = idecRemainingMinimumGuaranteeAmount;
            string lstrBenefitOptionValue = string.Empty;
            //DataTable ltblBenefitOptionValue = lbusBenefitApplication.GetPlanAndBenefitOptionValue(this.icdoPayeeAccount.plan_benefit_id);

            //if (ltblBenefitOptionValue.Rows.Count > 0)
            //{
            //    lstrBenefitOptionValue = Convert.ToString(ltblBenefitOptionValue.Rows[0][1]);
            //}

            busBenefitCalculationDetail lbusBenefitCalculationDetail = abusBenefitCalculationPostRetirementDeath.iclbBenefitCalculationDetail[0];
            lbusBenefitCalculationDetail.iclbBenefitCalculationOptions = new Collection<busBenefitCalculationOptions>();


            busBenefitCalculationOptions lbusBenefitCalculationOptions = new busBenefitCalculationOptions { icdoBenefitCalculationOptions = new cdoBenefitCalculationOptions() };
            lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.benefit_calculation_detail_id = lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.benefit_calculation_detail_id;

            lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.account_relationship_id = busConstant.BenefitCalculation.ACCOUNT_RELATIONSHIP_CODE_ID;

            if (aintBeneficiaryPersonId > 0 && astrBeneficiaryTypeValue == busConstant.BENEFICIARY_TYPE_PRIMARY)
            {
                lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.account_relationship_value = busConstant.BenefitCalculation.ACCOUNT_RELATIONSHIP_JOINT_ANNUITANT;
            }
            else
            {
                lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.account_relationship_value = busConstant.BenefitCalculation.ACCOUNT_RELATIONSHIP_BENEFICIARY;
            }

            lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.survivor_relationship_id = busConstant.BENEFICIARY_RELATIONSHIP_CODE_ID;
            lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.survivor_relationship_value = astrSurvivorRelation;

            if (astrBeneficiaryTypeValue == busConstant.BENEFICIARY_TYPE_PRIMARY)
            {
                lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.plan_benefit_id = this.icdoPayeeAccount.plan_benefit_id;
                if (lstrBenefitOptionValue == busConstant.TEN_YEARS_CERTAIN_AND_LIFE_ANNUTIY || lstrBenefitOptionValue == busConstant.TWO_YEARS_CERTAIN_AND_LIFE_ANNUITY ||
                    lstrBenefitOptionValue == busConstant.THREE_YEARS_CERTAIN_AND_LIFE_ANNUITY || lstrBenefitOptionValue == busConstant.FIVE_YEARS_CERTAIN_AND_LIFE_ANNUTIY)
                {
                    DataTable ldtbSurvivorAmt = busBase.Select("cdoPersonAccountBeneficiary.GetAmountForTermCertain", new object[1] { lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.benefit_calculation_detail_id });
                    if (ldtbSurvivorAmt.Rows.Count > 0 && Convert.ToString(ldtbSurvivorAmt.Rows[0][0]).IsNotNullOrEmpty())
                    {
                        lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.survivor_amount = Convert.ToInt32(ldtbSurvivorAmt.Rows[0][0]);
                    }
                }
                else
                {
                    lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.plan_benefit_id = this.icdoPayeeAccount.plan_benefit_id;

                    DataTable ldtbSurvivorAmt = busBase.Select("cdoPersonAccountBeneficiary.GetSurvivorAmount", new object[1] { abusBenefitCalculationDetailExisting.icdoBenefitCalculationDetail.benefit_calculation_detail_id });
                    if (ldtbSurvivorAmt.Rows.Count > 0)
                    {
                        lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.survivor_amount = Convert.ToInt32(ldtbSurvivorAmt.Rows[0]["SURVIVOR_AMOUNT"]);
                    }
                }
            }
            else
            {
                if (lstrBenefitOptionValue == busConstant.TEN_YEARS_CERTAIN_AND_LIFE_ANNUTIY || lstrBenefitOptionValue == busConstant.TWO_YEARS_CERTAIN_AND_LIFE_ANNUITY ||
                   lstrBenefitOptionValue == busConstant.THREE_YEARS_CERTAIN_AND_LIFE_ANNUITY || lstrBenefitOptionValue == busConstant.FIVE_YEARS_CERTAIN_AND_LIFE_ANNUTIY)
                {
                    lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.plan_benefit_id = this.icdoPayeeAccount.plan_benefit_id;
                    DataTable ldtbSurvivorAmt = busBase.Select("cdoPersonAccountBeneficiary.GetAmountForTermCertain", new object[1] { lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.benefit_calculation_detail_id });
                    if (ldtbSurvivorAmt.Rows.Count > 0 && Convert.ToString(ldtbSurvivorAmt.Rows[0][0]).IsNotNullOrEmpty())
                    {
                        lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.survivor_amount = (Convert.ToInt32(ldtbSurvivorAmt.Rows[0][0]) / 100) * adecSurvivorPercentage;
                    }
                }
                else
                {
                    //lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.plan_benefit_id = lbusCalculation.GetPlanBenefitId(this.icdoPayeeAccount.iintPlanId, busConstant.LUMP_SUM);
                    if (aintBeneficiaryPersonId > 0)
                    {
                        lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.survivor_amount = (ldecMinimumGuarentee / 100) * adecSurvivorPercentage;
                    }
                }
            }

            lbusBenefitCalculationDetail.iclbBenefitCalculationOptions.Add(lbusBenefitCalculationOptions);

            lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.Insert();

            #endregion

        }

        public void InsertSpecialAccountsCalculationDetails(busPerson abusPerson, int aintBeneficiaryPersonId, int aintBeneficiaryOrgId, string astrBeneficiaryTypeValue, string astrSurvivorRelation, decimal adecSurvivorPercentage,
            Collection<busPayeeAccount> aclbLocal52SpAccountPayeeAccount = null, Collection<busPayeeAccount> aclbLocal161SpAccountPayeeAccount = null)
        {


            busPayeeAccount lbusPayeeAccount = new busPayeeAccount();
            if (aclbLocal52SpAccountPayeeAccount != null)
            {
                lbusPayeeAccount = aclbLocal52SpAccountPayeeAccount.First();
            }
            else
            {
                lbusPayeeAccount = aclbLocal161SpAccountPayeeAccount.First();
            }
            lbusPayeeAccount.LoadBenefitDetails();


            busBenefitCalculationDetail lbusBenefitCalculationDetail = new busBenefitCalculationDetail { icdoBenefitCalculationDetail = new cdoBenefitCalculationDetail() };
            busBenefitApplicationDetail lbusBenefitApplicationDetail = new busBenefitApplicationDetail { icdoBenefitApplicationDetail = new cdoBenefitApplicationDetail() };

            if (lbusBenefitCalculationDetail.FindBenefitCalculationDetail(lbusPayeeAccount.icdoPayeeAccount.benefit_calculation_detail_id))
            {
                lbusPayeeAccount.ibusBenefitCalculationHeader = new busBenefitCalculationHeader { icdoBenefitCalculationHeader = new cdoBenefitCalculationHeader() };
                lbusPayeeAccount.ibusBenefitCalculationHeader.FindBenefitCalculationHeader(lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.benefit_calculation_header_id);
            }
            if (lbusBenefitApplicationDetail.FindBenefitApplicationDetail(lbusPayeeAccount.icdoPayeeAccount.benefit_application_detail_id))
            {
                lbusPayeeAccount.ibusBenefitApplication = new busBenefitApplication { icdoBenefitApplication = new cdoBenefitApplication() };
                lbusPayeeAccount.ibusBenefitApplication.FindBenefitApplication(lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.benefit_application_id);
            }


            busPerson lbusSurvivorPerson = new busPerson { icdoPerson = new cdoPerson() };
            busOrganization lbusSurvivorOrg = new busOrganization { icdoOrganization = new cdoOrganization() };


            busBenefitCalculationPostRetirementDeath lbusBenefitCalculationPostRetirementDeath = new busBenefitCalculationPostRetirementDeath { icdoBenefitCalculationHeader = new cdoBenefitCalculationHeader() };
            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.benefit_application_id = lbusPayeeAccount.ibusBenefitApplication.icdoBenefitApplication.benefit_application_id;
            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.person_id = lbusPayeeAccount.icdoPayeeAccount.person_id;

            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.calculation_type_id = busConstant.BenefitCalculation.CALCULATION_TYPE_CODE_ID;
            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.calculation_type_value = busConstant.BenefitCalculation.CALCULATION_TYPE_FINAL;
            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.benefit_type_id = busConstant.BENEFIT_TYPE_CODE_ID;
            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.benefit_type_value = busConstant.BENEFIT_TYPE_DEATH_POST_RETIREMENT;//DOPR DDPT
            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.status_id = busConstant.BenefitCalculation.CALCULATION_STATUS_TYPE_CODE_ID;
            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.status_value = busConstant.BenefitCalculation.CALCULATION_STATUS_TYPE_PENDING;
            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.retirement_date = lbusPayeeAccount.ibusBenefitApplication.icdoBenefitApplication.retirement_date;
            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.age = lbusPayeeAccount.ibusBenefitCalculationHeader.icdoBenefitCalculationHeader.age;
            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.date_of_death = abusPerson.icdoPerson.date_of_death;
            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.survivor_percentage = adecSurvivorPercentage;
            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.payee_account_id = lbusPayeeAccount.icdoPayeeAccount.payee_account_id;

            lbusBenefitCalculationPostRetirementDeath.iclbBenefitCalculationDetail = new Collection<busBenefitCalculationDetail>();



            if (aintBeneficiaryPersonId > 0)
            {
                if (lbusSurvivorPerson.FindPerson(aintBeneficiaryPersonId))
                {
                    lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.beneficiary_person_id = aintBeneficiaryPersonId;
                    lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.beneficiary_person_name = lbusSurvivorPerson.icdoPerson.istrFullName;
                    lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.beneficiary_person_date_of_birth = lbusSurvivorPerson.icdoPerson.idtDateofBirth;
                }
            }
            else
            {
                if (lbusSurvivorOrg.FindOrganization(aintBeneficiaryOrgId))
                {
                    lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.organization_id = aintBeneficiaryOrgId;
                }

            }

            busCalculation lbusCalculation = new busCalculation();
            busBenefitApplication lbusBenefitApplication = new busBenefitApplication();
            string lstrBenefitOptionValue = string.Empty;

            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.Insert();

            //Benefit Calculation Details


            busBenefitCalculationDetail lbusPostRetirementDeathBenefitCalculationDetail = new busBenefitCalculationDetail { icdoBenefitCalculationDetail = new cdoBenefitCalculationDetail() };

            lbusPostRetirementDeathBenefitCalculationDetail.icdoBenefitCalculationDetail.benefit_application_detail_id = lbusPayeeAccount.icdoPayeeAccount.benefit_application_detail_id;
            lbusPostRetirementDeathBenefitCalculationDetail.icdoBenefitCalculationDetail.status_id = busConstant.BenefitCalculation.CALCULATION_STATUS_TYPE_CODE_ID;
            lbusPostRetirementDeathBenefitCalculationDetail.icdoBenefitCalculationDetail.status_value = busConstant.BenefitCalculation.CALCULATION_STATUS_TYPE_PENDING;

            lbusPostRetirementDeathBenefitCalculationDetail.icdoBenefitCalculationDetail.plan_id = lbusPayeeAccount.icdoPayeeAccount.iintPlanId;
            lbusPostRetirementDeathBenefitCalculationDetail.icdoBenefitCalculationDetail.person_account_id = lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.person_account_id; ;


            lbusPostRetirementDeathBenefitCalculationDetail.icdoBenefitCalculationDetail.local52_special_acct_bal_amount = lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.local52_special_acct_bal_amount;
            lbusPostRetirementDeathBenefitCalculationDetail.icdoBenefitCalculationDetail.local161_special_acct_bal_amount = lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.local161_special_acct_bal_amount;

            lbusPostRetirementDeathBenefitCalculationDetail.icdoBenefitCalculationDetail.ee_flag = lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.ee_flag;
            lbusPostRetirementDeathBenefitCalculationDetail.icdoBenefitCalculationDetail.uvhp_flag = lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.uvhp_flag;
            lbusPostRetirementDeathBenefitCalculationDetail.icdoBenefitCalculationDetail.l52_spl_acc_flag = lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.l52_spl_acc_flag;
            lbusPostRetirementDeathBenefitCalculationDetail.icdoBenefitCalculationDetail.l161_spl_acc_flag = lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.l161_spl_acc_flag;

            lbusBenefitCalculationPostRetirementDeath.iclbBenefitCalculationDetail.Add(lbusPostRetirementDeathBenefitCalculationDetail);

            lbusPostRetirementDeathBenefitCalculationDetail.icdoBenefitCalculationDetail.benefit_calculation_header_id = lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.benefit_calculation_header_id;
            lbusPostRetirementDeathBenefitCalculationDetail.icdoBenefitCalculationDetail.Insert();

            lbusPostRetirementDeathBenefitCalculationDetail.iclbBenefitCalculationOptions = new Collection<busBenefitCalculationOptions>();

            //
            busBenefitCalculationOptions lbusPostRetirementDeathBenefitCalculationOptions = new busBenefitCalculationOptions { icdoBenefitCalculationOptions = new cdoBenefitCalculationOptions() };
            lbusPostRetirementDeathBenefitCalculationOptions.icdoBenefitCalculationOptions.benefit_calculation_detail_id = lbusPostRetirementDeathBenefitCalculationDetail.icdoBenefitCalculationDetail.benefit_calculation_detail_id;

            lbusPostRetirementDeathBenefitCalculationOptions.icdoBenefitCalculationOptions.account_relationship_id = busConstant.BenefitCalculation.ACCOUNT_RELATIONSHIP_CODE_ID;

            if (aintBeneficiaryPersonId > 0)
            {
                lbusPostRetirementDeathBenefitCalculationOptions.icdoBenefitCalculationOptions.account_relationship_value = busConstant.BenefitCalculation.ACCOUNT_RELATIONSHIP_JOINT_ANNUITANT;
            }
            else
            {
                lbusPostRetirementDeathBenefitCalculationOptions.icdoBenefitCalculationOptions.account_relationship_value = busConstant.BenefitCalculation.ACCOUNT_RELATIONSHIP_BENEFICIARY;
            }

            lbusPostRetirementDeathBenefitCalculationOptions.icdoBenefitCalculationOptions.survivor_relationship_id = busConstant.BENEFICIARY_RELATIONSHIP_CODE_ID;
            lbusPostRetirementDeathBenefitCalculationOptions.icdoBenefitCalculationOptions.survivor_relationship_value = astrSurvivorRelation;

            lbusPostRetirementDeathBenefitCalculationOptions.icdoBenefitCalculationOptions.plan_benefit_id = lbusCalculation.GetPlanBenefitId(busConstant.IAP_PLAN_ID, busConstant.LIFE);

            decimal ldecBenefitOptionFactor = 1;
            ldecBenefitOptionFactor = lbusCalculation.GetBenefitOptionFactor(busConstant.BENEFIT_TYPE_WITHDRAWAL, lbusCalculation.GetPlanBenefitId(busConstant.IAP_PLAN_ID, busConstant.LIFE),
                                                                    Convert.ToInt32(lbusPayeeAccount.ibusBenefitCalculationHeader.icdoBenefitCalculationHeader.idecSurvivorFullAge), busConstant.ZERO_INT) * 12;

            if (aclbLocal52SpAccountPayeeAccount != null)
            {
                lbusPostRetirementDeathBenefitCalculationOptions.icdoBenefitCalculationOptions.survivor_amount = lbusPostRetirementDeathBenefitCalculationDetail.icdoBenefitCalculationDetail.local52_special_acct_bal_amount
                                         / ldecBenefitOptionFactor;
            }
            else
            {
                lbusPostRetirementDeathBenefitCalculationOptions.icdoBenefitCalculationOptions.survivor_amount = lbusPostRetirementDeathBenefitCalculationDetail.icdoBenefitCalculationDetail.local161_special_acct_bal_amount
                                    / lbusBenefitCalculationDetail.iclbBenefitCalculationOptions.FirstOrDefault().icdoBenefitCalculationOptions.benefit_option_factor;
            }

            lbusPostRetirementDeathBenefitCalculationDetail.iclbBenefitCalculationOptions.Add(lbusPostRetirementDeathBenefitCalculationOptions);
            lbusPostRetirementDeathBenefitCalculationOptions.icdoBenefitCalculationOptions.Insert();


            if (lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.benefit_calculation_header_id > 0)
            {
                busWorkflowHelper.InitializeWorkflowIfNotExists(busConstant.POSTRETIREMENT_DEATH_PAYSURVIVOR_WORKFLOW_NAME, this.icdoPayeeAccount.person_id, 0, lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.benefit_calculation_header_id, null);
                SetWorkflowRelatedVariablesforPaySurvivor(lbusPayeeAccount.icdoPayeeAccount.payee_account_id, lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.benefit_calculation_header_id);
            }

        }

        //This Scenario will occur when Participant dies and we create survivors payee account and before getting first payment survivor dies,
        //in that case we Create Post Retirement Calculation Of Contingent Ben of participant
        public void CreatePostRetirementCalculationForContingentFromPrimaryBenPayeeAccount(busBenefitCalculationDetail abusBenefitCalculationDetail,
          busBenefitCalculationOptions abusBenefitCalculationOptions, busBenefitApplicationDetail abusBenefitApplicationDetail,
          busPerson abusPerson, int aintBeneficiaryPersonId, int aintBeneficiaryOrgId, string astrBeneficiaryTypeValue, string astrSurvivorRelation, decimal adecSurvivorPercentage,
            busPayeeAccount abusParticipantPayeeAccount, busBenefitCalculationHeader aParticipantBenefitCalculationHeader, bool ablnCreateAdjustmentCalculation)
        {
            int lintpersonAccountId = 0;
            decimal ldecBenefitAmount = decimal.Zero;
            decimal ldecMea = decimal.Zero;
            decimal ldecNonTaxableAmount = decimal.Zero;
            decimal ldecTaxableAnount = decimal.Zero;
            string lstrEEFlag = busConstant.FLAG_NO;
            string lstrUvHpFlag = busConstant.FLAG_NO;
            string lstrL52Flag = busConstant.FLAG_NO;
            string lstrL161Flag = busConstant.FLAG_NO;
            string lstrBenefitOptionValue = string.Empty;

            if (string.IsNullOrEmpty(this.istrBenefitOptionValue))
            {
                this.LoadBenefitDetails();
            }

            if (abusBenefitCalculationDetail == null)
            {
                ibusCalculation.GetTaxableAndNonTaxableAmountFromPaymentItemTypes(abusParticipantPayeeAccount, out ldecTaxableAnount, out ldecNonTaxableAmount);
                ldecMea = ldecNonTaxableAmount;
                ldecBenefitAmount = ldecTaxableAnount + ldecNonTaxableAmount;
                if (this.ibusParticipant.iclbPersonAccount.IsNullOrEmpty())
                {
                    this.ibusParticipant.LoadPersonAccounts();
                }
                if (this.ibusParticipant.iclbPersonAccount.Count > 0)
                {
                    if (this.ibusParticipant.iclbPersonAccount.Where(item => item.icdoPersonAccount.plan_id == this.icdoPayeeAccount.iintPlanId).Count() > 0)
                    {
                        lintpersonAccountId = this.ibusParticipant.iclbPersonAccount.Where(item => item.icdoPersonAccount.plan_id == this.icdoPayeeAccount.iintPlanId).FirstOrDefault().icdoPersonAccount.plan_id;
                    }
                }
            }
            else
            {
                lintpersonAccountId = abusBenefitCalculationDetail.icdoBenefitCalculationDetail.person_account_id;
                ldecMea = abusBenefitCalculationDetail.icdoBenefitCalculationDetail.monthly_exclusion_amount;
                lstrEEFlag = abusBenefitCalculationDetail.icdoBenefitCalculationDetail.ee_flag;
                lstrUvHpFlag = abusBenefitCalculationDetail.icdoBenefitCalculationDetail.uvhp_flag;
                lstrL52Flag = abusBenefitCalculationDetail.icdoBenefitCalculationDetail.l52_spl_acc_flag;
                lstrL161Flag = abusBenefitCalculationDetail.icdoBenefitCalculationDetail.l161_spl_acc_flag;
                if (this.icdoPayeeAccount.benefit_account_type_value == busConstant.BENEFIT_TYPE_RETIREMENT)
                {
                    ldecBenefitAmount = abusBenefitCalculationOptions.icdoBenefitCalculationOptions.benefit_amount;
                }
                else if (this.icdoPayeeAccount.benefit_account_type_value == busConstant.BENEFIT_TYPE_DISABILITY)
                {
                    ldecBenefitAmount = abusBenefitCalculationOptions.icdoBenefitCalculationOptions.participant_amount;
                }
            }
            LoadPaymentHistoryHeaderDetails();

            busPerson lbusSurvivorPerson = new busPerson { icdoPerson = new cdoPerson() };
            busOrganization lbusSurvivorOrg = new busOrganization { icdoOrganization = new cdoOrganization() };

            busBenefitCalculationPostRetirementDeath lbusBenefitCalculationPostRetirementDeath = new busBenefitCalculationPostRetirementDeath { icdoBenefitCalculationHeader = new cdoBenefitCalculationHeader() };
            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.benefit_application_id = abusParticipantPayeeAccount.ibusBenefitApplication.icdoBenefitApplication.benefit_application_id;
            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.person_id = abusParticipantPayeeAccount.icdoPayeeAccount.person_id;

            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.calculation_type_id = busConstant.BenefitCalculation.CALCULATION_TYPE_CODE_ID;

            if (ablnCreateAdjustmentCalculation)
            {
                lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.calculation_type_value = busConstant.BenefitCalculation.CALCULATION_TYPE_ADJUSTMENT;
            }
            else
            {
                lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.calculation_type_value = busConstant.BenefitCalculation.CALCULATION_TYPE_FINAL;
            }
            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.benefit_type_id = busConstant.BENEFIT_TYPE_CODE_ID;
            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.benefit_type_value = busConstant.BENEFIT_TYPE_DEATH_POST_RETIREMENT;//DOPR DDPT
            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.status_id = busConstant.BenefitCalculation.CALCULATION_STATUS_TYPE_CODE_ID;
            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.status_value = busConstant.BenefitCalculation.CALCULATION_STATUS_TYPE_PENDING;
            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.retirement_date = abusParticipantPayeeAccount.ibusBenefitApplication.icdoBenefitApplication.retirement_date;
            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.age = aParticipantBenefitCalculationHeader.icdoBenefitCalculationHeader.age;
            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.date_of_death = abusPerson.icdoPerson.date_of_death;
            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.survivor_percentage = adecSurvivorPercentage;
            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.payee_account_id = abusParticipantPayeeAccount.icdoPayeeAccount.payee_account_id;

            lbusBenefitCalculationPostRetirementDeath.iclbBenefitCalculationDetail = new Collection<busBenefitCalculationDetail>();


            if (aintBeneficiaryPersonId > 0)
            {
                if (lbusSurvivorPerson.FindPerson(aintBeneficiaryPersonId))
                {
                    lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.beneficiary_person_id = aintBeneficiaryPersonId;
                    lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.beneficiary_person_name = lbusSurvivorPerson.icdoPerson.istrFullName;
                    lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.beneficiary_person_date_of_birth = lbusSurvivorPerson.icdoPerson.idtDateofBirth;
                }
            }
            else
            {
                if (lbusSurvivorOrg.FindOrganization(aintBeneficiaryOrgId))
                {
                    lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.organization_id = aintBeneficiaryOrgId;
                }

            }

            busCalculation lbusCalculation = new busCalculation();
            busBenefitApplication lbusBenefitApplication = new busBenefitApplication();


            #region Benefit Calculation Details

            busBenefitCalculationDetail lbusBenefitCalculationDetail = new busBenefitCalculationDetail { icdoBenefitCalculationDetail = new cdoBenefitCalculationDetail() };

            lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.benefit_application_detail_id = abusParticipantPayeeAccount.icdoPayeeAccount.benefit_application_detail_id;
            lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.status_id = busConstant.BenefitCalculation.CALCULATION_STATUS_TYPE_CODE_ID;
            lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.status_value = busConstant.BenefitCalculation.CALCULATION_STATUS_TYPE_PENDING;

            lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.plan_id = abusParticipantPayeeAccount.icdoPayeeAccount.iintPlanId;
            lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.person_account_id = lintpersonAccountId;


            //lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.iap_balance_amount = abusBenefitCalculationDetail.icdoBenefitCalculationDetail.iap_balance_amount;
            lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.ee_flag = lstrEEFlag;
            lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.uvhp_flag = lstrUvHpFlag;
            lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.l52_spl_acc_flag = lstrL52Flag;
            lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.l161_spl_acc_flag = lstrL161Flag;
            lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.benefit_subtype_value = this.icdoPayeeAccount.retirement_type_value;
            lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.minimum_guarantee_amount = (abusParticipantPayeeAccount.idecRemainingMinimumGuaranteeAmount / 100) * adecSurvivorPercentage;
            lbusBenefitCalculationPostRetirementDeath.iclbBenefitCalculationDetail.Add(lbusBenefitCalculationDetail);
            #endregion

            #region Benefit Calculation Options
            decimal ldecMinimumGuarentee = abusParticipantPayeeAccount.idecRemainingMinimumGuaranteeAmount;
            lbusBenefitCalculationDetail.iclbBenefitCalculationOptions = new Collection<busBenefitCalculationOptions>();


            busBenefitCalculationOptions lbusBenefitCalculationOptions = new busBenefitCalculationOptions { icdoBenefitCalculationOptions = new cdoBenefitCalculationOptions() };
            lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.benefit_calculation_detail_id = lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.benefit_calculation_detail_id;

            lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.account_relationship_id = busConstant.BenefitCalculation.ACCOUNT_RELATIONSHIP_CODE_ID;


            lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.account_relationship_value = busConstant.BenefitCalculation.ACCOUNT_RELATIONSHIP_BENEFICIARY;


            lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.survivor_relationship_id = busConstant.BENEFICIARY_RELATIONSHIP_CODE_ID;
            lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.survivor_relationship_value = astrSurvivorRelation;



            if (lstrBenefitOptionValue == busConstant.TEN_YEARS_CERTAIN_AND_LIFE_ANNUTIY || lstrBenefitOptionValue == busConstant.TWO_YEARS_CERTAIN_AND_LIFE_ANNUITY ||
                lstrBenefitOptionValue == busConstant.THREE_YEARS_CERTAIN_AND_LIFE_ANNUITY || lstrBenefitOptionValue == busConstant.FIVE_YEARS_CERTAIN_AND_LIFE_ANNUTIY)
            {
                lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.survivor_amount = (ldecBenefitAmount / 100) * adecSurvivorPercentage;
                lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.benefit_amount = ldecBenefitAmount;

            }
            else
            {
                lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.plan_benefit_id = lbusCalculation.GetPlanBenefitId(abusParticipantPayeeAccount.icdoPayeeAccount.iintPlanId, busConstant.LUMP_SUM);
                if (aintBeneficiaryPersonId > 0)
                {
                    lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.survivor_amount = (ldecMinimumGuarentee / 100) * adecSurvivorPercentage;
                }
                lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.benefit_amount = ldecBenefitAmount;
            }


            lbusBenefitCalculationDetail.iclbBenefitCalculationOptions.Add(lbusBenefitCalculationOptions);


            #endregion

            #region Insert Calculation Object

            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.Insert();
            lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.benefit_calculation_header_id = lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.benefit_calculation_header_id;
            lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.Insert();
            lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.benefit_calculation_detail_id = lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.benefit_calculation_detail_id;
            lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.Insert();
            #endregion


            if (lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.benefit_calculation_header_id > 0)
            {
                busWorkflowHelper.InitializeWorkflowIfNotExists(busConstant.POSTRETIREMENT_DEATH_PAYSURVIVOR_WORKFLOW_NAME, this.icdoPayeeAccount.person_id, 0, lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.benefit_calculation_header_id, null);
                //SetWorkflowRelatedVariablesforPaySurvivor(0, lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.benefit_calculation_header_id);
            }

        }

        public void InsertBenefitCalculationDetailsForConversion(busBenefitCalculationRetirement abusBenefitCalculationRetirement, busBenefitApplicationDetail abusBenefitApplicationDetail, busBenefitCalculationOptions abusBenefitCalculationOptions)
        {
            busPerson lbusSurvivorPerson = new busPerson { icdoPerson = new cdoPerson() };
            busOrganization lbusSurvivorOrg = new busOrganization { icdoOrganization = new cdoOrganization() };
            busCalculation lbusCalculation = new busCalculation();

            busPlanBenefitXr lbusPlanBenefitXr = new busPlanBenefitXr();
            lbusPlanBenefitXr.FindPlanBenefitXr(icdoPayeeAccount.plan_benefit_id);
            string lstrBenefitOptionValue = lbusPlanBenefitXr.icdoPlanBenefitXr.benefit_option_value;

            busBenefitCalculationRetirement lbusBenefitCalculationRetirement = new busBenefitCalculationRetirement { icdoBenefitCalculationHeader = new cdoBenefitCalculationHeader() };
            busBenefitCalculationDetail lbusBenefitCalculationDetail = abusBenefitCalculationRetirement.iclbBenefitCalculationDetail.FirstOrDefault();

            busBenefitCalculationPostRetirementDeath lbusBenefitCalculationPostRetirementDeath = new busBenefitCalculationPostRetirementDeath { icdoBenefitCalculationHeader = new cdoBenefitCalculationHeader() };
            lbusBenefitCalculationPostRetirementDeath.iclbBenefitCalculationDetail = new Collection<busBenefitCalculationDetail>();


            busBenefitApplication lbusBenefitApplication = new busBenefitApplication();

            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.benefit_application_id = abusBenefitApplicationDetail.icdoBenefitApplicationDetail.benefit_application_id;
            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.person_id = this.icdoPayeeAccount.person_id;

            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.calculation_type_id = busConstant.BenefitCalculation.CALCULATION_TYPE_CODE_ID;
            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.calculation_type_value = busConstant.BenefitCalculation.CALCULATION_TYPE_ADJUSTMENT;
            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.benefit_type_id = busConstant.BENEFIT_TYPE_CODE_ID;
            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.benefit_type_value = busConstant.BENEFIT_TYPE_DEATH_POST_RETIREMENT;
            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.status_id = busConstant.BenefitCalculation.CALCULATION_STATUS_TYPE_CODE_ID;
            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.status_value = busConstant.BenefitCalculation.CALCULATION_STATUS_TYPE_PENDING;
            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.retirement_date = abusBenefitApplicationDetail.ibusBenefitApplication.icdoBenefitApplication.retirement_date;
            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.age = abusBenefitCalculationRetirement.icdoBenefitCalculationHeader.age;
            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.date_of_death = abusBenefitApplicationDetail.ibusBenefitApplication.ibusPerson.icdoPerson.date_of_death;
            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.survivor_percentage = abusBenefitCalculationRetirement.icdoBenefitCalculationHeader.survivor_percentage;
            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.payee_account_id = icdoPayeeAccount.payee_account_id;
            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.Insert();


            if (lbusSurvivorPerson.FindPerson(abusBenefitCalculationRetirement.icdoBenefitCalculationHeader.beneficiary_person_id))
            {
                lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.beneficiary_person_id = abusBenefitCalculationRetirement.icdoBenefitCalculationHeader.beneficiary_person_id;
                lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.beneficiary_person_name = lbusSurvivorPerson.icdoPerson.istrFullName;
                lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.beneficiary_person_date_of_birth = lbusSurvivorPerson.icdoPerson.idtDateofBirth;
            }
            else if (lbusSurvivorOrg.FindOrganization(abusBenefitCalculationRetirement.icdoBenefitCalculationHeader.organization_id))
            {
                lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.organization_id = abusBenefitCalculationRetirement.icdoBenefitCalculationHeader.organization_id;
            }


            # region Benefit Calculation Details

            int lintPersonAccountId = abusBenefitApplicationDetail.ibusBenefitApplication.ibusPerson.iclbPersonAccount.Where(item => item.icdoPersonAccount.istrPlanCode == abusBenefitApplicationDetail.istrPlanCode).FirstOrDefault().icdoPersonAccount.person_account_id;

            lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.benefit_application_detail_id = abusBenefitApplicationDetail.icdoBenefitApplicationDetail.benefit_application_detail_id;
            lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.status_id = busConstant.BenefitCalculation.CALCULATION_STATUS_TYPE_CODE_ID;
            lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.status_value = busConstant.BenefitCalculation.CALCULATION_STATUS_TYPE_PENDING;

            lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.plan_id = abusBenefitApplicationDetail.iintPlan_ID;
            lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.person_account_id = lintPersonAccountId;

            //   if (astrBeneficiaryTypeValue == busConstant.BENEFICIARY_TYPE_PRIMARY && lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.monthly_exclusion_amount > 0)
            if (lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.monthly_exclusion_amount > 0)
            {
                if (lstrBenefitOptionValue == busConstant.QJ50 || lstrBenefitOptionValue == "JP50" || lstrBenefitOptionValue == "QJ50" || lstrBenefitOptionValue == "QJSA")
                {
                    lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.monthly_exclusion_amount = (lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.monthly_exclusion_amount / 100) * 50;
                }
                else if (lstrBenefitOptionValue == "JP75" || lstrBenefitOptionValue == "JS75")
                {
                    lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.monthly_exclusion_amount = (lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.monthly_exclusion_amount / 100) * 75;
                }
                else if (lstrBenefitOptionValue == "J100" || lstrBenefitOptionValue == "JPOP" || lstrBenefitOptionValue == "JSAA")
                {
                    lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.monthly_exclusion_amount = lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.monthly_exclusion_amount;
                }
                else if (lstrBenefitOptionValue == "JA66" || lstrBenefitOptionValue == "JS66")
                {
                    lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.monthly_exclusion_amount = (lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.monthly_exclusion_amount / 100) * Convert.ToDecimal(66.67);
                }
            }
            lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.iap_balance_amount = lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.iap_balance_amount;
            lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.ee_flag = lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.ee_flag;
            lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.uvhp_flag = lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.uvhp_flag;
            lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.l52_spl_acc_flag = lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.l52_spl_acc_flag;
            lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.l161_spl_acc_flag = lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.l161_spl_acc_flag;
            lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.benefit_subtype_value = abusBenefitApplicationDetail.icdoBenefitApplicationDetail.benefit_subtype_value;
            lbusBenefitCalculationPostRetirementDeath.iclbBenefitCalculationDetail.Add(lbusBenefitCalculationDetail);


            lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.benefit_calculation_header_id = lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.benefit_calculation_header_id;
            lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.Insert();

            # endregion

            #region Benefit Calculation Options

            //    decimal ldecMinimumGuarentee = idecRemainingMinimumGuaranteeAmount;
            //    lbusBenefitCalculationDetail.iclbBenefitCalculationOptions = new Collection<busBenefitCalculationOptions>();


            //    busBenefitCalculationOptions lbusBenefitCalculationOptions = new busBenefitCalculationOptions { icdoBenefitCalculationOptions = new cdoBenefitCalculationOptions() };
            //    lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.benefit_calculation_detail_id = lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.benefit_calculation_detail_id;

            //    lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.account_relationship_id = busConstant.BenefitCalculation.ACCOUNT_RELATIONSHIP_CODE_ID;

            //    if (abusBenefitCalculationRetirement.icdoBenefitCalculationHeader.beneficiary_person_id > 0 && astrBeneficiaryTypeValue == busConstant.BENEFICIARY_TYPE_PRIMARY)
            //    {
            //        lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.account_relationship_value = busConstant.BenefitCalculation.ACCOUNT_RELATIONSHIP_JOINT_ANNUITANT;
            //    }
            //    else
            //    {
            //        lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.account_relationship_value = busConstant.BenefitCalculation.ACCOUNT_RELATIONSHIP_BENEFICIARY;
            //    }

            //    lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.survivor_relationship_id = busConstant.BENEFICIARY_RELATIONSHIP_CODE_ID;
            //    lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.survivor_relationship_value =abusBenefitCalculationOptions.icdoBenefitCalculationOptions.survivor_relationship_value ;

            //    if (astrBeneficiaryTypeValue == busConstant.BENEFICIARY_TYPE_PRIMARY)
            //    {
            //        lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.plan_benefit_id = this.icdoPayeeAccount.plan_benefit_id;
            //        if (lstrBenefitOptionValue == busConstant.TEN_YEARS_CERTAIN_AND_LIFE_ANNUTIY || lstrBenefitOptionValue == busConstant.TWO_YEARS_CERTAIN_AND_LIFE_ANNUITY ||
            //        lstrBenefitOptionValue == busConstant.THREE_YEARS_CERTAIN_AND_LIFE_ANNUITY || lstrBenefitOptionValue == busConstant.FIVE_YEARS_CERTAIN_AND_LIFE_ANNUTIY)
            //        {
            //            DataTable ldtbSurvivorAmt = busBase.Select("cdoPersonAccountBeneficiary.GetAmountForTermCertain", new object[1] { lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.benefit_calculation_detail_id });
            //            if (ldtbSurvivorAmt.Rows.Count > 0 && Convert.ToString(ldtbSurvivorAmt.Rows[0][0]).IsNotNullOrEmpty())
            //            {
            //                lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.survivor_amount = Convert.ToInt32(ldtbSurvivorAmt.Rows[0][0]);
            //            }
            //        }
            //        else
            //        {
            //            DataTable ldtbSurvivorAmt = busBase.Select("cdoPersonAccountBeneficiary.GetSurvivorAmount", new object[1] {  lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.benefit_calculation_detail_id });
            //            if (ldtbSurvivorAmt.Rows.Count > 0 && Convert.ToString(ldtbSurvivorAmt.Rows[0]["SURVIVOR_AMOUNT"]).IsNotNullOrEmpty())
            //            {
            //                lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.survivor_amount = Convert.ToInt32(ldtbSurvivorAmt.Rows[0]["SURVIVOR_AMOUNT"]);
            //            }
            //        }
            //    }
            //    else
            //    {
            //        if (lstrBenefitOptionValue == busConstant.TEN_YEARS_CERTAIN_AND_LIFE_ANNUTIY || lstrBenefitOptionValue == busConstant.TWO_YEARS_CERTAIN_AND_LIFE_ANNUITY ||
            //         lstrBenefitOptionValue == busConstant.THREE_YEARS_CERTAIN_AND_LIFE_ANNUITY || lstrBenefitOptionValue == busConstant.FIVE_YEARS_CERTAIN_AND_LIFE_ANNUTIY)
            //        {
            //            lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.plan_benefit_id = this.icdoPayeeAccount.plan_benefit_id;
            //            DataTable ldtbSurvivorAmt = busBase.Select("cdoPersonAccountBeneficiary.GetAmountForTermCertain", new object[1] {  lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.benefit_calculation_detail_id });
            //            if (ldtbSurvivorAmt.Rows.Count > 0 && Convert.ToString(ldtbSurvivorAmt.Rows[0][0]).IsNotNullOrEmpty())
            //            {
            //                lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.survivor_amount = (Convert.ToInt32(ldtbSurvivorAmt.Rows[0][0])  / 100) *  (abusBenefitCalculationRetirement.icdoBenefitCalculationHeader.survivor_percentage);
            //            }

            //        }
            //        else
            //        {
            //            lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.plan_benefit_id = lbusCalculation.GetPlanBenefitId(this.icdoPayeeAccount.iintPlanId, busConstant.LUMP_SUM);
            //            if (lbusBenefitCalculationRetirement.icdoBenefitCalculationHeader.beneficiary_person_id > 0)
            //            {
            //                lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.survivor_amount = (ldecMinimumGuarentee / 100) *  abusBenefitCalculationRetirement.icdoBenefitCalculationHeader.survivor_percentage;
            //            }
            //        }
            //    }

            //    lbusBenefitCalculationDetail.iclbBenefitCalculationOptions.Add(lbusBenefitCalculationOptions);

            //    lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.Insert();

            #endregion

            //    if (this.ibusBaseActivityInstance.IsNotNull())
            //    {
            //        if (lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.benefit_calculation_header_id > 0)
            //        {
            //            busWorkflowHelper.InitializeWorkflowIfNotExists(busConstant.POSTRETIREMENT_DEATH_PAYSURVIVOR_WORKFLOW_NAME, this.icdoPayeeAccount.person_id, 0, lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.benefit_calculation_header_id, null);
            //            SetWorkflowRelatedVariablesforPaySurvivor(icdoPayeeAccount.payee_account_id, lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.benefit_calculation_header_id);
            //        }
            //    }
        }

        public void InsertBenefitCalculationDetailsForConversion(busBenefitApplicationDetail abusBenefitApplicationDetail, int aintBeneficiaryPersonId, int aintBeneficiaryOrgId, string astrBeneficiaryTypeValue, string astrSurvivorRelation, decimal adecSurvivorPercentage, decimal adecSurvivorAmount, int aintPersonAccountID)
        {
            busPerson lbusSurvivorPerson = new busPerson { icdoPerson = new cdoPerson() };
            busOrganization lbusSurvivorOrg = new busOrganization { icdoOrganization = new cdoOrganization() };
            busBenefitCalculationPostRetirementDeath lbusBenefitCalculationPostRetirementDeath = new busBenefitCalculationPostRetirementDeath { icdoBenefitCalculationHeader = new cdoBenefitCalculationHeader() };

            decimal ldecParticipantMEA = 0M;

            this.LoadBenefitDetails();
            this.ibusPayee.LoadPersonAccounts();


            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.benefit_application_id = ibusBenefitApplication.icdoBenefitApplication.benefit_application_id;
            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.person_id = this.icdoPayeeAccount.person_id;

            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.calculation_type_id = busConstant.BenefitCalculation.CALCULATION_TYPE_CODE_ID;
            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.calculation_type_value = busConstant.BenefitCalculation.CALCULATION_TYPE_FINAL;
            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.benefit_type_id = busConstant.BENEFIT_TYPE_CODE_ID;
            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.benefit_type_value = busConstant.BENEFIT_TYPE_DEATH_POST_RETIREMENT;
            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.status_id = busConstant.BenefitCalculation.CALCULATION_STATUS_TYPE_CODE_ID;
            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.status_value = busConstant.BenefitCalculation.CALCULATION_STATUS_TYPE_PENDING;
            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.retirement_date = ibusBenefitApplication.icdoBenefitApplication.retirement_date;
            //lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.age=;
            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.date_of_death = this.ibusParticipant.icdoPerson.date_of_death;
            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.survivor_percentage = adecSurvivorPercentage;
            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.payee_account_id = icdoPayeeAccount.payee_account_id;

            LoadPaymentHistoryHeaderDetails();
            lbusBenefitCalculationPostRetirementDeath.iclbBenefitCalculationDetail = new Collection<busBenefitCalculationDetail>();


            if (aintBeneficiaryPersonId > 0)
            {
                if (lbusSurvivorPerson.FindPerson(aintBeneficiaryPersonId))
                {
                    lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.beneficiary_person_id = aintBeneficiaryPersonId;
                    lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.beneficiary_person_name = lbusSurvivorPerson.icdoPerson.istrFullName;
                    lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.beneficiary_person_date_of_birth = lbusSurvivorPerson.icdoPerson.idtDateofBirth;
                }
            }

            if (aintBeneficiaryOrgId > 0)
            {
                if (lbusSurvivorOrg.FindOrganization(aintBeneficiaryOrgId))
                {
                    lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.organization_id = aintBeneficiaryOrgId;
                    lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.istrOrganizationName = lbusSurvivorOrg.icdoOrganization.org_name;

                }


            }

            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.Insert();
            busCalculation lbusCalculation = new busCalculation();
            busBenefitApplication lbusBenefitApplication = new busBenefitApplication();
            string lstrBenefitOptionValue = string.Empty;

            DataTable ldtbBenefitOptionValue = lbusBenefitApplication.GetPlanAndBenefitOptionValue(this.icdoPayeeAccount.plan_benefit_id);
            if (ldtbBenefitOptionValue.Rows.Count > 0)
                lstrBenefitOptionValue = Convert.ToString(ldtbBenefitOptionValue.Rows[0][1]);


            #region Benefit Calculation Details
            busBenefitCalculationDetail lbusBenefitCalculationDetail = new busBenefitCalculationDetail { icdoBenefitCalculationDetail = new cdoBenefitCalculationDetail() };
            lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.benefit_application_detail_id = icdoPayeeAccount.benefit_application_detail_id;
            lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.status_id = busConstant.BenefitCalculation.CALCULATION_STATUS_TYPE_CODE_ID;
            lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.status_value = busConstant.BenefitCalculation.CALCULATION_STATUS_TYPE_PENDING;

            lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.plan_id = this.icdoPayeeAccount.iintPlanId;
            lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.person_account_id = aintPersonAccountID;


            DataTable ldtblParticipantsMEA = Select("cdoPayeeAccount.GetParticipantsMEA", new object[1] { this.icdoPayeeAccount.payee_account_id });

            if (ldtblParticipantsMEA.Rows.Count > 0 && Convert.ToString(ldtblParticipantsMEA.Rows[0][0]).IsNotNullOrEmpty())
            {
                ldecParticipantMEA = Convert.ToDecimal(ldtblParticipantsMEA.Rows[0][0]);
            }


            if (lstrBenefitOptionValue == busConstant.QJ50 || lstrBenefitOptionValue == "JP50" || lstrBenefitOptionValue == "QJ50" || lstrBenefitOptionValue == "QJSA")
            {
                lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.monthly_exclusion_amount = (ldecParticipantMEA / 100) * 50;
            }
            else if (lstrBenefitOptionValue == "JP75" || lstrBenefitOptionValue == "JS75")
            {
                lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.monthly_exclusion_amount = (ldecParticipantMEA / 100) * 75;
            }
            else if (lstrBenefitOptionValue == "J100" || lstrBenefitOptionValue == "JPOP" || lstrBenefitOptionValue == "JSAA")
            {
                lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.monthly_exclusion_amount = ldecParticipantMEA;
            }
            else if (lstrBenefitOptionValue == "JA66" || lstrBenefitOptionValue == "JS66")
            {
                lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.monthly_exclusion_amount = (ldecParticipantMEA / 100) * Convert.ToDecimal(66.67);
            }


            //lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.iap_balance_amount = lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.iap_balance_amount;
            //lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.ee_flag = abusBenefitCalculationDetail.icdoBenefitCalculationDetail.ee_flag;
            //lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.uvhp_flag = abusBenefitCalculationDetail.icdoBenefitCalculationDetail.uvhp_flag;
            //lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.l52_spl_acc_flag = abusBenefitCalculationDetail.icdoBenefitCalculationDetail.l52_spl_acc_flag;
            //lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.l161_spl_acc_flag = abusBenefitCalculationDetail.icdoBenefitCalculationDetail.l161_spl_acc_flag;
            //lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.benefit_subtype_value = abusBenefitApplicationDetail.icdoBenefitApplicationDetail.benefit_subtype_value;
            //lbusBenefitCalculationPostRetirementDeath.iclbBenefitCalculationDetail.Add(lbusBenefitCalculationDetail);



            lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.benefit_calculation_header_id = lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.benefit_calculation_header_id;
            lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.Insert();
            #endregion

            #region Benefit Calculation Options

            decimal ldecMinimumGuarentee = idecRemainingMinimumGuaranteeAmount;
            lbusBenefitCalculationDetail.iclbBenefitCalculationOptions = new Collection<busBenefitCalculationOptions>();


            busBenefitCalculationOptions lbusBenefitCalculationOptions = new busBenefitCalculationOptions { icdoBenefitCalculationOptions = new cdoBenefitCalculationOptions() };
            lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.benefit_calculation_detail_id = lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.benefit_calculation_detail_id;
            lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.account_relationship_id = busConstant.BenefitCalculation.ACCOUNT_RELATIONSHIP_CODE_ID;
            lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.plan_benefit_id = this.icdoPayeeAccount.plan_benefit_id;

            if (aintBeneficiaryPersonId > 0 && astrBeneficiaryTypeValue == busConstant.BENEFICIARY_TYPE_PRIMARY)
            {
                lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.account_relationship_value = busConstant.BenefitCalculation.ACCOUNT_RELATIONSHIP_JOINT_ANNUITANT;
            }
            else
            {
                lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.account_relationship_value = busConstant.BenefitCalculation.ACCOUNT_RELATIONSHIP_BENEFICIARY;
            }

            lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.survivor_relationship_id = busConstant.BENEFICIARY_RELATIONSHIP_CODE_ID;
            lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.survivor_relationship_value = astrSurvivorRelation;
            lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.survivor_amount = adecSurvivorAmount;


            lbusBenefitCalculationDetail.iclbBenefitCalculationOptions.Add(lbusBenefitCalculationOptions);
            lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.Insert();


            #endregion
        }

        public void CreatePostRetirementCalculationForPrimaryBen(busBenefitCalculationDetail abusBenefitCalculationDetail,
           busBenefitCalculationOptions abusBenefitCalculationOptions, busBenefitApplication abusBenefitApplication, busPayeeAccount abusPayeeAccount,
           busPerson abusPerson, int aintBeneficiaryPersonId, int aintBeneficiaryOrgId, string astrBeneficiaryTypeValue, string astrSurvivorRelation, decimal adecSurvivorPercentage,
           bool ablnCreateAdjustmentCalculation, decimal adecIAPBalance)
        {
            int lintpersonAccountId = 0;
            decimal ldecBenefitAmount = decimal.Zero;
            decimal ldecMea = decimal.Zero;
            decimal ldecNonTaxableAmount = decimal.Zero;
            decimal ldecTaxableAnount = decimal.Zero;
            decimal ldecSurvivorAmount = decimal.Zero;
            string lstrEEFlag = busConstant.FLAG_NO;
            string lstrUvHpFlag = busConstant.FLAG_NO;
            string lstrL52Flag = busConstant.FLAG_NO;
            string lstrL161Flag = busConstant.FLAG_NO;
            string lstrBenefitOptionValue = string.Empty;


            abusPayeeAccount.LoadBenefitDetails();
            lstrBenefitOptionValue = abusPayeeAccount.icdoPayeeAccount.istrBenefitOptionValue;

            if (abusBenefitCalculationOptions == null)
            {
                if (abusPayeeAccount.icdoPayeeAccount.iintPlanId != busConstant.IAP_PLAN_ID)
                {
                    ibusCalculation.GetTaxableAndNonTaxableAmountFromPaymentItemTypes(this, out ldecTaxableAnount, out ldecNonTaxableAmount);
                    ldecMea = ldecNonTaxableAmount;
                    ldecBenefitAmount = ldecTaxableAnount + ldecNonTaxableAmount;
                    //En PIR 66
                    ldecSurvivorAmount = ibusCalculation.GetSurvivorAmountFromBenefitAmount(ldecBenefitAmount, lstrBenefitOptionValue, abusPayeeAccount.icdoPayeeAccount.term_certain_end_date, adecSurvivorPercentage);

                }
                if (abusPayeeAccount.ibusPayee.iclbPersonAccount.IsNullOrEmpty())
                {
                    abusPayeeAccount.ibusPayee.LoadPersonAccounts();
                }
                if (abusPayeeAccount.ibusPayee.iclbPersonAccount.Count > 0)
                {
                    if (abusPayeeAccount.ibusPayee.iclbPersonAccount.Where(item => item.icdoPersonAccount.plan_id == this.icdoPayeeAccount.iintPlanId).Count() > 0)
                    {
                        lintpersonAccountId = abusPayeeAccount.ibusPayee.iclbPersonAccount.Where(item => item.icdoPersonAccount.plan_id == this.icdoPayeeAccount.iintPlanId).FirstOrDefault().icdoPersonAccount.person_account_id;
                    }
                }
            }
            else
            {
                lintpersonAccountId = abusBenefitCalculationDetail.icdoBenefitCalculationDetail.person_account_id;
                ldecMea = abusBenefitCalculationDetail.icdoBenefitCalculationDetail.monthly_exclusion_amount;
                lstrEEFlag = abusBenefitCalculationDetail.icdoBenefitCalculationDetail.ee_flag;
                lstrUvHpFlag = abusBenefitCalculationDetail.icdoBenefitCalculationDetail.uvhp_flag;
                lstrL52Flag = abusBenefitCalculationDetail.icdoBenefitCalculationDetail.l52_spl_acc_flag;
                lstrL161Flag = abusBenefitCalculationDetail.icdoBenefitCalculationDetail.l161_spl_acc_flag;

                if (abusPayeeAccount.icdoPayeeAccount.benefit_account_type_value == busConstant.BENEFIT_TYPE_RETIREMENT)
                {
                    ldecBenefitAmount = abusBenefitCalculationOptions.icdoBenefitCalculationOptions.benefit_amount;
                }
                else if (abusPayeeAccount.icdoPayeeAccount.benefit_account_type_value == busConstant.BENEFIT_TYPE_DISABILITY)
                {
                    ldecBenefitAmount = abusBenefitCalculationOptions.icdoBenefitCalculationOptions.participant_amount;
                }

                //En PIR 66
                // pir 520 added cond. for lum sum benefit to get ldecSurvivorAmount according to adecSurvivorPercentage
                if (abusPayeeAccount.icdoPayeeAccount.term_certain_end_date == DateTime.MinValue && abusPayeeAccount.icdoPayeeAccount.istrBenefitOption != busConstant.LUMP_SUM_DESCRIPTION)
                {
                    ldecSurvivorAmount = abusBenefitCalculationOptions.icdoBenefitCalculationOptions.survivor_amount;
                }
                else
                {
                    ldecSurvivorAmount = (ldecBenefitAmount / 100) * adecSurvivorPercentage;
                }
            }


            if (lstrBenefitOptionValue == busConstant.LUMP_SUM || lstrBenefitOptionValue == busConstant.TEN_YEARS_CERTAIN_AND_LIFE_ANNUTIY || lstrBenefitOptionValue == busConstant.TWO_YEARS_CERTAIN_AND_LIFE_ANNUITY ||
                  lstrBenefitOptionValue == busConstant.THREE_YEARS_CERTAIN_AND_LIFE_ANNUITY || lstrBenefitOptionValue == busConstant.FIVE_YEARS_CERTAIN_AND_LIFE_ANNUTIY)
            {
                ldecMea = (ldecMea / 100) * adecSurvivorPercentage;
            }

            LoadPaymentHistoryHeaderDetails();

            busPerson lbusSurvivorPerson = new busPerson { icdoPerson = new cdoPerson() };
            busOrganization lbusSurvivorOrg = new busOrganization { icdoOrganization = new cdoOrganization() };


            #region Benefit Calculation Header
            busBenefitCalculationPostRetirementDeath lbusBenefitCalculationPostRetirementDeath = new busBenefitCalculationPostRetirementDeath { icdoBenefitCalculationHeader = new cdoBenefitCalculationHeader() };
            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.benefit_application_id = abusBenefitApplication.icdoBenefitApplication.benefit_application_id;
            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.person_id = abusPayeeAccount.icdoPayeeAccount.person_id;

            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.calculation_type_id = busConstant.BenefitCalculation.CALCULATION_TYPE_CODE_ID;

            if (ablnCreateAdjustmentCalculation)
            {
                lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.calculation_type_value = busConstant.BenefitCalculation.CALCULATION_TYPE_ADJUSTMENT;
            }
            else
            {
                lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.calculation_type_value = busConstant.BenefitCalculation.CALCULATION_TYPE_FINAL;
            }
            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.benefit_type_id = busConstant.BENEFIT_TYPE_CODE_ID;
            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.benefit_type_value = busConstant.BENEFIT_TYPE_DEATH_POST_RETIREMENT;//DOPR DDPT
            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.status_id = busConstant.BenefitCalculation.CALCULATION_STATUS_TYPE_CODE_ID;
            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.status_value = busConstant.BenefitCalculation.CALCULATION_STATUS_TYPE_PENDING;
            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.retirement_date = abusBenefitApplication.icdoBenefitApplication.retirement_date;
            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.age = busGlobalFunctions.CalculatePersonAge(abusBenefitApplication.ibusPerson.icdoPerson.idtDateofBirth, abusBenefitApplication.icdoBenefitApplication.retirement_date);
            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.date_of_death = abusPerson.icdoPerson.date_of_death;
            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.survivor_percentage = adecSurvivorPercentage;
            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.payee_account_id = abusPayeeAccount.icdoPayeeAccount.payee_account_id;


            lbusBenefitCalculationPostRetirementDeath.iclbBenefitCalculationDetail = new Collection<busBenefitCalculationDetail>();


            if (aintBeneficiaryPersonId > 0)
            {
                if (lbusSurvivorPerson.FindPerson(aintBeneficiaryPersonId))
                {
                    lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.beneficiary_person_id = aintBeneficiaryPersonId;
                    lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.beneficiary_person_name = lbusSurvivorPerson.icdoPerson.istrFullName;
                    lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.beneficiary_person_date_of_birth = lbusSurvivorPerson.icdoPerson.idtDateofBirth;
                    lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.idecSurvivorFullAge = busGlobalFunctions.CalculatePersonAge(abusBenefitApplication.ibusPerson.icdoPerson.idtDateofBirth, abusBenefitApplication.icdoBenefitApplication.retirement_date);
                }
            }
            else
            {
                if (lbusSurvivorOrg.FindOrganization(aintBeneficiaryOrgId))
                {
                    lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.organization_id = aintBeneficiaryOrgId;
                }

            }
            #endregion Benefit Calculation Header

            #region Benefit Calculation Details

            busBenefitCalculationDetail lbusBenefitCalculationDetail = new busBenefitCalculationDetail { icdoBenefitCalculationDetail = new cdoBenefitCalculationDetail() };

            lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.benefit_application_detail_id = icdoPayeeAccount.benefit_application_detail_id;
            lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.status_id = busConstant.BenefitCalculation.CALCULATION_STATUS_TYPE_CODE_ID;
            lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.status_value = busConstant.BenefitCalculation.CALCULATION_STATUS_TYPE_PENDING;

            lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.plan_id = abusPayeeAccount.icdoPayeeAccount.iintPlanId;
            lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.person_account_id = lintpersonAccountId;


            lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.monthly_exclusion_amount = ldecMea;
            lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.ee_flag = lstrEEFlag;
            lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.uvhp_flag = lstrUvHpFlag;
            lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.l52_spl_acc_flag = lstrL52Flag;
            lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.l161_spl_acc_flag = lstrL161Flag;
            lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.benefit_subtype_value = abusPayeeAccount.icdoPayeeAccount.retirement_type_value;
            lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.minimum_guarantee_amount = (idecRemainingMinimumGuaranteeAmount / 100) * adecSurvivorPercentage;
            if (abusPayeeAccount.icdoPayeeAccount.iintPlanId == busConstant.IAP_PLAN_ID)
            {
                if (abusPayeeAccount.ibusPayeeBenefitAccount.IsNull())
                {
                    abusPayeeAccount.ibusPayeeBenefitAccount = new busPayeeBenefitAccount { icdoPayeeBenefitAccount = new cdoPayeeBenefitAccount() };
                    abusPayeeAccount.ibusPayeeBenefitAccount.FindPayeeBenefitAccount(abusPayeeAccount.icdoPayeeAccount.payee_benefit_account_id);
                }
                lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.iap_balance_amount = adecIAPBalance;
                lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.final_monthly_benefit_amount = adecIAPBalance;
                //PIR 863
                lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.adjustment_iap_payment_flag = icdoPayeeAccount.adjustment_payment_eligible_flag;
                if (adecIAPBalance != decimal.Zero)
                {
                    if (ibusCalculation == null || ibusCalculation.ibusLatestIAPAllocationSummaryAsofYear == null)
                    {
                        ibusCalculation = new busCalculation();
                        ibusCalculation.ibusLatestIAPAllocationSummaryAsofYear = new busIapAllocationSummary();
                        ibusCalculation.ibusLatestIAPAllocationSummaryAsofYear.LoadLatestAllocationSummaryAsofYear(idtRetirementDate.Year);

                    }
                    if ((ibusCalculation.ibusLatestIAPAllocationSummaryAsofYear.icdoIapAllocationSummary.computation_year) < idtRetirementDate.Year)
                    {
                        if (idtRetirementDate.Month != 1 && idtRetirementDate.Month != 2 && idtRetirementDate.Month != 3)
                        {
                            lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.adjustment_iap_payment_flag = busConstant.FLAG_YES;
                        }
                    }
                }
            }
            lbusBenefitCalculationPostRetirementDeath.iclbBenefitCalculationDetail.Add(lbusBenefitCalculationDetail);
            #endregion

            #region Benefit Calculation Options

            decimal ldecMinimumGuarentee = idecRemainingMinimumGuaranteeAmount;
            if (ldecMinimumGuarentee == decimal.Zero)
            {
                ldecMinimumGuarentee = GetRemainingNonTaxableBeginningBalanaceTillDate(abusPayeeAccount.ibusPayee.icdoPerson.date_of_death);
            }
            lbusBenefitCalculationDetail.iclbBenefitCalculationOptions = new Collection<busBenefitCalculationOptions>();

            //PIR 863
            if (!(abusPayeeAccount.icdoPayeeAccount.iintPlanId == busConstant.IAP_PLAN_ID && abusBenefitCalculationOptions.IsNull())
                && lstrBenefitOptionValue == busConstant.LIFE_ANNUTIY)
            {
                ldecMinimumGuarentee += idecRetroAdjustmentAmount;
            }


            busBenefitCalculationOptions lbusBenefitCalculationOptions = new busBenefitCalculationOptions { icdoBenefitCalculationOptions = new cdoBenefitCalculationOptions() };
            lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.benefit_calculation_detail_id = lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.benefit_calculation_detail_id;

            lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.account_relationship_id = busConstant.BenefitCalculation.ACCOUNT_RELATIONSHIP_CODE_ID;

            if (aintBeneficiaryPersonId > 0)
            {
                lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.account_relationship_value = busConstant.BenefitCalculation.ACCOUNT_RELATIONSHIP_JOINT_ANNUITANT;
            }


            lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.survivor_relationship_id = busConstant.BENEFICIARY_RELATIONSHIP_CODE_ID;
            lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.survivor_relationship_value = astrSurvivorRelation;

            //PROD PIR 100
            busPlanBenefitXr lbusPlanBenefitXr = new busPlanBenefitXr();
            if (lbusPlanBenefitXr.FindPlanBenefitXr(abusPayeeAccount.icdoPayeeAccount.plan_benefit_id))
            {
                string lstrData1Value = HelperUtil.GetData1ByCodeValue(lbusPlanBenefitXr.icdoPlanBenefitXr.benefit_option_id, lbusPlanBenefitXr.icdoPlanBenefitXr.benefit_option_value);
                if (lstrData1Value == busConstant.Joint_Survivor)
                {
                    busCalculation lbusCalculation = new busCalculation();
                    lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.plan_benefit_id = lbusCalculation.GetPlanBenefitId(abusPayeeAccount.icdoPayeeAccount.iintPlanId, busConstant.LIFE_ANNUTIY);
                }
                else
                    lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.plan_benefit_id = abusPayeeAccount.icdoPayeeAccount.plan_benefit_id;
            }

            if (!(abusPayeeAccount.icdoPayeeAccount.iintPlanId == busConstant.IAP_PLAN_ID && abusBenefitCalculationOptions.IsNull()))
            {
                if (lstrBenefitOptionValue == busConstant.TEN_YEARS_CERTAIN_AND_LIFE_ANNUTIY || lstrBenefitOptionValue == busConstant.TWO_YEARS_CERTAIN_AND_LIFE_ANNUITY ||
                lstrBenefitOptionValue == busConstant.THREE_YEARS_CERTAIN_AND_LIFE_ANNUITY || lstrBenefitOptionValue == busConstant.FIVE_YEARS_CERTAIN_AND_LIFE_ANNUTIY)
                {
                    //En PIR 66
                    lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.account_relationship_value = busConstant.BenefitCalculation.ACCOUNT_RELATIONSHIP_BENEFICIARY;
                    lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.survivor_amount = (ldecBenefitAmount / 100) * adecSurvivorPercentage;
                    lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.benefit_amount = ldecBenefitAmount;
                }
                else if (lstrBenefitOptionValue == busConstant.LIFE_ANNUTIY)
                {
                    lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.account_relationship_value = busConstant.BenefitCalculation.ACCOUNT_RELATIONSHIP_BENEFICIARY;

                    lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.plan_benefit_id = ibusCalculation.GetPlanBenefitId(abusPayeeAccount.icdoPayeeAccount.iintPlanId, busConstant.LUMP_SUM);
                    lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.benefit_amount = ldecMinimumGuarentee;
                    lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.survivor_amount = (ldecMinimumGuarentee / 100) * adecSurvivorPercentage;

                }
                else
                {
                    lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.survivor_amount = ldecSurvivorAmount;
                    lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.benefit_amount = ldecBenefitAmount;
                }
            }
            else
            {
                if (abusPayeeAccount.icdoPayeeAccount.istrBenefitOptionValue == busConstant.LUMP_SUM || adecIAPBalance != decimal.Zero)
                {
                    //PROD PIR 520
                    if (abusPayeeAccount.icdoPayeeAccount.istrBenefitOptionValue == busConstant.JOINT_100_PERCENT_SURVIVOR_ANNUITY || abusPayeeAccount.icdoPayeeAccount.istrBenefitOptionValue == busConstant.JOINT_50_PERCENT_SURVIVOR_ANNUITY ||
                                abusPayeeAccount.icdoPayeeAccount.istrBenefitOptionValue == busConstant.JOINT_75_PERCENT_SURVIVOR_ANNUITY || abusPayeeAccount.icdoPayeeAccount.istrBenefitOptionValue == busConstant.JOINT_75_PERCENT_POPUP_ANNUITY ||
                                abusPayeeAccount.icdoPayeeAccount.istrBenefitOptionValue == busConstant.JOINT_66_2by3_PERCENT_SURVIVOR_ANNUITY || abusPayeeAccount.icdoPayeeAccount.istrBenefitOptionValue == busConstant.JOINT_100_PERCENT_POPUP_ANNUITY ||
                                abusPayeeAccount.icdoPayeeAccount.istrBenefitOptionValue == busConstant.JOINT_50_PERCENT_POPUP_ANNUITY)
                        lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.plan_benefit_id = ibusCalculation.GetPlanBenefitId(abusPayeeAccount.icdoPayeeAccount.iintPlanId, busConstant.LIFE_ANNUTIY);
                    else
                        lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.plan_benefit_id = ibusCalculation.GetPlanBenefitId(abusPayeeAccount.icdoPayeeAccount.iintPlanId, busConstant.LUMP_SUM);

                    lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.survivor_amount = (lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.iap_balance_amount / 100) * adecSurvivorPercentage;
                    lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.iap_balance_amount = lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.survivor_amount;
                    lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.benefit_amount = lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.iap_balance_amount;
                }
                else
                {
                    decimal ldecBenefitOptionFactor = ibusCalculation.GetBenefitOptionFactor(abusPayeeAccount.icdoPayeeAccount.benefit_account_type_value, abusPayeeAccount.icdoPayeeAccount.plan_benefit_id,
                                                                            Convert.ToInt32(lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.idecParticipantFullAge), Convert.ToInt32(lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.idecSurvivorFullAge)) * 12;

                    ldecBenefitAmount = Convert.ToDecimal(Math.Round(lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.iap_balance_amount / ldecBenefitOptionFactor, 2));
                    if (lstrBenefitOptionValue == busConstant.LIFE_ANNUTIY || lstrBenefitOptionValue == busConstant.TEN_YEARS_CERTAIN_AND_LIFE_ANNUTIY || lstrBenefitOptionValue == busConstant.TWO_YEARS_CERTAIN_AND_LIFE_ANNUITY ||
                lstrBenefitOptionValue == busConstant.THREE_YEARS_CERTAIN_AND_LIFE_ANNUITY || lstrBenefitOptionValue == busConstant.FIVE_YEARS_CERTAIN_AND_LIFE_ANNUTIY)
                    {
                        ldecSurvivorAmount = (ldecBenefitAmount / 100) * adecSurvivorPercentage;
                    }
                    else
                    {
                        ldecSurvivorAmount = ibusCalculation.GetSurvivorAmountFromBenefitAmount(ldecBenefitAmount, lstrBenefitOptionValue);
                    }
                    // FIX FOR PLAN BENEFIT ID
                    lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.plan_benefit_id = ibusCalculation.GetPlanBenefitId(abusPayeeAccount.icdoPayeeAccount.iintPlanId, lstrBenefitOptionValue);
                    lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.benefit_amount = ldecBenefitAmount;
                    lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.survivor_amount = ldecSurvivorAmount;
                }
            }
            lbusBenefitCalculationDetail.iclbBenefitCalculationOptions.Add(lbusBenefitCalculationOptions);


            #endregion

            #region Insert Calculation Object

            bool lblnInsert = true;
            if (abusPayeeAccount.icdoPayeeAccount.iintPlanId == busConstant.IAP_PLAN_ID && adecIAPBalance <= decimal.Zero)
            {
                lblnInsert = false;
            }
            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.Insert();
            if (lblnInsert)
            {
                lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.benefit_calculation_header_id = lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.benefit_calculation_header_id;
                lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.Insert();
                lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.benefit_calculation_detail_id = lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.benefit_calculation_detail_id;
                lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.Insert();
            }
            #endregion

            //// PROD PIR 127
            lbusBenefitCalculationPostRetirementDeath.AfterPersistChanges();

            if (lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.benefit_calculation_header_id > 0)
            {
                busWorkflowHelper.InitializeWorkflowIfNotExists(busConstant.POSTRETIREMENT_DEATH_PAYSURVIVOR_WORKFLOW_NAME, abusPayeeAccount.icdoPayeeAccount.person_id, 0, lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.benefit_calculation_header_id, null);
                // SetWorkflowRelatedVariablesforPaySurvivor(icdoPayeeAccount.payee_account_id, lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.benefit_calculation_header_id);
            }

        }

        public void CreatePostRetirementCalculationForContingentBen(busBenefitCalculationDetail abusBenefitCalculationDetail,
       busBenefitCalculationOptions abusBenefitCalculationOptions, busBenefitApplication abusBenefitApplication, busPayeeAccount abusPayeeAccount,
       busPerson abusPerson, int aintBeneficiaryPersonId, int aintBeneficiaryOrgId, string astrBeneficiaryTypeValue, string astrSurvivorRelation, decimal adecSurvivorPercentage,
            bool ablnCreateAdjustmentCalculation, decimal adecIAPBalance)
        {

            int lintpersonAccountId = 0;
            decimal ldecBenefitAmount = decimal.Zero;
            decimal ldecMea = decimal.Zero;
            decimal ldecNonTaxableAmount = decimal.Zero;
            decimal ldecTaxableAnount = decimal.Zero;
            string lstrEEFlag = busConstant.FLAG_NO;
            string lstrUvHpFlag = busConstant.FLAG_NO;
            string lstrL52Flag = busConstant.FLAG_NO;
            string lstrL161Flag = busConstant.FLAG_NO;
            string lstrBenefitOptionValue = string.Empty;

            abusPayeeAccount.LoadBenefitDetails();
            lstrBenefitOptionValue = abusPayeeAccount.icdoPayeeAccount.istrBenefitOptionValue;


            if (abusBenefitCalculationOptions == null)
            {
                if (abusPayeeAccount.icdoPayeeAccount.iintPlanId != busConstant.IAP_PLAN_ID)
                {
                    ibusCalculation.GetTaxableAndNonTaxableAmountFromPaymentItemTypes(this, out ldecTaxableAnount, out ldecNonTaxableAmount);
                    ldecMea = ldecNonTaxableAmount;
                    ldecBenefitAmount = ldecTaxableAnount + ldecNonTaxableAmount;
                }
                if (abusPayeeAccount.ibusPayee.iclbPersonAccount.IsNullOrEmpty())
                {
                    abusPayeeAccount.ibusPayee.LoadPersonAccounts();
                }
                if (abusPayeeAccount.ibusPayee.iclbPersonAccount.Count > 0)
                {
                    if (abusPayeeAccount.ibusPayee.iclbPersonAccount.Where(item => item.icdoPersonAccount.plan_id == this.icdoPayeeAccount.iintPlanId).Count() > 0)
                    {
                        lintpersonAccountId = abusPayeeAccount.ibusPayee.iclbPersonAccount.Where(item => item.icdoPersonAccount.plan_id == this.icdoPayeeAccount.iintPlanId).FirstOrDefault().icdoPersonAccount.person_account_id;
                    }
                }
            }
            else
            {
                lintpersonAccountId = abusBenefitCalculationDetail.icdoBenefitCalculationDetail.person_account_id;
                ldecMea = abusBenefitCalculationDetail.icdoBenefitCalculationDetail.monthly_exclusion_amount;
                lstrEEFlag = abusBenefitCalculationDetail.icdoBenefitCalculationDetail.ee_flag;
                lstrUvHpFlag = abusBenefitCalculationDetail.icdoBenefitCalculationDetail.uvhp_flag;
                lstrL52Flag = abusBenefitCalculationDetail.icdoBenefitCalculationDetail.l52_spl_acc_flag;
                lstrL161Flag = abusBenefitCalculationDetail.icdoBenefitCalculationDetail.l161_spl_acc_flag;
                if (abusPayeeAccount.icdoPayeeAccount.benefit_account_type_value == busConstant.BENEFIT_TYPE_RETIREMENT)
                {
                    ldecBenefitAmount = abusBenefitCalculationOptions.icdoBenefitCalculationOptions.benefit_amount;
                }
                else if (abusPayeeAccount.icdoPayeeAccount.benefit_account_type_value == busConstant.BENEFIT_TYPE_DISABILITY)
                {
                    ldecBenefitAmount = abusBenefitCalculationOptions.icdoBenefitCalculationOptions.participant_amount;
                }
            }

            if (lstrBenefitOptionValue == busConstant.LUMP_SUM || lstrBenefitOptionValue == busConstant.TEN_YEARS_CERTAIN_AND_LIFE_ANNUTIY || lstrBenefitOptionValue == busConstant.TWO_YEARS_CERTAIN_AND_LIFE_ANNUITY ||
                lstrBenefitOptionValue == busConstant.THREE_YEARS_CERTAIN_AND_LIFE_ANNUITY || lstrBenefitOptionValue == busConstant.FIVE_YEARS_CERTAIN_AND_LIFE_ANNUTIY)
            {
                ldecMea = (ldecMea / 100) * adecSurvivorPercentage;
            }

            //PROD PIR 111
            //else
            //{
            //    ldecMea = ibusCalculation.GetSurvivorAmountFromBenefitAmount(ldecMea, lstrBenefitOptionValue);
            //}

            LoadPaymentHistoryHeaderDetails();

            busPerson lbusSurvivorPerson = new busPerson { icdoPerson = new cdoPerson() };
            busOrganization lbusSurvivorOrg = new busOrganization { icdoOrganization = new cdoOrganization() };

            #region Header
            busBenefitCalculationPostRetirementDeath lbusBenefitCalculationPostRetirementDeath = new busBenefitCalculationPostRetirementDeath { icdoBenefitCalculationHeader = new cdoBenefitCalculationHeader() };
            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.benefit_application_id = abusBenefitApplication.icdoBenefitApplication.benefit_application_id;
            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.person_id = abusPayeeAccount.icdoPayeeAccount.person_id;

            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.calculation_type_id = busConstant.BenefitCalculation.CALCULATION_TYPE_CODE_ID;

            if (ablnCreateAdjustmentCalculation)
            {
                lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.calculation_type_value = busConstant.BenefitCalculation.CALCULATION_TYPE_ADJUSTMENT;
            }
            else
            {
                lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.calculation_type_value = busConstant.BenefitCalculation.CALCULATION_TYPE_FINAL;
            }
            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.benefit_type_id = busConstant.BENEFIT_TYPE_CODE_ID;
            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.benefit_type_value = busConstant.BENEFIT_TYPE_DEATH_POST_RETIREMENT;//DOPR DDPT
            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.status_id = busConstant.BenefitCalculation.CALCULATION_STATUS_TYPE_CODE_ID;
            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.status_value = busConstant.BenefitCalculation.CALCULATION_STATUS_TYPE_PENDING;
            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.retirement_date = abusBenefitApplication.icdoBenefitApplication.retirement_date;
            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.age = busGlobalFunctions.CalculatePersonAge(abusBenefitApplication.ibusPerson.icdoPerson.idtDateofBirth, abusBenefitApplication.icdoBenefitApplication.retirement_date);
            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.date_of_death = abusPerson.icdoPerson.date_of_death;
            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.survivor_percentage = adecSurvivorPercentage;
            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.payee_account_id = abusPayeeAccount.icdoPayeeAccount.payee_account_id;



            lbusBenefitCalculationPostRetirementDeath.iclbBenefitCalculationDetail = new Collection<busBenefitCalculationDetail>();


            if (aintBeneficiaryPersonId > 0)
            {
                if (lbusSurvivorPerson.FindPerson(aintBeneficiaryPersonId))
                {
                    lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.beneficiary_person_id = aintBeneficiaryPersonId;
                    lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.beneficiary_person_name = lbusSurvivorPerson.icdoPerson.istrFullName;
                    lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.beneficiary_person_date_of_birth = lbusSurvivorPerson.icdoPerson.idtDateofBirth;
                }
            }
            else
            {
                if (lbusSurvivorOrg.FindOrganization(aintBeneficiaryOrgId))
                {
                    lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.organization_id = aintBeneficiaryOrgId;
                }

            }

            busCalculation lbusCalculation = new busCalculation();
            busBenefitApplication lbusBenefitApplication = new busBenefitApplication();
            #endregion

            #region Benefit Calculation Details

            busBenefitCalculationDetail lbusBenefitCalculationDetail = new busBenefitCalculationDetail { icdoBenefitCalculationDetail = new cdoBenefitCalculationDetail() };

            lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.benefit_application_detail_id = icdoPayeeAccount.benefit_application_detail_id;
            lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.status_id = busConstant.BenefitCalculation.CALCULATION_STATUS_TYPE_CODE_ID;
            lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.status_value = busConstant.BenefitCalculation.CALCULATION_STATUS_TYPE_PENDING;

            lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.plan_id = abusPayeeAccount.icdoPayeeAccount.iintPlanId;
            lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.person_account_id = lintpersonAccountId;



            lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.iap_balance_amount = adecIAPBalance;
            lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.final_monthly_benefit_amount = adecIAPBalance;

            lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.ee_flag = lstrEEFlag;
            lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.uvhp_flag = lstrUvHpFlag;
            lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.l52_spl_acc_flag = lstrL52Flag;
            lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.l161_spl_acc_flag = lstrL161Flag;
            lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.benefit_subtype_value = abusPayeeAccount.icdoPayeeAccount.retirement_type_value;
            lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.minimum_guarantee_amount = (idecRemainingMinimumGuaranteeAmount / 100) * adecSurvivorPercentage;
            lbusBenefitCalculationPostRetirementDeath.iclbBenefitCalculationDetail.Add(lbusBenefitCalculationDetail);



            #endregion

            #region Benefit Calculation Options

            decimal ldecMinimumGuarentee = idecRemainingMinimumGuaranteeAmount;
            if (ldecMinimumGuarentee == decimal.Zero)
            {
                ldecMinimumGuarentee = GetRemainingNonTaxableBeginningBalanaceTillDate(abusPayeeAccount.ibusPayee.icdoPerson.date_of_death);
                if (ldecMinimumGuarentee == decimal.Zero)
                {
                    ldecMinimumGuarentee = GetRemainingNonTaxableBeginningBalanaceTillDate(abusPayeeAccount.ibusPayee.icdoPerson.date_of_death);
                }
            }
            lbusBenefitCalculationDetail.iclbBenefitCalculationOptions = new Collection<busBenefitCalculationOptions>();


            busBenefitCalculationOptions lbusBenefitCalculationOptions = new busBenefitCalculationOptions { icdoBenefitCalculationOptions = new cdoBenefitCalculationOptions() };
            lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.benefit_calculation_detail_id = lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.benefit_calculation_detail_id;

            lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.account_relationship_id = busConstant.BenefitCalculation.ACCOUNT_RELATIONSHIP_CODE_ID;


            lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.account_relationship_value = busConstant.BenefitCalculation.ACCOUNT_RELATIONSHIP_BENEFICIARY;


            lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.survivor_relationship_id = busConstant.BENEFICIARY_RELATIONSHIP_CODE_ID;
            lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.survivor_relationship_value = astrSurvivorRelation;



            if ((lstrBenefitOptionValue == busConstant.TEN_YEARS_CERTAIN_AND_LIFE_ANNUTIY || lstrBenefitOptionValue == busConstant.TWO_YEARS_CERTAIN_AND_LIFE_ANNUITY ||
           lstrBenefitOptionValue == busConstant.THREE_YEARS_CERTAIN_AND_LIFE_ANNUITY || lstrBenefitOptionValue == busConstant.FIVE_YEARS_CERTAIN_AND_LIFE_ANNUTIY) && abusPayeeAccount.icdoPayeeAccount.iintPlanId != busConstant.IAP_PLAN_ID)
            {
                lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.survivor_amount = (ldecBenefitAmount / 100) * adecSurvivorPercentage;
                lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.benefit_amount = ldecBenefitAmount;
                // FIX FOR PLAN BENEFIT ID
                lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.plan_benefit_id = lbusCalculation.GetPlanBenefitId(abusPayeeAccount.icdoPayeeAccount.iintPlanId, busConstant.LUMP_SUM);
            }
            else
            {
                if (abusPayeeAccount.icdoPayeeAccount.iintPlanId == busConstant.IAP_PLAN_ID)
                {
                    lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.survivor_amount = (lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.iap_balance_amount / 100) * adecSurvivorPercentage;
                    lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.iap_balance_amount = lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.survivor_amount;
                    lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.benefit_amount = lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.iap_balance_amount;
                    // FIX FOR PLAN BENEFIT ID
                    lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.plan_benefit_id = lbusCalculation.GetPlanBenefitId(abusPayeeAccount.icdoPayeeAccount.iintPlanId, busConstant.LUMP_SUM);
                }
                else
                {
                    lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.plan_benefit_id = lbusCalculation.GetPlanBenefitId(abusPayeeAccount.icdoPayeeAccount.iintPlanId, busConstant.LUMP_SUM);

                    lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.survivor_amount = (ldecMinimumGuarentee / 100) * adecSurvivorPercentage;

                    lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.benefit_amount = ldecBenefitAmount;
                }
            }


            lbusBenefitCalculationDetail.iclbBenefitCalculationOptions.Add(lbusBenefitCalculationOptions);


            #endregion

            #region Insert Calculation Object
            bool lblnInsert = true;
            if (adecIAPBalance <= decimal.Zero && abusPayeeAccount.icdoPayeeAccount.iintPlanId == busConstant.IAP_PLAN_ID)
            {
                lblnInsert = false;
            }
            lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.Insert();
            if (lblnInsert)
            {
                lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.benefit_calculation_header_id = lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.benefit_calculation_header_id;
                lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.Insert();
                lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.benefit_calculation_detail_id = lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.benefit_calculation_detail_id;
                lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.Insert();
            }

            #endregion


            if (lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.benefit_calculation_header_id > 0)
            {
                busWorkflowHelper.InitializeWorkflowIfNotExists(busConstant.POSTRETIREMENT_DEATH_PAYSURVIVOR_WORKFLOW_NAME, abusPayeeAccount.icdoPayeeAccount.person_id, 0, lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.benefit_calculation_header_id, null);
                // SetWorkflowRelatedVariablesforPaySurvivor(icdoPayeeAccount.payee_account_id, lbusBenefitCalculationPostRetirementDeath.icdoBenefitCalculationHeader.benefit_calculation_header_id);
            }

        }

        public void SetWorkflowRelatedVariablesforPaySurvivor(int aintPayeeAccountID, int aintBenefitCalculationHeaderID = 0)
        {
            PAYEE_ACCOUNT_ID = aintPayeeAccountID;
            FINAL_CALCULATION_ID = aintBenefitCalculationHeaderID;
        }

        public void LoadWithholdingInformation()
        {
            DataTable ldtbList = Select<cdoWithholdingInformation>(
                new string[1] { enmWithholdingInformation.payee_account_id.ToString() },
                new object[1] { icdoPayeeAccount.payee_account_id }, null, null);
            iclbWithholdingInformation = GetCollection<busWithholdingInformation>(ldtbList, "icdoWithholdingInformation");
        }

        public void LoadWithholdingInformationHistoryDetail()
        {
            DataTable ldtblist = Select<cdoWithholdingInformationHistoryDetail>(
                new string[1] { enmWithholdingInformationHistoryDetail.payee_account_id.ToString() },
                new object[1] { icdoPayeeAccount.payee_account_id }, null, null);
            iclbWithholdingInformationHistoryDetail = GetCollection<busWithholdingInformationHistoryDetail>(ldtblist, "icdoWithholdingInformationHistoryDetail");

        }

        #region Create Or Update Payee Account Payment Item Type For Deduction
        public void CreateOrUpdatePaymentItemTypeForDeduction(busPayeeAccountDeduction lbusPayeeAccountDeduction)
        {
            string astrItemCode = string.Empty;

            if (idtNextBenefitPaymentDate == DateTime.MinValue)
                LoadNextBenefitPaymentDate();

            switch (lbusPayeeAccountDeduction.icdoPayeeAccountDeduction.deduction_type_value)
            {
                case busConstant.DeductionTypeValueIRSL:
                    astrItemCode = busConstant.ITEM41;
                    break;

                case busConstant.DeductionTypeValueChildSupport:
                    astrItemCode = busConstant.ITEM42;
                    break;

                case busConstant.DeductionTypeValueOther:
                    astrItemCode = busConstant.ITEM44;
                    break;

                case busConstant.DeductionTypeValueSpousalSupport:
                    astrItemCode = busConstant.ITEM43;
                    break;
            }


            if (astrItemCode.IsNotNullOrEmpty())
            {
                busPaymentItemType lobjPaymentItemType = new busPaymentItemType();
                lobjPaymentItemType.FindPaymentItemTypeByItemCode(astrItemCode);
                lbusPayeeAccountDeduction.icdoPayeeAccountDeduction.payment_item_type_id = lobjPaymentItemType.icdoPaymentItemType.payment_item_type_id;
                if (lbusPayeeAccountDeduction.icdoPayeeAccountDeduction.payee_account_payment_item_type_id == 0)
                {
                    lbusPayeeAccountDeduction.icdoPayeeAccountDeduction.payee_account_payment_item_type_id = CreatePayeeAccountPaymentItemType(astrItemCode,
                    lbusPayeeAccountDeduction.icdoPayeeAccountDeduction.amount, lbusPayeeAccountDeduction.icdoPayeeAccountDeduction.account_number, 0, idtBenefitPaymentDateForDeduction,
                    DateTime.MinValue, busConstant.FLAG_NO, false, false, lbusPayeeAccountDeduction.icdoPayeeAccountDeduction.payee_account_payment_item_type_id);
                }
                else
                {
                    lbusPayeeAccountDeduction.icdoPayeeAccountDeduction.payee_account_payment_item_type_id = CreatePayeeAccountPaymentItemType(astrItemCode,
                    lbusPayeeAccountDeduction.icdoPayeeAccountDeduction.amount, lbusPayeeAccountDeduction.icdoPayeeAccountDeduction.account_number, 0, idtBenefitPaymentDateForDeduction,
                    DateTime.MinValue, busConstant.FLAG_NO, false, false, lbusPayeeAccountDeduction.icdoPayeeAccountDeduction.payee_account_payment_item_type_id);
                    lbusPayeeAccountDeduction.icdoPayeeAccountDeduction.Update(); //Updating Payee Account Deduction.                
                }
                LoadPayeeAccountPaymentItemType();
            }
        }
        #endregion

        #region Create Payee Account Fed Tax Withholding for EmergencyOneTime Payment
        //EmergencyOneTimePayment - 03/17/2020
        public int CreateFedStateTaxForIAPLumpSumPayment(decimal ldecTaxableAmount, decimal ldecFedTaxPercentage, decimal ldecStateTaxPercentage, DateTime ldteNextBenefitPaymentDate)
        {
            if (ldecFedTaxPercentage != 0)
            {
                decimal ldecFedTaxAmount = ldecTaxableAmount * ldecFedTaxPercentage / 100;
                int iPayeeAccountPaymentitemtypeid = CreatePayeeAccountPaymentItemType("ITEM33", ldecFedTaxAmount, "0", 1,
                                        ldteNextBenefitPaymentDate, DateTime.MinValue, "N", false);
                cdoPayeeAccountTaxWithholding icdoPayeeAccountFedTaxWithholding = new cdoPayeeAccountTaxWithholding();
                int iPayeeAccountTaxWithholdingid = 0;
                icdoPayeeAccountFedTaxWithholding.payee_account_id = icdoPayeeAccount.payee_account_id;
                icdoPayeeAccountFedTaxWithholding.tax_identifier_value = "FDRL";
                icdoPayeeAccountFedTaxWithholding.benefit_distribution_type_value = "LSDB";
                icdoPayeeAccountFedTaxWithholding.start_date = ldteNextBenefitPaymentDate;
                icdoPayeeAccountFedTaxWithholding.tax_option_value = "FLAP";
                icdoPayeeAccountFedTaxWithholding.tax_percentage = ldecFedTaxPercentage;
                icdoPayeeAccountFedTaxWithholding.Insert();

                iPayeeAccountTaxWithholdingid = icdoPayeeAccountFedTaxWithholding.payee_account_tax_withholding_id;

                if (iPayeeAccountTaxWithholdingid != 0)
                {
                    cdoPayeeAccountTaxWithholdingItemDetail icdoPayeeAccountFedTaxWithholdingitemid = new cdoPayeeAccountTaxWithholdingItemDetail();
                    icdoPayeeAccountFedTaxWithholdingitemid.payee_account_tax_withholding_id = iPayeeAccountTaxWithholdingid;
                    icdoPayeeAccountFedTaxWithholdingitemid.payee_account_payment_item_type_id = iPayeeAccountPaymentitemtypeid;
                    icdoPayeeAccountFedTaxWithholdingitemid.payment_item_type_id = 33;
                    icdoPayeeAccountFedTaxWithholdingitemid.amount = ldecFedTaxAmount;
                    icdoPayeeAccountFedTaxWithholdingitemid.Insert();
                }
            }

            if (ldecStateTaxPercentage != 0)
            {
                decimal ldecStateTaxAmount = ldecTaxableAmount * ldecStateTaxPercentage / 100;
                int iPayeeAccountPaymentitemtypeid = CreatePayeeAccountPaymentItemType("ITEM34", ldecStateTaxAmount, "0", 2,
                                        ldteNextBenefitPaymentDate, DateTime.MinValue, "N", false);
                cdoPayeeAccountTaxWithholding icdoPayeeAccountStateTaxWithholding = new cdoPayeeAccountTaxWithholding();
                int iPayeeAccountTaxWithholdingid = 0;
                icdoPayeeAccountStateTaxWithholding.payee_account_id = icdoPayeeAccount.payee_account_id;
                icdoPayeeAccountStateTaxWithholding.tax_identifier_value = "STAT";
                icdoPayeeAccountStateTaxWithholding.benefit_distribution_type_value = "LSDB";
                icdoPayeeAccountStateTaxWithholding.start_date = ldteNextBenefitPaymentDate;
                icdoPayeeAccountStateTaxWithholding.tax_option_value = "FLAP";
                icdoPayeeAccountStateTaxWithholding.tax_percentage = ldecStateTaxPercentage;
                icdoPayeeAccountStateTaxWithholding.Insert();

                iPayeeAccountTaxWithholdingid = icdoPayeeAccountStateTaxWithholding.payee_account_tax_withholding_id;

                if (iPayeeAccountTaxWithholdingid != 0)
                {
                    cdoPayeeAccountTaxWithholdingItemDetail icdoPayeeAccountFedTaxWithholdingitemid = new cdoPayeeAccountTaxWithholdingItemDetail();
                    icdoPayeeAccountFedTaxWithholdingitemid.payee_account_tax_withholding_id = iPayeeAccountTaxWithholdingid;
                    icdoPayeeAccountFedTaxWithholdingitemid.payee_account_payment_item_type_id = iPayeeAccountPaymentitemtypeid;
                    icdoPayeeAccountFedTaxWithholdingitemid.payment_item_type_id = 34;
                    icdoPayeeAccountFedTaxWithholdingitemid.amount = ldecStateTaxAmount;
                    icdoPayeeAccountFedTaxWithholdingitemid.Insert();
                }
            }

            return 0;
        }
        #endregion

        public bool CheckMonthlyLimit()
        {
            if (idtNextBenefitPaymentDate == DateTime.MinValue)
                LoadNextBenefitPaymentDate();
            if (iclbPayeeAccountPaymentItemType == null)
                LoadPayeeAccountPaymentItemType();

            // PROD PIR 295
            //decimal idecTotalNetPaymentACH = idecNextNetPaymentACH + idecNextNetPaymentRollOver;
            decimal idecTotalNetPaymentACH = this.idecNextGrossPaymentACH + idecRetroAdjustmentAmount + idecNextGrossPaymentRollOver; // PROD PIR 389
            if (icdoPayeeAccount.iintPlanId != busConstant.IAP_PLAN_ID)
            {
                if (idecTotalNetPaymentACH >= (Convert.ToDecimal(HelperUtil.GetData1ByCodeValue(7034, busConstant.PensionMonthlyLimit))))
                {
                    return true;
                }
            }
            else
            {
                if (idecTotalNetPaymentACH >= (Convert.ToDecimal(HelperUtil.GetData1ByCodeValue(7034, busConstant.IAPMonthlyLimit))))
                {
                    return true;
                }
            }
            return false;
        }

        public void GetCuurentPayeeAccountStatus()
        {
            if (iclbPayeeAccountStatus == null)
                LoadPayeeAccountStatuss();
            busPayeeAccountStatus lobjbusPayeeAccountStatusLatestRecord = (from obj in iclbPayeeAccountStatus.AsEnumerable()
                                                                           where obj.icdoPayeeAccountStatus.status_effective_date.Date == iclbPayeeAccountStatus.Max(item => item.icdoPayeeAccountStatus.status_effective_date.Date)
                                                                           select obj).FirstOrDefault();
            istrPayeeStatus = busGlobalFunctions.GetCodeValueDescriptionByValue(lobjbusPayeeAccountStatusLatestRecord.icdoPayeeAccountStatus.status_id,
                lobjbusPayeeAccountStatusLatestRecord.icdoPayeeAccountStatus.status_value).description;


        }

        #region Create Payee Account For BOB

        /// <summary>
        /// Will be called from payee account of survivor : Survivor Is Receiving Payments and dies, Main Participant details stored in ibusParticipant
        /// Payee Account Will be created
        /// MPI PLan : Need to pick the updated minimum gurantee 
        /// Locals : As discussed no Benefit
        /// </summary>
        /// 
        public void CreatePayeeAccountForBOB(busPayeeAccount abusPayeeAccount, busPersonAccountBeneficiary abusPersonAccountBeneficiary, int aintSurvivorID, int aintBOBPersonID, int aintBOBOrgID,
            string astrRelationshipValue)
        {
            decimal ldecBenefitAmount = 0M;
            decimal ldecTaxableBenefitAmount = 0M;
            decimal ldecNonTaxableBenefitAmount = 0M;
            decimal ldecRemainingMinGuarantee = decimal.Zero;
            decimal ldecRemaingStartingNonTaxableAmount = decimal.Zero;

            decimal ldecPercentage = abusPersonAccountBeneficiary.icdoPersonAccountBeneficiary.dist_percent;
            string lstrBenefitOptionValue = string.Empty;
            int lintPlanId = abusPayeeAccount.icdoPayeeAccount.iintPlanId;
            lstrBenefitOptionValue = abusPayeeAccount.icdoPayeeAccount.istrBenefitOptionValue;
            int lintParticipantId = abusPayeeAccount.icdoPayeeAccount.person_id;

            ibusCalculation.GetTaxableAndNonTaxableAmountFromPaymentItemTypes(abusPayeeAccount, out ldecTaxableBenefitAmount, out ldecNonTaxableBenefitAmount);
            ldecBenefitAmount = ldecTaxableBenefitAmount + ldecNonTaxableBenefitAmount;

            //Load the Person Account of the Survivor [Search using the Comb of Beneficiary Person Id and Beneficiary of]
            //lbusBenefitCalculationDetail.LoadBenefitCalculationOptionss();
            this.LoadPaymentHistoryHeaderDetails();

            //busBenefitCalculationOptions lbusBenefitCalculationOptions = new busBenefitCalculationOptions { icdoBenefitCalculationOptions = new cdoBenefitCalculationOptions() };
            //lbusBenefitCalculationOptions = lbusBenefitCalculationDetail.iclbBenefitCalculationOptions.First();
            //lbusBenefitCalculationOptions.LoadPlanBenefitXr();

            //R3view -- IF Term Year Certain Option FIND the end Date 
            LoadPlanBenefitsForPlan(lintPlanId);
            int iintTermCertainMonths = busConstant.ZERO_INT;
            iintTermCertainMonths = busPayeeAccountHelper.IsTermCertainBenefitOption(abusPayeeAccount.icdoPayeeAccount.plan_benefit_id, this.iclbcdoPlanBenefit);
            ldecRemainingMinGuarantee = GetRemainingMinimumGuaranteeTillDate(this.ibusPayee.icdoPerson.date_of_death);
            ldecRemaingStartingNonTaxableAmount = GetRemainingNonTaxableBeginningBalanaceTillDate(this.ibusPayee.icdoPerson.date_of_death);
            if (ldecRemainingMinGuarantee == decimal.Zero)
            {
                ldecRemainingMinGuarantee = ldecRemaingStartingNonTaxableAmount;
            }
            if (lstrBenefitOptionValue != busConstant.LUMP_SUM)
            {
                if (iintTermCertainMonths > 0 && ldecBenefitAmount <= Decimal.Zero)
                {
                    utlError lobjError = new utlError();
                    lobjError = AddError(6057, "");//R3view 
                    this.iarrErrors.Add(lobjError);
                }
                else if (iintTermCertainMonths == 0 && ldecRemainingMinGuarantee == 0)
                {
                    utlError lobjError = new utlError();
                    lobjError = AddError(0, "Minimum Guarantee Amount is zero");//R3view 
                    this.iarrErrors.Add(lobjError);
                }
                else if ((iintTermCertainMonths > 0 && ldecBenefitAmount > Decimal.Zero) ||
                    (iintTermCertainMonths == 0 && ldecRemainingMinGuarantee > 0))
                {
                    int lintBenefitAccountID = 0;
                    int lintPayeeAccountID = 0;
                    string lstrFundsType = String.Empty;

                    //Benefit Account Related
                    decimal ldecAccountOwnerStartingTaxableAmount = 0.0M;
                    decimal ldecAccountOwnerStartingNonTaxableAmount = 0.0M;
                    decimal ldecAccountOwnerStartingGrossAmount = 0.0M;

                    busPayeeAccount lbusPayeeAccount = new busPayeeAccount { icdoPayeeAccount = new cdoPayeeAccount() };
                    busPayeeBenefitAccount lbusPayeeBenefitAccount = new busPayeeBenefitAccount { icdoPayeeBenefitAccount = new cdoPayeeBenefitAccount() };


                    //Need to change the logic here should be 
                    DateTime ldteBenefitBeginDate = new DateTime();

                    if (this.ibusPayee.icdoPerson.date_of_death.Day == 1)
                    {
                        ldteBenefitBeginDate = this.ibusPayee.icdoPerson.date_of_death.AddMonths(1);
                    }
                    else
                    {
                        ldteBenefitBeginDate = this.ibusPayee.icdoPerson.date_of_death.GetLastDayofMonth().AddDays(1);
                    }


                    DataTable ldtblPayeeBenefitAccount = Select("cdoPayeeBenefitAccount.GetPayeeBenefitAccount", new object[1] { this.icdoPayeeAccount.payee_benefit_account_id });
                    if (ldtblPayeeBenefitAccount.Rows.Count > 0)
                    {
                        if (Convert.ToString(ldtblPayeeBenefitAccount.Rows[0][enmPayeeBenefitAccount.starting_taxable_amount.ToString().ToUpper()]).IsNotNullOrEmpty())
                            ldecAccountOwnerStartingTaxableAmount = Convert.ToDecimal(ldtblPayeeBenefitAccount.Rows[0][enmPayeeBenefitAccount.starting_taxable_amount.ToString().ToUpper()]);

                        if (Convert.ToString(ldtblPayeeBenefitAccount.Rows[0][enmPayeeBenefitAccount.starting_nontaxable_amount.ToString().ToUpper()]).IsNotNullOrEmpty())
                            ldecAccountOwnerStartingNonTaxableAmount = Convert.ToDecimal(ldtblPayeeBenefitAccount.Rows[0][enmPayeeBenefitAccount.starting_nontaxable_amount.ToString().ToUpper()]);

                        ldecAccountOwnerStartingGrossAmount = ldecAccountOwnerStartingTaxableAmount + ldecAccountOwnerStartingNonTaxableAmount;
                        lstrFundsType = Convert.ToString(ldtblPayeeBenefitAccount.Rows[0][enmPayeeBenefitAccount.funds_type_value.ToString().ToUpper()]);
                    }

                    //Benefit Account
                    lintBenefitAccountID = busPayeeAccountHelper.IsBenefitAccountExists(abusPersonAccountBeneficiary.icdoPersonAccountBeneficiary.person_account_id,
                                                                                         abusPayeeAccount.icdoPayeeAccount.benefit_account_type_value, lstrFundsType);  //R3view  the Query and code for this one.

                    lintBenefitAccountID = lbusPayeeBenefitAccount.ManagePayeeBenefitAccount(lintBenefitAccountID, lintParticipantId,
                                                                      abusPersonAccountBeneficiary.icdoPersonAccountBeneficiary.person_account_id,
                                                                      ldecAccountOwnerStartingTaxableAmount, ldecAccountOwnerStartingNonTaxableAmount, ldecAccountOwnerStartingGrossAmount, lstrFundsType);

                    //Payee Account //R3view this code
                    if (aintBOBPersonID > 0)
                        lintPayeeAccountID = busPayeeAccountHelper.IsPayeeAccountExists(aintBOBPersonID, lintBenefitAccountID, busConstant.BenefitCalculation.ACCOUNT_RELATIONSHIP_BENEFICIARY, abusPayeeAccount.icdoPayeeAccount.benefit_account_type_value, false, lintPlanId
                            );
                    else if (aintBOBOrgID > 0)
                        lintPayeeAccountID = busPayeeAccountHelper.IsPayeeAccountExists(aintBOBOrgID, lintBenefitAccountID, busConstant.BenefitCalculation.ACCOUNT_RELATIONSHIP_BENEFICIARY, abusPayeeAccount.icdoPayeeAccount.benefit_account_type_value, false, lintPlanId
                             );
                    busCalculation lbusCalculation = new busCalculation();


                    decimal ldecNonTaxableBeginningBalance = 0.0M;
                    decimal ldecRemainingMinimumGuaranteeAmount = (ldecRemainingMinGuarantee / 100) * ldecPercentage;

                    //Need to do in Payment Adjustment
                    if (lintPlanId == busConstant.MPIPP_PLAN_ID)
                    {
                        ldecNonTaxableBeginningBalance = (ldecRemaingStartingNonTaxableAmount / 100) * ldecPercentage;
                    }

                    DateTime ldteTermCertainEndDate = new DateTime();
                    string lstrFamilyRelationshipValue = string.Empty;
                    lstrFamilyRelationshipValue = astrRelationshipValue;

                    if (iintTermCertainMonths > 0)
                    {
                        ldteTermCertainEndDate = this.icdoPayeeAccount.term_certain_end_date;
                    }


                    //Family Relationship value
                    //DataTable ldtbRelationshipValue = busBase.Select("cdoRelationship.GetRelationType", new object[2] { this.icdoBenefitCalculationHeader.person_id, this.icdoBenefitCalculationHeader.beneficiary_person_id });
                    //if (ldtbRelationshipValue.Rows.Count > 0)
                    //{
                    //    lstrFamilyRelationshipValue = Convert.ToString(ldtbRelationshipValue.Rows[0]["RELATIONSHIP_VALUE"]);
                    //}

                    //CHECK QDRO here in CONTEXT OF EE to determine PAYEE's starting NON-TAXABLE Amount

                    //R3view -- NonTaxable Beginning Balance   
                    if (aintBOBPersonID > 0)
                    {
                        lintPayeeAccountID = lbusPayeeAccount.ManagePayeeAccount(lintPayeeAccountID, aintBOBPersonID, 0,
                                                                              abusPayeeAccount.icdoPayeeAccount.benefit_application_detail_id,
                                                                              abusPayeeAccount.icdoPayeeAccount.benefit_calculation_detail_id,
                                                                              0, 0, lintBenefitAccountID, abusPayeeAccount.icdoPayeeAccount.benefit_account_type_value, this.icdoPayeeAccount.retirement_type_value,
                                                                              ldteBenefitBeginDate, DateTime.MinValue, busConstant.BenefitCalculation.ACCOUNT_RELATIONSHIP_BENEFICIARY, lstrFamilyRelationshipValue,
                                                                              ldecRemainingMinimumGuaranteeAmount, ldecNonTaxableBeginningBalance, abusPayeeAccount.icdoPayeeAccount.plan_benefit_id,
                                                                              ldteTermCertainEndDate);
                    }

                    else if (aintBOBOrgID > 0)
                        lintPayeeAccountID = lbusPayeeAccount.ManagePayeeAccount(lintPayeeAccountID, 0, aintBOBOrgID,
                                                                                  abusPayeeAccount.icdoPayeeAccount.benefit_application_detail_id,
                                                                                  abusPayeeAccount.icdoPayeeAccount.benefit_calculation_detail_id,
                                                                                  0, 0, lintBenefitAccountID, abusPayeeAccount.icdoPayeeAccount.benefit_account_type_value, this.icdoPayeeAccount.retirement_type_value,
                                                                                  ldteBenefitBeginDate, DateTime.MinValue, busConstant.BenefitCalculation.ACCOUNT_RELATIONSHIP_BENEFICIARY, lstrFamilyRelationshipValue,
                                                                                  ldecRemainingMinimumGuaranteeAmount, ldecNonTaxableBeginningBalance, abusPayeeAccount.icdoPayeeAccount.plan_benefit_id,
                                                                                  ldteTermCertainEndDate);

                    decimal ldecTaxableAmount = 0M;
                    decimal ldecNonTaxableAmount = 0M;
                    decimal ldecMEA = 0M;
                    decimal ldecBOBAmount = 0M;

                    lbusPayeeAccount.LoadNextBenefitPaymentDate();
                    DateTime ldteNextBenefitPaymentDate = lbusPayeeAccount.idtNextBenefitPaymentDate;

                    //R3view -- First Parameter Should be maybe Retirement or Payment Date Review the Function too 

                    if (lstrBenefitOptionValue == busConstant.TEN_YEARS_TERM_CERTAIN ||
                      lstrBenefitOptionValue == busConstant.THREE_YEARS_CERTAIN_AND_LIFE_ANNUITY ||
                      lstrBenefitOptionValue == busConstant.TEN_YEARS_CERTAIN_AND_LIFE_ANNUTIY ||
                      lstrBenefitOptionValue == busConstant.TWO_YEARS_CERTAIN_AND_LIFE_ANNUITY ||
                     lstrBenefitOptionValue == busConstant.FIVE_YEARS_CERTAIN_AND_LIFE_ANNUTIY)
                    {
                        ldecBOBAmount = ldecBenefitAmount * ldecPercentage / 100;
                    }
                    else
                    {
                        ldecBOBAmount = ldecRemainingMinimumGuaranteeAmount;
                    }

                    DataTable ldtblParticipantsMEA = Select("cdoPayeeAccount.GetParticipantsMEA", new object[1] { this.icdoPayeeAccount.payee_account_id });
                    if (ldtblParticipantsMEA.Rows.Count > 0)
                    {
                        ldecMEA = Convert.ToDecimal(ldtblParticipantsMEA.Rows[0][0]) * ldecPercentage / 100;
                    }


                    if (lintPlanId == busConstant.MPIPP_PLAN_ID
                        && (lstrBenefitOptionValue == busConstant.TEN_YEARS_TERM_CERTAIN ||
                        lstrBenefitOptionValue == busConstant.THREE_YEARS_CERTAIN_AND_LIFE_ANNUITY ||
                      lstrBenefitOptionValue == busConstant.TEN_YEARS_CERTAIN_AND_LIFE_ANNUTIY ||
                      lstrBenefitOptionValue == busConstant.TWO_YEARS_CERTAIN_AND_LIFE_ANNUITY ||
                      lstrBenefitOptionValue == busConstant.FIVE_YEARS_CERTAIN_AND_LIFE_ANNUTIY))
                    {

                        busPayeeAccountHelper.CalculateMonthlyPaymentComponents(DateTime.MinValue, ldecBOBAmount,
                           ref ldecNonTaxableAmount, ref ldecTaxableAmount, ldecMEA);

                    }
                    else if (lintPlanId == busConstant.IAP_PLAN_ID)
                    {

                        busPayeeAccountHelper.CalculateMonthlyPaymentComponents(DateTime.MinValue, ldecBOBAmount,
                                                                 ref ldecNonTaxableAmount, ref ldecTaxableAmount, 0);
                    }
                    else
                    {
                        busPayeeAccountHelper.CalculateMonthlyPaymentComponents(DateTime.MinValue, ldecBOBAmount,
                                            ref ldecNonTaxableAmount, ref ldecTaxableAmount, ldecNonTaxableBeginningBalance);

                    }

                    if (lstrBenefitOptionValue == busConstant.TEN_YEARS_TERM_CERTAIN ||
                        lstrBenefitOptionValue == busConstant.THREE_YEARS_CERTAIN_AND_LIFE_ANNUITY ||
                        lstrBenefitOptionValue == busConstant.TEN_YEARS_CERTAIN_AND_LIFE_ANNUTIY ||
                        lstrBenefitOptionValue == busConstant.TWO_YEARS_CERTAIN_AND_LIFE_ANNUITY ||
                        lstrBenefitOptionValue == busConstant.FIVE_YEARS_CERTAIN_AND_LIFE_ANNUTIY)
                    {

                        if (ldecTaxableAmount > 0M)
                        {
                            lbusPayeeAccount.CreatePayeeAccountPaymentItemType("ITEM1", ldecTaxableAmount, "0", 0,
                                                                ldteNextBenefitPaymentDate, DateTime.MinValue, "N", false);
                        }

                        if (ldecNonTaxableAmount > 0M)
                        {
                            lbusPayeeAccount.CreatePayeeAccountPaymentItemType("ITEM2", ldecNonTaxableAmount, "0", 0,
                                                            ldteNextBenefitPaymentDate, DateTime.MinValue, "N", false);
                        }

                    }
                    else
                    {
                        if (lstrBenefitOptionValue != busConstant.LUMP_SUM)
                        {
                            DataTable ldtPlanBenefitXr = Select<cdoPlanBenefitXr>(new string[2] { enmPlanBenefitXr.plan_id.ToString(), enmPlanBenefitXr.benefit_option_value.ToString() },
                                new object[2] { lintPlanId, busConstant.LUMP_SUM }, null, null);

                            if (ldtPlanBenefitXr.Rows.Count > 0)
                            {
                                lbusPayeeAccount.icdoPayeeAccount.plan_benefit_id = Convert.ToInt32(ldtPlanBenefitXr.Rows[0][enmPlanBenefitXr.plan_benefit_id.ToString().ToUpper()]);
                                lbusPayeeAccount.icdoPayeeAccount.Update();
                            }

                        }

                        ///MPI : Need to plug in the logic for LUMP Sum : Need to pick up the minimum gurantee[ will be calculated field]
                        ///Locals : No Benefit as discussed[Doubt this one , needs to be confirmed]
                        ///
                        if (ldecTaxableAmount > 0M)
                        {
                            lbusPayeeAccount.CreatePayeeAccountPaymentItemType("ITEM21", ldecTaxableAmount, "0", 0,
                                                            ldteNextBenefitPaymentDate, DateTime.MinValue, "N", false);
                        }

                        if (ldecNonTaxableAmount > 0M)
                        {
                            lbusPayeeAccount.CreatePayeeAccountPaymentItemType("ITEM22", ldecNonTaxableAmount, "0", 0,
                                                            ldteNextBenefitPaymentDate, DateTime.MinValue, "N", false);
                        }
                    }


                    //Create Payee Account in Review
                    lbusPayeeAccount.CreateReviewPayeeAccountStatus();

                    //Retro Calculation Items to be Created

                    if (lstrBenefitOptionValue == busConstant.TEN_YEARS_TERM_CERTAIN ||
                        lstrBenefitOptionValue == busConstant.THREE_YEARS_CERTAIN_AND_LIFE_ANNUITY ||
                        lstrBenefitOptionValue == busConstant.TEN_YEARS_CERTAIN_AND_LIFE_ANNUTIY ||
                        lstrBenefitOptionValue == busConstant.TWO_YEARS_CERTAIN_AND_LIFE_ANNUITY ||
                        lstrBenefitOptionValue == busConstant.FIVE_YEARS_CERTAIN_AND_LIFE_ANNUTIY)
                    {
                        int lintDiffinMonths = busGlobalFunctions.GetMonthsBetweenTwoDates(lbusPayeeAccount.icdoPayeeAccount.benefit_begin_date, ldteNextBenefitPaymentDate);

                        if (lintDiffinMonths > 0)
                        {
                            lbusPayeeAccount.LoadPayeeAccountPaymentItemType();
                            lbusPayeeAccount.CreateRetroPayments(lbusPayeeAccount, ldteNextBenefitPaymentDate, lbusPayeeAccount.icdoPayeeAccount.benefit_begin_date, lintPayeeAccountID, busConstant.RETRO_PAYMENT_INITIAL);
                        }
                    }



                    if (lbusPayeeAccount.icdoPayeeAccount.payee_account_id > 0)
                    {
                        busWorkflowHelper.InitializeWorkflowIfNotExists(busConstant.POSTRETIREMENT_DEATH_PAYSURVIVOR_BOB_WORKFLOW_NAME, lbusPayeeAccount.icdoPayeeAccount.person_id, 0, lbusPayeeAccount.icdoPayeeAccount.payee_account_id, null);
                        //SetWorkflowRelatedVariablesforPaySurvivor(lbusPayeeAccount.icdoPayeeAccount.payee_account_id);
                    }

                }
            }
        }
        /// <summary>
        /// BOB Of AlternatePayee
        /// </summary>
        public void CreatePayeeAccountForAlternateePayeeBeneficiary(int aintBeneficiaryPersonID, decimal ldecBeneficiaryPercentage, busPayeeAccount abusPayeeAccount)
        {
            busPayeeAccount lbusPayeeAccount = new busPayeeAccount { icdoPayeeAccount = new cdoPayeeAccount() };
            lbusPayeeAccount = abusPayeeAccount;

            lbusPayeeAccount.icdoPayeeAccount.person_id = aintBeneficiaryPersonID;

        }

        public void CreatePayeeAccountForBOBOfAlternatePayee(busPayeeAccount abusPayeeAccount, busPersonAccountBeneficiary abusPersonAccountBeneficiary, int aintSurvivorID, int aintBOBPersonID, int aintBOBOrgID,
         string astrRelationshipValue, int aintPayeeAccountEligibleForContinuance)
        {
            decimal ldecBenefitAmount = 0M;
            decimal ldecTaxableBenefitAmount = 0M;
            decimal ldecNonTaxableBenefitAmount = 0M;

            decimal ldecPercentage = abusPersonAccountBeneficiary.icdoPersonAccountBeneficiary.dist_percent;
            string lstrBenefitOptionValue = string.Empty;
            int lintPlanId = abusPayeeAccount.icdoPayeeAccount.iintPlanId;
            lstrBenefitOptionValue = abusPayeeAccount.icdoPayeeAccount.istrBenefitOptionValue;
            int lintParticipantId = abusPayeeAccount.ibusParticipant.icdoPerson.person_id;

            ibusCalculation.GetTaxableAndNonTaxableAmountFromPaymentItemTypes(abusPayeeAccount, out ldecTaxableBenefitAmount, out ldecNonTaxableBenefitAmount);
            ldecTaxableBenefitAmount = (ldecTaxableBenefitAmount / 100) * ldecPercentage;
            ldecNonTaxableBenefitAmount = (ldecNonTaxableBenefitAmount / 100) * ldecPercentage;

            ldecBenefitAmount = ldecTaxableBenefitAmount + ldecNonTaxableBenefitAmount;


            this.LoadPaymentHistoryHeaderDetails();

            //R3view -- IF Term Year Certain Option FIND the end Date 
            LoadPlanBenefitsForPlan(lintPlanId);
            int iintTermCertainMonths = busConstant.ZERO_INT;
            iintTermCertainMonths = busPayeeAccountHelper.IsTermCertainBenefitOption(abusPayeeAccount.icdoPayeeAccount.plan_benefit_id, this.iclbcdoPlanBenefit);
            decimal ldecRemainingMinGuarantee = GetRemainingMinimumGuaranteeTillDate(this.ibusPayee.icdoPerson.date_of_death);
            decimal ldecRemaingStartingNonTaxableAmount = GetRemainingNonTaxableBeginningBalanaceTillDate(this.ibusPayee.icdoPerson.date_of_death);
            if (ldecRemainingMinGuarantee == decimal.Zero)
            {
                ldecRemainingMinGuarantee = ldecRemaingStartingNonTaxableAmount;
            }

            if ((lstrBenefitOptionValue == busConstant.TEN_YEARS_CERTAIN_AND_LIFE_ANNUTIY || aintPayeeAccountEligibleForContinuance > 0) && ldecBenefitAmount <= decimal.Zero)
            {
                utlError lobjError = new utlError();
                lobjError = AddError(6057, "");//R3view 
                this.iarrErrors.Add(lobjError);
            }
            else if (ldecRemainingMinGuarantee == 0 && !(lstrBenefitOptionValue == busConstant.TEN_YEARS_CERTAIN_AND_LIFE_ANNUTIY || aintPayeeAccountEligibleForContinuance > 0))
            {
                utlError lobjError = new utlError();
                lobjError = AddError(0, "Minimum Guarantee Amount is zero");//R3view 
                this.iarrErrors.Add(lobjError);
            }
            else
            {

                int lintBenefitAccountID = 0;
                int lintPayeeAccountID = 0;
                string lstrFundsType = String.Empty;

                //Benefit Account Related
                decimal ldecAccountOwnerStartingTaxableAmount = 0.0M;
                decimal ldecAccountOwnerStartingNonTaxableAmount = 0.0M;
                decimal ldecAccountOwnerStartingGrossAmount = 0.0M;

                busPayeeAccount lbusPayeeAccount = new busPayeeAccount { icdoPayeeAccount = new cdoPayeeAccount() };
                busPayeeBenefitAccount lbusPayeeBenefitAccount = new busPayeeBenefitAccount { icdoPayeeBenefitAccount = new cdoPayeeBenefitAccount() };


                //Need to change the logic here should be 
                DateTime ldteBenefitBeginDate = new DateTime();

                if (this.ibusPayee.icdoPerson.date_of_death.Day == 1)
                {
                    ldteBenefitBeginDate = this.ibusPayee.icdoPerson.date_of_death.AddMonths(1);
                }
                else
                {
                    ldteBenefitBeginDate = this.ibusPayee.icdoPerson.date_of_death.GetLastDayofMonth().AddDays(1);
                }


                DataTable ldtblPayeeBenefitAccount = Select("cdoPayeeBenefitAccount.GetPayeeBenefitAccount", new object[1] { this.icdoPayeeAccount.payee_benefit_account_id });
                if (ldtblPayeeBenefitAccount.Rows.Count > 0)
                {
                    if (Convert.ToString(ldtblPayeeBenefitAccount.Rows[0][enmPayeeBenefitAccount.starting_taxable_amount.ToString().ToUpper()]).IsNotNullOrEmpty())
                        ldecAccountOwnerStartingTaxableAmount = Convert.ToDecimal(ldtblPayeeBenefitAccount.Rows[0][enmPayeeBenefitAccount.starting_taxable_amount.ToString().ToUpper()]);

                    if (Convert.ToString(ldtblPayeeBenefitAccount.Rows[0][enmPayeeBenefitAccount.starting_nontaxable_amount.ToString().ToUpper()]).IsNotNullOrEmpty())
                        ldecAccountOwnerStartingNonTaxableAmount = Convert.ToDecimal(ldtblPayeeBenefitAccount.Rows[0][enmPayeeBenefitAccount.starting_nontaxable_amount.ToString().ToUpper()]);

                    ldecAccountOwnerStartingGrossAmount = ldecAccountOwnerStartingTaxableAmount + ldecAccountOwnerStartingNonTaxableAmount;
                    lstrFundsType = Convert.ToString(ldtblPayeeBenefitAccount.Rows[0][enmPayeeBenefitAccount.funds_type_value.ToString().ToUpper()]);
                }

                //Benefit Account
                lintBenefitAccountID = busPayeeAccountHelper.IsBenefitAccountExists(abusPersonAccountBeneficiary.icdoPersonAccountBeneficiary.person_account_id,
                                                                                     busConstant.BENEFIT_TYPE_QDRO, lstrFundsType);  //R3view  the Query and code for this one.

                lintBenefitAccountID = lbusPayeeBenefitAccount.ManagePayeeBenefitAccount(lintBenefitAccountID, lintParticipantId,
                                                                  abusPersonAccountBeneficiary.icdoPersonAccountBeneficiary.person_account_id,
                                                                  ldecAccountOwnerStartingTaxableAmount, ldecAccountOwnerStartingNonTaxableAmount, ldecAccountOwnerStartingGrossAmount, lstrFundsType);

                //Payee Account //R3view this code
                if (aintBOBPersonID > 0)
                    lintPayeeAccountID = busPayeeAccountHelper.IsPayeeAccountExists(aintBOBPersonID, lintBenefitAccountID, busConstant.BenefitCalculation.ACCOUNT_RELATIONSHIP_BENEFICIARY, busConstant.BENEFIT_TYPE_QDRO, false, lintPlanId);
                else if (aintBOBOrgID > 0)
                    lintPayeeAccountID = busPayeeAccountHelper.IsPayeeAccountExists(aintBOBOrgID, lintBenefitAccountID, busConstant.BenefitCalculation.ACCOUNT_RELATIONSHIP_BENEFICIARY, busConstant.BENEFIT_TYPE_QDRO, false, lintPlanId);
                busCalculation lbusCalculation = new busCalculation();


                decimal ldecNonTaxableBeginningBalance = 0.0M;
                decimal ldecRemainingMinimumGuaranteeAmount = (ldecRemainingMinGuarantee / 100) * ldecPercentage;

                //Need to do in Payment Adjustment
                if (lintPlanId == busConstant.MPIPP_PLAN_ID)
                {
                    ldecNonTaxableBeginningBalance = (ldecRemaingStartingNonTaxableAmount / 100) * ldecPercentage;
                }


                DateTime ldteTermCertainEndDate = new DateTime();
                string lstrFamilyRelationshipValue = string.Empty;
                lstrFamilyRelationshipValue = astrRelationshipValue;

                if (iintTermCertainMonths > 0)
                {
                    ldteTermCertainEndDate = this.icdoPayeeAccount.term_certain_end_date;
                }

                //CHECK QDRO here in CONTEXT OF EE to determine PAYEE's starting NON-TAXABLE Amount

                //R3view -- NonTaxable Beginning Balance   
                if (aintBOBPersonID > 0)
                {
                    lintPayeeAccountID = lbusPayeeAccount.ManagePayeeAccount(lintPayeeAccountID, aintBOBPersonID, 0, 0, 0,
                                                                          abusPayeeAccount.icdoPayeeAccount.dro_application_detail_id,
                                                                          abusPayeeAccount.icdoPayeeAccount.dro_calculation_detail_id,
                                                                          lintBenefitAccountID, busConstant.BENEFIT_TYPE_QDRO, this.icdoPayeeAccount.retirement_type_value,
                                                                          ldteBenefitBeginDate, DateTime.MinValue, busConstant.BenefitCalculation.ACCOUNT_RELATIONSHIP_BENEFICIARY, lstrFamilyRelationshipValue,
                                                                          ldecRemainingMinimumGuaranteeAmount, ldecNonTaxableBeginningBalance, abusPayeeAccount.icdoPayeeAccount.plan_benefit_id,
                                                                          ldteTermCertainEndDate);
                }

                else if (aintBOBOrgID > 0)
                    lintPayeeAccountID = lbusPayeeAccount.ManagePayeeAccount(lintPayeeAccountID, 0, aintBOBOrgID, 0, 0,
                                                                              abusPayeeAccount.icdoPayeeAccount.dro_application_detail_id,
                                                                              abusPayeeAccount.icdoPayeeAccount.dro_calculation_detail_id, lintBenefitAccountID, busConstant.BENEFIT_TYPE_QDRO, this.icdoPayeeAccount.retirement_type_value,
                                                                              ldteBenefitBeginDate, DateTime.MinValue, busConstant.BenefitCalculation.ACCOUNT_RELATIONSHIP_BENEFICIARY, lstrFamilyRelationshipValue,
                                                                              ldecRemainingMinimumGuaranteeAmount, ldecNonTaxableBeginningBalance, abusPayeeAccount.icdoPayeeAccount.plan_benefit_id,
                                                                              ldteTermCertainEndDate);

                lbusPayeeAccount.LoadNextBenefitPaymentDate();
                DateTime ldteNextBenefitPaymentDate = lbusPayeeAccount.idtNextBenefitPaymentDate;

                if (lstrBenefitOptionValue == busConstant.TEN_YEARS_CERTAIN_AND_LIFE_ANNUTIY || aintPayeeAccountEligibleForContinuance > 0)
                {



                    if (ldecTaxableBenefitAmount > 0M)
                    {

                        lbusPayeeAccount.CreatePayeeAccountPaymentItemType("ITEM1", ldecTaxableBenefitAmount, "0", 0,
                                                                            ldteNextBenefitPaymentDate, DateTime.MinValue, "N", false);
                    }
                    if (ldecNonTaxableBenefitAmount > 0M)
                    {

                        lbusPayeeAccount.CreatePayeeAccountPaymentItemType("ITEM2", ldecNonTaxableBenefitAmount, "0", 0,
                                                            ldteNextBenefitPaymentDate, DateTime.MinValue, "N", false);

                    }
                    int lintDiffinMonths = busGlobalFunctions.GetMonthsBetweenTwoDates(lbusPayeeAccount.icdoPayeeAccount.benefit_begin_date, ldteNextBenefitPaymentDate);

                    if (lintDiffinMonths > 0)
                    {
                        lbusPayeeAccount.LoadPayeeAccountPaymentItemType();
                        lbusPayeeAccount.CreateRetroPayments(lbusPayeeAccount, ldteNextBenefitPaymentDate, lbusPayeeAccount.icdoPayeeAccount.benefit_begin_date, lintPayeeAccountID, busConstant.RETRO_PAYMENT_INITIAL);
                    }

                }
                else
                {
                    busPayeeAccountHelper.CalculateMonthlyPaymentComponents(DateTime.MinValue, ldecRemainingMinimumGuaranteeAmount,
                                        ref ldecNonTaxableBenefitAmount, ref ldecTaxableBenefitAmount, ldecNonTaxableBeginningBalance);

                    if (ldecTaxableBenefitAmount > 0M)
                    {
                        lbusPayeeAccount.CreatePayeeAccountPaymentItemType("ITEM21", ldecTaxableBenefitAmount, "0", 0,
                                                        ldteNextBenefitPaymentDate, DateTime.MinValue, "N", false);
                    }

                    if (ldecNonTaxableBenefitAmount > 0M)
                    {
                        lbusPayeeAccount.CreatePayeeAccountPaymentItemType("ITEM22", ldecNonTaxableBenefitAmount, "0", 0,
                                                        ldteNextBenefitPaymentDate, DateTime.MinValue, "N", false);
                    }
                }

                //Create Payee Account in Review
                lbusPayeeAccount.CreateReviewPayeeAccountStatus();

                if (lbusPayeeAccount.icdoPayeeAccount.payee_account_id > 0)
                {
                    busWorkflowHelper.InitializeWorkflowIfNotExists(busConstant.POSTRETIREMENT_DEATH_PAYSURVIVOR_BOB_WORKFLOW_NAME, lbusPayeeAccount.icdoPayeeAccount.person_id, 0, lbusPayeeAccount.icdoPayeeAccount.payee_account_id, null);
                    //SetWorkflowRelatedVariablesforPaySurvivor(lbusPayeeAccount.icdoPayeeAccount.payee_account_id);
                }

            }

        }

        public virtual void LoadPlanBenefitsForPlan(int aintPlanId)
        {
            DataTable ldtbList = Select<cdoPlanBenefitXr>(
                new string[1] { enmPlanBenefitXr.plan_id.ToString() },
                new object[1] { aintPlanId }, null, null);
            iclbcdoPlanBenefit = GetCollection<busPlanBenefitXr>(ldtbList, "icdoPlanBenefitXr");
        }

        public Collection<busPersonAccountBeneficiary> GetBeneficiaryDetails(int aintPersonID, int ainPlanID)
        {
            Collection<busPersonAccountBeneficiary> lclbbusPersonAccountBeneficiary = new Collection<busPersonAccountBeneficiary>();
            DataTable ldtPersonAccountBen = new DataTable();

            if (this.icdoPayeeAccount.benefit_account_type_value == busConstant.BENEFIT_TYPE_QDRO)
            {
                ldtPersonAccountBen = busBase.Select("cdoPersonAccountBeneficiary.GetPersonAccountForAlternatePayee", new object[2] { aintPersonID, ainPlanID });
            }
            else
            {
                ldtPersonAccountBen = busBase.Select("cdoPersonAccountBeneficiary.GetPersonAccountForSurvivor", new object[2] { aintPersonID, ainPlanID });
            }

            if (ldtPersonAccountBen.Rows.Count > 0)
                lclbbusPersonAccountBeneficiary = GetCollection<busPersonAccountBeneficiary>(ldtPersonAccountBen, "icdoPersonAccountBeneficiary");

            return lclbbusPersonAccountBeneficiary;

        }

        #endregion

        #region Load Last Payment Date
        public void LoadLastPaymentDate()
        {
            DataTable ldtbList = busBase.Select("cdoPaymentHistoryDistributionStatusHistory.GetLastPaymentDate", new object[2] { this.icdoPayeeAccount.payee_account_id, this.icdoPayeeAccount.person_id });
            if (ldtbList.IsNotNull() && ldtbList.Rows.Count > 0)
            {
                DataRow ldtrRow = ldtbList.Rows[0];

                if (ldtrRow["PAYMENT_DATE"] != DBNull.Value)
                    this.idtPayeeLastBenefitPaymentDate = Convert.ToDateTime(ldtrRow["PAYMENT_DATE"]);
                if (ldtrRow["GROSS_BENEFIT_AMOUNT"] != DBNull.Value)
                    this.idecGrossBenefitAmount = Convert.ToDecimal(ldtrRow["GROSS_BENEFIT_AMOUNT"]);
                if (ldtrRow["MONTHLY_BENEFIT_AMOUNT"] != DBNull.Value)
                    this.idecPreviousMonthlyGrossAmt = Convert.ToDecimal(ldtrRow["MONTHLY_BENEFIT_AMOUNT"]);
            }
        }
        //public void LoadOrganization()
        //{

        //    DataTable ldtbList = busBase.Select("cdoOrganization.Lookup", new object[0] {  });
        //    iclbOrganization = GetCollection<busOrganization>(ldtbList, "icdoOrganization");
        //}
        #endregion

        public void GetCalculatedTaxAmount()
        {
            foreach (busPayeeAccountTaxWithholding lbusPayeeAccountTaxWithholding in this.iclbPayeeAccountTaxWithholding)
            {
                DataTable ldtbGetAmount = busBase.Select("cdoPayeeAccountTaxWithholding.GetAmountOfCalculatedTax", new object[1] { lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.payee_account_tax_withholding_id });
                if (ldtbGetAmount.IsNotNull() && ldtbGetAmount.Rows.Count > 0)
                {
                    DataRow ldtrRow = ldtbGetAmount.Rows[0];

                    if (ldtrRow["AMOUNT"] != DBNull.Value)
                        lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.idecCalculatedTaxAmount = Convert.ToDecimal(ldtrRow["AMOUNT"]);

                }
            }
        }

        public void LoadPaymentHistoryHeader(int aintPayeeAccountID)
        {
            if (iclbPaymentHistoryHeader == null)
                iclbPaymentHistoryHeader = new Collection<busPaymentHistoryHeader>();
            DataTable ldtPaymentHistory = Select<cdoPaymentHistoryHeader>(new string[1] { "payee_account_id" },
                                                                    new object[1] { aintPayeeAccountID }, null, null);
            iclbPaymentHistoryHeader = GetCollection<busPaymentHistoryHeader>(ldtPaymentHistory, "icdoPaymentHistoryHeader");
        }

        /// Method to load Payment History Header Details - 
        public void LoadPaymentHistoryHeaderDetails()
        {
            iclbPaymentHistoryHeaderDetails = new Collection<busPaymentHistoryHeader>();
            idecRemainingMinimumGuaranteeAmount = icdoPayeeAccount.minimum_guarantee_amount;


            idecRemainingNonTaxableBeginningBalance = icdoPayeeAccount.nontaxable_beginning_balance;

            if (iclbPaymentHistoryHeader == null)
                LoadPaymentHistoryHeader(this.icdoPayeeAccount.payee_account_id);
            if (iclbPaymentHistoryHeader.Count > 0)
            {
                DateTime ldtLastPaymentDate = busPayeeAccountHelper.GetLastBenefitPaymentDate(this.icdoPayeeAccount.iintPlanId);
                ldtLastPaymentDate = ldtLastPaymentDate.AddMonths(1).AddDays(-1);
                DataTable ldtPaymentHistory = Select("cdoPayeeAccount.LoadPaymentDetails",
                                new object[2] { icdoPayeeAccount.payee_account_id, ldtLastPaymentDate });
                iclbPaymentHistoryHeaderDetails = GetCollection<busPaymentHistoryHeader>(ldtPaymentHistory, "icdoPaymentHistoryHeader");
                if (iclbPaymentHistoryHeaderDetails.Count > 0)
                {
                    decimal idecPaidNonTaxableAmountRemain = 0M;
                    idecPaidNonTaxableAmountRemain = (from obj in ldtPaymentHistory.AsEnumerable()
                                                      select obj.Field<decimal>("NONTAXABLE_AMOUNT_FOR_REMAINING")
                                                               ).Sum();
                    idecPaidGrossAmount = iclbPaymentHistoryHeaderDetails.Select(o => o.icdoPaymentHistoryHeader.gross_amount).Sum();
                    idecPaidNonTaxableAmount = iclbPaymentHistoryHeaderDetails.Select(o => o.icdoPaymentHistoryHeader.NonTaxable_Amount).Sum();
                    idecPaidTaxableAmount = iclbPaymentHistoryHeaderDetails.Select(o => o.icdoPaymentHistoryHeader.taxable_amount).Sum();
                    idecPaidTaxableRolloverAmount = iclbPaymentHistoryHeaderDetails.Sum(o => o.icdoPaymentHistoryHeader.taxable_rollover_amount);
                    idecPaidNonTaxableRolloverAmount = iclbPaymentHistoryHeaderDetails.Sum(o => o.icdoPaymentHistoryHeader.nontaxable_rollover_amount);

                    // For Remaining MGA and Non-taxable Balance
                    if (icdoPayeeAccount.nontaxable_beginning_balance > 0)
                        idecRemainingNonTaxableBeginningBalance = icdoPayeeAccount.nontaxable_beginning_balance - idecPaidNonTaxableAmountRemain;
                    else if (icdoPayeeAccount.remaining_non_taxable_from_conversion > 0)
                        idecRemainingNonTaxableBeginningBalance = icdoPayeeAccount.remaining_non_taxable_from_conversion - idecPaidNonTaxableAmountRemain;




                    if (icdoPayeeAccount.minimum_guarantee_amount > 0)
                        idecRemainingMinimumGuaranteeAmount = icdoPayeeAccount.minimum_guarantee_amount - idecPaidGrossAmount;
                    // Setting Zero if amount is negative
                    if (idecRemainingNonTaxableBeginningBalance < 0)
                        idecRemainingNonTaxableBeginningBalance = 0.0M;
                    if (idecRemainingMinimumGuaranteeAmount < 0)
                        idecRemainingMinimumGuaranteeAmount = 0.0M;
                }
            }
        }

        //Payment Adjustments
        public decimal GetRemainingNonTaxableBeginningBalanaceTillDate(DateTime adtToDate)
        {
            decimal ldecRemainingNonTaxableBeginningBalance = 0M;
            decimal ldecPaidNonTaxableAmount = 0M;
            Collection<busPaymentHistoryHeader> lclbPaymentHistoryHeaderDetails = new Collection<busPaymentHistoryHeader>();

            ldecRemainingNonTaxableBeginningBalance = icdoPayeeAccount.nontaxable_beginning_balance;

            if (iclbPaymentHistoryHeader == null)
                LoadPaymentHistoryHeader(this.icdoPayeeAccount.payee_account_id);
            if (iclbPaymentHistoryHeader.Count > 0)
            {
                DataTable ldtPaymentHistory = Select("cdoPayeeAccount.LoadPaymentDetails",
                                new object[2] { icdoPayeeAccount.payee_account_id, adtToDate });

                iclbPaymentHistoryHeaderDetails = GetCollection<busPaymentHistoryHeader>(ldtPaymentHistory, "icdoPaymentHistoryHeader");
                if (iclbPaymentHistoryHeaderDetails.Count > 0)
                {
                    ldecPaidNonTaxableAmount = iclbPaymentHistoryHeaderDetails.Select(o => o.icdoPaymentHistoryHeader.NonTaxable_Amount).Sum();

                    // For Remaining Non-taxable Beginning Balance Till Date
                    decimal idecPaidNonTaxableAmountRemain = 0M;
                    idecPaidNonTaxableAmountRemain = (from obj in ldtPaymentHistory.AsEnumerable()
                                                      select obj.Field<decimal>("NONTAXABLE_AMOUNT_FOR_REMAINING")
                                                               ).Sum();
                    if (icdoPayeeAccount.nontaxable_beginning_balance > 0)
                        ldecRemainingNonTaxableBeginningBalance = icdoPayeeAccount.nontaxable_beginning_balance - idecPaidNonTaxableAmountRemain;
                    else if (icdoPayeeAccount.remaining_non_taxable_from_conversion > 0)
                        ldecRemainingNonTaxableBeginningBalance = icdoPayeeAccount.remaining_non_taxable_from_conversion - idecPaidNonTaxableAmountRemain;
                }
            }


            if (ldecRemainingNonTaxableBeginningBalance > 0)
                return ldecRemainingNonTaxableBeginningBalance;
            else
                return 0;

        }

        //Payment Adjustments
        public decimal GetRemainingMinimumGuaranteeTillDate(DateTime adtToDate)
        {
            decimal ldecRemainingMinimumGuarantee = 0M;
            decimal ldecPaidGrossAmount = 0M;
            Collection<busPaymentHistoryHeader> lclbPaymentHistoryHeaderDetails = new Collection<busPaymentHistoryHeader>();

            ldecRemainingMinimumGuarantee = icdoPayeeAccount.minimum_guarantee_amount;

            if (iclbPaymentHistoryHeader == null)
                LoadPaymentHistoryHeader(this.icdoPayeeAccount.payee_account_id);
            if (iclbPaymentHistoryHeader.Count > 0)
            {
                DataTable ldtPaymentHistory = Select("cdoPayeeAccount.LoadPaymentDetails",
                                new object[2] { icdoPayeeAccount.payee_account_id, adtToDate });

                iclbPaymentHistoryHeaderDetails = GetCollection<busPaymentHistoryHeader>(ldtPaymentHistory, "icdoPaymentHistoryHeader");
                if (iclbPaymentHistoryHeaderDetails.Count > 0)
                {
                    ldecPaidGrossAmount = iclbPaymentHistoryHeaderDetails.Select(o => o.icdoPaymentHistoryHeader.gross_amount).Sum();

                    // For Remaining Non-taxable Beginning Balance Till Date
                    if (icdoPayeeAccount.minimum_guarantee_amount > 0)
                        ldecRemainingMinimumGuarantee = icdoPayeeAccount.minimum_guarantee_amount - ldecPaidGrossAmount;
                }
            }

            if (ldecRemainingMinimumGuarantee > 0)
                return ldecRemainingMinimumGuarantee;
            else
                return 0;
        }

        //Payment Adjustments
        public bool CheckRemainingNonTaxableBeginningBalOnGivenDate(ref decimal adecNonTaxableBeginningBal, ref decimal adecMEA)
        {

            decimal ldecRemainingNonTaxableBeginningBalOnGivenDate = 0M;

            ldecRemainingNonTaxableBeginningBalOnGivenDate = adecNonTaxableBeginningBal - adecMEA;

            if (ldecRemainingNonTaxableBeginningBalOnGivenDate > 0)
            {
                if (ldecRemainingNonTaxableBeginningBalOnGivenDate < adecMEA)
                {
                    adecMEA = ldecRemainingNonTaxableBeginningBalOnGivenDate;
                }

                adecNonTaxableBeginningBal = ldecRemainingNonTaxableBeginningBalOnGivenDate;

                return true;
            }
            else
            {
                return false;
            }
        }

        public void RetirementAffidavitCoverLetter()
        {
            busBenefitCalculationDetail lbusBenefitCalculationDetail = new busBenefitCalculationDetail { icdoBenefitCalculationDetail = new cdoBenefitCalculationDetail() };
            lbusBenefitCalculationDetail.FindBenefitCalculationDetail(this.icdoPayeeAccount.benefit_calculation_detail_id);


            if (this.icdoPayeeAccount.iintPlanId == busConstant.IAP_PLAN_ID)
            {
                this.iintRetirementYear = this.icdoPayeeAccount.benefit_begin_date.Year;
                this.iintLastYearFromRetrYear = this.icdoPayeeAccount.benefit_begin_date.AddYears(-1).Year;

                if (this.icdoPayeeAccount.adjustment_payment_eligible_flag.IsNotNullOrEmpty())
                {
                    istrEligibleForAdjustmentPayment = this.icdoPayeeAccount.adjustment_payment_eligible_flag;
                }

                if (lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.iap_as_of_date != DateTime.MinValue)
                {
                    DateTime ldtIAPasOfDate = lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.iap_as_of_date;
                    iinIAPasOfDateYear = ldtIAPasOfDate.Year;
                }
                istrQuarter = string.Empty;

                //determining the eligible quarter
                if (this.icdoPayeeAccount.benefit_begin_date.Month >= 4 && this.icdoPayeeAccount.benefit_begin_date.Month <= 6)
                {
                    istrQuarter = "First";
                }
                else if (this.icdoPayeeAccount.benefit_begin_date.Month >= 7 && this.icdoPayeeAccount.benefit_begin_date.Month <= 9)
                {
                    istrQuarter = "Second";
                }
                else if (this.icdoPayeeAccount.benefit_begin_date.Month >= 10 && this.icdoPayeeAccount.benefit_begin_date.Month <= 12)
                {
                    istrQuarter = "Third";
                }

                busPlanBenefitXr lbusPlanBenefitXr = new busPlanBenefitXr { icdoPlanBenefitXr = new cdoPlanBenefitXr() };
                if (lbusPlanBenefitXr.FindPlanBenefitXr(this.icdoPayeeAccount.plan_benefit_id))
                {
                    if (lbusPlanBenefitXr.icdoPlanBenefitXr.benefit_option_value == busConstant.LUMP_SUM)
                    {
                        istrLumpSumOnFile = "Y";
                    }
                }
            }
        }

        public void RolloverVerification()
        {
            this.iclbPayeeAccountRolloverDetail = new Collection<busPayeeAccountRolloverDetail>();
            DataTable ldtbRolloverDetails = busBase.Select("cdoPayeeAccountRolloverDetail.GetRolloverVerificationDetails", new object[1] { this.icdoPayeeAccount.payee_account_id });
            if (ldtbRolloverDetails.Rows.Count > 0)
            {
                foreach (DataRow ldtrPayeeAccountRolloverDetail in ldtbRolloverDetails.Rows)
                {
                    busPayeeAccountRolloverDetail lobjPayeeAccountRolloverDetail = new busPayeeAccountRolloverDetail();
                    lobjPayeeAccountRolloverDetail.icdoPayeeAccountRolloverDetail = new cdoPayeeAccountRolloverDetail();
                    lobjPayeeAccountRolloverDetail.icdoPayeeAccountRolloverDetail.LoadData(ldtrPayeeAccountRolloverDetail);
                    lobjPayeeAccountRolloverDetail.idecRolloverAmountRequired = Convert.ToDecimal(ldtrPayeeAccountRolloverDetail[enmPayeeAccountPaymentItemType.amount.ToString().ToUpper()]);
                    lobjPayeeAccountRolloverDetail.istrPayableTo = Convert.ToString(ldtrPayeeAccountRolloverDetail[enmOrganization.org_name.ToString().ToUpper()]);
                    if (lobjPayeeAccountRolloverDetail.istrPayableTo.IsNotNull())
                    {
                        isRolloverOrgExists = busConstant.FLAG_YES;
                        istrRolloverOrgName = lobjPayeeAccountRolloverDetail.istrPayableTo;
                    }
                    this.iclbPayeeAccountRolloverDetail.Add(lobjPayeeAccountRolloverDetail);
                }
            }
        }

        public void GetPayemntHistoryDistributionDetails()
        {
            DataTable ldtbPaymentHistory = busBase.Select("cdoPaymentHistoryDistribution.GetPaymentHistoryDistributionDetails", new object[1] { this.icdoPayeeAccount.payee_account_id });
            if (ldtbPaymentHistory.Rows.Count > 0)
            {
                foreach (DataRow ldrPaymentHistory in ldtbPaymentHistory.Rows)
                {
                    istrRecepientName = (ldrPaymentHistory[enmPaymentHistoryDistribution.recipient_name.ToString().ToUpper()] != DBNull.Value ? Convert.ToString(ldrPaymentHistory[enmPaymentHistoryDistribution.recipient_name.ToString().ToUpper()]) : String.Empty).ToUpper();
                    istrRecepientNameInProperCase = (ldrPaymentHistory[enmPaymentHistoryDistribution.recipient_name.ToString().ToUpper()] != DBNull.Value ? Convert.ToString(ldrPaymentHistory[enmPaymentHistoryDistribution.recipient_name.ToString().ToUpper()]) : String.Empty).ToProperCase();
                    //this.istrTransferOrgContactName = (ldrPaymentHistory[enmPaymentHistoryDistribution.addr_line_1.ToString().ToUpper()] != DBNull.Value ? Convert.ToString(ldrPaymentHistory[enmPaymentHistoryDistribution.addr_line_1.ToString().ToUpper()]) : String.Empty);// Convert.ToString(ldrPaymentHistory[enmPaymentHistoryDistribution.recipient_name.ToString().ToUpper()]);
                    istrAddrLine1 = (ldrPaymentHistory[enmPaymentHistoryDistribution.addr_line_1.ToString().ToUpper()] != DBNull.Value ? Convert.ToString(ldrPaymentHistory[enmPaymentHistoryDistribution.addr_line_1.ToString().ToUpper()]) : String.Empty).ToUpper();//Convert.ToString(ldrPaymentHistory[enmPaymentHistoryDistribution.addr_line_1.ToString().ToUpper()]);
                    istrAddrLine2 = (ldrPaymentHistory[enmPaymentHistoryDistribution.addr_line_2.ToString().ToUpper()] != DBNull.Value ? Convert.ToString(ldrPaymentHistory[enmPaymentHistoryDistribution.addr_line_2.ToString().ToUpper()]) : String.Empty).ToUpper(); //Convert.ToString(ldrPaymentHistory[enmPaymentHistoryDistribution.addr_line_2.ToString().ToUpper()]);
                    istrAddrLine3 = (ldrPaymentHistory[enmPaymentHistoryDistribution.addr_line_3.ToString().ToUpper()] != DBNull.Value ? Convert.ToString(ldrPaymentHistory[enmPaymentHistoryDistribution.addr_line_3.ToString().ToUpper()]) : String.Empty).ToUpper(); //Convert.ToString(ldrPaymentHistory[enmPaymentHistoryDistribution.addr_line_2.ToString().ToUpper()]);
                    istrCity = (ldrPaymentHistory[enmPaymentHistoryDistribution.addr_city.ToString().ToUpper()] != DBNull.Value ? Convert.ToString(ldrPaymentHistory[enmPaymentHistoryDistribution.addr_city.ToString().ToUpper()]) : String.Empty).ToUpper(); //Convert.ToString(ldrPaymentHistory[enmPaymentHistoryDistribution.addr_city.ToString().ToUpper()]);
                    istrStateDescription = (iobjPassInfo.isrvDBCache.GetCodeDescriptionString(150, Convert.ToString(ldrPaymentHistory[enmPaymentHistoryDistribution.addr_state_value.ToString().ToUpper()]))).ToUpper();
                    istrZipCode = ldrPaymentHistory[enmPaymentHistoryDistribution.addr_zip_code.ToString().ToUpper()] != DBNull.Value ? Convert.ToString(ldrPaymentHistory[enmPaymentHistoryDistribution.addr_zip_code.ToString().ToUpper()]) : String.Empty;// Convert.ToString(ldrPaymentHistory[enmPaymentHistoryDistribution.addr_zip_code.ToString().ToUpper()]);
                    istrZipCode4 = ldrPaymentHistory[enmPaymentHistoryDistribution.addr_zip_4_code.ToString().ToUpper()] != DBNull.Value ? Convert.ToString(ldrPaymentHistory[enmPaymentHistoryDistribution.addr_zip_4_code.ToString().ToUpper()]) : String.Empty; //Convert.ToString(ldrPaymentHistory[enmPaymentHistoryDistribution.addr_zip_4_code.ToString().ToUpper()]);
                    iintCheckNumber = ldrPaymentHistory[enmPaymentHistoryDistribution.check_number.ToString().ToUpper()] != DBNull.Value ? Convert.ToInt32(ldrPaymentHistory[enmPaymentHistoryDistribution.check_number.ToString().ToUpper()]) : 0; //Convert.ToInt32(ldrPaymentHistory[enmPaymentHistoryDistribution.check_number.ToString().ToUpper()]);
                    idtCheckDate = ldrPaymentHistory[enmPaymentHistoryDistribution.check_ach_effective_date.ToString().ToUpper()] != DBNull.Value ? Convert.ToDateTime(ldrPaymentHistory[enmPaymentHistoryDistribution.check_ach_effective_date.ToString().ToUpper()]) : DateTime.MinValue;// Convert.ToDateTime(ldrPaymentHistory[enmPaymentHistoryDistribution.check_ach_effective_date.ToString().ToUpper()]);
                    istrCheckDate = busGlobalFunctions.ConvertDateIntoDifFormat(idtCheckDate);
                    idecAmount = ldrPaymentHistory[enmPaymentHistoryDistribution.net_amount.ToString().ToUpper()] != DBNull.Value ? Convert.ToDecimal(ldrPaymentHistory[enmPaymentHistoryDistribution.net_amount.ToString().ToUpper()]) : 0M; //Convert.ToDecimal(ldrPaymentHistory[enmPaymentHistoryDistribution.net_amount.ToString().ToUpper()]);
                    if (ldrPaymentHistory[enmPaymentHistoryDistribution.addr_country_value.ToString().ToUpper()] != DBNull.Value && Convert.ToString(ldrPaymentHistory[enmPaymentHistoryDistribution.addr_country_value.ToString().ToUpper()]) != string.Empty)
                    {
                        lintCountryValue = Convert.ToInt32(Convert.ToString(ldrPaymentHistory[enmPaymentHistoryDistribution.addr_country_value.ToString().ToUpper()]));
                        if (lintCountryValue != 0)
                        {
                            istrCountryDescription = (iobjPassInfo.isrvDBCache.GetCodeDescriptionString(151, Convert.ToString(ldrPaymentHistory[enmPaymentHistoryDistribution.addr_country_value.ToString().ToUpper()]))).ToUpper();
                        }
                        if (lintCountryValue == busConstant.USA)
                        {
                            istrZipCode = (istrCity + " " + Convert.ToString(ldrPaymentHistory[enmPaymentHistoryDistribution.addr_state_value.ToString().ToUpper()]) + "  " +
                                                   istrZipCode) ?? String.Empty;

                            if ((istrZipCode4 != null) &&
                                   (istrZipCode4.Trim() != String.Empty))
                            {
                                istrZipCode += "-" + istrZipCode4 ?? String.Empty;
                            }
                            istrZipCode = istrZipCode.ToUpper();
                        }
                        else
                        {

                            istrZipCode = ldrPaymentHistory[enmPaymentHistoryDistribution.foreign_postal_code.ToString().ToUpper()] != DBNull.Value ? Convert.ToString(ldrPaymentHistory[enmPaymentHistoryDistribution.foreign_postal_code.ToString().ToUpper()]) : String.Empty + " " + istrCity;
                            istrZipCode = istrZipCode.ToUpper();
                        }
                    }
                    //if (ldrPaymentHistory[enmPaymentHistoryDistribution.addr_country_value.ToString().ToUpper()] != DBNull.Value && Convert.ToString(ldrPaymentHistory[enmPaymentHistoryDistribution.addr_country_value.ToString().ToUpper()])!=string.Empty)
                    //{
                    //    lintCountryValue = Convert.ToInt32(Convert.ToString(ldrPaymentHistory[enmPaymentHistoryDistribution.addr_country_value.ToString().ToUpper()]));
                    //    istrCountryDescription = iobjPassInfo.isrvDBCache.GetCodeDescriptionString(151, lintCountryValue.ToString());
                    //    if (lintCountryValue == busConstant.USA)
                    //    {
                    //        istrZipCode = istrZipCode ?? String.Empty;
                    //        istrZipCode = istrZipCode.ToUpper();
                    //        if ((istrZipCode4 != null) &&
                    //            (istrZipCode4 != String.Empty))
                    //        {
                    //            istrZipCode += "-" + istrZipCode4 ?? String.Empty;
                    //            istrZipCode = istrZipCode4.ToUpper();
                    //        }
                    //    }
                    //    else
                    //    {
                    //        istrZipCode = ldrPaymentHistory[enmPaymentHistoryDistribution.foreign_postal_code.ToString().ToUpper()]!=DBNull.Value?Convert.ToString(ldrPaymentHistory[enmPaymentHistoryDistribution.foreign_postal_code.ToString().ToUpper()]) : String.Empty;
                    //        istrZipCode = istrZipCode.ToUpper();
                    //    }
                    //}
                }
            }
        }
        public void GetCollectionPayemntHistoryDistributionDetails(string astrTemplateName)
        {

            DataTable ldtbPaymentHistory = busBase.Select("cdoPaymentHistoryDistribution.GetOutstandingRecordsForPayee", new object[1] { this.icdoPayeeAccount.payee_account_id });
            iblnIsBatch = false;

            DataTable dt = new DataTable();
            DateTime d1 = DateTime.Now.AddDays(-150);
            DateTime d2 = DateTime.Now.AddDays(-180);
            // dt = ldtbPaymentHistory;

            //PIR 1040: Builds bookMarks properties for the coresspondence within 150 and 180 and corres_generated_flag.
            if (iobjPassInfo.istrFormName == null)
            {
                if (astrTemplateName != busConstant.IAP_REPAYMENT_AUTHORIZATION_LETTER)
                {



                    var rowSourcesBatch = ldtbPaymentHistory.AsEnumerable()
                                    .Where(x => ((x.Field<string>("CORRES_GENERATED_FLAG") == string.Empty || x.Field<string>("CORRES_GENERATED_FLAG") == null)
                                          && ((DateTime)x["PAYMENT_DATE"]).Date >= d2 && ((DateTime)x["PAYMENT_DATE"]).Date <= d1));
                    //PIR: 1040 - If correspondence generated through the batch logged in username should not displayed in correspondence letter. this flag will restrict the username.
                    iblnIsBatch = true;

                    if (rowSourcesBatch.Any())
                    {
                        dt = rowSourcesBatch.CopyToDataTable<DataRow>();
                    }
                }
            }
            else
            {
                if (astrTemplateName == busConstant.IAP_OUTSTANDING_CHECKS || astrTemplateName == busConstant.IAP_REPAYMENT_AUTHORIZATION_LETTER)
                {
                    var rowSourcesUI = ldtbPaymentHistory.AsEnumerable()
                                  .Where(x => (((DateTime)x["PAYMENT_DATE"]).Date >= d2 && ((DateTime)x["PAYMENT_DATE"]).Date <= d1));

                    if (rowSourcesUI.Any())
                    {
                        dt = rowSourcesUI.CopyToDataTable<DataRow>();
                    }
                }


            }

            iclbPaymentHistoryDistribution = new Collection<busPaymentHistoryDistribution>();
            if (dt.Rows.Count > 0)
            {
                foreach (DataRow ldrPaymentHistory in dt.Rows)
                {
                    busPaymentHistoryDistribution abusPaymentHistoryDistribution = new busPaymentHistoryDistribution { icdoPaymentHistoryDistribution = new cdoPaymentHistoryDistribution() };
                    abusPaymentHistoryDistribution.icdoPaymentHistoryDistribution.LoadData(ldrPaymentHistory);
                    iclbPaymentHistoryDistribution.Add(abusPaymentHistoryDistribution);

                    istrPayeeFullName = (ldrPaymentHistory["PAYEE_NAME"] != DBNull.Value ? Convert.ToString(ldrPaymentHistory["PAYEE_NAME"]).ToUpper() : String.Empty).ToUpper();
                    istrPayeeNameProperCase = (ldrPaymentHistory["PAYEE_NAME"] != DBNull.Value ? Convert.ToString(ldrPaymentHistory["PAYEE_NAME"]) : String.Empty).ToUpper();
                    istrRecepientName = (ldrPaymentHistory[enmPaymentHistoryDistribution.recipient_name.ToString().ToUpper()] != DBNull.Value ? Convert.ToString(ldrPaymentHistory[enmPaymentHistoryDistribution.recipient_name.ToString().ToUpper()]) : String.Empty).ToUpper();
                    istrRecepientNameInProperCase = (ldrPaymentHistory[enmPaymentHistoryDistribution.recipient_name.ToString().ToUpper()] != DBNull.Value ? Convert.ToString(ldrPaymentHistory[enmPaymentHistoryDistribution.recipient_name.ToString().ToUpper()]) : String.Empty).ToProperCase();
                    //this.istrTransferOrgContactName = (ldrPaymentHistory[enmPaymentHistoryDistribution.addr_line_1.ToString().ToUpper()] != DBNull.Value ? Convert.ToString(ldrPaymentHistory[enmPaymentHistoryDistribution.addr_line_1.ToString().ToUpper()]) : String.Empty);// Convert.ToString(ldrPaymentHistory[enmPaymentHistoryDistribution.recipient_name.ToString().ToUpper()]);
                    istrAddrLine1 = (ldrPaymentHistory[enmPaymentHistoryDistribution.addr_line_1.ToString().ToUpper()] != DBNull.Value ? Convert.ToString(ldrPaymentHistory[enmPaymentHistoryDistribution.addr_line_1.ToString().ToUpper()]) : String.Empty).ToUpper();//Convert.ToString(ldrPaymentHistory[enmPaymentHistoryDistribution.addr_line_1.ToString().ToUpper()]);
                    istrAddrLine2 = (ldrPaymentHistory[enmPaymentHistoryDistribution.addr_line_2.ToString().ToUpper()] != DBNull.Value ? Convert.ToString(ldrPaymentHistory[enmPaymentHistoryDistribution.addr_line_2.ToString().ToUpper()]) : String.Empty).ToUpper(); //Convert.ToString(ldrPaymentHistory[enmPaymentHistoryDistribution.addr_line_2.ToString().ToUpper()]);
                    istrAddrLine3 = (ldrPaymentHistory[enmPaymentHistoryDistribution.addr_line_3.ToString().ToUpper()] != DBNull.Value ? Convert.ToString(ldrPaymentHistory[enmPaymentHistoryDistribution.addr_line_3.ToString().ToUpper()]) : String.Empty).ToUpper(); //Convert.ToString(ldrPaymentHistory[enmPaymentHistoryDistribution.addr_line_2.ToString().ToUpper()]);
                    istrCity = (ldrPaymentHistory[enmPaymentHistoryDistribution.addr_city.ToString().ToUpper()] != DBNull.Value ? Convert.ToString(ldrPaymentHistory[enmPaymentHistoryDistribution.addr_city.ToString().ToUpper()]) : String.Empty).ToUpper(); //Convert.ToString(ldrPaymentHistory[enmPaymentHistoryDistribution.addr_city.ToString().ToUpper()]);
                    istrStateDescription = (iobjPassInfo.isrvDBCache.GetCodeDescriptionString(150, Convert.ToString(ldrPaymentHistory[enmPaymentHistoryDistribution.addr_state_value.ToString().ToUpper()]))).ToUpper();
                    istrZipCode = ldrPaymentHistory[enmPaymentHistoryDistribution.addr_zip_code.ToString().ToUpper()] != DBNull.Value ? Convert.ToString(ldrPaymentHistory[enmPaymentHistoryDistribution.addr_zip_code.ToString().ToUpper()]) : String.Empty;// Convert.ToString(ldrPaymentHistory[enmPaymentHistoryDistribution.addr_zip_code.ToString().ToUpper()]);
                    istrZipCode4 = ldrPaymentHistory[enmPaymentHistoryDistribution.addr_zip_4_code.ToString().ToUpper()] != DBNull.Value ? Convert.ToString(ldrPaymentHistory[enmPaymentHistoryDistribution.addr_zip_4_code.ToString().ToUpper()]) : String.Empty; //Convert.ToString(ldrPaymentHistory[enmPaymentHistoryDistribution.addr_zip_4_code.ToString().ToUpper()]);
                    iintCheckNumber = ldrPaymentHistory[enmPaymentHistoryDistribution.check_number.ToString().ToUpper()] != DBNull.Value ? Convert.ToInt32(ldrPaymentHistory[enmPaymentHistoryDistribution.check_number.ToString().ToUpper()]) : 0; //Convert.ToInt32(ldrPaymentHistory[enmPaymentHistoryDistribution.check_number.ToString().ToUpper()]);
                    idtCheckDate = ldrPaymentHistory[enmPaymentHistoryDistribution.check_ach_effective_date.ToString().ToUpper()] != DBNull.Value ? Convert.ToDateTime(ldrPaymentHistory[enmPaymentHistoryDistribution.check_ach_effective_date.ToString().ToUpper()]) : DateTime.MinValue;// Convert.ToDateTime(ldrPaymentHistory[enmPaymentHistoryDistribution.check_ach_effective_date.ToString().ToUpper()]);
                    istrCheckDate = busGlobalFunctions.ConvertDateIntoDifFormat(idtCheckDate);
                    idecAmount = ldrPaymentHistory[enmPaymentHistoryDistribution.net_amount.ToString().ToUpper()] != DBNull.Value ? Convert.ToDecimal(ldrPaymentHistory[enmPaymentHistoryDistribution.net_amount.ToString().ToUpper()]) : 0M; //Convert.ToDecimal(ldrPaymentHistory[enmPaymentHistoryDistribution.net_amount.ToString().ToUpper()]);
                    if (ldrPaymentHistory[enmPaymentHistoryDistribution.addr_country_value.ToString().ToUpper()] != DBNull.Value && Convert.ToString(ldrPaymentHistory[enmPaymentHistoryDistribution.addr_country_value.ToString().ToUpper()]) != string.Empty)
                    {
                        istrCountryValue = Convert.ToString(ldrPaymentHistory[enmPaymentHistoryDistribution.addr_country_value.ToString().ToUpper()]);
                        if (istrCountryValue.IsNotNullOrEmpty())
                        {
                            istrCountryDescription = (iobjPassInfo.isrvDBCache.GetCodeDescriptionString(151, Convert.ToString(ldrPaymentHistory[enmPaymentHistoryDistribution.addr_country_value.ToString().ToUpper()]))).ToUpper();
                        }
                        if (Convert.ToInt32(ldrPaymentHistory[enmPaymentHistoryDistribution.addr_country_value.ToString().ToUpper()]) == busConstant.USA)
                        {
                            istrZipCode = (istrCity + " " + Convert.ToString(ldrPaymentHistory[enmPaymentHistoryDistribution.addr_state_value.ToString().ToUpper()]) + "  " +
                                                   istrZipCode) ?? String.Empty;

                            if ((istrZipCode4 != null) &&
                                   (istrZipCode4.Trim() != String.Empty))
                            {
                                istrZipCode += "-" + istrZipCode4 ?? String.Empty;
                            }
                            istrZipCode = istrZipCode.ToUpper();
                        }
                        else
                        {

                            istrZipCode = ldrPaymentHistory[enmPaymentHistoryDistribution.foreign_postal_code.ToString().ToUpper()] != DBNull.Value ? Convert.ToString(ldrPaymentHistory[enmPaymentHistoryDistribution.foreign_postal_code.ToString().ToUpper()]) : String.Empty + " " + istrCity;
                            istrZipCode = istrZipCode.ToUpper();
                        }
                    }
                    // }

                }
            }
        }
        public bool ShowConvertBenefitOptionButton()
        {
            DataTable ldtbList = busBase.Select("cdoBenefitApplication.LoadPopUpBenefitOptionsByPlanBenefitID",
                            new object[1] { this.icdoPayeeAccount.plan_benefit_id });

            if (ldtbList.Rows.Count > 0)
                return true;
            else
                return false;
        }

        public bool ShowRolloverOptionForRetireePayeeAccount()
        {
            if (iclbPayeeAccountPaymentItemType != null && !iclbPayeeAccountPaymentItemType.Where(
                            item => item.icdoPayeeAccountPaymentItemType.payment_item_type_id == 48).IsNullOrEmpty())
            {
                return true;
            }

            return false;
        }

        public void LoadPayeeAccountRetroPayments()
        {
            iclbPayeeAccountRetroPayment = new Collection<busPayeeAccountRetroPayment>();
            DataTable ltblRetroPayment = Select("cdoPayeeAccount.LoadPayeeAccountRetroPayments", new object[1] { icdoPayeeAccount.payee_account_id });
            if (ltblRetroPayment.Rows.Count > 0)
            {
                iclbPayeeAccountRetroPayment = GetCollection<busPayeeAccountRetroPayment>(ltblRetroPayment, "icdoPayeeAccountRetroPayment");
            }
        }

        public void LoadAllRepaymentSchedules()
        {
            iclbRepaymentSchedule = new Collection<busRepaymentSchedule>();
            DataTable ltblRepaymentSchedules = Select("cdoRepaymentSchedule.LoadAllRepaymentSchedules", new object[1] { icdoPayeeAccount.payee_account_id });
            if (ltblRepaymentSchedules.Rows.Count > 0)
            {
                iclbRepaymentSchedule = GetCollection<busRepaymentSchedule>(ltblRepaymentSchedules, "icdoRepaymentSchedule");
            }
        }

        public void LoadPayeeAccountBenefitOverPayment()
        {
            iclbPayeeAccountBenefitOverpayment = new Collection<busPayeeAccountBenefitOverpayment>();
            DataTable ltblBenefitOverpayment = Select("cdoPayeeAccount.LoadBenefitOverpayment", new object[1] { icdoPayeeAccount.payee_account_id });
            if (ltblBenefitOverpayment.Rows.Count > 0)
            {
                iclbPayeeAccountBenefitOverpayment = GetCollection<busPayeeAccountBenefitOverpayment>(ltblBenefitOverpayment, "icdoPayeeAccountRetroPayment");
            }


            //Need to change

            if (iclbPayeeAccountBenefitOverpayment != null)
            {
                foreach (busPayeeAccountBenefitOverpayment lbusPayeeAccountBenefitOverpayment in iclbPayeeAccountBenefitOverpayment)
                {
                    lbusPayeeAccountBenefitOverpayment.iclbRepaymentSchedule = new Collection<busRepaymentSchedule>();
                    lbusPayeeAccountBenefitOverpayment.LoadRepaymentSchedule();

                    lbusPayeeAccountBenefitOverpayment.iclbBenefitMonthwiseAdjustmentDetail = new Collection<busBenefitMonthwiseAdjustmentDetail>();
                    lbusPayeeAccountBenefitOverpayment.LoadBenefitMonthwiseAdjustmentDetails();
                }
            }

        }

        //6/15/2020 - IAP Payback
        public void LoadPayeeAccountIAPPaybacks()
        {
            iclbIAPHardshipPayback = new Collection<busIapHardshipPayback>();
            decimal idecIAPTotalBalanceAmount = 0;
            string istrWithdrawalType = string.Empty;

            DataTable ltblIAPHardshipPayback = Select("cdoPayeeAccount.LoadPayeeAccountIAPPaybacks", new object[1] { icdoPayeeAccount.payee_account_id });
            if (ltblIAPHardshipPayback.Rows.Count > 0)
            {
                iclbIAPHardshipPayback = GetCollection<busIapHardshipPayback>(ltblIAPHardshipPayback, "icdoIapHardshipPayback");
            }

            if (iclbIAPHardshipPayback.Count > 0)
            {
                idecIAPPaybackPaymentsReceived = iclbIAPHardshipPayback.Sum(item => item.icdoIapHardshipPayback.check_amount);

                var IAPPaybackSummary = from x in iclbIAPHardshipPayback
                                        group x.icdoIapHardshipPayback.check_amount by new { x.icdoIapHardshipPayback.check_date.Year }
                                        into y
                                        select new { y.Key.Year, check_amount = y.Sum() };

                this.iclbIAPPaybacksSummary = new Collection<cdoIapHardshipPayback>();

                foreach (var x in IAPPaybackSummary)
                {
                    cdoIapHardshipPayback icdoIAPHardshipPayback = new cdoIapHardshipPayback();
                    icdoIAPHardshipPayback.istrIAPPaybackYear = "Payback in " + x.Year + ":";
                    icdoIAPHardshipPayback.idecTotalIAPPaybacksReceived = x.check_amount;
                    this.iclbIAPPaybacksSummary.Add(icdoIAPHardshipPayback);
                }

                DataTable ltblWithdrawalTypeValue = Select("cdoPayeeAccount.GetWithdrawalTypebyApplicationDetailId", new object[1] { icdoPayeeAccount.benefit_application_detail_id });

                if (ltblWithdrawalTypeValue.Rows.Count > 0)
                {
                    istrWithdrawalType = ltblWithdrawalTypeValue.Rows[0][0].ToString();
                }

                if (this.istrMoreInformation == busConstant.HARDSHIP_2025_IAP_WITHDRAWAL || istrWithdrawalType ==  "HS25")
                {
                    idecIAPPayback2025Amount = iclbIAPPaybacksSummary.Where(x => x.istrIAPPaybackYear.Contains("2025")).Select(i => i.idecTotalIAPPaybacksReceived).FirstOrDefault();
                    idecIAPPayback2025Amount = idecIAPPayback2025Amount > 0 ? idecIAPPayback2025Amount * -1 : idecIAPPayback2025Amount;
                    idecIAPPayback2026Amount = iclbIAPPaybacksSummary.Where(x => x.istrIAPPaybackYear.Contains("2026")).Select(i => i.idecTotalIAPPaybacksReceived).FirstOrDefault();
                    idecIAPPayback2026Amount = idecIAPPayback2026Amount > 0 ? idecIAPPayback2026Amount * -1 : idecIAPPayback2026Amount;
                    idecIAPPayback2027Amount = iclbIAPPaybacksSummary.Where(x => x.istrIAPPaybackYear.Contains("2027")).Select(i => i.idecTotalIAPPaybacksReceived).FirstOrDefault();
                    idecIAPPayback2027Amount = idecIAPPayback2027Amount > 0 ? idecIAPPayback2027Amount * -1 : idecIAPPayback2027Amount;
                    idecIAPPayback2028Amount = iclbIAPPaybacksSummary.Where(x => x.istrIAPPaybackYear.Contains("2028")).Select(i => i.idecTotalIAPPaybacksReceived).FirstOrDefault();
                    idecIAPPayback2028Amount = idecIAPPayback2028Amount > 0 ? idecIAPPayback2028Amount * -1 : idecIAPPayback2028Amount;


                }
                else
                {
                    idecIAPPayback2020Amount = iclbIAPPaybacksSummary.Where(x => x.istrIAPPaybackYear.Contains("2020")).Select(i => i.idecTotalIAPPaybacksReceived).FirstOrDefault();
                    idecIAPPayback2020Amount = idecIAPPayback2020Amount > 0 ? idecIAPPayback2020Amount * -1 : idecIAPPayback2020Amount;
                    idecIAPPayback2021Amount = iclbIAPPaybacksSummary.Where(x => x.istrIAPPaybackYear.Contains("2021")).Select(i => i.idecTotalIAPPaybacksReceived).FirstOrDefault();
                    idecIAPPayback2021Amount = idecIAPPayback2021Amount > 0 ? idecIAPPayback2021Amount * -1 : idecIAPPayback2021Amount;
                    idecIAPPayback2022Amount = iclbIAPPaybacksSummary.Where(x => x.istrIAPPaybackYear.Contains("2022")).Select(i => i.idecTotalIAPPaybacksReceived).FirstOrDefault();
                    idecIAPPayback2022Amount = idecIAPPayback2022Amount > 0 ? idecIAPPayback2022Amount * -1 : idecIAPPayback2022Amount;
                    idecIAPPayback2023Amount = iclbIAPPaybacksSummary.Where(x => x.istrIAPPaybackYear.Contains("2023")).Select(i => i.idecTotalIAPPaybacksReceived).FirstOrDefault();
                    idecIAPPayback2023Amount = idecIAPPayback2023Amount > 0 ? idecIAPPayback2023Amount * -1 : idecIAPPayback2023Amount;

                }

                busIapHardshipPayback lastIAPPaybackCheck = iclbIAPHardshipPayback.OrderByDescending(a => a.icdoIapHardshipPayback.check_date).FirstOrDefault();
                istrIAPPaybackLastChkNum = lastIAPPaybackCheck.icdoIapHardshipPayback.check_number;
                idtIAPPaybackLastChkDt = lastIAPPaybackCheck.icdoIapHardshipPayback.check_date;
                idecIAPPaybackLastChkAmt = lastIAPPaybackCheck.icdoIapHardshipPayback.check_amount;
            }
            else
            {
                idecIAPPaybackPaymentsReceived = 0;
                if (this.iclbIAPPaybacksSummary.IsNotNull())
                    this.iclbIAPPaybacksSummary.Clear();
            }

            //6/15/2020 - IAP Payback
            if (iclbPaymentHistoryHeader == null)
                LoadPaymentHistoryHeader(this.icdoPayeeAccount.payee_account_id); //This populates iclbPaymentHistoryHeader

            busPaymentHistoryHeader lbusPaymentHistoryHeader = new busPaymentHistoryHeader();

            if (iclbPaymentHistoryHeader.IsNotNull() && iclbPaymentHistoryHeader.Count() > 0)
            {
                //Ticket 100522 - Retrieve the check that's in "Cleared" status
                DataTable ldtCleardDistribution = busBase.Select("cdoPaymentHistoryHeader.GetClrdDistributionByPayeeAccountID", new Object[1] { this.icdoPayeeAccount.payee_account_id });
                if (ldtCleardDistribution != null && ldtCleardDistribution.Rows.Count > 0)
                {
                    DataRow ldtrRow = ldtCleardDistribution.Rows[0];
                    int clrdPayment = Convert.ToInt32(ldtrRow["PAYMENT_HISTORY_HEADER_ID"]);

                    //Filter results to just the Cleared Check
                    lbusPaymentHistoryHeader = iclbPaymentHistoryHeader.Where(i => i.icdoPaymentHistoryHeader.payment_history_header_id == clrdPayment).FirstOrDefault();

                }
                else
                {
                    //Filter results to whatever the first check is since there is no Cleared check yet
                    lbusPaymentHistoryHeader = iclbPaymentHistoryHeader.FirstOrDefault();
                }
                idtIAPPaybackMaximumDueDate = lbusPaymentHistoryHeader.icdoPaymentHistoryHeader.payment_date.AddYears(3).GetLastDayofMonth();
                istrIAPPaybackMaximumDueDate = busGlobalFunctions.ConvertDateIntoDifFormat(idtIAPPaybackMaximumDueDate);
                idtIAPHardshipPaymentCheckDate = lbusPaymentHistoryHeader.icdoPaymentHistoryHeader.payment_date;
                istrIAPHardshipPaymentCheckDate = busGlobalFunctions.ConvertDateIntoDifFormat(idtIAPHardshipPaymentCheckDate);

            }

            if (idecGrossBenefitAmount != 0 && idecIAPPaybackPaymentsReceived != 0)
            {
                idecIAPPaybackRemainingUnPaidBalance = idecGrossBenefitAmount - idecIAPPaybackPaymentsReceived;
            }
            else
            {
                idecIAPPaybackRemainingUnPaidBalance = idecGrossBenefitAmount;
            }

            if (idecIAPPaybackRemainingUnPaidBalance > 0 && idtIAPPaybackMaximumDueDate > DateTime.Now)
            {
                istrIAPPaybackStatus = "In Progress";
            }
            else
            {
                istrIAPPaybackStatus = "Completed";
            }

            foreach (busIapHardshipPayback item in iclbIAPHardshipPayback)
            {
                idecIAPTotalBalanceAmount += item.icdoIapHardshipPayback.check_amount;
                item.icdoIapHardshipPayback.idecRunningIAPPaybackBalance = idecIAPTotalBalanceAmount;
            }

        }


        public void GeneratePaymentDirectiveForWizard()
        {
            this.ibusParticipant = new busPerson { icdoPerson = new cdoPerson() };
            this.ibusParticipant.FindPerson(this.icdoPayeeAccount.person_id);

            GeneratePaymentDirective();

        }

        public void InsertPersonNotesFromWizard()
        {

            this.ibusPayee = new busPerson { icdoPerson = new cdoPerson() };
            this.ibusPayee.FindPerson(this.icdoPayeeAccount.person_id);
            this.ibusPayee.iclbNotes = busGlobalFunctions.LoadNotes(this.icdoPayeeAccount.person_id, 0, busConstant.PERSON_MAINTAINENCE_FORM);

            busNotes lbusNotes = new busNotes { icdoNotes = new cdoNotes() };

            if (lbusNotes != null)
            {
                lbusNotes.icdoNotes.person_id = this.icdoPayeeAccount.person_id;
                lbusNotes.icdoNotes.org_id = 0;
                lbusNotes.icdoNotes.form_value = busConstant.PERSON_MAINTAINENCE_FORM;
                lbusNotes.icdoNotes.notes = "A pension payment for retirement date " + Convert.ToString(this.icdoPayeeAccount.idtRetireMentDate.Date.ToShortDateString()) + " has been submitted for audit review.";
                lbusNotes.icdoNotes.created_by = iobjPassInfo.istrUserID;
                lbusNotes.icdoNotes.created_date = DateTime.Now;
                lbusNotes.icdoNotes.modified_by = iobjPassInfo.istrUserID;
                lbusNotes.icdoNotes.modified_date = DateTime.Now;
                lbusNotes.icdoNotes.Insert();

            }
        }


        public void UpdatePacketTrackingStatusFromWizard()
        {

        
           busCorPacketContentTracking lbusCorPacketContentTracking = new busCorPacketContentTracking { icdoCorPacketContentTracking = new cdoCorPacketContentTracking() };
            DataTable ldtbList = Select("cdoCorPacketContent.GetPacketTrackingLIstByPersonId", new object[1] { this.icdoPayeeAccount.person_id });

            if (ldtbList.Rows.Count > 0)
            {
               
                foreach (DataRow ldtr in ldtbList.Rows)
                {

                    if (lbusCorPacketContentTracking != null)
                    {
                        lbusCorPacketContentTracking.FindCorPacketContentTracking(Convert.ToInt32(ldtr["TRACKING_ID"].ToString()));

                        if((lbusCorPacketContentTracking.icdoCorPacketContentTracking.tracking_id > 0) && 
                           (Convert.ToInt32(ldtr["TEMPLATE_ID"].ToString()) == busConstant.Retirement_Benefit_Election_PacketMPI ||
                            Convert.ToInt32(ldtr["TEMPLATE_ID"].ToString()) == busConstant.Retirement_Benefit_Election_Packet_Local_161 ||
                             Convert.ToInt32(ldtr["TEMPLATE_ID"].ToString()) == busConstant.Retirement_Benefit_Election_Packet_Local_52 ||
                             Convert.ToInt32(ldtr["TEMPLATE_ID"].ToString()) == busConstant.Retirement_Benefit_Election_Packet_Local_600 ||
                            Convert.ToInt32(ldtr["TEMPLATE_ID"].ToString()) == busConstant.Retirement_Benefit_Election_Packet_Local666 ||
                         Convert.ToInt32(ldtr["TEMPLATE_ID"].ToString()) == busConstant.Retirement_Benefit_Election_Packet_Local700))
                        {
                            if (lbusCorPacketContentTracking.icdoCorPacketContentTracking.packet_status_value != "CMPL")
                            {


                                busCorPacketContentTrackingHistory lbusCorPacketContentTrackingHistory = new busCorPacketContentTrackingHistory { icdoCorPacketContentTrackingHistory = new cdoCorPacketContentTrackingHistory() };

                                lbusCorPacketContentTrackingHistory.icdoCorPacketContentTrackingHistory.cor_packet_content_tracking_id = lbusCorPacketContentTracking.icdoCorPacketContentTracking.cor_packet_content_tracking_id;
                                lbusCorPacketContentTrackingHistory.icdoCorPacketContentTrackingHistory.mailed_by = lbusCorPacketContentTracking.icdoCorPacketContentTracking.mailed_by;
                                lbusCorPacketContentTrackingHistory.icdoCorPacketContentTrackingHistory.mailed_date = lbusCorPacketContentTracking.icdoCorPacketContentTracking.mailed_date;
                                lbusCorPacketContentTrackingHistory.icdoCorPacketContentTrackingHistory.received_by = lbusCorPacketContentTracking.icdoCorPacketContentTracking.received_by;
                                lbusCorPacketContentTrackingHistory.icdoCorPacketContentTrackingHistory.received_date = lbusCorPacketContentTracking.icdoCorPacketContentTracking.received_date;
                                lbusCorPacketContentTrackingHistory.icdoCorPacketContentTrackingHistory.packet_status_value = lbusCorPacketContentTracking.icdoCorPacketContentTracking.packet_status_value;
                                lbusCorPacketContentTrackingHistory.icdoCorPacketContentTrackingHistory.created_by = iobjPassInfo.istrUserID;
                                lbusCorPacketContentTrackingHistory.icdoCorPacketContentTrackingHistory.created_date = DateTime.Now;
                                lbusCorPacketContentTrackingHistory.icdoCorPacketContentTrackingHistory.modified_by = iobjPassInfo.istrUserID;
                                lbusCorPacketContentTrackingHistory.icdoCorPacketContentTrackingHistory.modified_date = DateTime.Now;
                                lbusCorPacketContentTrackingHistory.icdoCorPacketContentTrackingHistory.Insert();


                                lbusCorPacketContentTracking.icdoCorPacketContentTracking.packet_status_value = "CMPL";
                                lbusCorPacketContentTracking.icdoCorPacketContentTracking.modified_by = iobjPassInfo.istrUserID;
                                lbusCorPacketContentTracking.icdoCorPacketContentTracking.modified_date = DateTime.Now;
                                lbusCorPacketContentTracking.icdoCorPacketContentTracking.Update();


                            }


                        }

                       
                    }

                }





               
            }
                    



        }

        public void WizardTaxWithholdingSave(busPayeeAccountTaxWithholding lbusPayeeAccountTaxWithholding )
        {
            lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.payee_account_id = this.icdoPayeeAccount.payee_account_id;
            lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.tax_identifier_value = Convert.ToString(this.istrWizardTaxIdentifier);
            lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.benefit_distribution_type_value = Convert.ToString(this.istrWizardMinDistributionType);
            lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.tax_option_value = Convert.ToString(this.istrWizardTaxOptionValue);
            lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.marital_status_value = Convert.ToString(this.istrWizardMaritalStatusValue);
            lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.tax_allowance = this.iWizardtax_allowance;
            lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.tax_percentage = this.idecWizardtax_percentage;
            lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.start_date = this.idtWizardStartDate;
            lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.end_date = this.idtWizardEndDate;
            lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.step_2_b_3 = this.idecWizardStep2b3;
            lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.step_3_amount = this.idecWizardStep3;
            lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.step_4_a = this.idecWizardStep4A;
            lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.step_4_b = this.idecWizardStep4B;
            lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.step_4_c = this.idecWizardStep4C;
            lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.additional_tax_amount = this.idecWizardadditional_tax_amount;
            lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.personal_exemptions = iintWizardPersonlExemption;
            lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.age_and_blindness_exemptions = iintWizardAgeandBlindnessExemptions;
            lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.voluntary_withholding = iintWizardVoluntary_Withholding;
           lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.created_by = iobjPassInfo.istrUserID;
            lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.created_date = DateTime.Now;
            lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.modified_by = iobjPassInfo.istrUserID;
            lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.modified_date = DateTime.Now;

            

        }
        public ArrayList WizardTaxWithholdingValidate()
        {
            ArrayList larrList = new ArrayList();
            utlError lobjError = null;
                       
            busPayeeAccountTaxWithholding lbusPayeeAccountTaxWithholding = new busPayeeAccountTaxWithholding { icdoPayeeAccountTaxWithholding = new cdoPayeeAccountTaxWithholding() };

            if (lbusPayeeAccountTaxWithholding != null)
            {


                WizardTaxWithholdingSave(lbusPayeeAccountTaxWithholding);


                Hashtable lhstParams = new Hashtable();

                lhstParams["icdoPayeeAccountTaxWithholding.payee_account_id"] = lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.payee_account_id;
                lhstParams["tax_identifier_value"] = lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.tax_identifier_value;
                lhstParams["benefit_distribution_type_value"] = lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.benefit_distribution_type_value;
                lhstParams["tax_option_value"] = lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.tax_option_value;
                lhstParams["marital_status_value"] = lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.marital_status_value;
                lhstParams["tax_allowance"] = lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.tax_allowance;
                lhstParams["tax_percentage"] = lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.tax_percentage;
                lhstParams["additional_tax_amount"] = this.idecWizardadditional_tax_amount;

                if (lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.start_date != DateTime.MinValue)
                {
                    lhstParams["start_date"] = lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.start_date;

                }
                else
                {
                    lhstParams["start_date"] = null;

                }
                if (lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.end_date != DateTime.MinValue)
                {
                    lhstParams["end_date"] = lbusPayeeAccountTaxWithholding.icdoPayeeAccountTaxWithholding.end_date;

                }
                else
                {
                    lhstParams["end_date"] = null;

                }
            

                this.iarrErrors = lbusPayeeAccountTaxWithholding.CheckErrorOnAddButton(this, lhstParams, ref iarrErrors, true);

            }

            return this.iarrErrors;

        }

        public void AssigningPayeeAccountACHWizardDetails(busPayeeAccountAchDetail lbusPayeeAccountAchDetail)
        {
           

            lbusPayeeAccountAchDetail.icdoPayeeAccountAchDetail.payee_account_id = this.icdoPayeeAccount.payee_account_id;
            lbusPayeeAccountAchDetail.icdoPayeeAccountAchDetail.bank_org_id = this.iintWizardBankOrgId;
            lbusPayeeAccountAchDetail.icdoPayeeAccountAchDetail.bank_account_type_value = Convert.ToString(this.istrWizardBankAccountType);
            lbusPayeeAccountAchDetail.icdoPayeeAccountAchDetail.account_number = Convert.ToString(this.istrWizardAccountNumber);
            lbusPayeeAccountAchDetail.icdoPayeeAccountAchDetail.pre_note_flag = Convert.ToString(this.istrWizardPrenoteFlag);
                                                                           
            lbusPayeeAccountAchDetail.icdoPayeeAccountAchDetail.primary_account_flag = "Y";
            lbusPayeeAccountAchDetail.icdoPayeeAccountAchDetail.ach_start_date = Convert.ToDateTime(this.dtWizardAchStartDate);
            lbusPayeeAccountAchDetail.icdoPayeeAccountAchDetail.ach_end_date = Convert.ToDateTime(this.dtWizardAchEnddate);
            lbusPayeeAccountAchDetail.icdoPayeeAccountAchDetail.pre_note_completion_date = Convert.ToDateTime(this.dtWizardPreNoteCompletionDate);
            lbusPayeeAccountAchDetail.icdoPayeeAccountAchDetail.created_by = iobjPassInfo.istrUserID;
            lbusPayeeAccountAchDetail.icdoPayeeAccountAchDetail.created_date = DateTime.Now;
            lbusPayeeAccountAchDetail.icdoPayeeAccountAchDetail.modified_by = iobjPassInfo.istrUserID;
            lbusPayeeAccountAchDetail.icdoPayeeAccountAchDetail.modified_date = DateTime.Now;
            lbusPayeeAccountAchDetail.icdoPayeeAccountAchDetail.joint_account_flag = Convert.ToString(this.istrWizardJointAccountFlag.IsNullOrEmpty() ? "N" : this.istrWizardJointAccountFlag);

            
        }


       


        public ArrayList WizardACHDetailsValidate()
        {
            ArrayList larrList = new ArrayList();
            utlError lobjError = null;

            busPayeeAccountAchDetail lbusPayeeAccountAchDetail = new busPayeeAccountAchDetail { icdoPayeeAccountAchDetail = new cdoPayeeAccountAchDetail() };

            if (lbusPayeeAccountAchDetail != null)
            {


                AssigningPayeeAccountACHWizardDetails(lbusPayeeAccountAchDetail);


                Hashtable lhstParams = new Hashtable();

                if (this.istrWizardPaymentMethod != "CHK")
                {

                    lbusPayeeAccountAchDetail.icdoPayeeAccountAchDetail.payee_account_id = this.icdoPayeeAccount.payee_account_id;
                    lbusPayeeAccountAchDetail.icdoPayeeAccountAchDetail.bank_org_id = this.iintWizardBankOrgId;
                    lbusPayeeAccountAchDetail.icdoPayeeAccountAchDetail.bank_account_type_value = Convert.ToString(istrWizardBankAccountType);
                    lbusPayeeAccountAchDetail.icdoPayeeAccountAchDetail.account_number = Convert.ToString(this.istrWizardAccountNumber);
                    lbusPayeeAccountAchDetail.icdoPayeeAccountAchDetail.pre_note_flag = Convert.ToString(this.istrWizardPrenoteFlag);
                    lbusPayeeAccountAchDetail.icdoPayeeAccountAchDetail.primary_account_flag = "Y";
                    lbusPayeeAccountAchDetail.icdoPayeeAccountAchDetail.ach_start_date = this.dtWizardAchStartDate;
                    lbusPayeeAccountAchDetail.icdoPayeeAccountAchDetail.ach_end_date = this.dtWizardAchEnddate;


                    lhstParams["bank_account_type_value"] = lbusPayeeAccountAchDetail.icdoPayeeAccountAchDetail.bank_account_type_value;
                    lhstParams["bank_org_id"] = lbusPayeeAccountAchDetail.icdoPayeeAccountAchDetail.bank_org_id;
                    lhstParams["istrRoutingNumber"] = Convert.ToString(this.istrWizardRoutingNumber);
                    lhstParams["account_number"] = lbusPayeeAccountAchDetail.icdoPayeeAccountAchDetail.account_number;


                    if (lbusPayeeAccountAchDetail.icdoPayeeAccountAchDetail.ach_start_date != DateTime.MinValue)
                    {
                        lhstParams["ach_start_date"] = lbusPayeeAccountAchDetail.icdoPayeeAccountAchDetail.ach_start_date;

                    }
                    else
                    {
                        lhstParams["ach_start_date"] = null;

                    }

                    if (lbusPayeeAccountAchDetail.icdoPayeeAccountAchDetail.ach_end_date != DateTime.MinValue)
                    {
                        lhstParams["ach_end_date"] = lbusPayeeAccountAchDetail.icdoPayeeAccountAchDetail.ach_end_date;

                    }
                    else
                    {
                        lhstParams["ach_end_date"] = null;

                    }

                    if(this.iclbPayeeAccountAchDetail.Count == 0)
                    {
                        this.iarrErrors = lbusPayeeAccountAchDetail.CheckErrorOnAddButton(this, lhstParams, ref iarrErrors, true);

                        if (this.iarrErrors.Count == 0)
                        {
                            this.iclbPayeeAccountAchDetail.Add(lbusPayeeAccountAchDetail);

                        }

                    }

                }
            }
                              
            
            return this.iarrErrors;

        }



        public void Cancel_RetirementApplication_Wizard()
        {
          
            busBenefitApplicationDetail lbusBenefitApplicationDetail = new busBenefitApplicationDetail { icdoBenefitApplicationDetail = new cdoBenefitApplicationDetail()};

            if (lbusBenefitApplicationDetail.FindBenefitApplicationDetail(icdoPayeeAccount.benefit_application_detail_id))
            {
                this.ibusBenefitApplication = new busBenefitApplication();
                this.ibusBenefitApplication.FindBenefitApplication(lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.benefit_application_id);
                this.ibusBenefitApplication.ibusPerson = new busPerson { icdoPerson = new cdoPerson() };
                this.ibusBenefitApplication.ibusPerson.FindPerson(icdoPayeeAccount.person_id);
                this.ibusBenefitApplication.ibusPerson.LoadPersonAccounts();
                this.ibusBenefitApplication.LoadBenefitApplicationDetails();
                this.ibusBenefitApplication.btn_Cancelled();
               

            }
        }

        /// <summary>
        /// Get Tax Options By Identifier
        /// </summary>
        /// <param name="astrCodeValue"></param>
        /// <returns></returns>
        public Collection<cdoCodeValue> GetTaxOptionsByIdentifier(string astrCodeValue, string astrdistributiontypecodevalue, int astrTaxWithholdId)
        {
            Collection<cdoCodeValue> lclbTaxOptions = new Collection<cdoCodeValue>();

            //EmergencyOneTimePayment - 03/17/2020
            if (!astrdistributiontypecodevalue.IsNullOrEmpty() && (astrdistributiontypecodevalue == "null" || astrdistributiontypecodevalue == "NULL"))
            {
                astrdistributiontypecodevalue = string.Empty;
            }

            if (icdoPayeeAccount.retiree_incr_flag == "Y" && !string.IsNullOrEmpty(icdoPayeeAccount.istrBenefitDistributionType) &&
                (astrdistributiontypecodevalue.IsNullOrEmpty() || astrdistributiontypecodevalue == ""))
            {
                astrdistributiontypecodevalue = icdoPayeeAccount.istrBenefitDistributionType;
            }

            //begin rid 76034
            if (astrdistributiontypecodevalue.IsNullOrEmpty() && icdoPayeeAccount.istrBenefitOption != "Lump Sum" && icdoPayeeAccount.retiree_incr_flag != "Y")
            {
                astrdistributiontypecodevalue = busConstant.Benefit_Distribution_Type_Monthly_Benefit;
            }

            if (astrdistributiontypecodevalue.IsNullOrEmpty() && icdoPayeeAccount.istrBenefitOption == "Lump Sum" && icdoPayeeAccount.retiree_incr_flag != "Y")
            {
                astrdistributiontypecodevalue = busConstant.Benefit_Distribution_Type_LumpSum;
            }
            //end rid 76034  

            if (astrCodeValue.IsNullOrEmpty() || (astrCodeValue.IsNotNullOrEmpty() && astrCodeValue.Contains("null")))
            {
                if (this.icdoPayeeAccount.istrTaxIdentifier != null)
                {
                    astrCodeValue = this.icdoPayeeAccount.istrTaxIdentifier;

                }
                else
                {
                    astrCodeValue = string.Empty;

                }

            }

            if (astrdistributiontypecodevalue.IsNullOrEmpty() || (astrdistributiontypecodevalue.IsNotNullOrEmpty() && astrCodeValue.IsNullOrEmpty()))
            {
                astrdistributiontypecodevalue = string.Empty;
            }

            //Ticket#73404
            if (astrTaxWithholdId > 0)
            {
                var taxwithholding = this.iclbPayeeAccountTaxWithholding.Where(i => i.icdoPayeeAccountTaxWithholding.payee_account_tax_withholding_id == astrTaxWithholdId).FirstOrDefault();

                if (astrCodeValue == string.Empty)
                {
                    astrCodeValue = taxwithholding.icdoPayeeAccountTaxWithholding.tax_identifier_value;
                }

                if (astrdistributiontypecodevalue == string.Empty)
                {
                    astrdistributiontypecodevalue = taxwithholding.icdoPayeeAccountTaxWithholding.benefit_distribution_type_value;
                }


            }


            if (astrCodeValue != string.Empty && !astrdistributiontypecodevalue.IsNullOrEmpty())
            {

                DataTable ldtbResult = busBase.Select("cdoPayeeAccount.GetTaxOptions", new object[2] { astrCodeValue, astrdistributiontypecodevalue });

                //PIR 863
                if (this.icdoPayeeAccount.account_relation_value == busConstant.BenefitCalculation.ACCOUNT_RELATIONSHIP_BENEFICIARY
                    && this.icdoPayeeAccount.benefit_account_type_value == busConstant.BENEFIT_TYPE_DEATH_POST_RETIREMENT
                    && this.icdoPayeeAccount.iintPlanId != busConstant.IAP_PLAN_ID)
                {
                    if (ldtbResult.IsNotNull() && ldtbResult.Rows.Count > 0)
                    {
                        lclbTaxOptions = doBase.GetCollection<cdoCodeValue>(ldtbResult);
                    }

                    return lclbTaxOptions;
                }


                if (ldtbResult.IsNotNull() && ldtbResult.Rows.Count > 0)
                {
                    bool lblnStateTax = false;
                    if (astrCodeValue == busConstant.CA_STATE_TAX || astrCodeValue == busConstant.GA_STATE_TAX || astrCodeValue == busConstant.OR_STATE_TAX || astrCodeValue == busConstant.NC_STATE_TAX || astrCodeValue == busConstant.VA_STATE_TAX)
                    {
                        if (this.ibusPayee != null)
                        {
                            this.ibusPayee.iclbPersonAddress = new Collection<busPersonAddress>();
                            if (this.icdoPayeeAccount.account_relation_value == busConstant.BenefitCalculation.ACCOUNT_RELATIONSHIP_BENEFICIARY)
                            {
                                this.ibusPayee.iblnBeneficiary = busConstant.YES;
                                this.ibusPayee.iblnParticipant = string.Empty;
                                this.ibusPayee.iblnDependent = string.Empty;
                            }

                            this.ibusPayee.LoadPersonAddresss();


                            foreach (busPersonAddress lbusPersonAddress in this.ibusPayee.iclbPersonAddress)
                            {
                                if ((lbusPersonAddress.icdoPersonAddress.end_date >= DateTime.Now || lbusPersonAddress.icdoPersonAddress.end_date == DateTime.MinValue) &&
                                   lbusPersonAddress.icdoPersonAddress.start_date <= DateTime.Now && lbusPersonAddress.icdoPersonAddress.start_date != lbusPersonAddress.icdoPersonAddress.end_date)
                                {
                                    foreach (cdoPersonAddressChklist lcdoPersonAddressChklist in lbusPersonAddress.iclcPersonAddressChklist)
                                    {
                                        if (lcdoPersonAddressChklist.address_type_value == busConstant.MAILING_ADDRESS || lcdoPersonAddressChklist.address_type_value == busConstant.PHYSICAL_AND_MAILING_ADDRESS)
                                        {
                                            if (lbusPersonAddress.icdoPersonAddress.addr_state_value == busConstant.CALIFORNIA || lbusPersonAddress.icdoPersonAddress.addr_state_value == busConstant.GEORGIA ||
                                                lbusPersonAddress.icdoPersonAddress.addr_state_value == busConstant.OREGON || lbusPersonAddress.icdoPersonAddress.addr_state_value == busConstant.NORTH_CAROLINA
                                                || lbusPersonAddress.icdoPersonAddress.addr_state_value == busConstant.VERGINIA)
                                            {
                                                lblnStateTax = true;
                                                lclbTaxOptions = doBase.GetCollection<cdoCodeValue>(ldtbResult);
                                                break;
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        else
                        {

                            //this.ibusPayee.iclbPersonAddress = new Collection<busPersonAddress>();
                            this.ibusOrganization.iclbOrgAddress = new Collection<busOrgAddress>();
                            if (this.icdoPayeeAccount.account_relation_value == busConstant.BenefitCalculation.ACCOUNT_RELATIONSHIP_BENEFICIARY)
                            {
                                this.ibusOrganization.iblnBeneficiary = busConstant.YES;
                                this.ibusOrganization.iblnParticipant = string.Empty;
                                this.ibusOrganization.iblnDependent = string.Empty;
                            }

                            //this.ibusPayee.LoadPersonAddresss();
                            this.ibusOrganization.LoadOrgAddresss();


                            foreach (busOrgAddress lbusOrgAddress in this.ibusOrganization.iclbOrgAddress)
                            {
                                if ((lbusOrgAddress.icdoOrgAddress.end_date >= DateTime.Now || lbusOrgAddress.icdoOrgAddress.end_date == DateTime.MinValue) &&
                                   lbusOrgAddress.icdoOrgAddress.start_date <= DateTime.Now && lbusOrgAddress.icdoOrgAddress.start_date != lbusOrgAddress.icdoOrgAddress.end_date)
                                {

                                    if (lbusOrgAddress.icdoOrgAddress.address_type_value == busConstant.MAILING_ADDRESS || lbusOrgAddress.icdoOrgAddress.address_type_value == busConstant.PHYSICAL_AND_MAILING_ADDRESS)
                                    {
                                        if (lbusOrgAddress.icdoOrgAddress.state_value == busConstant.CALIFORNIA || lbusOrgAddress.icdoOrgAddress.state_value == busConstant.GEORGIA || lbusOrgAddress.icdoOrgAddress.state_value == busConstant.OREGON || lbusOrgAddress.icdoOrgAddress.state_value == busConstant.NORTH_CAROLINA || lbusOrgAddress.icdoOrgAddress.state_value == busConstant.VERGINIA)
                                        {
                                            lblnStateTax = true;
                                            lclbTaxOptions = doBase.GetCollection<cdoCodeValue>(ldtbResult);
                                            break;
                                        }
                                    }
                                }
                            }

                        }
                        if (!lblnStateTax)
                        {
                            Collection<cdoCodeValue> lclbTaxOptionsForCA = new Collection<cdoCodeValue>();
                            lclbTaxOptionsForCA = doBase.GetCollection<cdoCodeValue>(ldtbResult);
                            #region PROD PIR 173
                            if (this.iclbPayeeAccountTaxWithholding.Where(i => i.icdoPayeeAccountTaxWithholding.tax_identifier_value == busConstant.CA_STATE_TAX || i.icdoPayeeAccountTaxWithholding.tax_identifier_value == busConstant.GA_STATE_TAX
                                             || i.icdoPayeeAccountTaxWithholding.tax_identifier_value == busConstant.OR_STATE_TAX
                                             || i.icdoPayeeAccountTaxWithholding.tax_identifier_value == busConstant.NC_STATE_TAX
                                             || i.icdoPayeeAccountTaxWithholding.tax_identifier_value == busConstant.VA_STATE_TAX
                                             && i.icdoPayeeAccountTaxWithholding.tax_option_value != busConstant.NO_STATE_TAX && (i.icdoPayeeAccountTaxWithholding.end_date.IsNull()
                                             || i.icdoPayeeAccountTaxWithholding.end_date == DateTime.MinValue)).Count() > 0)
                                lclbTaxOptions.Add(lclbTaxOptionsForCA.Where(item => item.code_value ==
                                                                             this.iclbPayeeAccountTaxWithholding.Where(i => i.icdoPayeeAccountTaxWithholding.tax_identifier_value == busConstant.CA_STATE_TAX
                                                                              || i.icdoPayeeAccountTaxWithholding.tax_identifier_value == busConstant.GA_STATE_TAX
                                                                                     || i.icdoPayeeAccountTaxWithholding.tax_identifier_value == busConstant.OR_STATE_TAX
                                                                                     || i.icdoPayeeAccountTaxWithholding.tax_identifier_value == busConstant.NC_STATE_TAX
                                                                                     || i.icdoPayeeAccountTaxWithholding.tax_identifier_value == busConstant.VA_STATE_TAX
                                                                             && i.icdoPayeeAccountTaxWithholding.tax_option_value != busConstant.NO_STATE_TAX && (i.icdoPayeeAccountTaxWithholding.end_date.IsNull()
                                                                             || i.icdoPayeeAccountTaxWithholding.end_date == DateTime.MinValue)).FirstOrDefault().icdoPayeeAccountTaxWithholding.tax_option_value).FirstOrDefault());
                            #endregion
                            lclbTaxOptions.Add(lclbTaxOptionsForCA.Where(item => item.code_value == busConstant.NO_STATE_TAX).FirstOrDefault());
                        }
                        else if (this.icdoPayeeAccount.istrBenefitOption == busConstant.LUMP_SUM_DESCRIPTION && (lclbTaxOptions == null || lclbTaxOptions.Count() == 0))
                        {

                            Collection<cdoCodeValue> lclbTaxOptionsForCA = new Collection<cdoCodeValue>();
                            lclbTaxOptionsForCA = doBase.GetCollection<cdoCodeValue>(ldtbResult);
                            lclbTaxOptions = new Collection<cdoCodeValue>();


                            //Ticke#73404
                            if (astrdistributiontypecodevalue != "MNBF")
                            {
                                lclbTaxOptions.Add(lclbTaxOptionsForCA.Where(item => item.code_value == busConstant.FLAT_PERCENT).FirstOrDefault());
                            }

                            //Code Added Abhishek as per VIno's request for showing old option too in-case we need to end date 12/5/2012 
                            if (!this.iclbPayeeAccountTaxWithholding.IsNullOrEmpty())
                            {
                                if (this.iclbPayeeAccountTaxWithholding.Where(i => i.icdoPayeeAccountTaxWithholding.tax_identifier_value == busConstant.CA_STATE_TAX
                                                                                     || i.icdoPayeeAccountTaxWithholding.tax_identifier_value == busConstant.GA_STATE_TAX
                                                                                     || i.icdoPayeeAccountTaxWithholding.tax_identifier_value == busConstant.OR_STATE_TAX
                                                                                     || i.icdoPayeeAccountTaxWithholding.tax_identifier_value == busConstant.NC_STATE_TAX
                                                                                     || i.icdoPayeeAccountTaxWithholding.tax_identifier_value == busConstant.VA_STATE_TAX
                                                                             && i.icdoPayeeAccountTaxWithholding.tax_option_value != busConstant.FLAT_PERCENT && (i.icdoPayeeAccountTaxWithholding.end_date.IsNull()
                                                                             || i.icdoPayeeAccountTaxWithholding.end_date == DateTime.MinValue)).Count() > 0)
                                    lclbTaxOptions.Add(lclbTaxOptionsForCA.Where(item => item.code_value ==
                                                                                 this.iclbPayeeAccountTaxWithholding.Where(i => i.icdoPayeeAccountTaxWithholding.tax_identifier_value == busConstant.CA_STATE_TAX || i.icdoPayeeAccountTaxWithholding.tax_identifier_value == busConstant.GA_STATE_TAX
                                                                                                                                 || i.icdoPayeeAccountTaxWithholding.tax_identifier_value == busConstant.OR_STATE_TAX
                                                                                                                                 || i.icdoPayeeAccountTaxWithholding.tax_identifier_value == busConstant.NC_STATE_TAX
                                                                                                                                 || i.icdoPayeeAccountTaxWithholding.tax_identifier_value == busConstant.VA_STATE_TAX
                                                                                 && i.icdoPayeeAccountTaxWithholding.tax_option_value != busConstant.FLAT_PERCENT && (i.icdoPayeeAccountTaxWithholding.end_date.IsNull()
                                                                                 || i.icdoPayeeAccountTaxWithholding.end_date == DateTime.MinValue)).FirstOrDefault().icdoPayeeAccountTaxWithholding.tax_option_value).FirstOrDefault());
                            }
                            //After PIR 763
                            if (lclbTaxOptions.Where(item => item.code_value == busConstant.NO_STATE_TAX).Count() == 0)
                                lclbTaxOptions.Add(lclbTaxOptionsForCA.Where(item => item.code_value == busConstant.NO_STATE_TAX).FirstOrDefault());
                        }
                        // Retiree Increase Payee Account Taxwithholding Options
                        else if (this.icdoPayeeAccount.istrBenefitOption == busConstant.LUMP_SUM_DESCRIPTION && this.icdoPayeeAccount.retiree_incr_flag == busConstant.FLAG_YES)
                        {
                            lclbTaxOptions = doBase.GetCollection<cdoCodeValue>(ldtbResult);
                        }
                    }
                    else if (this.icdoPayeeAccount.istrBenefitOption == busConstant.LUMP_SUM_DESCRIPTION && (lclbTaxOptions == null || lclbTaxOptions.Count() == 0))
                    {
                        Collection<cdoCodeValue> lclbTaxOptionsForCA = new Collection<cdoCodeValue>();
                        lclbTaxOptionsForCA = doBase.GetCollection<cdoCodeValue>(ldtbResult);
                        lclbTaxOptions = new Collection<cdoCodeValue>();
                        //Ticke#73404
                        if (astrdistributiontypecodevalue != "MNBF")
                        {
                            lclbTaxOptions.Add(lclbTaxOptionsForCA.Where(item => item.code_value == busConstant.FLAT_PERCENT).FirstOrDefault());
                        }

                        //Code Added Abhishek as per VIno's request for showing old option too in-case we need to end date 12/5/2012 
                        if (!this.iclbPayeeAccountTaxWithholding.IsNullOrEmpty())
                        {
                            if (this.iclbPayeeAccountTaxWithholding.Where(i => i.icdoPayeeAccountTaxWithholding.tax_identifier_value == busConstant.FEDRAL_STATE_TAX
                                                                         && i.icdoPayeeAccountTaxWithholding.tax_option_value != busConstant.FLAT_PERCENT && (i.icdoPayeeAccountTaxWithholding.end_date.IsNull()
                                                                         || i.icdoPayeeAccountTaxWithholding.end_date == DateTime.MinValue)).Count() > 0)
                                lclbTaxOptions.Add(lclbTaxOptionsForCA.Where(item => item.code_value ==
                                                                             this.iclbPayeeAccountTaxWithholding.Where(i => i.icdoPayeeAccountTaxWithholding.tax_identifier_value == busConstant.FEDRAL_STATE_TAX
                                                                             && i.icdoPayeeAccountTaxWithholding.tax_option_value != busConstant.FLAT_PERCENT && (i.icdoPayeeAccountTaxWithholding.end_date.IsNull()
                                                                             || i.icdoPayeeAccountTaxWithholding.end_date == DateTime.MinValue)).FirstOrDefault().icdoPayeeAccountTaxWithholding.tax_option_value).FirstOrDefault());



                            if (lclbTaxOptions.Count > 0 && lclbTaxOptions[0] == null && this.iclbPayeeAccountTaxWithholding.Where(i => i.icdoPayeeAccountTaxWithholding.tax_identifier_value == busConstant.FEDRAL_STATE_TAX
                                                                             && i.icdoPayeeAccountTaxWithholding.tax_option_value != busConstant.FLAT_PERCENT && (i.icdoPayeeAccountTaxWithholding.end_date.IsNull()
                                                                             || i.icdoPayeeAccountTaxWithholding.end_date == DateTime.MinValue)).FirstOrDefault().icdoPayeeAccountTaxWithholding.tax_option_value == "FTIA")
                            {
                                lclbTaxOptions = new Collection<cdoCodeValue>();

                                lclbTaxOptions.Add(lclbTaxOptionsForCA.Where(item => item.code_value == busConstant.FEDRAL_TAX_IRS_TABLE).FirstOrDefault());
                                lclbTaxOptions.Add(lclbTaxOptionsForCA.Where(item => item.code_value == busConstant.NO_FEDRAL_TAX).FirstOrDefault());
                            }
                        }
                        if (this.icdoPayeeAccount.account_relation_value == busConstant.BenefitCalculation.ACCOUNT_RELATIONSHIP_BENEFICIARY
                            && this.icdoPayeeAccount.family_relation_value != busConstant.BENEFICIARY_RELATIONSHIP_SPOUSE)
                        {
                            lclbTaxOptions = new Collection<cdoCodeValue>();
                            //Ticke#73404
                            if (astrdistributiontypecodevalue != "MNBF")
                            {
                                lclbTaxOptions.Add(lclbTaxOptionsForCA.Where(item => item.code_value == busConstant.FLAT_PERCENT).FirstOrDefault());
                            }

                            lclbTaxOptions.Add(lclbTaxOptionsForCA.Where(item => item.code_value == busConstant.FLAT_DOLLAR).FirstOrDefault());
                            lclbTaxOptions.Add(lclbTaxOptionsForCA.Where(item => item.code_value == busConstant.NO_FEDRAL_TAX).FirstOrDefault());
                        }

                    }
                    // Retiree Increase Payee Account Taxwithholding Options
                    else if (this.icdoPayeeAccount.istrBenefitOption == busConstant.LUMP_SUM_DESCRIPTION && this.icdoPayeeAccount.retiree_incr_flag == busConstant.FLAG_YES)
                    {
                        lclbTaxOptions = doBase.GetCollection<cdoCodeValue>(ldtbResult);
                    }
                    else
                    {
                        lclbTaxOptions = doBase.GetCollection<cdoCodeValue>(ldtbResult);
                    }
                    LoadBreakDownDetails();

                    if (idecNextGrossPaymentACH <= 0)
                    {
                        if (iclbPayeeAccountRolloverDetail == null)
                        {
                            LoadPayeeAccountRolloverDetails();
                        }
                        if (iclbPayeeAccountRolloverDetail.Count() > 0)
                        {
                            Collection<cdoCodeValue> lclbTaxOptionsForCA = new Collection<cdoCodeValue>();
                            lclbTaxOptionsForCA = doBase.GetCollection<cdoCodeValue>(ldtbResult);
                            lclbTaxOptions = new Collection<cdoCodeValue>();
                            if (astrCodeValue == busConstant.CA_STATE_TAX || astrCodeValue == busConstant.GA_STATE_TAX || astrCodeValue == busConstant.OR_STATE_TAX || astrCodeValue == busConstant.NC_STATE_TAX || astrCodeValue == busConstant.VA_STATE_TAX)
                            {
                                //Ticke#73404
                                if (astrdistributiontypecodevalue != "MNBF")
                                {
                                    lclbTaxOptions.Add(lclbTaxOptionsForCA.Where(item => item.code_value == busConstant.FLAT_PERCENT).FirstOrDefault());
                                }

                                lclbTaxOptions.Add(lclbTaxOptionsForCA.Where(item => item.code_value == busConstant.NO_STATE_TAX).FirstOrDefault());
                            }
                            else
                            {
                                //Ticke#73404
                                if (astrdistributiontypecodevalue != "MNBF")
                                {
                                    lclbTaxOptions.Add(lclbTaxOptionsForCA.Where(item => item.code_value == busConstant.FLAT_PERCENT).FirstOrDefault());
                                }

                                lclbTaxOptions.Add(lclbTaxOptionsForCA.Where(item => item.code_value == busConstant.NO_FEDRAL_TAX).FirstOrDefault());
                            }
                        }
                    }
                }
                #region PROD PIR 173
                //if (astrCodeValue == busConstant.CA_STATE_TAX && (lclbTaxOptions.Where(item => item.code_value == busConstant.NO_STATE_TAX).Count() > 0 && this.iclbPayeeAccountTaxWithholding.Where(item => item.icdoPayeeAccountTaxWithholding.tax_option_value != busConstant.NO_STATE_TAX
                //                                                                                                                                         && item.icdoPayeeAccountTaxWithholding.tax_identifier_value == busConstant.CA_STATE_TAX
                //                                                                                                                                         && item.icdoPayeeAccountTaxWithholding.end_date == DateTime.MinValue).Count() > 0))
                //{
                //    Collection<cdoCodeValue> lclbTaxOptionsForCA = new Collection<cdoCodeValue>();
                //    lclbTaxOptionsForCA = doBase.GetCollection<cdoCodeValue>(ldtbResult);
                //    lclbTaxOptions.Add(lclbTaxOptionsForCA.Where(item => item.code_value ==
                //                         this.iclbPayeeAccountTaxWithholding.Where(i => i.icdoPayeeAccountTaxWithholding.tax_identifier_value == busConstant.CA_STATE_TAX
                //                         && (i.icdoPayeeAccountTaxWithholding.tax_option_value != busConstant.NO_STATE_TAX || i.icdoPayeeAccountTaxWithholding.tax_option_value != busConstant.FLAT_PERCENT)
                //                         && i.icdoPayeeAccountTaxWithholding.end_date == DateTime.MinValue).FirstOrDefault().icdoPayeeAccountTaxWithholding.tax_option_value).FirstOrDefault());
                //}
                #endregion

                #region PROD PIR 193


                if (!(lclbTaxOptions.Where(item => item != null && item.code_value != null && (item.code_value == busConstant.NO_FEDRAL_TAX ||
                                                                                               item.code_value == busConstant.NO_STATE_TAX)).Count() > 0))
                {
                    Collection<cdoCodeValue> lclbTaxOptionsForCA = new Collection<cdoCodeValue>();
                    lclbTaxOptionsForCA = doBase.GetCollection<cdoCodeValue>(ldtbResult);
                    if (astrCodeValue == busConstant.CA_STATE_TAX || astrCodeValue == busConstant.GA_STATE_TAX || astrCodeValue == busConstant.OR_STATE_TAX || astrCodeValue == busConstant.NC_STATE_TAX || astrCodeValue == busConstant.VA_STATE_TAX)

                        lclbTaxOptions.Add(lclbTaxOptionsForCA.Where(item => item.code_value == busConstant.NO_STATE_TAX).FirstOrDefault());
                    else
                        lclbTaxOptions.Add(lclbTaxOptionsForCA.Where(item => item.code_value == busConstant.NO_FEDRAL_TAX).FirstOrDefault());
                }



                #endregion

                //PIR 803
                #region For Retiree Increase Payee Accounts
                if (icdoPayeeAccount.retiree_incr_flag == busConstant.FLAG_YES)
                {
                    if (ldtbResult.IsNotNull() && ldtbResult.Rows.Count > 0)
                    {
                        lclbTaxOptions = doBase.GetCollection<cdoCodeValue>(ldtbResult);
                    }
                }
                #endregion
            }
            return lclbTaxOptions;
        }


        public bool CheckAnnuity()
        {
            if (this.icdoPayeeAccount.istrBenefitOption.IsNotNullOrEmpty())
            {
                if (this.icdoPayeeAccount.istrBenefitOption.Contains("Annuity"))
                {
                    return true;
                }
                else
                {
                    return false;
                }
            }
            return false;
        }


        //for PIR-829
        public bool CheckIfManagerLogin()
        {
            busUserRoles lbusUserRoles = new busUserRoles { icdoRoles = new cdoRoles() };
            if (lbusUserRoles.FindUserRoles(iobjPassInfo.iintUserSerialID, busConstant.Role.MANAGER_ROLE))
                return true;
            else
                return false;

        }

        public bool CheckIfStaff2Login()
        {
            busUserRoles lbusUserRoles = new busUserRoles { icdoRoles = new cdoRoles() };
            if (lbusUserRoles.FindUserRoles(iobjPassInfo.iintUserSerialID, busConstant.Role.STAFF_2))
                return true;
            else
                return false;

        }
        public ArrayList btn_RefreshCalculationClick()
        {
            ArrayList larrList = new ArrayList();
            if (icdoPayeeAccount.benefit_account_type_value == busConstant.BENEFIT_TYPE_RETIREMENT)
            {
                busPlanBenefitXr lbusPlanBenefitXr = new busPlanBenefitXr();
                lbusPlanBenefitXr.FindPlanBenefitXr(icdoPayeeAccount.plan_benefit_id);
                string lstrBenefitOption = lbusPlanBenefitXr.icdoPlanBenefitXr.benefit_option_value;
                ReCalculateBenefitForRetirement(lstrBenefitOption, ablnPostRetDeath: true, ablnRefreshCalculationFinal: true);
            }
            else if (icdoPayeeAccount.benefit_account_type_value == busConstant.BENEFIT_TYPE_DISABILITY)
            {
                busPlanBenefitXr lbusPlanBenefitXr = new busPlanBenefitXr();
                lbusPlanBenefitXr.FindPlanBenefitXr(icdoPayeeAccount.plan_benefit_id);
                string lstrBenefitOption = lbusPlanBenefitXr.icdoPlanBenefitXr.benefit_option_value;
                RecalculateParticipantDisabilityBenefits(lstrBenefitOption, ablnPostRetrDeath: true, ablnRefreshCalculationFinal: true);
            }

            larrList.Add(this);

            return larrList;
        }

        #region Code for Benefit Adjustments

        public ArrayList btn_ReCalculateBenefits()
        {
            ArrayList larrList = new ArrayList();
            utlError lobjError = new utlError();

            ReleaseWithholding();//PIR 990

            int lintParticipantHasPendingDRO = (int)DBFunction.DBExecuteScalar("cdoPayeeAccount.CheckIfParticipantHasPendingDRO", new object[1] { icdoPayeeAccount.person_id },

                iobjPassInfo.iconFramework, iobjPassInfo.itrnFramework);

            int lintParticipantDateOfDeath = (int)DBFunction.DBExecuteScalar("cdoPayeeAccount.CheckIfParticipantIsDead", new object[1] { ibusPayeeBenefitAccount.icdoPayeeBenefitAccount.person_id },
                                        iobjPassInfo.iconFramework, iobjPassInfo.itrnFramework);

            int lintPendingAdjCalcCount = (int)DBFunction.DBExecuteScalar("cdoBenefitCalculationHeader.GetCountofPendingAdjCalc",
                                                                            new object[3] { icdoPayeeAccount.person_id, icdoPayeeAccount.benefit_account_type_value, icdoPayeeAccount.iintPlanId },
                                                                            iobjPassInfo.iconFramework, iobjPassInfo.itrnFramework);

            //Pir 527-Soft Error
            if (lintParticipantHasPendingDRO > 0)
            {
                int lintrtn = DBFunction.DBNonQuery("cdoPayeeAccount.InsertPayeeAccountSoftErrors",
                        new object[3] { icdoPayeeAccount.person_id, 6062, iobjPassInfo.istrUserID },
                                      iobjPassInfo.iconFramework, iobjPassInfo.itrnFramework);

            }
            if (lintPendingAdjCalcCount > 0)
            {

                //10 Percent
                DBFunction.DBExecuteScalar("cdoBenefitCalculationHeader.CancelPendingAdjustmentCalculations",
                                                                            new object[3] { icdoPayeeAccount.benefit_account_type_value, icdoPayeeAccount.person_id, icdoPayeeAccount.iintPlanId },
                                                                            iobjPassInfo.iconFramework, iobjPassInfo.itrnFramework);

            }

            if (icdoPayeeAccount.benefit_account_type_value == busConstant.BENEFIT_TYPE_RETIREMENT)
            {
                busPlanBenefitXr lbusPlanBenefitXr = new busPlanBenefitXr();
                lbusPlanBenefitXr.FindPlanBenefitXr(icdoPayeeAccount.plan_benefit_id);
                string lstrBenefitOption = lbusPlanBenefitXr.icdoPlanBenefitXr.benefit_option_value;
                if (bConvertBenefitOptionToLife)  //RID 115034
                {
                    lstrBenefitOption = busConstant.LIFE;
                }

                busBenefitCalculationRetirement lbusBenefitCalculationRetirement = new busBenefitCalculationRetirement { icdoBenefitCalculationHeader = new cdoBenefitCalculationHeader() };

                //RE-MD PIR 815
                if (icdoPayeeAccount.retirement_type_value == busConstant.RETIREMENT_TYPE_MINIMUM_DISTRIBUTION)
                {
                    lbusBenefitCalculationRetirement = ReCalculateBenefitForRetirement(lstrBenefitOption, ablnReEvaluationMDBatch: true, ablnPostRetDeath: true);//ablnPostRetDeath it needs to be true, else it will attach the calculation with the payee account if there are hours after retirement.

                    if (lbusBenefitCalculationRetirement != null && lbusBenefitCalculationRetirement.iclbBenefitCalculationDetail != null && lbusBenefitCalculationRetirement.iclbBenefitCalculationDetail.Count > 0)
                    {
                        lbusBenefitCalculationRetirement.RecalculateMDBenefits(lbusBenefitCalculationRetirement, this);
                    }
                }
                else
                {
                    lbusBenefitCalculationRetirement = ReCalculateBenefitForRetirement(lstrBenefitOption, ablnPostRetDeath: true);//ablnPostRetDeath it needs to be true, else it will attach the calculation with the payee account if there are hours after retirement.

                    //10 Percent
                    if (icdoPayeeAccount.iintPlanId == busConstant.MPIPP_PLAN_ID && icdoPayeeAccount.retirement_type_value == busConstant.RETIREMENT_TYPE_LATE && lbusBenefitCalculationRetirement != null &&
                        lbusBenefitCalculationRetirement.iclbBenefitCalculationDetail != null && lbusBenefitCalculationRetirement.iclbBenefitCalculationDetail.Count > 0
                        && lbusBenefitCalculationRetirement.icdoBenefitCalculationHeader.age > busConstant.BenefitCalculation.AGE_70_HALF
                        && lbusBenefitCalculationRetirement.iclbBenefitCalculationDetail[0].iclbBenefitCalculationYearlyDetail != null
                        && lbusBenefitCalculationRetirement.iclbBenefitCalculationDetail[0].iclbBenefitCalculationYearlyDetail.Where(t => t.icdoBenefitCalculationYearlyDetail.reemployed_flag == busConstant.FLAG_YES).Count() <= 0)
                    {
                        lbusBenefitCalculationRetirement.RecalculateMDBenefits(lbusBenefitCalculationRetirement, this, ablnRetiree: true);
                    }
                    else
                    {
                        //  DateTime ldtMDdt = new DateTime(lbusBenefitCalculationRetirement.ibusBenefitApplication.ibusPerson.icdoPerson.date_of_birth.AddYears(70).AddMonths(6).Year + 1, 04, 01);
                        //                    ldtMinDistrubutionDate = busGlobalFunctions.GetMinDistributionDate(this.ibusPayee.icdoPerson.person_id, this.ibusBenefitCalculationHeader.iclbBenefitCalculationDetail.Select(i => i.icdoBenefitCalculationDetail.vested_date).FirstOrDefault());

                        DateTime ldtMDdt = new DateTime();
                        DateTime ldtVestedDate = new DateTime();
                        ldtVestedDate = busGlobalFunctions.GetVestedDate(icdoPayeeAccount.person_id, icdoPayeeAccount.iintPlanId);
                        ldtMDdt = busGlobalFunctions.GetMinDistributionDate(this.ibusPayee.icdoPerson.person_id, ldtVestedDate);

                        // RID# 153935 If Differ normal MD and retired before selected MD date, use Retirement date for adjustment.
                        int lintPersonId = this.ibusPayee.icdoPerson.person_id;
                        DateTime ldtDOB = this.ibusPayee.icdoPerson.date_of_birth;
                        DateTime ldtRetirementDate = lbusBenefitCalculationRetirement.icdoBenefitCalculationHeader.retirement_date;
                        DateTime ldtNormalMDDate = new DateTime();
                        DateTime ldtSelectedMDDate = new DateTime();
                        bool lblnMDDiffer = false;
                        ldtNormalMDDate = busGlobalFunctions.GetMinDistributionDate(ldtDOB, ldtVestedDate); //calculate MD date based on age 70.5
                        ldtSelectedMDDate = busGlobalFunctions.GetMinDistributionDate(lintPersonId, ldtVestedDate);  //calculate MD Date based on participant MD age option
                        lblnMDDiffer = ldtSelectedMDDate > ldtNormalMDDate;
                        //If participant had MD differ but retireed before Differed MD date, Retirement date should be used for calculating MD Adjustment factors.
                        if (lblnMDDiffer && ldtRetirementDate < ldtSelectedMDDate)
                        {
                            ldtMDdt = ldtRetirementDate;
                        }

                        if (ldtMDdt.Year <= DateTime.Now.Year && lbusBenefitCalculationRetirement.iclbBenefitCalculationDetail != null
                            && lbusBenefitCalculationRetirement.iclbBenefitCalculationDetail.Count > 0
                           && lbusBenefitCalculationRetirement.iclbBenefitCalculationDetail[0].iclbBenefitCalculationYearlyDetail
                           .Where(t => t.icdoBenefitCalculationYearlyDetail.reemployed_flag == busConstant.FLAG_YES && t.icdoBenefitCalculationYearlyDetail.plan_year >= ldtMDdt.Year).Count() > 0
                          )
                        {
                            lbusBenefitCalculationRetirement.iclbBenefitCalculationDetail[0].icdoBenefitCalculationDetail.istrBenefitOptionValue = lstrBenefitOption;
                            lbusBenefitCalculationRetirement.RecalculateMDBenefits(lbusBenefitCalculationRetirement, this, true);
                        }
                    }
                }

                if (lbusBenefitCalculationRetirement.icdoBenefitCalculationHeader.benefit_calculation_header_id == 0)
                {
                    lobjError = null;
                    lobjError = AddError(6159, "");
                    larrList.Add(lobjError);
                    return larrList;

                }
            }
            else if (icdoPayeeAccount.benefit_account_type_value == busConstant.BENEFIT_TYPE_DISABILITY)
            {
                busPlanBenefitXr lbusPlanBenefitXr = new busPlanBenefitXr();
                lbusPlanBenefitXr.FindPlanBenefitXr(icdoPayeeAccount.plan_benefit_id);
                string lstrBenefitOption = lbusPlanBenefitXr.icdoPlanBenefitXr.benefit_option_value;
                if (bConvertBenefitOptionToLife)  //RID 115034
                {
                    lstrBenefitOption = busConstant.LIFE;
                }
                //RequestID: 72091
                string lstrOriginalBenefitOption = this.icdoPayeeAccount.istrOriginalBenefitOptionValue;
                bool blnConvertBenOption = false;

                if ((lstrOriginalBenefitOption == busConstant.JOINT_100_PERCENT_POPUP_ANNUITY || lstrOriginalBenefitOption == busConstant.JOINT_75_PERCENT_POPUP_ANNUITY || lstrOriginalBenefitOption == busConstant.JOINT_50_PERCENT_POPUP_ANNUITY) && lstrBenefitOption == busConstant.LIFE)
                {
                    blnConvertBenOption = true;
                }

                busBenefitCalculationHeader lbusBenefitCalculationDisability = new busBenefitCalculationHeader();
                lbusBenefitCalculationDisability = RecalculateParticipantDisabilityBenefits(lstrBenefitOption, ablnConvertBenOption: blnConvertBenOption); //RequestID: 72091
                if (lbusBenefitCalculationDisability.icdoBenefitCalculationHeader.benefit_calculation_header_id == 0)
                {
                    lobjError = null;
                    lobjError = AddError(6159, "");
                    larrList.Add(lobjError);
                    return larrList;
                }
            }
            else if (icdoPayeeAccount.benefit_account_type_value == busConstant.BENEFIT_TYPE_DEATH_PRE_RETIREMENT)
            {
                busPlanBenefitXr lbusPlanBenefitXr = new busPlanBenefitXr();
                lbusPlanBenefitXr.FindPlanBenefitXr(icdoPayeeAccount.plan_benefit_id);
                string lstrBenefitOption = lbusPlanBenefitXr.icdoPlanBenefitXr.benefit_option_value;
                RecalculateSurvivorPreRetirementDeathBenefits(lstrBenefitOption);
            }
            else if (icdoPayeeAccount.benefit_account_type_value == busConstant.BENEFIT_TYPE_DEATH_POST_RETIREMENT)
            {
                ReCalculateBenefitForPostRetirement();
            }
            else if (icdoPayeeAccount.benefit_account_type_value == busConstant.BENEFIT_TYPE_WITHDRAWAL)
            {
                ReCalculateBenefitForWithdrawl();
            }
            else if (icdoPayeeAccount.benefit_account_type_value == busConstant.BENEFIT_TYPE_QDRO)
            {
                ReCalculateBenefitForQDRO(this);
            }
            larrList.Add(this);

            return larrList;
        }

        public busBenefitCalculationRetirement ReCalculateBenefitForRetirement(string astrBenefitOptionValue, DataTable adtReemployedHours = null, bool ablnReEvaluationMDBatch = false, bool lblnDoInsert = true, bool ablnRefreshCalculationFinal = false, bool ablnPostRetDeath = false, DateTime? adtBenefitEffectiveDate = null, bool ablnReemployed = false,
                                                                                       bool ablnConvertBenOption = false, string astrRetirementSubType = "")
        {
            FINAL_CALCULATION_ID = 0;
            FINAL_DRO_CALCULATION_ID = 0;

            busBenefitCalculationRetirement lbusBenefitCalculationRetirement =
               new busBenefitCalculationRetirement { icdoBenefitCalculationHeader = new cdoBenefitCalculationHeader() };
            busBenefitApplicationDetail lbusBenefitApplicationDetail = new busBenefitApplicationDetail();

            utlError lobjErr = new utlError();
            ArrayList larr = new ArrayList();

            if (lbusBenefitApplicationDetail.FindBenefitApplicationDetail(icdoPayeeAccount.benefit_application_detail_id))
            {
                int lintPersonAccountId = 0;
                lbusBenefitApplicationDetail.iintPlan_ID = this.icdoPayeeAccount.iintPlanId;
                #region Initialize Calculation Needed Objects from Application

                lbusBenefitCalculationRetirement.iintOriginalPayeeAccountId = this.icdoPayeeAccount.payee_account_id;
                lbusBenefitCalculationRetirement.ibusBenefitApplication = new busBenefitApplication();
                lbusBenefitCalculationRetirement.ibusBenefitApplication.FindBenefitApplication(lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.benefit_application_id);
                lbusBenefitCalculationRetirement.ibusPerson = new busPerson();
                lbusBenefitCalculationRetirement.ibusPerson.FindPerson(icdoPayeeAccount.person_id);
                lbusBenefitCalculationRetirement.ibusPerson.LoadPersonAccounts();

                this.ibusParticipant = lbusBenefitCalculationRetirement.ibusPerson;
                this.ibusParticipant.iclbPersonAccount = lbusBenefitCalculationRetirement.ibusPerson.iclbPersonAccount;
                if (this.ibusParticipant.iclbPersonAccount.Where(i => i.icdoPersonAccount.plan_id == this.icdoPayeeAccount.iintPlanId).Count() > 0 && astrRetirementSubType.IsNotNullOrEmpty())
                    this.ibusParticipant.iclbPersonAccount.Where(i => i.icdoPersonAccount.plan_id == this.icdoPayeeAccount.iintPlanId).FirstOrDefault().icdoPersonAccount.istrRetirementSubType = astrRetirementSubType;

                if (ablnReEvaluationMDBatch)
                {
                    DateTime ldtdate = new DateTime(DateTime.Now.Year, 1, 1);

                    if (lbusBenefitCalculationRetirement.ibusBenefitApplication.icdoBenefitApplication.retirement_date <= ldtdate) //Ticket - 69718
                        lbusBenefitCalculationRetirement.ibusBenefitApplication.icdoBenefitApplication.retirement_date = ldtdate;
                }
                else if (lbusBenefitCalculationRetirement.ibusBenefitApplication.icdoBenefitApplication.retirement_date.IsNotNull())
                {
                    lbusBenefitCalculationRetirement.ibusBenefitApplication.icdoBenefitApplication.retirement_date = lbusBenefitCalculationRetirement.ibusBenefitApplication.icdoBenefitApplication.retirement_date;
                    lbusBenefitCalculationRetirement.icdoBenefitCalculationHeader.retirement_date = lbusBenefitCalculationRetirement.ibusBenefitApplication.icdoBenefitApplication.retirement_date;
                }



                busPerson lbusSurvivourInfo = new busPerson();
                if (lbusSurvivourInfo.FindPerson(lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.joint_annuitant_id))
                {
                    lbusBenefitCalculationRetirement.icdoBenefitCalculationHeader.iintSurvivorAgeAtRetirement =
                                        busGlobalFunctions.CalculatePersonAgeInDec(lbusSurvivourInfo.icdoPerson.idtDateofBirth,
                                        lbusBenefitCalculationRetirement.ibusBenefitApplication.icdoBenefitApplication.retirement_date);

                    lbusBenefitCalculationRetirement.icdoBenefitCalculationHeader.istrSurvivorMPID = lbusSurvivourInfo.icdoPerson.mpi_person_id;
                    lbusBenefitCalculationRetirement.icdoBenefitCalculationHeader.beneficiary_person_id = lbusSurvivourInfo.icdoPerson.person_id;
                    //Min-Dist-Abhi
                }

                lbusBenefitCalculationRetirement.icdoBenefitCalculationHeader.age = busGlobalFunctions.CalculatePersonAgeInDec(this.ibusParticipant.icdoPerson.idtDateofBirth,
                                                                                       lbusBenefitCalculationRetirement.ibusBenefitApplication.icdoBenefitApplication.retirement_date);
                lbusBenefitCalculationRetirement.ibusBenefitApplication.ibusPerson = this.ibusParticipant;
                lbusBenefitCalculationRetirement.ibusBenefitApplication.ibusPerson.iclbPersonAccount = this.ibusParticipant.iclbPersonAccount;
                lbusBenefitCalculationRetirement.iclbBenefitCalculationDetail = new Collection<busBenefitCalculationDetail>();
                lbusBenefitCalculationRetirement.iclbPersonAccountRetirementContribution = new Collection<busPersonAccountRetirementContribution>();
                lbusBenefitCalculationRetirement.ibusBenefitApplication.idecAge = lbusBenefitCalculationRetirement.icdoBenefitCalculationHeader.age;
                lbusBenefitCalculationRetirement.ibusBenefitApplication.LoadandProcessWorkHistory_ForAllPlans();

                if (!lbusBenefitCalculationRetirement.ibusBenefitApplication.aclbPersonWorkHistory_MPI.IsNullOrEmpty() &&
                     lbusBenefitCalculationRetirement.ibusBenefitApplication.aclbPersonWorkHistory_MPI.Where(i => i.year == lbusBenefitCalculationRetirement.ibusBenefitApplication.icdoBenefitApplication.retirement_date.Year).Count() > 0 && ablnReEvaluationMDBatch)
                {
                    lbusBenefitCalculationRetirement.ibusBenefitApplication.aclbPersonWorkHistory_MPI.RemoveAt(lbusBenefitCalculationRetirement.ibusBenefitApplication.aclbPersonWorkHistory_MPI.IndexOf(lbusBenefitCalculationRetirement.ibusBenefitApplication.aclbPersonWorkHistory_MPI.Where(i => i.year == lbusBenefitCalculationRetirement.ibusBenefitApplication.icdoBenefitApplication.retirement_date.Year).FirstOrDefault()));
                }

                if (!lbusBenefitCalculationRetirement.ibusPerson.iclbPersonAccount.Where(item => item.icdoPersonAccount.plan_id == busConstant.MPIPP_PLAN_ID).IsNullOrEmpty())
                {
                    //PIR-619(to get ee contributions and interest)
                    busAnnualBenefitSummaryOverview lbusAnnualBenefitSummaryOverview = new busAnnualBenefitSummaryOverview();
                    if (lbusAnnualBenefitSummaryOverview.FindPerson(this.ibusParticipant.icdoPerson.person_id))
                    {
                        lbusAnnualBenefitSummaryOverview.LoadEEcontributions();
                        lbusAnnualBenefitSummaryOverview.btn_PostEEInterest();
                    }
                    lbusBenefitCalculationRetirement.LoadAllRetirementContributions(lbusBenefitCalculationRetirement.ibusPerson.iclbPersonAccount.Where(item => item.icdoPersonAccount.plan_id == busConstant.MPIPP_PLAN_ID).FirstOrDefault());
                }
                else
                {
                    lbusBenefitCalculationRetirement.LoadAllRetirementContributions(null);
                }

                //PIR 894
                if (ablnConvertBenOption)
                    lbusBenefitCalculationRetirement.ibusBenefitApplication.NotEligible = false;
                else
                    lbusBenefitCalculationRetirement.SetupPreRequisites_RetirementCalculations();

                #endregion
                if (!lbusBenefitCalculationRetirement.ibusBenefitApplication.NotEligible)
                {
                    #region Set header record

                    string lstrCalculationType = string.Empty;

                    if (ablnReEvaluationMDBatch)
                        lstrCalculationType = busConstant.BenefitCalculation.CALCULATION_TYPE_ADJUSTMENT;
                    else if (ablnRefreshCalculationFinal)
                        lstrCalculationType = busConstant.BenefitCalculation.CALCULATION_TYPE_FINAL;
                    else
                        lstrCalculationType = busConstant.BenefitCalculation.CALCULATION_TYPE_ADJUSTMENT;


                    if (icdoPayeeAccount.iintPlanId == busConstant.IAP_PLAN_ID)
                    {
                        lbusBenefitCalculationRetirement.iblnCalculateIAPBenefit = true;

                        lbusBenefitApplicationDetail.istrPlanCode = busConstant.IAP;
                        #region Setting Up Header for IAP

                        lbusBenefitCalculationRetirement.PopulateInitialDataBenefitCalculationHeader(this.ibusParticipant.icdoPerson.person_id,
                                                        lbusBenefitCalculationRetirement.ibusBenefitApplication.icdoBenefitApplication.benefit_application_id,
                                                        lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.joint_annuitant_id,
                                                         busConstant.BENEFIT_TYPE_RETIREMENT, lstrCalculationType,
                                                         lbusBenefitCalculationRetirement.ibusBenefitApplication.icdoBenefitApplication.retirement_date,
                                                         lbusBenefitCalculationRetirement.icdoBenefitCalculationHeader.age,
                                                         icdoPayeeAccount.iintPlanId, 0, 100, ablnReEvaluationMDBatch);
                        #endregion
                    }
                    else if (icdoPayeeAccount.iintPlanId == busConstant.MPIPP_PLAN_ID)
                    {

                        lbusBenefitCalculationRetirement.iblnCalculateMPIPPBenefit = true;
                        lbusBenefitApplicationDetail.istrPlanCode = busConstant.MPIPP;


                        lbusBenefitCalculationRetirement.PopulateInitialDataBenefitCalculationHeader(this.ibusParticipant.icdoPerson.person_id,
                                                            lbusBenefitCalculationRetirement.ibusBenefitApplication.icdoBenefitApplication.benefit_application_id,
                                                            lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.joint_annuitant_id,
                                                            busConstant.BENEFIT_TYPE_RETIREMENT, lstrCalculationType,
                                                            lbusBenefitCalculationRetirement.ibusBenefitApplication.icdoBenefitApplication.retirement_date,
                                                            lbusBenefitCalculationRetirement.icdoBenefitCalculationHeader.age,
                                                            icdoPayeeAccount.iintPlanId, 0, 100, ablnReEvaluationMDBatch);
                    }

                    else
                    {
                        #region Local Plans Found
                        if (lbusBenefitCalculationRetirement.ibusBenefitApplication.ibusPerson.iclbPersonAccount.Where(
                                                                    item => item.icdoPersonAccount.plan_id == icdoPayeeAccount.iintPlanId).Count() > 0)
                        {
                            lbusBenefitApplicationDetail.istrPlanCode = lbusBenefitCalculationRetirement.ibusBenefitApplication.ibusPerson.iclbPersonAccount.Where(
                                                                        item => item.icdoPersonAccount.plan_id == icdoPayeeAccount.iintPlanId).FirstOrDefault().icdoPersonAccount.istrPlanCode;

                            lbusBenefitCalculationRetirement.PopulateInitialDataBenefitCalculationHeader(this.ibusParticipant.icdoPerson.person_id,
                                                               lbusBenefitCalculationRetirement.ibusBenefitApplication.icdoBenefitApplication.benefit_application_id,
                                                               lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.joint_annuitant_id,
                                                               busConstant.BENEFIT_TYPE_RETIREMENT, lstrCalculationType,
                                                               lbusBenefitCalculationRetirement.ibusBenefitApplication.icdoBenefitApplication.retirement_date,
                                                               lbusBenefitCalculationRetirement.icdoBenefitCalculationHeader.age,
                                                               icdoPayeeAccount.iintPlanId, 0, 100, ablnReEvaluationMDBatch);
                        }
                        #endregion
                    }

                    #endregion

                    if (lbusBenefitCalculationRetirement.ibusBenefitApplication.CheckAlreadyVested(lbusBenefitApplicationDetail.istrPlanCode))
                    {
                        lintPersonAccountId = ibusParticipant.iclbPersonAccount.Where(item => item.icdoPersonAccount.istrPlanCode == lbusBenefitApplicationDetail.istrPlanCode).FirstOrDefault().icdoPersonAccount.person_account_id;

                        if (lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.istrBenefitOptionValue.IsNullOrEmpty() && lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.istrSubPlanBenefitOptionValue.IsNotNullOrEmpty())
                        {
                            lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.istrBenefitOptionValue = lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.istrSubPlanBenefitOptionValue;
                        }

                        //PIR 894
                        if (!ablnConvertBenOption && astrBenefitOptionValue == busConstant.LIFE && icdoPayeeAccount.istrOriginalBenefitOptionValue.IsNotNullOrEmpty())
                        {
                            ablnConvertBenOption = true;
                        }

                        if (ablnConvertBenOption && !ablnReEvaluationMDBatch)
                            lbusBenefitCalculationRetirement.SpawnFinalRetirementCalculation(lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.benefit_application_detail_id,
                                                                                             lintPersonAccountId, icdoPayeeAccount.iintPlanId, lbusBenefitApplicationDetail.istrPlanCode,
                                                                                             lbusBenefitCalculationRetirement.ibusBenefitApplication.ibusTempPersonAccountEligibility.icdoPersonAccountEligibility.vested_date,
                                                                                              astrRetirementSubType.IsNotNullOrEmpty() ? astrRetirementSubType : ibusParticipant.iclbPersonAccount.Where(plan => plan.icdoPersonAccount.istrPlanCode ==
                                                                                              lbusBenefitApplicationDetail.istrPlanCode).FirstOrDefault().icdoPersonAccount.istrRetirementSubType,
                                                                                              astrBenefitOptionValue, ablnReEvaluationMDBatch, ablnReemployed, ablnConvertBenOption: ablnConvertBenOption, astrOriginalBenefitOption: icdoPayeeAccount.istrOriginalBenefitOptionValue);//PIR 894
                        else if (ablnReEvaluationMDBatch)
                            lbusBenefitCalculationRetirement.SpawnFinalRetirementCalculation(lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.benefit_application_detail_id,
                                                                                         lintPersonAccountId, icdoPayeeAccount.iintPlanId, lbusBenefitApplicationDetail.istrPlanCode,
                                                                                         lbusBenefitCalculationRetirement.ibusBenefitApplication.ibusTempPersonAccountEligibility.icdoPersonAccountEligibility.vested_date,
                                                                                          busConstant.RETIREMENT_TYPE_MINIMUM_DISTRIBUTION, astrBenefitOptionValue, ablnReEvaluationMDBatch, ablnReemployed, ablnConvertBenOption: ablnConvertBenOption, astrOriginalBenefitOption: icdoPayeeAccount.istrOriginalBenefitOptionValue);
                        else
                            lbusBenefitCalculationRetirement.SpawnFinalRetirementCalculation(lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.benefit_application_detail_id,
                                                                                         lintPersonAccountId, icdoPayeeAccount.iintPlanId, lbusBenefitApplicationDetail.istrPlanCode,
                                                                                         lbusBenefitCalculationRetirement.ibusBenefitApplication.ibusTempPersonAccountEligibility.icdoPersonAccountEligibility.vested_date,
                                                                                         ibusParticipant.iclbPersonAccount.Where(plan => plan.icdoPersonAccount.istrPlanCode ==
                                                                                         lbusBenefitApplicationDetail.istrPlanCode).FirstOrDefault().icdoPersonAccount.istrRetirementSubType
                                                                                         , astrBenefitOptionValue, ablnReEvaluationMDBatch, ablnReemployed, this.icdoPayeeAccount.adjustment_payment_eligible_flag);


                        //10 Percent
                        //Ticket# 68700
                        if ((lbusBenefitApplicationDetail.iintPlan_ID != busConstant.IAP_PLAN_ID && astrBenefitOptionValue == busConstant.LUMP_SUM &&
                            lbusBenefitCalculationRetirement.icdoBenefitCalculationHeader.calculation_type_value == busConstant.BenefitCalculation.CALCULATION_TYPE_ADJUSTMENT &&
                            lbusBenefitCalculationRetirement.iclbBenefitCalculationDetail != null && lbusBenefitCalculationRetirement.iclbBenefitCalculationDetail.Count() > 0
                            && lbusBenefitCalculationRetirement.iclbBenefitCalculationDetail[0].icdoBenefitCalculationDetail.ee_flag != busConstant.FLAG_YES &&
                            lbusBenefitCalculationRetirement.iclbBenefitCalculationDetail[0].icdoBenefitCalculationDetail.uvhp_flag != busConstant.FLAG_YES
                            && lbusBenefitCalculationRetirement.iclbBenefitCalculationDetail[0].iclbBenefitCalculationOptions != null && lbusBenefitCalculationRetirement.iclbBenefitCalculationDetail[0].iclbBenefitCalculationOptions.Count() > 0)
                            || (lbusBenefitApplicationDetail.iintPlan_ID == busConstant.IAP_PLAN_ID))
                        {
                            //Ticket# 68700
                            if (lbusBenefitCalculationRetirement.iclbBenefitCalculationDetail.Count > 0)
                            {
                                if (lbusBenefitCalculationRetirement.iclbBenefitCalculationDetail[0].iclbBenefitCalculationOptions.Count > 0)
                                {
                                    lbusBenefitCalculationRetirement.iclbBenefitCalculationDetail[0].iclbBenefitCalculationOptions[0].icdoBenefitCalculationOptions.paid_amount = idecPaidGrossAmount;

                                }

                            }


                        }

                        //Rohan RE-MD PIR 815
                        if (lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.benefit_subtype_value != busConstant.RETIREMENT_TYPE_MINIMUM_DISTRIBUTION && lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.benefit_subtype_value != ibusParticipant.iclbPersonAccount.Where(plan => plan.icdoPersonAccount.istrPlanCode ==
                                                                                     lbusBenefitApplicationDetail.istrPlanCode).FirstOrDefault().icdoPersonAccount.istrRetirementSubType)
                        {
                            lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.benefit_subtype_value = ibusParticipant.iclbPersonAccount.Where(plan => plan.icdoPersonAccount.istrPlanCode ==
                                                                                         lbusBenefitApplicationDetail.istrPlanCode).FirstOrDefault().icdoPersonAccount.istrRetirementSubType;

                            lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.Update();

                        }

                        if (!ablnReEvaluationMDBatch)
                        {
                            if (this.idtNextBenefitPaymentDate == DateTime.MinValue)
                                this.LoadNextBenefitPaymentDate();
                            decimal ldecParticiantAge = busGlobalFunctions.CalculatePersonAge(this.ibusPayee.icdoPerson.date_of_birth, this.idtNextBenefitPaymentDate);
                            if (ldecParticiantAge >= 65 && (icdoPayeeAccount.iintPlanId == 1 || icdoPayeeAccount.iintPlanId == 2))
                            {
                                //Only If hours after retirement won't be called from MD : participant not yet retired.
                                lbusBenefitCalculationRetirement = GetFinalCalculationForReEmployedParticipants(adtReemployedHours, lbusBenefitCalculationRetirement, lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.istrBenefitOptionValue, ablnPostRetDeath, ablnReemployed);
                            }
                        }
                    }

                    try
                    {
                        if (lblnDoInsert || ablnReEvaluationMDBatch)
                        {
                            lbusBenefitCalculationRetirement.icdoBenefitCalculationHeader.Insert();
                            lbusBenefitCalculationRetirement.AfterPersistChanges();
                        }

                        if (this.ibusBaseActivityInstance.IsNotNull())
                        {
                            FINAL_CALCULATION_ID = lbusBenefitCalculationRetirement.icdoBenefitCalculationHeader.benefit_calculation_header_id;
                            this.SetProcessInstanceParameters();
                        }
                    }
                    catch
                    {
                    }
                }
            }
            return lbusBenefitCalculationRetirement;
        }

        private busBenefitCalculationHeader ReCalculateBenefitForWithdrawl(bool lblnDoInsert = true, bool ablnRefreshCalculationFinal = false)
        {
            FINAL_CALCULATION_ID = 0;
            FINAL_DRO_CALCULATION_ID = 0;

            busBenefitCalculationWithdrawal lbusBenefitCalculationWithdrawal = new busBenefitCalculationWithdrawal { icdoBenefitCalculationHeader = new cdoBenefitCalculationHeader() };
            busBenefitApplicationDetail lbusBenefitApplicationDetail = new busBenefitApplicationDetail();
            int lintPersonAccountId = 0;

            if (lbusBenefitApplicationDetail.FindBenefitApplicationDetail(icdoPayeeAccount.benefit_application_detail_id))
            {
                lbusBenefitCalculationWithdrawal.ibusBenefitApplication = new busBenefitApplication();
                lbusBenefitCalculationWithdrawal.ibusBenefitApplication.FindBenefitApplication(lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.benefit_application_id);

                busPlanBenefitXr lbusPlanBenefitXr = new busPlanBenefitXr();
                lbusPlanBenefitXr.FindPlanBenefitXr(lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.plan_benefit_id);
                lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.istrBenefitOptionValue = lbusPlanBenefitXr.icdoPlanBenefitXr.benefit_option_value;

                string lstrCalculationType = string.Empty;
                if (ablnRefreshCalculationFinal)
                {
                    lstrCalculationType = busConstant.BenefitCalculation.CALCULATION_TYPE_FINAL;
                }
                else
                {
                    lstrCalculationType = busConstant.BenefitCalculation.CALCULATION_TYPE_ADJUSTMENT;
                }

                //534- TUSHAR, iblnCalculateIAPBenefit flag should be set here
                if (icdoPayeeAccount.iintPlanId == busConstant.IAP_PLAN_ID)
                {
                    //Check there will be diffferent payee accounts , but header is same.
                    #region IAP
                    if (lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.l161_spl_acc_flag != busConstant.Flag_Yes &&
                        lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.l52_spl_acc_flag != busConstant.Flag_Yes)
                    {
                        lbusBenefitCalculationWithdrawal.iblnCalculateIAPBenefit = true;
                    }
                    #endregion

                    #region IAP_SpecialAccounts
                    if (lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.l161_spl_acc_flag == busConstant.Flag_Yes)
                    {
                        lbusBenefitCalculationWithdrawal.iblnCalculateL161SplAccBenefit = true;
                    }
                    if (lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.l52_spl_acc_flag == busConstant.Flag_Yes)
                    {
                        lbusBenefitCalculationWithdrawal.iblnCalculateL52SplAccBenefit = true;
                    }
                    #endregion
                }
                if (lbusBenefitCalculationWithdrawal.ibusBenefitApplication.icdoBenefitApplication.dro_application_id > 0)
                {
                    //Ticket #100420 --START
                    int dro_application_id = lbusBenefitCalculationWithdrawal.ibusBenefitApplication.icdoBenefitApplication.dro_application_id;
                    lbusBenefitCalculationWithdrawal.ibusQdroApplication = new busQdroApplication();
                    lbusBenefitCalculationWithdrawal.ibusQdroApplication.FindQdroApplication(dro_application_id);
                    lbusBenefitCalculationWithdrawal.ibusQdroApplication.LoadAllBenefitDetails();
                    lbusBenefitCalculationWithdrawal.ibusQdroApplication.LoadBenefitDetails();
                    int alternate_payee_id = lbusBenefitCalculationWithdrawal.ibusBenefitApplication.icdoBenefitApplication.alternate_payee_id;
                    if (alternate_payee_id.IsNotNull())
                    {
                        lbusBenefitCalculationWithdrawal.ibusQdroApplication.ibusAlternatePayee = new busPerson();
                        lbusBenefitCalculationWithdrawal.ibusQdroApplication.ibusAlternatePayee.FindPerson(alternate_payee_id);
                    }
                    lbusBenefitCalculationWithdrawal.ibusQdroApplication.ibusParticipant = this.ibusParticipant;
                    lbusBenefitCalculationWithdrawal.ibusPerson = this.ibusParticipant;
                    //Ticket #100420 --END
                    lbusBenefitCalculationWithdrawal.ibusPerson.LoadPersonAccounts();
                    lbusBenefitCalculationWithdrawal.icdoBenefitCalculationHeader.age = busGlobalFunctions.CalculatePersonAgeInDec(lbusBenefitCalculationWithdrawal.ibusQdroApplication.ibusParticipant.icdoPerson.idtDateofBirth,
                                                                                        lbusBenefitCalculationWithdrawal.ibusBenefitApplication.icdoBenefitApplication.retirement_date);
                    lbusBenefitCalculationWithdrawal.ibusBenefitApplication.ibusPerson = lbusBenefitCalculationWithdrawal.ibusQdroApplication.ibusParticipant;
                    lbusBenefitCalculationWithdrawal.ibusBenefitApplication.ibusPerson.iclbPersonAccount = lbusBenefitCalculationWithdrawal.ibusQdroApplication.ibusParticipant.iclbPersonAccount;
                    lbusBenefitCalculationWithdrawal.iclbBenefitCalculationDetail = new Collection<busBenefitCalculationDetail>();
                    lbusBenefitCalculationWithdrawal.iclbPersonAccountRetirementContribution = new Collection<busPersonAccountRetirementContribution>();
                    lbusBenefitCalculationWithdrawal.ibusBenefitApplication.idecAge = lbusBenefitCalculationWithdrawal.icdoBenefitCalculationHeader.age;
                    lbusBenefitCalculationWithdrawal.ibusBenefitApplication.LoadandProcessWorkHistory_ForAllPlans();

                    if (!lbusBenefitCalculationWithdrawal.ibusQdroApplication.ibusParticipant.iclbPersonAccount.Where(item => item.icdoPersonAccount.plan_id == busConstant.MPIPP_PLAN_ID).IsNullOrEmpty())
                    {
                        lbusBenefitCalculationWithdrawal.LoadAllRetirementContributions(lbusBenefitCalculationWithdrawal.ibusQdroApplication.ibusParticipant.iclbPersonAccount.Where(item => item.icdoPersonAccount.plan_id == busConstant.MPIPP_PLAN_ID).FirstOrDefault());
                    }
                    else
                    {
                        lbusBenefitCalculationWithdrawal.LoadAllRetirementContributions(null);
                    }

                    if (icdoPayeeAccount.iintPlanId == busConstant.IAP_PLAN_ID)
                    {
                        lbusBenefitApplicationDetail.istrPlanCode = busConstant.IAP;

                        #region IAP PLAN FOUND IN GRID

                        if (lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.l52_spl_acc_flag == busConstant.FLAG_YES)
                        {
                            lbusBenefitCalculationWithdrawal.iblnCalculateL52SplAccBenefit = true;
                        }

                        else if (lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.l161_spl_acc_flag == busConstant.FLAG_YES)
                        {
                            lbusBenefitCalculationWithdrawal.iblnCalculateL161SplAccBenefit = true;
                        }



                        #region Setting Up Header for IAP
                        //Ticket #100420
                        lbusBenefitCalculationWithdrawal.PopulateInitialDataBenefitCalculationHeader(this.ibusPayee.icdoPerson.person_id,
                                        lbusBenefitCalculationWithdrawal.ibusBenefitApplication.icdoBenefitApplication.benefit_application_id,
                                        lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.joint_annuitant_id,
                                        busConstant.BENEFIT_TYPE_WITHDRAWAL, lstrCalculationType,
                                        lbusBenefitCalculationWithdrawal.ibusBenefitApplication.icdoBenefitApplication.withdrawal_date,
                                         lbusBenefitCalculationWithdrawal.ibusBenefitApplication.idecAge, icdoPayeeAccount.iintPlanId);
                        #endregion

                        #endregion
                    }
                    else if (icdoPayeeAccount.iintPlanId == busConstant.MPIPP_PLAN_ID)
                    {
                        lbusBenefitApplicationDetail.istrPlanCode = busConstant.MPIPP;
                        #region MPIPP PLAN FOUNd in GRID

                        if (lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.uvhp_flag == busConstant.FLAG_YES)
                        {
                            lbusBenefitCalculationWithdrawal.iblnCalcualteUVHPBenefit = true;
                        }
                        else if (lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.ee_flag == busConstant.FLAG_YES)
                        {
                            lbusBenefitCalculationWithdrawal.iblnCalcualteNonVestedEEBenefit = true;
                        }

                        #region Setting Up Header for IAP

                        lbusBenefitCalculationWithdrawal.PopulateInitialDataBenefitCalculationHeader(this.ibusParticipant.icdoPerson.person_id,
                                        lbusBenefitCalculationWithdrawal.ibusBenefitApplication.icdoBenefitApplication.benefit_application_id,
                                        lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.joint_annuitant_id,
                                        busConstant.BENEFIT_TYPE_WITHDRAWAL, lstrCalculationType,
                                        lbusBenefitCalculationWithdrawal.ibusBenefitApplication.icdoBenefitApplication.withdrawal_date,
                                         lbusBenefitCalculationWithdrawal.ibusBenefitApplication.idecAge, icdoPayeeAccount.iintPlanId);
                        #endregion

                        #endregion
                    }

                    lintPersonAccountId = lbusBenefitCalculationWithdrawal.ibusQdroApplication.ibusParticipant.iclbPersonAccount.Where(item => item.icdoPersonAccount.istrPlanCode == lbusBenefitApplicationDetail.istrPlanCode).FirstOrDefault().icdoPersonAccount.person_account_id;
                    lbusBenefitCalculationWithdrawal.SpawnFinalWithdrawalCalculationForAlternatePayee(lbusBenefitCalculationWithdrawal.ibusQdroApplication, lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.benefit_application_detail_id,
                                                                                    lintPersonAccountId, icdoPayeeAccount.iintPlanId, lbusBenefitApplicationDetail.istrPlanCode,
                                                                                    lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.istrBenefitOptionValue,
                                                                                     lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.dro_model_value);
                }
                else
                {
                    lbusBenefitCalculationWithdrawal.ibusPerson = this.ibusParticipant;
                    lbusBenefitCalculationWithdrawal.ibusPerson.LoadPersonAccounts();
                    lbusBenefitCalculationWithdrawal.icdoBenefitCalculationHeader.age = busGlobalFunctions.CalculatePersonAgeInDec(this.ibusParticipant.icdoPerson.idtDateofBirth,
                                                                                        lbusBenefitCalculationWithdrawal.ibusBenefitApplication.icdoBenefitApplication.retirement_date);
                    lbusBenefitCalculationWithdrawal.ibusBenefitApplication.ibusPerson = this.ibusParticipant;
                    lbusBenefitCalculationWithdrawal.ibusBenefitApplication.ibusPerson.iclbPersonAccount = lbusBenefitCalculationWithdrawal.ibusPerson.iclbPersonAccount;
                    lbusBenefitCalculationWithdrawal.iclbBenefitCalculationDetail = new Collection<busBenefitCalculationDetail>();
                    lbusBenefitCalculationWithdrawal.iclbPersonAccountRetirementContribution = new Collection<busPersonAccountRetirementContribution>();
                    lbusBenefitCalculationWithdrawal.ibusBenefitApplication.idecAge = lbusBenefitCalculationWithdrawal.icdoBenefitCalculationHeader.age;
                    lbusBenefitCalculationWithdrawal.ibusBenefitApplication.LoadandProcessWorkHistory_ForAllPlans();

                    if (!lbusBenefitCalculationWithdrawal.ibusPerson.iclbPersonAccount.Where(item => item.icdoPersonAccount.plan_id == busConstant.MPIPP_PLAN_ID).IsNullOrEmpty())
                    {
                        lbusBenefitCalculationWithdrawal.LoadAllRetirementContributions(lbusBenefitCalculationWithdrawal.ibusPerson.iclbPersonAccount.Where(item => item.icdoPersonAccount.plan_id == busConstant.MPIPP_PLAN_ID).FirstOrDefault());
                    }
                    else
                    {
                        lbusBenefitCalculationWithdrawal.LoadAllRetirementContributions(null);
                    }

                    if (icdoPayeeAccount.iintPlanId == busConstant.IAP_PLAN_ID)
                    {
                        lbusBenefitApplicationDetail.istrPlanCode = busConstant.IAP;

                        #region IAP PLAN FOUND IN GRID

                        if (lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.l52_spl_acc_flag == busConstant.FLAG_YES)
                        {
                            lbusBenefitCalculationWithdrawal.iblnCalculateL52SplAccBenefit = true;
                        }
                        else if (lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.l161_spl_acc_flag == busConstant.FLAG_YES)
                        {
                            lbusBenefitCalculationWithdrawal.iblnCalculateL161SplAccBenefit = true;
                        }

                        #region Setting Up Header for IAP

                        lbusBenefitCalculationWithdrawal.PopulateInitialDataBenefitCalculationHeader(lbusBenefitCalculationWithdrawal.ibusPerson.icdoPerson.person_id,
                                                    lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.benefit_application_id,
                                                    lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.joint_annuitant_id,
                                                        busConstant.BENEFIT_TYPE_WITHDRAWAL, lstrCalculationType,
                                                        lbusBenefitCalculationWithdrawal.ibusBenefitApplication.icdoBenefitApplication.withdrawal_date,
                                                        lbusBenefitCalculationWithdrawal.ibusBenefitApplication.idecAge, icdoPayeeAccount.iintPlanId);
                        #endregion

                        #endregion
                    }

                    else if (icdoPayeeAccount.iintPlanId == busConstant.MPIPP_PLAN_ID)
                    {
                        lbusBenefitApplicationDetail.istrPlanCode = busConstant.MPIPP;

                        #region MPIPP PLAN FOUNd in GRID

                        if (lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.ee_flag == busConstant.FLAG_YES ||
                                 lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.uvhp_flag == busConstant.FLAG_YES)
                        {
                            lbusBenefitCalculationWithdrawal.iblnCalcualteUVHPBenefit = true;
                            lbusBenefitCalculationWithdrawal.iblnCalcualteNonVestedEEBenefit = true;
                        }

                        #region Setting Up Header for MPIPP

                        lbusBenefitCalculationWithdrawal.PopulateInitialDataBenefitCalculationHeader(lbusBenefitCalculationWithdrawal.ibusPerson.icdoPerson.person_id,
                                                        lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.benefit_application_id,
                                                        lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.joint_annuitant_id,
                                                         busConstant.BENEFIT_TYPE_WITHDRAWAL, lstrCalculationType,
                                                         lbusBenefitCalculationWithdrawal.ibusBenefitApplication.icdoBenefitApplication.withdrawal_date,
                                                         lbusBenefitCalculationWithdrawal.ibusBenefitApplication.idecAge, icdoPayeeAccount.iintPlanId);
                        #endregion

                        #endregion
                    }

                    lintPersonAccountId = lbusBenefitCalculationWithdrawal.ibusPerson.iclbPersonAccount.Where(
                        item => item.icdoPersonAccount.istrPlanCode == lbusBenefitApplicationDetail.istrPlanCode).FirstOrDefault().icdoPersonAccount.person_account_id;

                    if (icdoPayeeAccount.iintPlanId == busConstant.MPIPP_PLAN_ID)
                    {
                        CalculateAndPostUVHPPartialInterest(lintPersonAccountId, lbusBenefitCalculationWithdrawal.icdoBenefitCalculationHeader.benefit_calculation_header_id,
                                        lbusBenefitCalculationWithdrawal.ibusBenefitApplication.icdoBenefitApplication.withdrawal_date);
                    }

                    lbusBenefitCalculationWithdrawal.SpawnFinalWithdrawalCalculation(lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.benefit_application_detail_id,
                                                     lintPersonAccountId, icdoPayeeAccount.iintPlanId, lbusBenefitApplicationDetail.istrPlanCode,
                                                     lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.istrBenefitOptionValue, astrAdjustmentFlag: this.icdoPayeeAccount.adjustment_payment_eligible_flag);
                }

                try
                {
                    if (lblnDoInsert)
                    {
                        lbusBenefitCalculationWithdrawal.icdoBenefitCalculationHeader.Insert();
                        lbusBenefitCalculationWithdrawal.AfterPersistChanges();
                    }

                    if (this.ibusBaseActivityInstance.IsNotNull())
                    {
                        FINAL_CALCULATION_ID = lbusBenefitCalculationWithdrawal.icdoBenefitCalculationHeader.benefit_calculation_header_id;
                        this.SetProcessInstanceParameters();
                    }

                }
                catch
                {
                }


            }
            return lbusBenefitCalculationWithdrawal;
        }

        //10 Percent 2017
        public busQdroCalculationHeader ReCalculateBenefitForQDRO(busPayeeAccount abusAlternatePayeeAccount, busPayeeAccount abusParticipantPayeeAccount = null, bool ablnRefreshCalculationFinal = false)
        {
            FINAL_CALCULATION_ID = 0;
            FINAL_DRO_CALCULATION_ID = 0;
            bool lblnParticipantPayeeAccount = false;
            decimal ldecParticipantAmount = 0M;

            busQdroCalculationHeader lbusQdroCalculationHeader =
               new busQdroCalculationHeader { icdoQdroCalculationHeader = new cdoQdroCalculationHeader() };
            busDroBenefitDetails lbusDroBenefitDetails = new busDroBenefitDetails();

            string lstrCalculationType = string.Empty;
            if (ablnRefreshCalculationFinal)
            {
                lstrCalculationType = busConstant.BenefitCalculation.CALCULATION_TYPE_FINAL;
            }
            else
            {
                lstrCalculationType = busConstant.BenefitCalculation.CALCULATION_TYPE_ADJUSTMENT;
            }

            if (lbusDroBenefitDetails.FindDroBenefitDetails(abusAlternatePayeeAccount.icdoPayeeAccount.dro_application_detail_id))
            {
                #region Initialize Calculation Needed Objects from Application
                lbusQdroCalculationHeader.ibusBenefitApplication = new busBenefitApplication { icdoBenefitApplication = new cdoBenefitApplication() };
                lbusQdroCalculationHeader.ibusQdroApplication = new busQdroApplication();
                lbusQdroCalculationHeader.ibusQdroApplication.FindQdroApplication(lbusDroBenefitDetails.icdoDroBenefitDetails.dro_application_id);

                abusAlternatePayeeAccount.ibusParticipant = new busPerson();
                abusAlternatePayeeAccount.ibusParticipant.FindPerson(lbusQdroCalculationHeader.ibusQdroApplication.icdoDroApplication.person_id);

                abusAlternatePayeeAccount.ibusPayee = new busPerson();
                abusAlternatePayeeAccount.ibusPayee.FindPerson(lbusQdroCalculationHeader.ibusQdroApplication.icdoDroApplication.alternate_payee_id);

                lbusQdroCalculationHeader.ibusQdroApplication.iclbDroBenefitDetails = new Collection<busDroBenefitDetails>();
                lbusQdroCalculationHeader.ibusQdroApplication.LoadBenefitDetails();
                //Need to set this value since QDRO calculation requires iclbDroBenefitDetails collection
                lbusQdroCalculationHeader.ibusQdroApplication.iclbDroBenefitDetails =
                    lbusQdroCalculationHeader.ibusQdroApplication.iclbDroBenefitDetails.Where(item => item.icdoDroBenefitDetails.dro_benefit_id ==
                    lbusDroBenefitDetails.icdoDroBenefitDetails.dro_benefit_id).ToList().ToCollection();

                #endregion

                #region CHECK IF POST RETIREMENT QDRO
                if (lbusDroBenefitDetails.icdoDroBenefitDetails.dro_model_value == busConstant.DRO_MODEL_VALUE_STANDARD_RETIREE_FORMULA)
                {
                    if (abusParticipantPayeeAccount == null)
                    {
                        DataTable ldtblPayeeAccounts = busBase.Select("cdoDroApplication.GetParticipantsPayeeAccountForGivenPlan", new object[] { lbusQdroCalculationHeader.ibusQdroApplication.icdoDroApplication.person_id, icdoPayeeAccount.iintPlanId });

                        if (ldtblPayeeAccounts != null && ldtblPayeeAccounts.Rows.Count > 0)
                        {
                            abusParticipantPayeeAccount = new busPayeeAccount { icdoPayeeAccount = new cdoPayeeAccount() };
                            abusParticipantPayeeAccount.icdoPayeeAccount.LoadData(ldtblPayeeAccounts.Rows[0]);
                        }
                    }

                    if (abusParticipantPayeeAccount != null)
                    {
                        lblnParticipantPayeeAccount = busConstant.BOOL_TRUE;
                        abusParticipantPayeeAccount.LoadBenefitDetails();
                        abusParticipantPayeeAccount.LoadNextBenefitPaymentDate();
                        DataTable ldtblParticipantAmount = busBase.Select("cdoQdroCalculationHeader.GetBenefitAmount", new object[] { abusParticipantPayeeAccount.icdoPayeeAccount.payee_account_id,
                                        idtNextBenefitPaymentDate});
                        if (ldtblParticipantAmount.Rows.Count > 0)
                        {
                            ldecParticipantAmount = Convert.ToDecimal(ldtblParticipantAmount.Rows[0][0]);
                        }
                    }
                }

                if (lblnParticipantPayeeAccount)
                {
                    lbusQdroCalculationHeader.iblnParticipantPayeeAccount = lblnParticipantPayeeAccount;
                    lbusQdroCalculationHeader.idecParticipantAmount = ldecParticipantAmount;
                    lbusQdroCalculationHeader.iclbParticipantsPayeeAccount = new Collection<busPayeeAccount>();
                    lbusQdroCalculationHeader.iclbParticipantsPayeeAccount.Add(abusParticipantPayeeAccount);
                }

                #endregion

                #region ReCalculate DRO
                decimal ldecTaxableAmount = decimal.Zero;
                decimal ldecNonTaxableAmount = decimal.Zero;
                //10 Percent
                RecalculateDRO(lbusQdroCalculationHeader, abusAlternatePayeeAccount, lbusDroBenefitDetails, lstrCalculationType, lblnParticipantPayeeAccount, true, ref ldecTaxableAmount, ref ldecNonTaxableAmount);
                #endregion

            }

            return lbusQdroCalculationHeader;
        }

        //ablnUpdatePayeeAcc ablnUpdatePayeeAcc : will be set to true from reemplyment : reevaluation batch is ran & AP' benefits are already resumed
        public busQdroCalculationHeader RecalculateDRO(busQdroCalculationHeader abusQdroCalculationHeader, busPayeeAccount abusQDROPayeeAccount, busDroBenefitDetails abusDroBenefitDetails, string astrCalculationType, bool ablnSharedInterestDRO, bool ablnInsertInDb, ref decimal adecTaxableAmount, ref decimal adecNonTaxableAmount, DateTime? adtAccruedAsOfDate = null, bool ablnUpdatePayeeAcc = false)
        {
            busPlanBenefitXr lbusPlanBenefitXr = new busPlanBenefitXr();

            #region Load Calculation Parameters

            abusQdroCalculationHeader.ibusBenefitApplication.icdoBenefitApplication.retirement_date = abusQdroCalculationHeader.ibusQdroApplication.icdoDroApplication.dro_commencement_date;
            abusQdroCalculationHeader.ibusParticipant = abusQDROPayeeAccount.ibusParticipant;
            abusQdroCalculationHeader.ibusAlternatePayee = abusQDROPayeeAccount.ibusPayee;
            abusQdroCalculationHeader.ibusParticipant.LoadPersonAccounts();
            abusQdroCalculationHeader.icdoQdroCalculationHeader.age = busGlobalFunctions.CalculatePersonAgeInDec(abusQDROPayeeAccount.ibusParticipant.icdoPerson.idtDateofBirth,
                                                                                abusQdroCalculationHeader.ibusBenefitApplication.icdoBenefitApplication.retirement_date);
            abusQdroCalculationHeader.ibusBenefitApplication.ibusPerson = abusQDROPayeeAccount.ibusParticipant;
            abusQdroCalculationHeader.ibusBenefitApplication.ibusPerson.iclbPersonAccount = abusQdroCalculationHeader.ibusParticipant.iclbPersonAccount;
            abusQdroCalculationHeader.iclbQdroCalculationDetail = new Collection<busQdroCalculationDetail>();
            abusQdroCalculationHeader.iclbPersonAccountRetirementContribution = new Collection<busPersonAccountRetirementContribution>();
            abusQdroCalculationHeader.ibusBenefitApplication.idecAge = abusQdroCalculationHeader.icdoQdroCalculationHeader.age;
            abusQDROPayeeAccount.LoadDRODetails();

            //if (!abusQdroCalculationHeader.iblnParticipantPayeeAccount)
            //{
            abusQdroCalculationHeader.ibusBenefitApplication.LoadandProcessWorkHistory_ForAllPlans();
            //}

            abusQdroCalculationHeader.ibusBenefitCalculationHeader = new busBenefitCalculationHeader();
            if (!abusQDROPayeeAccount.ibusParticipant.iclbPersonAccount.Where(item => item.icdoPersonAccount.plan_id == busConstant.MPIPP_PLAN_ID).IsNullOrEmpty())
            {
                abusQdroCalculationHeader.iclbPersonAccountRetirementContribution =
                    abusQdroCalculationHeader.ibusBenefitCalculationHeader.LoadAllRetirementContributions(abusQDROPayeeAccount.ibusParticipant.icdoPerson.person_id, abusQDROPayeeAccount.ibusParticipant.iclbPersonAccount.Where(item => item.icdoPersonAccount.plan_id == busConstant.MPIPP_PLAN_ID).FirstOrDefault());
            }
            else
            {
                abusQdroCalculationHeader.iclbPersonAccountRetirementContribution = abusQdroCalculationHeader.ibusBenefitCalculationHeader.LoadAllRetirementContributions(abusQDROPayeeAccount.ibusParticipant.icdoPerson.person_id, null);
            }

            #endregion

            #region Check If Participant Disabled

            //10 Percent
            string lstrIsParticipantDisabledFlag = busConstant.FLAG_NO;

            DataTable ldtblDisabilityApplication = Select("cdoQdroCalculationHeader.GetParticipantWithDisabilityAppl", new object[2] { abusQDROPayeeAccount.icdoPayeeAccount.iintPlanId, abusQdroCalculationHeader.ibusQdroApplication.icdoDroApplication.person_id });
            if (ldtblDisabilityApplication != null && ldtblDisabilityApplication.Rows.Count > 0)
            {
                lstrIsParticipantDisabledFlag = busConstant.FLAG_YES;
            }

            #endregion Check If Participant Disabled



            #region LoadHeaderObject
            abusQdroCalculationHeader.PopulateInitialDataQdroCalculationHeader(
                     abusQDROPayeeAccount.ibusParticipant.icdoPerson.person_id, abusQdroCalculationHeader.ibusQdroApplication.icdoDroApplication.dro_application_id,
                     abusQDROPayeeAccount.ibusPayee, abusQdroCalculationHeader.ibusQdroApplication.icdoDroApplication.dro_commencement_date,
                     abusQDROPayeeAccount.icdoPayeeAccount.iintPlanId, abusQdroCalculationHeader.ibusQdroApplication.icdoDroApplication.date_of_marriage,
                     abusQdroCalculationHeader.ibusQdroApplication.icdoDroApplication.date_of_divorce,
                     lstrIsParticipantDisabledFlag, astrCalculationType);//10 Percent

            if (!ablnSharedInterestDRO)
            {
                abusQdroCalculationHeader.ibusBenefitApplication.LoadWorkHistoryandSetupPrerequisites_Retirement();
            }
            #endregion

            #region If participant disabled

            if (abusQdroCalculationHeader.ibusQdroApplication.icdoDroApplication.is_participant_disabled_flag == busConstant.FLAG_YES)
            {
                abusQdroCalculationHeader.ibusBenefitApplicationForDisability = new busBenefitApplication { icdoBenefitApplication = new cdoBenefitApplication() };
                abusQdroCalculationHeader.ibusBenefitApplicationForDisability.ibusPerson = new busPerson { icdoPerson = new cdoPerson() };
                abusQdroCalculationHeader.ibusBenefitApplicationForDisability.ibusPerson.iclbPersonAccount = new Collection<busPersonAccount>();

                abusQdroCalculationHeader.ibusBenefitApplicationForDisability.ibusPerson = abusQdroCalculationHeader.ibusParticipant;
                abusQdroCalculationHeader.ibusBenefitApplicationForDisability.ibusPerson.iclbPersonAccount = abusQdroCalculationHeader.ibusParticipant.iclbPersonAccount;
                abusQdroCalculationHeader.ibusBenefitApplicationForDisability.aclbPersonWorkHistory_MPI =
                                                                                abusQdroCalculationHeader.ibusBenefitApplication.aclbPersonWorkHistory_MPI;
                abusQdroCalculationHeader.ibusBenefitApplicationForDisability.aclbPersonWorkHistory_IAP =
                                                                                abusQdroCalculationHeader.ibusBenefitApplication.aclbPersonWorkHistory_IAP;
                abusQdroCalculationHeader.ibusBenefitApplicationForDisability.Eligible_Plans =
                                                                                abusQdroCalculationHeader.ibusBenefitApplication.Eligible_Plans;
                abusQdroCalculationHeader.ibusBenefitApplicationForDisability.icdoBenefitApplication.retirement_date = abusQdroCalculationHeader.ibusQdroApplication.icdoDroApplication.dro_commencement_date;
                if (!ablnSharedInterestDRO)
                {
                    abusQdroCalculationHeader.ibusBenefitApplicationForDisability.DetermineBenefitSubTypeandEligibility_Disability();
                }
            }

            #endregion

            #region CreateQDROCalculation
            if (ablnInsertInDb)
            {
                abusQdroCalculationHeader.icdoQdroCalculationHeader.iintPlanId = abusQDROPayeeAccount.icdoPayeeAccount.iintPlanId;
                string lstrPlanCode = abusQDROPayeeAccount.ibusParticipant.iclbPersonAccount.Where(item => item.icdoPersonAccount.plan_id == abusQDROPayeeAccount.icdoPayeeAccount.iintPlanId).FirstOrDefault().icdoPersonAccount.istrPlanCode;//lbusQdroCalculationHeader.GetPlanCode();

                if (ablnSharedInterestDRO || abusQdroCalculationHeader.ibusBenefitApplication.CheckAlreadyVested(lstrPlanCode))
                {
                    lbusPlanBenefitXr.FindPlanBenefitXr(abusDroBenefitDetails.icdoDroBenefitDetails.plan_benefit_id);

                    //PIR 554
                    if (lstrPlanCode == busConstant.Local_666 && abusQDROPayeeAccount.icdoPayeeAccount.istrBenefitOptionValue == busConstant.THREE_YEARS_CERTAIN_AND_LIFE_ANNUITY
                        && abusQdroCalculationHeader.icdoQdroCalculationHeader.calculation_type_value == busConstant.BenefitCalculation.CALCULATION_TYPE_ADJUSTMENT)
                    {
                        abusQdroCalculationHeader.ibusBenefitApplication.DetermineBenefitSubTypeandEligibility_Retirement();
                    }

                    DateTime ldtVestedDate = new DateTime();
                    if (abusQdroCalculationHeader.ibusBenefitApplication.ibusTempPersonAccountEligibility == null)
                    {
                        DataTable ldtblVestedDate = Select("cdoPersonAccountEligibility.GetVestedDate", new object[2]{ abusQDROPayeeAccount.ibusParticipant.icdoPerson.person_id,
                            abusQDROPayeeAccount.icdoPayeeAccount.iintPlanId});
                        if (ldtblVestedDate != null && ldtblVestedDate.Rows.Count > 0)
                        {
                            if (Convert.ToString(ldtblVestedDate.Rows[0][0]).IsNotNullOrEmpty())
                            {
                                ldtVestedDate = Convert.ToDateTime(ldtblVestedDate.Rows[0][0]);
                            }
                        }
                    }
                    else
                    {
                        ldtVestedDate = abusQdroCalculationHeader.ibusBenefitApplication.ibusTempPersonAccountEligibility.icdoPersonAccountEligibility.vested_date;
                    }

                    abusQdroCalculationHeader.SpawnFinalQdroCalculation(abusDroBenefitDetails.icdoDroBenefitDetails.dro_benefit_id,
                                        abusQDROPayeeAccount.ibusParticipant.iclbPersonAccount.Where(item => item.icdoPersonAccount.plan_id == icdoPayeeAccount.iintPlanId).FirstOrDefault().icdoPersonAccount.person_account_id,
                                        abusQDROPayeeAccount.icdoPayeeAccount.iintPlanId, lstrPlanCode, ldtVestedDate,
                                        abusQDROPayeeAccount.ibusParticipant.iclbPersonAccount.Where(item => item.icdoPersonAccount.plan_id == icdoPayeeAccount.iintPlanId).FirstOrDefault().icdoPersonAccount.istrRetirementSubType,
                                        abusQDROPayeeAccount.icdoPayeeAccount.istrBenefitOptionValue, ablnSharedInterestDRO);
                }
                try
                {
                    abusQdroCalculationHeader.iintParticipantPayeeAccountId = this.icdoPayeeAccount.payee_account_id;
                    abusQdroCalculationHeader.iintOriginalPayeeAccountId = abusQDROPayeeAccount.icdoPayeeAccount.payee_account_id;
                    abusQdroCalculationHeader.icdoQdroCalculationHeader.Insert();
                    //Ticket#84882
                    abusQdroCalculationHeader.iclbQdroCalculationDetail.FirstOrDefault().icdoQdroCalculationDetail.iblnIsNewRecord = true;
                    abusQdroCalculationHeader.AfterPersistChanges();


                    if (this.ibusBaseActivityInstance.IsNotNull())
                    {
                        FINAL_DRO_CALCULATION_ID = abusQdroCalculationHeader.icdoQdroCalculationHeader.qdro_calculation_header_id;
                        this.SetProcessInstanceParameters();
                    }

                }
                catch
                {
                }
            }
            #endregion

            #region Update Payee Account In Case of Reemployment
            if (ablnUpdatePayeeAcc)
            {
                busQdroCalculationOptions lbusQdroCalculationOptions;
                if (!abusQdroCalculationHeader.iclbQdroCalculationDetail.IsNullOrEmpty() && !abusQdroCalculationHeader.iclbQdroCalculationDetail.FirstOrDefault().iclbQdroCalculationOptions.IsNullOrEmpty())
                {
                    decimal ldecTaxableAmount = decimal.Zero;
                    decimal ldecNonTaxableAmount = decimal.Zero;
                    busQdroCalculationDetail lbusQdroCalculationDetail = abusQdroCalculationHeader.iclbQdroCalculationDetail.FirstOrDefault();
                    lbusQdroCalculationOptions = new busQdroCalculationOptions { icdoQdroCalculationOptions = new cdoQdroCalculationOptions() };
                    lbusQdroCalculationOptions = lbusQdroCalculationDetail.iclbQdroCalculationOptions.FirstOrDefault();

                    //abusQDROPayeeAccount.GetTaxableNonTaxableAmountForAlternatePayee(lbusQdroCalculationOptions, lbusQdroCalculationDetail.icdoQdroCalculationDetail.vested_ee_amount, lbusPlanBenefitXr.icdoPlanBenefitXr.benefit_option_value,
                    //               lbusQdroCalculationOptions.icdoQdroCalculationOptions.alt_payee_benefit_amount, lbusQdroCalculationDetail.icdoQdroCalculationDetail.alt_payee_member_exclusion_amount, out  ldecTaxableAmount, out  ldecNonTaxableAmount);

                    if (!abusQDROPayeeAccount.iclbPayeeAccountPaymentItemType.IsNullOrEmpty())
                    {
                        abusQDROPayeeAccount.iclbPayeeAccountPaymentItemTypeActive = (from item in this.iclbPayeeAccountPaymentItemType
                                                                                      where busGlobalFunctions.CheckDateOverlapping(abusQDROPayeeAccount.idtNextBenefitPaymentDate,
                                                                                      item.icdoPayeeAccountPaymentItemType.start_date, item.icdoPayeeAccountPaymentItemType.end_date)
                                                                                      select item).ToList().ToCollection<busPayeeAccountPaymentItemType>();
                        abusQDROPayeeAccount.LoadNextBenefitPaymentDate();

                        if (abusQDROPayeeAccount.icdoPayeeAccount.iintPlanId != busConstant.IAP_PLAN_ID)
                        {
                            #region Update Payment Item Types
                            string astrAccountNo = string.Empty;

                            UpdatePaymentItemTypeWithNewAmount(abusQDROPayeeAccount, lbusQdroCalculationDetail.icdoQdroCalculationDetail.alt_payee_member_exclusion_amount, lbusQdroCalculationOptions.icdoQdroCalculationOptions.alt_payee_benefit_amount, decimal.Zero, abusQDROPayeeAccount.icdoPayeeAccount.istrBenefitOptionValue, DateTime.Now, abusQDROPayeeAccount.icdoPayeeAccount.iintPlanId, ref adecTaxableAmount);
                            adecNonTaxableAmount = lbusQdroCalculationOptions.icdoQdroCalculationOptions.alt_payee_benefit_amount - adecTaxableAmount;
                            #region AmountAlreadyPaidToTheParticipant
                            Collection<busBenefitMonthwiseAdjustmentDetail> lclbBenefitMonthwiseAdjustmentDetail = new Collection<busBenefitMonthwiseAdjustmentDetail>();
                            lclbBenefitMonthwiseAdjustmentDetail = ibusCalculation.GetAmountActuallyPaid(abusQDROPayeeAccount, Convert.ToDateTime(adtAccruedAsOfDate), abusQDROPayeeAccount.idtNextBenefitPaymentDate.AddDays(-1));
                            #endregion

                            #region Amount Should Have been Paid
                            foreach (busBenefitMonthwiseAdjustmentDetail lbusBenefitMonthwiseAdjustmentDetail in lclbBenefitMonthwiseAdjustmentDetail)
                            {
                                lbusBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.non_taxable_amount_to_be_paid = adecNonTaxableAmount;
                                lbusBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.taxable_amount_to_be_paid = adecTaxableAmount;
                            }
                            ibusCalculation.CreateOverpaymentUnderPayment(this, lclbBenefitMonthwiseAdjustmentDetail, busConstant.RETRO_PAYMENT_REEMPLOYMENT);
                            #endregion

                            #endregion
                        }
                        else
                        {
                            #region Check If LumpSum Paid Out
                            bool lblnLumpSumPaidOut = false;
                            decimal ldecAmount = decimal.Zero;
                            if (lbusPlanBenefitXr.icdoPlanBenefitXr.benefit_option_value == busConstant.LUMP_SUM)
                            {
                                DataTable ldtTable = Select("cdoPaymentHistoryHeader.GetLumpSumAmountPaidOut", new object[1] { abusQDROPayeeAccount.icdoPayeeAccount.payee_account_id });
                                if (ldtTable.Rows.Count > 0)
                                {
                                    ldecAmount = Convert.ToDecimal(ldtTable.Rows[0][0]);
                                    if (ldecAmount > 0)
                                    {
                                        lblnLumpSumPaidOut = true;
                                    }
                                }
                            }
                            #endregion

                            adecTaxableAmount = lbusQdroCalculationOptions.icdoQdroCalculationOptions.alt_payee_benefit_amount - ldecAmount;
                            //If Lump Sum has been paid out that means non taxable amount is zero : all new benefit is taxable.
                            abusQDROPayeeAccount.CreatePayeeAccountPaymentItemType("ITEM21", adecTaxableAmount, "0", 0, abusQDROPayeeAccount.idtNextBenefitPaymentDate, DateTime.MinValue, "N", false);
                        }




                    }


                }
            }
            #endregion
            return abusQdroCalculationHeader;
        }

        private void CalculateAndPostUVHPPartialInterest(int aintPersonAccountId, int aintBenefitCalculationHeaderId, DateTime adtRetirementDate)
        {

            busCalculation lbusCalculation = new busCalculation();
            //Check if there is late UVHP contribution in privous month
            //Get calculate the latest interest 
            //Post Latest interest - old interest 
            int lintLateContributionYear = 0;
            // Get Late UVHP contribution
            DataTable ldtbLateUVHPContribution = busBase.Select("cdoPersonAccountRetirementContribution.GetPreviousMonthUVHPContribution",
                new object[1] { aintPersonAccountId });

            if (ldtbLateUVHPContribution.Rows.Count > 0)
            {
                lintLateContributionYear = Convert.ToInt32(ldtbLateUVHPContribution.Rows[0][enmPersonAccountRetirementContribution.computational_year.ToString()]);

                for (int lintYear = lintLateContributionYear; lintYear <= adtRetirementDate.Year; lintYear++)
                {
                    decimal ldecRateOfInterest = lbusCalculation.CalculateRateOfInterest(lintYear);
                    DataTable ldtbUVHPContribution = busBase.Select("cdoPersonAccountRetirementContribution.LoadLateUVHPContribution",
                                                      new object[] { aintPersonAccountId, lintYear });

                    if (ldtbUVHPContribution.Rows.Count > 0)
                    {
                        busPersonAccountRetirementContribution lbusPersonAccountRetirementContribution =
                               new busPersonAccountRetirementContribution { icdoPersonAccountRetirementContribution = new cdoPersonAccountRetirementContribution() };
                        lbusPersonAccountRetirementContribution.icdoPersonAccountRetirementContribution.LoadData(ldtbUVHPContribution.Rows[0]);

                        if (lintYear != adtRetirementDate.Year)
                        {
                            decimal ldecUVHPInterestAmtAfterLateCont = (lbusPersonAccountRetirementContribution.icdoPersonAccountRetirementContribution.uvhp_amount +
                                                  lbusPersonAccountRetirementContribution.icdoPersonAccountRetirementContribution.uvhp_int_amount) * ldecRateOfInterest;

                            decimal ldecUVHPInterestAmtBeforeLateCont = lbusPersonAccountRetirementContribution.icdoPersonAccountRetirementContribution.uvhp_int_amount;
                            decimal ldecUVHPActualInterest = ldecUVHPInterestAmtAfterLateCont - ldecUVHPInterestAmtBeforeLateCont;

                            lbusPersonAccountRetirementContribution.InsertPersonAccountRetirementContirbution(aintPersonAccountId,
                              busGlobalFunctions.GetLastDateOfComputationYear(lintYear), DateTime.Now, lintYear,
                              busConstant.ZERO_DECIMAL, busConstant.ZERO_DECIMAL, busConstant.ZERO_DECIMAL, busConstant.TransactionTypeInterest,
                              busConstant.ZERO_DECIMAL, busConstant.ZERO_DECIMAL, busConstant.ZERO_DECIMAL, ldecUVHPActualInterest, busConstant.ZERO_DECIMAL,
                              busConstant.CONTRIBUTION_TYPE_UVHP, lbusPersonAccountRetirementContribution.icdoPersonAccountRetirementContribution.contribution_subtype_value);
                        }
                        else
                        {
                            decimal ldecPriorYearInterest = decimal.Zero;
                            decimal ldecPartialUVHPInterestAmount = lbusCalculation.CalculatePartialUVHPInterest(adtRetirementDate, aintPersonAccountId, out ldecPriorYearInterest);
                            if (ldecPartialUVHPInterestAmount - ldecPriorYearInterest > decimal.Zero)
                            {
                                lbusPersonAccountRetirementContribution.InsertPersonAccountRetirementContirbution(aintPersonAccountId, busGlobalFunctions.GetLastDateOfComputationYear(adtRetirementDate.Year - 1).AddDays(1),
                                DateTime.Now, adtRetirementDate.Year, adecUVHPInterestAmount: ldecPartialUVHPInterestAmount - ldecPriorYearInterest, astrTransactionType: busConstant.TRANSACTION_TYPE_INTEREST,
                                astrContributionType: busConstant.CONTRIBUTION_TYPE_UVHP, aintReferenceID: aintBenefitCalculationHeaderId);
                            }
                            if (ldecPriorYearInterest > decimal.Zero)
                            {
                                lbusPersonAccountRetirementContribution = new busPersonAccountRetirementContribution { icdoPersonAccountRetirementContribution = new cdoPersonAccountRetirementContribution() };
                                lbusPersonAccountRetirementContribution.InsertPersonAccountRetirementContirbution(aintPersonAccountId, busGlobalFunctions.GetLastDateOfComputationYear(adtRetirementDate.Year - 1).AddDays(1),
                                DateTime.Now, adtRetirementDate.AddYears(-1).Year, adecUVHPInterestAmount: ldecPriorYearInterest, astrTransactionType: busConstant.TRANSACTION_TYPE_INTEREST,
                                astrContributionType: busConstant.CONTRIBUTION_TYPE_UVHP, aintReferenceID: aintBenefitCalculationHeaderId);

                            }
                        }
                    }
                }
            }
        }

        #region payee Account Status for Visible Rule's
        public bool IsPayeeAccountStatusCancelled()
        {
            if (this.iclbPayeeAccountStatus.IsNullOrEmpty())
            {
                this.LoadPayeeAccountStatuss();
            }
            if (!this.iclbPayeeAccountStatus.IsNullOrEmpty())
            {
                if (this.iclbPayeeAccountStatus.FirstOrDefault().icdoPayeeAccountStatus.status_value == busConstant.PAYEE_ACCOUNT_STATUS_CANCELLED)
                {
                    return true;
                }
            }

            return false;
        }
        public bool IsBPMInProgress()
        {
            //Active process already exists for person.

            Collection<IDbDataParameter> lclbParameters = new Collection<IDbDataParameter>();
            lclbParameters.Add(DBFunction.GetDBParameter("@PERSON_ID", "int", this.icdoPayeeAccount.person_id, iobjPassInfo.iconFramework));
            lclbParameters.Add(DBFunction.GetDBParameter("@CASE_NAME", "string", busConstant.ReturnToWorkRequest.MAP_RETURN_TO_WORK, iobjPassInfo.iconFramework));
            
            string lstrActiveInProgressInstanceQuery = "entFramework.CountActiveProcessForPersonByCaseName";

            object lobjActiveWfCount = DBFunction.DBExecuteScalar(lstrActiveInProgressInstanceQuery, lclbParameters, iobjPassInfo.iconFramework, iobjPassInfo.itrnFramework);

            if (lobjActiveWfCount != null)
            {
                if (Convert.ToInt32(lobjActiveWfCount) > 0)
                {
                    return true;
                }
            }
            return false;
        }

        public bool IsPayeeAccountStatusCompletedORCancelled()
        {
            if (this.iclbPayeeAccountStatus.Count > 0)
            {
                if (this.iclbPayeeAccountStatus.FirstOrDefault().icdoPayeeAccountStatus.status_value == busConstant.PAYEE_ACCOUNT_STATUS_COMPLETED
                    || this.iclbPayeeAccountStatus.FirstOrDefault().icdoPayeeAccountStatus.status_value == busConstant.PAYEE_ACCOUNT_STATUS_CANCELLED
                    || this.iclbPayeeAccountStatus.FirstOrDefault().icdoPayeeAccountStatus.status_value == busConstant.PAYEE_ACCOUNT_STATUS_SUSPENDED)
                {
                    return true;
                }
            }

            return false;
        }
        #endregion

        #region Recalculate_Death

        //10 % Percent 2017
        public busBenefitCalculationPreRetirementDeath RecalculateSurvivorPreRetirementDeathBenefits(string astrBenefitOptionValue, bool ablnRefreshCalculationFinal = false)
        {
            FINAL_CALCULATION_ID = 0;
            FINAL_DRO_CALCULATION_ID = 0;

            busBenefitApplicationDetail lbusBenefitApplicationDetail = new busBenefitApplicationDetail { icdoBenefitApplicationDetail = new cdoBenefitApplicationDetail() };
            busDeathPreRetirement lbusDeathPreRetirement = new busDeathPreRetirement { icdoBenefitApplication = new cdoBenefitApplication() };

            busBenefitCalculationPreRetirementDeath lbusBenefitCalculationPreRetirementDeath = new busBenefitCalculationPreRetirementDeath { icdoBenefitCalculationHeader = new cdoBenefitCalculationHeader() };

            #region Death_Application_Object
            if (lbusBenefitApplicationDetail.FindBenefitApplicationDetail(this.icdoPayeeAccount.benefit_application_detail_id))
            {

                lbusBenefitApplicationDetail.ibusPlanBenefitXr = new busPlanBenefitXr { icdoPlanBenefitXr = new cdoPlanBenefitXr() };
                lbusBenefitApplicationDetail.ibusPlanBenefitXr.FindPlanBenefitXr(lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.plan_benefit_id);
                lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.istrBenefitOptionValue = astrBenefitOptionValue;

                lbusDeathPreRetirement = LoadDeathApplicationObject(lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.benefit_application_id);
                lbusBenefitApplicationDetail.iintPlan_ID = this.icdoPayeeAccount.iintPlanId;
                lbusBenefitApplicationDetail.istrPlanCode = lbusDeathPreRetirement.ibusPerson.iclbPersonAccount.Where(item => item.icdoPersonAccount.plan_id == this.icdoPayeeAccount.iintPlanId).FirstOrDefault().icdoPersonAccount.istrPlanCode;
            }
            #endregion

            string lstrCalculationType = string.Empty;
            if (ablnRefreshCalculationFinal)
            {
                lstrCalculationType = busConstant.BenefitCalculation.CALCULATION_TYPE_FINAL;
            }
            else
            {
                lstrCalculationType = busConstant.BenefitCalculation.CALCULATION_TYPE_ADJUSTMENT;
            }

            #region Death_PreRetirement_Calculation_Object

            lbusBenefitCalculationPreRetirementDeath = LoadHeaderObject(lbusDeathPreRetirement, lbusBenefitApplicationDetail, lstrCalculationType);

            #endregion

            if (lbusBenefitApplicationDetail.iintPlan_ID == busConstant.MPIPP_PLAN_ID)
            {
                //Check there will be diffferent payee accounts , but header is same.
                if (lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.uvhp_flag != busConstant.Flag_Yes)
                {
                    #region PURE_MPI
                    lbusBenefitCalculationPreRetirementDeath.iblnCalculateMPIPPBenefit = true;
                    #endregion
                }
                if (lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.uvhp_flag == busConstant.Flag_Yes)
                {
                    #region EE_UVHP
                    lbusBenefitCalculationPreRetirementDeath.iblnCalcualteUVHPBenefit = true;
                    #endregion
                }
            }
            else if (lbusBenefitApplicationDetail.iintPlan_ID == busConstant.IAP_PLAN_ID)
            {
                //Check there will be diffferent payee accounts , but header is same.
                #region IAP
                if (lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.l161_spl_acc_flag != busConstant.Flag_Yes &&
                    lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.l52_spl_acc_flag != busConstant.Flag_Yes)
                {
                    lbusBenefitCalculationPreRetirementDeath.iblnCalculateIAPBenefit = true;
                }
                #endregion

                #region IAP_SpecialAccounts
                if (lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.l161_spl_acc_flag == busConstant.Flag_Yes)
                {
                    lbusBenefitCalculationPreRetirementDeath.iblnCalculateL161SplAccBenefit = true;
                }
                if (lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.l52_spl_acc_flag == busConstant.Flag_Yes)
                {
                    lbusBenefitCalculationPreRetirementDeath.iblnCalculateL52SplAccBenefit = true;
                }
                #endregion
            }
            else
            {
                #region Locals
                #endregion
            }

            #region Calculate Benefits
            string lstrBenefitSubtype = lbusDeathPreRetirement.ibusPerson.iclbPersonAccount.Where(item => item.icdoPersonAccount.plan_id == this.icdoPayeeAccount.iintPlanId).FirstOrDefault().icdoPersonAccount.istrRetirementSubType;
            int lintPersonAccountId = lbusDeathPreRetirement.ibusPerson.iclbPersonAccount.Where(item => item.icdoPersonAccount.istrPlanCode == lbusBenefitApplicationDetail.istrPlanCode).FirstOrDefault().icdoPersonAccount.person_account_id;

            if (lbusBenefitApplicationDetail.iintPlan_ID == busConstant.MPIPP_PLAN_ID)
            {
                CalculateAndPostUVHPPartialInterest(lintPersonAccountId, lbusBenefitCalculationPreRetirementDeath.icdoBenefitCalculationHeader.benefit_calculation_header_id,
                                                    lbusBenefitCalculationPreRetirementDeath.icdoBenefitCalculationHeader.retirement_date);
            }

            if (lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.istrBenefitOptionValue == busConstant.LUMP_SUM)
            {
                if (!string.IsNullOrEmpty(lbusBenefitCalculationPreRetirementDeath.icdoBenefitCalculationHeader.istrEarliestRetirementType))
                {
                    lstrBenefitSubtype = lbusBenefitCalculationPreRetirementDeath.icdoBenefitCalculationHeader.istrEarliestRetirementType;
                }
            }
            lbusBenefitCalculationPreRetirementDeath.SpawnFinalRetirementCalculation(lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.benefit_application_detail_id,
                                                                             lintPersonAccountId,
                                                                             lbusBenefitApplicationDetail.iintPlan_ID, lbusBenefitApplicationDetail.istrPlanCode, lbusDeathPreRetirement.ibusTempPersonAccountEligibility.icdoPersonAccountEligibility.vested_date,
                                                                             lstrBenefitSubtype, lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.istrBenefitOptionValue, astrAdjustmentFlag: this.icdoPayeeAccount.adjustment_payment_eligible_flag);

            //10 Percent
            //Ticket# 68700
            if ((lbusBenefitApplicationDetail.iintPlan_ID != busConstant.IAP_PLAN_ID && lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.istrBenefitOptionValue == busConstant.LUMP_SUM &&
                lbusBenefitCalculationPreRetirementDeath.icdoBenefitCalculationHeader.calculation_type_value == busConstant.BenefitCalculation.CALCULATION_TYPE_ADJUSTMENT &&
                lbusBenefitCalculationPreRetirementDeath.iclbBenefitCalculationDetail != null && lbusBenefitCalculationPreRetirementDeath.iclbBenefitCalculationDetail.Count() > 0
                && lbusBenefitCalculationPreRetirementDeath.iclbBenefitCalculationDetail[0].icdoBenefitCalculationDetail.ee_flag != busConstant.FLAG_YES &&
                lbusBenefitCalculationPreRetirementDeath.iclbBenefitCalculationDetail[0].icdoBenefitCalculationDetail.uvhp_flag != busConstant.FLAG_YES
                && lbusBenefitCalculationPreRetirementDeath.iclbBenefitCalculationDetail[0].iclbBenefitCalculationOptions != null && lbusBenefitCalculationPreRetirementDeath.iclbBenefitCalculationDetail[0].iclbBenefitCalculationOptions.Count() > 0) || (lbusBenefitApplicationDetail.iintPlan_ID == busConstant.IAP_PLAN_ID))
            {
                //Ticket# 68700
                if (lbusBenefitCalculationPreRetirementDeath.iclbBenefitCalculationDetail.Count > 0)
                {
                    if (lbusBenefitCalculationPreRetirementDeath.iclbBenefitCalculationDetail[0].iclbBenefitCalculationOptions.Count > 0)
                    {
                        lbusBenefitCalculationPreRetirementDeath.iclbBenefitCalculationDetail[0].iclbBenefitCalculationOptions[0].icdoBenefitCalculationOptions.paid_amount = idecPaidGrossAmount;
                    }


                }

            }
            #endregion

            lbusBenefitCalculationPreRetirementDeath.iintOriginalPayeeAccountId = this.icdoPayeeAccount.payee_account_id;
            lbusBenefitCalculationPreRetirementDeath.icdoBenefitCalculationHeader.ienuObjectState = ObjectState.Insert;
            lbusBenefitCalculationPreRetirementDeath.PersistChanges();
            lbusBenefitCalculationPreRetirementDeath.AfterPersistChanges();

            if (this.ibusBaseActivityInstance.IsNotNull())
            {
                FINAL_CALCULATION_ID = lbusBenefitCalculationPreRetirementDeath.icdoBenefitCalculationHeader.benefit_calculation_header_id;
                this.SetProcessInstanceParameters();
            }

            return lbusBenefitCalculationPreRetirementDeath;
        }


        public void RecalculateSurvivorPostRetirementDeathBenefitsWithLateHours()
        {
            busBenefitApplicationDetail lbusBenefitApplicationDetail = new busBenefitApplicationDetail() { icdoBenefitApplicationDetail = new cdoBenefitApplicationDetail() };
            busBenefitCalculationHeader lbusBenefitCalculationHeader = new busBenefitCalculationHeader() { icdoBenefitCalculationHeader = new cdoBenefitCalculationHeader() };

            bool lblnMPIPPCalculated = false;
            bool lblnIAPCalculated = false;

            int lintPersonAccountId = 0;
            int lintMPIPPHeaderId = 0;
            int lintIAPHeaderId = 0;


            busPlanBenefitXr lbusPlanBenefitXr = new busPlanBenefitXr();
            lbusPlanBenefitXr.FindPlanBenefitXr(icdoPayeeAccount.plan_benefit_id);
            string lstrBenefitOption = lbusPlanBenefitXr.icdoPlanBenefitXr.benefit_option_value;



            if (lbusBenefitApplicationDetail.FindBenefitApplicationDetail(this.icdoPayeeAccount.benefit_application_detail_id))
            {

                lbusBenefitApplicationDetail.LoadBenefitApplication();
                lbusBenefitApplicationDetail.LoadPlanBenefitXr();

                lbusBenefitApplicationDetail.iintPlan_ID = lbusBenefitApplicationDetail.ibusPlanBenefitXr.icdoPlanBenefitXr.plan_id;
                DataTable ldtbGetPlanCodebyId = busBase.Select("cdoPlan.GetPlanCodebyId", new object[1] { lbusBenefitApplicationDetail.iintPlan_ID });
                if (ldtbGetPlanCodebyId.Rows.Count > 0)
                    lbusBenefitApplicationDetail.istrPlanCode = ldtbGetPlanCodebyId.Rows[0][enmPlan.plan_code.ToString()].ToString();


                lbusBenefitApplicationDetail.ibusBenefitApplication.ibusPerson = new busPerson();
                lbusBenefitApplicationDetail.ibusBenefitApplication.ibusPerson.FindPerson(this.icdoPayeeAccount.person_id);
                lbusBenefitApplicationDetail.ibusBenefitApplication.ibusPerson.LoadPersonAccounts();
                lbusBenefitApplicationDetail.ibusBenefitApplication.LoadandProcessWorkHistory_ForAllPlans();

                if (lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.joint_annuitant_id > 0)
                {
                    if (this.icdoPayeeAccount.benefit_account_type_value == busConstant.BENEFIT_TYPE_RETIREMENT)
                    {
                        busBenefitCalculationRetirement lbusBenefitCalculationRetirement = new busBenefitCalculationRetirement { icdoBenefitCalculationHeader = new cdoBenefitCalculationHeader() };
                        busBenefitCalculationDetail lbusBenefitCalculationDetail = new busBenefitCalculationDetail() { icdoBenefitCalculationDetail = new cdoBenefitCalculationDetail() };

                        busPerson lbusSurvivorPerson = new busPerson { icdoPerson = new cdoPerson() };
                        lbusSurvivorPerson.FindPerson(lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.joint_annuitant_id);


                        lbusBenefitCalculationRetirement.ibusBenefitApplication = lbusBenefitApplicationDetail.ibusBenefitApplication;
                        lbusBenefitCalculationRetirement.ibusPerson = lbusBenefitApplicationDetail.ibusBenefitApplication.ibusPerson;
                        lbusBenefitCalculationRetirement.ibusPerson.iclbPersonAccount = lbusBenefitApplicationDetail.ibusBenefitApplication.ibusPerson.iclbPersonAccount;
                        lbusBenefitCalculationRetirement.icdoBenefitCalculationHeader.age = busGlobalFunctions.CalculatePersonAgeInDec(lbusBenefitApplicationDetail.ibusBenefitApplication.ibusPerson.icdoPerson.idtDateofBirth, lbusBenefitApplicationDetail.ibusBenefitApplication.icdoBenefitApplication.retirement_date);



                        if (lbusBenefitCalculationDetail.FindBenefitCalculationDetail(this.icdoPayeeAccount.benefit_calculation_detail_id))
                        {
                            this.ibusBenefitCalculationHeader = new busBenefitCalculationHeader { icdoBenefitCalculationHeader = new cdoBenefitCalculationHeader() };
                            this.ibusBenefitCalculationHeader.FindBenefitCalculationHeader(lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.benefit_calculation_header_id);

                        }


                        lbusBenefitCalculationRetirement.iclbBenefitCalculationDetail = new Collection<busBenefitCalculationDetail>();

                        lbusBenefitCalculationRetirement.iclbPersonAccountRetirementContribution = new Collection<busPersonAccountRetirementContribution>();


                        if (!lbusBenefitApplicationDetail.ibusBenefitApplication.ibusPerson.iclbPersonAccount.Where(item => item.icdoPersonAccount.plan_id == busConstant.MPIPP_PLAN_ID).IsNullOrEmpty())
                        {
                            lbusBenefitCalculationRetirement.LoadAllRetirementContributions(lbusBenefitApplicationDetail.ibusBenefitApplication.ibusPerson.iclbPersonAccount.Where(item => item.icdoPersonAccount.plan_id == busConstant.MPIPP_PLAN_ID).FirstOrDefault());
                        }
                        else
                        {
                            lbusBenefitCalculationRetirement.LoadAllRetirementContributions(null);
                        }



                        if (lbusBenefitApplicationDetail.iintPlan_ID == busConstant.IAP_PLAN_ID)
                        {
                            lbusBenefitCalculationRetirement.iblnCalculateIAPBenefit = true;

                            #region Setting Up Header for IAP
                            if (!lblnIAPCalculated)
                            {
                                lbusBenefitCalculationRetirement.PopulateInitialDataBenefitCalculationHeader(lbusBenefitApplicationDetail.ibusBenefitApplication.ibusPerson.icdoPerson.person_id, lbusBenefitApplicationDetail.ibusBenefitApplication.icdoBenefitApplication.benefit_application_id, lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.joint_annuitant_id,
                                                                                     busConstant.BENEFIT_TYPE_RETIREMENT, busConstant.BenefitCalculation.CALCULATION_TYPE_ADJUSTMENT, lbusBenefitApplicationDetail.ibusBenefitApplication.icdoBenefitApplication.retirement_date,
                                                                                     lbusBenefitApplicationDetail.ibusBenefitApplication.idecAge, lbusBenefitApplicationDetail.iintPlan_ID);
                            }
                            else
                            {
                                if (lbusBenefitCalculationRetirement.FindBenefitCalculationHeader(lintIAPHeaderId))
                                {
                                    lbusBenefitCalculationRetirement.icdoBenefitCalculationHeader.iintPlanId = lbusBenefitApplicationDetail.iintPlan_ID;
                                    lbusBenefitCalculationRetirement.icdoBenefitCalculationHeader.iintSurvivorAgeAtRetirement = busGlobalFunctions.CalculatePersonAgeInDec(lbusBenefitCalculationRetirement.icdoBenefitCalculationHeader.beneficiary_person_date_of_birth, lbusBenefitApplicationDetail.ibusBenefitApplication.icdoBenefitApplication.retirement_date);
                                }
                            }
                            #endregion
                        }



                        else if (lbusBenefitApplicationDetail.iintPlan_ID == busConstant.MPIPP_PLAN_ID)
                        {
                            lbusBenefitCalculationRetirement.iblnCalculateMPIPPBenefit = true;

                            lintMPIPPHeaderId = lbusBenefitCalculationRetirement.icdoBenefitCalculationHeader.benefit_calculation_header_id;
                            #region Setting Up Header for MPIPP
                            if (!lblnMPIPPCalculated)

                                lbusBenefitCalculationRetirement.PopulateInitialDataBenefitCalculationHeader(lbusBenefitApplicationDetail.ibusBenefitApplication.ibusPerson.icdoPerson.person_id, lbusBenefitApplicationDetail.ibusBenefitApplication.icdoBenefitApplication.benefit_application_id, lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.joint_annuitant_id,
                                                                                      busConstant.BENEFIT_TYPE_RETIREMENT, busConstant.BenefitCalculation.CALCULATION_TYPE_ADJUSTMENT, lbusBenefitApplicationDetail.ibusBenefitApplication.icdoBenefitApplication.retirement_date,
                                                                                      lbusBenefitApplicationDetail.ibusBenefitApplication.idecAge, lbusBenefitApplicationDetail.iintPlan_ID);


                            else if (lbusBenefitCalculationRetirement.FindBenefitCalculationHeader(lintMPIPPHeaderId))
                            {
                                lbusBenefitCalculationRetirement.icdoBenefitCalculationHeader.iintPlanId = lbusBenefitApplicationDetail.iintPlan_ID;

                                lbusBenefitCalculationRetirement.icdoBenefitCalculationHeader.iintSurvivorAgeAtRetirement = busGlobalFunctions.CalculatePersonAgeInDec(lbusBenefitCalculationRetirement.icdoBenefitCalculationHeader.beneficiary_person_date_of_birth, lbusBenefitApplicationDetail.ibusBenefitApplication.icdoBenefitApplication.retirement_date);
                            }
                        }
                        #endregion

                        if (lbusBenefitCalculationRetirement.ibusBenefitApplication.CheckAlreadyVested(lbusBenefitApplicationDetail.istrPlanCode))
                        {
                            if (lbusBenefitApplicationDetail.ibusBenefitApplication.ibusPerson.iclbPersonAccount.Where(item => item.icdoPersonAccount.istrPlanCode == lbusBenefitApplicationDetail.istrPlanCode).Count() > 0)
                                lintPersonAccountId = lbusBenefitApplicationDetail.ibusBenefitApplication.ibusPerson.iclbPersonAccount.Where(item => item.icdoPersonAccount.istrPlanCode == lbusBenefitApplicationDetail.istrPlanCode).FirstOrDefault().icdoPersonAccount.person_account_id;



                            if (lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.istrBenefitOptionValue.IsNullOrEmpty() && lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.istrSubPlanBenefitOptionValue.IsNotNullOrEmpty())
                            {
                                lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.istrBenefitOptionValue = lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.istrSubPlanBenefitOptionValue;
                            }

                            lbusBenefitCalculationRetirement.SpawnFinalRetirementCalculation(lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.benefit_application_detail_id,
                                                                                              lintPersonAccountId, lbusBenefitApplicationDetail.iintPlan_ID, lbusBenefitApplicationDetail.istrPlanCode,
                                                                                              lbusBenefitCalculationRetirement.ibusBenefitApplication.ibusTempPersonAccountEligibility.icdoPersonAccountEligibility.vested_date,
                                                                                              lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.benefit_subtype_value,
                                                                                              lstrBenefitOption);
                        }



                        lbusBenefitCalculationDetail = lbusBenefitCalculationRetirement.iclbBenefitCalculationDetail.FirstOrDefault();
                        InsertBenefitCalculationDetailsForConversion(lbusBenefitCalculationRetirement, lbusBenefitApplicationDetail, lbusBenefitCalculationDetail.iclbBenefitCalculationOptions.FirstOrDefault());

                    }


                }

            }


        }


        public busDeathPreRetirement LoadDeathApplicationObject(int aintbenefitapplicationid)
        {
            busDeathPreRetirement lbusDeathPreRetirement = new busDeathPreRetirement { icdoBenefitApplication = new cdoBenefitApplication() };
            lbusDeathPreRetirement.FindBenefitApplication(aintbenefitapplicationid);
            lbusDeathPreRetirement.ibusPerson = new busPerson();
            lbusDeathPreRetirement.ibusPerson.FindPerson(lbusDeathPreRetirement.icdoBenefitApplication.person_id);
            lbusDeathPreRetirement.GetAgeAtDeath();
            lbusDeathPreRetirement.GetAgeAtRetirement(lbusDeathPreRetirement.icdoBenefitApplication.retirement_date);
            lbusDeathPreRetirement.ibusPerson.LoadPersonAccounts();
            lbusDeathPreRetirement.LoadandProcessWorkHistory_ForAllPlans();
            lbusDeathPreRetirement.CheckIfQualifiedSpouseinDeath();
            lbusDeathPreRetirement.DetermineVesting();

            return lbusDeathPreRetirement;
        }

        /// <summary>
        /// Load Header Object && Earliest Retirement Date
        /// </summary>
        /// <param name="lbusDeathPreRetirement"></param>
        /// <returns></returns>
        public busBenefitCalculationPreRetirementDeath LoadHeaderObject(busDeathPreRetirement lbusDeathPreRetirement, busBenefitApplicationDetail abusBenefitApplicationDetail, string astrCalculationType)
        {
            DateTime ldtBenefitCommencementDate = lbusDeathPreRetirement.icdoBenefitApplication.retirement_date;
            busBenefitCalculationPreRetirementDeath lbusBenefitCalculationPreRetirementDeath = new busBenefitCalculationPreRetirementDeath { icdoBenefitCalculationHeader = new cdoBenefitCalculationHeader() };

            lbusBenefitCalculationPreRetirementDeath.ibusBenefitApplication = new busBenefitApplication { icdoBenefitApplication = new cdoBenefitApplication() };
            lbusBenefitCalculationPreRetirementDeath.ibusBenefitApplication = lbusDeathPreRetirement;
            lbusBenefitCalculationPreRetirementDeath.ibusPerson = lbusDeathPreRetirement.ibusPerson;
            lbusBenefitCalculationPreRetirementDeath.ibusPerson.iclbPersonAccount = lbusDeathPreRetirement.ibusPerson.iclbPersonAccount;
            lbusBenefitCalculationPreRetirementDeath.icdoBenefitCalculationHeader.age = busGlobalFunctions.CalculatePersonAgeInDec(lbusDeathPreRetirement.ibusPerson.icdoPerson.idtDateofBirth, lbusDeathPreRetirement.icdoBenefitApplication.retirement_date);
            lbusBenefitCalculationPreRetirementDeath.iclbBenefitCalculationDetail = new Collection<busBenefitCalculationDetail>();
            lbusBenefitCalculationPreRetirementDeath.iclbPersonAccountRetirementContribution = new Collection<busPersonAccountRetirementContribution>();

            if (!lbusDeathPreRetirement.ibusPerson.iclbPersonAccount.Where(item => item.icdoPersonAccount.plan_id == busConstant.MPIPP_PLAN_ID).IsNullOrEmpty())
            {
                lbusBenefitCalculationPreRetirementDeath.LoadAllRetirementContributions(lbusDeathPreRetirement.ibusPerson.iclbPersonAccount.Where(item => item.icdoPersonAccount.plan_id == busConstant.MPIPP_PLAN_ID).FirstOrDefault());
            }
            else
            {
                lbusBenefitCalculationPreRetirementDeath.LoadAllRetirementContributions(null);
            }


            lbusBenefitCalculationPreRetirementDeath.PopulateInitialDataBenefitCalculationHeader(lbusDeathPreRetirement.ibusPerson.icdoPerson.person_id,
    lbusDeathPreRetirement.icdoBenefitApplication.benefit_application_id, abusBenefitApplicationDetail.icdoBenefitApplicationDetail.survivor_id,
                                                                         busConstant.BENEFIT_TYPE_DEATH_PRE_RETIREMENT, astrCalculationType, lbusDeathPreRetirement.icdoBenefitApplication.retirement_date,
                                                                         lbusDeathPreRetirement.idecAge, this.icdoPayeeAccount.iintPlanId, abusBenefitApplicationDetail.icdoBenefitApplicationDetail.organization_id, abusBenefitApplicationDetail.icdoBenefitApplicationDetail.idecPercentage);


            lbusBenefitCalculationPreRetirementDeath.LoadPreRetirementDeathInitialData();
            lbusBenefitCalculationPreRetirementDeath.ibusBenefitApplication.icdoBenefitApplication.retirement_date = ldtBenefitCommencementDate;
            lbusBenefitCalculationPreRetirementDeath.icdoBenefitCalculationHeader.benefit_commencement_date = ldtBenefitCommencementDate;
            lbusBenefitCalculationPreRetirementDeath.SetUpVariablesForDeath(lbusDeathPreRetirement.icdoBenefitApplication.retirement_date);



            return lbusBenefitCalculationPreRetirementDeath;
        }

        #endregion

        #region Recalculate_Disability

        public busBenefitCalculationHeader RecalculateParticipantDisabilityBenefits(string astrBenefitOptionValue, bool lblnDoInsert = true, bool ablnRefreshCalculationFinal = false, bool ablnPostRetrDeath = false, bool ablnConvertBenOption = false) //RequestID: 72091
        {

            FINAL_CALCULATION_ID = 0;
            FINAL_DRO_CALCULATION_ID = 0;

            busBenefitApplicationDetail lbusBenefitApplicationDetail = new busBenefitApplicationDetail { icdoBenefitApplicationDetail = new cdoBenefitApplicationDetail() };
            busDisabilityApplication lbusDisabilityApplication = new busDisabilityApplication { icdoBenefitApplication = new cdoBenefitApplication() };
            busDisabiltyBenefitCalculation lbusDisabiltyBenefitCalculation = new busDisabiltyBenefitCalculation { icdoBenefitCalculationHeader = new cdoBenefitCalculationHeader() };


            if (lbusBenefitApplicationDetail.FindBenefitApplicationDetail(this.icdoPayeeAccount.benefit_application_detail_id))
            {
                lbusBenefitApplicationDetail.ibusPlanBenefitXr = new busPlanBenefitXr { icdoPlanBenefitXr = new cdoPlanBenefitXr() };
                lbusBenefitApplicationDetail.ibusPlanBenefitXr.FindPlanBenefitXr(lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.plan_benefit_id);
                lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.istrBenefitOptionValue = lbusBenefitApplicationDetail.ibusPlanBenefitXr.icdoPlanBenefitXr.benefit_option_value;

                lbusDisabilityApplication = LoadDisabilityApplication(lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.benefit_application_id);

                lbusBenefitApplicationDetail.iintPlan_ID = this.icdoPayeeAccount.iintPlanId;
                lbusBenefitApplicationDetail.istrPlanCode = lbusDisabilityApplication.ibusPerson.iclbPersonAccount.Where(item => item.icdoPersonAccount.plan_id == this.icdoPayeeAccount.iintPlanId).FirstOrDefault().icdoPersonAccount.istrPlanCode;

                lbusDisabiltyBenefitCalculation.ibusBenefitApplication = new busBenefitApplication();
                lbusDisabiltyBenefitCalculation.ibusBenefitApplication.FindBenefitApplication(lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.benefit_application_id);

                lbusDisabiltyBenefitCalculation.ibusPerson = new busPerson();
                lbusDisabiltyBenefitCalculation.ibusPerson.FindPerson(icdoPayeeAccount.person_id);
                lbusDisabiltyBenefitCalculation.ibusPerson.LoadPersonAccounts();

                this.ibusParticipant = lbusDisabiltyBenefitCalculation.ibusPerson;
                this.ibusParticipant.iclbPersonAccount = lbusDisabiltyBenefitCalculation.ibusPerson.iclbPersonAccount;

            }
            string lstrCalculationType = string.Empty;
            if (ablnRefreshCalculationFinal)
            {
                lstrCalculationType = busConstant.BenefitCalculation.CALCULATION_TYPE_FINAL;
            }
            else
            {
                lstrCalculationType = busConstant.BenefitCalculation.CALCULATION_TYPE_ADJUSTMENT;
            }

            #region Disability_Calculation_Object

            lbusDisabiltyBenefitCalculation = LoadDisabilityHeaderObject(lbusDisabilityApplication, lbusBenefitApplicationDetail, lstrCalculationType, ablnPostRetrDeath);

            #endregion

            if (!lbusDisabiltyBenefitCalculation.ibusBenefitApplication.NotEligible)
            {

                if (this.icdoPayeeAccount.iintPlanId == busConstant.IAP_PLAN_ID)
                {
                    lbusDisabiltyBenefitCalculation.iblnCalculateIAPBenefit = true;
                }
                //Ticket#67780
                //if (lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.benefit_subtype_value != ibusParticipant.iclbPersonAccount.Where(plan => plan.icdoPersonAccount.istrPlanCode ==
                //                                                                 lbusBenefitApplicationDetail.istrPlanCode).FirstOrDefault().icdoPersonAccount.istrRetirementSubType)
                //{
                //    lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.benefit_subtype_value = ibusParticipant.iclbPersonAccount.Where(plan => plan.icdoPersonAccount.istrPlanCode ==
                //                                                                 lbusBenefitApplicationDetail.istrPlanCode).FirstOrDefault().icdoPersonAccount.istrRetirementSubType;
                //    lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.Update();

                //}

                //PIR 894 //RequestID: 72091
                if (!ablnConvertBenOption && astrBenefitOptionValue == busConstant.LIFE && icdoPayeeAccount.istrOriginalBenefitOptionValue.IsNotNullOrEmpty())
                {
                    ablnConvertBenOption = true;
                }
                //RequestID: 72091
                if (ablnConvertBenOption)
                    lbusDisabiltyBenefitCalculation.SpawnFinalRetirementCalculation(lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.benefit_application_detail_id,
                                                                           lbusDisabilityApplication.ibusPerson.iclbPersonAccount.Where(item => item.icdoPersonAccount.istrPlanCode == lbusBenefitApplicationDetail.istrPlanCode).FirstOrDefault().icdoPersonAccount.person_account_id,
                                                                           lbusBenefitApplicationDetail.iintPlan_ID, lbusBenefitApplicationDetail.istrPlanCode, lbusDisabilityApplication.ibusTempPersonAccountEligibility.icdoPersonAccountEligibility.vested_date,
                                                                           lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.benefit_subtype_value, astrBenefitOptionValue, lbusDisabilityApplication.icdoBenefitApplication.retirement_date, astrIAPAdjustmentFlag: this.icdoPayeeAccount.adjustment_payment_eligible_flag, ablnConvertBenOption: ablnConvertBenOption, astrOriginalBenefitOption: icdoPayeeAccount.istrOriginalBenefitOptionValue);
                else

                    lbusDisabiltyBenefitCalculation.SpawnFinalRetirementCalculation(lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.benefit_application_detail_id,
                                                                           lbusDisabilityApplication.ibusPerson.iclbPersonAccount.Where(item => item.icdoPersonAccount.istrPlanCode == lbusBenefitApplicationDetail.istrPlanCode).FirstOrDefault().icdoPersonAccount.person_account_id,
                                                                           lbusBenefitApplicationDetail.iintPlan_ID, lbusBenefitApplicationDetail.istrPlanCode, lbusDisabilityApplication.ibusTempPersonAccountEligibility.icdoPersonAccountEligibility.vested_date,
                                                                           lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.benefit_subtype_value, astrBenefitOptionValue, lbusDisabilityApplication.icdoBenefitApplication.retirement_date, astrIAPAdjustmentFlag: this.icdoPayeeAccount.adjustment_payment_eligible_flag);




                //Ticket#67780
                //if (lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.benefit_subtype_value != ibusParticipant.iclbPersonAccount.Where(plan => plan.icdoPersonAccount.istrPlanCode ==
                //                                                             lbusBenefitApplicationDetail.istrPlanCode).FirstOrDefault().icdoPersonAccount.istrRetirementSubType)
                //{
                //    lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.benefit_subtype_value = ibusParticipant.iclbPersonAccount.Where(plan => plan.icdoPersonAccount.istrPlanCode ==
                //                                                                 lbusBenefitApplicationDetail.istrPlanCode).FirstOrDefault().icdoPersonAccount.istrRetirementSubType;

                //    lbusBenefitApplicationDetail.icdoBenefitApplicationDetail.Update();

                //}

                if (lblnDoInsert)
                {
                    lbusDisabiltyBenefitCalculation.iintOriginalPayeeAccountId = this.icdoPayeeAccount.payee_account_id;//aintOriginalPayeeAccountID;
                    lbusDisabiltyBenefitCalculation.icdoBenefitCalculationHeader.ienuObjectState = ObjectState.Insert;
                    lbusDisabiltyBenefitCalculation.PersistChanges();
                    lbusDisabiltyBenefitCalculation.AfterPersistChanges();
                }

                if (this.ibusBaseActivityInstance.IsNotNull())
                {
                    FINAL_CALCULATION_ID = lbusDisabiltyBenefitCalculation.icdoBenefitCalculationHeader.benefit_calculation_header_id;
                    this.SetProcessInstanceParameters();
                }
            }
            return lbusDisabiltyBenefitCalculation;

        }

        public busDisabilityApplication LoadDisabilityApplication(int aintbenefitapplicationid)
        {
            busDisabilityApplication lbusDisabilityApplication = new busDisabilityApplication { icdoBenefitApplication = new cdoBenefitApplication() };
            lbusDisabilityApplication.FindBenefitApplication(aintbenefitapplicationid);
            lbusDisabilityApplication.ibusPerson = new busPerson();
            lbusDisabilityApplication.ibusPerson.FindPerson(lbusDisabilityApplication.icdoBenefitApplication.person_id);
            lbusDisabilityApplication.GetAgeAtRetirement(lbusDisabilityApplication.icdoBenefitApplication.retirement_date);
            lbusDisabilityApplication.ibusPerson.LoadPersonAccounts();
            lbusDisabilityApplication.LoadandProcessWorkHistory_ForAllPlans();
            lbusDisabilityApplication.DetermineVesting();


            return lbusDisabilityApplication;
        }

        public busDisabiltyBenefitCalculation LoadDisabilityHeaderObject(busDisabilityApplication abusDisabilityApplication, busBenefitApplicationDetail abusBenefitApplicationDetail, string astrCalculationType, bool ablnPostRetrDeath = false)
        {
            busDisabiltyBenefitCalculation lbusDisabiltyBenefitCalculation = new busDisabiltyBenefitCalculation { icdoBenefitCalculationHeader = new cdoBenefitCalculationHeader() };
            lbusDisabiltyBenefitCalculation.ibusBenefitApplication = abusDisabilityApplication;
            lbusDisabiltyBenefitCalculation.ibusPerson = abusDisabilityApplication.ibusPerson;
            lbusDisabiltyBenefitCalculation.ibusPerson.iclbPersonAccount = abusDisabilityApplication.ibusPerson.iclbPersonAccount;
            lbusDisabiltyBenefitCalculation.icdoBenefitCalculationHeader.age = busGlobalFunctions.CalculatePersonAgeInDec(abusDisabilityApplication.ibusPerson.icdoPerson.idtDateofBirth, abusDisabilityApplication.icdoBenefitApplication.retirement_date);
            lbusDisabiltyBenefitCalculation.iclbBenefitCalculationDetail = new Collection<busBenefitCalculationDetail>();
            lbusDisabiltyBenefitCalculation.iclbPersonAccountRetirementContribution = new Collection<busPersonAccountRetirementContribution>();

            //Loading obj if person wud have been eligible for early retirement.
            lbusDisabiltyBenefitCalculation.ibusBenefitApplicationRetirement = new busBenefitApplication { icdoBenefitApplication = new cdoBenefitApplication() };
            lbusDisabiltyBenefitCalculation.ibusBenefitApplicationRetirement = abusDisabilityApplication;
            lbusDisabiltyBenefitCalculation.ibusBenefitApplicationRetirement.LoadWorkHistoryandSetupPrerequisites_Retirement();
            //should be removed
            lbusDisabiltyBenefitCalculation.icdoBenefitCalculationHeader.istrRetirementType = lbusDisabiltyBenefitCalculation.ibusBenefitApplicationRetirement.ibusPerson.iclbPersonAccount.Where(item => item.icdoPersonAccount.plan_id == abusBenefitApplicationDetail.iintPlan_ID).FirstOrDefault().icdoPersonAccount.istrRetirementSubType;
            lbusDisabiltyBenefitCalculation.GetEligiblityForRegularBenefit();
            if (!abusDisabilityApplication.ibusPerson.iclbPersonAccount.Where(item => item.icdoPersonAccount.plan_id == busConstant.MPIPP_PLAN_ID).IsNullOrEmpty())
            {
                lbusDisabiltyBenefitCalculation.LoadAllRetirementContributions(abusDisabilityApplication.ibusPerson.iclbPersonAccount.Where(item => item.icdoPersonAccount.plan_id == busConstant.MPIPP_PLAN_ID).FirstOrDefault());
            }
            else
            {
                lbusDisabiltyBenefitCalculation.LoadAllRetirementContributions(null);
            }

            lbusDisabiltyBenefitCalculation.PopulateInitialDataBenefitCalculationHeader(abusDisabilityApplication.ibusPerson.icdoPerson.person_id, abusDisabilityApplication.icdoBenefitApplication.benefit_application_id, abusBenefitApplicationDetail.icdoBenefitApplicationDetail.joint_annuitant_id,
                            busConstant.BENEFIT_TYPE_DISABILITY, astrCalculationType, abusDisabilityApplication.icdoBenefitApplication.retirement_date,
                            abusDisabilityApplication.idecAge, abusBenefitApplicationDetail.iintPlan_ID);
            lbusDisabiltyBenefitCalculation.SetUpDisabilityVariablesForCalculation(abusDisabilityApplication.icdoBenefitApplication.retirement_date, ablnPostRetrDeath);
            abusDisabilityApplication.CheckAlreadyVested(abusBenefitApplicationDetail.istrPlanCode);


            return lbusDisabiltyBenefitCalculation;
        }


        #endregion

        #endregion

        #region btn Convert Benefit Option

        public ArrayList btn_Convert_Benefit_Option()
        {
            FINAL_CALCULATION_ID = 0;
            utlError lobjError = null;
            if (this.iarrErrors.IsNull())
            {
                this.iarrErrors = new ArrayList();
            }


            int lintSpouseDOD = (int)DBFunction.DBExecuteScalar("cdoPayeeAccount.CheckIfSpouseIsDead", new object[1] { this.icdoPayeeAccount.benefit_application_detail_id },
                                           iobjPassInfo.iconFramework, iobjPassInfo.itrnFramework);

            if (lintSpouseDOD == 0)
            {
                lobjError = AddError(6170, " ");
                this.iarrErrors.Add(lobjError);
                return iarrErrors;
            }

            busPlanBenefitXr lbusPlanBenefitXr = new busPlanBenefitXr { icdoPlanBenefitXr = new cdoPlanBenefitXr() };
            lbusPlanBenefitXr.FindPlanBenefitXr(this.icdoPayeeAccount.plan_benefit_id);
            //IAP, LOCAL 161, LOCAL 700 have no pop up provision

            switch (lbusPlanBenefitXr.icdoPlanBenefitXr.plan_id)
            {
                #region MPI POP UP BENEFIT & LOCAL 52 POP UP BENEFIT
                case busConstant.MPIPP_PLAN_ID:
                case busConstant.LOCAL_52_PLAN_ID:
                    #region JP50 or JPOP
                    if (lbusPlanBenefitXr.icdoPlanBenefitXr.benefit_option_value == busConstant.JOINT_50_PERCENT_POPUP_ANNUITY || lbusPlanBenefitXr.icdoPlanBenefitXr.benefit_option_value == busConstant.JOINT_100_PERCENT_POPUP_ANNUITY)
                    {
                        //RequestID: 72091
                        //ReCalculateBenefitForRetirement(busConstant.LIFE_ANNUTIY, null, busConstant.BOOL_FALSE, true, false, false, null, false, true, this.icdoPayeeAccount.retirement_type_value);
                        //RID 115034
                        //DBFunction.DBExecuteScalar("cdoPayeeAccount.UpdateBenefitOptionOnConversion", new object[2] { this.icdoPayeeAccount.payee_account_id, lbusPlanBenefitXr.icdoPlanBenefitXr.plan_id }, iobjPassInfo.iconFramework, iobjPassInfo.itrnFramework);
                        //this.FindPayeeAccount(this.icdoPayeeAccount.payee_account_id);

                        //convert JS50 or JPOP to Single Life Annuity
                        //if (icdoPayeeAccount.benefit_account_type_value == busConstant.BENEFIT_TYPE_RETIREMENT)
                        //{                          
                        //    this.btn_ReCalculateBenefits();                                                        
                        //}

                        //if (icdoPayeeAccount.benefit_account_type_value == busConstant.BENEFIT_TYPE_DISABILITY)
                        //{
                        //    RecalculateParticipantDisabilityBenefits(busConstant.LIFE_ANNUTIY, true);
                        //}
                        bConvertBenefitOptionToLife = true; //RID 115034
                        this.btn_ReCalculateBenefits();
                    }
                    #endregion

                    break;
                #endregion

                #region LOCAL 600 POP UP BENEFIT
                case busConstant.LOCAL_600_PLAN_ID:
                    #region JP50
                    if (lbusPlanBenefitXr.icdoPlanBenefitXr.benefit_option_value == busConstant.JOINT_50_PERCENT_POPUP_ANNUITY)
                    {
                        //convert JS50 to Ten Years Certain and Life Amount

                        int lintPayementCount = (int)DBFunction.DBExecuteScalar("cdoPayeeAccount.GetCountOfPaymentMade",
                            new object[2] { icdoPayeeAccount.payee_account_id, this.ibusParticipant.icdoPerson.person_id }, iobjPassInfo.iconFramework,
                            iobjPassInfo.itrnFramework);

                        //PIR 894
                        if (lintPayementCount >= 120)
                        {
                            lobjError = AddError(6290, " ");
                            this.iarrErrors.Add(lobjError);
                            return iarrErrors;
                        }
                        //PIR 894
                        if (icdoPayeeAccount.benefit_account_type_value == busConstant.BENEFIT_TYPE_RETIREMENT)
                        {
                            //RequestID: 72091
                            //ReCalculateBenefitForRetirement(busConstant.LIFE_ANNUTIY, null, busConstant.BOOL_FALSE, true, false, false, null, false, true, this.icdoPayeeAccount.retirement_type_value);
                            //RID 115034
                            //DBFunction.DBExecuteScalar("cdoPayeeAccount.UpdateBenefitOptionOnConversion", new object[2] { this.icdoPayeeAccount.payee_account_id, lbusPlanBenefitXr.icdoPlanBenefitXr.plan_id }, iobjPassInfo.iconFramework, iobjPassInfo.itrnFramework);
                            //this.FindPayeeAccount(this.icdoPayeeAccount.payee_account_id);
                            bConvertBenefitOptionToLife = true; //RID 115034
                            this.btn_ReCalculateBenefits();
                        }

                        if (icdoPayeeAccount.benefit_account_type_value == busConstant.BENEFIT_TYPE_DISABILITY)
                        {
                            if (lintPayementCount >= 0)
                                RecalculateParticipantDisabilityBenefits(busConstant.TEN_YEARS_CERTAIN_AND_LIFE_ANNUTIY, true);
                            else
                            {
                                RecalculateParticipantDisabilityBenefits(busConstant.JOINT_50_PERCENT_POPUP_ANNUITY, true);
                            }
                        }
                    }
                    #endregion
                    break;
                #endregion

                #region LOCAL 666 POP UP BENEFIT
                case busConstant.LOCAL_666_PLAN_ID:
                    #region JP50
                    if (lbusPlanBenefitXr.icdoPlanBenefitXr.benefit_option_value == busConstant.JOINT_50_PERCENT_POPUP_ANNUITY)
                    {
                        //PIR 894
                        if (icdoPayeeAccount.benefit_account_type_value == busConstant.BENEFIT_TYPE_RETIREMENT)
                        {
                            //RequestID: 72091
                            //ReCalculateBenefitForRetirement(busConstant.LIFE_ANNUTIY, null, busConstant.BOOL_FALSE, true, false, false, null, false, true, this.icdoPayeeAccount.retirement_type_value);                            
                            //RID 115034
                            //DBFunction.DBExecuteScalar("cdoPayeeAccount.UpdateBenefitOptionOnConversion", new object[2] { this.icdoPayeeAccount.payee_account_id, lbusPlanBenefitXr.icdoPlanBenefitXr.plan_id }, iobjPassInfo.iconFramework, iobjPassInfo.itrnFramework);
                            //this.FindPayeeAccount(this.icdoPayeeAccount.payee_account_id);
                            bConvertBenefitOptionToLife = true; //RID 115034
                            this.btn_ReCalculateBenefits();
                        }

                        //convert JS50 to Three Years Certain and Life Amount

                        if (icdoPayeeAccount.benefit_account_type_value == busConstant.BENEFIT_TYPE_DISABILITY)
                        {
                            RecalculateParticipantDisabilityBenefits(busConstant.THREE_YEARS_CERTAIN_AND_LIFE_ANNUITY, true);
                        }
                    }
                    #endregion
                    break;
                    #endregion
            }
            // }
            //}
            bConvertBenefitOptionToLife = false; //RID 115034
            return iarrErrors;
        }



        #endregion

        #region Reemployment_Code

        public ArrayList btn_Remployment()
        {
            //AnnualReEvaluationforReEmployedBatch();
            if (this.iarrErrors.IsNull())
                this.iarrErrors = new ArrayList();

            bool lblbReemployed = false;

            //RMD72Project
            int lintPersonId = Convert.ToInt32(ibusPayee.icdoPerson.person_id);
            int lintPlanID = this.icdoPayeeAccount.iintPlanId;
            DateTime ldtDOB = Convert.ToDateTime(ibusPayee.icdoPerson.date_of_birth);
            DateTime ldtVestedDate = busGlobalFunctions.GetVestedDate(lintPersonId, lintPlanID);
            DateTime ldtMinDistributionDate = new DateTime();

            // RID# 153935 As per teresa, even if participant has differed RMD batch should use 70.5 RMD date to check for suspension.
            ldtMinDistributionDate = busGlobalFunctions.GetMinDistributionDate(ldtDOB, ldtVestedDate); //calculate MD date based on age 70.5

            //ldtMinDistributionDate = busGlobalFunctions.GetMinDistributionDate(lintPersonId, ldtVestedDate);  //calculate MD Date based on participant MD age option
            //DateTime ldt72MinDate = busGlobalFunctions.Get72MinDistributionDate(ldtDOB, ldtVestedDate); //calculate MD date based on age 70.5
            //DateTime ldtRetirementDate = this.idtRetirementDate; // Convert.ToDateTime(adtPerson["RETIREMENT_DATE"]);

            ////If participant had age 72 option but retireed before 72MD date, business asked to use 70.5 instead of if participant age 72 MD date.
            //if (ldtMinDistributionDate == ldt72MinDate && ldtRetirementDate < ldtMinDistributionDate)
            //{
            //    ldtMinDistributionDate = busGlobalFunctions.GetMinDistributionDate(ldtDOB, ldtVestedDate); //calculate MD date based on age 70.5
            //}


            //PIR 930
            //RMD72Project   replacing hard coded 70.5 with calculated MD date.
            //if (idtNextBenefitPaymentDate.Date >= new DateTime(ibusPayee.icdoPerson.date_of_birth.AddYears(70).AddMonths(6).Year + 1, 04, 01).Date)
            if (idtNextBenefitPaymentDate.Date >= ldtMinDistributionDate)
            {
                this.iarrErrors.Add(AddError(6210, ""));
                return this.iarrErrors;
            }

            if (this.icdoPayeeAccount.retirement_type_value != busConstant.RETIREMENT_TYPE_MINIMUM_DISTRIBUTION)
            {
                DataTable ldtReemployedPayeeAccounts = busBase.Select("cdoPayeeAccount.GetReEmployedParticipantInfo", new object[1] { this.icdoPayeeAccount.payee_account_id });
                if (ldtReemployedPayeeAccounts.Rows.Count > 0)
                {
                    #region Check Reemployment Rule and chnage the status and update payment item depending on Rule 3
                    EvaluateReEmployedRules(ldtReemployedPayeeAccounts.Rows[0], DateTime.Now, ref lblbReemployed);
                    #endregion
                    //2.)Initiate Workflow
                    //PIR-893
                    // busWorkflowHelper.InitializeWorkflow(busConstant.PROCESS_REEMPLOYMENT, this.icdoPayeeAccount.person_id, 0, this.icdoPayeeAccount.payee_account_id, new Hashtable());
                }
            }
            else
            {
                this.iarrErrors.Add(AddError(6210, ""));
            }
            return this.iarrErrors;
        }

        public bool CheckIfConversionRecordForReemployedParticipants()
        {
            if (this.icdoPayeeAccount.created_by == "CONVERSION")
            {
                if (this.icdoPayeeAccount.benefit_calculation_detail_id > 0)
                {
                    DataTable ldtdata = Select("cdoPayeeAccount.GetCalculationCreatedForParticipant", new object[1] { this.icdoPayeeAccount.benefit_application_detail_id });
                    if (ldtdata.Rows.Count == 1)
                    {
                        return true;
                    }
                }
            }
            return false;
        }

        public bool CheckIfCountryIsOutsideUS()
        {
            bool lendDateFlag = false;
            if (this.ibusPayee != null && this.ibusPayee.icdoPerson.person_id > 0)
            {
                this.ibusPayee.LoadPersonAddresss();
                this.LoadPayeeAccountAchDetails();


                foreach (var irow in this.iclbPayeeAccountAchDetail)
                {
                    if (irow.icdoPayeeAccountAchDetail.ach_end_date != DateTime.MinValue)
                    {
                        lendDateFlag = true;
                    }
                    else
                    {
                        return false;
                    }

                }

                if (lendDateFlag == true || this.iclbPayeeAccountAchDetail.Count() == 0)
                {
                    if (this.ibusPayee.iclbPersonAddress.Where(i => i.icdoPersonAddress.end_date == DateTime.MinValue).Count() > 0)//&& (this.iclbPayeeAccountAchDetail.Where(i=>i.icdoPayeeAccountAchDetail.ach_end_date != DateTime.MinValue).Count()>0 || this.iclbPayeeAccountAchDetail.Count() ==0))
                    {
                        if (this.ibusPayee.iclbPersonAddress.Where(i => i.icdoPersonAddress.end_date == DateTime.MinValue && i.icdoPersonAddress.addr_country_value != "0001").Count() > 0)
                        {
                            return true;
                        }

                    }

                }


            }
            return false;
        }

        #region Commented as a part of PIR 1025
        //public bool ResumeParticipantAndAlternatePayeeBenefits(DateTime adtRunDate, cdoReemploymentHistory acdoReemploymentHistory = null)
        //{
        //    if (this.ibusParticipant.IsNull())
        //    {
        //        this.ibusParticipant = new busPerson { icdoPerson = new cdoPerson() };
        //        this.ibusParticipant.FindPerson(this.icdoPayeeAccount.person_id);
        //    }

        //    this.LoadBenefitDetails();
        //    bool lblnResumeBenefits = false;
        //    //These two dates get pushed in reemployment History
        //    DateTime ldtLastWorkingDate = new DateTime();
        //    string lstrEmpName = string.Empty;
        //    Dictionary<int, Dictionary<int, decimal>> ldictHoursAfterRetirement = new Dictionary<int, Dictionary<int, decimal>>();
        //    ldictHoursAfterRetirement = ibusCalculation.LoadMPIHoursAfterRetirementDate(this.ibusParticipant.icdoPerson.istrSSNNonEncrypted, this.icdoPayeeAccount.idtRetireMentDate, this.icdoPayeeAccount.iintPlanId, ref ldtLastWorkingDate, ref lstrEmpName);

        //    //UAT PIR
        //    #region CheckEligibileForResume
        //    if (acdoReemploymentHistory.IsNull())
        //    {
        //        lblnResumeBenefits = EligibilityRulesForResumeBenefits(this.icdoPayeeAccount.reemployed_flag_as_of_date, this.icdoPayeeAccount.idtRetireMentDate, ldictHoursAfterRetirement, adtRunDate);
        //    }
        //    else
        //    {
        //        lblnResumeBenefits = true;
        //    }
        //    #endregion

        //    if (lblnResumeBenefits)
        //    {
        //        if (this.icdoPayeeAccount.reemployed_flag_as_of_date == DateTime.MinValue)
        //        {
        //            #region Update Payee Account Status
        //            busPayeeAccountStatus lbusPayeeAccountStatus = new busPayeeAccountStatus { icdoPayeeAccountStatus = new cdoPayeeAccountStatus() };
        //            lbusPayeeAccountStatus.InsertValuesInPayeeAccountStatus(this.icdoPayeeAccount.payee_account_id, busConstant.PAYEE_ACCOUNT_STATUS_REVIEW, DateTime.Now);

        //            this.icdoPayeeAccount.reemployed_flag = busConstant.FLAG_NO;
        //            this.icdoPayeeAccount.Update();
        //            #endregion
        //        }
        //        else
        //        {
        //            DateTime ldtFromDate = ibusCalculation.GetPayrollDateFromMonth(this.icdoPayeeAccount.reemployed_flag_as_of_date);
        //            #region Load-CheckReEmploymentHistory

        //            if (acdoReemploymentHistory.IsNull())
        //            {
        //                if (this.iclcReemploymentHistory.IsNullOrEmpty())
        //                {
        //                    this.LoadReemploymentHistorys();
        //                }
        //                if (!this.iclcReemploymentHistory.IsNullOrEmpty())
        //                {
        //                    DateTime ldtComparisionFromMonth = new DateTime();
        //                    DateTime ldtComparisonToMonth = new DateTime();
        //                    //Review it
        //                    DateTime ldtlastWorkingDatePayroll = ibusCalculation.GetPayrollDateFromMonth(ldtLastWorkingDate);
        //                    foreach (cdoReemploymentHistory lcdoReemploymentHistory in this.iclcReemploymentHistory)
        //                    {
        //                        ldtComparisionFromMonth = ibusCalculation.GetPayrollDateFromMonth(lcdoReemploymentHistory.reemployed_flag_from_date);
        //                        ldtComparisonToMonth = ibusCalculation.GetPayrollDateFromMonth(lcdoReemploymentHistory.reemployed_flag_to_date);
        //                        if (ldtComparisonToMonth != DateTime.MinValue)
        //                        {
        //                            if (ldtFromDate >= ldtComparisionFromMonth && ldtFromDate <= ldtComparisonToMonth && ldtlastWorkingDatePayroll <= ldtComparisonToMonth && ldtlastWorkingDatePayroll >= ldtComparisionFromMonth)
        //                            {
        //                                return false;
        //                            }
        //                        }
        //                    }
        //                }
        //            }
        //            else
        //            {
        //                ldtFromDate = new DateTime(acdoReemploymentHistory.reemployed_flag_from_date.AddYears(1).Year, 01, 01);
        //            }
        //            #endregion

        //            decimal ldecAltPayeeMeaOffset = decimal.Zero;
        //            decimal ldecAltPayeeTaxableAmount = decimal.Zero;
        //            bool lblnPayEEDerived = false;

        //            DateTime ldteLastBenefitPaymentDate = busPayeeAccountHelper.GetLastBenefitPaymentDate(this.icdoPayeeAccount.iintPlanId);
        //            LoadNextBenefitPaymentDate();
        //            DateTime ldteNextBenefitPaymentDate = this.idtNextBenefitPaymentDate;
        //            if (this.iclbPayeeAccountStatus.IsNullOrEmpty())
        //                this.LoadPayeeAccountStatuss();
        //            if (acdoReemploymentHistory.IsNull())
        //            {
        //                if (this.iclcReemploymentHistory.Where(item => item.reemployed_flag_to_date == DateTime.MinValue).Count() > 0)
        //                {
        //                    if (this.iclcReemploymentHistory.Where(item => item.reemployed_flag_to_date == DateTime.MinValue).FirstOrDefault().reemployment_reason_value == busConstant.REEMPLOYMENT_RULE_5 ||
        //                        this.iclcReemploymentHistory.Where(item => item.reemployed_flag_to_date == DateTime.MinValue).FirstOrDefault().reemployment_reason_value == busConstant.REEMPLOYMENT_RULE_3)
        //                    {
        //                        if (!this.iclbPayeeAccountStatus.IsNullOrEmpty())
        //                        {
        //                            if (this.iclbPayeeAccountStatus.FirstOrDefault().icdoPayeeAccountStatus.status_value != busConstant.PAYEE_ACCOUNT_STATUS_SUSPENDED)
        //                            {
        //                                lblnPayEEDerived = true;
        //                            }
        //                        }
        //                    }
        //                }
        //            }
        //            else
        //            {
        //                if (acdoReemploymentHistory.reemployment_reason_value == busConstant.REEMPLOYMENT_RULE_5 ||
        //                       acdoReemploymentHistory.reemployment_reason_value == busConstant.REEMPLOYMENT_RULE_3)
        //                {
        //                    if (!this.iclbPayeeAccountStatus.IsNullOrEmpty())
        //                    {
        //                        if (this.iclbPayeeAccountStatus.FirstOrDefault().icdoPayeeAccountStatus.status_value != busConstant.PAYEE_ACCOUNT_STATUS_SUSPENDED)
        //                        {
        //                            lblnPayEEDerived = true;
        //                        }
        //                    }
        //                }
        //            }
        //            if (lblnPayEEDerived)
        //            {
        //                if (this.icdoPayeeAccount.ee_derived_benefit_amount == decimal.Zero)
        //                {

        //                }
        //            }
        //            DateTime ldtToDate = ibusCalculation.GetPayrollDateFromMonth(adtRunDate);

        //            if (this.iclbPayeeAccountPaymentItemType.IsNullOrEmpty())
        //                LoadPayeeAccountPaymentItemType();

        //            #region AmountAlreadyPaidToTheParticipant
        //            Collection<busBenefitMonthwiseAdjustmentDetail> lclbBenefitMonthwiseAdjustmentDetail = new Collection<busBenefitMonthwiseAdjustmentDetail>();
        //            lclbBenefitMonthwiseAdjustmentDetail = ibusCalculation.GetAmountActuallyPaid(this, ldtFromDate, ldteLastBenefitPaymentDate);
        //            #endregion

        //            #region Get Participant's Amount
        //            decimal ldecParticipantBenefitAmount = decimal.Zero;
        //            DataTable ldtResumeBenefits = null;
        //            if (this.icdoPayeeAccount.benefit_calculation_detail_id > 0)
        //            {
        //                //DataTable ldtReemployedPayeeAccounts = busBase.Select("cdoPayeeAccount.GetReEmployedParticipantInfo", new object[1] { this.icdoPayeeAccount.payee_account_id });
        //                ldtResumeBenefits = busBase.Select("cdoPayeeAccount.ResumeBenefitToUpdatePaymentItems", new object[1] { this.icdoPayeeAccount.benefit_calculation_detail_id });
        //                if (ldtResumeBenefits.Rows.Count > 0)
        //                {
        //                    if (!string.IsNullOrEmpty(Convert.ToString(ldtResumeBenefits.Rows[0][enmBenefitCalculationOptions.overridden_benefit_amount.ToString()])))
        //                    {
        //                        ldecParticipantBenefitAmount = Convert.ToDecimal(ldtResumeBenefits.Rows[0][enmBenefitCalculationOptions.overridden_benefit_amount.ToString()]);
        //                    }
        //                    if (ldecParticipantBenefitAmount == decimal.Zero)
        //                    {
        //                        if (this.icdoPayeeAccount.benefit_account_type_value == busConstant.BENEFIT_TYPE_DISABILITY)
        //                        {
        //                            if (ldtResumeBenefits.Rows[0][enmBenefitCalculationOptions.participant_amount.ToString()].IsNotNull())
        //                            {
        //                                ldecParticipantBenefitAmount = Convert.ToDecimal(ldtResumeBenefits.Rows[0][enmBenefitCalculationOptions.participant_amount.ToString()]);
        //                            }
        //                        }
        //                        else if (this.icdoPayeeAccount.benefit_account_type_value == busConstant.BENEFIT_TYPE_RETIREMENT)
        //                        {
        //                            if (ldtResumeBenefits.Rows[0][enmBenefitCalculationOptions.benefit_amount.ToString()].IsNotNull())
        //                            {
        //                                ldecParticipantBenefitAmount = Convert.ToDecimal(ldtResumeBenefits.Rows[0][enmBenefitCalculationOptions.benefit_amount.ToString()]);
        //                            }
        //                        }
        //                    }
        //                }
        //            }
        //            else
        //            {
        //                decimal ldecTaxableAmount = decimal.Zero;
        //                decimal ldecNonTaxableAmount = decimal.Zero;
        //                iclbPayeeAccountPaymentItemTypeActive = (from item in this.iclbPayeeAccountPaymentItemType
        //                                                         where busGlobalFunctions.CheckDateOverlapping(idtNextBenefitPaymentDate,
        //                                                         item.icdoPayeeAccountPaymentItemType.start_date, item.icdoPayeeAccountPaymentItemType.end_date)
        //                                                         select item).ToList().ToCollection<busPayeeAccountPaymentItemType>();
        //                if (lblnPayEEDerived)
        //                {
        //                    busPayeeAccountPaymentItemType lbusPayeeAccountPayementItemTypeInsert = null;
        //                    if (!iclbPayeeAccountPaymentItemType.IsNullOrEmpty())
        //                    {
        //                        lbusPayeeAccountPayementItemTypeInsert = this.iclbPayeeAccountPaymentItemType.OrderByDescending(item => item.icdoPayeeAccountPaymentItemType.end_date).Where(item => item.icdoPayeeAccountPaymentItemType.end_date != DateTime.MinValue && item.ibusPaymentItemType.icdoPaymentItemType.item_type_code == busConstant.ITEM1).FirstOrDefault();
        //                    }
        //                    ibusCalculation.GetTaxableAndNonTaxableAmountFromPaymentItemTypes(this, out ldecTaxableAmount, out ldecNonTaxableAmount);


        //                    ldecParticipantBenefitAmount = ldecNonTaxableAmount + lbusPayeeAccountPayementItemTypeInsert.icdoPayeeAccountPaymentItemType.amount;
        //                }

        //            }
        //            #endregion

        //            #region ResumeAlternatePayeeBenefits
        //            ResumeBenefitsForRetireeModelAlternatePayeeInReEmployedStatus(ldictHoursAfterRetirement, lblnPayEEDerived, lclbBenefitMonthwiseAdjustmentDetail, ldteNextBenefitPaymentDate, ldtFromDate, ldteLastBenefitPaymentDate, ldecParticipantBenefitAmount, out ldecAltPayeeMeaOffset, out ldecAltPayeeTaxableAmount);
        //            #endregion

        //            #region Amount Should Have been Paid to the participant

        //            #endregion

        //            #region ResumeParticipantBenefits
        //            bool lblnCalculateUnderOverPayment = false;
        //            if (!lclbBenefitMonthwiseAdjustmentDetail.IsNullOrEmpty())
        //            {
        //                lblnCalculateUnderOverPayment = true;
        //            }
        //            // Active Payee Account Payment Item type
        //            if (this.icdoPayeeAccount.benefit_calculation_detail_id > 0)
        //            {
        //                //DataTable ldtReemployedPayeeAccounts = busBase.Select("cdoPayeeAccount.GetReEmployedParticipantInfo", new object[1] { this.icdoPayeeAccount.payee_account_id });
        //                //DataTable ldtResumeBenefits = busBase.Select("cdoPayeeAccount.ResumeBenefitToUpdatePaymentItems", new object[1] { this.icdoPayeeAccount.benefit_calculation_detail_id });
        //                if (ldtResumeBenefits.Rows.Count > 0)
        //                {
        //                    if (this.icdoPayeeAccount.nontaxable_beginning_balance > 0)
        //                        UpdatePaymentItemsFromResumeBenefits(ldictHoursAfterRetirement, ldtResumeBenefits.Rows[0], lclbBenefitMonthwiseAdjustmentDetail, this.icdoPayeeAccount.nontaxable_beginning_balance, ldecAltPayeeMeaOffset, ldecAltPayeeTaxableAmount, lblnPayEEDerived, lblnCalculateUnderOverPayment);
        //                    else
        //                        UpdatePaymentItemsFromResumeBenefits(ldictHoursAfterRetirement, ldtResumeBenefits.Rows[0], lclbBenefitMonthwiseAdjustmentDetail, this.icdoPayeeAccount.remaining_non_taxable_from_conversion, ldecAltPayeeMeaOffset, ldecAltPayeeTaxableAmount, lblnPayEEDerived, lblnCalculateUnderOverPayment);

        //                    if (this.idtNextBenefitPaymentDate == DateTime.MinValue)
        //                        this.idtNextBenefitPaymentDate = ldteNextBenefitPaymentDate;
        //                    this.ProcessTaxWithHoldingDetails();
        //                    //ResumeBenefits(ldtReemployedPayeeAccounts.Rows[0], DateTime.Now);
        //                }
        //            }
        //            else
        //            {
        //                decimal ldecTaxableAmount = decimal.Zero;
        //                decimal ldecNonTaxableAmount = decimal.Zero;
        //                if (this.idtNextBenefitPaymentDate == DateTime.MinValue)
        //                {
        //                    this.idtNextBenefitPaymentDate = ldteNextBenefitPaymentDate;
        //                }

        //                if (lblnPayEEDerived)
        //                {

        //                    iclbPayeeAccountPaymentItemTypeActive = (from item in this.iclbPayeeAccountPaymentItemType
        //                                                             where busGlobalFunctions.CheckDateOverlapping(idtNextBenefitPaymentDate,
        //                                                             item.icdoPayeeAccountPaymentItemType.start_date, item.icdoPayeeAccountPaymentItemType.end_date)
        //                                                             select item).ToList().ToCollection<busPayeeAccountPaymentItemType>();

        //                    busPayeeAccountPaymentItemType lbusPayeeAccountPayementItemTypeInsert;
        //                    if (!iclbPayeeAccountPaymentItemType.IsNullOrEmpty())
        //                    {
        //                        lbusPayeeAccountPayementItemTypeInsert = this.iclbPayeeAccountPaymentItemType.OrderByDescending(item => item.icdoPayeeAccountPaymentItemType.end_date).Where(item => item.icdoPayeeAccountPaymentItemType.end_date != DateTime.MinValue && item.ibusPaymentItemType.icdoPaymentItemType.item_type_code == busConstant.ITEM1).FirstOrDefault();
        //                        CreatePayeeAccountPaymentItemType(busConstant.ITEM1, lbusPayeeAccountPayementItemTypeInsert.icdoPayeeAccountPaymentItemType.amount, "0", 0, this.idtNextBenefitPaymentDate, DateTime.MinValue, "N", false);
        //                    }
        //                }
        //                ldecTaxableAmount = decimal.Zero;
        //                ldecNonTaxableAmount = decimal.Zero;
        //                ibusCalculation.GetTaxableAndNonTaxableAmountFromPaymentItemTypes(this, out ldecTaxableAmount, out ldecNonTaxableAmount);
        //                #region Update Payee Account Status
        //                busPayeeAccountStatus lbusPayeeAccountStatus = new busPayeeAccountStatus { icdoPayeeAccountStatus = new cdoPayeeAccountStatus() };
        //                lbusPayeeAccountStatus.InsertValuesInPayeeAccountStatus(this.icdoPayeeAccount.payee_account_id, busConstant.PAYEE_ACCOUNT_STATUS_REVIEW, DateTime.Now);
        //                #endregion
        //                if (lblnCalculateUnderOverPayment)
        //                {
        //                    CreateOverPaymentForReEmploymemt(ldictHoursAfterRetirement, lclbBenefitMonthwiseAdjustmentDetail, lblnPayEEDerived, ldecNonTaxableAmount, this.icdoPayeeAccount.ee_derived_benefit_amount, ldecTaxableAmount + ldecNonTaxableAmount);
        //                }

        //                this.ProcessTaxWithHoldingDetails();
        //            }
        //            #endregion

        //            #region UpdateReemploymentHistory
        //            if (acdoReemploymentHistory.IsNull())
        //            {
        //                this.icdoPayeeAccount.reemployed_flag = busConstant.FLAG_NO;
        //                this.icdoPayeeAccount.reemployed_flag_as_of_date = DateTime.MinValue;
        //                this.icdoPayeeAccount.Update();

        //                cdoReemploymentHistory lcdoLatestReemploymentHistory = new cdoReemploymentHistory();
        //                if (this.iclcReemploymentHistory.Where(item => item.resume_benefit_date == DateTime.MinValue).Count() > 0)
        //                {
        //                    lcdoLatestReemploymentHistory = this.iclcReemploymentHistory.Where(item => item.resume_benefit_date == DateTime.MinValue).FirstOrDefault();
        //                    lcdoLatestReemploymentHistory.resume_benefit_date = ldteNextBenefitPaymentDate;
        //                    lcdoLatestReemploymentHistory.reemployed_flag_to_date = ldtLastWorkingDate;
        //                    lcdoLatestReemploymentHistory.Update();
        //                }
        //            }

        //            #endregion

        //        }
        //    }
        //    return lblnResumeBenefits;
        //}
        #endregion Commented as a part of PIR 1025

        public busReemploymentHistory InsertInReemploymentHistory(DateTime adtReemployedFlagFromDate, DateTime adtReemployedFlagToDate, DateTime adtResumeBenefitDate, string astrReemploymentRule, int aintPayeeAccountID, decimal adecSupportAmount, string astrSupport)
        {
            busReemploymentHistory lbusReemploymentHistory = new busReemploymentHistory { icdoReemploymentHistory = new cdoReemploymentHistory() };

            lbusReemploymentHistory.icdoReemploymentHistory.payee_account_id = aintPayeeAccountID;
            lbusReemploymentHistory.icdoReemploymentHistory.reemployed_flag_from_date = adtReemployedFlagFromDate;
            lbusReemploymentHistory.icdoReemploymentHistory.support_deduction_amount = adecSupportAmount;
            lbusReemploymentHistory.icdoReemploymentHistory.support_deduction_item_code = astrSupport;

            lbusReemploymentHistory.icdoReemploymentHistory.created_by = this.iobjPassInfo.istrUserID;
            lbusReemploymentHistory.icdoReemploymentHistory.created_date = DateTime.Now;
            lbusReemploymentHistory.icdoReemploymentHistory.modified_by = this.iobjPassInfo.istrUserID;
            lbusReemploymentHistory.icdoReemploymentHistory.modified_date = DateTime.Now;
            lbusReemploymentHistory.icdoReemploymentHistory.update_seq = 0;
            if (!string.IsNullOrEmpty(astrReemploymentRule))
            {
                lbusReemploymentHistory.icdoReemploymentHistory.reemployment_reason_value = astrReemploymentRule;
            }
            if (adtReemployedFlagToDate != DateTime.MinValue)
            {
                lbusReemploymentHistory.icdoReemploymentHistory.reemployed_flag_to_date = adtReemployedFlagToDate;
            }
            if (lbusReemploymentHistory.icdoReemploymentHistory.resume_benefit_date != DateTime.MinValue)
            {
                lbusReemploymentHistory.icdoReemploymentHistory.resume_benefit_date = adtResumeBenefitDate;
            }

            lbusReemploymentHistory.icdoReemploymentHistory.Insert();

            return lbusReemploymentHistory;

        }

        public void GetDroRetireeModelsForParticipant(string astrReemployedRule, decimal adecEEDerivedAmount, decimal adecMea, DateTime adtReemployedAsofDate, DateTime adtBatchRunDate, out decimal adecAPMea, out decimal adecAPEEDerivedTaxable, int aintPlanId, int aintJobScheduleId = 0)
        {

            adecAPMea = decimal.Zero;
            adecAPEEDerivedTaxable = decimal.Zero;

            busPayeeAccountStatus lbusPayeeAccountStatus;
            busPayeeAccount lbusPayeeAccount;
            //PIR-893
            DataTable ldtDroApp = Select("cdoDroBenefitDetails.GetPayeeAccountsBenefitTypeForRetireeModel", new object[3] { this.icdoPayeeAccount.benefit_account_type_value, this.icdoPayeeAccount.benefit_begin_date, this.icdoPayeeAccount.person_id });
            if (ldtDroApp.Rows.Count > 0)
            {
                foreach (DataRow ldtRow in ldtDroApp.Rows)
                {
                    lbusPayeeAccount = new busPayeeAccount { icdoPayeeAccount = new cdoPayeeAccount() };
                    lbusPayeeAccount.icdoPayeeAccount.LoadData(ldtRow);
                    lbusPayeeAccountStatus = new busPayeeAccountStatus { icdoPayeeAccountStatus = new cdoPayeeAccountStatus() };
                    string lstrCorrespondenceRule = string.Empty;

                    if (astrReemployedRule == busConstant.REEMPLOYMENT_RULE_1)
                    {
                        lbusPayeeAccountStatus.InsertValuesInPayeeAccountStatus(lbusPayeeAccount.icdoPayeeAccount.payee_account_id, busConstant.PAYEE_ACCOUNT_STATUS_SUSPENDED, DateTime.Now, busConstant.PAYEE_ACCOUNT_SUSPENSION_REASON_REEMPLOYED_RULE_1, aintJobScheduleId: aintJobScheduleId);
                    }
                    else if (astrReemployedRule == busConstant.REEMPLOYMENT_RULE_2)
                    {
                        lbusPayeeAccountStatus.InsertValuesInPayeeAccountStatus(lbusPayeeAccount.icdoPayeeAccount.payee_account_id, busConstant.PAYEE_ACCOUNT_STATUS_SUSPENDED, DateTime.Now, busConstant.PAYEE_ACCOUNT_SUSPENSION_REASON_REEMPLOYED_RULE_2, aintJobScheduleId: aintJobScheduleId);
                    }
                    else if (astrReemployedRule == busConstant.REEMPLOYMENT_RULE_3)
                    {
                        #region  EE Derived Benefit Calculation Code - Removed as a part of fix for PIR 1051

                        //decimal ldecParticipantTaxableAmt = decimal.Zero;
                        //decimal ldecParticipantNonTaxableAmt = decimal.Zero;

                        //decimal ldecAPTaxableAmt = decimal.Zero;
                        //decimal ldecAPNonTaxableAmt = decimal.Zero;

                        //ibusCalculation.GetTaxableAndNonTaxableAmountFromPaymentItemTypes(this, out ldecParticipantTaxableAmt, out ldecParticipantNonTaxableAmt);
                        //ibusCalculation.GetTaxableAndNonTaxableAmountFromPaymentItemTypes(this, out ldecAPTaxableAmt, out ldecAPNonTaxableAmt);

                        //if (ldecParticipantTaxableAmt + ldecParticipantNonTaxableAmt + ldecAPNonTaxableAmt + ldecAPTaxableAmt > decimal.Zero)
                        //{
                        //    ldecAPBenefitFraction = Math.Round((ldecAPTaxableAmt + ldecAPNonTaxableAmt) / (ldecParticipantTaxableAmt + ldecParticipantNonTaxableAmt + ldecAPNonTaxableAmt + ldecAPTaxableAmt), 3);
                        //}

                        //ldecAPMea = adecMea * ldecAPBenefitFraction;
                        //ldecAPEeDerivedTaxable = adecEEDerivedAmount * ldecAPBenefitFraction;
                        //adecAPMea += ldecAPMea;
                        //adecAPEEDerivedTaxable += ldecAPEeDerivedTaxable;
                        //CheckForChildSupportOrSpousalForAlternatepayee(out lstrChildSupportSpousal, out ldecChildSupportSpousalAmount);
                        //DateTime ldteNextBenefitPaymentDate = busPayeeAccountHelper.GetLastBenefitPaymentDate(this.icdoPayeeAccount.iintPlanId).AddMonths(1);

                        //InsertNewPaymentItemTypes(ldecAPEeDerivedTaxable, ldecAPMea, ldecChildSupportSpousalAmount, ldteNextBenefitPaymentDate, lstrChildSupportSpousal);

                        //if (adecEEDerivedAmount > decimal.Zero)
                        //{
                        //    lbusPayeeAccount.CreateReviewPayeeAccountStatus();
                        //}
                        //else
                        //{
                        //    lbusPayeeAccountStatus.InsertValuesInPayeeAccountStatus(lbusPayeeAccount.icdoPayeeAccount.payee_account_id, busConstant.PAYEE_ACCOUNT_STATUS_SUSPENDED, DateTime.Now, busConstant.PAYEE_ACCOUNT_SUSPENSION_REASON_REEMPLOYED_RULE_3);
                        //}

                        #endregion  EE Derived Benefit Calculation Code - Removed as a part of fix for PIR 1051

                        lbusPayeeAccountStatus.InsertValuesInPayeeAccountStatus(lbusPayeeAccount.icdoPayeeAccount.payee_account_id, busConstant.PAYEE_ACCOUNT_STATUS_SUSPENDED, DateTime.Now, busConstant.PAYEE_ACCOUNT_SUSPENSION_REASON_REEMPLOYED_RULE_3, aintJobScheduleId: aintJobScheduleId);
                    }

                    #region Removed as a part of fix for PIR 1051
                    //else if (astrReemployedRule == busConstant.REEMPLOYMENT_RULE_4)
                    //{
                    //    lbusPayeeAccountStatus.InsertValuesInPayeeAccountStatus(lbusPayeeAccount.icdoPayeeAccount.payee_account_id, busConstant.PAYEE_ACCOUNT_STATUS_SUSPENDED, DateTime.Now, busConstant.PAYEE_ACCOUNT_SUSPENSION_REASON_REEMPLOYED_RULE_4);
                    //}
                    //else if (astrReemployedRule == busConstant.REEMPLOYMENT_RULE_5)
                    //{
                    //    decimal ldecParticipantTaxableAmt = decimal.Zero;
                    //    decimal ldecParticipantNonTaxableAmt = decimal.Zero;

                    //    decimal ldecAPTaxableAmt = decimal.Zero;
                    //    decimal ldecAPNonTaxableAmt = decimal.Zero;

                    //    ibusCalculation.GetTaxableAndNonTaxableAmountFromPaymentItemTypes(this, out ldecParticipantTaxableAmt, out ldecParticipantNonTaxableAmt);
                    //    ibusCalculation.GetTaxableAndNonTaxableAmountFromPaymentItemTypes(this, out ldecAPTaxableAmt, out ldecAPNonTaxableAmt);

                    //    if (ldecParticipantTaxableAmt + ldecParticipantNonTaxableAmt + ldecAPNonTaxableAmt + ldecAPTaxableAmt > decimal.Zero)
                    //    {
                    //        ldecAPBenefitFraction = Math.Round((ldecAPTaxableAmt + ldecAPNonTaxableAmt) / (ldecParticipantTaxableAmt + ldecParticipantNonTaxableAmt + ldecAPNonTaxableAmt + ldecAPTaxableAmt), 3);
                    //    }



                    //    ldecAPEeDerivedTaxable = adecEEDerivedAmount * ldecAPBenefitFraction;
                    //    adecAPMea += ldecAPMea;
                    //    adecAPEEDerivedTaxable += ldecAPEeDerivedTaxable;
                    //    CheckForChildSupportOrSpousalForAlternatepayee(out lstrChildSupportSpousal, out ldecChildSupportSpousalAmount);
                    //    DateTime ldteNextBenefitPaymentDate = busPayeeAccountHelper.GetLastBenefitPaymentDate(this.icdoPayeeAccount.iintPlanId).AddMonths(1);
                    //    InsertNewPaymentItemTypes(ldecAPEeDerivedTaxable, ldecAPMea, ldecChildSupportSpousalAmount, ldteNextBenefitPaymentDate, lstrChildSupportSpousal);
                    //    if (adecEEDerivedAmount > decimal.Zero)
                    //    {
                    //        lbusPayeeAccount.CreateReviewPayeeAccountStatus();
                    //    }
                    //    else
                    //    {
                    //        lbusPayeeAccountStatus.InsertValuesInPayeeAccountStatus(lbusPayeeAccount.icdoPayeeAccount.payee_account_id, busConstant.PAYEE_ACCOUNT_STATUS_SUSPENDED, DateTime.Now, busConstant.PAYEE_ACCOUNT_SUSPENSION_REASON_REEMPLOYED_RULE_3);

                    //    }
                    //}
                    #endregion Removed as a part of fix for PIR 1051

                    else if (astrReemployedRule == "REED")
                    {
                        lbusPayeeAccountStatus.InsertValuesInPayeeAccountStatus(lbusPayeeAccount.icdoPayeeAccount.payee_account_id, busConstant.PAYEE_ACCOUNT_STATUS_SUSPENDED, DateTime.Now, "REED", aintJobScheduleId: aintJobScheduleId);
                    }
                    #region UpdatePayeeAccount/History
                    lbusPayeeAccount.icdoPayeeAccount.reemployed_flag = busConstant.FLAG_YES;
                    if (astrReemployedRule != "REED")
                    {
                        lbusPayeeAccount.icdoPayeeAccount.accrued_benefit_to_be_paid_reeval_flag = busConstant.FLAG_YES;
                    }
                    lbusPayeeAccount.icdoPayeeAccount.Update();

                    #endregion

                }
            }
        }

        //1.) EADB = TRUE : a) Check If benefits are resumed for the participant.
        // b.) if yes check if late hours reported create overpayment , under payment
        // c.) if no 
        public string EvaluateReEmployedRules(DataRow adtPerson, DateTime adtBatchRunDate, ref bool ablnReemployed, bool ablnRunFromBatch = false, int aintJobScheduleId = 0)
        {
            string lstrRuleCorrespondence = string.Empty;
            string lstrReemploymentRule = string.Empty;
            decimal ldecTotalMEA = decimal.Zero;
            decimal ldecTotalTaxable = decimal.Zero;
            int lintBenefitAppID;
            int lintBenefitCalculationHeaderId = 0;
            int lintPersonAccountID;
            int lintBenefeciaryPersonID = 0;

            string lstrSSN = string.Empty;
            DateTime ldtRetirementDate = new DateTime();
            DateTime ldtDOB = new DateTime();
            DateTime ldtDisabilityCertificationDate = new DateTime();
            DateTime ldtBenDOB = new DateTime();

            decimal ldecAge = decimal.Zero;
            decimal ldecAgeIndec = decimal.Zero;
            decimal ldecBeneficiaryAgeAtRetr = decimal.Zero;

            string lstrBenefitTypeValue = string.Empty;
            string lstrBenefitSubTypeValue = string.Empty;
            string lstrBenefitOptionValue = string.Empty;
            string lstrDecryptedDOB = string.Empty;

            string lstrDisabilityConversionFlag = busConstant.FLAG_NO;
            bool lblnMarkReemployed = false;
            decimal ldecVestedEEContributions = decimal.Zero;
            decimal ldecVestedEEInterest = decimal.Zero;
            decimal ldecEEDerivedBenefit = decimal.Zero;
            int lintPlanID = this.icdoPayeeAccount.iintPlanId;
            busPayeeAccountStatus lbusPayeeAccountStatus = null;


            DateTime ldt1986Date = new DateTime(1986, 08, 01);

            lstrSSN = Convert.ToString(adtPerson[enmPerson.ssn.ToString()]);
            ldtRetirementDate = Convert.ToDateTime(adtPerson[enmBenefitApplication.retirement_date.ToString()]);
            ldtDOB = Convert.ToDateTime(adtPerson[enmPerson.date_of_birth.ToString()]);
            lstrBenefitTypeValue = Convert.ToString(adtPerson[enmBenefitApplication.benefit_type_value.ToString()]);
            lstrBenefitSubTypeValue = Convert.ToString(adtPerson[enmBenefitApplicationDetail.benefit_subtype_value.ToString()]);
            lstrDisabilityConversionFlag = Convert.ToString(adtPerson[enmPayeeAccount.disability_conversion_flag.ToString()]);
            lintBenefitAppID = Convert.ToInt32(adtPerson[enmBenefitApplication.benefit_application_id.ToString()]);
            if (!string.IsNullOrEmpty(Convert.ToString(adtPerson[enmBenefitCalculationHeader.benefit_calculation_header_id.ToString()])))
            {
                lintBenefitCalculationHeaderId = Convert.ToInt32(adtPerson[enmBenefitCalculationHeader.benefit_calculation_header_id.ToString()]);
            }
            if (!string.IsNullOrEmpty(Convert.ToString(adtPerson[enmBenefitApplicationDetail.joint_annuitant_id.ToString()])))
            {
                lintBenefeciaryPersonID = Convert.ToInt32(adtPerson[enmBenefitApplicationDetail.joint_annuitant_id.ToString()]);
                if (!string.IsNullOrEmpty(Convert.ToString(adtPerson["BEN_DOB"])))
                {
                    lstrDecryptedDOB = Convert.ToString(adtPerson["BEN_DOB"]);
                    if (!string.IsNullOrEmpty(lstrDecryptedDOB))
                    {
                        ldtBenDOB = Convert.ToDateTime(lstrDecryptedDOB);
                        ldecBeneficiaryAgeAtRetr = busGlobalFunctions.CalculatePersonAge(ldtBenDOB, ldtRetirementDate);
                    }
                }
            }
            lintPersonAccountID = Convert.ToInt32(adtPerson[enmPersonAccount.person_account_id.ToString()]);
            ldtDisabilityCertificationDate = this.icdoPayeeAccount.benefit_begin_date;
            ldecAge = busGlobalFunctions.CalculatePersonAge(ldtDOB, adtBatchRunDate);
            ldecAgeIndec = busGlobalFunctions.CalculatePersonAgeInDec(ldtDOB, ldtRetirementDate);
            lintPlanID = Convert.ToInt32(adtPerson[enmPlanBenefitXr.plan_id.ToString()]);
            lstrBenefitOptionValue = Convert.ToString(adtPerson[enmPlanBenefitXr.benefit_option_value.ToString()]);

            #region EE Derived Benefit Calculation Code - Removed as a part of fix for PIR 1051
            //ldecEEDerivedBenefit = this.icdoPayeeAccount.ee_derived_benefit_amount;

            //if (lintPlanID == busConstant.MPIPP_PLAN_ID && this.icdoPayeeAccount.ee_derived_benefit_amount == decimal.Zero)
            //{
            //    if (!string.IsNullOrEmpty(Convert.ToString(adtPerson[enmPayeeBenefitAccount.starting_nontaxable_amount.ToString()])))
            //    {
            //        ldecVestedEEContributions = Convert.ToDecimal(adtPerson[enmPayeeBenefitAccount.starting_nontaxable_amount.ToString()]);
            //    }
            //    if (!string.IsNullOrEmpty(Convert.ToString(adtPerson[enmPayeeBenefitAccount.starting_taxable_amount.ToString()])))
            //    {
            //        ldecVestedEEInterest = Convert.ToDecimal(adtPerson[enmPayeeBenefitAccount.starting_taxable_amount.ToString()]);
            //    }
            //    if (lintBenefitCalculationHeaderId > 0)
            //    {
            //        if (!string.IsNullOrEmpty(Convert.ToString(adtPerson[enmBenefitCalculationDetail.ee_derived_benefit_amount.ToString()])))
            //        {
            //            ldecEEDerivedBenefit = GetEEDerivedToBePaid(Convert.ToDecimal(adtPerson[enmBenefitCalculationDetail.ee_derived_benefit_amount.ToString()])
            //                 , lstrBenefitSubTypeValue, ldecAgeIndec, ldecBeneficiaryAgeAtRetr);


            //        }
            //    }
            //    else
            //    {
            //        if (ldecVestedEEContributions + ldecVestedEEInterest == decimal.Zero)
            //        {
            //            DataTable ldtbEEAmtAndEEContribution = busBase.Select("cdoPersonAccountRetirementContribution.GetVestedEEContribution", new object[1] { lintPersonAccountID });
            //            if (ldtbEEAmtAndEEContribution.IsNotNull() && ldtbEEAmtAndEEContribution.Rows.Count > 0 && ldtbEEAmtAndEEContribution.Rows[0][0] != DBNull.Value)
            //            {
            //                ldecVestedEEContributions = Convert.ToDecimal(ldtbEEAmtAndEEContribution.Rows[0]["EE_CONTRIBUTION_AMOUNT"]);
            //                ldecVestedEEInterest = Convert.ToDecimal(ldtbEEAmtAndEEContribution.Rows[0]["EE_INT_AMOUNT"]);
            //            }
            //        }
            //        if (ldecVestedEEContributions + ldecVestedEEInterest > decimal.Zero)
            //        {
            //            ldecEEDerivedBenefit = GetEEDerivedBenefit(ldecVestedEEContributions + ldecVestedEEInterest, ldecAgeIndec, ldtRetirementDate, lstrBenefitSubTypeValue, ldecBeneficiaryAgeAtRetr);
            //        }
            //    }
            //    this.icdoPayeeAccount.ee_derived_benefit_amount = ldecEEDerivedBenefit;
            //}
            #endregion EE Derived Benefit Calculation Code - Removed as a part of fix for PIR 1051

            if (this.icdoPayeeAccount.reemployed_flag_as_of_date != DateTime.MinValue && ((this.icdoPayeeAccount.reemployed_flag_from_eadb == busConstant.FLAG_YES && ablnRunFromBatch && (lintPlanID == busConstant.MPIPP_PLAN_ID || lintPlanID == busConstant.IAP_PLAN_ID)) || (lintPlanID != busConstant.MPIPP_PLAN_ID && !ablnRunFromBatch)))
            {
                #region Load Hours
                utlConnection utlLegacyDBConnetion = HelperFunction.GetDBConnectionProperties("Legacy");
                string lstrLegacyDBConnetion = utlLegacyDBConnetion.istrConnectionString;

                SqlParameter[] lsqlParameters = new SqlParameter[2];
                SqlParameter param1 = new SqlParameter("@SSN", DbType.String);
                SqlParameter param2 = new SqlParameter("@RETIREMENT_DATE", DbType.DateTime);

                param1.Value = lstrSSN;
                lsqlParameters[0] = param1;

                param2.Value = ldtRetirementDate;
                lsqlParameters[1] = param2;

                DateTime ldtLastWorkingDate = new DateTime();
                string lstrEmpName = string.Empty;
                int lintReemployedYear = 0;
                if (this.icdoPayeeAccount.reemployed_flag_as_of_date != DateTime.MinValue)
                {
                    lintReemployedYear = adtBatchRunDate.Year;
                }
                Dictionary<int, Dictionary<int, decimal>> ldictHoursAfterRetirement = new Dictionary<int, Dictionary<int, decimal>>();
                ldictHoursAfterRetirement = ibusCalculation.LoadMPIHoursAfterRetirementDate(lstrSSN, ldtRetirementDate, lintPlanID, ref ldtLastWorkingDate, ref lstrEmpName, lintReemployedYear);
                this.istrEmployerName = lstrEmpName;
                #endregion

                if (ldictHoursAfterRetirement.Count > 0)
                {
                    decimal ldecHoursAccToRule = decimal.Zero;
                    DateTime ldtRuleDate = new DateTime();

                    #region LoadReEmploymentHistory

                    if (this.iclcReemploymentHistory.IsNullOrEmpty())
                    {
                        this.LoadReemploymentHistorys();
                    }
                    #endregion

                    //Check with Sid/Vino for conversion.
                    #region Check If Date is Late Hours Date
                    DateTime ldtFromDate = new DateTime();
                    DateTime ldtAdjustFromDate = new DateTime();
                    DateTime ldtAdjustToDate = new DateTime();
                    cdoReemploymentHistory lcdoReemploymentHistory = GetParametersForReEmploymentAsOfDate(this.icdoPayeeAccount.reemployed_flag_as_of_date, ldtRetirementDate, ldictHoursAfterRetirement, adtBatchRunDate, ldtLastWorkingDate, out ldtFromDate, out ldtAdjustFromDate, out ldtAdjustToDate);
                    #endregion


                    if (this.icdoPayeeAccount.reemployed_flag_from_eadb == busConstant.FLAG_YES || !ablnRunFromBatch)
                    {

                        if (ldtFromDate != DateTime.MinValue)
                        {
                            #region Check If LumpSum Paid Out
                            bool lblnLumpSumPaidOut = false;
                            decimal ldecAmount = decimal.Zero;
                            if (lstrBenefitOptionValue == busConstant.LUMP_SUM)
                            {
                                DataTable ldtTable = Select("cdoPaymentHistoryHeader.GetLumpSumAmountPaidOut", new object[1] { this.icdoPayeeAccount.payee_account_id });
                                if (ldtTable.Rows.Count > 0)
                                {
                                    ldecAmount = Convert.ToDecimal(ldtTable.Rows[0][0]);
                                    if (ldecAmount > 0)
                                    {
                                        lblnLumpSumPaidOut = true;
                                    }
                                }
                            }
                            #endregion

                            //Ref : Mail
                            //Payee Account with Lump sum and getting re-employed :- We need to suspend his benefits if the 
                            //benefits are not paid. If paid, just mark the payee for re-evaluation. On re-evaluation batch when 
                            //we create new calculation, check whether we paid the participant or not.
                            //If paid, only the re-employed accrued benefit will be paid to participant.

                            #region Evaluate Re-Employment Rules
                            if ((ablnRunFromBatch || lintPlanID != busConstant.MPIPP_PLAN_ID))
                            {
                                lblnMarkReemployed = CheckReEmploymentRules(ldtFromDate, ldtRetirementDate, adtBatchRunDate, ldtDisabilityCertificationDate, ldictHoursAfterRetirement, ldecAge, ldecAgeIndec,
                                    ldecVestedEEInterest, ldecVestedEEContributions, ldecEEDerivedBenefit, lstrBenefitTypeValue, lstrBenefitSubTypeValue, lstrBenefitOptionValue,
                                    lintBenefitAppID, lintPlanID, ref lstrRuleCorrespondence, ref lstrReemploymentRule, lblnLumpSumPaidOut, aintJobScheduleId: aintJobScheduleId);
                            }
                            else
                            {
                                lblnMarkReemployed = true;
                            }

                            #endregion                                                  

                            #region Update_Payee_Account_Check_Reemployment_Flag
                            if (lblnMarkReemployed && ldtRetirementDate > ldt1986Date)
                            {
                                this.icdoPayeeAccount.reemployed_flag = busConstant.FLAG_YES;
                                this.icdoPayeeAccount.accrued_benefit_to_be_paid_reeval_flag = busConstant.FLAG_YES;
                                this.icdoPayeeAccount.reemployed_flag_from_eadb = busConstant.FLAG_NO;
                                this.icdoPayeeAccount.Update();
                            }
                            #endregion

                        }
                        else
                        {
                            #region Rule 2
                            lblnMarkReemployed = CheckReEmploymentRules(this.icdoPayeeAccount.reemployed_flag_as_of_date, ldtRetirementDate, adtBatchRunDate, ldtDisabilityCertificationDate, ldictHoursAfterRetirement, ldecAge, ldecAgeIndec,
                                        ldecVestedEEInterest, ldecVestedEEContributions, ldecEEDerivedBenefit, lstrBenefitTypeValue, lstrBenefitSubTypeValue, lstrBenefitOptionValue,
                                        lintBenefitAppID, lintPlanID, ref lstrRuleCorrespondence, ref lstrReemploymentRule, false, false, ablnCheckOnlyForRule2: true, aintJobScheduleId : aintJobScheduleId);
                            #endregion

                            #region Adjustment
                            if (!lblnMarkReemployed)
                            {
                                if (ldtRetirementDate > ldt1986Date)
                                {
                                    this.icdoPayeeAccount.accrued_benefit_to_be_paid_reeval_flag = busConstant.FLAG_YES;
                                    this.icdoPayeeAccount.reemployed_flag_from_eadb = busConstant.FLAG_NO;
                                    this.icdoPayeeAccount.reemployed_flag = busConstant.FLAG_NO;
                                    this.icdoPayeeAccount.reemployed_flag_as_of_date = DateTime.MinValue;
                                    this.icdoPayeeAccount.Update();
                                }

                                //BR : 68 OPUS must adjust the existing overpayment / underpayment if any extra additional late hours comeshours come in for the reemployed period.
                                //Eg. Participant was reemployed from 07/01/2012 to 09/15/2012. In October, MPI resumes the benefit effective 11/1/2012 and set any overpayment / underpayment on receipt of confirmation from Participant. Now if any late hours come in 11/15/2012 for the re-employed period, then overpayment / underpayment must be updated accordingly
                                if (ldtAdjustFromDate != DateTime.MinValue && ldtAdjustToDate != DateTime.MinValue && ldtAdjustFromDate <= ldtAdjustToDate)
                                {
                                    if (string.IsNullOrEmpty(lcdoReemploymentHistory.reemployment_reason_value))
                                    {
                                        lblnMarkReemployed = CheckReEmploymentRules(ldtAdjustFromDate, ldtRetirementDate, adtBatchRunDate, ldtDisabilityCertificationDate, ldictHoursAfterRetirement, ldecAge, ldecAgeIndec,
                                        ldecVestedEEInterest, ldecVestedEEContributions, ldecEEDerivedBenefit, lstrBenefitTypeValue, lstrBenefitSubTypeValue, lstrBenefitOptionValue,
                                        lintBenefitAppID, lintPlanID, ref lstrRuleCorrespondence, ref lstrReemploymentRule, false, true, aintJobScheduleId: aintJobScheduleId);

                                        lcdoReemploymentHistory.reemployment_reason_value = lstrReemploymentRule;
                                        lcdoReemploymentHistory.Update();

                                    }


                                    lstrRuleCorrespondence = string.Empty;
                                }
                            }
                            #endregion
                        }

                    }
                    else if (this.icdoPayeeAccount.reemployed_flag == busConstant.FLAG_YES)
                    {
                        #region Rule 2
                        ldecHoursAccToRule = decimal.Zero;
                        ldtRuleDate = adtBatchRunDate;
                        if (ldictHoursAfterRetirement.Keys.Contains(ldtRuleDate.Year))
                        {
                            if (ldecAge < 65 && lstrBenefitSubTypeValue == busConstant.RETIREMENT_TYPE_UNREDUCED_EARLY)
                            {
                                ldecHoursAccToRule = ldictHoursAfterRetirement[ldtRuleDate.Year].Values.Sum();
                                if (ldecHoursAccToRule >= 400)
                                {
                                    lbusPayeeAccountStatus = new busPayeeAccountStatus { icdoPayeeAccountStatus = new cdoPayeeAccountStatus() };
                                    lbusPayeeAccountStatus.InsertValuesInPayeeAccountStatus(this.icdoPayeeAccount.payee_account_id, busConstant.PAYEE_ACCOUNT_STATUS_SUSPENDED, DateTime.Now, busConstant.PAYEE_ACCOUNT_SUSPENSION_REASON_REEMPLOYED_RULE_2, aintJobScheduleId: aintJobScheduleId);

                                    lblnMarkReemployed = true;
                                    if (lintPlanID != busConstant.IAP_PLAN_ID)
                                    {
                                        GetDroRetireeModelsForParticipant(busConstant.REEMPLOYMENT_RULE_2, 0, 0, this.icdoPayeeAccount.reemployed_flag_as_of_date, adtBatchRunDate, out ldecTotalMEA, out ldecTotalTaxable, lintPlanID, aintJobScheduleId: aintJobScheduleId);
                                    }
                                }

                                if (ldecHoursAccToRule >= 300)
                                {
                                    lstrRuleCorrespondence = busConstant.REEMPLOYMENT_RULE_2;
                                    this.idecReemploymentCreditedHours = Math.Round(ldecHoursAccToRule, 1);
                                    this.iintReemploymentYear = ldtRuleDate.Year;
                                }
                            }
                        }
                        if (lblnMarkReemployed)
                        {
                            #region Update_Payee_Account_Check_Reemployment_Flag
                            if (lblnMarkReemployed && ldtRetirementDate > ldt1986Date)
                            {
                                this.icdoPayeeAccount.reemployed_flag = busConstant.FLAG_YES;
                                this.icdoPayeeAccount.accrued_benefit_to_be_paid_reeval_flag = busConstant.FLAG_YES;
                                this.icdoPayeeAccount.reemployed_flag_from_eadb = busConstant.FLAG_NO;
                                this.icdoPayeeAccount.Update();
                            }
                            #endregion

                        }
                        #endregion
                    }
                }
            }
            else
            {
                #region Update_Payee_Account_Check_Reemployment_Flag
                if (ldtRetirementDate > ldt1986Date && !ablnRunFromBatch)
                {
                    lbusPayeeAccountStatus = new busPayeeAccountStatus { icdoPayeeAccountStatus = new cdoPayeeAccountStatus() };
                    lbusPayeeAccountStatus.InsertValuesInPayeeAccountStatus(this.icdoPayeeAccount.payee_account_id, busConstant.PAYEE_ACCOUNT_STATUS_SUSPENDED, DateTime.Now, "REED", aintJobScheduleId: aintJobScheduleId);

                    lblnMarkReemployed = true;

                    this.ibusParticipant.LoadPersonSuspendibleMonth();
                    if (!this.ibusParticipant.iclbPersonSuspendibleMonth.IsNullOrEmpty())
                    {
                        if (this.ibusParticipant.iclbPersonSuspendibleMonth.Where(item => item.icdoPersonSuspendibleMonth.status_value == "PEND").Count() > 0)
                        {
                            busPersonSuspendibleMonth lbusPersonSuspendibleMonth = this.ibusParticipant.iclbPersonSuspendibleMonth.OrderBy(item => item.icdoPersonSuspendibleMonth.plan_year).ThenBy(item => Convert.ToInt32(item.icdoPersonSuspendibleMonth.suspendible_month_value)).Where(item => item.icdoPersonSuspendibleMonth.status_value == "PEND").FirstOrDefault();
                            if (Convert.ToInt32(lbusPersonSuspendibleMonth.icdoPersonSuspendibleMonth.plan_year) > 0 && Convert.ToInt32(lbusPersonSuspendibleMonth.icdoPersonSuspendibleMonth.suspendible_month_value) > 0)
                            {
                                this.icdoPayeeAccount.reemployed_flag_as_of_date = busGlobalFunctions.GetFirstPayrollDayOfMonth(Convert.ToInt32(lbusPersonSuspendibleMonth.icdoPersonSuspendibleMonth.plan_year), Convert.ToInt32(lbusPersonSuspendibleMonth.icdoPersonSuspendibleMonth.suspendible_month_value));
                            }
                            foreach (busPersonSuspendibleMonth lbusPendingSuspendibleMonth in this.ibusParticipant.iclbPersonSuspendibleMonth.Where(item => item.icdoPersonSuspendibleMonth.status_value == "PEND").ToList().ToCollection())
                            {
                                lbusPendingSuspendibleMonth.icdoPersonSuspendibleMonth.status_value = "PRCD";
                                lbusPendingSuspendibleMonth.icdoPersonSuspendibleMonth.Update();
                            }

                        }

                    }

                    if (lintPlanID != busConstant.IAP_PLAN_ID)
                    {
                        GetDroRetireeModelsForParticipant("REED", 0, 0, this.icdoPayeeAccount.reemployed_flag_as_of_date, adtBatchRunDate, out ldecTotalMEA, out ldecTotalTaxable, lintPlanID, aintJobScheduleId: aintJobScheduleId);
                    }

                    this.icdoPayeeAccount.reemployed_flag = busConstant.FLAG_YES;
                    this.icdoPayeeAccount.reemployed_flag_from_eadb = busConstant.FLAG_NO;
                    this.icdoPayeeAccount.Update();


                }

                #endregion
            }

            ablnReemployed = lblnMarkReemployed;
            return lstrRuleCorrespondence;
        }

        public cdoReemploymentHistory GetParametersForReEmploymentAsOfDate(DateTime adtReEmployedAsOfDate, DateTime adtRetirementDate, Dictionary<int, Dictionary<int, decimal>> adictHoursAfterRetirement, DateTime adtBatchRunDate, DateTime adtLastWorkingDate, out DateTime adtFromDate, out DateTime adtAdjustFromDate, out DateTime adtAdjustToDate)
        {
            bool lblnLateHoursStartFromRemAsOfDate = false;
            bool lblnStartFromRetDate = false;
            cdoReemploymentHistory lReemploymentHistory = null;
            DateTime ldtReEmployedAsOfDatePayRollMonth = ibusCalculation.GetPayrollDateFromMonth(adtReEmployedAsOfDate);
            DateTime ldtComparisionFromMonth = new DateTime();
            DateTime ldtComparisonToMonth = new DateTime();
            adtFromDate = DateTime.MinValue;
            adtAdjustFromDate = DateTime.MinValue;
            adtAdjustToDate = DateTime.MinValue;
            DateTime ldtBatchMonth = ibusCalculation.GetPayrollDateFromMonth(adtBatchRunDate);
            decimal ldecHoursAfterComparisonToMonth = decimal.Zero;
            bool lblnChkForHoursinBatchMonth = false;
            string lstrReemploymentRule = string.Empty;

            if (adictHoursAfterRetirement.Keys.Contains(ldtBatchMonth.Year))
            {
                if (adictHoursAfterRetirement[ldtBatchMonth.Year][ldtBatchMonth.Month] > 0)
                {
                    lblnChkForHoursinBatchMonth = true;
                }
            }

            if (!lblnChkForHoursinBatchMonth)
            {
                if (!this.iclcReemploymentHistory.IsNullOrEmpty())
                {
                    foreach (cdoReemploymentHistory lcdoReemploymentHistory in this.iclcReemploymentHistory)
                    {
                        ldtComparisionFromMonth = ibusCalculation.GetPayrollDateFromMonth(lcdoReemploymentHistory.reemployed_flag_from_date);
                        ldtComparisonToMonth = ibusCalculation.GetPayrollDateFromMonth(lcdoReemploymentHistory.reemployed_flag_to_date);

                        if (ldtReEmployedAsOfDatePayRollMonth >= ldtComparisionFromMonth && ldtReEmployedAsOfDatePayRollMonth <= ldtComparisonToMonth)
                        {
                            foreach (int lintYear in adictHoursAfterRetirement.Keys)
                            {
                                if (lintYear >= ldtComparisonToMonth.Year)
                                {
                                    Dictionary<int, decimal> ldictHours = adictHoursAfterRetirement[ldtComparisonToMonth.Year];

                                    foreach (int lintMonth in ldictHours.Keys)
                                    {
                                        if ((lintMonth > ldtComparisonToMonth.Month && lintYear == ldtComparisonToMonth.Year) ||
                                            lintYear > ldtComparisonToMonth.Year)
                                        {
                                            ldecHoursAfterComparisonToMonth += ldictHours[lintMonth];
                                        }
                                    }

                                }
                            }
                            if (ldecHoursAfterComparisonToMonth == 0)
                            {
                                adtAdjustFromDate = ldtComparisionFromMonth;
                                adtAdjustToDate = ldtComparisonToMonth;
                                lblnLateHoursStartFromRemAsOfDate = true;
                                lReemploymentHistory = lcdoReemploymentHistory;
                                break;
                            }
                        }

                    }
                }

                bool ablnEligibleForResumeBenefits = false;
                ablnEligibleForResumeBenefits = EligibilityRulesForResumeBenefits(adtReEmployedAsOfDate, adtRetirementDate, adictHoursAfterRetirement, adtBatchRunDate, ref lstrReemploymentRule);
                if (ablnEligibleForResumeBenefits)
                {
                    if (!lblnLateHoursStartFromRemAsOfDate)
                    {
                        if (this.idtNextBenefitPaymentDate == DateTime.MinValue)
                            this.LoadNextBenefitPaymentDate();
                        adtAdjustFromDate = ibusCalculation.GetPayrollDateFromMonth(adtReEmployedAsOfDate);
                        adtAdjustToDate = ibusCalculation.GetPayrollDateFromMonth(adtLastWorkingDate);

                        if (adtAdjustToDate >= adtAdjustFromDate)
                        {
                            busReemploymentHistory lbusReemploymentHistory = InsertInReemploymentHistory(adtReEmployedAsOfDate, adtLastWorkingDate, this.idtNextBenefitPaymentDate, string.Empty, this.icdoPayeeAccount.payee_account_id, decimal.Zero, string.Empty);
                            lReemploymentHistory = lbusReemploymentHistory.icdoReemploymentHistory;
                        }
                    }
                }
                else
                {
                    adtFromDate = adtReEmployedAsOfDate;
                }
            }
            else
            {
                adtFromDate = adtReEmployedAsOfDate;
            }

            return lReemploymentHistory;

        }

        //Rule 1 : Get Evaluated If Hours are getting reported for first time[No History], or even if history exists hours reported from date is less than that in the collection
        public bool CheckReEmploymentRules(DateTime adtFromDate, DateTime adtRetirementDate, DateTime adtBatchRunDate, DateTime adtDisabilityCertificationDate, Dictionary<int, Dictionary<int, decimal>> adictHoursAfterRetirement,
            decimal adecAge, decimal adecAgeIndec, decimal adecVestedEEInterest, decimal adecVestedEEContributions, decimal adecEEDerivedBenefit,
            string astrBenefitTypeValue, string astrBenefitSubTypeValue, string astrBenefitOptionValue
            , int aintBenefitAppID
            , int aintPlanID, ref string astrRuleCorrespondence, ref string astrReemploymentRule, bool ablnLumpSumPaidOut, bool ablnCheckRuleForLateHours = false, bool ablnCheckOnlyForRule2 = false, int aintJobScheduleId = 0)
        {
            bool lblnMarkReemployed = false;
            DateTime ldtRuleDate = new DateTime();
            decimal ldecTotalMEA = decimal.Zero;
            decimal ldecTotalTaxable = decimal.Zero;
            decimal ldecHoursAccToRule = decimal.Zero;
            decimal ldecSpousalSupportAmount = decimal.Zero;
            string lstrSpousalSupportItemCode = string.Empty;
            DateTime ldtFromDate = ibusCalculation.GetPayrollDateFromMonth(adtFromDate);
            busPayeeAccountStatus lbusPayeeAccountStatus;
            astrReemploymentRule = string.Empty;

            bool lblnEvaluateAllRules = false;
            if (ablnCheckRuleForLateHours)
                lblnEvaluateAllRules = true;
            else
            {
                if (this.iclbPayeeAccountStatus.IsNullOrEmpty())
                {
                    this.LoadPayeeAccountStatuss();
                }
                if (!this.iclbPayeeAccountStatus.IsNullOrEmpty())
                {
                    if (this.iclbPayeeAccountStatus.FirstOrDefault().icdoPayeeAccountStatus.status_value == busConstant.PAYEE_ACCOUNT_STATUS_SUSPENDED)
                    {
                        if (this.iclbPayeeAccountStatus.FirstOrDefault().icdoPayeeAccountStatus.suspension_status_reason_value == "REED")
                        {
                            lblnEvaluateAllRules = true;
                        }
                    }
                }
            }

            if (this.iclbPayeeAccountPaymentItemType.IsNullOrEmpty())
                LoadPayeeAccountPaymentItemType();

            if (!this.iclbPayeeAccountPaymentItemType.IsNullOrEmpty())
            {
                // Active Payee Account Payment Item type
                iclbPayeeAccountPaymentItemTypeActive = (from item in this.iclbPayeeAccountPaymentItemType
                                                         where busGlobalFunctions.CheckDateOverlapping(busPayeeAccountHelper.GetLastBenefitPaymentDate(aintPlanID).AddMonths(1),
                                                         item.icdoPayeeAccountPaymentItemType.start_date, item.icdoPayeeAccountPaymentItemType.end_date)
                                                         select item).ToList().ToCollection<busPayeeAccountPaymentItemType>();

                if (iclbPayeeAccountPaymentItemTypeActive.Where(item => item.ibusPaymentItemType.icdoPaymentItemType.item_type_code ==
                    busConstant.ITEM41 || item.ibusPaymentItemType.icdoPaymentItemType.item_type_code == busConstant.ITEM42 || item.ibusPaymentItemType.icdoPaymentItemType.item_type_code ==
                    busConstant.ITEM43 || item.ibusPaymentItemType.icdoPaymentItemType.item_type_code == busConstant.ITEM44).Count() > 0)
                {
                    lstrSpousalSupportItemCode = iclbPayeeAccountPaymentItemTypeActive.Where(item => item.ibusPaymentItemType.icdoPaymentItemType.item_type_code ==
                        busConstant.ITEM41 || item.ibusPaymentItemType.icdoPaymentItemType.item_type_code == busConstant.ITEM42 || item.ibusPaymentItemType.icdoPaymentItemType.item_type_code ==
                        busConstant.ITEM43 || item.ibusPaymentItemType.icdoPaymentItemType.item_type_code == busConstant.ITEM44).FirstOrDefault().ibusPaymentItemType.icdoPaymentItemType.item_type_code;

                    ldecSpousalSupportAmount = iclbPayeeAccountPaymentItemTypeActive.Where(item => item.ibusPaymentItemType.icdoPaymentItemType.item_type_code ==
                        busConstant.ITEM41 || item.ibusPaymentItemType.icdoPaymentItemType.item_type_code == busConstant.ITEM42 || item.ibusPaymentItemType.icdoPaymentItemType.item_type_code ==
                        busConstant.ITEM43 || item.ibusPaymentItemType.icdoPaymentItemType.item_type_code == busConstant.ITEM44).FirstOrDefault().icdoPayeeAccountPaymentItemType.amount;
                }
            }

            if (!ablnCheckOnlyForRule2)
            {
                #region Rule 1 : If 1 or more hours were reported for a Retired participant prior to the end of 2nd consecutive payroll month
                if ((!lblnMarkReemployed && this.icdoPayeeAccount.reemployed_flag != busConstant.FLAG_YES) || lblnEvaluateAllRules)
                {

                    ldtRuleDate = adtRetirementDate.AddMonths(1);

                    if (ldtFromDate < adtRetirementDate.AddMonths(2))
                    {
                        if (adictHoursAfterRetirement.Keys.Contains(ldtRuleDate.Year))
                        {
                            ldecHoursAccToRule = (adictHoursAfterRetirement[ldtRuleDate.Year])[ldtRuleDate.Month];
                        }
                        if (adictHoursAfterRetirement.Keys.Contains(adtRetirementDate.Year))
                        {
                            ldecHoursAccToRule += (adictHoursAfterRetirement[adtRetirementDate.Year])[adtRetirementDate.Month];
                        }
                        if (ldecHoursAccToRule >= 1)
                        {
                            astrRuleCorrespondence = busConstant.REEMPLOYMENT_RULE_1;
                            astrReemploymentRule = busConstant.REEMPLOYMENT_RULE_1;
                            lblnMarkReemployed = true;
                            if (!ablnCheckRuleForLateHours)
                            {
                                if (aintPlanID != busConstant.IAP_PLAN_ID)
                                {
                                    lbusPayeeAccountStatus = new busPayeeAccountStatus { icdoPayeeAccountStatus = new cdoPayeeAccountStatus() };
                                    lbusPayeeAccountStatus.InsertValuesInPayeeAccountStatus(this.icdoPayeeAccount.payee_account_id, busConstant.PAYEE_ACCOUNT_STATUS_SUSPENDED, DateTime.Now, busConstant.PAYEE_ACCOUNT_SUSPENSION_REASON_REEMPLOYED_RULE_1, aintJobScheduleId: aintJobScheduleId);

                                    GetDroRetireeModelsForParticipant(astrReemploymentRule, 0, 0, adtFromDate, adtBatchRunDate, out ldecTotalMEA, out ldecTotalTaxable, aintPlanID, aintJobScheduleId: aintJobScheduleId);
                                    LoadNextBenefitPaymentDate();
                                }
                            }
                        }

                    }
                }


                #endregion
            }
            if (aintPlanID != busConstant.IAP_PLAN_ID && !ablnLumpSumPaidOut)
            {
                #region Rule 2
                if (!lblnMarkReemployed)
                {
                    ldecHoursAccToRule = decimal.Zero;
                    ldtRuleDate = adtBatchRunDate;
                    if (adictHoursAfterRetirement.Keys.Contains(ldtRuleDate.Year))
                    {
                        if (adecAge < 65 && astrBenefitSubTypeValue == busConstant.RETIREMENT_TYPE_UNREDUCED_EARLY)
                        {
                            ldecHoursAccToRule = adictHoursAfterRetirement[ldtRuleDate.Year].Values.Sum();
                            if (ldecHoursAccToRule >= 400)
                            {
                                astrReemploymentRule = busConstant.REEMPLOYMENT_RULE_2;
                                lblnMarkReemployed = true;
                                if (!ablnCheckRuleForLateHours)
                                {
                                    if (aintPlanID != busConstant.IAP_PLAN_ID)
                                    {
                                        lbusPayeeAccountStatus = new busPayeeAccountStatus { icdoPayeeAccountStatus = new cdoPayeeAccountStatus() };
                                        lbusPayeeAccountStatus.InsertValuesInPayeeAccountStatus(this.icdoPayeeAccount.payee_account_id, busConstant.PAYEE_ACCOUNT_STATUS_SUSPENDED, DateTime.Now, busConstant.PAYEE_ACCOUNT_SUSPENSION_REASON_REEMPLOYED_RULE_2, aintJobScheduleId: aintJobScheduleId);

                                        GetDroRetireeModelsForParticipant(astrReemploymentRule, 0, 0, adtFromDate, adtBatchRunDate, out ldecTotalMEA, out ldecTotalTaxable, aintPlanID, aintJobScheduleId: aintJobScheduleId);
                                    }
                                }
                                else
                                {
                                    astrRuleCorrespondence = busConstant.REEMPLOYMENT_RULE_2;
                                }
                            }
                            if (ldecHoursAccToRule >= 300)
                            {
                                astrRuleCorrespondence = busConstant.REEMPLOYMENT_RULE_2;

                                //Re-Employment Approaching Un-Reduced Limit letter.
                                //variables for Corr
                                this.idecReemploymentCreditedHours = Math.Round(ldecHoursAccToRule, 1);
                                this.iintReemploymentYear = ldtRuleDate.Year;

                            }
                        }
                    }
                }
                #endregion

                if (!ablnCheckOnlyForRule2)
                {
                    #region Rule3
                    if ((!lblnMarkReemployed && this.icdoPayeeAccount.reemployed_flag != busConstant.FLAG_YES && astrBenefitTypeValue != busConstant.BENEFIT_TYPE_DISABILITY) || lblnEvaluateAllRules)
                    {
                        ldecHoursAccToRule = decimal.Zero;
                        //Prod Fix : 13th August 2013
                        if (!ablnCheckRuleForLateHours)
                        {
                            //RID#90258 Reverting back Payroll Month selection. 
                            ldtRuleDate = ibusCalculation.GetPayrollDateFromMonth(adtBatchRunDate).AddMonths(-1);
                            //ldtRuleDate = ibusCalculation.GetPayrollDateFromMonth(adtBatchRunDate); //Payroll Month Fix - 12052019
                        }
                        else
                        {
                            ldtRuleDate = ldtFromDate;
                        }
                        if (ldtFromDate >= adtRetirementDate.AddMonths(2))
                        {
                            if (adictHoursAfterRetirement.Keys.Contains(ldtRuleDate.Year))
                            {
                                bool lblnHoursGreaterThan40InAMonth = false;
                                foreach (int lintYear in adictHoursAfterRetirement.Keys)
                                {
                                    if (lintYear >= ldtRuleDate.Year)
                                    {
                                        Dictionary<int, decimal> ldictMonths = adictHoursAfterRetirement[lintYear];
                                        if (lintYear == ldtRuleDate.Year)
                                        {
                                            //RID# 90712
                                            if (!ablnCheckRuleForLateHours)
                                            {
                                                DateTime ldtPreviousMonthDate;
                                                ldtPreviousMonthDate = ldtRuleDate.AddMonths(-1);

                                                if (adictHoursAfterRetirement.Keys.Contains(ldtRuleDate.Year) && (adictHoursAfterRetirement[ldtRuleDate.Year]).Keys.Contains(ldtRuleDate.Month))
                                                {
                                                    if ((adictHoursAfterRetirement[ldtRuleDate.Year])[ldtRuleDate.Month] >= this.ibusCalculation.GetSuspendibleHoursValue(ldtRuleDate.Year, ldtRuleDate.Month))
                                                    {
                                                        lblnHoursGreaterThan40InAMonth = true;
                                                        break;
                                                    }
                                                }
                                                if (adictHoursAfterRetirement.Keys.Contains(ldtPreviousMonthDate.Year) && (adictHoursAfterRetirement[ldtPreviousMonthDate.Year]).Keys.Contains(ldtPreviousMonthDate.Month))
                                                {
                                                    if ((adictHoursAfterRetirement[ldtPreviousMonthDate.Year])[ldtPreviousMonthDate.Month] >= this.ibusCalculation.GetSuspendibleHoursValue(ldtPreviousMonthDate.Year, ldtPreviousMonthDate.Month))
                                                    {
                                                        lblnHoursGreaterThan40InAMonth = true;
                                                        break;
                                                    }
                                                }
                                            }
                                            else
                                            {
                                                //SuspendibleHoursChange
                                                if (ldictMonths.Where(item => item.Key >= ldtRuleDate.Month && item.Value >= this.ibusCalculation.GetSuspendibleHoursValue(lintYear, item.Key)).Count() > 0)
                                                {
                                                    lblnHoursGreaterThan40InAMonth = true;
                                                    break;
                                                }
                                                //PIR 1051
                                                //SuspendibleHoursChange
                                                else if (ldtRuleDate.AddMonths(-1).Year == lintYear && ldictMonths.Where(item => item.Key >= ldtRuleDate.Month - 1 && item.Value >= this.ibusCalculation.GetSuspendibleHoursValue(lintYear, item.Key)).Count() > 0)
                                                {
                                                    lblnHoursGreaterThan40InAMonth = true;
                                                    break;
                                                }
                                                else if (ldtRuleDate.AddMonths(-1).Year < lintYear
                                                    && adictHoursAfterRetirement.Keys.Contains(ldtRuleDate.AddMonths(-1).Year))
                                                {
                                                    //SuspendibleHoursChange
                                                    if (adictHoursAfterRetirement[ldtRuleDate.AddMonths(-1).Year].Where(item => item.Key >= ldtRuleDate.Month - 1 && item.Value >= this.ibusCalculation.GetSuspendibleHoursValue(ldtRuleDate.AddMonths(-1).Year, item.Key)).Count() > 0)
                                                    {
                                                        lblnHoursGreaterThan40InAMonth = true;
                                                        break;
                                                    }
                                                }
                                            }
                                        }
                                        else if (lintYear > ldtRuleDate.Year)
                                        {
                                            //SuspendibleHoursChange
                                            if (ldictMonths.Where(item => item.Value >= this.ibusCalculation.GetSuspendibleHoursValue(lintYear, item.Key)).Count() > 0)
                                            {
                                                lblnHoursGreaterThan40InAMonth = true;
                                                break;
                                            }
                                            //PIR 1051
                                            else if (adictHoursAfterRetirement.Keys.Contains(ldtRuleDate.Year))
                                            {   //SuspendibleHoursChange
                                                if (adictHoursAfterRetirement[ldtRuleDate.Year].Where(item => item.Key >= ldtRuleDate.Month && item.Value >= this.ibusCalculation.GetSuspendibleHoursValue(ldtRuleDate.Year, item.Key)).Count() > 0)
                                                {
                                                    lblnHoursGreaterThan40InAMonth = true;
                                                    break;
                                                }
                                            }
                                        }

                                    }
                                }

                                if (lblnHoursGreaterThan40InAMonth)
                                {
                                    if (!ablnCheckRuleForLateHours)
                                    {
                                        #region  EE Derived Benefit Calculation Code - Removed as a part of fix for PIR 1051
                                        //if (!ablnLumpSumPaidOut)
                                        //{
                                        //    ChangePayeeAccountStatusBasedOnEEDerivedBenefit(this.icdoPayeeAccount.payee_account_id, adecVestedEEInterest + adecVestedEEContributions, adecAgeIndec, adtRetirementDate, adecEEDerivedBenefit, astrBenefitOptionValue, adtBatchRunDate, aintPlanID, busConstant.PAYEE_ACCOUNT_SUSPENSION_REASON_REEMPLOYED_RULE_3);
                                        //}
                                        //else
                                        //{
                                        //    lbusPayeeAccountStatus = new busPayeeAccountStatus { icdoPayeeAccountStatus = new cdoPayeeAccountStatus() };
                                        //    lbusPayeeAccountStatus.InsertValuesInPayeeAccountStatus(this.icdoPayeeAccount.payee_account_id, busConstant.PAYEE_ACCOUNT_STATUS_SUSPENDED, DateTime.Now, busConstant.PAYEE_ACCOUNT_SUSPENSION_REASON_REEMPLOYED_RULE_3);
                                        //}
                                        #endregion  EE Derived Benefit Calculation Code - Removed as a part of fix for PIR 1051

                                        if (aintPlanID != busConstant.IAP_PLAN_ID)
                                        {
                                            lbusPayeeAccountStatus = new busPayeeAccountStatus { icdoPayeeAccountStatus = new cdoPayeeAccountStatus() };
                                            lbusPayeeAccountStatus.InsertValuesInPayeeAccountStatus(this.icdoPayeeAccount.payee_account_id, busConstant.PAYEE_ACCOUNT_STATUS_SUSPENDED, DateTime.Now, busConstant.PAYEE_ACCOUNT_SUSPENSION_REASON_REEMPLOYED_RULE_3, aintJobScheduleId: aintJobScheduleId);
                                        }
                                    }

                                    lblnMarkReemployed = true;
                                    astrReemploymentRule = busConstant.REEMPLOYMENT_RULE_3;
                                    this.iintReemploymentYear = ldtRuleDate.Year;

                                }
                            }
                        }
                    }
                    #endregion

                    #region Rule 4,5 Commented as a part of fix for PIR 1051
                    //if ((!lblnMarkReemployed && this.icdoPayeeAccount.reemployed_flag != busConstant.FLAG_YES) || lblnEvaluateAllRules)
                    //{
                    //    if (astrBenefitTypeValue == busConstant.BENEFIT_TYPE_DISABILITY)
                    //    {
                    //        bool lblnCheckNoDisabilityCertificationInCompYear = false;
                    //        int countMonths = busGlobalFunctions.GetMonthsBetweenTwoDates(adtDisabilityCertificationDate, adtBatchRunDate);
                    //        if (countMonths > 24)
                    //        {
                    //            DataTable ldataDisabilityRecertificationDate = busBase.Select("cdoDisabilityBenefitHistory.GetLatestDisabilityCertification", new object[1] { aintBenefitAppID });
                    //            if (ldataDisabilityRecertificationDate.Rows.Count > 0)
                    //            {
                    //                if (!string.IsNullOrEmpty(Convert.ToString(ldataDisabilityRecertificationDate.Rows[0][enmDisabilityBenefitHistory.disability_cont_letter_date.ToString()])))
                    //                {
                    //                    adtDisabilityCertificationDate = Convert.ToDateTime(ldataDisabilityRecertificationDate.Rows[0][enmDisabilityBenefitHistory.disability_cont_letter_date.ToString()]);
                    //                    countMonths = busGlobalFunctions.GetMonthsBetweenTwoDates(adtDisabilityCertificationDate, adtBatchRunDate);
                    //                    if (countMonths < 12)
                    //                    {
                    //                        lblnCheckNoDisabilityCertificationInCompYear = true;
                    //                    }
                    //                }
                    //            }
                    //            //Rule 5
                    //        }
                    //        else if (countMonths > 12)
                    //        {
                    //            if (astrBenefitSubTypeValue == "SSAD")
                    //            {
                    //                DataTable ldataDisabilityRecertificationDate = busBase.Select("cdoDisabilityBenefitHistory.GetLatestDisabilityCertification", new object[1] { aintBenefitAppID });
                    //                if (ldataDisabilityRecertificationDate.IsNotNull() && ldataDisabilityRecertificationDate.Rows.Count > 0)
                    //                {
                    //                    if (!string.IsNullOrEmpty(Convert.ToString(ldataDisabilityRecertificationDate.Rows[0][enmDisabilityBenefitHistory.disability_cont_letter_date.ToString()])))
                    //                    {
                    //                        adtDisabilityCertificationDate = Convert.ToDateTime(ldataDisabilityRecertificationDate.Rows[0][enmDisabilityBenefitHistory.disability_cont_letter_date.ToString()]);
                    //                        countMonths = busGlobalFunctions.GetMonthsBetweenTwoDates(adtDisabilityCertificationDate, adtBatchRunDate);
                    //                        if (countMonths < 12)
                    //                        {
                    //                            lblnCheckNoDisabilityCertificationInCompYear = true;
                    //                        }
                    //                    }
                    //                }
                    //            }
                    //            else
                    //            {
                    //                lblnCheckNoDisabilityCertificationInCompYear = true;
                    //            }
                    //        }
                    //        else
                    //        {
                    //            lblnCheckNoDisabilityCertificationInCompYear = true;
                    //            //Rule 4
                    //            //Cor : SSA Disability Benefits Stops-Overpayment 
                    //        }
                    //        if (lblnCheckNoDisabilityCertificationInCompYear)
                    //        {
                    //            //Rule 5
                    //            ldecHoursAccToRule = decimal.Zero;
                    //            ldtRuleDate = DateTime.MinValue;
                    //            bool lblnHoursGreaterThan40InAMonth = false;
                    //            //Prod Fix : 13th August 2013
                    //            if (!ablnCheckRuleForLateHours)
                    //            {
                    //                ldtRuleDate = ibusCalculation.GetPayrollDateFromMonth(adtBatchRunDate).AddMonths(-1);
                    //            }
                    //            else
                    //            {
                    //                ldtRuleDate = ldtFromDate;
                    //            }
                    //            if (ldtFromDate >= adtRetirementDate.AddMonths(2))
                    //            {
                    //                if (adictHoursAfterRetirement.Keys.Contains(ldtRuleDate.Year))
                    //                {
                    //                    foreach (int lintYear in adictHoursAfterRetirement.Keys)
                    //                    {
                    //                        if (lintYear >= ldtRuleDate.Year)
                    //                        {
                    //                            Dictionary<int, decimal> ldictMonths = adictHoursAfterRetirement[lintYear];
                    //                            if (lintYear == ldtRuleDate.Year)
                    //                            {
                    //                                if (ldictMonths.Where(item => item.Key >= ldtRuleDate.Month && item.Value >= 40).Count() > 0)
                    //                                {
                    //                                    lblnHoursGreaterThan40InAMonth = true;
                    //                                    break;
                    //                                }
                    //                            }
                    //                            else if (lintYear > ldtRuleDate.Year)
                    //                            {
                    //                                if (ldictMonths.Where(item => item.Value >= 40).Count() > 0)
                    //                                {
                    //                                    lblnHoursGreaterThan40InAMonth = true;
                    //                                    break;
                    //                                }
                    //                            }

                    //                        }
                    //                    }
                    //                    //ldecHoursAccToRule = (decimal)(lhstYearlyHours[ldtRuleDate.Year] as Hashtable)[ldtRuleDate.Month];
                    //                    if (lblnHoursGreaterThan40InAMonth)
                    //                    {
                    //                        if (!ablnCheckRuleForLateHours)
                    //                        {
                    //                            if (!ablnLumpSumPaidOut)
                    //                            {
                    //                                ChangePayeeAccountStatusBasedOnEEDerivedBenefit(this.icdoPayeeAccount.payee_account_id, adecVestedEEInterest + adecVestedEEContributions, adecAgeIndec, adtRetirementDate, adecEEDerivedBenefit, astrBenefitOptionValue, adtBatchRunDate, aintPlanID, busConstant.PAYEE_ACCOUNT_SUSPENSION_REASON_REEMPLOYED_RULE_5);
                    //                            }
                    //                            else
                    //                            {
                    //                                lbusPayeeAccountStatus = new busPayeeAccountStatus { icdoPayeeAccountStatus = new cdoPayeeAccountStatus() };
                    //                                lbusPayeeAccountStatus.InsertValuesInPayeeAccountStatus(this.icdoPayeeAccount.payee_account_id, busConstant.PAYEE_ACCOUNT_STATUS_SUSPENDED, DateTime.Now, busConstant.PAYEE_ACCOUNT_SUSPENSION_REASON_REEMPLOYED_RULE_5);

                    //                            }
                    //                        }
                    //                        lblnMarkReemployed = true;
                    //                        //astrRuleCorrespondence = busConstant.REEMPLOYMENT_RULE_5;
                    //                        astrReemploymentRule = busConstant.REEMPLOYMENT_RULE_5;

                    //                    }
                    //                }
                    //            }
                    //        }
                    //        else
                    //        {
                    //            astrRuleCorrespondence = busConstant.REEMPLOYMENT_RULE_4;
                    //            astrReemploymentRule = busConstant.REEMPLOYMENT_RULE_4;
                    //            if (!ablnCheckRuleForLateHours)
                    //            {
                    //                lbusPayeeAccountStatus = new busPayeeAccountStatus { icdoPayeeAccountStatus = new cdoPayeeAccountStatus() };
                    //                lbusPayeeAccountStatus.InsertValuesInPayeeAccountStatus(this.icdoPayeeAccount.payee_account_id, busConstant.PAYEE_ACCOUNT_STATUS_SUSPENDED, DateTime.Now, busConstant.PAYEE_ACCOUNT_SUSPENSION_REASON_REEMPLOYED_RULE_4);
                    //                GetDroRetireeModelsForParticipant(astrReemploymentRule, 0, 0, adtFromDate, adtBatchRunDate, out ldecTotalMEA, out ldecTotalTaxable, aintPlanID);
                    //                //Rule 4
                    //                //Cor : SSA Disability Benefits Stops-Overpayment
                    //            }
                    //        }

                    //        lblnMarkReemployed = true;
                    //    }
                    //}
                    #endregion
                }
            }
            if (lblnMarkReemployed && !ablnCheckRuleForLateHours)
            {
                InsertInReemploymentHistory(this.icdoPayeeAccount.reemployed_flag_as_of_date, DateTime.MinValue, DateTime.MinValue, astrReemploymentRule, this.icdoPayeeAccount.payee_account_id, ldecSpousalSupportAmount, lstrSpousalSupportItemCode);
            }
            return lblnMarkReemployed;

        }

        public void AdjustUnderOverPaymentLateReemployedHours(Dictionary<int, Dictionary<int, decimal>> adictHoursAfterRetirement, cdoReemploymentHistory acdoReemploymentHistory, DateTime adtAdjustFromDate, DateTime adtAdjustToDate)
        {
            //Don't take any offset here we are just adjusting Alternate Payee's and Participant's Benefit.

            decimal ldecAmount = decimal.Zero;
            decimal ldecTaxableAmountShouldHaveBeenPaid = decimal.Zero;
            decimal ldecNonTaxableAmountShouldHaveBeenPaid = decimal.Zero;
            decimal ldecEEDerivedTaxableShouldHaveBeenPaid = decimal.Zero;
            busBenefitCalculationDetail lbusBenefitCalculationDetail = new busBenefitCalculationDetail { icdoBenefitCalculationDetail = new cdoBenefitCalculationDetail() };
            busBenefitCalculationHeader lbusBenefitCalculationHeader = new busBenefitCalculationHeader { icdoBenefitCalculationHeader = new cdoBenefitCalculationHeader() };
            if (lbusBenefitCalculationDetail.FindBenefitCalculationDetail(this.icdoPayeeAccount.benefit_calculation_detail_id))
            {
                lbusBenefitCalculationHeader.FindBenefitCalculationHeader(lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.benefit_calculation_header_id);
                if (lbusBenefitCalculationHeader.icdoBenefitCalculationHeader.benefit_calculation_header_id > 0)
                {
                    ibusCalculation.FillYearlyDetailSetBenefitAmountForEachYear(lbusBenefitCalculationHeader, lbusBenefitCalculationDetail);
                }

            }
            this.ibusParticipant = new busPerson { icdoPerson = new cdoPerson() };
            this.ibusParticipant.FindPerson(this.icdoPayeeAccount.person_id);

            this.ibusParticipant.LoadPersonSuspendibleMonth();

            //Rule Needs to be checked here as well to judge if person was eligible for EE derived or not
            bool lblnEEDerived = false;
            if (acdoReemploymentHistory.reemployment_reason_value == busConstant.REEMPLOYMENT_RULE_3 || acdoReemploymentHistory.reemployment_reason_value == busConstant.REEMPLOYMENT_RULE_5)
            {
                lblnEEDerived = true;
            }

            //If -ve then it was a overpayment else it was underpayment.
            //This amount needs to be adjusted against the month wise adjustment details.
            decimal ldecTaxableRetroPaymentMade = decimal.Zero;
            decimal ldecNonTaxableRetroPaymentMade = decimal.Zero;


            /*
            #region LoadRetroPaymentsMade
            Collection<busPayeeAccountRetroPayment> lclEffectivebusPayeeAccountRetroPayment;
            if (this.iclbPayeeAccountRetroPayment.IsNullOrEmpty())
            {
                LoadPayeeAccountRetroPayments();
            }
            if (!this.iclbPayeeAccountRetroPayment.IsNullOrEmpty())
            {
                if (this.iclbPayeeAccountRetroPayment.Where(item => item.icdoPayeeAccountRetroPayment.effective_start_date >= adtAdjustFromDate && item.icdoPayeeAccountRetroPayment.effective_end_date <= adtAdjustToDate).Count() > 0)
                {
                    lclEffectivebusPayeeAccountRetroPayment = this.iclbPayeeAccountRetroPayment.Where(item => item.icdoPayeeAccountRetroPayment.effective_start_date >= adtAdjustFromDate && item.icdoPayeeAccountRetroPayment.effective_end_date <= adtAdjustToDate && (item.icdoPayeeAccountRetroPayment.retro_payment_type_value == "IRPM" || item.icdoPayeeAccountRetroPayment.retro_payment_type_value == busConstant.RETRO_PAYMENT_REEMPLOYMENT)).ToList().ToCollection();
                    foreach (busPayeeAccountRetroPayment lbusPayeeAccountRetroPayment in lclEffectivebusPayeeAccountRetroPayment)
                    {
                        lbusPayeeAccountRetroPayment.LoadPayeeAccountRetroPaymentDetails();
                        foreach (busPayeeAccountRetroPaymentDetail lbusPayeeAccountRetroPaymentDetail in lbusPayeeAccountRetroPayment.iclbPayeeAccountRetroPaymentDetail)
                        {
                            lbusPayeeAccountRetroPaymentDetail.LoadPaymentItemType();
                            if (lbusPayeeAccountRetroPayment.icdoPayeeAccountRetroPayment.is_overpayment_flag == busConstant.FLAG_YES)
                            {
                                if (lbusPayeeAccountRetroPaymentDetail.ibusPaymentItemType.icdoPaymentItemType.taxable_item_flag == busConstant.FLAG_YES &&
                                    lbusPayeeAccountRetroPaymentDetail.ibusPaymentItemType.icdoPaymentItemType.item_type_direction == 1)
                                {
                                    ldecTaxableRetroPaymentMade -= lbusPayeeAccountRetroPaymentDetail.icdoPayeeAccountRetroPaymentDetail.amount;
                                }
                                else if (lbusPayeeAccountRetroPaymentDetail.ibusPaymentItemType.icdoPaymentItemType.taxable_item_flag == busConstant.FLAG_NO &&
                                    lbusPayeeAccountRetroPaymentDetail.ibusPaymentItemType.icdoPaymentItemType.item_type_direction == 1)
                                {
                                    ldecNonTaxableRetroPaymentMade -= lbusPayeeAccountRetroPaymentDetail.icdoPayeeAccountRetroPaymentDetail.amount;
                                }
                            }
                            else if (lbusPayeeAccountRetroPayment.icdoPayeeAccountRetroPayment.retro_payment_type_value == busConstant.RETRO_PAYMENT_INITIAL)
                            {
                                if (lbusPayeeAccountRetroPaymentDetail.ibusPaymentItemType.icdoPaymentItemType.taxable_item_flag == busConstant.FLAG_YES &&
                                   lbusPayeeAccountRetroPaymentDetail.ibusPaymentItemType.icdoPaymentItemType.item_type_direction == 1)
                                {
                                    ldecTaxableRetroPaymentMade += lbusPayeeAccountRetroPaymentDetail.icdoPayeeAccountRetroPaymentDetail.amount;
                                }
                                else if (lbusPayeeAccountRetroPaymentDetail.ibusPaymentItemType.icdoPaymentItemType.taxable_item_flag == busConstant.FLAG_NO &&
                                    lbusPayeeAccountRetroPaymentDetail.ibusPaymentItemType.icdoPaymentItemType.item_type_direction == 1)
                                {
                                    ldecNonTaxableRetroPaymentMade += lbusPayeeAccountRetroPaymentDetail.icdoPayeeAccountRetroPaymentDetail.amount;
                                }
                            }
                        }
                    }
                }
            }
            #endregion
            */
            #region AmountAlreadyPaidToTheParticipant
            Collection<busBenefitMonthwiseAdjustmentDetail> lclbBenefitMonthwiseAdjustmentDetail = new Collection<busBenefitMonthwiseAdjustmentDetail>();
            lclbBenefitMonthwiseAdjustmentDetail = ibusCalculation.GetAmountActuallyPaid(this, adtAdjustFromDate, adtAdjustToDate);
            #endregion

            #region AlternatePayeeOverPayments/Under

            #endregion

            #region Amount Should Have been Paid to the participant
            DateTime ldtParticipantTurns65 = this.ibusParticipant.icdoPerson.date_of_birth.AddYears(65);
            if (ldtParticipantTurns65.Day != 1)
            {
                ldtParticipantTurns65 = ldtParticipantTurns65.GetLastDayofMonth().AddDays(1);
            }
            bool lblnGetAmountForReemployment = false;
            foreach (busBenefitMonthwiseAdjustmentDetail lbusBenefitMonthwiseAdjustmentDetail in lclbBenefitMonthwiseAdjustmentDetail)
            {
                lblnGetAmountForReemployment = false;
                if (lbusBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.payment_date >= ldtParticipantTurns65)
                {
                    lblnGetAmountForReemployment = true;
                }
                ldecTaxableAmountShouldHaveBeenPaid = decimal.Zero;
                ldecNonTaxableAmountShouldHaveBeenPaid = decimal.Zero;
                if (ibusCalculation.CheckIfMonthIsSuspendible(adictHoursAfterRetirement, this.ibusParticipant.iclbPersonSuspendibleMonth, lbusBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.payment_date))
                {
                    lbusBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.suspended_flag = busConstant.FLAG_YES;
                    if (adictHoursAfterRetirement.Keys.Contains(lbusBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.payment_date.Year))
                    {
                        lbusBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.hours = adictHoursAfterRetirement[lbusBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.payment_date.Year][lbusBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.payment_date.Month];
                    }
                    if (lblnEEDerived)
                    {
                        ldecNonTaxableAmountShouldHaveBeenPaid = ldecNonTaxableAmountShouldHaveBeenPaid - lbusBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.idecAlternatePayeeMonthlyNonTaxableOffset;
                        ldecTaxableAmountShouldHaveBeenPaid = this.icdoPayeeAccount.ee_derived_benefit_amount - lbusBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.idecAlternatePayeeMonthlyTaxableOffset;
                    }
                }
                else
                {
                    if (adictHoursAfterRetirement.Keys.Contains(lbusBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.payment_date.Year))
                    {
                        lbusBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.hours = adictHoursAfterRetirement[lbusBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.payment_date.Year][lbusBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.payment_date.Month];
                    }
                    ldecNonTaxableAmountShouldHaveBeenPaid = ldecNonTaxableAmountShouldHaveBeenPaid - lbusBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.idecAlternatePayeeMonthlyNonTaxableOffset;
                    if (lbusBenefitCalculationHeader.icdoBenefitCalculationHeader.benefit_calculation_header_id > 0)
                    {
                        ldecTaxableAmountShouldHaveBeenPaid = ibusCalculation.GetBenefitAmountOfParticipantFromYearlyDetail(lbusBenefitCalculationHeader, lbusBenefitCalculationDetail, lbusBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.payment_date.Year, ablnGetAmountForReemployment: lblnGetAmountForReemployment);
                        ldecTaxableAmountShouldHaveBeenPaid = ldecTaxableAmountShouldHaveBeenPaid - ldecNonTaxableAmountShouldHaveBeenPaid;
                    }
                    ldecTaxableAmountShouldHaveBeenPaid = ldecTaxableAmountShouldHaveBeenPaid - lbusBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.idecAlternatePayeeMonthlyTaxableOffset;
                }
                lbusBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.non_taxable_amount_to_be_paid = ldecNonTaxableAmountShouldHaveBeenPaid;
                lbusBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.taxable_amount_to_be_paid = ldecTaxableAmountShouldHaveBeenPaid;
            }

            AdjustAltPayeeUnderOverPaymentLateReemployedHours(lclbBenefitMonthwiseAdjustmentDetail, adtAdjustFromDate, adtAdjustToDate, lblnEEDerived);
            foreach (busBenefitMonthwiseAdjustmentDetail lbusBenefitMonthwiseAdjustmentDetail in lclbBenefitMonthwiseAdjustmentDetail)
            {
                lbusBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.taxable_amount_to_be_paid -= lbusBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.idecAlternatePayeeMonthlyTaxableOffset;
                lbusBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.non_taxable_amount_to_be_paid -= lbusBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.idecAlternatePayeeMonthlyNonTaxableOffset;

            }


            ibusCalculation.CreateOverpaymentUnderPayment(this, lclbBenefitMonthwiseAdjustmentDetail, busConstant.RETRO_PAYMENT_REEMPLOYMENT, ldecTaxableRetroPaymentMade, ldecNonTaxableRetroPaymentMade);


            #endregion


            //Check If Payments are completed.
            //To Handle Late Hours of ReEmployed Period.
            //Adjust Overpayment Underpayment
            //1.) Check DRO : Create Overpayment Underpayment
            //2.) 


            // ResumeParticipantAndAlternatePayeeBenefits(adtBatchRunDate);
        }

        public void AdjustAltPayeeUnderOverPaymentLateReemployedHours(Collection<busBenefitMonthwiseAdjustmentDetail> aclbParticipantBenefitMonthwiseAdjustmentDetail, DateTime adtAdjustFromDate, DateTime adtAdjustToDate, bool ablnEEDerived)
        {
            DataTable ldtDroApp = Select("cdoDroBenefitDetails.GetPayeeAccountsForRetireeModel", new object[2] { this.icdoPayeeAccount.person_id, this.icdoPayeeAccount.benefit_begin_date });
            if (ldtDroApp.Rows.Count > 0)
            {
                foreach (DataRow ldtRow in ldtDroApp.Rows)
                {
                    busPayeeAccount lbusPayeeAccount = new busPayeeAccount { icdoPayeeAccount = new cdoPayeeAccount() };
                    lbusPayeeAccount.icdoPayeeAccount.LoadData(ldtRow);

                    decimal ldecFlatAmount = decimal.Zero;
                    decimal ldecFlatPercentage = decimal.Zero;

                    if (!string.IsNullOrEmpty(Convert.ToString(ldtRow[enmDroBenefitDetails.benefit_amt.ToString()])))
                    {
                        ldecFlatAmount = Convert.ToDecimal(ldtRow[enmDroBenefitDetails.benefit_amt.ToString()]);
                    }
                    if (!string.IsNullOrEmpty(Convert.ToString(ldtRow[enmDroBenefitDetails.benefit_flat_perc.ToString()])))
                    {
                        ldecFlatPercentage = Convert.ToDecimal(ldtRow[enmDroBenefitDetails.benefit_flat_perc.ToString()]);
                    }
                    if (ldecFlatAmount == 0 && ldecFlatPercentage == 0)
                        continue;
                    busBenefitCalculationDetail lbusBenefitCalculationDetail = new busBenefitCalculationDetail { icdoBenefitCalculationDetail = new cdoBenefitCalculationDetail() };
                    busBenefitCalculationHeader lbusBenefitCalculationHeader = new busBenefitCalculationHeader { icdoBenefitCalculationHeader = new cdoBenefitCalculationHeader() };
                    if (lbusBenefitCalculationDetail.FindBenefitCalculationDetail(this.icdoPayeeAccount.benefit_calculation_detail_id))
                    {
                        lbusBenefitCalculationHeader.FindBenefitCalculationHeader(lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.benefit_calculation_header_id);
                    }

                    this.ibusParticipant.LoadPersonSuspendibleMonth();


                    //If -ve then it was a overpayment else it was underpayment.
                    //This amount needs to be adjusted against the month wise adjustment details.
                    decimal ldecTaxableRetroPaymentMade = decimal.Zero;
                    decimal ldecNonTaxableRetroPaymentMade = decimal.Zero;


                    #region LoadRetroPaymentsMade
                    /*
                     Collection<busPayeeAccountRetroPayment> lclEffectivebusPayeeAccountRetroPayment;
                     if (this.iclbPayeeAccountRetroPayment.IsNullOrEmpty())
                     {
                         LoadPayeeAccountRetroPayments();
                     }
                     if (!this.iclbPayeeAccountRetroPayment.IsNullOrEmpty())
                     {
                         if (this.iclbPayeeAccountRetroPayment.Where(item => item.icdoPayeeAccountRetroPayment.effective_start_date >= adtAdjustFromDate && item.icdoPayeeAccountRetroPayment.effective_end_date <= adtAdjustToDate).Count() > 0)
                         {
                             lclEffectivebusPayeeAccountRetroPayment = this.iclbPayeeAccountRetroPayment.Where(item => item.icdoPayeeAccountRetroPayment.effective_start_date >= adtAdjustFromDate && item.icdoPayeeAccountRetroPayment.effective_end_date <= adtAdjustToDate && (item.icdoPayeeAccountRetroPayment.retro_payment_type_value == "IRPM" || item.icdoPayeeAccountRetroPayment.retro_payment_type_value == busConstant.RETRO_PAYMENT_REEMPLOYMENT)).ToList().ToCollection();
                             foreach (busPayeeAccountRetroPayment lbusPayeeAccountRetroPayment in lclEffectivebusPayeeAccountRetroPayment)
                             {
                                 lbusPayeeAccountRetroPayment.LoadPayeeAccountRetroPaymentDetails();
                                 foreach (busPayeeAccountRetroPaymentDetail lbusPayeeAccountRetroPaymentDetail in lbusPayeeAccountRetroPayment.iclbPayeeAccountRetroPaymentDetail)
                                 {
                                     lbusPayeeAccountRetroPaymentDetail.LoadPaymentItemType();
                                     if (lbusPayeeAccountRetroPayment.icdoPayeeAccountRetroPayment.is_overpayment_flag == busConstant.FLAG_YES)
                                     {
                                         if (lbusPayeeAccountRetroPaymentDetail.ibusPaymentItemType.icdoPaymentItemType.taxable_item_flag == busConstant.FLAG_YES &&
                                             lbusPayeeAccountRetroPaymentDetail.ibusPaymentItemType.icdoPaymentItemType.item_type_direction == 1)
                                         {
                                             ldecTaxableRetroPaymentMade -= lbusPayeeAccountRetroPaymentDetail.icdoPayeeAccountRetroPaymentDetail.amount;
                                         }
                                         else if (lbusPayeeAccountRetroPaymentDetail.ibusPaymentItemType.icdoPaymentItemType.taxable_item_flag == busConstant.FLAG_NO &&
                                             lbusPayeeAccountRetroPaymentDetail.ibusPaymentItemType.icdoPaymentItemType.item_type_direction == 1)
                                         {
                                             ldecNonTaxableRetroPaymentMade -= lbusPayeeAccountRetroPaymentDetail.icdoPayeeAccountRetroPaymentDetail.amount;
                                         }
                                     }
                                     else if (lbusPayeeAccountRetroPayment.icdoPayeeAccountRetroPayment.retro_payment_type_value == busConstant.RETRO_PAYMENT_INITIAL)
                                     {
                                         if (lbusPayeeAccountRetroPaymentDetail.ibusPaymentItemType.icdoPaymentItemType.taxable_item_flag == busConstant.FLAG_YES &&
                                            lbusPayeeAccountRetroPaymentDetail.ibusPaymentItemType.icdoPaymentItemType.item_type_direction == 1)
                                         {
                                             ldecTaxableRetroPaymentMade += lbusPayeeAccountRetroPaymentDetail.icdoPayeeAccountRetroPaymentDetail.amount;
                                         }
                                         else if (lbusPayeeAccountRetroPaymentDetail.ibusPaymentItemType.icdoPaymentItemType.taxable_item_flag == busConstant.FLAG_NO &&
                                             lbusPayeeAccountRetroPaymentDetail.ibusPaymentItemType.icdoPaymentItemType.item_type_direction == 1)
                                         {
                                             ldecNonTaxableRetroPaymentMade += lbusPayeeAccountRetroPaymentDetail.icdoPayeeAccountRetroPaymentDetail.amount;
                                         }
                                     }
                                 }
                             }
                         }
                     }
                      */
                    #endregion


                    #region AmountAlreadyPaidToTheAlternatePayee
                    Collection<busBenefitMonthwiseAdjustmentDetail> lclbBenefitMonthwiseAdjustmentDetail = new Collection<busBenefitMonthwiseAdjustmentDetail>();
                    lclbBenefitMonthwiseAdjustmentDetail = ibusCalculation.GetAmountActuallyPaid(lbusPayeeAccount, adtAdjustFromDate, adtAdjustToDate);
                    #endregion

                    #region Amount Should Have been Paid to the AlternatePayee
                    busBenefitMonthwiseAdjustmentDetail lbusParticipantBenefitMonthwiseAdjustmentDetail;
                    foreach (busBenefitMonthwiseAdjustmentDetail lbusBenefitMonthwiseAdjustmentDetail in lclbBenefitMonthwiseAdjustmentDetail)
                    {
                        if (aclbParticipantBenefitMonthwiseAdjustmentDetail.Where(item => item.icdoBenefitMonthwiseAdjustmentDetail.payment_date == lbusBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.payment_date).Count() > 0)
                        {
                            lbusParticipantBenefitMonthwiseAdjustmentDetail = new busBenefitMonthwiseAdjustmentDetail { icdoBenefitMonthwiseAdjustmentDetail = new cdoBenefitMonthwiseAdjustmentDetail() };

                            if (lbusParticipantBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.suspended_flag == busConstant.FLAG_YES)
                            {
                                if (ablnEEDerived)
                                {
                                    lbusBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.taxable_amount_to_be_paid = lbusParticipantBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.taxable_amount_to_be_paid * ldecFlatPercentage;
                                    lbusBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.non_taxable_amount_to_be_paid = lbusParticipantBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.non_taxable_amount_to_be_paid * ldecFlatPercentage;
                                }
                            }
                            else
                            {
                                lbusBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.taxable_amount_to_be_paid = lbusParticipantBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.taxable_amount_to_be_paid * ldecFlatPercentage + ldecFlatAmount;
                                lbusBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.non_taxable_amount_to_be_paid = lbusParticipantBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.non_taxable_amount_to_be_paid * ldecFlatPercentage;
                            }
                            lbusParticipantBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.idecAlternatePayeeMonthlyNonTaxableOffset += lbusBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.non_taxable_amount_to_be_paid;
                            lbusParticipantBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.idecAlternatePayeeMonthlyTaxableOffset += lbusBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.taxable_amount_to_be_paid;

                        }

                    }
                    ibusCalculation.CreateOverpaymentUnderPayment(this, lclbBenefitMonthwiseAdjustmentDetail, busConstant.RETRO_PAYMENT_REEMPLOYMENT, ldecTaxableRetroPaymentMade, ldecNonTaxableRetroPaymentMade);
                    #endregion


                }
            }
        }

        public decimal GetEEDerivedBenefit(decimal adecTotalAmount, decimal adecAge, DateTime adtRetirementDate, string astrBenefitSubType = "", decimal adecBenAge = 0)
        {
            busCalculation lbusCalculation = new busCalculation();

            decimal ldecERF = 1;
            decimal ldecBenefitOptionFactor = 1;

            decimal ldecEEDerivedAmount = decimal.Zero;
            decimal ldecTableAfactor = lbusCalculation.GetTableAFactor(adecAge, busConstant.MPIPP_PLAN_ID, adtRetirementDate.Year);
            decimal ldecTableBfactor = lbusCalculation.GetTableBFactorForEEDerived(busConstant.BENEFIT_TYPE_RETIREMENT, busConstant.RETIREMENT_TYPE_LATE, 2,
                                                           Math.Floor(adecAge), adtRetirementDate.Year < 1988 ? 1988 : adtRetirementDate.Year);
            if (ldecTableBfactor > 0)
            {
                ldecEEDerivedAmount = Math.Round(((adecTotalAmount * ldecTableAfactor) / ldecTableBfactor), 2);
            }
            ldecEEDerivedAmount = GetEEDerivedToBePaid(ldecEEDerivedAmount, astrBenefitSubType, adecAge, adecBenAge);

            return ldecEEDerivedAmount;
        }

        public decimal GetEEDerivedToBePaid(decimal adecEEDerivedAmount, string astrBenefitSubType, decimal adecAge, decimal adecBenAge)
        {
            decimal ldecEEDerivedToBePaid = decimal.Zero;
            decimal ldecERF = 1;
            decimal ldecBenefitOptionFactor = decimal.Zero;
            if (adecEEDerivedAmount > decimal.Zero && !string.IsNullOrEmpty(astrBenefitSubType))
            {
                if (astrBenefitSubType == busConstant.RETIREMENT_TYPE_REDUCED_EARLY || astrBenefitSubType == busConstant.RETIREMENT_TYPE_SPL_REDUCED_EARLY)
                {
                    ldecERF = ibusCalculation.GetEarlyReductionFactor(busConstant.MPIPP_PLAN_ID, astrBenefitSubType, this.icdoPayeeAccount.retirement_type_value,
                                                                Convert.ToInt32(Math.Floor(adecAge)));
                }
            }
            ldecBenefitOptionFactor = ibusCalculation.GetBenefitOptionFactor(astrBenefitSubType, this.icdoPayeeAccount.plan_benefit_id, Convert.ToInt32(Math.Floor(adecAge)), Convert.ToInt32(Math.Floor(adecBenAge)));

            ldecEEDerivedToBePaid = Math.Round(Math.Round(adecEEDerivedAmount * ldecERF, 2) * ldecBenefitOptionFactor, 2);

            return ldecEEDerivedToBePaid;
        }

        public void ChangePayeeAccountStatusBasedOnEEDerivedBenefit(int aintPayeeAccountID, decimal adecTotalAmount, decimal adecAge, DateTime adtRetirementDate, decimal adecEEDerivedBenefit, string astrBenefitOptionValue, DateTime adtBatchRunDate, int aintPlanID, string astrReemployedRule)
        {
            decimal ldecEEDerivedBenefit = adecEEDerivedBenefit;
            if (ldecEEDerivedBenefit == decimal.Zero)
            {
                ldecEEDerivedBenefit = GetEEDerivedBenefit(adecTotalAmount, adecAge, adtRetirementDate);
            }
            if (ldecEEDerivedBenefit > 0)
            {
                CreateReviewPayeeAccountStatus();
                //busPayeeAccountStatus lbusPayeeAccountStatus = new busPayeeAccountStatus { icdoPayeeAccountStatus = new cdoPayeeAccountStatus() };
                //lbusPayeeAccountStatus.InsertValuesInPayeeAccountStatus(aintPayeeAccountID, busConstant.PAYEE_ACCOUNT_STATUS_REVIEW, DateTime.Now);
                UpdatePaymentItemTypeWithNewEEAmount(astrReemployedRule, ldecEEDerivedBenefit, astrBenefitOptionValue, adtBatchRunDate, aintPlanID);
                // 1.) OPUS must re-calculate taxes when Payee Account status is set to Review.
                if (this.idtNextBenefitPaymentDate == DateTime.MinValue)
                    this.LoadNextBenefitPaymentDate();
                this.ProcessTaxWithHoldingDetails();

                // 2.) initiate Update Payee Account.
                busWorkflowHelper.InitializeWorkflow(busConstant.UPDATE_PAYEE_ACCOUNT, this.icdoPayeeAccount.person_id, 0, this.icdoPayeeAccount.payee_account_id, new Hashtable());
                this.icdoPayeeAccount.ee_derived_benefit_amount = ldecEEDerivedBenefit;

            }
            else
            {
                busPayeeAccountStatus lbusPayeeAccountStatus = new busPayeeAccountStatus { icdoPayeeAccountStatus = new cdoPayeeAccountStatus() };
                lbusPayeeAccountStatus.InsertValuesInPayeeAccountStatus(this.icdoPayeeAccount.payee_account_id, busConstant.PAYEE_ACCOUNT_STATUS_SUSPENDED, DateTime.Now, astrReemployedRule);
            }
        }


        public void UpdatePaymentItemTypeWithNewAmount(busPayeeAccount abusPayeeAccount, decimal adecMEA, decimal adecAmount, decimal adecNonTaxableBegBalance, string astrBenefitOptionValue, DateTime adtBatchRunDate, int aintPlanId, ref decimal adecTaxableBenefitAmount)
        {
            string lstrChildSupportSpousal = string.Empty;
            decimal ldecChildSupportAmount = decimal.Zero;
            decimal ldecTaxableAmount = adecAmount;
            decimal ldecMea = adecMEA;
            abusPayeeAccount.LoadNextBenefitPaymentDate();
            DateTime ldteNextBenefitPaymentDate = this.idtNextBenefitPaymentDate;
            if (this.icdoPayeeAccount.iintPlanId != busConstant.IAP_PLAN_ID)
            {
                if (astrBenefitOptionValue == busConstant.LUMP_SUM)
                {
                    decimal ldecLumpSumAmountPaidOut = decimal.Zero;
                    bool lblnLumpSumPaidOut = false;
                    DataTable ldtTable = Select("cdoPaymentHistoryHeader.GetLumpSumAmountPaidOut", new object[1] { abusPayeeAccount.icdoPayeeAccount.payee_account_id });
                    if (ldtTable.Rows.Count > 0)
                    {
                        ldecLumpSumAmountPaidOut = Convert.ToDecimal(ldtTable.Rows[0][0]);
                        if (ldecLumpSumAmountPaidOut > 0)
                        {
                            lblnLumpSumPaidOut = true;
                        }
                    }
                    if (lblnLumpSumPaidOut)
                    {
                        abusPayeeAccount.CreatePayeeAccountPaymentItemType(busConstant.ITEM21, ldecTaxableAmount - ldecLumpSumAmountPaidOut, "0", 0,
                                                 ldteNextBenefitPaymentDate, DateTime.MinValue, "N", false);

                    }
                    else
                    {
                        // Create Non Taxable As well here.
                        abusPayeeAccount.CreatePayeeAccountPaymentItemType(busConstant.ITEM22, adecNonTaxableBegBalance, "0", 0,
                             ldteNextBenefitPaymentDate, DateTime.MinValue, "N", false);

                        // Create Non Taxab
                        abusPayeeAccount.CreatePayeeAccountPaymentItemType(busConstant.ITEM21, ldecTaxableAmount - adecNonTaxableBegBalance, "0", 0,
                             ldteNextBenefitPaymentDate, DateTime.MinValue, "N", false);

                    }
                    //Get Taxable non taxable both

                }
                else
                {
                    abusPayeeAccount.GetPaymentItemsOfTheParticipant(adecAmount, adtBatchRunDate, ldteNextBenefitPaymentDate, out ldecChildSupportAmount, out lstrChildSupportSpousal);

                    #region Insert New Payment Item Types
                    ldecTaxableAmount = ldecTaxableAmount - ldecMea;
                    abusPayeeAccount.InsertNewPaymentItemTypes(ldecTaxableAmount, ldecMea, ldecChildSupportAmount, ldteNextBenefitPaymentDate, lstrChildSupportSpousal);
                    #endregion

                    #region Update Payee Account Status
                    busPayeeAccountStatus lbusPayeeAccountStatus = new busPayeeAccountStatus { icdoPayeeAccountStatus = new cdoPayeeAccountStatus() };
                    lbusPayeeAccountStatus.InsertValuesInPayeeAccountStatus(abusPayeeAccount.icdoPayeeAccount.payee_account_id, busConstant.PAYEE_ACCOUNT_STATUS_REVIEW, DateTime.Now);
                    #endregion

                    adecTaxableBenefitAmount = ldecTaxableAmount;
                }
            }
            else
            {
                abusPayeeAccount.CreatePayeeAccountPaymentItemType(busConstant.ITEM21, ldecTaxableAmount, "0", 0,
                         ldteNextBenefitPaymentDate, DateTime.MinValue, "N", false);

            }


        }


        /// <summary>
        /// To pass the benefit amount , could be ee derived in case of ReEmployedParticipants
        /// </summary>
        /// <param name="adecAmount"></param>
        public void UpdatePaymentItemTypeWithNewEEAmount(string astrReemployedRule, decimal adecAmount, string astrBenefitOptionValue, DateTime adtBatchRunDate, int aintPlanId)
        {
            string lstrChildSupportSpousal = string.Empty;
            decimal ldecChildSupportAmount = decimal.Zero;
            decimal ldecTaxableAmount = adecAmount;
            decimal ldecMea = decimal.Zero;
            DateTime ldteNextBenefitPaymentDate = busPayeeAccountHelper.GetLastBenefitPaymentDate(this.icdoPayeeAccount.iintPlanId).AddMonths(1);

            if (astrBenefitOptionValue == busConstant.LUMP_SUM)
            {
                CreatePayeeAccountPaymentItemType(busConstant.ITEM21, ldecTaxableAmount, "0", 0,
                                                             ldteNextBenefitPaymentDate, DateTime.MinValue, "N", false);

            }
            else
            {
                GetPaymentItemsOfTheParticipantToInsertEEDerived(adecAmount, adtBatchRunDate, ldteNextBenefitPaymentDate, out ldecChildSupportAmount, out lstrChildSupportSpousal, out ldecTaxableAmount, out ldecMea);

                //if (this.iclbPayeeAccountPaymentItemType.IsNullOrEmpty())
                //    LoadPayeeAccountPaymentItemType();

                //// Active Payee Account Payment Item type
                //iclbPayeeAccountPaymentItemTypeActive = (from item in this.iclbPayeeAccountPaymentItemType
                //                                         where busGlobalFunctions.CheckDateOverlapping(idtNextBenefitPaymentDate,
                //                                         item.icdoPayeeAccountPaymentItemType.start_date, item.icdoPayeeAccountPaymentItemType.end_date)
                //                                         select item).ToList().ToCollection<busPayeeAccountPaymentItemType>();

                //decimal ldecMea = 0;
                //if (iclbPayeeAccountPaymentItemTypeActive.Where(item => item.ibusPaymentItemType.icdoPaymentItemType.item_type_code ==
                //    busConstant.ITEM41 || item.ibusPaymentItemType.icdoPaymentItemType.item_type_code == busConstant.ITEM42 || item.ibusPaymentItemType.icdoPaymentItemType.item_type_code ==
                //    busConstant.ITEM43 || item.ibusPaymentItemType.icdoPaymentItemType.item_type_code == busConstant.ITEM44).Count() > 0)
                //{
                //    lstrChildSupportSpousal = iclbPayeeAccountPaymentItemTypeActive.Where(item => item.ibusPaymentItemType.icdoPaymentItemType.item_type_code ==
                //        busConstant.ITEM41 || item.ibusPaymentItemType.icdoPaymentItemType.item_type_code == busConstant.ITEM42 || item.ibusPaymentItemType.icdoPaymentItemType.item_type_code ==
                //        busConstant.ITEM43 || item.ibusPaymentItemType.icdoPaymentItemType.item_type_code == busConstant.ITEM44).FirstOrDefault().ibusPaymentItemType.icdoPaymentItemType.item_type_code;

                //    ldecChildSupportAmount = iclbPayeeAccountPaymentItemTypeActive.Where(item => item.ibusPaymentItemType.icdoPaymentItemType.item_type_code ==
                //        busConstant.ITEM41 || item.ibusPaymentItemType.icdoPaymentItemType.item_type_code == busConstant.ITEM42 || item.ibusPaymentItemType.icdoPaymentItemType.item_type_code ==
                //        busConstant.ITEM43 || item.ibusPaymentItemType.icdoPaymentItemType.item_type_code == busConstant.ITEM44).FirstOrDefault().icdoPayeeAccountPaymentItemType.amount;
                //}

                //if (this.iclbPayeeAccountPaymentItemTypeActive.Where(lbusPayeeAccountPaymentItemType =>
                //    lbusPayeeAccountPaymentItemType.ibusPaymentItemType.icdoPaymentItemType.item_type_code == busConstant.ITEM2).Count() > 0)
                //{
                //    ldecMea = this.iclbPayeeAccountPaymentItemTypeActive.Where(lbusPayeeAccountPaymentItemType =>
                //    lbusPayeeAccountPaymentItemType.ibusPaymentItemType.icdoPaymentItemType.item_type_code == busConstant.ITEM2).FirstOrDefault().icdoPayeeAccountPaymentItemType.amount;
                //}
                //foreach (busPayeeAccountPaymentItemType lbusPayeeAccountPaymentItemType in this.iclbPayeeAccountPaymentItemTypeActive)
                //{
                //    if (lbusPayeeAccountPaymentItemType.ibusPaymentItemType.icdoPaymentItemType.item_type_code != busConstant.ITEM2)
                //    {
                //        lbusPayeeAccountPaymentItemType.icdoPayeeAccountPaymentItemType.end_date = DateTime.Now;
                //    }
                //}
                //if (ldecMea > 0)
                //{
                //    ldecTaxableAmount = adecAmount - ldecMea;
                //}

                #region Check Dro Of The Participant

                decimal ldecTotalAPMea = decimal.Zero;
                decimal ldecTotalAPeeTaxable = decimal.Zero;
                GetDroRetireeModelsForParticipant(astrReemployedRule, ldecTaxableAmount, ldecMea, this.icdoPayeeAccount.reemployed_flag_as_of_date, adtBatchRunDate, out ldecTotalAPMea, out ldecTotalAPeeTaxable, aintPlanId);
                ldecTaxableAmount = ldecTaxableAmount - ldecTotalAPeeTaxable;
                ldecMea = ldecMea - ldecTotalAPMea;

                #endregion

                #region Insert New Payment Item Types
                /*
                CreatePayeeAccountPaymentItemType(busConstant.ITEM1, ldecTaxableAmount, "0", 0,
                                                                                 ldteNextBenefitPaymentDate, DateTime.MinValue, "N", false);
                //OPUS must not create payment distribution for participant if net benefit is less than Child Support, IRS Levy or Spousal Support 
                //deductions. OPUS must create payment distribution to person/organization entitled to that deduction.
                if (!string.IsNullOrEmpty(lstrChildSupportSpousal))
                {
                    if (ldecChildSupportAmount > ldecMea + ldecTaxableAmount)
                    {
                        CreatePayeeAccountPaymentItemType(lstrChildSupportSpousal, ldecMea + ldecTaxableAmount, "0", 0,
                                                                     ldteNextBenefitPaymentDate, DateTime.MinValue, "N", false);
                    }
                    else
                    {
                        CreatePayeeAccountPaymentItemType(lstrChildSupportSpousal, ldecChildSupportAmount , "0", 0,
                                             ldteNextBenefitPaymentDate, DateTime.MinValue, "N", false);

                    }

                }

                #endregion


                #region Update Payee Account
                //DateTime? date = new DateTime?();
                this.icdoPayeeAccount.reemployed_flag = busConstant.FLAG_YES;
                this.icdoPayeeAccount.reemployed_flag_as_of_date = DateTime.Now;
                this.icdoPayeeAccount.Update();
                */
                #endregion

                InsertNewPaymentItemTypes(ldecTaxableAmount, ldecMea, ldecChildSupportAmount, ldteNextBenefitPaymentDate, lstrChildSupportSpousal);
            }


        }

        public void InsertNewPaymentItemTypes(decimal adecTaxableAmount, decimal adecMea, decimal adecChildSupportAmount, DateTime adteNextBenefitPaymentDate, string astrChildSupportSpousal)
        {
            #region Insert New Payment Item Types

            //OPUS must not create payment distribution for participant if net benefit is less than Child Support, IRS Levy or Spousal Support 
            //deductions. OPUS must create payment distribution to person/organization entitled to that deduction.
            decimal ldecTotalRemainingAnount = adecTaxableAmount + adecMea;
            if (adecMea > 0)
            {
                CreatePayeeAccountPaymentItemType(busConstant.ITEM2, adecMea, "0", 0,
                                             adteNextBenefitPaymentDate, DateTime.MinValue, "N", false);
                CreatePayeeAccountPaymentItemType(busConstant.ITEM1, adecTaxableAmount, "0", 0,
                                                                 adteNextBenefitPaymentDate, DateTime.MinValue, "N", false);
            }
            else
            {
                CreatePayeeAccountPaymentItemType(busConstant.ITEM1, adecTaxableAmount, "0", 0,
                                                                 adteNextBenefitPaymentDate, DateTime.MinValue, "N", false);
            }

            if (!string.IsNullOrEmpty(astrChildSupportSpousal))
            {
                if (adecChildSupportAmount > adecMea + adecTaxableAmount)
                {
                    CreatePayeeAccountPaymentItemType(astrChildSupportSpousal, adecMea + adecTaxableAmount, "0", 0,
                                                                 adteNextBenefitPaymentDate, DateTime.MinValue, "N", false);
                }
                else
                {
                    CreatePayeeAccountPaymentItemType(astrChildSupportSpousal, adecChildSupportAmount, "0", 0,
                                         adteNextBenefitPaymentDate, DateTime.MinValue, "N", false);
                }
            }
            #endregion

        }

        public void CheckForChildSupportOrSpousalForAlternatepayee(out string astrChildSupportSpousal, out decimal adecChildSupportSpousalAmount)
        {
            astrChildSupportSpousal = string.Empty;
            adecChildSupportSpousalAmount = decimal.Zero;
            if (this.iclbPayeeAccountPaymentItemType.IsNullOrEmpty())
                LoadPayeeAccountPaymentItemType();

            // Active Payee Account Payment Item type
            iclbPayeeAccountPaymentItemTypeActive = (from item in this.iclbPayeeAccountPaymentItemType
                                                     where busGlobalFunctions.CheckDateOverlapping(idtNextBenefitPaymentDate,
                                                     item.icdoPayeeAccountPaymentItemType.start_date, item.icdoPayeeAccountPaymentItemType.end_date)
                                                     select item).ToList().ToCollection<busPayeeAccountPaymentItemType>();

            if (iclbPayeeAccountPaymentItemTypeActive.Where(item => item.ibusPaymentItemType.icdoPaymentItemType.item_type_code ==
                busConstant.ITEM41 || item.ibusPaymentItemType.icdoPaymentItemType.item_type_code == busConstant.ITEM42 || item.ibusPaymentItemType.icdoPaymentItemType.item_type_code ==
                busConstant.ITEM43 || item.ibusPaymentItemType.icdoPaymentItemType.item_type_code == busConstant.ITEM44).Count() > 0)
            {
                astrChildSupportSpousal = iclbPayeeAccountPaymentItemTypeActive.Where(item => item.ibusPaymentItemType.icdoPaymentItemType.item_type_code ==
                    busConstant.ITEM41 || item.ibusPaymentItemType.icdoPaymentItemType.item_type_code == busConstant.ITEM42 || item.ibusPaymentItemType.icdoPaymentItemType.item_type_code ==
                    busConstant.ITEM43 || item.ibusPaymentItemType.icdoPaymentItemType.item_type_code == busConstant.ITEM44).FirstOrDefault().ibusPaymentItemType.icdoPaymentItemType.item_type_code;

                adecChildSupportSpousalAmount = iclbPayeeAccountPaymentItemTypeActive.Where(item => item.ibusPaymentItemType.icdoPaymentItemType.item_type_code ==
                    busConstant.ITEM41 || item.ibusPaymentItemType.icdoPaymentItemType.item_type_code == busConstant.ITEM42 || item.ibusPaymentItemType.icdoPaymentItemType.item_type_code ==
                    busConstant.ITEM43 || item.ibusPaymentItemType.icdoPaymentItemType.item_type_code == busConstant.ITEM44).FirstOrDefault().icdoPayeeAccountPaymentItemType.amount;
            }

        }


        public void GetPaymentItemsOfTheParticipantToInsertEEDerived(decimal adecAmount, DateTime adtBatchRunDate, DateTime adtNextBenefitPaymentDate, out decimal adecChildSupportAmount, out string astrChildSupportSpousal, out decimal adecTaxableAmount, out decimal adecMEA)
        {
            astrChildSupportSpousal = string.Empty;
            adecChildSupportAmount = decimal.Zero;
            adecTaxableAmount = adecAmount;
            adecMEA = decimal.Zero;
            if (this.iclbPayeeAccountPaymentItemType.IsNullOrEmpty())
                LoadPayeeAccountPaymentItemType();

            // Active Payee Account Payment Item type
            iclbPayeeAccountPaymentItemTypeActive = (from item in this.iclbPayeeAccountPaymentItemType
                                                     where busGlobalFunctions.CheckDateOverlapping(adtNextBenefitPaymentDate,
                                                     item.icdoPayeeAccountPaymentItemType.start_date, item.icdoPayeeAccountPaymentItemType.end_date)
                                                     select item).ToList().ToCollection<busPayeeAccountPaymentItemType>();

            if (iclbPayeeAccountPaymentItemTypeActive.Where(item => item.ibusPaymentItemType.icdoPaymentItemType.item_type_code ==
                busConstant.ITEM41 || item.ibusPaymentItemType.icdoPaymentItemType.item_type_code == busConstant.ITEM42 || item.ibusPaymentItemType.icdoPaymentItemType.item_type_code ==
                busConstant.ITEM43 || item.ibusPaymentItemType.icdoPaymentItemType.item_type_code == busConstant.ITEM44).Count() > 0)
            {
                astrChildSupportSpousal = iclbPayeeAccountPaymentItemTypeActive.Where(item => item.ibusPaymentItemType.icdoPaymentItemType.item_type_code ==
                    busConstant.ITEM41 || item.ibusPaymentItemType.icdoPaymentItemType.item_type_code == busConstant.ITEM42 || item.ibusPaymentItemType.icdoPaymentItemType.item_type_code ==
                    busConstant.ITEM43 || item.ibusPaymentItemType.icdoPaymentItemType.item_type_code == busConstant.ITEM44).FirstOrDefault().ibusPaymentItemType.icdoPaymentItemType.item_type_code;

                adecChildSupportAmount = iclbPayeeAccountPaymentItemTypeActive.Where(item => item.ibusPaymentItemType.icdoPaymentItemType.item_type_code ==
                    busConstant.ITEM41 || item.ibusPaymentItemType.icdoPaymentItemType.item_type_code == busConstant.ITEM42 || item.ibusPaymentItemType.icdoPaymentItemType.item_type_code ==
                    busConstant.ITEM43 || item.ibusPaymentItemType.icdoPaymentItemType.item_type_code == busConstant.ITEM44).FirstOrDefault().icdoPayeeAccountPaymentItemType.amount;
            }

            if (this.iclbPayeeAccountPaymentItemTypeActive.Where(lbusPayeeAccountPaymentItemType =>
                lbusPayeeAccountPaymentItemType.ibusPaymentItemType.icdoPaymentItemType.item_type_code == busConstant.ITEM2).Count() > 0)
            {
                adecMEA = this.iclbPayeeAccountPaymentItemTypeActive.Where(lbusPayeeAccountPaymentItemType =>
                lbusPayeeAccountPaymentItemType.ibusPaymentItemType.icdoPaymentItemType.item_type_code == busConstant.ITEM2).FirstOrDefault().icdoPayeeAccountPaymentItemType.amount;
            }

            foreach (busPayeeAccountPaymentItemType lbusPayeeAccountPaymentItemType in this.iclbPayeeAccountPaymentItemTypeActive)
            {
                if (lbusPayeeAccountPaymentItemType.ibusPaymentItemType.icdoPaymentItemType.item_type_code != busConstant.ITEM2)
                {
                    lbusPayeeAccountPaymentItemType.icdoPayeeAccountPaymentItemType.end_date = adtNextBenefitPaymentDate.AddDays(-1);
                    lbusPayeeAccountPaymentItemType.icdoPayeeAccountPaymentItemType.Update();
                }
            }
            if (adecMEA > 0)
            {
                adecTaxableAmount = adecAmount - adecMEA;
            }
        }

        public void GetPaymentItemsOfTheParticipant(decimal adecAmount, DateTime adtBatchRunDate, DateTime adtNextBenefitPaymentDate, out decimal adecChildSupportAmount, out string astrChildSupportSpousal)
        {
            astrChildSupportSpousal = string.Empty;
            adecChildSupportAmount = decimal.Zero;
            if (this.iclbPayeeAccountPaymentItemType.IsNullOrEmpty())
                LoadPayeeAccountPaymentItemType();

            // Active Payee Account Payment Item type
            iclbPayeeAccountPaymentItemTypeActive = (from item in this.iclbPayeeAccountPaymentItemType
                                                     where busGlobalFunctions.CheckDateOverlapping(adtNextBenefitPaymentDate,
                                                     item.icdoPayeeAccountPaymentItemType.start_date, item.icdoPayeeAccountPaymentItemType.end_date)
                                                     select item).ToList().ToCollection<busPayeeAccountPaymentItemType>();

            if (!this.iclcReemploymentHistory.IsNullOrEmpty())
            {
                if (this.iclcReemploymentHistory.Where(item => item.reemployed_flag_to_date == DateTime.MinValue).Count() > 0)
                {
                    astrChildSupportSpousal = this.iclcReemploymentHistory.Where(item => item.reemployed_flag_to_date == DateTime.MinValue).FirstOrDefault().support_deduction_item_code;
                    adecChildSupportAmount = this.iclcReemploymentHistory.Where(item => item.reemployed_flag_to_date == DateTime.MinValue).FirstOrDefault().support_deduction_amount;
                }
            }

            //if (this.iclbPayeeAccountPaymentItemTypeActive.Where(lbusPayeeAccountPaymentItemType =>
            //    lbusPayeeAccountPaymentItemType.ibusPaymentItemType.icdoPaymentItemType.item_type_code == busConstant.ITEM2).Count() > 0)
            //{
            //    adecMEA = this.iclbPayeeAccountPaymentItemTypeActive.Where(lbusPayeeAccountPaymentItemType =>
            //    lbusPayeeAccountPaymentItemType.ibusPaymentItemType.icdoPaymentItemType.item_type_code == busConstant.ITEM2).FirstOrDefault().icdoPayeeAccountPaymentItemType.amount;
            //}
            /*
            //Collection<busPayeeAccountPaymentItemType> lclbPayeeAccountPaymentItemTypeDelete = new Collection<busPayeeAccountPaymentItemType>();
            foreach (busPayeeAccountPaymentItemType lbusPayeeAccountPaymentItemType in this.iclbPayeeAccountPaymentItemTypeActive)
            {
                if (lbusPayeeAccountPaymentItemType.ibusPaymentItemType.icdoPaymentItemType.item_type_code != busConstant.ITEM2)
                {
                    CreatePayeeAccountPaymentItemType(lbusPayeeAccountPaymentItemType.ibusPaymentItemType.icdoPaymentItemType.item_type_code, 0,
                        lbusPayeeAccountPaymentItemType.icdoPayeeAccountPaymentItemType.account_number,
                        lbusPayeeAccountPaymentItemType.icdoPayeeAccountPaymentItemType.vendor_org_id,
                        adtNextBenefitPaymentDate, DateTime.MinValue, "N", false);
                    //Review with Kunal
                    //if (adtNextBenefitPaymentDate.AddDays(-1) > lbusPayeeAccountPaymentItemType.icdoPayeeAccountPaymentItemType.start_date)
                    //{
                    //    lbusPayeeAccountPaymentItemType.icdoPayeeAccountPaymentItemType.end_date = adtNextBenefitPaymentDate.AddDays(-1);
                    //    lbusPayeeAccountPaymentItemType.icdoPayeeAccountPaymentItemType.Update();
                    //}
                    //else
                    //{
                    //    lclbPayeeAccountPaymentItemTypeDelete.Add(lbusPayeeAccountPaymentItemType);
                    //}
                }
                else
                {

                }
            }*/
            //if (lclbPayeeAccountPaymentItemTypeDelete.Count > 0)
            //{
            //    foreach (busPayeeAccountPaymentItemType lbusPayeeAccountPaymentItemType in lclbPayeeAccountPaymentItemTypeDelete)
            //    {
            //        lbusPayeeAccountPaymentItemType.icdoPayeeAccountPaymentItemType.Delete();
            //    }
            //}
            //if (adecMEA > 0)
            //{
            //    adecTaxableAmount = adecAmount - adecMEA;
            //}
        }


        public void UpdatePayeeAccount(DateTime adtBatchRunDate)
        {
            #region Update Payee Account
            //DateTime? date = new DateTime?();
            this.icdoPayeeAccount.reemployed_flag = busConstant.FLAG_YES;
            this.icdoPayeeAccount.reemployed_flag_as_of_date = adtBatchRunDate;
            this.icdoPayeeAccount.Update();
            #endregion

        }

        public void CreateCorrespondenceForReEmployedParticipant(DataRow adtPayeeInfo, string astrCorrespondence)
        {
            ArrayList arrResult = new ArrayList();
            if (this.ibusPayee.IsNull())
            {
                ibusPayee = new busPerson { icdoPerson = new cdoPerson() };
                ibusPayee.icdoPerson.LoadData(adtPayeeInfo);
            }
            arrResult.Add(this);
            //this.CreateCorrespondence(busConstant.PERO_0004, this.iobjPassInfo.istrUserID, this.iobjPassInfo.iintUserSerialID, arrResult, new Hashtable());
        }


        public busBenefitCalculationRetirement ReEvaluateReemployedParticipants(DataTable adtReEmployedHoursAfterRetirementDate, DataRow adtPayeeAccount, DateTime adtBenefitEffectiveDate, DateTime adtBatchRunDate, busBenefitCalculationRetirement abusBenefitCalculationHeader = null, bool ablnPostRetDeath = false, bool ablnLateHoursReported = false)
        {
            #region Properties
            busBenefitCalculationRetirement lbusBenefitCalculationRetirement = new busBenefitCalculationRetirement { icdoBenefitCalculationHeader = new cdoBenefitCalculationHeader() };
            busBenefitCalculationDetail lbusBenefitCalculationDetail = new busBenefitCalculationDetail { icdoBenefitCalculationDetail = new cdoBenefitCalculationDetail() };
            busBenefitApplicationDetail lbusBenefitApplicationDetail = new busBenefitApplicationDetail { icdoBenefitApplicationDetail = new cdoBenefitApplicationDetail() };


            bool lblnStartCalculatingFromRetirement = false;
            bool lblnCreateMinDistributionCalculation = false;
            DateTime ldtMinDistrubutionDate = new DateTime();
            string lstrPayeeAccountCreatedBy = Convert.ToString(adtPayeeAccount["CREATED_BY"]);
            this.ibusPayee = new busPerson { icdoPerson = new cdoPerson() };
            this.ibusPayee.icdoPerson.LoadData(adtPayeeAccount);


            string lstrSpouseDOB = Convert.ToString(adtPayeeAccount["BEN_DOB"]);
            DateTime ldtSpouseDOB = new DateTime();
            //change the query to get dob for spouse.

            int lintBenAppId = Convert.ToInt32(adtPayeeAccount[enmBenefitApplication.benefit_application_id.ToString()]);
            decimal ldecParticipantAge = busGlobalFunctions.CalculatePersonAge(this.ibusPayee.icdoPerson.idtDateofBirth, adtBatchRunDate);
            if (this.ibusPayee.icdoPerson.date_of_death != DateTime.MinValue)
            {
                ldecParticipantAge = busGlobalFunctions.CalculatePersonAge(this.ibusPayee.icdoPerson.idtDateofBirth, this.ibusPayee.icdoPerson.date_of_death);
            }


            decimal ldecSpouseAge = busGlobalFunctions.CalculatePersonAge(ldtSpouseDOB, adtBatchRunDate);
            string lstrBenefitOptionValue = Convert.ToString(adtPayeeAccount[enmPlanBenefitXr.benefit_option_value.ToString()]);
            string lstrPlanCode = Convert.ToString(adtPayeeAccount[enmPlan.plan_code.ToString()]);
            if (lstrPlanCode == busConstant.IAP_PLAN)
            {
                lbusBenefitCalculationRetirement = ReCalculateBenefitForRetirement(lstrBenefitOptionValue, adtReEmployedHoursAfterRetirementDate, false, false, true, false, adtBenefitEffectiveDate, true);

            }
            else
            {
                bool lblnLumpSumPaidOut = false;
                decimal ldecLumpSumAmountPaidOut = decimal.Zero;
                if (lstrBenefitOptionValue == busConstant.LUMP_SUM)
                {
                    DataTable ldtTable = Select("cdoPaymentHistoryHeader.GetLumpSumAmountPaidOut", new object[1] { this.icdoPayeeAccount.payee_account_id });
                    if (ldtTable.Rows.Count > 0)
                    {
                        ldecLumpSumAmountPaidOut = Convert.ToDecimal(ldtTable.Rows[0][0]);
                        if (ldecLumpSumAmountPaidOut > 0)
                        {
                            lblnLumpSumPaidOut = true;
                        }
                    }
                }
                #endregion


                #region Adjustment_Late_Conversion_CalculationExists
                DataTable ldtAdjustments = busBase.Select("cdoBenefitApplicationDetail.GetLatestAdjustmentCalculation", new object[1] { this.icdoPayeeAccount.benefit_application_detail_id });

                if (ldtAdjustments.Rows.Count > 0)
                {
                    lbusBenefitCalculationRetirement = ReCalculateBenefitForRetirement(lstrBenefitOptionValue, adtReEmployedHoursAfterRetirementDate, false, false, true, false, adtBenefitEffectiveDate, true);
                    //ReeEvaluate Right From Scratch
                }
                else if (ablnLateHoursReported)
                {
                    lbusBenefitCalculationRetirement = ReCalculateBenefitForRetirement(lstrBenefitOptionValue, adtReEmployedHoursAfterRetirementDate, false, false, true, false, adtBenefitEffectiveDate, true);
                    //ReeEvaluate Right From Scratch
                }
                else if (lstrPayeeAccountCreatedBy == "CONVERSION" && this.icdoPayeeAccount.benefit_calculation_detail_id == 0)
                {
                    lbusBenefitCalculationRetirement = ReCalculateBenefitForRetirement(lstrBenefitOptionValue, adtReEmployedHoursAfterRetirementDate, false, false, true, false, adtBenefitEffectiveDate, true);
                    //ReeEvaluate Right From Scratch
                }
                else
                {
                    if (this.icdoPayeeAccount.benefit_calculation_detail_id > 0 && lbusBenefitCalculationDetail.FindBenefitCalculationDetail(this.icdoPayeeAccount.benefit_calculation_detail_id))
                    {
                        DataTable ldt = new DataTable();
                        int lintYear = 0;
                        lbusBenefitCalculationDetail.LoadBenefitCalculationOptionss();
                        bool lblnEvaluateBenefits = false;
                        if (ablnPostRetDeath)
                        {
                            if (lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.reemployed_accrued_benefit_effective_date != DateTime.MinValue)
                            {
                                if (lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.reemployed_accrued_benefit_effective_date < adtBenefitEffectiveDate)
                                {
                                    if (adtReEmployedHoursAfterRetirementDate.AsEnumerable().Where(o => o.Field<int>("Year") >=
                                        lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.reemployed_accrued_benefit_effective_date.Year).Count() > 0)
                                    {
                                        lblnEvaluateBenefits = true;
                                        lintYear = lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.reemployed_accrued_benefit_effective_date.Year;
                                        ldt = adtReEmployedHoursAfterRetirementDate.AsEnumerable().Where(o => o.Field<int>("Year") >= lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.reemployed_accrued_benefit_effective_date.Year).CopyToDataTable();
                                        LoadCalculatioObjectFromCalculationDetail(lbusBenefitCalculationDetail, lbusBenefitCalculationRetirement, lintBenAppId, lstrPlanCode, this.ibusPayee, ldecParticipantAge, ldecSpouseAge, adtBatchRunDate, ldt, lblnStartCalculatingFromRetirement);
                                    }

                                }
                            }
                            else
                            {
                                lblnEvaluateBenefits = true;
                                lblnStartCalculatingFromRetirement = true;
                                LoadCalculatioObjectFromCalculationDetail(lbusBenefitCalculationDetail, lbusBenefitCalculationRetirement, lintBenAppId, lstrPlanCode, this.ibusPayee, ldecParticipantAge, ldecSpouseAge, adtBatchRunDate, adtReEmployedHoursAfterRetirementDate, true);
                            }
                        }
                        else if (ldecParticipantAge == 65)
                        {
                            lblnEvaluateBenefits = true;
                            lblnStartCalculatingFromRetirement = true;
                            LoadCalculatioObjectFromCalculationDetail(lbusBenefitCalculationDetail, lbusBenefitCalculationRetirement, lintBenAppId, lstrPlanCode, this.ibusPayee, ldecParticipantAge, ldecSpouseAge, adtBatchRunDate, adtReEmployedHoursAfterRetirementDate, lblnStartCalculatingFromRetirement);
                        }
                        else
                        {
                            if (lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.reemployed_accrued_benefit_effective_date == DateTime.MinValue)
                            {
                                lblnStartCalculatingFromRetirement = true;
                                lblnEvaluateBenefits = true;
                            }
                            else if (lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.reemployed_accrued_benefit_effective_date < adtBenefitEffectiveDate && adtReEmployedHoursAfterRetirementDate.AsEnumerable().Where(o => o.Field<int>("Year") == adtBatchRunDate.AddYears(-1).Year).Count() > 0)
                            {
                                lblnEvaluateBenefits = true;
                                lintYear = adtBatchRunDate.AddYears(-1).Year;
                                ldt = adtReEmployedHoursAfterRetirementDate.AsEnumerable().Where(o => o.Field<int>("Year") == adtBatchRunDate.AddYears(-1).Year).CopyToDataTable();
                                LoadCalculatioObjectFromCalculationDetail(lbusBenefitCalculationDetail, lbusBenefitCalculationRetirement, lintBenAppId, lstrPlanCode, this.ibusPayee, ldecParticipantAge, ldecSpouseAge, adtBatchRunDate, ldt, lblnStartCalculatingFromRetirement, lintYear);
                            }
                        }
                        if (lblnEvaluateBenefits)
                        {
                            AddReemployedYearsToExistingCalculation(adtReEmployedHoursAfterRetirementDate, adtPayeeAccount, adtBatchRunDate, lbusBenefitCalculationRetirement, lblnStartCalculatingFromRetirement, lstrBenefitOptionValue, adtBenefitEffectiveDate, ablnPostRetDeath);
                        }
                    }
                }
            }

            #endregion
            return lbusBenefitCalculationRetirement;

        }

        public void AddReemployedYearsToExistingCalculation(DataTable adtReEmployedHoursAfterRetirementDate, DataRow adtPayeeAccount, DateTime adtBatchRunDate, busBenefitCalculationRetirement abusBenefitCalculationRetirement, bool ablnStartFromRetirement, string astrBenefitOptionValue, DateTime adtBenefitEffectiveDate, bool ablnPostRetDeath = false, bool ablnIsFromBatch = true)
        {
            if (adtReEmployedHoursAfterRetirementDate.IsNotNull() && adtReEmployedHoursAfterRetirementDate.Rows.Count > 0)
            {
                //lblnEvaluateBenefits = true;
                decimal ldecPrevBenefitAmount = decimal.Zero;
                decimal ldecPrevLifeBenefitAmount = decimal.Zero; //PIR 894
                string lstrSpouseDOB = Convert.ToString(adtPayeeAccount["BEN_DOB"]);
                DateTime ldtSpouseDOB = new DateTime();
                DateTime ldtMinDistrubutionDate = new DateTime();
                bool lblnCreateMinDistributionCalculation = false;

                //PIR - 930
                if (this.ibusPayee.icdoPerson.date_of_death == DateTime.MinValue && !ablnPostRetDeath)
                {
                    ldtMinDistrubutionDate = busGlobalFunctions.GetMinDistributionDate(this.ibusPayee.icdoPerson.person_id, this.ibusBenefitCalculationHeader.iclbBenefitCalculationDetail.Select(i => i.icdoBenefitCalculationDetail.vested_date).FirstOrDefault());
                    // ldtMinDistrubutionDate = new DateTime(this.ibusPayee.icdoPerson.idtDateofBirth.AddYears(70).AddMonths(6).AddYears(1).Year, 04, 01);
                    if (adtBenefitEffectiveDate > ldtMinDistrubutionDate)
                    {
                        lblnCreateMinDistributionCalculation = true;
                    }
                }
                if (!string.IsNullOrEmpty(lstrSpouseDOB))
                {
                    ldtSpouseDOB = Convert.ToDateTime(lstrSpouseDOB);
                }
                if (abusBenefitCalculationRetirement.ibusBenefitApplication.IsNotNull())
                {
                    abusBenefitCalculationRetirement.ibusBenefitApplication.aclbReEmployedWorkHistory = cdoDummyWorkData.GetCollection<cdoDummyWorkData>(adtReEmployedHoursAfterRetirementDate);
                    //PIR - 930                                      
                    abusBenefitCalculationRetirement.ibusBenefitApplication.ProcessWorkHistoryPadding(abusBenefitCalculationRetirement.ibusBenefitApplication.aclbReEmployedWorkHistory, busConstant.MPIPP);

                    this.LoadWorkDataCollectionObjectAfterRetirement(abusBenefitCalculationRetirement.ibusBenefitApplication.aclbReEmployedWorkHistory, abusBenefitCalculationRetirement.ibusPerson, abusBenefitCalculationRetirement.icdoBenefitCalculationHeader.retirement_date);
                    //PIR 627 sort by year
                    abusBenefitCalculationRetirement.ibusBenefitApplication.aclbReEmployedWorkHistory = abusBenefitCalculationRetirement.ibusBenefitApplication.aclbReEmployedWorkHistory.OrderBy(item => item.year).ThenBy(item => item.age).ToList().ToCollection();//PIR 627 10292015

                    //PIR - 930
                    int lintRetirementYear = abusBenefitCalculationRetirement.ibusBenefitApplication.icdoBenefitApplication.retirement_date.Year;
                    int lintReemployedBeginYear = abusBenefitCalculationRetirement.ibusBenefitApplication.aclbReEmployedWorkHistory[0].year;

                    if (lintReemployedBeginYear - lintRetirementYear > 1)
                    {
                        abusBenefitCalculationRetirement.ibusBenefitApplication.ProcessWorkHistoryPaddingBetweenRetirementAndReEmployment(lintRetirementYear, lintReemployedBeginYear, abusBenefitCalculationRetirement.ibusBenefitApplication.aclbReEmployedWorkHistory);
                        abusBenefitCalculationRetirement.ibusBenefitApplication.aclbReEmployedWorkHistory = abusBenefitCalculationRetirement.ibusBenefitApplication.aclbReEmployedWorkHistory.OrderBy(item => item.year).ThenBy(item => item.age).ToList().ToCollection();
                    }

                    busBenefitCalculationDetail lbusBenefitCalculationDetail = abusBenefitCalculationRetirement.iclbBenefitCalculationDetail.FirstOrDefault();

                    busBenefitCalculationOptions lbusbenefitCalculationOption = lbusBenefitCalculationDetail.iclbBenefitCalculationOptions.FirstOrDefault();

                    #region Get Reemployed Years Detail Object
                    if (ablnPostRetDeath)
                    {
                        lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.reemployed_accrued_benefit_effective_date = adtBenefitEffectiveDate;
                    }
                    else
                    {
                        lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.reemployed_accrued_benefit_effective_date = new DateTime(adtBenefitEffectiveDate.Year, 1, 1);
                    }
                    ibusCalculation.FillYearlyDetailSetBenefitAmountForEachYear(abusBenefitCalculationRetirement, lbusBenefitCalculationDetail);
                    ldecPrevBenefitAmount = ibusCalculation.GetBenefitAmountOfParticipantFromYearlyDetail(abusBenefitCalculationRetirement, lbusBenefitCalculationDetail, abusBenefitCalculationRetirement.icdoBenefitCalculationHeader.retirement_date.Year);
                    if (!ablnStartFromRetirement)
                    {

                        DateTime ldtParticipantTurns65 = this.ibusPayee.icdoPerson.date_of_birth.AddYears(65);
                        if (ldtParticipantTurns65.Day != 1)
                        {
                            ldtParticipantTurns65 = ldtParticipantTurns65.GetLastDayofMonth().AddDays(1);
                        }
                        bool lblnGetAmountForReemployment = false;
                        if (lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.reemployed_accrued_benefit_effective_date.AddYears(-1) >= ldtParticipantTurns65)
                        {
                            lblnGetAmountForReemployment = true;
                        }
                        ldecPrevBenefitAmount = ibusCalculation.GetBenefitAmountOfParticipantFromYearlyDetail(abusBenefitCalculationRetirement, lbusBenefitCalculationDetail, lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.reemployed_accrued_benefit_effective_date.AddYears(-1).Year, ablnGetAmountForReemployment: lblnGetAmountForReemployment);
                    }
                    if (ldecPrevBenefitAmount == decimal.Zero)
                    {
                        ldecPrevBenefitAmount = lbusbenefitCalculationOption.icdoBenefitCalculationOptions.benefit_amount;
                    }

                    //PIR 894
                    if (lbusbenefitCalculationOption.icdoBenefitCalculationOptions.pop_up_option_factor > 0M)
                    {
                        ldecPrevLifeBenefitAmount = ldecPrevBenefitAmount;
                        ldecPrevBenefitAmount = Math.Round(ldecPrevBenefitAmount * lbusbenefitCalculationOption.icdoBenefitCalculationOptions.pop_up_option_factor, 2);
                    }

                    if (lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.plan_id == busConstant.MPIPP_PLAN_ID)
                    {
                        ibusCalculation.CalculateAccruedBenefitForReEmployedParticipant(abusBenefitCalculationRetirement, this, adtBatchRunDate, ablnStartFromRetirement);
                    }

                    #endregion
                    if (lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.plan_id == busConstant.MPIPP_PLAN_ID)
                    {
                        //PIR 894
                        if (lbusbenefitCalculationOption.icdoBenefitCalculationOptions.pop_up_option_factor > 0M)
                            this.icdoPayeeAccount.istrBenefitOptionValue = busConstant.LIFE;

                        abusBenefitCalculationRetirement.GetBenefitAmountForEachYearAfterRetirement(abusBenefitCalculationRetirement, this, this.icdoPayeeAccount.istrBenefitOptionValue, adtBatchRunDate, ldtSpouseDOB, lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.reemployed_accrued_benefit_effective_date, ablnStartFromRetirement, ldecPrevBenefitAmount, ldecPrevLifeBenefitAmount, this.icdoPayeeAccount.term_certain_end_date);//PROD PIR 275 //PIR 894
                    }


                    #region CreateNewFinalDroForRetireeModel

                    decimal ldecParticipantAmount = decimal.Zero;
                    decimal ldecAPTaxableOffset = decimal.Zero;
                    decimal ldecAPNonTaxableOffset = decimal.Zero;
                    decimal ldecParticipantMea = decimal.Zero;
                    if (!lbusBenefitCalculationDetail.iclbBenefitCalculationOptions.IsNullOrEmpty())
                    {
                        DataTable ldtDroApp = Select("cdoDroBenefitDetails.GetRetireeApForParticipantForReevaluation", new object[2] { this.icdoPayeeAccount.person_id, this.icdoPayeeAccount.iintPlanId });
                        if (ldtDroApp.Rows.Count > 0)
                        {
                            busQdroApplication lbusQdroApplication;
                            busDroBenefitDetails lbusDroBenefitDetails;
                            busPayeeAccount lbusAPPayeeAccount;
                            busQdroCalculationHeader lbusQdroCalculationHeader;
                            ldecParticipantAmount = lbusBenefitCalculationDetail.iclbBenefitCalculationOptions.FirstOrDefault().icdoBenefitCalculationOptions.benefit_amount;
                            ldecParticipantMea = lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.monthly_exclusion_amount;
                            int lintDROAppId;
                            foreach (DataRow ldtRow in ldtDroApp.Rows)
                            {
                                lintDROAppId = Convert.ToInt32(ldtRow[enmDroBenefitDetails.dro_application_id.ToString()]);
                                lbusQdroApplication = new busQdroApplication { icdoDroApplication = new cdoDroApplication() };
                                lbusDroBenefitDetails = new busDroBenefitDetails { icdoDroBenefitDetails = new cdoDroBenefitDetails() };
                                lbusDroBenefitDetails.icdoDroBenefitDetails.LoadData(ldtRow);
                                lbusQdroApplication.FindQdroApplication(lintDROAppId);
                                lbusAPPayeeAccount = new busPayeeAccount { icdoPayeeAccount = new cdoPayeeAccount() };
                                lbusAPPayeeAccount.icdoPayeeAccount.LoadData(ldtRow);
                                lbusAPPayeeAccount.ibusPayee = new busPerson { icdoPerson = new cdoPerson() };
                                lbusAPPayeeAccount.ibusPayee.FindPerson(lbusAPPayeeAccount.icdoPayeeAccount.person_id);
                                lbusAPPayeeAccount.ibusParticipant = this.ibusPayee;


                                #region Initialize Calculation Needed Objects from Application
                                lbusQdroCalculationHeader = new busQdroCalculationHeader { icdoQdroCalculationHeader = new cdoQdroCalculationHeader() };
                                lbusQdroCalculationHeader.ibusBenefitApplication = new busBenefitApplication { icdoBenefitApplication = new cdoBenefitApplication() };
                                lbusQdroCalculationHeader.ibusQdroApplication = new busQdroApplication();
                                lbusQdroCalculationHeader.ibusQdroApplication = lbusQdroApplication;
                                lbusQdroCalculationHeader.ibusQdroApplication.iclbDroBenefitDetails = new Collection<busDroBenefitDetails>();
                                lbusQdroCalculationHeader.ibusQdroApplication.LoadBenefitDetails();
                                //Need to set this value since QDRO calculation requires iclbDroBenefitDetails collection
                                lbusQdroCalculationHeader.ibusQdroApplication.iclbDroBenefitDetails =
                                    lbusQdroCalculationHeader.ibusQdroApplication.iclbDroBenefitDetails.Where(item => item.icdoDroBenefitDetails.dro_benefit_id ==
                                    lbusDroBenefitDetails.icdoDroBenefitDetails.dro_benefit_id).ToList().ToCollection();

                                #endregion

                                #region Create FINAL Post Retirement DRO
                                lbusQdroCalculationHeader.iblnParticipantPayeeAccount = true;
                                lbusQdroCalculationHeader.idecParticipantAmount = ldecParticipantAmount;
                                lbusQdroCalculationHeader.idecParticipantMea = ldecParticipantMea;
                                lbusQdroCalculationHeader.iclbParticipantsPayeeAccount = new Collection<busPayeeAccount>();
                                lbusQdroCalculationHeader.iclbParticipantsPayeeAccount.Add(this);

                                decimal ldecTaxableAmount = decimal.Zero;
                                decimal ldecNonTaxableAmount = decimal.Zero;
                                lbusQdroCalculationHeader = RecalculateDRO(lbusQdroCalculationHeader, lbusAPPayeeAccount, lbusDroBenefitDetails, busConstant.BenefitCalculation.CALCULATION_TYPE_FINAL, true, true, ref ldecTaxableAmount, ref ldecNonTaxableAmount, lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.reemployed_accrued_benefit_effective_date);
                                ldecAPNonTaxableOffset += ldecNonTaxableAmount;
                                ldecAPTaxableOffset += ldecTaxableAmount;
                                if (!lbusQdroCalculationHeader.iclbQdroCalculationDetail.IsNullOrEmpty())
                                {
                                    lbusAPPayeeAccount.icdoPayeeAccount.dro_calculation_detail_id = lbusQdroCalculationHeader.iclbQdroCalculationDetail.FirstOrDefault().icdoQdroCalculationDetail.qdro_calculation_detail_id;
                                    lbusAPPayeeAccount.icdoPayeeAccount.Update();
                                }
                                #endregion

                            }
                        }
                    }
                    #endregion

                    if (!ablnPostRetDeath)
                    {
                        #region Insert Header Object
                        InsertNewCalculationHeaderObject(abusBenefitCalculationRetirement, abusBenefitCalculationRetirement.iclbBenefitCalculationDetail.FirstOrDefault(), this.icdoPayeeAccount.istrBenefitOptionValue, ablnStartFromRetirement);
                        #endregion
                    }
                }

            }
        }

        /// <summary>
        /// adtReEmployedHoursAfterRetirementDate : Hours passed till a prior year if passed from reevaluation batch or from resume benefits
        /// hours till the Date of death for survivor.
        /// </summary>
        /// <param name="adtReEmployedHoursAfterRetirementDate"></param>
        /// <param name="adtPayeeAccount"></param>
        /// <param name="adtBatchRunDate"></param>
        /// <param name="ablnPostRetDRO"></param>
        /// <param name="ablnLateHoursReported"></param>
        /// <returns></returns>

        public busBenefitCalculationRetirement CreateFinalCalculationForReEmployedParticipants(DataTable adtReEmployedHoursAfterRetirementDate, DataRow adtPayeeAccount, DateTime adtBenefitEffectiveDate, DateTime adtBatchRunDate, busBenefitCalculationRetirement abusBenefitCalculationHeader = null, bool ablnPostRetDeath = false, bool ablnLateHoursReported = false)
        {
            //Identified under what scenarios we need to calculate right from the retirement date
            //1.) In case of Adjustment Calculations
            //2.) In case of Late hours get reported after retirement

            //Will Get True in case payee account is of Conversion though the existing calculation also exists.
            //If Late Hours get Reported of the participant then reference point in case of conversion is the accrued benefit 
            bool lblnStartCalculatingFromRetirement = false;
            bool lblnEvaluateBenefits = false;
            decimal ldecCurrentBenefitAmount = decimal.Zero;

            string lstrPayeeAccountCreatedBy = Convert.ToString(adtPayeeAccount["CREATED_BY"]);

            busPerson lbusPerson = new busPerson { icdoPerson = new cdoPerson() };
            lbusPerson.icdoPerson.LoadData(adtPayeeAccount);

            string lstrSpouseDOB = Convert.ToString(adtPayeeAccount["BEN_DOB"]);
            DateTime ldtSpouseDOB = new DateTime();
            if (!string.IsNullOrEmpty(lstrSpouseDOB))
            {
                ldtSpouseDOB = Convert.ToDateTime(lstrSpouseDOB);
            }
            decimal ldecReferenceAccruedBenefit = decimal.Zero;
            //change the query to get dob for spouse.

            int lintBenAppId = Convert.ToInt32(adtPayeeAccount[enmBenefitApplication.benefit_application_id.ToString()]);
            decimal ldecParticipantAge = busGlobalFunctions.CalculatePersonAge(lbusPerson.icdoPerson.idtDateofBirth, adtBatchRunDate);
            if (lbusPerson.icdoPerson.date_of_death != DateTime.MinValue)
            {
                ldecParticipantAge = busGlobalFunctions.CalculatePersonAge(lbusPerson.icdoPerson.idtDateofBirth, lbusPerson.icdoPerson.date_of_death);
            }
            decimal ldecSpouseAge = busGlobalFunctions.CalculatePersonAge(ldtSpouseDOB, adtBatchRunDate);

            string lstrBenefitOptionValue = Convert.ToString(adtPayeeAccount[enmPlanBenefitXr.benefit_option_value.ToString()]);
            string lstrPlanCode = Convert.ToString(adtPayeeAccount[enmPlan.plan_code.ToString()]);

            bool lblnLumpSumPaidOut = false;
            decimal ldecLumpSumAmountPaidOut = decimal.Zero;
            if (lstrBenefitOptionValue == busConstant.LUMP_SUM)
            {
                DataTable ldtTable = Select("cdoPaymentHistoryHeader.GetLumpSumAmountPaidOut", new object[1] { this.icdoPayeeAccount.payee_account_id });
                if (ldtTable.Rows.Count > 0)
                {
                    ldecLumpSumAmountPaidOut = Convert.ToDecimal(ldtTable.Rows[0][0]);
                    if (ldecLumpSumAmountPaidOut > 0)
                    {
                        lblnLumpSumPaidOut = true;
                    }
                }
            }

            busBenefitCalculationRetirement lbusBenefitCalculationRetirement = new busBenefitCalculationRetirement { icdoBenefitCalculationHeader = new cdoBenefitCalculationHeader() };
            busBenefitCalculationDetail lbusBenefitCalculationDetail = new busBenefitCalculationDetail { icdoBenefitCalculationDetail = new cdoBenefitCalculationDetail() };
            busBenefitApplicationDetail lbusBenefitApplicationDetail = new busBenefitApplicationDetail { icdoBenefitApplicationDetail = new cdoBenefitApplicationDetail() };
            if (abusBenefitCalculationHeader.IsNull())
            {
                if (lstrPlanCode == busConstant.MPIPP)
                {
                    #region Adjustment_Late_Conversion_CalculationExists
                    DataTable ldtAdjustments = busBase.Select("cdoBenefitApplicationDetail.GetLatestAdjustmentCalculation", new object[1] { this.icdoPayeeAccount.benefit_application_detail_id });

                    if (ldtAdjustments.Rows.Count > 0)
                    {
                        lblnStartCalculatingFromRetirement = true;
                        lblnEvaluateBenefits = true;
                        lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.LoadData(ldtAdjustments.Rows[0]);
                        LoadCalculatioObjectFromCalculationDetail(lbusBenefitCalculationDetail, lbusBenefitCalculationRetirement, lintBenAppId, lstrPlanCode, lbusPerson, ldecParticipantAge, ldecSpouseAge, adtBatchRunDate, adtReEmployedHoursAfterRetirementDate, lblnStartCalculatingFromRetirement);
                        ldecReferenceAccruedBenefit = lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.early_reduced_benefit_amount;
                    }
                    else if (ablnLateHoursReported)
                    {
                        if (this.icdoPayeeAccount.benefit_calculation_detail_id > 0 && lbusBenefitCalculationDetail.FindBenefitCalculationDetail(this.icdoPayeeAccount.benefit_calculation_detail_id))
                        {
                            lblnStartCalculatingFromRetirement = true;
                            lblnEvaluateBenefits = true;
                            //Late Hours Reported After Retirement will start calculating from 
                            LoadCalculatioObjectFromCalculationDetail(lbusBenefitCalculationDetail, lbusBenefitCalculationRetirement, lintBenAppId, lstrPlanCode, lbusPerson, ldecParticipantAge, ldecSpouseAge, adtBatchRunDate, adtReEmployedHoursAfterRetirementDate, lblnStartCalculatingFromRetirement);
                            //ldecReferenceAccruedBenefit = lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.accrued_at_retirement_amount;
                            ldecReferenceAccruedBenefit = lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.early_reduced_benefit_amount;
                        }
                        else if (lbusBenefitApplicationDetail.FindBenefitApplicationDetail(this.icdoPayeeAccount.benefit_application_detail_id))
                        {
                            lblnStartCalculatingFromRetirement = true;
                            lblnEvaluateBenefits = true;
                            LoadCalculationObjectFromApplicationDetail(lbusBenefitApplicationDetail, lbusBenefitCalculationDetail, lbusBenefitCalculationRetirement, lstrPlanCode, lintBenAppId, lbusPerson, ldecParticipantAge, ldecSpouseAge, adtBatchRunDate, adtReEmployedHoursAfterRetirementDate);
                            if (!lbusBenefitCalculationRetirement.iclbBenefitCalculationDetail.IsNullOrEmpty())
                            {
                                lbusBenefitCalculationDetail = lbusBenefitCalculationRetirement.iclbBenefitCalculationDetail.FirstOrDefault();
                            }
                            ldecReferenceAccruedBenefit = this.icdoPayeeAccount.unreduced_benefit_amount;
                        }
                    }
                    else if (lstrPayeeAccountCreatedBy == "CONVERSION" && this.icdoPayeeAccount.benefit_calculation_detail_id == 0)
                    {
                        if (lbusBenefitApplicationDetail.FindBenefitApplicationDetail(this.icdoPayeeAccount.benefit_application_detail_id))
                        {
                            LoadCalculationObjectFromApplicationDetail(lbusBenefitApplicationDetail, lbusBenefitCalculationDetail, lbusBenefitCalculationRetirement, lstrPlanCode, lintBenAppId, lbusPerson, ldecParticipantAge, ldecSpouseAge, adtBatchRunDate, adtReEmployedHoursAfterRetirementDate);
                            if (!lbusBenefitCalculationRetirement.iclbBenefitCalculationDetail.IsNullOrEmpty())
                            {
                                lbusBenefitCalculationDetail = lbusBenefitCalculationRetirement.iclbBenefitCalculationDetail.FirstOrDefault();
                            }
                            ldecReferenceAccruedBenefit = this.icdoPayeeAccount.unreduced_benefit_amount;
                            lblnStartCalculatingFromRetirement = true;
                            lblnEvaluateBenefits = true;
                        }
                    }
                    else
                    {
                        if (this.icdoPayeeAccount.benefit_calculation_detail_id > 0 && lbusBenefitCalculationDetail.FindBenefitCalculationDetail(this.icdoPayeeAccount.benefit_calculation_detail_id))
                        {
                            DataTable ldt = new DataTable();
                            int lintYear = 0;
                            lbusBenefitCalculationDetail.LoadBenefitCalculationOptionss();
                            if (ablnPostRetDeath)
                            {
                                if (lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.reemployed_accrued_benefit_effective_date != DateTime.MinValue)
                                {
                                    if (lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.reemployed_accrued_benefit_effective_date < adtBenefitEffectiveDate)
                                    {
                                        if (adtReEmployedHoursAfterRetirementDate.AsEnumerable().Where(o => o.Field<int>("Year") >=
                                            lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.reemployed_accrued_benefit_effective_date.Year).Count() > 0)
                                        {
                                            lblnEvaluateBenefits = true;
                                            lintYear = lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.reemployed_accrued_benefit_effective_date.Year;
                                            ldt = adtReEmployedHoursAfterRetirementDate.AsEnumerable().Where(o => o.Field<int>("Year") >= lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.reemployed_accrued_benefit_effective_date.Year).CopyToDataTable();
                                            LoadCalculatioObjectFromCalculationDetail(lbusBenefitCalculationDetail, lbusBenefitCalculationRetirement, lintBenAppId, lstrPlanCode, lbusPerson, ldecParticipantAge, ldecSpouseAge, adtBatchRunDate, ldt, lblnStartCalculatingFromRetirement);
                                        }

                                    }
                                }
                                else
                                {
                                    lblnStartCalculatingFromRetirement = true;
                                    LoadCalculatioObjectFromCalculationDetail(lbusBenefitCalculationDetail, lbusBenefitCalculationRetirement, lintBenAppId, lstrPlanCode, lbusPerson, ldecParticipantAge, ldecSpouseAge, adtBatchRunDate, adtReEmployedHoursAfterRetirementDate, true);
                                    lblnEvaluateBenefits = true;
                                    ldecReferenceAccruedBenefit = lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.early_reduced_benefit_amount;

                                }
                            }
                            else if (ldecParticipantAge == 65)
                            {
                                lblnStartCalculatingFromRetirement = true;
                                LoadCalculatioObjectFromCalculationDetail(lbusBenefitCalculationDetail, lbusBenefitCalculationRetirement, lintBenAppId, lstrPlanCode, lbusPerson, ldecParticipantAge, ldecSpouseAge, adtBatchRunDate, adtReEmployedHoursAfterRetirementDate, lblnStartCalculatingFromRetirement);
                                if (lbusBenefitCalculationRetirement.ibusBenefitApplication.aclbReEmployedWorkHistory.Where(item => item.vested_hours >= 870).Count() > 0)
                                {
                                    lblnEvaluateBenefits = true;
                                }
                                ldecReferenceAccruedBenefit = lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.early_reduced_benefit_amount;
                            }
                            else
                            {
                                if (adtReEmployedHoursAfterRetirementDate.AsEnumerable().Where(o => o.Field<int>("Year") == adtBatchRunDate.AddYears(-1).Year).Count() > 0)
                                {
                                    lintYear = adtBatchRunDate.AddYears(-1).Year;
                                    ldt = adtReEmployedHoursAfterRetirementDate.AsEnumerable().Where(o => o.Field<int>("Year") == adtBatchRunDate.AddYears(-1).Year).CopyToDataTable();
                                    LoadCalculatioObjectFromCalculationDetail(lbusBenefitCalculationDetail, lbusBenefitCalculationRetirement, lintBenAppId, lstrPlanCode, lbusPerson, ldecParticipantAge, ldecSpouseAge, adtBatchRunDate, ldt, lblnStartCalculatingFromRetirement, lintYear);
                                    if (lbusBenefitCalculationRetirement.ibusBenefitApplication.aclbReEmployedWorkHistory.Where(item => item.vested_hours >= 870).Count() > 0)
                                    {
                                        lblnEvaluateBenefits = true;
                                    }
                                }

                            }
                            if (lblnEvaluateBenefits)
                            {
                                if (!lbusBenefitCalculationDetail.iclbBenefitCalculationOptions.IsNullOrEmpty())
                                {
                                    ldecCurrentBenefitAmount = lbusBenefitCalculationDetail.iclbBenefitCalculationOptions.FirstOrDefault().icdoBenefitCalculationOptions.benefit_amount;
                                }
                                //if (!lbusBenefitCalculationDetail.iclbBenefitCalculationYearlyDetail.IsNullOrEmpty())
                                //{
                                //    if (lbusBenefitCalculationDetail.iclbBenefitCalculationYearlyDetail.Where(item => item.icdoBenefitCalculationYearlyDetail.plan_year == adtBatchRunDate.AddYears(-1).Year && item.icdoBenefitCalculationYearlyDetail.reemployed_flag == busConstant.FLAG_YES).Count() > 0)
                                //    {
                                //        ldecReferenceAccruedBenefit = lbusBenefitCalculationDetail.iclbBenefitCalculationYearlyDetail.Where(item => item.icdoBenefitCalculationYearlyDetail.plan_year == lintYear && item.icdoBenefitCalculationYearlyDetail.reemployed_flag == busConstant.FLAG_YES).FirstOrDefault().icdoBenefitCalculationYearlyDetail.total_accrued_benefit;
                                //    }
                                //    else if (lbusBenefitCalculationDetail.iclbBenefitCalculationYearlyDetail.Where(item => item.icdoBenefitCalculationYearlyDetail.plan_year == lintYear).Count() > 0)
                                //    {
                                //        ldecReferenceAccruedBenefit = lbusBenefitCalculationDetail.iclbBenefitCalculationYearlyDetail.Where(item => item.icdoBenefitCalculationYearlyDetail.plan_year == lintYear).FirstOrDefault().icdoBenefitCalculationYearlyDetail.annual_adjustment_amount;
                                //        if (ldecReferenceAccruedBenefit == 0)
                                //        {
                                //            ldecReferenceAccruedBenefit = lbusBenefitCalculationDetail.iclbBenefitCalculationYearlyDetail.Where(item => item.icdoBenefitCalculationYearlyDetail.plan_year == lintYear).FirstOrDefault().icdoBenefitCalculationYearlyDetail.total_accrued_benefit;

                                //        }
                                //    }
                                //    else
                                //    {
                                //        ldecReferenceAccruedBenefit = lbusBenefitCalculationDetail.iclbBenefitCalculationYearlyDetail.OrderByDescending(item => item.icdoBenefitCalculationYearlyDetail.plan_year).ToList().ToCollection().Where(item => item.icdoBenefitCalculationYearlyDetail.plan_year <= lintYear).FirstOrDefault().icdoBenefitCalculationYearlyDetail.annual_adjustment_amount;
                                //        if (ldecReferenceAccruedBenefit == 0)
                                //        {
                                //            ldecReferenceAccruedBenefit = lbusBenefitCalculationDetail.iclbBenefitCalculationYearlyDetail.OrderByDescending(item => item.icdoBenefitCalculationYearlyDetail.plan_year).ToList().ToCollection().Where(item => item.icdoBenefitCalculationYearlyDetail.plan_year <= lintYear).FirstOrDefault().icdoBenefitCalculationYearlyDetail.total_accrued_benefit;

                                //        }

                                //    }
                                //}
                                //else
                                //{
                                //    ldecReferenceAccruedBenefit = lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.additional_accrued_benefit_amount;
                                //    if (ldecReferenceAccruedBenefit == 0)
                                //    {
                                //        ldecReferenceAccruedBenefit = lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.unreduced_benefit_amount;
                                //    }
                                //}
                            }

                        }
                    }

                    #endregion
                }
                else if (lstrPlanCode == busConstant.IAP)
                {
                    LoadCalculationObjectFromApplicationDetailForIAP(lbusBenefitApplicationDetail, lbusBenefitCalculationDetail, lbusBenefitCalculationRetirement, lintBenAppId, lbusPerson, ldecParticipantAge, ldecSpouseAge, adtBatchRunDate, adtReEmployedHoursAfterRetirementDate, lstrPlanCode);
                    ldecReferenceAccruedBenefit = this.icdoPayeeAccount.unreduced_benefit_amount;

                }
            }
            else
            {
                lblnEvaluateBenefits = true;
                abusBenefitCalculationHeader.ibusBenefitApplication.aclbReEmployedWorkHistory = cdoDummyWorkData.GetCollection<cdoDummyWorkData>(adtReEmployedHoursAfterRetirementDate);
                this.LoadWorkDataCollectionObjectAfterRetirement(abusBenefitCalculationHeader.ibusBenefitApplication.aclbReEmployedWorkHistory, abusBenefitCalculationHeader.ibusPerson, abusBenefitCalculationHeader.icdoBenefitCalculationHeader.retirement_date);
                lbusBenefitCalculationDetail = abusBenefitCalculationHeader.iclbBenefitCalculationDetail.FirstOrDefault();
                lblnStartCalculatingFromRetirement = true;
                ldecReferenceAccruedBenefit = lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.early_reduced_benefit_amount;
                lbusBenefitCalculationRetirement = abusBenefitCalculationHeader;
            }
            if (lblnEvaluateBenefits)
            {

                #region Get New Detail Object
                if (adtBenefitEffectiveDate.Day == 1)
                {
                    lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.reemployed_accrued_benefit_effective_date = adtBenefitEffectiveDate;
                }
                else
                {
                    lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.reemployed_accrued_benefit_effective_date = adtBenefitEffectiveDate.AddMonths(1).GetFirstDayofMonth();
                }
                if (lbusBenefitCalculationRetirement.iclbBenefitCalculationDetail.IsNull())
                {
                    lbusBenefitCalculationRetirement.iclbBenefitCalculationDetail = new Collection<busBenefitCalculationDetail>();
                }
                if (lbusBenefitCalculationRetirement.iclbBenefitCalculationDetail.Count == 0)
                {
                    lbusBenefitCalculationRetirement.iclbBenefitCalculationDetail.Add(lbusBenefitCalculationDetail);
                }
                if (lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.plan_id == busConstant.MPIPP_PLAN_ID)
                {
                    ibusCalculation.CalculateAccruedBenefitForReEmployedParticipant(lbusBenefitCalculationRetirement, this, adtBatchRunDate, lblnStartCalculatingFromRetirement);
                }
                else if (lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.plan_id == busConstant.IAP_PLAN_ID)
                {
                    lbusBenefitCalculationRetirement.iblnCalculateIAPBenefit = true;
                    lbusBenefitCalculationRetirement.iblnCalculateL52SplAccBenefit = false;
                    lbusBenefitCalculationRetirement.iblnCalculateL161SplAccBenefit = false;
                    ibusCalculation.LoadIapBalanceForReEmployedParticipants(lbusBenefitCalculationRetirement);
                }

                #endregion

                //  bool lblnIsMinDistributionCalculation = false;
                //DateTime adtMinimumDistributionDate = new DateTime(lbusBenefitCalculationRetirement.ibusPerson.icdoPerson.idtDateofBirth.AddYears(70).AddMonths(6).AddYears(1).Year, 04, 01);
                DateTime adtMinimumDistributionDate = new DateTime();
                adtMinimumDistributionDate = busGlobalFunctions.GetMinDistributionDate(this.ibusPayee.icdoPerson.person_id, lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.vested_date);


                if (adtBatchRunDate >= adtMinimumDistributionDate)
                {

                }
                else
                {
                    #region Get New Options Object
                    //lbusBenefitCalculationRetirement.CalculateBenefit
                    decimal ldecFinalAccruedBenefit = lbusBenefitCalculationRetirement.iclbBenefitCalculationDetail.FirstOrDefault().icdoBenefitCalculationDetail.early_reduced_benefit_amount;
                    if (lbusBenefitCalculationDetail.iclbBenefitCalculationOptions.IsNull())
                    {
                        lbusBenefitCalculationDetail.iclbBenefitCalculationOptions = new Collection<busBenefitCalculationOptions>();
                    }
                    if (lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.plan_id == busConstant.MPIPP_PLAN_ID)
                    {
                        lbusBenefitCalculationRetirement.GetBenefitAmountForEachYearAfterRetirement(lbusBenefitCalculationRetirement, lstrBenefitOptionValue, adtBatchRunDate, lbusPerson.icdoPerson.idtDateofBirth, ldtSpouseDOB, lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.reemployed_accrued_benefit_effective_date, lblnStartCalculatingFromRetirement, ldecReferenceAccruedBenefit, ldecCurrentBenefitAmount, this.icdoPayeeAccount.term_certain_end_date); //PROD PIR 275
                    }
                    else if (lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.plan_id == busConstant.IAP_PLAN_ID)
                    {
                        lbusBenefitCalculationRetirement.CalculateIAPBenefitAmount(lstrBenefitOptionValue, true);
                    }
                    if (lblnLumpSumPaidOut)
                    {
                        if (lbusBenefitCalculationRetirement.iclbBenefitCalculationDetail.Count > 0)
                        {
                            if (lbusBenefitCalculationRetirement.iclbBenefitCalculationDetail.FirstOrDefault().iclbBenefitCalculationOptions.Count > 0)
                            {
                                //lbusBenefitCalculationRetirement.iclbBenefitCalculationDetail.FirstOrDefault().iclbBenefitCalculationOptions.FirstOrDefault().icdoBenefitCalculationOptions
                            }
                        }
                        //lbusBenefitCalculationRetirement.iclbBenefitCalculationDetail.FirstOrDefault().iclbBenefitCalculationOptions
                    }
                    #endregion
                }

                if (!ablnPostRetDeath)
                {
                    #region Insert Header Object
                    InsertNewCalculationHeaderObject(lbusBenefitCalculationRetirement, lbusBenefitCalculationDetail, lstrBenefitOptionValue, lblnStartCalculatingFromRetirement);
                    #endregion
                }

                #region CreateNewFinalDroForRetireeModel

                decimal ldecParticipantAmount = decimal.Zero;
                if (!lbusBenefitCalculationDetail.iclbBenefitCalculationOptions.IsNullOrEmpty())
                {

                    DataTable ldtDroApp = Select("cdoDroBenefitDetails.GetRetireeApForParticipantForReevaluation", new object[2] { this.icdoPayeeAccount.person_id, this.icdoPayeeAccount.iintPlanId });
                    if (ldtDroApp.Rows.Count > 0)
                    {
                        busQdroApplication lbusQdroApplication;
                        busDroBenefitDetails lbusDroBenefitDetails;
                        busPayeeAccount lbusAPPayeeAccount;
                        busQdroCalculationHeader lbusQdroCalculationHeader;
                        ldecParticipantAmount = lbusBenefitCalculationDetail.iclbBenefitCalculationOptions.FirstOrDefault().icdoBenefitCalculationOptions.benefit_amount;
                        int lintDROAppId;
                        foreach (DataRow ldtRow in ldtDroApp.Rows)
                        {
                            lintDROAppId = Convert.ToInt32(ldtRow[enmDroBenefitDetails.dro_application_id.ToString()]);
                            lbusQdroApplication = new busQdroApplication { icdoDroApplication = new cdoDroApplication() };
                            lbusDroBenefitDetails = new busDroBenefitDetails { icdoDroBenefitDetails = new cdoDroBenefitDetails() };
                            lbusDroBenefitDetails.icdoDroBenefitDetails.LoadData(ldtRow);
                            lbusQdroApplication.FindQdroApplication(lintDROAppId);
                            lbusAPPayeeAccount = new busPayeeAccount { icdoPayeeAccount = new cdoPayeeAccount() };
                            lbusAPPayeeAccount.icdoPayeeAccount.LoadData(ldtRow);

                            #region Initialize Calculation Needed Objects from Application
                            lbusQdroCalculationHeader = new busQdroCalculationHeader { icdoQdroCalculationHeader = new cdoQdroCalculationHeader() };
                            lbusQdroCalculationHeader.ibusBenefitApplication = new busBenefitApplication { icdoBenefitApplication = new cdoBenefitApplication() };
                            lbusQdroCalculationHeader.ibusQdroApplication = new busQdroApplication();
                            lbusQdroCalculationHeader.ibusQdroApplication = lbusQdroApplication;
                            lbusQdroCalculationHeader.ibusQdroApplication.iclbDroBenefitDetails = new Collection<busDroBenefitDetails>();
                            lbusQdroCalculationHeader.ibusQdroApplication.LoadBenefitDetails();
                            //Need to set this value since QDRO calculation requires iclbDroBenefitDetails collection
                            lbusQdroCalculationHeader.ibusQdroApplication.iclbDroBenefitDetails =
                                lbusQdroCalculationHeader.ibusQdroApplication.iclbDroBenefitDetails.Where(item => item.icdoDroBenefitDetails.dro_benefit_id ==
                                lbusDroBenefitDetails.icdoDroBenefitDetails.dro_benefit_id).ToList().ToCollection();

                            #endregion

                            #region Create FINAL Post Retirement DRO
                            lbusQdroCalculationHeader.iblnParticipantPayeeAccount = true;
                            lbusQdroCalculationHeader.idecParticipantAmount = ldecParticipantAmount;
                            lbusQdroCalculationHeader.iclbParticipantsPayeeAccount = new Collection<busPayeeAccount>();
                            lbusQdroCalculationHeader.iclbParticipantsPayeeAccount.Add(this);
                            decimal ldecTaxableAmount = decimal.Zero;
                            decimal ldecNonTaxableAmount = decimal.Zero;

                            lbusQdroCalculationHeader = RecalculateDRO(lbusQdroCalculationHeader, lbusAPPayeeAccount, lbusDroBenefitDetails, busConstant.BenefitCalculation.CALCULATION_TYPE_FINAL, true, true, ref ldecTaxableAmount, ref ldecNonTaxableAmount, lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.reemployed_accrued_benefit_effective_date);
                            #endregion

                        }
                    }
                }
                #endregion

            }
            return lbusBenefitCalculationRetirement;

        }

        public void LoadCalculationObjectFromApplicationDetailForIAP(busBenefitApplicationDetail abusBenefitApplicationDetail, busBenefitCalculationDetail abusBenefitCalculationDetail, busBenefitCalculationHeader abusBenefitCalculationHeader, int aintBenAppID,
            busPerson abusPerson, decimal adecParticipantAge, decimal adecSpouseAge, DateTime adtBatchRunDate, DataTable adtReEmployedHoursAfterRetirementDate, string astrPlanCode)
        {
            busBenefitApplication lbusBenefitApplication = new busBenefitApplication { icdoBenefitApplication = new cdoBenefitApplication() };
            abusBenefitCalculationHeader = new busBenefitCalculationHeader { icdoBenefitCalculationHeader = new cdoBenefitCalculationHeader() };

            abusBenefitCalculationDetail = new busBenefitCalculationDetail { icdoBenefitCalculationDetail = new cdoBenefitCalculationDetail() };

            busPlanBenefitXr lbusPlanBenefitXr = new busPlanBenefitXr { icdoPlanBenefitXr = new cdoPlanBenefitXr() };
            lbusPlanBenefitXr.FindPlanBenefitXr(abusBenefitApplicationDetail.icdoBenefitApplicationDetail.plan_benefit_id);

            abusBenefitCalculationHeader.ibusBenefitApplication = LoadRetirementApplicationObject(aintBenAppID, abusPerson, adecParticipantAge, astrPlanCode);

            LoadRetirementObjectForReEmployedParticipants(abusBenefitCalculationHeader, abusBenefitApplicationDetail);
            abusBenefitCalculationHeader.PopulateInitialDataBenefitCalculationHeaderForRemployment(this.icdoPayeeAccount.person_id, abusBenefitApplicationDetail.icdoBenefitApplicationDetail.benefit_application_id,
            abusBenefitApplicationDetail.icdoBenefitApplicationDetail.joint_annuitant_id, this.icdoPayeeAccount.benefit_account_type_value, busConstant.BenefitCalculation.CALCULATION_TYPE_FINAL, abusBenefitCalculationHeader.ibusBenefitApplication.icdoBenefitApplication.retirement_date,
            abusBenefitCalculationHeader.ibusBenefitApplication.idecAge, lbusPlanBenefitXr.icdoPlanBenefitXr.plan_id);
            abusBenefitCalculationHeader.icdoBenefitCalculationHeader.age = busGlobalFunctions.CalculatePersonAgeInDec(abusPerson.icdoPerson.idtDateofBirth, adtBatchRunDate);
            abusBenefitCalculationHeader.icdoBenefitCalculationHeader.idecParticipantFullAge = adecParticipantAge;
            abusBenefitCalculationHeader.icdoBenefitCalculationHeader.iintSurvivorAgeAtRetirement = adecSpouseAge;
            abusBenefitApplicationDetail.istrPlanCode = astrPlanCode;
            busPersonAccount lbusPersonAccount = abusBenefitCalculationHeader.ibusPerson.iclbPersonAccount.Where(item => item.icdoPersonAccount.istrPlanCode == abusBenefitApplicationDetail.istrPlanCode).FirstOrDefault();
            abusBenefitCalculationHeader.LoadAllRetirementContributions(lbusPersonAccount);


            abusBenefitCalculationDetail = LoadCalculationDetailObject(abusBenefitCalculationHeader, abusBenefitCalculationDetail, abusBenefitApplicationDetail, lbusPersonAccount);

        }


        public void LoadCalculatioObjectFromCalculationDetail(busBenefitCalculationDetail abusBenefitCalculationDetail, busBenefitCalculationHeader abusBenefitCalculationHeader, int aintBenAppID, string astrPlanCode,
            busPerson abusPerson, decimal adecParticipantAge, decimal adecSpouseAge, DateTime adtBatchRunDate, DataTable adtReEmployedHoursAfterRetirementDate, bool ablnStartFromRetirement, int aintYear = 0)
        {
            //abusBenefitCalculationHeader = new busBenefitCalculationRetirement { icdoBenefitCalculationHeader = new cdoBenefitCalculationHeader() };

            abusBenefitCalculationHeader.FindBenefitCalculationHeader(abusBenefitCalculationDetail.icdoBenefitCalculationDetail.benefit_calculation_header_id);
            abusBenefitCalculationHeader.ibusBenefitApplication = LoadRetirementApplicationObject(aintBenAppID, abusPerson, adecParticipantAge, astrPlanCode);
            abusBenefitCalculationHeader.ibusPerson = abusBenefitCalculationHeader.ibusBenefitApplication.ibusPerson;
            abusBenefitCalculationHeader.ibusPerson.iclbPersonAccount = abusBenefitCalculationHeader.ibusBenefitApplication.ibusPerson.iclbPersonAccount;
            abusBenefitCalculationHeader.icdoBenefitCalculationHeader.iintPlanId = abusBenefitCalculationDetail.icdoBenefitCalculationDetail.plan_id;
            abusBenefitCalculationHeader.icdoBenefitCalculationHeader.age = busGlobalFunctions.CalculatePersonAgeInDec(abusPerson.icdoPerson.idtDateofBirth, adtBatchRunDate);
            abusBenefitCalculationHeader.icdoBenefitCalculationHeader.idecParticipantFullAge = adecParticipantAge;
            abusBenefitCalculationHeader.icdoBenefitCalculationHeader.iintSurvivorAgeAtRetirement = adecSpouseAge;

            #region Load Detail Object
            abusBenefitCalculationHeader.iclbBenefitCalculationDetail = new Collection<busBenefitCalculationDetail>();
            abusBenefitCalculationHeader.iclbBenefitCalculationDetail.Add(abusBenefitCalculationDetail);
            #endregion

            //lbusBenefitCalculationDetail.LoadBenefitCalculationOptionss();
            if (ablnStartFromRetirement)
            {
                abusBenefitCalculationDetail.LoadBenefitCalculationYearlyDetailsBeforeRetirement();
            }
            else
            {
                abusBenefitCalculationDetail.LoadBenefitCalculationYearlyDetails();
                abusBenefitCalculationDetail.iclbBenefitCalculationYearlyDetail = abusBenefitCalculationDetail.iclbBenefitCalculationYearlyDetail.Where(item => !(item.icdoBenefitCalculationYearlyDetail.plan_year >= aintYear && item.icdoBenefitCalculationYearlyDetail.reemployed_flag == busConstant.FLAG_YES)).ToList().ToCollection();
            }

            abusBenefitCalculationHeader.ibusBenefitApplication.aclbReEmployedWorkHistory = cdoDummyWorkData.GetCollection<cdoDummyWorkData>(adtReEmployedHoursAfterRetirementDate);
            this.LoadWorkDataCollectionObjectAfterRetirement(abusBenefitCalculationHeader.ibusBenefitApplication.aclbReEmployedWorkHistory, abusBenefitCalculationHeader.ibusPerson, abusBenefitCalculationHeader.icdoBenefitCalculationHeader.retirement_date);


        }

        public void LoadCalculationObjectFromApplicationDetail(busBenefitApplicationDetail abusBenefitApplicationDetail, busBenefitCalculationDetail abusBenefitCalculationDetail, busBenefitCalculationHeader abusBenefitCalculationHeader, string astrPlanCode,
            int aintBenAppID, busPerson abusPerson, decimal adecParticipantAge, decimal adecSpouseAge, DateTime adtBatchRunDate, DataTable adtReEmployedHoursAfterRetirementDate)
        {
            abusBenefitApplicationDetail.istrPlanCode = astrPlanCode;

            busBenefitApplication lbusBenefitApplication = new busBenefitApplication { icdoBenefitApplication = new cdoBenefitApplication() };
            //abusBenefitCalculationHeader = new busBenefitCalculationHeader { icdoBenefitCalculationHeader = new cdoBenefitCalculationHeader() };

            //abusBenefitCalculationDetail = new busBenefitCalculationDetail { icdoBenefitCalculationDetail = new cdoBenefitCalculationDetail() };

            busPlanBenefitXr lbusPlanBenefitXr = new busPlanBenefitXr { icdoPlanBenefitXr = new cdoPlanBenefitXr() };
            lbusPlanBenefitXr.FindPlanBenefitXr(abusBenefitApplicationDetail.icdoBenefitApplicationDetail.plan_benefit_id);

            abusBenefitCalculationHeader.ibusBenefitApplication = LoadRetirementApplicationObject(aintBenAppID, abusPerson, adecParticipantAge, astrPlanCode);
            abusBenefitCalculationHeader.PopulateInitialDataBenefitCalculationHeaderForRemployment(this.icdoPayeeAccount.person_id, abusBenefitApplicationDetail.icdoBenefitApplicationDetail.benefit_application_id,
            abusBenefitApplicationDetail.icdoBenefitApplicationDetail.joint_annuitant_id, this.icdoPayeeAccount.benefit_account_type_value, busConstant.BenefitCalculation.CALCULATION_TYPE_FINAL, abusBenefitCalculationHeader.ibusBenefitApplication.icdoBenefitApplication.retirement_date,
            adecParticipantAge, lbusPlanBenefitXr.icdoPlanBenefitXr.plan_id);

            LoadRetirementObjectForReEmployedParticipants(abusBenefitCalculationHeader, abusBenefitApplicationDetail);
            abusBenefitCalculationHeader.ibusBenefitApplication.aclbReEmployedWorkHistory = cdoDummyWorkData.GetCollection<cdoDummyWorkData>(adtReEmployedHoursAfterRetirementDate);
            abusBenefitCalculationHeader.icdoBenefitCalculationHeader.age = busGlobalFunctions.CalculatePersonAgeInDec(abusPerson.icdoPerson.idtDateofBirth, adtBatchRunDate);
            abusBenefitCalculationHeader.icdoBenefitCalculationHeader.idecParticipantFullAge = adecParticipantAge;
            abusBenefitCalculationHeader.icdoBenefitCalculationHeader.iintSurvivorAgeAtRetirement = adecSpouseAge;
            busPersonAccount lbusPersonAccount = abusBenefitCalculationHeader.ibusPerson.iclbPersonAccount.Where(item => item.icdoPersonAccount.istrPlanCode == abusBenefitApplicationDetail.istrPlanCode).FirstOrDefault();
            abusBenefitCalculationHeader.LoadAllRetirementContributions(lbusPersonAccount);

            this.LoadWorkDataCollectionObjectAfterRetirement(abusBenefitCalculationHeader.ibusBenefitApplication.aclbReEmployedWorkHistory, abusBenefitCalculationHeader.ibusPerson, abusBenefitCalculationHeader.icdoBenefitCalculationHeader.retirement_date);

            abusBenefitCalculationHeader.iclbBenefitCalculationDetail = new Collection<busBenefitCalculationDetail>();
            abusBenefitCalculationDetail = LoadCalculationDetailObject(abusBenefitCalculationHeader, abusBenefitCalculationDetail, abusBenefitApplicationDetail, lbusPersonAccount);
            if (abusBenefitCalculationHeader.iclbBenefitCalculationDetail.Count > 0)
            {
                abusBenefitCalculationHeader.iclbBenefitCalculationDetail.FirstOrDefault().icdoBenefitCalculationDetail.minimum_guarantee_amount = this.icdoPayeeAccount.minimum_guarantee_amount;
            }


        }

        public busDisabiltyBenefitCalculation CreateFinalCalculationForReEmployedDisabledParticipants(DataTable adtReEmployedHoursAfterRetirementDate, DataRow adtPayeeAccount, DateTime adtBenefitEffectiveDate, DateTime adtBatchRunDate, bool ablnPostRetDeath = false, bool ablnLateHoursReported = false)
        {
            bool lblnTreatAsConversionCalculation = false;
            decimal ldecReferenceAccruedBenefit = decimal.Zero;
            busPerson lbusPerson = new busPerson { icdoPerson = new cdoPerson() };
            lbusPerson.icdoPerson.LoadData(adtPayeeAccount);
            string lstrPayeeAccountCreatedBy = Convert.ToString(adtPayeeAccount["CREATED_BY"]);
            string lstrPlanCode = Convert.ToString(adtPayeeAccount[enmPlan.plan_code.ToString()]);
            string lstrSpouseDOB = Convert.ToString(adtPayeeAccount["BEN_DOB"]);
            DateTime ldtSpouseDOB = new DateTime();
            bool lblnEvaluateBenefits = false;
            decimal ldecCurrentBenefitAmount = decimal.Zero;
            if (!string.IsNullOrEmpty(lstrSpouseDOB))
            {
                ldtSpouseDOB = Convert.ToDateTime(lstrSpouseDOB);
            }
            bool lblnStartFromRetirement = false;
            //change the query to get dob for spouse.

            int lintBenAppId = Convert.ToInt32(adtPayeeAccount[enmBenefitApplication.benefit_application_id.ToString()]);
            decimal ldecParticipantAge = busGlobalFunctions.CalculatePersonAge(lbusPerson.icdoPerson.idtDateofBirth, adtBatchRunDate);
            if (lbusPerson.icdoPerson.date_of_death != DateTime.MinValue)
            {
                ldecParticipantAge = busGlobalFunctions.CalculatePersonAge(lbusPerson.icdoPerson.idtDateofBirth, lbusPerson.icdoPerson.date_of_death);
            }
            decimal ldecSpouseAge = busGlobalFunctions.CalculatePersonAge(ldtSpouseDOB, adtBatchRunDate);

            string lstrBenefitOptionValue = Convert.ToString(adtPayeeAccount[enmPlanBenefitXr.benefit_option_value.ToString()]);

            busDisabiltyBenefitCalculation lbusDisabiltyBenefitCalculation = new busDisabiltyBenefitCalculation { icdoBenefitCalculationHeader = new cdoBenefitCalculationHeader() };
            busBenefitCalculationDetail lbusBenefitCalculationDetail = new busBenefitCalculationDetail { icdoBenefitCalculationDetail = new cdoBenefitCalculationDetail() };
            busBenefitApplicationDetail lbusBenefitApplicationDetail = new busBenefitApplicationDetail { icdoBenefitApplicationDetail = new cdoBenefitApplicationDetail() };
            if (lstrPlanCode == busConstant.MPIPP)
            {
                DataTable ldtAdjustments = busBase.Select("cdoBenefitApplicationDetail.GetLatestAdjustmentCalculation", new object[1] { this.icdoPayeeAccount.benefit_application_detail_id });
                if (ablnLateHoursReported && this.icdoPayeeAccount.benefit_calculation_detail_id > 0 && lstrPayeeAccountCreatedBy == "CONVERSION")
                {
                    lblnTreatAsConversionCalculation = true;
                }

                if (ldtAdjustments.Rows.Count > 0)
                {
                    //From Scratch
                    busBenefitCalculationHeader lbusBenefitCalculationHeader = RecalculateParticipantDisabilityBenefits(lstrBenefitOptionValue, true, true, ablnPostRetDeath);
                    lbusBenefitCalculationHeader.icdoBenefitCalculationHeader.status_value = busConstant.BenefitCalculation.CALCULATION_STATUS_TYPE_APPROVED;
                    if (!ablnPostRetDeath)
                    {
                        UpdatePayeeAccountFromReEvaluationBatch(this, lbusBenefitCalculationHeader, lbusBenefitCalculationHeader.iclbBenefitCalculationDetail.FirstOrDefault(), lstrBenefitOptionValue);
                    }
                    lblnEvaluateBenefits = false;
                    return (lbusBenefitCalculationHeader as busDisabiltyBenefitCalculation);
                }
                else if (ablnLateHoursReported)
                {
                    if (this.icdoPayeeAccount.benefit_calculation_detail_id > 0 && lbusBenefitCalculationDetail.FindBenefitCalculationDetail(this.icdoPayeeAccount.benefit_calculation_detail_id))
                    {
                        busBenefitCalculationHeader lbusBenefitCalculationHeader = RecalculateParticipantDisabilityBenefits(lstrBenefitOptionValue, true, true, ablnPostRetDeath);
                        lbusBenefitCalculationHeader.icdoBenefitCalculationHeader.status_value = busConstant.BenefitCalculation.CALCULATION_STATUS_TYPE_APPROVED;
                        if (!ablnPostRetDeath)
                        {
                            UpdatePayeeAccountFromReEvaluationBatch(this, lbusBenefitCalculationHeader, lbusBenefitCalculationHeader.iclbBenefitCalculationDetail.FirstOrDefault(), lstrBenefitOptionValue);
                        }
                        lblnEvaluateBenefits = false;
                        return (lbusBenefitCalculationHeader as busDisabiltyBenefitCalculation);
                    }
                    else if (lbusBenefitApplicationDetail.FindBenefitApplicationDetail(this.icdoPayeeAccount.benefit_application_detail_id))
                    {
                        busBenefitCalculationHeader lbusBenefitCalculationHeader = RecalculateParticipantDisabilityBenefits(lstrBenefitOptionValue, true, true, ablnPostRetDeath);
                        lbusBenefitCalculationHeader.icdoBenefitCalculationHeader.status_value = busConstant.BenefitCalculation.CALCULATION_STATUS_TYPE_APPROVED;
                        if (!ablnPostRetDeath)
                        {
                            UpdatePayeeAccountFromReEvaluationBatch(this, lbusBenefitCalculationHeader, lbusBenefitCalculationHeader.iclbBenefitCalculationDetail.FirstOrDefault(), lstrBenefitOptionValue);
                        }
                        lblnEvaluateBenefits = false;
                        return (lbusBenefitCalculationHeader as busDisabiltyBenefitCalculation);
                    }
                }
                else if (lstrPayeeAccountCreatedBy == "CONVERSION" && this.icdoPayeeAccount.benefit_calculation_detail_id == 0)
                {
                    busBenefitCalculationHeader lbusBenefitCalculationHeader = RecalculateParticipantDisabilityBenefits(lstrBenefitOptionValue, true, true, ablnPostRetDeath);
                    lbusBenefitCalculationHeader.icdoBenefitCalculationHeader.status_value = busConstant.BenefitCalculation.CALCULATION_STATUS_TYPE_APPROVED;
                    if (!ablnPostRetDeath)
                    {
                        UpdatePayeeAccountFromReEvaluationBatch(this, lbusBenefitCalculationHeader, lbusBenefitCalculationHeader.iclbBenefitCalculationDetail.FirstOrDefault(), lstrBenefitOptionValue);
                    }
                    lblnEvaluateBenefits = false;
                    return (lbusBenefitCalculationHeader as busDisabiltyBenefitCalculation);
                }
                else
                {
                    if (this.icdoPayeeAccount.benefit_calculation_detail_id > 0 && lbusBenefitCalculationDetail.FindBenefitCalculationDetail(this.icdoPayeeAccount.benefit_calculation_detail_id))
                    {
                        decimal lintYear = 0;
                        DataTable ldt = new DataTable();
                        lbusBenefitCalculationDetail.LoadBenefitCalculationOptionss();
                        if (ablnPostRetDeath)
                        {
                            if (lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.reemployed_accrued_benefit_effective_date != DateTime.MinValue)
                            {
                                if (lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.reemployed_accrued_benefit_effective_date < adtBenefitEffectiveDate)
                                {
                                    if (adtReEmployedHoursAfterRetirementDate.AsEnumerable().Where(o => o.Field<int>("Year") >
                                        lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.reemployed_accrued_benefit_effective_date.Year).Count() > 0)
                                    {
                                        lblnEvaluateBenefits = true;
                                        lintYear = lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.reemployed_accrued_benefit_effective_date.Year;
                                        ldt = adtReEmployedHoursAfterRetirementDate.AsEnumerable().Where(o => o.Field<int>("Year") == lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.reemployed_accrued_benefit_effective_date.Year).CopyToDataTable();
                                        LoadCalculatioObjectFromCalculationDetail(lbusBenefitCalculationDetail, lbusDisabiltyBenefitCalculation, lintBenAppId, lstrPlanCode, lbusPerson, ldecParticipantAge, ldecSpouseAge, adtBatchRunDate, ldt, lblnStartFromRetirement);
                                    }

                                }
                            }
                            else
                            {
                                lblnStartFromRetirement = true;
                                LoadCalculatioObjectFromCalculationDetail(lbusBenefitCalculationDetail, lbusDisabiltyBenefitCalculation, lintBenAppId, lstrPlanCode, lbusPerson, ldecParticipantAge, ldecSpouseAge, adtBatchRunDate, adtReEmployedHoursAfterRetirementDate, true);
                                lblnEvaluateBenefits = true;
                                ldecReferenceAccruedBenefit = lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.early_reduced_benefit_amount;
                            }
                        }
                        else if (ldecParticipantAge == 65)
                        {
                            lblnEvaluateBenefits = true;
                            lblnStartFromRetirement = true;
                            LoadCalculatioObjectFromCalculationDetail(lbusBenefitCalculationDetail, lbusDisabiltyBenefitCalculation, lintBenAppId, lstrPlanCode, lbusPerson, ldecParticipantAge, ldecSpouseAge, adtBatchRunDate, adtReEmployedHoursAfterRetirementDate, lblnStartFromRetirement);
                            ldecReferenceAccruedBenefit = lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.early_reduced_benefit_amount;

                        }
                        else
                        {
                            lblnEvaluateBenefits = true;
                            lintYear = adtBatchRunDate.AddYears(-1).Year;
                            ldt = adtReEmployedHoursAfterRetirementDate.AsEnumerable().Where(o => o.Field<int>("Year") == adtBatchRunDate.AddYears(-1).Year).CopyToDataTable(); ;
                            LoadCalculatioObjectFromCalculationDetail(lbusBenefitCalculationDetail, lbusDisabiltyBenefitCalculation, lintBenAppId, lstrPlanCode, lbusPerson, ldecParticipantAge, ldecSpouseAge, adtBatchRunDate, ldt, lblnStartFromRetirement);
                        }
                        if (lblnEvaluateBenefits)
                        {
                            if (!lbusBenefitCalculationDetail.iclbBenefitCalculationOptions.IsNullOrEmpty())
                            {
                                ldecCurrentBenefitAmount = lbusBenefitCalculationDetail.iclbBenefitCalculationOptions.FirstOrDefault().icdoBenefitCalculationOptions.benefit_amount;
                            }
                            //if (!lbusBenefitCalculationDetail.iclbBenefitCalculationYearlyDetail.IsNullOrEmpty())
                            //{
                            //    if (lbusBenefitCalculationDetail.iclbBenefitCalculationYearlyDetail.Where(item => item.icdoBenefitCalculationYearlyDetail.plan_year == adtBatchRunDate.AddYears(-1).Year && item.icdoBenefitCalculationYearlyDetail.reemployed_flag == busConstant.FLAG_YES).Count() > 0)
                            //    {
                            //        ldecReferenceAccruedBenefit = lbusBenefitCalculationDetail.iclbBenefitCalculationYearlyDetail.Where(item => item.icdoBenefitCalculationYearlyDetail.plan_year == lintYear && item.icdoBenefitCalculationYearlyDetail.reemployed_flag == busConstant.FLAG_YES).FirstOrDefault().icdoBenefitCalculationYearlyDetail.total_accrued_benefit;
                            //    }
                            //    else if (lbusBenefitCalculationDetail.iclbBenefitCalculationYearlyDetail.Where(item => item.icdoBenefitCalculationYearlyDetail.plan_year == lintYear).Count() > 0)
                            //    {
                            //        ldecReferenceAccruedBenefit = lbusBenefitCalculationDetail.iclbBenefitCalculationYearlyDetail.Where(item => item.icdoBenefitCalculationYearlyDetail.plan_year == lintYear).FirstOrDefault().icdoBenefitCalculationYearlyDetail.annual_adjustment_amount;
                            //        if (ldecReferenceAccruedBenefit == 0)
                            //        {
                            //            ldecReferenceAccruedBenefit = lbusBenefitCalculationDetail.iclbBenefitCalculationYearlyDetail.Where(item => item.icdoBenefitCalculationYearlyDetail.plan_year == lintYear).FirstOrDefault().icdoBenefitCalculationYearlyDetail.total_accrued_benefit;

                            //        }
                            //    }
                            //    else
                            //    {
                            //        ldecReferenceAccruedBenefit = lbusBenefitCalculationDetail.iclbBenefitCalculationYearlyDetail.OrderByDescending(item => item.icdoBenefitCalculationYearlyDetail.plan_year).ToList().ToCollection().Where(item => item.icdoBenefitCalculationYearlyDetail.plan_year <= lintYear).FirstOrDefault().icdoBenefitCalculationYearlyDetail.annual_adjustment_amount;
                            //        if (ldecReferenceAccruedBenefit == 0)
                            //        {
                            //            ldecReferenceAccruedBenefit = lbusBenefitCalculationDetail.iclbBenefitCalculationYearlyDetail.OrderByDescending(item => item.icdoBenefitCalculationYearlyDetail.plan_year).ToList().ToCollection().Where(item => item.icdoBenefitCalculationYearlyDetail.plan_year <= lintYear).FirstOrDefault().icdoBenefitCalculationYearlyDetail.total_accrued_benefit;

                            //        }

                            //    }
                            //}
                            //else
                            //{
                            //    ldecReferenceAccruedBenefit = lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.additional_accrued_benefit_amount;
                            //    if (ldecReferenceAccruedBenefit == 0)
                            //    {
                            //        ldecReferenceAccruedBenefit = lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.unreduced_benefit_amount;
                            //    }
                            //}
                        }
                    }
                }
            }
            else if (lstrPlanCode == busConstant.IAP)
            {
                lblnEvaluateBenefits = true;
                lblnStartFromRetirement = true;
                LoadCalculationObjectFromApplicationDetailForIAP(lbusBenefitApplicationDetail, lbusBenefitCalculationDetail, lbusDisabiltyBenefitCalculation, lintBenAppId, lbusPerson, ldecParticipantAge, ldecSpouseAge, adtBatchRunDate, adtReEmployedHoursAfterRetirementDate, lstrPlanCode);
                ldecReferenceAccruedBenefit = this.icdoPayeeAccount.unreduced_benefit_amount;
            }
            #region Commented
            /*

            #region Existing Pending Adjustment Calculation
            if (ldtAdjustments.Rows.Count > 0)
            {
                lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.LoadData(ldtAdjustments.Rows[0]);
                lbusDisabiltyBenefitCalculation = new busDisabiltyBenefitCalculation { icdoBenefitCalculationHeader = new cdoBenefitCalculationHeader() };
                busBenefitCalculationOptions lbusBenefitCalculationOptions = new busBenefitCalculationOptions { icdoBenefitCalculationOptions = new cdoBenefitCalculationOptions() };

                lbusDisabiltyBenefitCalculation.FindBenefitCalculationHeader(lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.benefit_calculation_header_id);
                lbusDisabiltyBenefitCalculation.ibusBenefitApplication = LoadRetirementApplicationObject(lintBenAppId, lbusPerson, ldecParticipantAge);
                lbusDisabiltyBenefitCalculation.ibusPerson = lbusDisabiltyBenefitCalculation.ibusBenefitApplication.ibusPerson;
                lbusDisabiltyBenefitCalculation.ibusPerson.iclbPersonAccount = lbusDisabiltyBenefitCalculation.ibusBenefitApplication.ibusPerson.iclbPersonAccount;
                lbusDisabiltyBenefitCalculation.icdoBenefitCalculationHeader.iintPlanId = lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.plan_id;
                lbusDisabiltyBenefitCalculation.icdoBenefitCalculationHeader.age = busGlobalFunctions.CalculatePersonAgeInDec(lbusPerson.icdoPerson.idtDateofBirth, adtBatchRunDate);
                lbusDisabiltyBenefitCalculation.icdoBenefitCalculationHeader.idecParticipantFullAge = ldecParticipantAge;
                lbusDisabiltyBenefitCalculation.icdoBenefitCalculationHeader.iintSurvivorAgeAtRetirement = ldecSpouseAge;
                #region Set Parameters for Retirement
                #endregion

                //lbusBenefitCalculationDetail.LoadBenefitCalculationOptionss();
                lbusBenefitCalculationDetail.LoadBenefitCalculationYearlyDetails();

                lbusDisabiltyBenefitCalculation.ibusBenefitApplication.aclbReEmployedWorkHistory = cdoDummyWorkData.GetCollection<cdoDummyWorkData>(adtReEmployedHoursAfterRetirementDate);
                this.LoadWorkDataCollectionObjectAfterRetirement(lbusDisabiltyBenefitCalculation.ibusBenefitApplication.aclbReEmployedWorkHistory, lbusDisabiltyBenefitCalculation.ibusPerson);

            }
            #endregion

            #region Existing Calculation
            else if (lbusBenefitCalculationDetail.FindBenefitCalculationDetail(this.icdoPayeeAccount.benefit_calculation_detail_id))
            {
                lbusDisabiltyBenefitCalculation = new busDisabiltyBenefitCalculation { icdoBenefitCalculationHeader = new cdoBenefitCalculationHeader() };
                busBenefitCalculationOptions lbusBenefitCalculationOptions = new busBenefitCalculationOptions { icdoBenefitCalculationOptions = new cdoBenefitCalculationOptions() };

                lbusDisabiltyBenefitCalculation.FindBenefitCalculationHeader(lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.benefit_calculation_header_id);
                lbusDisabiltyBenefitCalculation.ibusBenefitApplication = LoadRetirementApplicationObject(lintBenAppId, lbusPerson, ldecParticipantAge);
                lbusDisabiltyBenefitCalculation.ibusPerson = lbusDisabiltyBenefitCalculation.ibusBenefitApplication.ibusPerson;
                lbusDisabiltyBenefitCalculation.ibusPerson.iclbPersonAccount = lbusDisabiltyBenefitCalculation.ibusBenefitApplication.ibusPerson.iclbPersonAccount;
                lbusDisabiltyBenefitCalculation.icdoBenefitCalculationHeader.iintPlanId = lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.plan_id;
                lbusDisabiltyBenefitCalculation.icdoBenefitCalculationHeader.age = busGlobalFunctions.CalculatePersonAgeInDec(lbusPerson.icdoPerson.idtDateofBirth, adtBatchRunDate);
                lbusDisabiltyBenefitCalculation.icdoBenefitCalculationHeader.idecParticipantFullAge = ldecParticipantAge;
                lbusDisabiltyBenefitCalculation.icdoBenefitCalculationHeader.iintSurvivorAgeAtRetirement = ldecSpouseAge;
                #region Set Parameters for Retirement
                #endregion

                //lbusBenefitCalculationDetail.LoadBenefitCalculationOptionss();
                lbusBenefitCalculationDetail.LoadBenefitCalculationYearlyDetails();

                lbusDisabiltyBenefitCalculation.ibusBenefitApplication.aclbReEmployedWorkHistory = cdoDummyWorkData.GetCollection<cdoDummyWorkData>(adtReEmployedHoursAfterRetirementDate);
                this.LoadWorkDataCollectionObjectAfterRetirement(lbusDisabiltyBenefitCalculation.ibusBenefitApplication.aclbReEmployedWorkHistory, lbusDisabiltyBenefitCalculation.ibusPerson);
            }
            #endregion

            #region Conversion Applications
            else if (lbusBenefitApplicationDetail.FindBenefitApplicationDetail(this.icdoPayeeAccount.benefit_application_detail_id))
            {
                busBenefitApplication lbusBenefitApplication = new busBenefitApplication { icdoBenefitApplication = new cdoBenefitApplication() };
                lbusDisabiltyBenefitCalculation = new busDisabiltyBenefitCalculation { icdoBenefitCalculationHeader = new cdoBenefitCalculationHeader() };
                lbusBenefitCalculationDetail = new busBenefitCalculationDetail { icdoBenefitCalculationDetail = new cdoBenefitCalculationDetail() };

                lbusDisabiltyBenefitCalculation.ibusBenefitApplication = LoadRetirementApplicationObject(lintBenAppId, lbusPerson, ldecParticipantAge);
                LoadRetirementObjectForReEmployedParticipants(lbusDisabiltyBenefitCalculation, lbusBenefitApplicationDetail);
                lbusDisabiltyBenefitCalculation.ibusBenefitApplication.aclbReEmployedWorkHistory = cdoDummyWorkData.GetCollection<cdoDummyWorkData>(adtReEmployedHoursAfterRetirementDate);
                lbusDisabiltyBenefitCalculation.icdoBenefitCalculationHeader.age = busGlobalFunctions.CalculatePersonAgeInDec(lbusPerson.icdoPerson.idtDateofBirth, adtBatchRunDate);
                lbusDisabiltyBenefitCalculation.icdoBenefitCalculationHeader.idecParticipantFullAge = ldecParticipantAge;
                lbusDisabiltyBenefitCalculation.icdoBenefitCalculationHeader.iintSurvivorAgeAtRetirement = ldecSpouseAge;

                this.LoadWorkDataCollectionObjectAfterRetirement(lbusDisabiltyBenefitCalculation.ibusBenefitApplication.aclbReEmployedWorkHistory, lbusDisabiltyBenefitCalculation.ibusPerson);
                LoadCalculationDetailObject(lbusDisabiltyBenefitCalculation, lbusBenefitCalculationDetail, lbusBenefitApplicationDetail);
            }

            #endregion

            */
            #endregion

            if (lblnEvaluateBenefits)
            {
                #region Get New Detail Object
                if (adtBenefitEffectiveDate.Day == 1)
                {
                    lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.reemployed_accrued_benefit_effective_date = adtBenefitEffectiveDate;
                }
                else
                {
                    lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.reemployed_accrued_benefit_effective_date = adtBenefitEffectiveDate.AddMonths(1).GetFirstDayofMonth();
                }
                if (lbusDisabiltyBenefitCalculation.iclbBenefitCalculationDetail.IsNull())
                {
                    lbusDisabiltyBenefitCalculation.iclbBenefitCalculationDetail = new Collection<busBenefitCalculationDetail>();
                }
                lbusDisabiltyBenefitCalculation.iclbBenefitCalculationDetail.Add(lbusBenefitCalculationDetail);
                if (lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.plan_id == busConstant.MPIPP_PLAN_ID)
                {
                    ibusCalculation.CalculateAccruedBenefitForReEmployedParticipant(lbusDisabiltyBenefitCalculation, this, adtBatchRunDate, lblnStartFromRetirement);
                }
                else if (lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.plan_id == busConstant.IAP_PLAN_ID)
                {
                    lbusDisabiltyBenefitCalculation.iblnCalculateIAPBenefit = true;
                    lbusDisabiltyBenefitCalculation.iblnCalculateL52SplAccBenefit = false;
                    lbusDisabiltyBenefitCalculation.iblnCalculateL161SplAccBenefit = false;
                    ibusCalculation.LoadIapBalanceForReEmployedParticipants(lbusDisabiltyBenefitCalculation);
                }

                #endregion

                #region Get New Options Object
                //lbusBenefitCalculationRetirement.CalculateBenefit
                decimal ldecFinalAccruedBenefit = lbusDisabiltyBenefitCalculation.iclbBenefitCalculationDetail.FirstOrDefault().icdoBenefitCalculationDetail.early_reduced_benefit_amount;
                if (lbusBenefitCalculationDetail.iclbBenefitCalculationOptions.IsNull())
                {
                    lbusBenefitCalculationDetail.iclbBenefitCalculationOptions = new Collection<busBenefitCalculationOptions>();
                }
                //ibusCalculation.CalculateOptionForReEmployedBenefit(lbusBenefitCalculationOptions, lbusBenefitCalculationDetail);
                if (lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.plan_id == busConstant.MPIPP_PLAN_ID)
                {
                    lbusDisabiltyBenefitCalculation.GetBenefitAmountForEachYearAfterRetirement(lbusDisabiltyBenefitCalculation, lstrBenefitOptionValue, adtBatchRunDate, lbusPerson.icdoPerson.idtDateofBirth, ldtSpouseDOB, lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.reemployed_accrued_benefit_effective_date, lblnStartFromRetirement, ldecReferenceAccruedBenefit, ldecCurrentBenefitAmount);
                    //lbusDisabiltyBenefitCalculation.GetDisabilityBenefitOptions(lstrBenefitOptionValue, lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.unreduced_benefit_amount, decimal.Zero, decimal.Zero);
                }
                else if (lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.plan_id == busConstant.IAP_PLAN_ID)
                {
                    lbusDisabiltyBenefitCalculation.CalculateIAPBenefitAmount(lstrBenefitOptionValue, true);
                }
                #endregion

                #region CreateNewFinalDroForRetireeModel

                decimal ldecParticipantAmount = decimal.Zero;
                decimal ldecAPTaxableOffset = decimal.Zero;
                decimal ldecAPNonTaxableOffset = decimal.Zero;
                if (!lbusBenefitCalculationDetail.iclbBenefitCalculationOptions.IsNullOrEmpty())
                {
                    DataTable ldtDroApp = Select("cdoDroBenefitDetails.GetRetireeApForParticipantForReevaluation", new object[2] { this.icdoPayeeAccount.person_id, this.icdoPayeeAccount.iintPlanId });
                    if (ldtDroApp.Rows.Count > 0)
                    {
                        busQdroApplication lbusQdroApplication;
                        busDroBenefitDetails lbusDroBenefitDetails;
                        busPayeeAccount lbusAPPayeeAccount;
                        busQdroCalculationHeader lbusQdroCalculationHeader;
                        ldecParticipantAmount = lbusBenefitCalculationDetail.iclbBenefitCalculationOptions.FirstOrDefault().icdoBenefitCalculationOptions.benefit_amount;
                        int lintDROAppId;
                        foreach (DataRow ldtRow in ldtDroApp.Rows)
                        {
                            lintDROAppId = Convert.ToInt32(ldtRow[enmDroBenefitDetails.dro_application_id.ToString()]);
                            lbusQdroApplication = new busQdroApplication { icdoDroApplication = new cdoDroApplication() };
                            lbusDroBenefitDetails = new busDroBenefitDetails { icdoDroBenefitDetails = new cdoDroBenefitDetails() };
                            lbusDroBenefitDetails.icdoDroBenefitDetails.LoadData(ldtRow);
                            lbusQdroApplication.FindQdroApplication(lintDROAppId);
                            lbusAPPayeeAccount = new busPayeeAccount { icdoPayeeAccount = new cdoPayeeAccount() };
                            lbusAPPayeeAccount.icdoPayeeAccount.LoadData(ldtRow);
                            lbusAPPayeeAccount.ibusPayee = new busPerson { icdoPerson = new cdoPerson() };
                            lbusAPPayeeAccount.ibusPayee.FindPerson(lbusAPPayeeAccount.icdoPayeeAccount.person_id);
                            lbusAPPayeeAccount.ibusParticipant = this.ibusParticipant;


                            #region Initialize Calculation Needed Objects from Application
                            lbusQdroCalculationHeader = new busQdroCalculationHeader { icdoQdroCalculationHeader = new cdoQdroCalculationHeader() };
                            lbusQdroCalculationHeader.ibusBenefitApplication = new busBenefitApplication { icdoBenefitApplication = new cdoBenefitApplication() };
                            lbusQdroCalculationHeader.ibusQdroApplication = new busQdroApplication();
                            lbusQdroCalculationHeader.ibusQdroApplication = lbusQdroApplication;
                            lbusQdroCalculationHeader.ibusQdroApplication.iclbDroBenefitDetails = new Collection<busDroBenefitDetails>();
                            lbusQdroCalculationHeader.ibusQdroApplication.LoadBenefitDetails();
                            //Need to set this value since QDRO calculation requires iclbDroBenefitDetails collection
                            lbusQdroCalculationHeader.ibusQdroApplication.iclbDroBenefitDetails =
                                lbusQdroCalculationHeader.ibusQdroApplication.iclbDroBenefitDetails.Where(item => item.icdoDroBenefitDetails.dro_benefit_id ==
                                lbusDroBenefitDetails.icdoDroBenefitDetails.dro_benefit_id).ToList().ToCollection();

                            #endregion

                            #region Create FINAL Post Retirement DRO
                            lbusQdroCalculationHeader.iblnParticipantPayeeAccount = true;
                            lbusQdroCalculationHeader.idecParticipantAmount = ldecParticipantAmount;
                            lbusQdroCalculationHeader.iclbParticipantsPayeeAccount = new Collection<busPayeeAccount>();
                            lbusQdroCalculationHeader.iclbParticipantsPayeeAccount.Add(this);

                            decimal ldecTaxableAmount = decimal.Zero;
                            decimal ldecNonTaxableAmount = decimal.Zero;
                            lbusQdroCalculationHeader = RecalculateDRO(lbusQdroCalculationHeader, lbusAPPayeeAccount, lbusDroBenefitDetails, busConstant.BenefitCalculation.CALCULATION_TYPE_FINAL, true, true, ref ldecTaxableAmount, ref ldecNonTaxableAmount, lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.reemployed_accrued_benefit_effective_date);
                            ldecAPNonTaxableOffset += ldecNonTaxableAmount;
                            ldecAPTaxableOffset += ldecTaxableAmount;
                            if (!lbusQdroCalculationHeader.iclbQdroCalculationDetail.IsNullOrEmpty())
                            {
                                lbusAPPayeeAccount.icdoPayeeAccount.dro_calculation_detail_id = lbusQdroCalculationHeader.iclbQdroCalculationDetail.FirstOrDefault().icdoQdroCalculationDetail.qdro_calculation_detail_id;
                                lbusAPPayeeAccount.icdoPayeeAccount.Update();
                            }
                            #endregion

                        }
                    }
                }
                #endregion

                if (!ablnPostRetDeath)
                {
                    #region Insert Header Object
                    InsertNewCalculationHeaderObject(lbusDisabiltyBenefitCalculation, lbusBenefitCalculationDetail, lstrBenefitOptionValue, lblnStartFromRetirement);
                    #endregion
                }
            }

            return lbusDisabiltyBenefitCalculation;
        }

        public busRetirementApplication LoadRetirementApplicationObject(int aintbenefitapplicationid, busPerson abusPerson, decimal adecParticipantAge, string astrPlanCode)
        {
            busRetirementApplication lbusRetirementApplication = new busRetirementApplication();
            if (lbusRetirementApplication.FindBenefitApplication(aintbenefitapplicationid))
            {
                lbusRetirementApplication.ibusPerson = abusPerson;
                lbusRetirementApplication.idecAge = adecParticipantAge;
                lbusRetirementApplication.ibusPerson.LoadPersonAccounts();
                if (astrPlanCode == busConstant.MPIPP)
                {
                    lbusRetirementApplication.LoadandProcessWorkHistory_ForAllPlans();
                }
            }

            return lbusRetirementApplication;
        }

        public void LoadRetirementObjectForReEmployedParticipants(busBenefitCalculationHeader abusBenefitCalculationHeader, busBenefitApplicationDetail abusBenefitApplicationDetail)
        {
            abusBenefitCalculationHeader.ibusPerson = abusBenefitCalculationHeader.ibusBenefitApplication.ibusPerson;
            abusBenefitCalculationHeader.ibusPerson.iclbPersonAccount = abusBenefitCalculationHeader.ibusBenefitApplication.ibusPerson.iclbPersonAccount;
            abusBenefitCalculationHeader.icdoBenefitCalculationHeader.age = busGlobalFunctions.CalculatePersonAgeInDec(abusBenefitCalculationHeader.ibusBenefitApplication.ibusPerson.icdoPerson.idtDateofBirth, abusBenefitCalculationHeader.ibusBenefitApplication.icdoBenefitApplication.retirement_date);

            //abusBenefitCalculationHeader.PopulateInitialDataBenefitCalculationHeaderForRemployment(this.icdoPayeeAccount.person_id, abusBenefitApplicationDetail.icdoBenefitApplicationDetail.benefit_application_id,
            //abusBenefitApplicationDetail.icdoBenefitApplicationDetail.joint_annuitant_id, this.icdoPayeeAccount.benefit_account_type_value, busConstant.BenefitCalculation.CALCULATION_TYPE_FINAL, abusBenefitCalculationHeader.ibusBenefitApplication.icdoBenefitApplication.retirement_date,
            //abusBenefitCalculationHeader.ibusBenefitApplication.idecAge, abusBenefitApplicationDetail.iintPlan_ID);
        }

        public busBenefitCalculationDetail LoadCalculationDetailObject(busBenefitCalculationHeader abusBenefitCalculationHeader, busBenefitCalculationDetail abusBenefitCalculationDetail, busBenefitApplicationDetail abusBenefitApplicationDetail, busPersonAccount abusPersonAccount)
        {
            if (abusBenefitCalculationHeader.ibusPerson.iclbPersonAccount.Where(item => item.icdoPersonAccount.istrPlanCode == abusBenefitApplicationDetail.istrPlanCode).Count() > 0)
            {
                decimal ldecParticipantAgeAtRetirement = decimal.Zero;
                decimal ldecSpouseAgeAtRetirement = decimal.Zero;
                bool lblnQualifiedSpouse = false;
                int lintPersonAccountId = abusPersonAccount.icdoPersonAccount.person_account_id;
                abusBenefitCalculationHeader.PopulateInitialDataBenefitCalculationDetails(abusBenefitApplicationDetail.icdoBenefitApplicationDetail.benefit_application_detail_id, lintPersonAccountId, abusBenefitCalculationHeader.icdoBenefitCalculationHeader.iintPlanId, abusBenefitApplicationDetail.istrPlanCode, abusBenefitCalculationHeader.ibusBenefitApplication.ibusTempPersonAccountEligibility.icdoPersonAccountEligibility.vested_date, abusBenefitApplicationDetail.icdoBenefitApplicationDetail.benefit_subtype_value);

                ldecParticipantAgeAtRetirement = busGlobalFunctions.CalculatePersonAge(abusBenefitCalculationHeader.ibusPerson.icdoPerson.idtDateofBirth, abusBenefitCalculationHeader.icdoBenefitCalculationHeader.retirement_date);
                if (abusBenefitApplicationDetail.icdoBenefitApplicationDetail.joint_annuitant_id > 0)
                {
                    ldecSpouseAgeAtRetirement = busGlobalFunctions.CalculatePersonAge(abusBenefitCalculationHeader.icdoBenefitCalculationHeader.beneficiary_person_date_of_birth, abusBenefitCalculationHeader.icdoBenefitCalculationHeader.retirement_date);
                    lblnQualifiedSpouse = ibusCalculation.CheckIfSurvivorIsQualifiedSpouse(abusBenefitCalculationHeader.icdoBenefitCalculationHeader.person_id, abusBenefitCalculationHeader.icdoBenefitCalculationHeader.beneficiary_person_id);
                }
                abusBenefitCalculationDetail = abusBenefitCalculationHeader.iclbBenefitCalculationDetail.FirstOrDefault();
                if (abusBenefitCalculationHeader.icdoBenefitCalculationHeader.iintPlanId == busConstant.MPIPP_PLAN_ID)
                {
                    abusBenefitCalculationHeader.ibusCalculation.CalculateMEA(abusPersonAccount.icdoPersonAccount.idecVestedEE, lblnQualifiedSpouse, ldecParticipantAgeAtRetirement, ldecSpouseAgeAtRetirement);
                }
            }

            return abusBenefitCalculationDetail;
        }
        public void LoadWorkDataCollectionObjectAfterRetirement(Collection<cdoDummyWorkData> aclbPersonWorkHistoryAfterRet, busPerson abusPerson, DateTime adtRetirementDate)
        {
            //PIR 627
            //DateTime ldtComputationYearEndDate = busGlobalFunctions.GetLastDateOfComputationYear(aclbPersonWorkHistoryAfterRet.First().year);
            //decimal lintAgeCounter = (ldtComputationYearEndDate.Year - abusPerson.icdoPerson.idtDateofBirth.Year) + Math.Round((ldtComputationYearEndDate.Month - abusPerson.icdoPerson.idtDateofBirth.Month) / 12m, 4);
            //foreach (cdoDummyWorkData item in aclbPersonWorkHistoryAfterRet)
            //{
            //    item.age = lintAgeCounter;
            //    lintAgeCounter++;
            //}            
            foreach (cdoDummyWorkData item in aclbPersonWorkHistoryAfterRet)
            {
                DateTime ldtComputationYearEndDate = busGlobalFunctions.GetLastDateOfComputationYear(item.year);
                decimal lintAgeCounter = (ldtComputationYearEndDate.Year - abusPerson.icdoPerson.idtDateofBirth.Year) + Math.Round((ldtComputationYearEndDate.Month - abusPerson.icdoPerson.idtDateofBirth.Month) / 12m, 4);
                item.age = lintAgeCounter;
            }
            //split row at age 65
            CalculateDataTillAge65ForReEmploymentSplit(aclbPersonWorkHistoryAfterRet, abusPerson, adtRetirementDate);
        }

        //PIR 627
        private void CalculateDataTillAge65ForReEmploymentSplit(Collection<cdoDummyWorkData> aclbPersonWorkHistoryAfterRet, busPerson abusPerson, DateTime adtRetirementDate)
        {
            foreach (cdoDummyWorkData acdoDummyWorkData in aclbPersonWorkHistoryAfterRet)
            {
                decimal ldecNormalRetirementAge = busConstant.ZERO_DECIMAL;
                DateTime ldtNormalRetirementDate = DateTime.MinValue;
                if (this.ibusCalculation.IsNull())
                    this.ibusCalculation = new busCalculation();

                ldecNormalRetirementAge = this.ibusCalculation.GetNormalRetirementAge(this.icdoPayeeAccount.iintPlanId);
                ldtNormalRetirementDate = abusPerson.icdoPerson.idtDateofBirth.AddYears(Convert.ToInt32(ldecNormalRetirementAge));
                //PIR 1035
                if (ldtNormalRetirementDate.Day != 1)
                {
                    ldtNormalRetirementDate = ldtNormalRetirementDate.AddMonths(1).GetFirstDayofMonth();
                }


                if ((Math.Floor(acdoDummyWorkData.age) == 65 && ldtNormalRetirementDate.Year == acdoDummyWorkData.year) ||
                       (Math.Floor(acdoDummyWorkData.age) > 65 && ldtNormalRetirementDate.Year == acdoDummyWorkData.year))
                {
                    decimal ldecOriginalidecvested_hours = acdoDummyWorkData.vested_hours;
                    decimal ldecOriginalqualified_hours = acdoDummyWorkData.qualified_hours;
                    decimal ldecOriginalidecTotalHealthHours = acdoDummyWorkData.idecTotalHealthHours;

                    decimal ldecHoursAtAge65 = busConstant.ZERO_DECIMAL;
                    if (ldtNormalRetirementDate != DateTime.MinValue)
                    {
                        //Calculate the Accrued Benefit upto Age 65            
                        Hashtable lhstMonthlyHours = new Hashtable();
                        lhstMonthlyHours = this.ibusCalculation.GetMonthlyHoursForPlanYear(abusPerson.icdoPerson.ssn, acdoDummyWorkData.year, this.icdoPayeeAccount.iintPlanId);

                        IDictionaryEnumerator denum = lhstMonthlyHours.GetEnumerator();
                        DictionaryEntry dentry;
                        denum.Reset();
                        while (denum.MoveNext() != false)
                        {
                            dentry = (DictionaryEntry)denum.Current;
                            //PIR 1035
                            if (adtRetirementDate != DateTime.Now && adtRetirementDate < ldtNormalRetirementDate)
                            {
                                if ((int)dentry.Key <= ldtNormalRetirementDate.Month && (int)dentry.Key > adtRetirementDate.Month)
                                    Math.Round(ldecHoursAtAge65 = ldecHoursAtAge65 + (decimal)dentry.Value, 2, MidpointRounding.AwayFromZero);
                            }
                            else if ((int)dentry.Key <= ldtNormalRetirementDate.Month)
                            {
                                Math.Round(ldecHoursAtAge65 = ldecHoursAtAge65 + (decimal)dentry.Value, 2, MidpointRounding.AwayFromZero);
                            }
                        }
                    }
                    //add new row for exsiting year for split at age 65
                    cdoDummyWorkData lcdoDummyWorkData = new cdoDummyWorkData();
                    lcdoDummyWorkData.year = acdoDummyWorkData.year;
                    lcdoDummyWorkData.vested_hours = ldecHoursAtAge65;
                    lcdoDummyWorkData.qualified_hours = ldecHoursAtAge65;
                    lcdoDummyWorkData.idecTotalHealthHours = ldecHoursAtAge65;
                    lcdoDummyWorkData.age = ldecNormalRetirementAge;
                    aclbPersonWorkHistoryAfterRet.Add(lcdoDummyWorkData);

                    //update remaning split hours with existing year
                    acdoDummyWorkData.vested_hours = ldecOriginalidecvested_hours - ldecHoursAtAge65;
                    acdoDummyWorkData.qualified_hours = ldecOriginalqualified_hours - ldecHoursAtAge65;
                    acdoDummyWorkData.idecTotalHealthHours = ldecOriginalidecTotalHealthHours - ldecHoursAtAge65;

                    break;
                }
            }
        }

        /// <summary>
        /// adecAPTaxableOffset,adecAPNonTaxableOffset : Only gets set in case of updating payment item types
        /// </summary>
        /// <param name="abusBenefitCalculationHeader"></param>
        /// <param name="abusBenefitCalculationDetail"></param>
        /// <param name="astrBenefitOptionValue"></param>
        /// <param name="ablnMinDistribution"></param>
        /// <param name="adecAPTaxableOffset"></param>
        /// <param name="adecAPNonTaxableOffset"></param>
        public void InsertNewCalculationHeaderObject(busBenefitCalculationHeader abusBenefitCalculationHeader, busBenefitCalculationDetail abusBenefitCalculationDetail, string astrBenefitOptionValue, bool ablnStartFromRetirement, bool ablnMinDistribution = false, decimal adecAPTaxableOffset = decimal.Zero, decimal adecAPNonTaxableOffset = decimal.Zero)
        {
            abusBenefitCalculationHeader.icdoBenefitCalculationHeader.benefit_calculation_header_id = 0;
            abusBenefitCalculationHeader.icdoBenefitCalculationHeader.status_value = busConstant.BenefitCalculation.CALCULATION_STATUS_TYPE_APPROVED;
            ibusCalculation.ResetAuditFields(abusBenefitCalculationHeader.icdoBenefitCalculationHeader);
            abusBenefitCalculationHeader.icdoBenefitCalculationHeader.ienuObjectState = ObjectState.Insert;
            abusBenefitCalculationHeader.icdoBenefitCalculationHeader.Insert();

            foreach (busBenefitCalculationDetail lbusBenefitCalculationDetail in abusBenefitCalculationHeader.iclbBenefitCalculationDetail)
            {
                lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.ienuObjectState = ObjectState.Insert;
                lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.benefit_calculation_detail_id = 0;
                ibusCalculation.ResetAuditFields(lbusBenefitCalculationDetail.icdoBenefitCalculationDetail);
                lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.benefit_calculation_header_id = abusBenefitCalculationHeader.icdoBenefitCalculationHeader.benefit_calculation_header_id;
                lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.Insert();

                if (!lbusBenefitCalculationDetail.iclbBenefitCalculationOptions.IsNullOrEmpty())
                {
                    foreach (busBenefitCalculationOptions lbusBenefitCalculationOptions in lbusBenefitCalculationDetail.iclbBenefitCalculationOptions)
                    {
                        lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.ienuObjectState = ObjectState.Insert;
                        lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.benefit_calculation_option_id = 0;
                        ibusCalculation.ResetAuditFields(lbusBenefitCalculationOptions.icdoBenefitCalculationOptions);
                        lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.benefit_calculation_detail_id = lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.benefit_calculation_detail_id;
                        lbusBenefitCalculationOptions.icdoBenefitCalculationOptions.Insert();

                    }
                }

                if (!lbusBenefitCalculationDetail.iclbBenefitCalculationYearlyDetail.IsNullOrEmpty())
                {

                    foreach (busBenefitCalculationYearlyDetail lbusBenefitCalculationYearlyDetail in lbusBenefitCalculationDetail.iclbBenefitCalculationYearlyDetail)
                    {
                        lbusBenefitCalculationYearlyDetail.icdoBenefitCalculationYearlyDetail.ienuObjectState = ObjectState.Insert;
                        lbusBenefitCalculationYearlyDetail.icdoBenefitCalculationYearlyDetail.benefit_calculation_yearly_detail_id = 0;
                        lbusBenefitCalculationYearlyDetail.icdoBenefitCalculationYearlyDetail.benefit_calculation_detail_id = lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.benefit_calculation_detail_id; ;
                        lbusBenefitCalculationYearlyDetail.icdoBenefitCalculationYearlyDetail.Insert();

                        #region Commented
                        if (lbusBenefitCalculationYearlyDetail.iclbBenefitCalculationNonsuspendibleDetail != null && lbusBenefitCalculationYearlyDetail.iclbBenefitCalculationNonsuspendibleDetail.Count > 0)
                        {
                            foreach (busBenefitCalculationNonsuspendibleDetail lbusBenefitCalculationNonsuspendibleDetail in lbusBenefitCalculationYearlyDetail.iclbBenefitCalculationNonsuspendibleDetail)
                            {
                                lbusBenefitCalculationNonsuspendibleDetail.icdoBenefitCalculationNonsuspendibleDetail.benefit_calculation_yearly_detail_id = lbusBenefitCalculationYearlyDetail.icdoBenefitCalculationYearlyDetail.benefit_calculation_yearly_detail_id;
                                lbusBenefitCalculationNonsuspendibleDetail.icdoBenefitCalculationNonsuspendibleDetail.benefit_calculation_detail_id = lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.benefit_calculation_detail_id;
                                lbusBenefitCalculationNonsuspendibleDetail.icdoBenefitCalculationNonsuspendibleDetail.Insert();
                            }
                        }
                        #endregion
                    }
                }
                this.icdoPayeeAccount.benefit_calculation_detail_id = abusBenefitCalculationHeader.iclbBenefitCalculationDetail.FirstOrDefault().icdoBenefitCalculationDetail.benefit_calculation_detail_id;
                //this.icdoPayeeAccount.accrued_benefit_to_be_paid_reeval_flag = busConstant.FLAG_NO;
                this.icdoPayeeAccount.Update();

                //Participant : Should already be recieving benefits 
                if (abusBenefitCalculationHeader.icdoBenefitCalculationHeader.benefit_calculation_header_id > 0)
                {
                    #region UpdatePaymentItemTypes
                    if (this.icdoPayeeAccount.reemployed_flag == busConstant.FLAG_NO)
                    {
                        //MPI will set up data for conversion data in reemployment history without 
                        bool lblnReemploymentFromConversion = false;
                        if (this.iclcReemploymentHistory.IsNullOrEmpty())
                        {
                            this.LoadReemploymentHistorys();
                        }
                        if (!this.iclcReemploymentHistory.IsNullOrEmpty())
                        {
                            if (this.iclcReemploymentHistory.Where(item => item.reemployed_flag_to_date == DateTime.MinValue).Count() > 0)
                            {
                                lblnReemploymentFromConversion = true;
                            }
                        }

                        if (lblnReemploymentFromConversion || ablnStartFromRetirement)
                        {
                            if (lblnReemploymentFromConversion)
                            {
                                this.icdoPayeeAccount.reemployed_flag_as_of_date = this.iclcReemploymentHistory.Where(item => item.reemployed_flag_to_date == DateTime.MinValue).FirstOrDefault().reemployed_flag_from_date;
                                //ResumeParticipantAndAlternatePayeeBenefits(DateTime.Now);
                            }
                            else
                            {
                                if (!this.iclcReemploymentHistory.IsNullOrEmpty())
                                {
                                    cdoReemploymentHistory lcdoReemploymentHistory = this.iclcReemploymentHistory.OrderByDescending(item => item.modified_date).FirstOrDefault();
                                    if (this.icdoPayeeAccount.reemployed_flag_as_of_date == DateTime.MinValue)
                                    {
                                        this.icdoPayeeAccount.reemployed_flag_as_of_date = lcdoReemploymentHistory.reemployed_flag_from_date;
                                    }
                                    //ResumeParticipantAndAlternatePayeeBenefits(DateTime.Now, lcdoReemploymentHistory);
                                }
                            }
                        }
                        else
                        {
                            decimal ldecTaxableAmount = decimal.Zero;
                            decimal ldecNonTaxableShouldHaveBeenPaid = decimal.Zero;
                            decimal ldecTaxableShouldHaveBeenPaid = decimal.Zero;

                            if (this.icdoPayeeAccount.benefit_account_type_value == busConstant.BENEFIT_TYPE_RETIREMENT)
                            {
                                ldecTaxableAmount = lbusBenefitCalculationDetail.iclbBenefitCalculationOptions.FirstOrDefault().icdoBenefitCalculationOptions.benefit_amount;
                            }
                            else
                            {
                                ldecTaxableAmount = lbusBenefitCalculationDetail.iclbBenefitCalculationOptions.FirstOrDefault().icdoBenefitCalculationOptions.participant_amount;
                            }
                            ldecTaxableAmount = ldecTaxableAmount - adecAPTaxableOffset;
                            ldecNonTaxableShouldHaveBeenPaid = lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.monthly_exclusion_amount - adecAPNonTaxableOffset;

                            UpdatePaymentItemTypeWithNewAmount(this, ldecNonTaxableShouldHaveBeenPaid, ldecTaxableAmount, decimal.Zero, astrBenefitOptionValue, DateTime.Now, abusBenefitCalculationHeader.iclbBenefitCalculationDetail.FirstOrDefault().icdoBenefitCalculationDetail.plan_id, ref ldecTaxableShouldHaveBeenPaid);

                            #region AmountAlreadyPaidToTheParticipant
                            Collection<busBenefitMonthwiseAdjustmentDetail> lclbBenefitMonthwiseAdjustmentDetail = new Collection<busBenefitMonthwiseAdjustmentDetail>();
                            lclbBenefitMonthwiseAdjustmentDetail = ibusCalculation.GetAmountActuallyPaid(this, lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.reemployed_accrued_benefit_effective_date, this.idtLastBenefitPaymentDate);
                            #endregion

                            #region Amount Should Have been Paid
                            foreach (busBenefitMonthwiseAdjustmentDetail lbusBenefitMonthwiseAdjustmentDetail in lclbBenefitMonthwiseAdjustmentDetail)
                            {
                                lbusBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.non_taxable_amount_to_be_paid = ldecTaxableAmount - ldecTaxableShouldHaveBeenPaid;
                                lbusBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.taxable_amount_to_be_paid = ldecTaxableShouldHaveBeenPaid;
                            }
                            ibusCalculation.CreateOverpaymentUnderPayment(this, lclbBenefitMonthwiseAdjustmentDetail, busConstant.RETRO_PAYMENT_REEMPLOYMENT);
                            #endregion
                        }

                    }

                    #endregion

                }
                //lbusBenefitCalculationDetail.LoadBenefitCalculationYearlyDetailsTotal();
            }
        }

        public void UpdatePayeeAccountFromReEvaluationBatch(busPayeeAccount abusPayeeAccount, busBenefitCalculationHeader abusBenefitCalculationHeader, busBenefitCalculationDetail abusBenefitCalculationDetail, string astrBenefitOptionValue)
        {
            abusPayeeAccount.icdoPayeeAccount.benefit_calculation_detail_id = abusBenefitCalculationHeader.iclbBenefitCalculationDetail.FirstOrDefault().icdoBenefitCalculationDetail.benefit_calculation_detail_id;

            //Participant : Should already be recieving benefits 
            #region UpdatePaymentItemTypes
            if (abusBenefitCalculationHeader.icdoBenefitCalculationHeader.benefit_calculation_header_id > 0)
            {
                if (this.icdoPayeeAccount.reemployed_flag == busConstant.FLAG_NO)//means benefits are already resumed 
                {
                    if (this.iclbPayeeAccountPaymentItemType.IsNullOrEmpty())
                    {
                        this.LoadPayeeAccountPaymentItemType();
                    }
                    DateTime ldtNextBenefitPaymentDate = busPayeeAccountHelper.GetLastBenefitPaymentDate().AddMonths(1);
                    if (ldtNextBenefitPaymentDate >= abusBenefitCalculationDetail.icdoBenefitCalculationDetail.reemployed_accrued_benefit_effective_date)
                    {
                        if (!this.iclbPayeeAccountPaymentItemType.IsNullOrEmpty())
                        {
                            iclbPayeeAccountPaymentItemTypeActive = (from item in this.iclbPayeeAccountPaymentItemType
                                                                     where busGlobalFunctions.CheckDateOverlapping(ldtNextBenefitPaymentDate,
                                                                     item.icdoPayeeAccountPaymentItemType.start_date, item.icdoPayeeAccountPaymentItemType.end_date)
                                                                     select item).ToList().ToCollection<busPayeeAccountPaymentItemType>();
                            #region Update Payment Item Types

                            if (abusBenefitCalculationDetail.icdoBenefitCalculationDetail.plan_id != busConstant.IAP_PLAN_ID &&
                                astrBenefitOptionValue != busConstant.LUMP_SUM)
                            {
                                decimal ldecTaxableAmount = decimal.Zero;
                                decimal ldecNonTaxableShouldHaveBeenPaid = decimal.Zero;
                                decimal ldecTaxableShouldHaveBeenPaid = decimal.Zero;
                                if (!iclbPayeeAccountPaymentItemTypeActive.IsNullOrEmpty() && iclbPayeeAccountPaymentItemTypeActive.Count >= 1)
                                {
                                    if (this.icdoPayeeAccount.benefit_account_type_value == busConstant.BENEFIT_TYPE_RETIREMENT)
                                    {
                                        ldecTaxableAmount = abusBenefitCalculationDetail.iclbBenefitCalculationOptions.FirstOrDefault().icdoBenefitCalculationOptions.benefit_amount;
                                    }
                                    else
                                    {
                                        ldecTaxableAmount = abusBenefitCalculationDetail.iclbBenefitCalculationOptions.FirstOrDefault().icdoBenefitCalculationOptions.participant_amount;
                                    }
                                    ldecTaxableShouldHaveBeenPaid = ldecTaxableAmount;
                                    string astrAccountNo = string.Empty;
                                    foreach (busPayeeAccountPaymentItemType lbusPayeeAccountPaymentItemType in this.iclbPayeeAccountPaymentItemType)
                                    {
                                        if (lbusPayeeAccountPaymentItemType.ibusPaymentItemType.icdoPaymentItemType.item_type_direction == 1)
                                        {
                                            if (lbusPayeeAccountPaymentItemType.ibusPaymentItemType.icdoPaymentItemType.item_type_code != busConstant.ITEM1)
                                            {
                                                if (lbusPayeeAccountPaymentItemType.ibusPaymentItemType.icdoPaymentItemType.item_type_code == busConstant.ITEM2)
                                                {
                                                    ldecNonTaxableShouldHaveBeenPaid = lbusPayeeAccountPaymentItemType.icdoPayeeAccountPaymentItemType.amount;
                                                    ldecTaxableShouldHaveBeenPaid -= ldecNonTaxableShouldHaveBeenPaid;
                                                }
                                                ldecTaxableAmount -= lbusPayeeAccountPaymentItemType.icdoPayeeAccountPaymentItemType.amount;
                                            }
                                            else
                                            {
                                                astrAccountNo = lbusPayeeAccountPaymentItemType.icdoPayeeAccountPaymentItemType.account_number;
                                            }
                                        }
                                    }
                                    CreatePayeeAccountPaymentItemType("ITEM1", ldecTaxableAmount, astrAccountNo, 0,
                                                     ldtNextBenefitPaymentDate, DateTime.MinValue, "N", false);

                                    #region AmountAlreadyPaidToTheParticipant
                                    Collection<busBenefitMonthwiseAdjustmentDetail> lclbBenefitMonthwiseAdjustmentDetail = new Collection<busBenefitMonthwiseAdjustmentDetail>();
                                    lclbBenefitMonthwiseAdjustmentDetail = ibusCalculation.GetAmountActuallyPaid(this, abusBenefitCalculationDetail.icdoBenefitCalculationDetail.reemployed_accrued_benefit_effective_date, ldtNextBenefitPaymentDate.AddDays(-1));
                                    #endregion

                                    #region Amount Should Have been Paid
                                    foreach (busBenefitMonthwiseAdjustmentDetail lbusBenefitMonthwiseAdjustmentDetail in lclbBenefitMonthwiseAdjustmentDetail)
                                    {
                                        lbusBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.non_taxable_amount_to_be_paid = ldecNonTaxableShouldHaveBeenPaid;
                                        lbusBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.taxable_amount_to_be_paid = ldecTaxableShouldHaveBeenPaid;
                                    }
                                    ibusCalculation.CreateOverpaymentUnderPayment(this, lclbBenefitMonthwiseAdjustmentDetail, busConstant.RETRO_PAYMENT_REEMPLOYMENT);
                                    #endregion


                                }
                            }

                            else
                            {

                                #region Check If LumpSum Paid Out
                                bool lblnLumpSumPaidOut = false;
                                decimal ldecAmount = decimal.Zero;
                                if (astrBenefitOptionValue == busConstant.LUMP_SUM)
                                {
                                    DataTable ldtTable = Select("cdoPaymentHistoryHeader.GetLumpSumAmountPaidOut", new object[1] { this.icdoPayeeAccount.payee_account_id });
                                    if (ldtTable.Rows.Count > 0)
                                    {
                                        ldecAmount = Convert.ToDecimal(ldtTable.Rows[0][0]);
                                        if (ldecAmount > 0)
                                        {
                                            lblnLumpSumPaidOut = true;
                                        }
                                    }
                                }
                                #endregion


                                //Plug in the logic what has been paid to the participant : Subtract that amount from this amount.
                                decimal ldecTaxableAmount = abusBenefitCalculationDetail.iclbBenefitCalculationOptions.FirstOrDefault().icdoBenefitCalculationOptions.benefit_amount;

                                //If Lump Sum has been paid out that means non taxable amount is zero : all new benefit is taxable.
                                CreatePayeeAccountPaymentItemType("ITEM21", ldecTaxableAmount - ldecAmount, "0", 0, ldtNextBenefitPaymentDate, DateTime.MinValue, "N", false);
                            }
                            #endregion
                        }
                    }
                    //Update the payee Account Item types with new updated amount.
                }
            }
            #endregion

            //this.icdoPayeeAccount.accrued_benefit_to_be_paid_reeval_flag = busConstant.FLAG_NO;
            this.icdoPayeeAccount.Update();

        }

        public bool CheckEligibleForResumeBemefit(DataRow adtPerson, DateTime adtTime, string astrSSN, DateTime adtRetirementDate, decimal adecAge, int aintPlanID, ref DateTime adtLastWorkingDate,
            ref string astrResumptionRule)
        {
            bool lblnResumeBenefits = false;

            DateTime ldtReEmployedAsOfDate = new DateTime();
            if (this.iclbPayeeAccountStatus.IsNullOrEmpty())
                this.LoadPayeeAccountStatuss();
            if (!this.iclbPayeeAccountStatus.IsNullOrEmpty())
            {
                if (this.iclbPayeeAccountStatus.FirstOrDefault().icdoPayeeAccountStatus.status_value == busConstant.PAYEE_ACCOUNT_STATUS_SUSPENDED &&
                    this.iclbPayeeAccountStatus.FirstOrDefault().icdoPayeeAccountStatus.suspension_status_reason_value == busConstant.PAYEE_ACCOUNT_SUSPENSION_REASON_REEMPLOYED_RULE_2 &&
                    adecAge < 65)
                {
                    return false;
                }
            }
            if (!string.IsNullOrEmpty(Convert.ToString(adtPerson[enmPayeeAccount.reemployed_flag_as_of_date.ToString()])))
            {
                ldtReEmployedAsOfDate = Convert.ToDateTime(adtPerson[enmPayeeAccount.reemployed_flag_as_of_date.ToString()]);
            }
            ldtReEmployedAsOfDate = ibusCalculation.GetPayrollDateFromMonth(ldtReEmployedAsOfDate);
            string lstrEmpName = string.Empty;
            Dictionary<int, Dictionary<int, decimal>> ldictYearlyHours = ibusCalculation.LoadMPIHoursAfterRetirementDate(astrSSN, adtRetirementDate, aintPlanID, ref adtLastWorkingDate, ref lstrEmpName);
            if (ldictYearlyHours.Count > 0)
            {
                lblnResumeBenefits = EligibilityRulesForResumeBenefits(ldtReEmployedAsOfDate, adtRetirementDate, ldictYearlyHours, adtTime, ref astrResumptionRule); //PIR 1025
            }
            else
            {
                //SuspendibleHoursChange
                lblnResumeBenefits = true;

                //RID#90258 Reverting back Payroll Month selection.
                DateTime ldtRuleDate = ibusCalculation.GetPayrollDateFromMonth(adtTime).AddMonths(-1);
                //DateTime ldtRuleDate = ibusCalculation.GetPayrollDateFromMonth(adtTime);//Payroll Month Fix - 12052019
                astrResumptionRule = "Resumption Rule 2 - Reported less than " + Convert.ToString(Convert.ToInt32(this.ibusCalculation.GetSuspendibleHoursValue(ldtRuleDate.Year, ldtRuleDate.Month))) + " hours in last payroll month.";
            }

            return lblnResumeBenefits;
        }

        public bool EligibilityRulesForResumeBenefits(DateTime adtReEmployedAsOfDate, DateTime adtRetirementDate, Dictionary<int, Dictionary<int, decimal>> adictYearlyHours, DateTime adtTime,
            ref string astrResumptionRule)
        {
            bool lblnResumeBenefits = false;

            #region rule is for participants who worked during the 1st two months after their retirement date

            if (adtReEmployedAsOfDate < adtRetirementDate.AddMonths(2) && adtReEmployedAsOfDate != DateTime.MinValue)
            {
                //RID#90258 Reverting back Payroll Month selection.
                DateTime ldtLastCompletedpayrollMonth = ibusCalculation.GetPayrollDateFromMonth(adtTime).AddMonths(-1);
                DateTime ldtSecondLastCompletedpayrollMonth = ibusCalculation.GetPayrollDateFromMonth(adtTime).AddMonths(-2);

                //Payroll Month Fix - 12052019
                //DateTime ldtLastCompletedpayrollMonth = ibusCalculation.GetPayrollDateFromMonth(adtTime);
                //DateTime ldtSecondLastCompletedpayrollMonth = ibusCalculation.GetPayrollDateFromMonth(adtTime).AddMonths(-1);

                if (busGlobalFunctions.GetLastPayrollDayOfMonth(ldtLastCompletedpayrollMonth.Year, ldtLastCompletedpayrollMonth.Month) < adtTime)
                {
                    decimal ldecCheckZeroHours = decimal.Zero;
                    if (adictYearlyHours.Keys.Contains(ldtLastCompletedpayrollMonth.Year))
                    {
                        ldecCheckZeroHours += (adictYearlyHours[ldtLastCompletedpayrollMonth.Year])[ldtLastCompletedpayrollMonth.Month];
                    }

                    if (adictYearlyHours.Keys.Contains(ldtSecondLastCompletedpayrollMonth.Year))
                    {
                        ldecCheckZeroHours += (adictYearlyHours[ldtSecondLastCompletedpayrollMonth.Year])[ldtSecondLastCompletedpayrollMonth.Month];
                    }

                    if (ldecCheckZeroHours == decimal.Zero)
                    {
                        lblnResumeBenefits = true;
                        astrResumptionRule = busConstant.RESUMPTION_RULE_1;
                    }
                }
            }

            #endregion

            #region Rest
            else
            {
                decimal ldecHoursAccToRule = decimal.Zero;

                //RID#90258 Reverting back Payroll Month selection.
                DateTime ldtRuleDate = ibusCalculation.GetPayrollDateFromMonth(adtTime).AddMonths(-1);
                //DateTime ldtRuleDate = ibusCalculation.GetPayrollDateFromMonth(adtTime);//Payroll Month Fix - 12052019

                if (adictYearlyHours.Keys.Contains(ldtRuleDate.Year))
                {
                    ldecHoursAccToRule = (adictYearlyHours[ldtRuleDate.Year])[ldtRuleDate.Month];
                    //SuspendibleHoursChange
                    if (ldecHoursAccToRule < this.ibusCalculation.GetSuspendibleHoursValue(ldtRuleDate.Year, ldtRuleDate.Month))
                    {
                        if (!ibusCalculation.CheckIFMonthIsASuspendibleMonth(this.icdoPayeeAccount.person_id, ldtRuleDate.Year, ldtRuleDate.Month.ToString()))
                        {
                            lblnResumeBenefits = true;
                            //SuspendibleHoursChange
                            astrResumptionRule = "Resumption Rule 2 - Reported less than " + Convert.ToString(Convert.ToInt32(this.ibusCalculation.GetSuspendibleHoursValue(ldtRuleDate.Year, ldtRuleDate.Month))) + " hours in last payroll month.";
                        }
                    }
                }
                else
                {
                    if (!ibusCalculation.CheckIFMonthIsASuspendibleMonth(this.icdoPayeeAccount.person_id, ldtRuleDate.Year, ldtRuleDate.Month.ToString()))
                    {
                        lblnResumeBenefits = true;
                        astrResumptionRule = busConstant.RESUMPTION_RULE_4;
                    }
                }
            }
            #endregion

            return lblnResumeBenefits;
        }

        public bool ResumeBenefits(DataRow adtPerson, DateTime adtResumeBenefitDate, ref string astrResumptionRule)
        {
            string lstrSSN = Convert.ToString(adtPerson[enmPerson.ssn.ToString()]);
            bool lblnEligibleForResumeBenefits = false;

            DateTime ldtRetirementDate = Convert.ToDateTime(adtPerson[enmBenefitApplication.retirement_date.ToString()]);
            if (!string.IsNullOrEmpty(Convert.ToString(adtPerson[enmPerson.date_of_birth.ToString()])))
            {
                DateTime ldtDOB = Convert.ToDateTime(adtPerson[enmPerson.date_of_birth.ToString()]);
                DateTime ldtMinimumDistributionDate, ldtLastWorkingDate = new DateTime();
                decimal ldecAge = busGlobalFunctions.CalculatePersonAge(ldtDOB, adtResumeBenefitDate);
                int lintPlanID = Convert.ToInt32(adtPerson[enmPlanBenefitXr.plan_id.ToString()]);

                lblnEligibleForResumeBenefits = CheckEligibleForResumeBemefit(adtPerson, adtResumeBenefitDate, lstrSSN, ldtRetirementDate, ldecAge, lintPlanID, ref ldtLastWorkingDate, ref astrResumptionRule);

                // ldtMinimumDistributionDate = new DateTime(ldtDOB.AddYears(70).AddMonths(6).AddYears(1).Year, 04, 01);
                //RMD72Project
                int lintPersonId = Convert.ToInt32(adtPerson["PERSON_ID"]);
                DateTime ldtVestedDate = busGlobalFunctions.GetVestedDate(lintPersonId, lintPlanID);

                // RID# 153935 As per teresa, even if participant has differed RMD batch should use 70.5 RMD date to check for suspension.
                ldtMinimumDistributionDate = busGlobalFunctions.GetMinDistributionDate(ldtDOB, ldtVestedDate); //calculate MD date based on age 70.5

                //ldtMinimumDistributionDate = busGlobalFunctions.GetMinDistributionDate(lintPersonId, ldtVestedDate);  //calculate MD Date based on participant MD age option
                //DateTime ldt72MinDate = busGlobalFunctions.Get72MinDistributionDate(ldtDOB, ldtVestedDate); //calculate MD date based on age 70.5

                ////If participant had age 72 option but retireed before 72MD date, business asked to use 70.5 instead of if participant age 72 MD date.
                //if (ldtMinimumDistributionDate == ldt72MinDate && ldtRetirementDate < ldtMinimumDistributionDate)
                //{
                //    ldtMinimumDistributionDate = busGlobalFunctions.GetMinDistributionDate(ldtDOB, ldtVestedDate); //calculate MD date based on age 70.5
                //}





                #region Min Distribution only for the first time

                if (!lblnEligibleForResumeBenefits)
                {
                    if (ldtMinimumDistributionDate.Year == adtResumeBenefitDate.Year)
                    {
                        this.LoadNextBenefitPaymentDate();
                        if (ldtMinimumDistributionDate <= this.idtNextBenefitPaymentDate)
                        {
                            lblnEligibleForResumeBenefits = true;
                            astrResumptionRule = busConstant.RESUMPTION_RULE_3;
                        }
                    }
                }

                #endregion


                if (lblnEligibleForResumeBenefits)
                {
                    //PIR 1025                                       
                    cdoReemploymentHistory lcdoLatestReemploymentHistory = new cdoReemploymentHistory();
                    LoadReemploymentHistorys();
                    if (this.iclcReemploymentHistory != null && this.iclcReemploymentHistory.Count() > 0 &&
                        this.iclcReemploymentHistory.Where(item => item.resume_benefit_date == DateTime.MinValue).Count() > 0)
                    {
                        lcdoLatestReemploymentHistory = this.iclcReemploymentHistory.Where(item => item.resume_benefit_date == DateTime.MinValue).FirstOrDefault();
                        lcdoLatestReemploymentHistory.reemployed_flag_to_date = ldtLastWorkingDate;
                        lcdoLatestReemploymentHistory.Update();
                    }
                }
            }
            return lblnEligibleForResumeBenefits;
        }

        public busBenefitCalculationRetirement GetFinalCalculationForReEmployedParticipants(DataTable adtReemployedHours, busBenefitCalculationRetirement abusBenefitCalculationRetirement, string astrBenefitOptionValue, bool ablnPostRetDeath, bool ablnReemploymentFromRevalBatch, DateTime? adtBenefitEffectiveDate = null)
        {
            DateTime ldtBenefitAsOfDate = new DateTime();
            DateTime ldtBenefitEffectiveDate = new DateTime();
            DateTime adtResumeBenefitDate = new DateTime();
            DateTime adtRetirementDate = new DateTime();
            DateTime ldtDOB = new DateTime();
            decimal ldecAge = 0M;
            string astrSSN = string.Empty;

            adtResumeBenefitDate = DateTime.Now;
            ldtDOB = Convert.ToDateTime(ibusPayee.icdoPerson.date_of_birth);
            ldecAge = busGlobalFunctions.CalculatePersonAge(ldtDOB, adtResumeBenefitDate);
            adtRetirementDate = icdoPayeeAccount.idtRetireMentDate;
            astrSSN = ibusPayee.icdoPerson.ssn;
            ldtBenefitAsOfDate = busGlobalFunctions.GetLastDateOfComputationYear(adtResumeBenefitDate.AddYears(-1).Year);

            busBenefitCalculationRetirement lbusBenefitCalculationRetirement = abusBenefitCalculationRetirement;



            ldtBenefitAsOfDate = busGlobalFunctions.GetLastDateOfComputationYear(adtResumeBenefitDate.AddYears(-1).Year);
            if (adtBenefitEffectiveDate.IsNull())
            {
                ldtBenefitEffectiveDate = adtResumeBenefitDate;
            }
            else
            {
                ldtBenefitEffectiveDate = Convert.ToDateTime(adtBenefitEffectiveDate);
            }
            DataTable ldtReEvaluationTable = adtReemployedHours;
            if (ldtReEvaluationTable.IsNull() && this.icdoPayeeAccount.iintPlanId != busConstant.IAP_PLAN_ID)
            {
                ldtReEvaluationTable = ibusCalculation.LoadHoursBetweenTwoDates(astrSSN, adtRetirementDate, ldtBenefitAsOfDate, busConstant.MPIPP);
            }
            if ((ldtReEvaluationTable.IsNotNull() && ldtReEvaluationTable.Rows.Count > 0) || this.icdoPayeeAccount.iintPlanId == busConstant.IAP_PLAN_ID)
            {
                DataTable ldtPayeeAccountDetails = busBase.Select("cdoPayeeAccount.GetReEmployedParticipantInfo", new object[1] { this.icdoPayeeAccount.payee_account_id });
                if (ldtPayeeAccountDetails.Rows.Count > 0)
                {
                    if (this.icdoPayeeAccount.benefit_account_type_value == busConstant.BENEFIT_TYPE_RETIREMENT)
                    {
                        this.AddReemployedYearsToExistingCalculation(ldtReEvaluationTable, ldtPayeeAccountDetails.Rows[0], adtResumeBenefitDate, lbusBenefitCalculationRetirement, true, astrBenefitOptionValue, ldtBenefitEffectiveDate, ablnPostRetDeath, ablnReemploymentFromRevalBatch);
                    }

                }
            }
            return lbusBenefitCalculationRetirement;
        }

        public void UpdatePaymentItemsFromResumeBenefits(Dictionary<int, Dictionary<int, decimal>> adictHoursAfterRetirement, DataRow adtPerson, Collection<busBenefitMonthwiseAdjustmentDetail> aclbBenefitMonthwiseAdjustmentDetail, decimal adecNonTaxableBeginingBalance,
            decimal adecNonTaxableOffset, decimal adecTaxableOffset, bool ablnEEDerived, bool ablnCalculateOverorUnder = false)
        {
            string lstrBenefitOptionValue = Convert.ToString(adtPerson[enmPlanBenefitXr.benefit_option_value.ToString()]);
            string lstrBenefitType = Convert.ToString(adtPerson[enmBenefitApplication.benefit_type_value.ToString()]);
            int lintPlanID = Convert.ToInt32(adtPerson[enmPlanBenefitXr.plan_id.ToString()]);
            decimal ldecMEAAmount = decimal.Zero;
            decimal ldecTaxableAmount = decimal.Zero;
            decimal ldecMonthlyTaxableBenefit = decimal.Zero;
            decimal ldecBenefitAmount = decimal.Zero;

            if (lintPlanID != busConstant.IAP_PLAN_ID)
            {
                ldecTaxableAmount = this.icdoPayeeAccount.ee_derived_benefit_amount;

                if (!string.IsNullOrEmpty(Convert.ToString(adtPerson[enmBenefitCalculationDetail.monthly_exclusion_amount.ToString()])))
                {
                    ldecMEAAmount = Convert.ToDecimal(adtPerson[enmBenefitCalculationDetail.monthly_exclusion_amount.ToString()]);
                    if (ldecMEAAmount > 0)
                    {
                        ldecMEAAmount = ldecMEAAmount - adecNonTaxableOffset;
                    }
                }
                if (!string.IsNullOrEmpty(Convert.ToString(adtPerson[enmBenefitCalculationDetail.ee_derived_benefit_amount.ToString()])))
                {
                    ldecTaxableAmount = Convert.ToDecimal(adtPerson[enmBenefitCalculationDetail.ee_derived_benefit_amount.ToString()]);
                }

                if (!string.IsNullOrEmpty(Convert.ToString(adtPerson[enmBenefitCalculationOptions.overridden_benefit_amount.ToString()])))
                {
                    ldecBenefitAmount = Convert.ToDecimal(adtPerson[enmBenefitCalculationOptions.overridden_benefit_amount.ToString()]);
                }
                if (ldecBenefitAmount == decimal.Zero)
                {
                    if (lstrBenefitType == busConstant.BENEFIT_TYPE_DISABILITY)
                    {
                        if (adtPerson[enmBenefitCalculationOptions.participant_amount.ToString()].IsNotNull())
                        {
                            ldecBenefitAmount = Convert.ToDecimal(adtPerson[enmBenefitCalculationOptions.participant_amount.ToString()]);
                        }
                    }
                    else if (lstrBenefitType == busConstant.BENEFIT_TYPE_RETIREMENT)
                    {
                        if (adtPerson[enmBenefitCalculationOptions.benefit_amount.ToString()].IsNotNull())
                        {
                            ldecBenefitAmount = Convert.ToDecimal(adtPerson[enmBenefitCalculationOptions.benefit_amount.ToString()]);
                        }
                    }
                }
            }
            else
            {
                if (adtPerson[enmBenefitCalculationDetail.iap_balance_amount.ToString()].IsNotNull() && !string.IsNullOrEmpty(Convert.ToString(adtPerson[enmBenefitCalculationDetail.iap_balance_amount.ToString()].IsNotNull())))
                {
                    ldecBenefitAmount = Convert.ToDecimal(adtPerson[enmBenefitCalculationDetail.iap_balance_amount.ToString()].IsNotNull());
                }
            }
            if (ldecBenefitAmount > 0)
            {
                ldecBenefitAmount = ldecBenefitAmount - adecTaxableOffset - adecNonTaxableOffset;
                UpdatePaymentItemTypeWithNewAmount(this, ldecMEAAmount, ldecBenefitAmount, adecNonTaxableBeginingBalance, lstrBenefitOptionValue, DateTime.Now, lintPlanID, ref ldecMonthlyTaxableBenefit);
                if (ablnCalculateOverorUnder)
                {
                    CreateOverPaymentForReEmploymemt(adictHoursAfterRetirement, aclbBenefitMonthwiseAdjustmentDetail, ablnEEDerived, ldecMEAAmount, ldecTaxableAmount, ldecBenefitAmount);
                }
                if (this.idtNextBenefitPaymentDate == DateTime.MinValue)
                    this.LoadNextBenefitPaymentDate();

            }
        }

        public void OverrideReEmployment()
        {
            if (this.icdoPayeeAccount.reemployed_flag == busConstant.FLAG_YES && this.icdoPayeeAccount.reemployment_override_flag == busConstant.FLAG_YES)
            {
                this.icdoPayeeAccount.reemployed_flag = busConstant.FLAG_NO;
            }
        }

        /// <summary>
        /// Dates : Reemployment As Of Date , Dro Commencement Date, Batch Date.
        /// adecMea : Reflects the Offset from  AP
        /// </summary>
        public void CreateOverPaymentForReEmploymemt(Dictionary<int, Dictionary<int, decimal>> adictHoursAfterRetirement, Collection<busBenefitMonthwiseAdjustmentDetail> aclbBenefitMonthwiseAdjustmentDetail, bool ablnEEDerivedBenefit, decimal adecMea, decimal adecTaxableAmount, decimal adecMonthlyTaxableAmount)
        {
            if (this.icdoPayeeAccount.reemployed_flag_as_of_date != DateTime.MinValue)
            {

                #region Prop
                bool lblnReempoyedDueToNonSignatoryMonths = false;
                decimal ldecBenefitAmountFromYearlyDetail = decimal.Zero;
                decimal ldecTaxableAmountShouldHaveBeenPaid = decimal.Zero;
                decimal ldecNonTaxableAmountShouldHaveBeenPaid = decimal.Zero;
                DateTime ldtFromDate = ibusCalculation.GetPayrollDateFromMonth(this.icdoPayeeAccount.reemployed_flag_as_of_date);
                DateTime ldtToDate = ibusCalculation.GetPayrollDateFromMonth(DateTime.Now);
                int lintDiffMonths = busGlobalFunctions.GetMonthsBetweenTwoDates(ldtFromDate, ldtToDate);
                busBenefitCalculationDetail lbusBenefitCalculationDetail = new busBenefitCalculationDetail { icdoBenefitCalculationDetail = new cdoBenefitCalculationDetail() };
                busBenefitCalculationHeader lbusBenefitCalculationHeader = new busBenefitCalculationHeader { icdoBenefitCalculationHeader = new cdoBenefitCalculationHeader() };
                if (this.icdoPayeeAccount.benefit_calculation_detail_id > 0)
                {
                    lbusBenefitCalculationDetail.FindBenefitCalculationDetail(this.icdoPayeeAccount.benefit_calculation_detail_id);
                    lbusBenefitCalculationHeader.FindBenefitCalculationHeader(lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.benefit_calculation_header_id);
                    if (ablnEEDerivedBenefit && adecTaxableAmount == decimal.Zero)
                    {
                        if (lbusBenefitCalculationDetail.iclbBenefitCalculationOptions.IsNullOrEmpty())
                        {
                            lbusBenefitCalculationDetail.LoadBenefitCalculationOptionss();
                        }
                        decimal ldecERF = 1;
                        decimal ldecBenefitOptionFactor = decimal.Zero;
                        if (!lbusBenefitCalculationDetail.iclbBenefitCalculationOptions.IsNullOrEmpty())
                        {
                            ldecBenefitOptionFactor = lbusBenefitCalculationDetail.iclbBenefitCalculationOptions.FirstOrDefault().icdoBenefitCalculationOptions.benefit_option_factor;
                            if (lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.benefit_subtype_value == busConstant.RETIREMENT_TYPE_REDUCED_EARLY ||
                                lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.benefit_subtype_value == busConstant.RETIREMENT_TYPE_SPL_REDUCED_EARLY)
                            {
                                ldecERF = lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.early_reduction_factor;
                            }
                            adecTaxableAmount = Math.Round(Math.Round(lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.ee_derived_benefit_amount * ldecERF, 2) * ldecBenefitOptionFactor, 2);
                            this.icdoPayeeAccount.ee_derived_benefit_amount = adecTaxableAmount;
                        }

                    }
                }
                #endregion

                this.ibusParticipant.LoadPersonSuspendibleMonth();
                if (this.iclcReemploymentHistory.Where(item => item.reemployed_flag_to_date == DateTime.MinValue).Count() == 0)
                {
                    //No Reemployment History exists Participant so got reemployed on the click of the button.
                    lblnReempoyedDueToNonSignatoryMonths = true;
                }
                aclbBenefitMonthwiseAdjustmentDetail = aclbBenefitMonthwiseAdjustmentDetail.OrderByDescending(item => item.icdoBenefitMonthwiseAdjustmentDetail.payment_date).ToList().ToCollection();
                if (this.icdoPayeeAccount.benefit_calculation_detail_id > 0)
                {
                    ibusCalculation.FillYearlyDetailSetBenefitAmountForEachYear(lbusBenefitCalculationHeader, lbusBenefitCalculationDetail);
                }
                DateTime ldtParticipantTurns65 = this.ibusPayee.icdoPerson.date_of_birth.AddYears(65);
                if (ldtParticipantTurns65.Day != 1)
                {
                    ldtParticipantTurns65 = ldtParticipantTurns65.GetLastDayofMonth().AddDays(1);
                }
                bool lblnGetAmountForReemployment = false;
                foreach (busBenefitMonthwiseAdjustmentDetail lbusBenefitMonthwiseAdjustmentDetail in aclbBenefitMonthwiseAdjustmentDetail)
                {
                    lblnGetAmountForReemployment = false;
                    ldecTaxableAmountShouldHaveBeenPaid = decimal.Zero;
                    ldecNonTaxableAmountShouldHaveBeenPaid = decimal.Zero;
                    lblnGetAmountForReemployment = false;
                    if (lbusBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.payment_date >= ldtParticipantTurns65)
                    {
                        lblnGetAmountForReemployment = true;
                    }
                    if (ibusCalculation.CheckIfMonthIsSuspendible(adictHoursAfterRetirement, this.ibusParticipant.iclbPersonSuspendibleMonth, lbusBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.payment_date))
                    {
                        lbusBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.suspended_flag = busConstant.FLAG_YES;
                        if (adictHoursAfterRetirement.Keys.Contains(lbusBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.payment_date.Year))
                        {
                            lbusBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.hours = adictHoursAfterRetirement[lbusBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.payment_date.Year][lbusBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.payment_date.Month];
                        }
                        if (ablnEEDerivedBenefit)
                        {
                            if (adecTaxableAmount > 0)
                            {
                                ldecNonTaxableAmountShouldHaveBeenPaid = adecMea;
                                ldecTaxableAmountShouldHaveBeenPaid = adecTaxableAmount - adecMea - lbusBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.idecAlternatePayeeMonthlyTaxableOffset;
                            }
                        }
                        else
                        {

                            if (lblnReempoyedDueToNonSignatoryMonths)
                            {
                                if (!this.ibusParticipant.iclbPersonSuspendibleMonth.IsNullOrEmpty() && this.ibusParticipant.iclbPersonSuspendibleMonth.Where(item =>
                                    item.icdoPersonSuspendibleMonth.plan_year == lbusBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.payment_date.Year && item.icdoPersonSuspendibleMonth.suspendible_month_value.Trim() == Convert.ToString(lbusBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.payment_date.Month)).Count() > 0)
                                {
                                    ldecNonTaxableAmountShouldHaveBeenPaid = adecMea;
                                    ldecTaxableAmountShouldHaveBeenPaid = adecTaxableAmount - adecMea - lbusBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.idecAlternatePayeeMonthlyTaxableOffset;
                                }
                            }
                        }

                    }
                    else
                    {
                        if (adictHoursAfterRetirement.Keys.Contains(lbusBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.payment_date.Year))
                        {
                            lbusBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.hours = adictHoursAfterRetirement[lbusBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.payment_date.Year][lbusBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.payment_date.Month];
                        }
                        if (this.icdoPayeeAccount.benefit_calculation_detail_id > 0)
                        {
                            ldecBenefitAmountFromYearlyDetail = ibusCalculation.GetBenefitAmountOfParticipantFromYearlyDetail(lbusBenefitCalculationHeader, lbusBenefitCalculationDetail, lbusBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.payment_date.Year, ablnGetAmountForReemployment: lblnGetAmountForReemployment);
                            if (ldecBenefitAmountFromYearlyDetail > 0)
                            {
                                adecMonthlyTaxableAmount = ldecBenefitAmountFromYearlyDetail;
                            }
                            ldecNonTaxableAmountShouldHaveBeenPaid = adecMea;
                            ldecTaxableAmountShouldHaveBeenPaid = adecMonthlyTaxableAmount - ldecNonTaxableAmountShouldHaveBeenPaid - lbusBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.idecAlternatePayeeMonthlyTaxableOffset -
                                                            lbusBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.idecAlternatePayeeMonthlyNonTaxableOffset;
                        }
                        else
                        {
                            ldecNonTaxableAmountShouldHaveBeenPaid = adecMea;
                            ldecTaxableAmountShouldHaveBeenPaid = adecMonthlyTaxableAmount - ldecNonTaxableAmountShouldHaveBeenPaid - lbusBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.idecAlternatePayeeMonthlyTaxableOffset;
                        }
                    }
                    lbusBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.non_taxable_amount_to_be_paid = ldecNonTaxableAmountShouldHaveBeenPaid;
                    lbusBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.taxable_amount_to_be_paid = ldecTaxableAmountShouldHaveBeenPaid;

                }
                ibusCalculation.CreateOverpaymentUnderPayment(this, aclbBenefitMonthwiseAdjustmentDetail, busConstant.RETRO_PAYMENT_REEMPLOYMENT);
            }
        }


        public void LoadOverPaymentObject(busPaymentHistoryHeader lbusPaymentHistoryHeader)
        {
            lbusPaymentHistoryHeader.LoadPaymentHistoryDetails();
            decimal ldecTaxableAmt = decimal.Zero;
            decimal ldecNonTaxableAmt = decimal.Zero;
            if (lbusPaymentHistoryHeader.iclbPaymentHistoryDetail.IsNullOrEmpty())
            {
                foreach (busPaymentHistoryDetail lbusPaymentHistoryDetail in lbusPaymentHistoryHeader.iclbPaymentHistoryDetail)
                {
                    busPaymentItemType lbusPaymentItemType = new busPaymentItemType();
                    lbusPaymentItemType.FindPaymentItemType(lbusPaymentHistoryDetail.icdoPaymentHistoryDetail.payment_item_type_id);

                    if (lbusPaymentItemType.icdoPaymentItemType.item_type_direction == 1 &&
                        lbusPaymentItemType.icdoPaymentItemType.receivable_creation_1099r_value == busConstant.RECEIVABLE_CREATION_WITH_OR_WITHOUT_1099R)
                    {
                        if (lbusPaymentItemType.icdoPaymentItemType.taxable_item_flag == busConstant.FLAG_YES)
                            ldecTaxableAmt = ldecTaxableAmt + lbusPaymentHistoryDetail.icdoPaymentHistoryDetail.amount;
                        else
                            ldecNonTaxableAmt = ldecNonTaxableAmt + lbusPaymentHistoryDetail.icdoPaymentHistoryDetail.amount;
                    }
                }

                busPayeeAccountRetroPayment lbusPayeeAccountRetroPayment = new busPayeeAccountRetroPayment();
                int lintPayeeAccRetroPaymentId = lbusPayeeAccountRetroPayment.CreatePayeeAccountRetroPayment(lbusPaymentHistoryHeader.icdoPaymentHistoryHeader.payee_account_id, busConstant.RETRO_PAYMENT_BENEFIT_OVERPAYMENT,
                                              DateTime.MinValue, DateTime.MinValue, DateTime.MinValue, DateTime.MinValue,
                                              null, ldecTaxableAmt + ldecNonTaxableAmt, 0, null, null, busConstant.FLAG_YES);

                foreach (busPaymentHistoryDetail lbusPaymentHistoryDetail in lbusPaymentHistoryHeader.iclbPaymentHistoryDetail)
                {
                    busPayeeAccountRetroPaymentDetail lbusPayeeAccountRetroPaymentDetail = new busPayeeAccountRetroPaymentDetail();
                    lbusPayeeAccountRetroPaymentDetail.CreatePayeeAccountRetroPaymentDetail(lintPayeeAccRetroPaymentId, lbusPaymentHistoryDetail);
                }

                //insert data in SGT_BENEFIT_MONTHWISE_ADJUSTMENT_DETAIL
                busBenefitMonthwiseAdjustmentDetail lbusBenefitMonthwiseAdjustmentDetail = new busBenefitMonthwiseAdjustmentDetail();
                lbusBenefitMonthwiseAdjustmentDetail.CreateMonthwiseAdjustmentDetail(lintPayeeAccRetroPaymentId, lbusPaymentHistoryHeader.icdoPaymentHistoryHeader.payment_date, 0, 0,
                                    ldecTaxableAmt, ldecNonTaxableAmt, 0, null, lbusPaymentHistoryHeader.icdoPaymentHistoryHeader.payment_history_header_id);
            }


        }

        public void LoadRetroActiveObject(DataTable adtPaymentHistory)
        {
            busPayeeAccountRetroPayment lbusPayeeAccountRetroPayment = new busPayeeAccountRetroPayment { icdoPayeeAccountRetroPayment = new cdoPayeeAccountRetroPayment() };
            lbusPayeeAccountRetroPayment.iclbBenefitMonthwiseAdjustmentDetail = new Collection<busBenefitMonthwiseAdjustmentDetail>();

            busBenefitMonthwiseAdjustmentDetail lbusBenefitMonthwiseAdjustmentDetail;
            decimal ldecMonthlyTaxableAmountPaid = decimal.Zero;
            decimal ldecMonthlyNonTaxableAmountPaid = decimal.Zero;
            DateTime ldtPaymentDate = new DateTime();
            decimal ldecTaxableAmtToBePaid = decimal.Zero;
            decimal ldecNonTaxableAmtToBePaid = decimal.Zero;
            decimal ldecHours = decimal.Zero;
            string astrSuspendedFlag = string.Empty;
            int lintPaymentHistoryHeaderId = 0;


            foreach (DataRow ldtRow in adtPaymentHistory.Rows)
            {
                if (!string.IsNullOrEmpty(Convert.ToString(ldtRow["Non_Taxable_Amount"])))
                {
                    ldecMonthlyNonTaxableAmountPaid = Convert.ToDecimal(ldtRow["Non_Taxable_Amount"]);
                }
                if (!string.IsNullOrEmpty(Convert.ToString(ldtRow["Taxable_Amount"])))
                {
                    ldecMonthlyTaxableAmountPaid = Convert.ToDecimal(ldtRow["Taxable_Amount"]);
                }
                if (!string.IsNullOrEmpty(Convert.ToString(ldtRow["PAYMENT_DATE"])))
                {
                    ldtPaymentDate = Convert.ToDateTime(ldtRow["PAYMENT_DATE"]);
                }
                if (!string.IsNullOrEmpty(Convert.ToString(ldtRow["PAYMENT_HISTORY_HEADER_ID"])))
                {
                    lintPaymentHistoryHeaderId = Convert.ToInt32(ldtRow["PAYMENT_HISTORY_HEADER_ID"]);
                }

                lbusBenefitMonthwiseAdjustmentDetail = new busBenefitMonthwiseAdjustmentDetail { icdoBenefitMonthwiseAdjustmentDetail = new cdoBenefitMonthwiseAdjustmentDetail() };
                lbusBenefitMonthwiseAdjustmentDetail = lbusBenefitMonthwiseAdjustmentDetail.FillMonthWiseAdjustmentDetail(ldtPaymentDate, ldecTaxableAmtToBePaid, ldecNonTaxableAmtToBePaid, ldecMonthlyTaxableAmountPaid, ldecMonthlyNonTaxableAmountPaid, decimal.Zero, null, lintPaymentHistoryHeaderId);

            }
        }

        public bool GetReEmploymentRule(DataRow adtPerson)
        {
            bool lblnPayEEDerived = false;
            string lstrRuleCorrespondence = string.Empty;

            #region Load Hours
            int lintBenefitAppID;
            int lintBenefitCalculationHeaderId;
            int lintPersonAccountID;

            string lstrSSN = string.Empty;
            DateTime ldtRetirementDate = new DateTime();
            DateTime ldtDOB = new DateTime();
            DateTime ldtDisabilityCertificationDate = new DateTime();
            //DataTime lstSSAApplicationDate = new DataTime
            decimal ldecAge = decimal.Zero;
            decimal ldecAgeIndec = decimal.Zero;
            string lstrBenefitTypeValue = string.Empty;
            string lstrBenefitSubTypeValue = string.Empty;
            string lstrBenefitOptionValue = string.Empty;

            string lstrDisabilityConversionFlag = busConstant.FLAG_NO;
            bool lblnMarkReemployed = false;
            int lintPlanID = this.icdoPayeeAccount.iintPlanId;
            //busPayeeAccountStatus lbusPayeeAccountStatus;


            //lbusPayeeAccount = new busPayeeAccount { icdoPayeeAccount = new cdoPayeeAccount() };
            //lbusPayeeAccount.icdoPayeeAccount.LoadData(adtPerson);
            DateTime ldt1986Date = new DateTime(1986, 08, 01);

            lstrSSN = Convert.ToString(adtPerson[enmPerson.ssn.ToString()]);

            ldtRetirementDate = Convert.ToDateTime(adtPerson[enmBenefitApplication.retirement_date.ToString()]);
            ldtDOB = Convert.ToDateTime(adtPerson[enmPerson.date_of_birth.ToString()]);
            lstrBenefitTypeValue = Convert.ToString(adtPerson[enmBenefitApplication.benefit_type_value.ToString()]);
            lstrBenefitSubTypeValue = Convert.ToString(adtPerson[enmBenefitApplicationDetail.benefit_subtype_value.ToString()]);
            lstrDisabilityConversionFlag = Convert.ToString(adtPerson[enmPayeeAccount.disability_conversion_flag.ToString()]);
            lintBenefitAppID = Convert.ToInt32(adtPerson[enmBenefitApplication.benefit_application_id.ToString()]);
            lintBenefitCalculationHeaderId = Convert.ToInt32(adtPerson[enmBenefitCalculationHeader.benefit_calculation_header_id.ToString()]);
            lintPersonAccountID = Convert.ToInt32(adtPerson[enmPersonAccount.person_account_id.ToString()]);
            ldtDisabilityCertificationDate = this.icdoPayeeAccount.benefit_begin_date;
            ldecAge = busGlobalFunctions.CalculatePersonAge(ldtDOB, DateTime.Now);
            ldecAgeIndec = busGlobalFunctions.CalculatePersonAgeInDec(ldtDOB, ldtRetirementDate);

            lstrBenefitOptionValue = Convert.ToString(adtPerson[enmPlanBenefitXr.benefit_option_value.ToString()]);

            //ldecEEDerivedBenefit = Convert.ToDecimal(adtPerson[enmBenefitCalculationDetail.ee

            utlConnection utlLegacyDBConnetion = HelperFunction.GetDBConnectionProperties("Legacy");
            string lstrLegacyDBConnetion = utlLegacyDBConnetion.istrConnectionString;

            SqlParameter[] lsqlParameters = new SqlParameter[2];
            SqlParameter param1 = new SqlParameter("@SSN", DbType.String);
            SqlParameter param2 = new SqlParameter("@RETIREMENT_DATE", DbType.DateTime);

            param1.Value = lstrSSN;
            lsqlParameters[0] = param1;

            param2.Value = ldtRetirementDate;
            lsqlParameters[1] = param2;

            DataTable ldtGetHoursAfterRetirementDate = busGlobalFunctions.ExecuteSPtoGetDataTable("usp_GetWorkDataAfterRetirement", lstrLegacyDBConnetion, null, lsqlParameters);
            Hashtable lhstYearlyHours = new Hashtable();
            if (ldtGetHoursAfterRetirementDate.Rows.Count > 0)
            {
                var distinctRows = (from DataRow dRow in ldtGetHoursAfterRetirementDate.Rows
                                    select new { col1 = dRow["ComputationYear"] }).Distinct();
                foreach (var ldtRow in distinctRows)
                {
                    int lintCompYear = Convert.ToInt32(ldtRow.col1.ToString());

                    Hashtable lhstMonthlyHours = new Hashtable();
                    for (int i = 12; i >= 1; i--)
                    {
                        lhstMonthlyHours.Add(i, busConstant.ZERO_DECIMAL);
                    }

                    foreach (DataRow ldrWeeklyHours in ldtGetHoursAfterRetirementDate.Rows)
                    {
                        if (Convert.ToInt32(ldrWeeklyHours["ComputationYear"].ToString()) == lintCompYear)
                        {
                            DateTime ldtFromDate = Convert.ToDateTime(ldrWeeklyHours["FromDate"]);
                            decimal ldecHours = 1M;
                            int lintPayrollMonth = 1;

                            if (Convert.ToInt32(ldrWeeklyHours["Weeks"]) > 0)
                            {
                                ldecHours = Convert.ToDecimal(ldrWeeklyHours["PensionHours"]) / Convert.ToInt32(ldrWeeklyHours["Weeks"]);
                            }
                            else
                            {
                                ldecHours = Convert.ToDecimal(ldrWeeklyHours["PensionHours"]);
                            }

                            while (ldtFromDate <= Convert.ToDateTime(ldrWeeklyHours["ToDate"]))
                            {
                                lintPayrollMonth = busGlobalFunctions.GetPayrollMonth(ldtFromDate);
                                lhstMonthlyHours[lintPayrollMonth] = (decimal)lhstMonthlyHours[lintPayrollMonth] + ldecHours;
                                ldtFromDate = ldtFromDate.AddDays(7);
                            }
                        }
                    }

                    lhstYearlyHours.Add(lintCompYear, lhstMonthlyHours);

                }
                #endregion

                decimal ldecHoursAccToRule = decimal.Zero;
                DateTime ldtRuleDate = new DateTime();
                #region Rule 1 : If 1 or more hours were reported for a Retired participant prior to the end of 2nd consecutive payroll month
                if (!lblnMarkReemployed && this.icdoPayeeAccount.reemployed_flag != busConstant.FLAG_YES)
                {
                    ldtRuleDate = ldtRetirementDate.AddMonths(1);
                    ldecHoursAccToRule = (decimal)(lhstYearlyHours[ldtRuleDate.Year] as Hashtable)[ldtRuleDate.Month] + (decimal)(lhstYearlyHours[ldtRetirementDate.Year] as Hashtable)[ldtRetirementDate.Month];
                    if (ldecHoursAccToRule > 1)
                    {
                        lstrRuleCorrespondence = busConstant.REEMPLOYMENT_RULE_1;
                        lblnMarkReemployed = true;
                        //lbusPayeeAccountStatus = new busPayeeAccountStatus { icdoPayeeAccountStatus = new cdoPayeeAccountStatus() };
                        //lbusPayeeAccountStatus.InsertValuesInPayeeAccountStatus(this.icdoPayeeAccount.payee_account_id, busConstant.PAYEE_ACCOUNT_STATUS_SUSPENDED, DateTime.Now, busConstant.PAYEE_ACCOUNT_SUSPENSION_REASON_REEMPLOYED);
                        LoadNextBenefitPaymentDate(); // for getting nextBenefitPaymentDate for corr Payee-0003 REEMPLOYMENT_WITHIN_TWO_MONTHS_OF_RETIREMENT

                    }
                }

                #endregion

                #region Rule 2
                if (!lblnMarkReemployed)
                {
                    ldecHoursAccToRule = decimal.Zero;
                    ldtRuleDate = DateTime.Now;

                    if (ldecAge < 65 && lstrBenefitSubTypeValue == busConstant.RETIREMENT_TYPE_UNREDUCED_EARLY)
                    {
                        foreach (DictionaryEntry lhstMonth in (lhstYearlyHours[ldtRuleDate.Year] as Hashtable))
                        {
                            ldecHoursAccToRule += Convert.ToDecimal(lhstMonth.Value);
                        }
                        if (ldecHoursAccToRule > 400)
                        {
                            lblnMarkReemployed = true;
                        }

                    }
                }
                #endregion

                #region Rule3
                if (!lblnMarkReemployed && this.icdoPayeeAccount.reemployed_flag != busConstant.FLAG_YES)
                {
                    ldecHoursAccToRule = decimal.Zero;
                    ldtRuleDate = DateTime.MinValue;

                    ldtRuleDate = ldtRetirementDate.AddMonths(2);
                    foreach (DictionaryEntry ldict in lhstYearlyHours)
                    {
                        if (Convert.ToInt32(ldict.Key) >= ldtRuleDate.Year)
                        {
                            Hashtable lhstMonths = (Hashtable)lhstYearlyHours[ldtRuleDate.Year];
                            foreach (DictionaryEntry ldictMonths in lhstMonths)
                            {
                                if ((Convert.ToInt32(ldictMonths.Key) >= ldtRuleDate.Month && Convert.ToInt32(ldict.Key) == ldtRuleDate.Year) ||
                                    (Convert.ToInt32(ldict.Key) > ldtRuleDate.Year))
                                {
                                    ldecHoursAccToRule += Convert.ToDecimal(ldictMonths.Value);
                                }
                            }
                        }
                    }
                    //SuspendibleHoursChange
                    //ldecHoursAccToRule = (decimal)(lhstYearlyHours[ldtRuleDate.Year] as Hashtable)[ldtRuleDate.Month];
                    if (ldecHoursAccToRule > this.ibusCalculation.GetSuspendibleHoursValue(ldtRuleDate.Year, ldtRuleDate.Month))
                    {
                        //ChangePayeeAccountStatusBasedOnEEDerivedBenefit(this.icdoPayeeAccount.payee_account_id, ldecVestedEEInterest + ldecVestedEEContributions, ldecAgeIndec, ldtRetirementDate, ldecEEDerivedBenefit, lstrBenefitOptionValue);
                        lblnMarkReemployed = true;
                        lblnPayEEDerived = true;
                        //lstrRuleCorrespondence = busConstant.REEMPLOYMENT_RULE_3;

                    }
                }
                #endregion

                #region Rule 4,5
                if (!lblnMarkReemployed && this.icdoPayeeAccount.reemployed_flag != busConstant.FLAG_YES)
                {
                    if (lstrBenefitTypeValue == busConstant.BENEFIT_TYPE_DISABILITY)
                    {
                        bool lblnCheckNoDisabilityCertificationInCompYear = false;
                        int countMonths = busGlobalFunctions.GetMonthsBetweenTwoDates(ldtDisabilityCertificationDate, DateTime.Now);
                        if (countMonths > 24)
                        {
                            DataTable ldataDisabilityRecertificationDate = busBase.Select("cdoDisabilityBenefitHistory.GetLatestDisabilityCertification", new object[1] { lintBenefitAppID });
                            if (ldataDisabilityRecertificationDate.Rows.Count > 0)
                            {
                                ldtDisabilityCertificationDate = Convert.ToDateTime(ldataDisabilityRecertificationDate.Rows[0][enmDisabilityBenefitHistory.disability_cont_letter_date.ToString()]);
                                countMonths = busGlobalFunctions.GetMonthsBetweenTwoDates(ldtDisabilityCertificationDate, DateTime.Now);
                                if (countMonths < 12)
                                {
                                    lblnCheckNoDisabilityCertificationInCompYear = true;
                                }
                            }
                            //Rule 5
                        }
                        else if (countMonths > 12)
                        {
                            if (lstrBenefitSubTypeValue == "SSAD")
                            {
                                DataTable ldataDisabilityRecertificationDate = busBase.Select("cdoDisabilityBenefitHistory.GetLatestDisabilityCertification", new object[1] { lintBenefitAppID });
                                if (ldataDisabilityRecertificationDate.Rows.Count > 0)
                                {
                                    ldtDisabilityCertificationDate = Convert.ToDateTime(ldataDisabilityRecertificationDate.Rows[0][enmDisabilityBenefitHistory.disability_cont_letter_date.ToString()]);
                                    countMonths = busGlobalFunctions.GetMonthsBetweenTwoDates(ldtDisabilityCertificationDate, DateTime.Now);
                                    if (countMonths < 12)
                                    {
                                        lblnCheckNoDisabilityCertificationInCompYear = true;
                                    }
                                }
                            }
                            else
                            {
                                lblnCheckNoDisabilityCertificationInCompYear = true;
                            }
                        }
                        else
                        {
                            lblnCheckNoDisabilityCertificationInCompYear = true;
                            //Rule 4
                            //Cor : SSA Disability Benefits Stops-Overpayment 
                        }
                        if (lblnCheckNoDisabilityCertificationInCompYear)
                        {
                            //Rule 5
                            ldecHoursAccToRule = decimal.Zero;
                            ldtRuleDate = DateTime.MinValue;

                            ldtRuleDate = ldtRetirementDate.AddMonths(2);
                            foreach (DictionaryEntry ldict in lhstYearlyHours)
                            {
                                if (Convert.ToInt32(ldict.Key) >= ldtRuleDate.Year)
                                {
                                    Hashtable lhstMonths = (Hashtable)lhstYearlyHours[ldtRuleDate.Year];
                                    foreach (DictionaryEntry ldictMonths in lhstMonths)
                                    {
                                        if ((Convert.ToInt32(ldictMonths.Key) >= ldtRuleDate.Month && Convert.ToInt32(ldict.Key) == ldtRuleDate.Year) ||
                                            (Convert.ToInt32(ldict.Key) > ldtRuleDate.Year))
                                        {
                                            ldecHoursAccToRule += Convert.ToDecimal(ldictMonths.Value);
                                        }
                                    }
                                }
                            }
                            //ldecHoursAccToRule = (decimal)(lhstYearlyHours[ldtRuleDate.Year] as Hashtable)[ldtRuleDate.Month];
                            //SuspendibleHoursChange 
                            if (ldecHoursAccToRule > this.ibusCalculation.GetSuspendibleHoursValue(ldtRuleDate.Year, ldtRuleDate.Month))
                            {
                                //ChangePayeeAccountStatusBasedOnEEDerivedBenefit(this.icdoPayeeAccount.payee_account_id, ldecVestedEEInterest + ldecVestedEEContributions, ldecAgeIndec, ldtRetirementDate, ldecEEDerivedBenefit, lstrBenefitOptionValue);
                                lblnMarkReemployed = true;
                                lblnPayEEDerived = true;
                                //lstrRuleCorrespondence = busConstant.REEMPLOYMENT_RULE_3;

                            }
                        }
                        else
                        {
                            lstrRuleCorrespondence = busConstant.REEMPLOYMENT_RULE_4;
                            //Rule 4
                            //Cor : SSA Disability Benefits Stops-Overpayment 
                        }

                        lblnMarkReemployed = true;
                    }
                }
                #endregion

            }

            return lblnPayEEDerived;
        }

        public void ResumeBenefitsForRetireeModelAlternatePayeeInReEmployedStatus(Dictionary<int, Dictionary<int, decimal>> adictHoursAfterRetirement, bool ablnEligibleForEE, Collection<busBenefitMonthwiseAdjustmentDetail> aclbParticipantBenefitMonthwiseAdjustmentDetail, DateTime adteNextBenefitPaymentDate, DateTime adtFromDate, DateTime adtToDate, decimal ldecParticipantBenefitAmount, out decimal adecTotalMEAOffset, out decimal adecTotalTaxableAmountOffset)
        {
            DataTable ldtALterPayeeRetModel = Select("cdoDroBenefitDetails.GetRetireeModelAltPayeeToResumeBenefits", new object[3] { this.icdoPayeeAccount.person_id, this.icdoPayeeAccount.iintPlanId, this.icdoPayeeAccount.benefit_begin_date });
            adecTotalMEAOffset = decimal.Zero;
            adecTotalTaxableAmountOffset = decimal.Zero;
            busPayeeAccount lbusPayeeAccount;

            string lstrBenefitOptionValue = string.Empty;
            //     decimal ldecALtPayeeBenefitAmount = decimal.Zero;
            decimal ldecAPBenefitFraction = decimal.Zero;
            decimal ldecMonthlyExclusionAmount = decimal.Zero;
            decimal ldecEEContribution = decimal.Zero;
            decimal ldecTaxableAmount = decimal.Zero;
            decimal ldecNonTaxableAmount = decimal.Zero;
            if (ldtALterPayeeRetModel.Rows.Count > 0)
            {
                foreach (DataRow ldtRow in ldtALterPayeeRetModel.Rows)
                {
                    lbusPayeeAccount = new busPayeeAccount { icdoPayeeAccount = new cdoPayeeAccount() };
                    lbusPayeeAccount.icdoPayeeAccount.LoadData(ldtRow);
                    DateTime ldtQdroCommencementDate = new DateTime();

                    decimal ldecAPTaxableShouldHaveEarned = decimal.Zero;
                    decimal ldecAPNonTaxableShouldHaveEarned = decimal.Zero;
                    //Multiple DRO Part Mea = Part Mea - AP Mea * all DRO
                    string astrBenefitOptionValue = string.Empty;
                    if (!string.IsNullOrEmpty(Convert.ToString(ldtRow[enmDroApplication.dro_commencement_date.ToString()])))
                    {
                        ldtQdroCommencementDate = Convert.ToDateTime(ldtRow[enmDroApplication.dro_commencement_date.ToString()]);
                        if (ldtQdroCommencementDate > adtFromDate)
                        {
                            adtFromDate = ldtQdroCommencementDate;
                        }
                    }

                    this.ibusParticipant.LoadPersonSuspendibleMonth();

                    if (lbusPayeeAccount.icdoPayeeAccount.dro_calculation_detail_id > 0)
                    {
                        #region Calculation
                        DataTable ldtResumeBenefits = busBase.Select("cdoDroBenefitDetails.ResumeBenefitForAlternatePayees", new object[1] { lbusPayeeAccount.icdoPayeeAccount.dro_calculation_detail_id });
                        if (ldtResumeBenefits.Rows.Count > 0)
                        {
                            busQdroCalculationOptions lbusQdroCalculationOptions = new busQdroCalculationOptions { icdoQdroCalculationOptions = new cdoQdroCalculationOptions() };
                            lbusQdroCalculationOptions.icdoQdroCalculationOptions.LoadData(ldtResumeBenefits.Rows[0]);
                            if (!string.IsNullOrEmpty(Convert.ToString(ldtResumeBenefits.Rows[0][enmQdroCalculationDetail.alt_payee_ee_contribution.ToString()])))
                            {
                                ldecEEContribution = Convert.ToDecimal(ldtResumeBenefits.Rows[0][enmQdroCalculationDetail.alt_payee_ee_contribution.ToString()]);
                            }
                            if (!string.IsNullOrEmpty(Convert.ToString(ldtResumeBenefits.Rows[0][enmQdroCalculationDetail.alt_payee_member_exclusion_amount.ToString()])))
                            {
                                ldecMonthlyExclusionAmount = Convert.ToDecimal(ldtResumeBenefits.Rows[0][enmQdroCalculationDetail.alt_payee_member_exclusion_amount.ToString()]);
                            }
                            lstrBenefitOptionValue = Convert.ToString(ldtResumeBenefits.Rows[0][enmPlanBenefitXr.benefit_option_value.ToString()]);

                            lbusPayeeAccount.GetTaxableNonTaxableAmountForAlternatePayee(lbusQdroCalculationOptions, ldecEEContribution, lstrBenefitOptionValue,
                               lbusQdroCalculationOptions.icdoQdroCalculationOptions.alt_payee_benefit_amount, ldecMonthlyExclusionAmount, out ldecTaxableAmount, out ldecNonTaxableAmount);


                            adecTotalMEAOffset += ldecNonTaxableAmount;
                            adecTotalTaxableAmountOffset += ldecTaxableAmount;

                            UpdatePaymentItemTypeWithNewAmount(lbusPayeeAccount, ldecNonTaxableAmount, ldecTaxableAmount + ldecNonTaxableAmount, ldecEEContribution, lstrBenefitOptionValue, DateTime.Now, this.icdoPayeeAccount.iintPlanId, ref ldecTaxableAmount);

                            ldecAPBenefitFraction = lbusQdroCalculationOptions.icdoQdroCalculationOptions.alt_payee_benefit_amount / ldecParticipantBenefitAmount;

                        }
                        #endregion
                        //modify pick from calculations
                        /*
                        #region Alternate Payee Under or Over Payment
                        if (ldtGrossAmountEarned.Rows.Count > 0)
                        {
                            ldecAPTaxableShouldHaveEarned = decimal.Zero;
                            ldecAPNonTaxableShouldHaveEarned = decimal.Zero;
                            busPayeeAccountRetroPayment lbusAlternatePayeePayeeAccountRetroPayment = null;
                            lbusAlternatePayeePayeeAccountRetroPayment = lbusAlternatePayeePayeeAccountRetroPayment.LoadRetroActiveMonthWiseCollectionObject(ldtGrossAmountEarned);
                            if (!lbusAlternatePayeePayeeAccountRetroPayment.iclbBenefitMonthwiseAdjustmentDetail.IsNullOrEmpty())
                            {
                                if (ldtQdroCommencementDate > adtFromDate)
                                {
                                    if (ablnEligibleForEE)
                                    {
                                        while (adtFromDate <= adtToDate)
                                        {
                                            //if (this.iclbPayeeAccountPaymentItemType.Where(item => (item.icdoPayeeAccountPaymentItemType.start_date >= adtFromDate && item.icdoPayeeAccountPaymentItemType.end_date == DateTime.MinValue ||
                                            //    item.icdoPayeeAccountPaymentItemType.start_date >= adtFromDate && item.icdoPayeeAccountPaymentItemType.end_date >= adtFromDate) && item.ibusPaymentItemType.icdoPaymentItemType.item_type_code_value == busConstant.ITEM2).Count() > 0)
                                            //{
                                            //    ldecAPNonTaxableShouldHaveEarned = this.iclbPayeeAccountPaymentItemType.Where(item => (item.icdoPayeeAccountPaymentItemType.start_date >= adtFromDate && item.icdoPayeeAccountPaymentItemType.end_date == DateTime.MinValue ||
                                            //        item.icdoPayeeAccountPaymentItemType.start_date >= adtFromDate && item.icdoPayeeAccountPaymentItemType.end_date >= adtFromDate) && item.ibusPaymentItemType.icdoPaymentItemType.item_type_code_value == busConstant.ITEM2).FirstOrDefault().icdoPayeeAccountPaymentItemType.amount;
                                            //}
                                            //if (this.icdoPayeeAccount.ee_derived_benefit_amount > ldecAPNonTaxableShouldHaveEarned)
                                            //{
                                            //    ldecAPTaxableShouldHaveEarned = this.icdoPayeeAccount.ee_derived_benefit_amount - ldecAPNonTaxableShouldHaveEarned;
                                            ////}
                                            //adtFromDate = adtFromDate.AddMonths(1);
                                            //lbusAlternatePayeePayeeAccountRetroPayment.iclbBenefitMonthwiseAdjustmentDetail.Where(item => item.icdoBenefitMonthwiseAdjustmentDetail.payment_date == adtFromDate).FirstOrDefault().icdoBenefitMonthwiseAdjustmentDetail.non_taxable_amount_to_be_paid = ldecAPNonTaxableShouldHaveEarned;
                                            //lbusAlternatePayeePayeeAccountRetroPayment.iclbBenefitMonthwiseAdjustmentDetail.Where(item => item.icdoBenefitMonthwiseAdjustmentDetail.payment_date == adtFromDate).FirstOrDefault().icdoBenefitMonthwiseAdjustmentDetail.taxable_amount_to_be_paid = ldecAPTaxableShouldHaveEarned;
                                            //if (aclbParticipantBenefitMonthwiseAdjustmentDetail.Where(item => item.icdoBenefitMonthwiseAdjustmentDetail.payment_date == adtFromDate).Count() > 0)
                                            //{
                                            //    aclbParticipantBenefitMonthwiseAdjustmentDetail.Where(item => item.icdoBenefitMonthwiseAdjustmentDetail.payment_date == adtFromDate).FirstOrDefault().icdoBenefitMonthwiseAdjustmentDetail.idecAlternatePayeeMonthlyTaxableOffset = ldecAPTaxableShouldHaveEarned;
                                            //    aclbParticipantBenefitMonthwiseAdjustmentDetail.Where(item => item.icdoBenefitMonthwiseAdjustmentDetail.payment_date == adtFromDate).FirstOrDefault().icdoBenefitMonthwiseAdjustmentDetail.idecAlternatePayeeMonthlyNonTaxableOffset = ldecAPNonTaxableShouldHaveEarned;

                                            //}

                                        }
                                    }

                                    ldecTotalAPTaxableShouldHaveEarned += ldecAPTaxableShouldHaveEarned;
                                    ldecTotalAPNonTaxableShouldHaveEarned += ldecAPNonTaxableShouldHaveEarned;

                                }
                            }
                        }
                        #endregion

                        */
                    }
                    else
                    {
                        #region Conversion

                        if (ablnEligibleForEE)
                        {
                            if (lbusPayeeAccount.iclbPayeeAccountPaymentItemType.IsNullOrEmpty())
                            {
                                lbusPayeeAccount.LoadPayeeAccountPaymentItemType();
                            }
                            if (this.idtNextBenefitPaymentDate == DateTime.MinValue)
                            {
                                LoadNextBenefitPaymentDate();
                            }

                            busPayeeAccountPaymentItemType lbusPayeeAccountPayementItemTypeInsert;

                            lbusPayeeAccountPayementItemTypeInsert = lbusPayeeAccount.iclbPayeeAccountPaymentItemType.OrderByDescending(item => item.icdoPayeeAccountPaymentItemType.end_date).Where(item => item.icdoPayeeAccountPaymentItemType.end_date != DateTime.MinValue && item.ibusPaymentItemType.icdoPaymentItemType.item_type_code == busConstant.ITEM1).FirstOrDefault();

                            lbusPayeeAccount.CreatePayeeAccountPaymentItemType(busConstant.ITEM1, lbusPayeeAccountPayementItemTypeInsert.icdoPayeeAccountPaymentItemType.amount, "0", 0, this.idtNextBenefitPaymentDate, DateTime.MinValue, "N", false);

                        }
                        ibusCalculation.GetTaxableAndNonTaxableAmountFromPaymentItemTypes(lbusPayeeAccount, out ldecTaxableAmount, out ldecNonTaxableAmount);
                        adecTotalMEAOffset += ldecNonTaxableAmount;
                        adecTotalTaxableAmountOffset += ldecTaxableAmount;
                        if ((ldecParticipantBenefitAmount + ldecNonTaxableAmount + ldecTaxableAmount) > decimal.Zero)
                        {
                            ldecAPBenefitFraction = Math.Round((ldecNonTaxableAmount + ldecTaxableAmount) / (ldecParticipantBenefitAmount + ldecNonTaxableAmount + ldecTaxableAmount), 3);
                        }


                        //Chnage status to review                     
                        #endregion

                    }
                    #region Overpayment/Underpayment
                    ldecAPNonTaxableShouldHaveEarned = ldecNonTaxableAmount;
                    ldecAPTaxableShouldHaveEarned = Math.Round(this.icdoPayeeAccount.ee_derived_benefit_amount * ldecAPBenefitFraction, 2);
                    if (ldecAPTaxableShouldHaveEarned > 0)
                    {
                        ldecAPTaxableShouldHaveEarned = ldecAPTaxableShouldHaveEarned - ldecNonTaxableAmount;
                    }
                    Collection<busBenefitMonthwiseAdjustmentDetail> lclbAPBenefitMonthwiseAdjustmentDetail = ibusCalculation.GetAmountActuallyPaid(lbusPayeeAccount, adtFromDate, adtToDate);
                    if (!lclbAPBenefitMonthwiseAdjustmentDetail.IsNullOrEmpty())
                    {
                        DateTime ldtParticipantTurns65 = this.ibusParticipant.icdoPerson.date_of_birth.AddYears(65);
                        if (ldtParticipantTurns65.Day != 1)
                        {
                            ldtParticipantTurns65 = ldtParticipantTurns65.GetLastDayofMonth().AddDays(1);
                        }
                        bool lblnGetAmountForReemployment = false;
                        busBenefitCalculationHeader lbusBenefitCalculationHeader = new busBenefitCalculationHeader { icdoBenefitCalculationHeader = new cdoBenefitCalculationHeader() };
                        busBenefitCalculationDetail lbusBenefitCalculationDetail = new busBenefitCalculationDetail { icdoBenefitCalculationDetail = new cdoBenefitCalculationDetail() };
                        if (this.icdoPayeeAccount.benefit_calculation_detail_id > 0)
                        {
                            lbusBenefitCalculationDetail.FindBenefitCalculationDetail(this.icdoPayeeAccount.benefit_calculation_detail_id);
                            lbusBenefitCalculationHeader.FindBenefitCalculationHeader(lbusBenefitCalculationDetail.icdoBenefitCalculationDetail.benefit_calculation_header_id);
                            ibusCalculation.FillYearlyDetailSetBenefitAmountForEachYear(lbusBenefitCalculationHeader, lbusBenefitCalculationDetail);
                        }
                        decimal ldecTaxBenefitAmountFromYearlyDetail = ldecTaxableAmount;
                        while (adtFromDate <= adtToDate)
                        {
                            ldecTaxBenefitAmountFromYearlyDetail = ldecTaxableAmount;
                            lblnGetAmountForReemployment = false;
                            if (adtFromDate >= ldtParticipantTurns65)
                            {
                                lblnGetAmountForReemployment = true;
                            }
                            if (ibusCalculation.CheckIfMonthIsSuspendible(adictHoursAfterRetirement, this.ibusParticipant.iclbPersonSuspendibleMonth, adtFromDate))
                            {
                                if (ablnEligibleForEE)
                                {
                                    lclbAPBenefitMonthwiseAdjustmentDetail.Where(item => item.icdoBenefitMonthwiseAdjustmentDetail.payment_date == adtFromDate).FirstOrDefault().icdoBenefitMonthwiseAdjustmentDetail.non_taxable_amount_to_be_paid = ldecAPNonTaxableShouldHaveEarned;
                                    lclbAPBenefitMonthwiseAdjustmentDetail.Where(item => item.icdoBenefitMonthwiseAdjustmentDetail.payment_date == adtFromDate).FirstOrDefault().icdoBenefitMonthwiseAdjustmentDetail.taxable_amount_to_be_paid = ldecAPTaxableShouldHaveEarned;
                                    if (aclbParticipantBenefitMonthwiseAdjustmentDetail.Where(item => item.icdoBenefitMonthwiseAdjustmentDetail.payment_date == adtFromDate).Count() > 0)
                                    {
                                        aclbParticipantBenefitMonthwiseAdjustmentDetail.Where(item => item.icdoBenefitMonthwiseAdjustmentDetail.payment_date == adtFromDate).FirstOrDefault().icdoBenefitMonthwiseAdjustmentDetail.idecAlternatePayeeMonthlyTaxableOffset += ldecAPTaxableShouldHaveEarned;
                                        aclbParticipantBenefitMonthwiseAdjustmentDetail.Where(item => item.icdoBenefitMonthwiseAdjustmentDetail.payment_date == adtFromDate).FirstOrDefault().icdoBenefitMonthwiseAdjustmentDetail.idecAlternatePayeeMonthlyNonTaxableOffset += ldecAPNonTaxableShouldHaveEarned;
                                    }
                                }
                            }
                            else
                            {
                                if (this.icdoPayeeAccount.benefit_calculation_detail_id > 0)
                                {
                                    ldecTaxBenefitAmountFromYearlyDetail = ibusCalculation.GetBenefitAmountOfParticipantFromYearlyDetail(lbusBenefitCalculationHeader, lbusBenefitCalculationDetail, adtFromDate.Year, ablnGetAmountForReemployment: lblnGetAmountForReemployment);
                                    ldecTaxBenefitAmountFromYearlyDetail = Math.Round(ldecTaxBenefitAmountFromYearlyDetail * ldecAPBenefitFraction, 2);
                                    ldecTaxBenefitAmountFromYearlyDetail = ldecTaxBenefitAmountFromYearlyDetail - ldecNonTaxableAmount;

                                }
                                lclbAPBenefitMonthwiseAdjustmentDetail.Where(item => item.icdoBenefitMonthwiseAdjustmentDetail.payment_date == adtFromDate).FirstOrDefault().icdoBenefitMonthwiseAdjustmentDetail.non_taxable_amount_to_be_paid = ldecNonTaxableAmount;
                                lclbAPBenefitMonthwiseAdjustmentDetail.Where(item => item.icdoBenefitMonthwiseAdjustmentDetail.payment_date == adtFromDate).FirstOrDefault().icdoBenefitMonthwiseAdjustmentDetail.taxable_amount_to_be_paid = ldecTaxBenefitAmountFromYearlyDetail;
                                if (aclbParticipantBenefitMonthwiseAdjustmentDetail.Where(item => item.icdoBenefitMonthwiseAdjustmentDetail.payment_date == adtFromDate).Count() > 0)
                                {
                                    aclbParticipantBenefitMonthwiseAdjustmentDetail.Where(item => item.icdoBenefitMonthwiseAdjustmentDetail.payment_date == adtFromDate).FirstOrDefault().icdoBenefitMonthwiseAdjustmentDetail.idecAlternatePayeeMonthlyTaxableOffset += ldecTaxBenefitAmountFromYearlyDetail;
                                    aclbParticipantBenefitMonthwiseAdjustmentDetail.Where(item => item.icdoBenefitMonthwiseAdjustmentDetail.payment_date == adtFromDate).FirstOrDefault().icdoBenefitMonthwiseAdjustmentDetail.idecAlternatePayeeMonthlyNonTaxableOffset += ldecNonTaxableAmount;
                                }

                            }
                            adtFromDate = adtFromDate.AddMonths(1);
                        }
                        if (!lclbAPBenefitMonthwiseAdjustmentDetail.IsNullOrEmpty())
                        {
                            ibusCalculation.CreateOverpaymentUnderPayment(lbusPayeeAccount, lclbAPBenefitMonthwiseAdjustmentDetail, busConstant.RETRO_PAYMENT_REEMPLOYMENT);
                        }
                    }

                    #endregion

                }
            }
        }

        public void GetTaxableNonTaxableAmountForAlternatePayee(busQdroCalculationOptions abusQdroCalculationOptions, decimal adecEEContribution, string astrBenefitOptionValue, decimal adecALtPayeeAmountBeforeConversion, decimal adecMonthlyExclusionAmount, out decimal adecTaxableAmount, out decimal adecNonTaxableAmount)
        {
            adecTaxableAmount = decimal.Zero;
            adecNonTaxableAmount = decimal.Zero;
            if (this.icdoPayeeAccount.iintPlanId == busConstant.MPIPP_PLAN_ID && astrBenefitOptionValue == busConstant.LUMP_SUM)
            {
                busPayeeAccountHelper.CalculateMonthlyPaymentComponents(DateTime.MinValue, abusQdroCalculationOptions.icdoQdroCalculationOptions.alt_payee_benefit_amount,
                                                        ref adecNonTaxableAmount, ref adecTaxableAmount, adecEEContribution);

            }
            else if (this.icdoPayeeAccount.iintPlanId == busConstant.IAP_PLAN_ID)
            {
                busPayeeAccountHelper.CalculateMonthlyPaymentComponents(DateTime.MinValue, adecALtPayeeAmountBeforeConversion,
                                         ref adecNonTaxableAmount, ref adecNonTaxableAmount, 0);

            }
            else
            {
                busPayeeAccountHelper.CalculateMonthlyPaymentComponents(DateTime.MinValue, abusQdroCalculationOptions.icdoQdroCalculationOptions.alt_payee_benefit_amount,
                              ref adecNonTaxableAmount, ref adecTaxableAmount, adecMonthlyExclusionAmount);

            }
        }

        public void UpdateMonthlyCollectionWithWhatShouldHaveBeenPaidToAlternatePayee(Dictionary<int, Dictionary<int, decimal>> adictHoursAfterRetirement, bool ablnEligibleForEE, Collection<busBenefitMonthwiseAdjustmentDetail> aclbParticipantBenefitMonthwiseAdjustmentDetail, DataTable adtGrossAmountEarned, DateTime adtFromDate, DateTime adtToDate, decimal adecNonTaxableAmount, decimal adecTaxableAmount, decimal adecSharedPercentage)
        {
            busPayeeAccountRetroPayment lbusPayeeAccountRetroPayment = null;
            decimal ldecAPNonTaxableShouldHaveEarned = adecNonTaxableAmount;
            decimal ldecAPTaxableShouldHaveEarned = this.icdoPayeeAccount.ee_derived_benefit_amount * adecSharedPercentage / 100;
            lbusPayeeAccountRetroPayment = lbusPayeeAccountRetroPayment.LoadRetroActiveMonthWiseCollectionObject(adtGrossAmountEarned);
            if (!lbusPayeeAccountRetroPayment.iclbBenefitMonthwiseAdjustmentDetail.IsNullOrEmpty())
            {
                while (adtFromDate <= adtToDate)
                {
                    if (ibusCalculation.CheckIfMonthIsSuspendible(adictHoursAfterRetirement, this.ibusParticipant.iclbPersonSuspendibleMonth, adtFromDate) && ablnEligibleForEE)
                    {
                        lbusPayeeAccountRetroPayment.iclbBenefitMonthwiseAdjustmentDetail.Where(item => item.icdoBenefitMonthwiseAdjustmentDetail.payment_date == adtFromDate).FirstOrDefault().icdoBenefitMonthwiseAdjustmentDetail.non_taxable_amount_to_be_paid = ldecAPNonTaxableShouldHaveEarned;
                        lbusPayeeAccountRetroPayment.iclbBenefitMonthwiseAdjustmentDetail.Where(item => item.icdoBenefitMonthwiseAdjustmentDetail.payment_date == adtFromDate).FirstOrDefault().icdoBenefitMonthwiseAdjustmentDetail.taxable_amount_to_be_paid = ldecAPTaxableShouldHaveEarned;
                        if (aclbParticipantBenefitMonthwiseAdjustmentDetail.Where(item => item.icdoBenefitMonthwiseAdjustmentDetail.payment_date == adtFromDate).Count() > 0)
                        {
                            aclbParticipantBenefitMonthwiseAdjustmentDetail.Where(item => item.icdoBenefitMonthwiseAdjustmentDetail.payment_date == adtFromDate).FirstOrDefault().icdoBenefitMonthwiseAdjustmentDetail.idecAlternatePayeeMonthlyTaxableOffset += ldecAPTaxableShouldHaveEarned;
                            aclbParticipantBenefitMonthwiseAdjustmentDetail.Where(item => item.icdoBenefitMonthwiseAdjustmentDetail.payment_date == adtFromDate).FirstOrDefault().icdoBenefitMonthwiseAdjustmentDetail.idecAlternatePayeeMonthlyNonTaxableOffset += ldecAPNonTaxableShouldHaveEarned;
                        }
                    }
                    else
                    {
                        lbusPayeeAccountRetroPayment.iclbBenefitMonthwiseAdjustmentDetail.Where(item => item.icdoBenefitMonthwiseAdjustmentDetail.payment_date == adtFromDate).FirstOrDefault().icdoBenefitMonthwiseAdjustmentDetail.non_taxable_amount_to_be_paid = adecNonTaxableAmount;
                        lbusPayeeAccountRetroPayment.iclbBenefitMonthwiseAdjustmentDetail.Where(item => item.icdoBenefitMonthwiseAdjustmentDetail.payment_date == adtFromDate).FirstOrDefault().icdoBenefitMonthwiseAdjustmentDetail.taxable_amount_to_be_paid = adecTaxableAmount;
                        if (aclbParticipantBenefitMonthwiseAdjustmentDetail.Where(item => item.icdoBenefitMonthwiseAdjustmentDetail.payment_date == adtFromDate).Count() > 0)
                        {
                            aclbParticipantBenefitMonthwiseAdjustmentDetail.Where(item => item.icdoBenefitMonthwiseAdjustmentDetail.payment_date == adtFromDate).FirstOrDefault().icdoBenefitMonthwiseAdjustmentDetail.idecAlternatePayeeMonthlyTaxableOffset += adecNonTaxableAmount;
                            aclbParticipantBenefitMonthwiseAdjustmentDetail.Where(item => item.icdoBenefitMonthwiseAdjustmentDetail.payment_date == adtFromDate).FirstOrDefault().icdoBenefitMonthwiseAdjustmentDetail.idecAlternatePayeeMonthlyNonTaxableOffset += adecTaxableAmount;
                        }

                    }
                    adtFromDate = adtFromDate.AddMonths(1);
                }

                //ibusCalculation.CreateOverpaymentUnderPayment(lbusPayeeAccount, lbusAlternatePayeePayeeAccountRetroPayment.iclbBenefitMonthwiseAdjustmentDetail);
            }
        }

        #endregion

        #region ReleaseWithholding

        public ArrayList ReleaseWithholding()
        {
            utlError lobjError = null;
            ArrayList larralist = new ArrayList();
            if (this.iarrErrors.IsNull())
                this.iarrErrors = new ArrayList();
            Collection<busBenefitMonthwiseAdjustmentDetail> lclbParticipantMonthWiseAdjustmentDetail = null;
            if (!this.iclbWithholdingInformation.IsNullOrEmpty())
            {
                foreach (busWithholdingInformation lbusWithholdingInfo in this.iclbWithholdingInformation)
                {
                    if (lbusWithholdingInfo.icdoWithholdingInformation.withholding_date_to == DateTime.MinValue)
                    {
                        //PIR 990
                        if (this.icdoPayeeAccount.iintPlanId != busConstant.IAP_PLAN_ID)
                        {

                            if (lbusWithholdingInfo.icdoWithholdingInformation.withholding_date_from > this.idtNextBenefitPaymentDate.AddDays(-1))
                            {
                                lbusWithholdingInfo.icdoWithholdingInformation.withholding_date_to = lbusWithholdingInfo.icdoWithholdingInformation.withholding_date_from;
                            }
                            else
                            {
                                lbusWithholdingInfo.icdoWithholdingInformation.withholding_date_to = this.idtNextBenefitPaymentDate.AddDays(-1);
                            }


                            DataTable ldtblTotalWithheldAmount = Select("cdoWithholdingInformation.GetTotalWithheldAmount", new object[3] { this.icdoPayeeAccount.payee_account_id ,
                            lbusWithholdingInfo.icdoWithholdingInformation.withholding_date_from,lbusWithholdingInfo.icdoWithholdingInformation.withholding_date_to});
                            if (ldtblTotalWithheldAmount != null && ldtblTotalWithheldAmount.Rows.Count > 0)
                            {

                                lclbParticipantMonthWiseAdjustmentDetail = new Collection<busBenefitMonthwiseAdjustmentDetail>();
                                foreach (DataRow ldrWithheldAmount in ldtblTotalWithheldAmount.Rows)
                                {
                                    busBenefitMonthwiseAdjustmentDetail lbusBenefitMonthwiseAdjustmentDetail = new busBenefitMonthwiseAdjustmentDetail { icdoBenefitMonthwiseAdjustmentDetail = new cdoBenefitMonthwiseAdjustmentDetail() };
                                    lbusBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.payment_date = Convert.ToDateTime(ldrWithheldAmount[enmPaymentHistoryHeader.payment_date.ToString().ToUpper()]);
                                    lbusBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.taxable_amount_to_be_paid =
                                        (Convert.ToDecimal(ldrWithheldAmount["TAXABLE_WITHHOLD_FLAT_AMOUNT"]));
                                    lbusBenefitMonthwiseAdjustmentDetail.icdoBenefitMonthwiseAdjustmentDetail.non_taxable_amount_to_be_paid =
                                        (Convert.ToDecimal(ldrWithheldAmount["NON_TAXABLE_WITHHOLD_FLAT_AMOUNT"]));

                                    lclbParticipantMonthWiseAdjustmentDetail.Add(lbusBenefitMonthwiseAdjustmentDetail);
                                }
                                ibusCalculation.CreateOverpaymentUnderPayment(this, lclbParticipantMonthWiseAdjustmentDetail, busConstant.RETRO_PAYMENT_RELEASE_WITHHOLDING);
                            }
                        }
                        //PIR 990
                        else
                        {
                            if (lbusWithholdingInfo.icdoWithholdingInformation.withholding_date_from > DateTime.Now.AddDays(-1))
                            {
                                lbusWithholdingInfo.icdoWithholdingInformation.withholding_date_to = lbusWithholdingInfo.icdoWithholdingInformation.withholding_date_from;
                            }
                            else
                            {
                                lbusWithholdingInfo.icdoWithholdingInformation.withholding_date_to = DateTime.Now.AddDays(-1);
                            }

                        }
                        lbusWithholdingInfo.icdoWithholdingInformation.Update();

                        //RID 83533
                        if (this.iclbPayeeAccountStatus.Count > 0)
                        {
                            if (this.iclbPayeeAccountStatus.FirstOrDefault().icdoPayeeAccountStatus.status_value == busConstant.PAYEE_ACCOUNT_STATUS_APPROVED
                                || this.iclbPayeeAccountStatus.FirstOrDefault().icdoPayeeAccountStatus.status_value == busConstant.PAYEE_ACCOUNT_STATUS_RECEIVING)
                            {
                                CreateReviewPayeeAccountStatus();
                            }
                        }

                        break;

                    }
                }
            }

            this.EvaluateInitialLoadRules();
            larralist.Add(this);
            return larralist;
        }

        #endregion

        void DeleteFromCollectionPayeeAccountPaymentItemType(int payee_account_payment_item_type_id)
        {
            if (iclbPayeeAccountPaymentItemType != null)
            {
                busPayeeAccountPaymentItemType deleteItem = (from item in this.iclbPayeeAccountPaymentItemType
                                                             where
                                                             item.icdoPayeeAccountPaymentItemType.payee_account_payment_item_type_id == payee_account_payment_item_type_id
                                                             select item).FirstOrDefault();

                if (deleteItem != null)
                {
                    iclbPayeeAccountPaymentItemType.Remove(deleteItem);
                }
            }

        }

        int GetFedTaxOrganization()
        {
            int iintOrganizationId = 0;
            string istrFedTaxOrganizationID = HelperUtil.GetData1ByCodeValue(busConstant.TaxOrg_Code_Id, busConstant.FedTax_Code_Value);
            DataTable ldtbOrganization = busBase.Select<cdoOrganization>(new string[1] { enmOrganization.mpi_org_id.ToString() },
                                                  new object[1] { istrFedTaxOrganizationID }, null, null);
            if (ldtbOrganization != null && ldtbOrganization.Rows.Count > 0)
            {
                iintOrganizationId = Convert.ToInt32(ldtbOrganization.Rows[0][enmOrganization.org_id.ToString()]);
            }
            return iintOrganizationId;
        }

        int GetStateTaxOrganization(string stateTaxCode)
        {
            int iintOrganizationId = 0;
            string istrStateTaxOrganizationID = HelperUtil.GetData1ByCodeValue(busConstant.TaxOrg_Code_Id, stateTaxCode);
            DataTable ldtbOrganization = busBase.Select<cdoOrganization>(new string[1] { enmOrganization.mpi_org_id.ToString() },
                                                  new object[1] { istrStateTaxOrganizationID }, null, null);
            if (ldtbOrganization != null && ldtbOrganization.Rows.Count > 0)
            {
                iintOrganizationId = Convert.ToInt32(ldtbOrganization.Rows[0][enmOrganization.org_id.ToString()]);
            }
            return iintOrganizationId;
        }

        public void InsertIntoProviderReportPayment(string astrSubsystemValue, int aintSubsystemRefId, int aintPersonId, int aintOrgId, int aintPayeeAccountId, decimal adecAmount,
           int aintPaymentHistoryHeaderId, int aintPaymentItemTypeId)
        {
            cdoProviderReportPayment lobjProviderReportPayment = new cdoProviderReportPayment();
            lobjProviderReportPayment.subsystem_id = busConstant.PAYEE_ACCOUNT_SUBSYSTEM_ID; //lcdoProviderReportPayment.subsystem_id;
            lobjProviderReportPayment.subsystem_value = astrSubsystemValue;
            lobjProviderReportPayment.subsystem_ref_id = aintSubsystemRefId;
            lobjProviderReportPayment.person_id = aintPersonId;
            lobjProviderReportPayment.provider_org_id = aintOrgId;
            lobjProviderReportPayment.payee_account_id = aintPayeeAccountId;
            lobjProviderReportPayment.effective_date = DateTime.Now;
            lobjProviderReportPayment.amount = adecAmount;
            lobjProviderReportPayment.payment_history_header_id = aintPaymentHistoryHeaderId;
            lobjProviderReportPayment.payment_item_type_id = aintPaymentItemTypeId;
            lobjProviderReportPayment.created_by = iobjPassInfo.istrUserID;
            lobjProviderReportPayment.created_date = DateTime.Now;
            lobjProviderReportPayment.modified_by = iobjPassInfo.istrUserID;
            lobjProviderReportPayment.modified_date = DateTime.Now;
            lobjProviderReportPayment.Insert();
        }

        public void InsertIntoPayeeAccountRolloverItemDetail(int aintPayeeAccountRolloverDetailId, int aintPayeeAccountPaymentTypeId)
        {
            busPayeeAccountRolloverItemDetail lbusPayeeAccountRolloverItemDetail = new busPayeeAccountRolloverItemDetail() { icdoPayeeAccountRolloverItemDetail = new cdoPayeeAccountRolloverItemDetail() };
            lbusPayeeAccountRolloverItemDetail.icdoPayeeAccountRolloverItemDetail.payee_account_rollover_detail_id = aintPayeeAccountRolloverDetailId;
            lbusPayeeAccountRolloverItemDetail.icdoPayeeAccountRolloverItemDetail.payee_account_payment_item_type_id = aintPayeeAccountPaymentTypeId;
            lbusPayeeAccountRolloverItemDetail.icdoPayeeAccountRolloverItemDetail.Insert();
        }
        public override void LoadPayeeAccountStatuss()
        {
            DataTable ldtbList = Select<cdoPayeeAccountStatus>(
                new string[1] { enmPayeeAccountStatus.payee_account_id.ToString() },
                new object[1] { icdoPayeeAccount.payee_account_id }, null, "status_effective_date desc");
            iclbPayeeAccountStatus = GetCollection<busPayeeAccountStatus>(ldtbList, "icdoPayeeAccountStatus");
        }

        public void LoadLocalMPIHours()
        {
            Dictionary<string, object> ldictParams = new Dictionary<string, object>();
            busBase lobjBase = new busBase();
            foreach (string lstrParam in iobjPassInfo.idictParams.Keys)
            {
                ldictParams[lstrParam] = iobjPassInfo.idictParams[lstrParam];
            }
            //Make a copy of original connection before starting the parallel loop which would be again used after completion of parallel loop
            iobjPassInfo.idictParams["ID"] = "Batch PassInfo";
            utlPassInfo lobjMainPassInfo = iobjPassInfo;


            DataTable ldtbFinalTableForReport = new DataTable();
            idtLastBenefitPaymentDate = busPayeeAccountHelper.GetLastBenefitPaymentDate(busConstant.IAP_PLAN_ID);

            idtNextBenefitPaymentDate = busGlobalFunctions.GetPaymentDayForIAP(idtLastBenefitPaymentDate.AddDays(7));

            if (idtNextBenefitPaymentDate != DateTime.MinValue)
            {
                //DataTable ldtPayeeAccountData = busBase.Select("cdoReemploymentHistory.GetReemploymentHistory", new object[1] { icdoPayeeAccount.payee_account_id });
                //if (ldtPayeeAccountData.Rows.Count > 0)
                //{
                //    ArrayList aarrResultReport = new ArrayList();
                //    //DataTable ldtbPayeeAccountsForReport = new DataTable();
                //    //ldtbPayeeAccountsForReport = ldtPayeeAccountData.Clone();

                //   // iclbPayeeAccount = lobjBase.GetCollection<busPayeeAccount>(ldtPayeeAccountData, "icdoPayeeAccount");
                //    //Initialize the parallel processing options, especially the max number of thread to be used for parallel processing



                //    {
                utlPassInfo lobjPassInfo = new utlPassInfo();
                lobjPassInfo.idictParams = ldictParams;
                lobjPassInfo.idictParams["ID"] = "VerificationOfHoursBatch";
                lobjPassInfo.iconFramework = DBFunction.GetDBConnection();
                utlPassInfo.iobjPassInfo = lobjPassInfo;

                ArrayList aarrResult = new ArrayList();
                Hashtable ahtbQueryBkmarks = new Hashtable();
                DateTime ldtFromDate = DateTime.MinValue;
                DateTime ldtToDate = DateTime.MinValue;

                //if (lbusPayeeAccount.ibusParticipant == null)
                //{
                //    lbusPayeeAccount.ibusParticipant = new busPerson { icdoPerson = new cdoPerson() };
                //    lbusPayeeAccount.ibusParticipant.FindPerson(lbusPayeeAccount.icdoPayeeAccount.person_id);
                //    if (lbusPayeeAccount.ibusParticipant != null)
                //    {
                //        lbusPayeeAccount.LoadBenefitDetails();
                //        lbusPayeeAccount.LoadDRODetails();
                //    }
                //}

                utlConnection utlLegacyDBConnetion = HelperFunction.GetDBConnectionProperties("Legacy");
                string astrLegacyDBConnetion = utlLegacyDBConnetion.istrConnectionString;

                SqlParameter[] parameters = new SqlParameter[2];
                SqlParameter param1 = new SqlParameter("@SSN", DbType.String);
                SqlParameter param2 = new SqlParameter("@RETIREMENT_DATE", DbType.DateTime);
                //SqlParameter param3 = new SqlParameter("@TO_DATE", DbType.DateTime);

                param1.Value = this.ibusParticipant.icdoPerson.istrSSNNonEncrypted;
                parameters[0] = param1;
                // Kunal : MPI Wanted to do it this way.[else everyehere it should be a day after end of the week of retirement.
                param2.Value = busGlobalFunctions.GetFirstDayOfWeek(this.icdoPayeeAccount.idtRetireMentDate);
                parameters[1] = param2;

                //param3.Value = busGlobalFunctions.GetLastDayOfWeek(this.icdoPayeeAccount.benefit_begin_date);
                //parameters[2] = param3;

                DataTable ldtbIAPInfo = busGlobalFunctions.ExecuteSPtoGetDataTable("usp_GetWorkDataAfterRetirement", astrLegacyDBConnetion, null, parameters);
                iclbPersonWorkHistory = new Collection<cdoDummyWorkData>();
                this.iclbPayeeAccountForTable = new Collection<busPayeeAccount>();
                if (ldtbIAPInfo.Rows.Count > 0)
                {
                    var distinctRows = (from DataRow dRow in ldtbIAPInfo.Rows
                                        where dRow["OldEmployerNum"].IsNotNull()
                                        select new
                                        {
                                            OldEmployerNum = dRow["OldEmployerNum"],
                                            EmployerName = dRow["EmployerName"],
                                            Address1 = dRow["Address1"],
                                            City = dRow["City"],
                                            Address2 = dRow["Address2"],
                                            State = dRow["State"],
                                            Contact1 = dRow["Contact1"],
                                            PostalCode = dRow["PostalCode"],
                                            Contact2 = dRow["Contact2"],
                                            Street = dRow["Street"],
                                            UnionCodeDesc = dRow["UnionCodeDesc"]
                                        }).Distinct();

                    foreach (var ldtRow in distinctRows)
                    {
                        cdoDummyWorkData icdoDummyWorkData = new cdoDummyWorkData();
                        decimal ldecIAPHours = (from DataRow drow in ldtbIAPInfo.Rows
                                                where Convert.ToString(drow["OldEmployerNum"]) == Convert.ToString(ldtRow.OldEmployerNum)
                                                select
                                                   Convert.ToDecimal(drow["PensionHours"])
                                             ).Sum();

                        if (ldecIAPHours > 0)
                        {
                            icdoDummyWorkData.MPIHours = ldecIAPHours;
                            idecIAPHours4QtrAlloc = ldecIAPHours; // pir - 652
                        }

                        this.istrEmployerName = Convert.ToString(ldtRow.EmployerName);


                        ldtFromDate = (from DataRow drow in ldtbIAPInfo.Rows
                                       where drow["OldEmployerNum"].ToString().ToLower().Trim() == ldtRow.OldEmployerNum.ToString().ToLower().Trim()
                                       select Convert.ToDateTime(drow["FromDate"])
                                               ).OrderBy(t => t.Date).First();

                        ldtToDate = (from DataRow drow in ldtbIAPInfo.Rows
                                     where drow["OldEmployerNum"].ToString().ToLower().Trim() == ldtRow.OldEmployerNum.ToString().ToLower().Trim()
                                     select Convert.ToDateTime(drow["ToDate"])
                                             ).OrderByDescending(t => t.Date).First();

                        if (ldtFromDate != DateTime.MinValue)
                        {
                            icdoDummyWorkData.BeginingDate = ldtFromDate;
                            //icdoDummyWorkData.istrFromDate = this.idtFromDate.ToString("MMMM") + " " + this.idtFromDate.Year;
                        }

                        var colIAPHours = (from DataRow drow in ldtbIAPInfo.Rows
                                           where Convert.ToString(drow["OldEmployerNum"]) == Convert.ToString(ldtRow.OldEmployerNum)
                                           select new
                                           {
                                               IAPHours = Convert.ToDecimal(drow["IAPHours"]),
                                               FromDate = Convert.ToDateTime(drow["FromDate"])
                                           }
                                           );

                        //this.iclbPayeeAccountForTable = new Collection<busPayeeAccount>();
                        foreach (var ldtIAPRow in colIAPHours)
                        {
                            busPayeeAccount lbusPayeeAccountForTable = new busPayeeAccount();
                            lbusPayeeAccountForTable.idtFromDtCorr16 = Convert.ToDateTime(ldtIAPRow.FromDate);
                            lbusPayeeAccountForTable.istrFormattedDate = Convert.ToString(Convert.ToDateTime(ldtIAPRow.FromDate).ToString("d"));
                            this.istrFromDtCorr16 = lbusPayeeAccountForTable.idtFromDtCorr16.ToString("MMMM") + " " + lbusPayeeAccountForTable.idtFromDtCorr16.Year;
                            // istr1 - for IAP Hours Reported of pir-659
                            lbusPayeeAccountForTable.istr1 = "Were any of the " + Convert.ToDecimal(ldtIAPRow.IAPHours) + " hours reported p/e " + lbusPayeeAccountForTable.istrFormattedDate +
                                                             " worked in " + this.istrFromDtCorr16 + "?  " + busConstant.YES_CAPS + "  " + busConstant.NO_CAPS;

                            // 
                            if (ldtToDate != DateTime.MinValue)
                            {
                                icdoDummyWorkData.EndingDate = ldtToDate; // for Week-Ending Date of pir-659
                                lbusPayeeAccountForTable.istrToDate = String.Format("{0:d}", icdoDummyWorkData.EndingDate);
                            }
                            this.iclbPayeeAccountForTable.Add(lbusPayeeAccountForTable);
                        }

                        this.idtVerificationHoursEffectiveDate = this.icdoPayeeAccount.idtRetireMentDate;
                        this.istrVerificationHoursEffectiveDate = this.idtVerificationHoursEffectiveDate.ToString("MMMM") + " " + this.idtVerificationHoursEffectiveDate.Year;

                        if (ldtToDate != DateTime.MinValue)
                        {
                            icdoDummyWorkData.EndingDate = ldtToDate;
                            this.idtToDate = ldtToDate;
                            //this.istrToDate = String.Format("{0:MMMM dd,yyyy}", this.idtToDate);
                        }

                        if (ldtRow.EmployerName.IsNotNull())
                        {
                            icdoDummyWorkData.Employer = Convert.ToString(ldtRow.EmployerName);
                        }
                        if (ldtRow.UnionCodeDesc.IsNotNull())
                        {
                            icdoDummyWorkData.UnionCodeDesc = Convert.ToString(ldtRow.UnionCodeDesc);
                        }
                        iclbPersonWorkHistory.Add(icdoDummyWorkData);
                        // pir - 659
                        if (ldtRow.Address1.IsNotNull())
                        {
                            this.istrAddress1 = Convert.ToString(ldtRow.Address1);
                        }
                        if (ldtRow.Address2.IsNotNull())
                        {
                            this.istrAddress2 = Convert.ToString(ldtRow.Address2);
                        }
                        if (ldtRow.City.IsNotNull())
                        {
                            this.istrCity1 = Convert.ToString(ldtRow.City);
                        }
                        if (ldtRow.State.IsNotNull())
                        {
                            this.istrState = Convert.ToString(ldtRow.State);
                        }
                        if (ldtRow.PostalCode.IsNotNull())
                        {
                            this.istrPostalCode = Convert.ToString(ldtRow.PostalCode);
                        }

                        //if (ldtRow.Contact1.IsNotNull())
                        //{
                        //    this.istrContact1 = Convert.ToString(ldtRow.Contact1);
                        //    if (this.istrContact1 != "")
                        //    {
                        //        this.istrContactTRUE = busConstant.FLAG_YES;
                        //    }
                        //}                       
                        //if (ldtRow.PostalCode.IsNotNull())
                        //{
                        //    this.istrPostalCode = Convert.ToString(ldtRow.PostalCode);
                        //}
                        //if (ldtRow.Contact2.IsNotNull())
                        //{
                        //    this.istrContact2 = Convert.ToString(ldtRow.Contact2);
                        //}
                        if (ldtRow.Street.IsNotNull())
                        {
                            this.istrStreet = Convert.ToString(ldtRow.Street);
                        }

                        //icdoDummyWorkData.MPIHours = this.idecIAPHoursSUM + this.idecIAPHours4QtrAlloc;

                        //if (this.idecIAPHoursSUM > 0)
                        //{
                        //    //Create Correspondence.                            
                        //    aarrResult.Add(lbusPayeeAccount);
                        //    this.CreateCorrespondence(busConstant.NOTIFICATION_OF_HOURS_LETTER_TO_PAYEE, this.iobjPassInfo.istrUserID, this.iobjPassInfo.iintUserSerialID, aarrResult, ahtbQueryBkmarks);
                        //    this.CreateCorrespondence(busConstant.VERIFICATION_OF_HOURS_LETTER_TO_EMPLOYER, this.iobjPassInfo.istrUserID, this.iobjPassInfo.iintUserSerialID, aarrResult, ahtbQueryBkmarks);
                        //    aarrResult.Clear();
                        //}
                    }

                    //if (this.idecIAPHours4QtrAlloc > 0)
                    //{
                    //    //Payee Accounts changed to Review status.
                    //    this.CreateReviewPayeeAccountStatus();

                    //    //Create Workflow.
                    //    busWorkflowHelper.InitializeWorkflow(busConstant.UPDATE_PAYEE_ACCOUNT, lbusPayeeAccount.icdoPayeeAccount.person_id, 0, lbusPayeeAccount.icdoPayeeAccount.payee_account_id, ahtbQueryBkmarks);
                    //    PAYEE_ACCOUNT_ID = lbusPayeeAccount.icdoPayeeAccount.payee_account_id;

                    //    //Create Report
                    //    if (!(aarrResultReport.Contains(PAYEE_ACCOUNT_ID)))
                    //    {
                    //        aarrResultReport.Add(PAYEE_ACCOUNT_ID);
                    //    }
                    //}
                }

                //if (lobjPassInfo.iconFramework.State == ConnectionState.Open)
                //{
                //    lobjPassInfo.iconFramework.Close();
                //}

                //lobjPassInfo.iconFramework.Dispose();
                //lobjPassInfo.iconFramework = null;


            }
            utlPassInfo.iobjPassInfo = lobjMainPassInfo;
        }

        public int GetPayeeBeneficiaryCount(int payeeBeneficiaryAccountId, int planId)
        {
            int libeneficiaryCount = 0;
            DataTable ldtbPaymentHistory = busBase.Select("cdoRepaymentSchedule.GetPayeeBeneficiaryCount", new object[2] { payeeBeneficiaryAccountId, planId });

            if (ldtbPaymentHistory.Rows.Count > 0)
            {
                libeneficiaryCount = Convert.ToInt32(ldtbPaymentHistory.Rows[0][0]);

            }

            return libeneficiaryCount;
        }

        //Pir-527
        public void LoadSoftErrors()
        {
            iclbBenfErrors = new Collection<busError>();
            DataTable ldtbError = Select("cdoPayeeAccount.LoadSoftErrors", new object[1] { icdoPayeeAccount.person_id });
            if (ldtbError.Rows.Count > 0)
            {

                foreach (DataRow ldtrError in ldtbError.Rows)
                {
                    busError lobjError = new busError();
                    sqlFunction.LoadQueryResult(lobjError, ldtrError, iobjPassInfo.iconFramework);
                    //lobjError.parameter_values = ldtrError[enmPersonAccountBeneficiary.person_account_beneficiary_id.ToString()].ToString();
                    string lstrParamValues = lobjError.parameter_values;

                    lobjError.display_message = FormatMessageParameters(lobjError.message_id, lobjError.display_message, lstrParamValues);
                    iclbBenfErrors.Add(lobjError);
                }
            }
        }

        public Collection<cdoDummyWorkData> iclbPersonWorkHistory { get; set; }

        public decimal ldecAgeIndec { get; set; }

        public int lintAgeIndec { get; set; }

        public int ainthealthEligibleFlag { get; set; }

        public int aintHasRetirementHealthDate { get; set; }

        //LA Sunset - Payment Directives
        #region Payment Directives

        public void LoadPaymentDirectives()
        {
            DataTable ldtbList = Select<cdoPaymentDirectives>(
                new string[2] { enmPayeeAccount.payee_account_id.ToString(), enmPaymentDirectives.is_deleted.ToString() },
                new object[2] { icdoPayeeAccount.payee_account_id, busConstant.FLAG_NO }, null, null);
            iclbPaymentDirectives = GetCollection<busPaymentDirectives>(ldtbList, "icdoPaymentDirectives");

            if (iclbPaymentDirectives != null && iclbPaymentDirectives.Count > 0)
            {
                iclbPaymentDirectives.ForEach(item => item.idtPaymentCycleDate = item.icdoPaymentDirectives.payment_cycle_date);
                idtLatestPaymentDirectiveCycleDate = iclbPaymentDirectives.Max(item => item.icdoPaymentDirectives.payment_cycle_date);
            }
        }

        public void LoadDeletedPaymentDirectives()
        {
            DataTable ldtbList = Select<cdoPaymentDirectives>(
                new string[2] { enmPayeeAccount.payee_account_id.ToString(), enmPaymentDirectives.is_deleted.ToString() },
                new object[2] { icdoPayeeAccount.payee_account_id, busConstant.FLAG_YES }, null, null);
            iclbDeletedPaymentDirectives = GetCollection<busPaymentDirectives>(ldtbList, "icdoPaymentDirectives");

            if (iclbDeletedPaymentDirectives != null && iclbDeletedPaymentDirectives.Count > 0)
            {
                iclbDeletedPaymentDirectives.ForEach(item => item.idtCreatedDate = item.icdoPaymentDirectives.created_date);
                iclbDeletedPaymentDirectives.ForEach(item => item.iintPaymentDirectiveId = item.icdoPaymentDirectives.payment_directives_id);
            }
        }

        public byte[] GeneratePaymentDirective(DateTime? adtPaymentCycleDate = null, int aintDeletedPaymentDirectiveId = 0)
        {
            DataSet ldsResult = new DataSet();
            DataTable ldResult = new DataTable();
            int lintPaymentDirectiveType = GetPaymentDirectiveType();

            busPaymentDirectives lbusPaymentDirectives = null;

            if (aintDeletedPaymentDirectiveId == 0)
            {
                LoadPaymentDirectives();

                if (adtPaymentCycleDate != null && adtPaymentCycleDate != DateTime.MinValue)
                {
                    if (iclbPaymentDirectives != null && iclbPaymentDirectives.Count > 0
                        && iclbPaymentDirectives.Where(item => item.icdoPaymentDirectives.payment_cycle_date == adtPaymentCycleDate).Count() > 0)
                    {
                        lbusPaymentDirectives = iclbPaymentDirectives.Where(item => item.icdoPaymentDirectives.payment_cycle_date == adtPaymentCycleDate).FirstOrDefault();
                    }
                }
                else
                {
                    lbusPaymentDirectives = InsertDataIntoPaymentDirectives(lintPaymentDirectiveType);
                }
            }
            else
            {
                LoadDeletedPaymentDirectives();
                if (iclbDeletedPaymentDirectives != null && iclbDeletedPaymentDirectives.Count > 0
                       && iclbDeletedPaymentDirectives.Where(item => item.icdoPaymentDirectives.payment_directives_id == aintDeletedPaymentDirectiveId).Count() > 0)
                {
                    lbusPaymentDirectives = iclbDeletedPaymentDirectives.Where(item => item.icdoPaymentDirectives.payment_directives_id == aintDeletedPaymentDirectiveId).FirstOrDefault();
                }
            }

            if (lbusPaymentDirectives != null)
            {
                ldResult = GetDataForPaymentDirectives(lbusPaymentDirectives);
            }

            ldResult.TableName = "ReportTable01";
            ldsResult.Tables.Add(ldResult.Copy());

            if (ldsResult != null)
            {
                byte[] lbyteFile = null;
                busCreateReports lbusCreateReports = new busCreateReports();

                if (lintPaymentDirectiveType == busConstant.RECURRING_PAYMENT_DIRECTIVE)
                {
                    lbyteFile = lbusCreateReports.CreateDynamicReport(ldsResult, "rptRecurringPaymentDirectives");
                }
                else if (lintPaymentDirectiveType == busConstant.ONETIME_PAYMENT_DIRECTIVE)
                    lbyteFile = lbusCreateReports.CreateDynamicReport(ldsResult, "rptOneTimePaymentDirectives");
                else if (lintPaymentDirectiveType == busConstant.IAP_PAYMENT_DIRECTIVE)
                    lbyteFile = lbusCreateReports.CreateDynamicReport(ldsResult, "rptIAPPaymentDirectives");

                return lbyteFile;
            }

            EvaluateInitialLoadRules();

            return null;
        }

        public void GeneratePaymentDirectiveForBatch(DateTime? adtPaymentCycleDate = null, int aintDeletedPaymentDirectiveId = 0)
        {
            DataSet ldsResult = new DataSet();
            DataTable ldResult = new DataTable();
            int lintPaymentDirectiveType = GetPaymentDirectiveType();

            busPaymentDirectives lbusPaymentDirectives = null;

            if (aintDeletedPaymentDirectiveId == 0)
            {
                LoadPaymentDirectives();

                if (adtPaymentCycleDate != null && adtPaymentCycleDate != DateTime.MinValue)
                {
                    if (iclbPaymentDirectives != null && iclbPaymentDirectives.Count > 0
                        && iclbPaymentDirectives.Where(item => item.icdoPaymentDirectives.payment_cycle_date == adtPaymentCycleDate).Count() > 0)
                    {
                        lbusPaymentDirectives = iclbPaymentDirectives.Where(item => item.icdoPaymentDirectives.payment_cycle_date == adtPaymentCycleDate).FirstOrDefault();
                    }
                }
                else
                {
                    lbusPaymentDirectives = InsertDataIntoPaymentDirectives(lintPaymentDirectiveType);
                }
            }
            else
            {
                LoadDeletedPaymentDirectives();
                if (iclbDeletedPaymentDirectives != null && iclbDeletedPaymentDirectives.Count > 0
                       && iclbDeletedPaymentDirectives.Where(item => item.icdoPaymentDirectives.payment_directives_id == aintDeletedPaymentDirectiveId).Count() > 0)
                {
                    lbusPaymentDirectives = iclbDeletedPaymentDirectives.Where(item => item.icdoPaymentDirectives.payment_directives_id == aintDeletedPaymentDirectiveId).FirstOrDefault();
                }
            }

            //if (lbusPaymentDirectives != null)
            //{
            //    ldResult = GetDataForPaymentDirectives(lbusPaymentDirectives);
            //}

            //ldResult.TableName = "ReportTable01";
            //ldsResult.Tables.Add(ldResult.Copy());

            //if (ldsResult != null)
            //{
            //    byte[] lbyteFile = null;
            //    busCreateReports lbusCreateReports = new busCreateReports();

            //    if (lintPaymentDirectiveType == busConstant.RECURRING_PAYMENT_DIRECTIVE)
            //    {
            //        lbyteFile = lbusCreateReports.CreateDynamicReport(ldsResult, "rptRecurringPaymentDirectives");
            //    }
            //    else if (lintPaymentDirectiveType == busConstant.ONETIME_PAYMENT_DIRECTIVE)
            //        lbyteFile = lbusCreateReports.CreateDynamicReport(ldsResult, "rptOneTimePaymentDirectives");
            //    else if (lintPaymentDirectiveType == busConstant.IAP_PAYMENT_DIRECTIVE)
            //        lbyteFile = lbusCreateReports.CreateDynamicReport(ldsResult, "rptIAPPaymentDirectives");

            //    //return lbyteFile;
            //}

            //EvaluateInitialLoadRules();

            //return null;
        }

        busPaymentDirectives InsertDataIntoPaymentDirectives(int aintPaymentDirectiveType)
        {
            DateTime ldtPaymentCycleDate = idtNextBenefitPaymentDate;

            if (icdoPayeeAccount.benefit_begin_date.Date > ldtPaymentCycleDate.Date)
                ldtPaymentCycleDate = icdoPayeeAccount.benefit_begin_date;

            if (idtAdhocPaymentDate != DateTime.MinValue)
                ldtPaymentCycleDate = idtAdhocPaymentDate;


            LoadPaymentDirectives();
            if (iclbPaymentDirectives != null && iclbPaymentDirectives.Where(item => item.icdoPaymentDirectives.payment_cycle_date.Date == ldtPaymentCycleDate.Date).Count() > 0)
            {
                cdoPaymentDirectives lcdoPaymentDirectives = iclbPaymentDirectives.Where(item => item.icdoPaymentDirectives.payment_cycle_date.Date == ldtPaymentCycleDate.Date).FirstOrDefault().icdoPaymentDirectives;
                lcdoPaymentDirectives.is_deleted = busConstant.FLAG_YES;
                lcdoPaymentDirectives.modified_by = istrModifiedBy;
                lcdoPaymentDirectives.Update();

                iclbPaymentDirectives.Remove(iclbPaymentDirectives.Where(item => item.icdoPaymentDirectives.payment_cycle_date.Date == ldtPaymentCycleDate.Date).FirstOrDefault());
            }

            busPaymentDirectives lbusPaymentDirectives = new busPaymentDirectives { icdoPaymentDirectives = new cdoPaymentDirectives() };

            #region Common Properties
            lbusPaymentDirectives.icdoPaymentDirectives.payment_directive_type = aintPaymentDirectiveType;
            lbusPaymentDirectives.icdoPaymentDirectives.payee_account_id = icdoPayeeAccount.payee_account_id;
            lbusPaymentDirectives.icdoPaymentDirectives.plan_id = icdoPayeeAccount.iintPlanId;
            lbusPaymentDirectives.icdoPaymentDirectives.plan_code = icdoPayeeAccount.istrPlanCode;
            if (ibusPayeeBenefitAccount.icdoPayeeBenefitAccount.funds_type_value.IsNotNullOrEmpty())
                lbusPaymentDirectives.icdoPaymentDirectives.plan_code = lbusPaymentDirectives.icdoPaymentDirectives.plan_code + " - " + ibusPayeeBenefitAccount.icdoPayeeBenefitAccount.funds_type_value;

            lbusPaymentDirectives.icdoPaymentDirectives.payment_cycle_date = ldtPaymentCycleDate;
            lbusPaymentDirectives.icdoPaymentDirectives.payee_account_status = istrPayeeStatus;

            lbusPaymentDirectives.icdoPaymentDirectives.payment_begin_date = icdoPayeeAccount.benefit_begin_date;
            lbusPaymentDirectives.icdoPaymentDirectives.payment_end_date = icdoPayeeAccount.benefit_end_date;

            lbusPaymentDirectives.icdoPaymentDirectives.payment_category_value = icdoPayeeAccount.benefit_account_type_value;
            lbusPaymentDirectives.icdoPaymentDirectives.retirement_type_value = icdoPayeeAccount.retirement_type_value;
            lbusPaymentDirectives.icdoPaymentDirectives.payee_ssn = icdoPayeeAccount.org_id > 0 ? ibusOrganization.icdoOrganization.federal_id : ibusPayee.icdoPerson.ssn;
            lbusPaymentDirectives.icdoPaymentDirectives.payee_mpid = icdoPayeeAccount.org_id > 0 ? ibusOrganization.icdoOrganization.mpi_org_id : ibusPayee.icdoPerson.mpi_person_id;
            lbusPaymentDirectives.icdoPaymentDirectives.payee_name = icdoPayeeAccount.org_id > 0 ? ibusOrganization.icdoOrganization.org_name : ibusPayee.icdoPerson.last_name + ", " + ibusPayee.icdoPerson.first_name + " " + ibusPayee.icdoPerson.middle_name;                                           //PAYEE_NAME
            lbusPaymentDirectives.icdoPaymentDirectives.payee_dob = icdoPayeeAccount.org_id > 0 ? DateTime.MinValue : ibusPayee.icdoPerson.date_of_birth;
            lbusPaymentDirectives.icdoPaymentDirectives.payee_dod = icdoPayeeAccount.org_id > 0 ? DateTime.MinValue : ibusPayee.icdoPerson.date_of_death;
            lbusPaymentDirectives.icdoPaymentDirectives.account_relationship_value = icdoPayeeAccount.account_relation_value;

            lbusPaymentDirectives.icdoPaymentDirectives.parti_ssn = ibusParticipant.icdoPerson.ssn;
            lbusPaymentDirectives.icdoPaymentDirectives.parti_mpid = ibusParticipant.icdoPerson.mpi_person_id;
            lbusPaymentDirectives.icdoPaymentDirectives.parti_name = ibusParticipant.icdoPerson.last_name + ", " + ibusParticipant.icdoPerson.first_name + " " + ibusParticipant.icdoPerson.middle_name;                                           //PAYEE_NAME
            lbusPaymentDirectives.icdoPaymentDirectives.parti_dob = ibusParticipant.icdoPerson.date_of_birth;
            lbusPaymentDirectives.icdoPaymentDirectives.parti_dod = ibusParticipant.icdoPerson.date_of_death;

            lbusPaymentDirectives.icdoPaymentDirectives.minimum_distribution_date =
                icdoPayeeAccount.retirement_type_value == busConstant.RETIREMENT_TYPE_MINIMUM_DISTRIBUTION ? icdoPayeeAccount.idtRetireMentDate : DateTime.MinValue;
            lbusPaymentDirectives.icdoPaymentDirectives.retirement_date =
                icdoPayeeAccount.retirement_type_value != busConstant.RETIREMENT_TYPE_MINIMUM_DISTRIBUTION ? icdoPayeeAccount.idtRetireMentDate : DateTime.MinValue;

            if (!(!(this.IsPayeeAccountStatusCompletedORCancelled()) && (this.idecRetroSpkAmount > 0)))
            {
                lbusPaymentDirectives.icdoPaymentDirectives.gross_amount = idecNextGrossPaymentACH;
            }

            if (iclbPayeeAccountTaxWithholding != null &&
                iclbPayeeAccountTaxWithholding.Where(item => item.icdoPayeeAccountTaxWithholding.tax_identifier_value == busConstant.FEDRAL_STATE_TAX &&
                (item.icdoPayeeAccountTaxWithholding.end_date == DateTime.MinValue || item.icdoPayeeAccountTaxWithholding.end_date > DateTime.Today)).Count() > 0)
            {
                cdoPayeeAccountTaxWithholding lcdoPayeeAccountFedTaxWithholding = iclbPayeeAccountTaxWithholding.Where(item => item.icdoPayeeAccountTaxWithholding.tax_identifier_value == busConstant.FEDRAL_STATE_TAX &&
                (item.icdoPayeeAccountTaxWithholding.end_date == DateTime.MinValue || item.icdoPayeeAccountTaxWithholding.end_date > DateTime.Today)).FirstOrDefault().icdoPayeeAccountTaxWithholding;

                lbusPaymentDirectives.icdoPaymentDirectives.tax_identifier_value = lcdoPayeeAccountFedTaxWithholding.tax_identifier_value;
                lbusPaymentDirectives.icdoPaymentDirectives.fed_marital_status_value = lcdoPayeeAccountFedTaxWithholding.marital_status_value;
                lbusPaymentDirectives.icdoPaymentDirectives.fed_tax_option_value = lcdoPayeeAccountFedTaxWithholding.tax_option_value;
                lbusPaymentDirectives.icdoPaymentDirectives.fed_tax_allowance = lcdoPayeeAccountFedTaxWithholding.tax_allowance;
                lbusPaymentDirectives.icdoPaymentDirectives.fed_flat_perc = lcdoPayeeAccountFedTaxWithholding.tax_percentage;
                lbusPaymentDirectives.icdoPaymentDirectives.fed_additional_tax_amount = lcdoPayeeAccountFedTaxWithholding.additional_tax_amount;

                if ((!(this.IsPayeeAccountStatusCompletedORCancelled()) && (this.idecRetroSpkAmount > 0)))
                {
                    lbusPaymentDirectives.icdoPaymentDirectives.fed_total_tax_amount = idecRetroSpkFederalTaxWithHolding * -1;
                }
                else
                {
                    lbusPaymentDirectives.icdoPaymentDirectives.fed_total_tax_amount = idecFederalTaxWithHolding * -1;
                }
            }

            if (iclbPayeeAccountTaxWithholding != null &&
               iclbPayeeAccountTaxWithholding.Where(item => item.icdoPayeeAccountTaxWithholding.tax_identifier_value != busConstant.FEDRAL_STATE_TAX &&
               (item.icdoPayeeAccountTaxWithholding.end_date == DateTime.MinValue || item.icdoPayeeAccountTaxWithholding.end_date > DateTime.Today)).Count() > 0)
            {
                cdoPayeeAccountTaxWithholding lcdoPayeeAccountStateTaxWithholding = iclbPayeeAccountTaxWithholding.Where(item => item.icdoPayeeAccountTaxWithholding.tax_identifier_value != busConstant.FEDRAL_STATE_TAX &&
                (item.icdoPayeeAccountTaxWithholding.end_date == DateTime.MinValue || item.icdoPayeeAccountTaxWithholding.end_date > DateTime.Today)).FirstOrDefault().icdoPayeeAccountTaxWithholding;

                lbusPaymentDirectives.icdoPaymentDirectives.tax_identifier_value = lcdoPayeeAccountStateTaxWithholding.tax_identifier_value;
                lbusPaymentDirectives.icdoPaymentDirectives.st_marital_status_value = lcdoPayeeAccountStateTaxWithholding.marital_status_value;
                lbusPaymentDirectives.icdoPaymentDirectives.st_tax_option_value = lcdoPayeeAccountStateTaxWithholding.tax_option_value;
                lbusPaymentDirectives.icdoPaymentDirectives.st_tax_allowance = lcdoPayeeAccountStateTaxWithholding.tax_allowance;
                lbusPaymentDirectives.icdoPaymentDirectives.st_flat_perc = lcdoPayeeAccountStateTaxWithholding.tax_percentage;
                lbusPaymentDirectives.icdoPaymentDirectives.st_additional_tax_amount = lcdoPayeeAccountStateTaxWithholding.additional_tax_amount;

                if ((!(this.IsPayeeAccountStatusCompletedORCancelled()) && (this.idecRetroSpkAmount > 0)))
                {
                    lbusPaymentDirectives.icdoPaymentDirectives.st_total_tax_amount = idecRetroSpkStateTaxWithHolding * -1;
                }
                else
                {
                    lbusPaymentDirectives.icdoPaymentDirectives.st_total_tax_amount = idecStateTaxWithHolding * -1;
                }
            }

            if (!(lbusPaymentDirectives.icdoPaymentDirectives.plan_id == busConstant.IAP_PLAN_ID && icdoPayeeAccount.istrBenefitOptionValue != busConstant.LUMP_SUM))
            {
                DataTable ltblDistributionCode = Select("cdoPaymentDirectives.GetDistributionCodeForPaymentDirectives", new object[2] { ldtPaymentCycleDate, icdoPayeeAccount.payee_account_id });
                if (ltblDistributionCode != null && ltblDistributionCode.Rows.Count > 0)
                {
                    busCode lbusDistributionCode = new busCode();
                    cdoCodeValue lcdoCodeValue = lbusDistributionCode.GetCodeValue(busConstant.DISTRIBUTION_CODE_ID, Convert.ToString(ltblDistributionCode.Rows[0][0]));
                    if (lcdoCodeValue != null)
                    {
                        lbusPaymentDirectives.icdoPaymentDirectives.distribution_code_value = lcdoCodeValue.code_value;
                        lbusPaymentDirectives.icdoPaymentDirectives.distribution_code_description = lcdoCodeValue.description;
                    }
                }
            }


            if (iclbPayeeAccountRolloverDetail != null
                && iclbPayeeAccountRolloverDetail.Where(item => item.icdoPayeeAccountRolloverDetail.status_value == busConstant.PayeeAccountRolloverDetailStatusActive).Count() > 0)
            {
                cdoPayeeAccountRolloverDetail lcdoPayeeAccountRolloverDetail =
                    iclbPayeeAccountRolloverDetail.Where(item => item.icdoPayeeAccountRolloverDetail.status_value == busConstant.PayeeAccountRolloverDetailStatusActive).FirstOrDefault().icdoPayeeAccountRolloverDetail;

                lbusPaymentDirectives.icdoPaymentDirectives.rollover_lump_sum_flag = busConstant.FLAG_YES;
                lbusPaymentDirectives.icdoPaymentDirectives.rollover_bank = lcdoPayeeAccountRolloverDetail.istrOrgName;
                lbusPaymentDirectives.icdoPaymentDirectives.rollover_address = lcdoPayeeAccountRolloverDetail.contact_name + " " + lcdoPayeeAccountRolloverDetail.addr_line_1 + " " +
                    lcdoPayeeAccountRolloverDetail.addr_line_2 + " " + lcdoPayeeAccountRolloverDetail.city + " " + lcdoPayeeAccountRolloverDetail.state_value + " " + lcdoPayeeAccountRolloverDetail.zip_code + "-" + lcdoPayeeAccountRolloverDetail.zip_4_code;
                lbusPaymentDirectives.icdoPaymentDirectives.rollover_account_number = lcdoPayeeAccountRolloverDetail.account_number;

                lbusPaymentDirectives.icdoPaymentDirectives.payment_to_payee = idecNextGrossPaymentACH;
                lbusPaymentDirectives.icdoPaymentDirectives.direct_rollover = idecNextGrossPaymentRollOver;

                if (lbusPaymentDirectives.icdoPaymentDirectives.payment_to_payee > 0)
                    lbusPaymentDirectives.icdoPaymentDirectives.split_payments_flag = busConstant.FLAG_YES;
            }

            if (icdoPayeeAccount.retiree_incr_flag == busConstant.FLAG_YES)
                lbusPaymentDirectives.icdoPaymentDirectives.retiree_incr = busConstant.YES;
            else
                lbusPaymentDirectives.icdoPaymentDirectives.retiree_incr = busConstant.NO;

            if (CheckMonthlyLimit())
                lbusPaymentDirectives.icdoPaymentDirectives.verification_rq = busConstant.YES;
            else
                lbusPaymentDirectives.icdoPaymentDirectives.verification_rq = "N/A";


            lbusPaymentDirectives.icdoPaymentDirectives.fund_type = ibusPayeeBenefitAccount.icdoPayeeBenefitAccount.funds_type_value;


            lbusPaymentDirectives.icdoPaymentDirectives.special_instructions = istrSpecialInstructions;

            lbusPaymentDirectives.icdoPaymentDirectives.is_deleted = busConstant.FLAG_NO;

            lbusPaymentDirectives.icdoPaymentDirectives.more_information = istrMoreInformation;

            lbusPaymentDirectives.icdoPaymentDirectives.verified_by = icdoPayeeAccount.verified_by;
            lbusPaymentDirectives.icdoPaymentDirectives.verified_date = icdoPayeeAccount.verified_date;

            #endregion Common Properties

            #region Recurring Payment Directives

            if (idecRetroAdjustmentAmount > 0 || idecRetroSpkAmount > 0)
            {
                lbusPaymentDirectives.icdoPaymentDirectives.retro_adjustment_date = ldtPaymentCycleDate;
                lbusPaymentDirectives.icdoPaymentDirectives.over_under_paymt_adj_amt =
                    idecRetroAdjustmentAmount > 0 ? idecRetroAdjustmentAmount : idecRetroSpkAmount;
            }

            lbusPaymentDirectives.icdoPaymentDirectives.payment_option_value = icdoPayeeAccount.istrBenefitOptionValue;
            lbusPaymentDirectives.icdoPaymentDirectives.ucd = 0;


            lbusPaymentDirectives.icdoPaymentDirectives.deduction_amt = idecDeduction;
            lbusPaymentDirectives.icdoPaymentDirectives.pension_receivable_amt = idecPensionReceivable;

            if (idecPensionReceivable != decimal.Zero && iclbRepaymentSchedule != null && iclbRepaymentSchedule.Count > 0)
            {
                if (iclbRepaymentSchedule.Where(item => item.icdoRepaymentSchedule.reimbursement_status_value == busConstant.PAYMENT_REIMBURSEMENT_STATUS_PENDING
                                                ||
                                                item.icdoRepaymentSchedule.reimbursement_status_value == busConstant.REIMBURSEMENT_STATUS_INPROGRESS).Count() > 0)
                {
                    lbusPaymentDirectives.icdoPaymentDirectives.repayment_esti_end_date = iclbRepaymentSchedule.Where(item => item.icdoRepaymentSchedule.reimbursement_status_value == busConstant.PAYMENT_REIMBURSEMENT_STATUS_PENDING
                                                ||
                                                item.icdoRepaymentSchedule.reimbursement_status_value == busConstant.REIMBURSEMENT_STATUS_INPROGRESS).FirstOrDefault().icdoRepaymentSchedule.estimated_end_date;
                }
            }


            lbusPaymentDirectives.icdoPaymentDirectives.net_amount = idecNextNetPaymentACH;
            lbusPaymentDirectives.icdoPaymentDirectives.total_months = 0;
            lbusPaymentDirectives.icdoPaymentDirectives.retro_plus_curr_mnt_annu_amt = idecNextMonthTaxable;
            lbusPaymentDirectives.icdoPaymentDirectives.retro_plus_curr_mnt_mea = idecNextMonthNonTaxable;

            if (iclbPayeeAccountRetroPayment != null && iclbPayeeAccountRetroPayment.Count > 0 &&
                iclbPayeeAccountRetroPayment.Where(item => item.icdoPayeeAccountRetroPayment.effective_start_date == idtNextBenefitPaymentDate
                    && item.icdoPayeeAccountRetroPayment.is_overpayment_flag != busConstant.FLAG_YES).Count() > 0)
            {
                cdoPayeeAccountRetroPayment lcdoPayeeAccountRetroPayment = iclbPayeeAccountRetroPayment.Where(item => item.icdoPayeeAccountRetroPayment.effective_start_date == idtNextBenefitPaymentDate
                    && item.icdoPayeeAccountRetroPayment.is_overpayment_flag != busConstant.FLAG_YES).FirstOrDefault().icdoPayeeAccountRetroPayment;

                lbusPaymentDirectives.icdoPaymentDirectives.total_months =
                    busGlobalFunctions.GetMonthsBetweenTwoDates(lcdoPayeeAccountRetroPayment.start_date, lcdoPayeeAccountRetroPayment.end_date);
            }

            if (!(iclbPayeeAccountAchDetail != null && iclbPayeeAccountAchDetail.Count > 0))
            {
                LoadPayeeAccountAchDetails();
                if (iclbPayeeAccountAchDetail != null)
                {
                    iclbPayeeAccountAchDetail = (from item in this.iclbPayeeAccountAchDetail
                                                 where busGlobalFunctions.CheckDateOverlapping(idtNextBenefitPaymentDate,
                                                 item.icdoPayeeAccountAchDetail.ach_start_date, item.icdoPayeeAccountAchDetail.ach_end_date)
                                                 select item).ToList().ToCollection<busPayeeAccountAchDetail>();
                }
            }

            if (iclbPayeeAccountAchDetail != null && iclbPayeeAccountAchDetail.Count > 0
                && iclbPayeeAccountAchDetail.Where(t => (t.icdoPayeeAccountAchDetail.ach_end_date == DateTime.MinValue || t.icdoPayeeAccountAchDetail.ach_end_date > DateTime.Today)).Count() > 0)
            {
                cdoPayeeAccountAchDetail lcdoPayeeAccountAchDetail = iclbPayeeAccountAchDetail.Where(t => (t.icdoPayeeAccountAchDetail.ach_end_date == DateTime.MinValue || t.icdoPayeeAccountAchDetail.ach_end_date > DateTime.Today)).FirstOrDefault().icdoPayeeAccountAchDetail;
                lbusPaymentDirectives.icdoPaymentDirectives.ach_flag = busConstant.FLAG_YES;
                lbusPaymentDirectives.icdoPaymentDirectives.bank = lcdoPayeeAccountAchDetail.istrOrgName;
                lbusPaymentDirectives.icdoPaymentDirectives.bank_account_type_value = lcdoPayeeAccountAchDetail.bank_account_type_value;
                lbusPaymentDirectives.icdoPaymentDirectives.bank_account_number = lcdoPayeeAccountAchDetail.account_number;
                lbusPaymentDirectives.icdoPaymentDirectives.routing_number = lcdoPayeeAccountAchDetail.iintRoutingNumber;
                lbusPaymentDirectives.icdoPaymentDirectives.effetive_date = lcdoPayeeAccountAchDetail.pre_note_completion_date;
            }

            if (iclbPayeeAccountWireDetail != null && iclbPayeeAccountWireDetail.Count > 0
                && iclbPayeeAccountWireDetail.Where(t => (t.icdoPayeeAccountWireDetail.wire_end_date == DateTime.MinValue || t.icdoPayeeAccountWireDetail.wire_end_date > DateTime.Today)).Count() > 0)
            {
                doPayeeAccountWireDetail lcdoPayeeAccountWireDetail = iclbPayeeAccountWireDetail.Where(t => (t.icdoPayeeAccountWireDetail.wire_end_date == DateTime.MinValue || t.icdoPayeeAccountWireDetail.wire_end_date > DateTime.Today)).FirstOrDefault().icdoPayeeAccountWireDetail;
                lbusPaymentDirectives.icdoPaymentDirectives.wire_flag = busConstant.FLAG_YES;
                lbusPaymentDirectives.icdoPaymentDirectives.bank = lcdoPayeeAccountWireDetail.istrOrgName;
                lbusPaymentDirectives.icdoPaymentDirectives.bank_account_type_value = lcdoPayeeAccountWireDetail.bank_account_type_value;
                lbusPaymentDirectives.icdoPaymentDirectives.bank_account_number = lcdoPayeeAccountWireDetail.beneficiary_account_number;
                //  lbusPaymentDirectives.icdoPaymentDirectives.routing_number = lcdoPayeeAccountWireDetail.iintAbaSwiftBankCode;
                lbusPaymentDirectives.icdoPaymentDirectives.aba_swift_bank_code = lcdoPayeeAccountWireDetail.istrAbaSwiftBankCode;
                lbusPaymentDirectives.icdoPaymentDirectives.effetive_date = lcdoPayeeAccountWireDetail.call_back_completion_date;
            }

            lbusPaymentDirectives.icdoPaymentDirectives.withholding_percentage = idecWithholdingPercentage;

            #endregion Recurring Payment Directives

            #region OneTime Payment Directives

            DataTable ltblEEUVHPAmt = Select("cdoPaymentDirectives.GetEEUVHPAmountForPaymentDirectives", new object[1] { icdoPayeeAccount.payee_account_id });
            if (ltblEEUVHPAmt != null && ltblEEUVHPAmt.Rows.Count > 0)
            {
                lbusPaymentDirectives.icdoPaymentDirectives.ee_contri_amount = Convert.ToDecimal(ltblEEUVHPAmt.Rows[0][enmBenefitCalculationDetail.non_vested_ee_amount.ToString().ToUpper()]);
                lbusPaymentDirectives.icdoPaymentDirectives.ee_interest_amount = Convert.ToDecimal(ltblEEUVHPAmt.Rows[0][enmBenefitCalculationDetail.non_vested_ee_interest.ToString().ToUpper()]);
                lbusPaymentDirectives.icdoPaymentDirectives.uvhp_amount = Convert.ToDecimal(ltblEEUVHPAmt.Rows[0][enmBenefitCalculationDetail.total_uvhp_contribution_amount.ToString().ToUpper()]);
                lbusPaymentDirectives.icdoPaymentDirectives.uvhp_interest_amount = Convert.ToDecimal(ltblEEUVHPAmt.Rows[0][enmBenefitCalculationDetail.total_uvhp_interest_amount.ToString().ToUpper()]);
                lbusPaymentDirectives.icdoPaymentDirectives.misc_payment_amt = Convert.ToDecimal(ltblEEUVHPAmt.Rows[0][enmBenefitCalculationDetail.qdro_offset.ToString().ToUpper()]);
            }

            lbusPaymentDirectives.icdoPaymentDirectives.gross_amount = idecNextGrossPaymentACH;

            #endregion OneTime Payment Directives

            #region IAP/Special Accnt Payment
            lbusPaymentDirectives.icdoPaymentDirectives.iap_bal_sp_accnt_amt = idecNextGrossPaymentACH;
            lbusPaymentDirectives.icdoPaymentDirectives.gross_amount = idecNextGrossPaymentACH;

            lbusPaymentDirectives.icdoPaymentDirectives.transfer_org_id = icdoPayeeAccount.istrOrgMPID;
            lbusPaymentDirectives.icdoPaymentDirectives.transfer_org_name = icdoPayeeAccount.istrOrgName;
            lbusPaymentDirectives.icdoPaymentDirectives.transfer_org_contact_name = icdoPayeeAccount.transfer_org_contact_name;

            if (icdoPayeeAccount.adjustment_payment_eligible_flag == busConstant.FLAG_YES)
                lbusPaymentDirectives.icdoPaymentDirectives.adjustment_payment_flag = busConstant.YES;
            else
                lbusPaymentDirectives.icdoPaymentDirectives.adjustment_payment_flag = busConstant.NO;

            if ((icdoPayeeAccount.benefit_account_type_value == busConstant.BENEFIT_TYPE_DISABILITY || icdoPayeeAccount.benefit_account_type_value == busConstant.BENEFIT_TYPE_WITHDRAWAL)
                && this.icdoPayeeAccount.iintBenefitApplicationID > 0)
            {
                busBenefitApplication lbusBenefitApplication = new busBenefitApplication { icdoBenefitApplication = new cdoBenefitApplication() };
                if (lbusBenefitApplication.FindBenefitApplication(this.icdoPayeeAccount.iintBenefitApplicationID))
                {

                    if (icdoPayeeAccount.benefit_account_type_value == busConstant.BENEFIT_TYPE_WITHDRAWAL && lbusBenefitApplication.icdoBenefitApplication.child_support_flag == busConstant.FLAG_YES)
                        lbusPaymentDirectives.icdoPaymentDirectives.child_support_flag = busConstant.YES;
                    else
                        lbusPaymentDirectives.icdoPaymentDirectives.child_support_flag = busConstant.NO;

                    //EmergencyOneTimePayment - 03/17/2017
                    if (icdoPayeeAccount.benefit_account_type_value == busConstant.BENEFIT_TYPE_WITHDRAWAL && lbusBenefitApplication.icdoBenefitApplication.emergency_onetime_payment_flag == busConstant.FLAG_YES)
                        lbusPaymentDirectives.icdoPaymentDirectives.emergency_onetime_payment_flag = busConstant.YES;
                    else
                        lbusPaymentDirectives.icdoPaymentDirectives.emergency_onetime_payment_flag = busConstant.NO;

                    if (icdoPayeeAccount.benefit_account_type_value == busConstant.BENEFIT_TYPE_WITHDRAWAL && lbusBenefitApplication.icdoBenefitApplication.withdrawal_type_value.IsNotNullOrEmpty())
                    {
                        lbusPaymentDirectives.icdoPaymentDirectives.withdrawal_type_id = 7098;
                        lbusPaymentDirectives.icdoPaymentDirectives.withdrawal_type_value = lbusBenefitApplication.icdoBenefitApplication.withdrawal_type_value;
                    }

                    if (icdoPayeeAccount.benefit_account_type_value == busConstant.BENEFIT_TYPE_DISABILITY && lbusBenefitApplication.icdoBenefitApplication.awarded_on_date != DateTime.MinValue)
                        lbusPaymentDirectives.icdoPaymentDirectives.awarded_on_date = lbusBenefitApplication.icdoBenefitApplication.awarded_on_date;
                }
            }

            #endregion IAP/Special Accnt Payment

            busPayeeAccountStatus lbusPayeeAccountStatus = iclbPayeeAccountStatus.OrderByDescending(item => item.icdoPayeeAccountStatus.status_effective_date).FirstOrDefault();
            if (iclbPayeeAccountStatus != null && lbusPayeeAccountStatus != null
                && lbusPayeeAccountStatus.icdoPayeeAccountStatus.status_value == busConstant.PayeeAccountStatusApproved)
            {
                lbusPaymentDirectives.icdoPaymentDirectives.approved_by = lbusPayeeAccountStatus.icdoPayeeAccountStatus.modified_by;
                lbusPaymentDirectives.icdoPaymentDirectives.approved_date = lbusPayeeAccountStatus.icdoPayeeAccountStatus.modified_date;
            }

            if (icdoPayeeAccount.org_id > 0)
                lbusPaymentDirectives.icdoPaymentDirectives.is_org_payment = busConstant.FLAG_YES;
            else
                lbusPaymentDirectives.icdoPaymentDirectives.is_org_payment = busConstant.FLAG_NO;

            lbusPaymentDirectives.icdoPaymentDirectives.created_by = istrModifiedBy;
            lbusPaymentDirectives.icdoPaymentDirectives.created_date = DateTime.Now;
            lbusPaymentDirectives.icdoPaymentDirectives.modified_by = istrModifiedBy;
            lbusPaymentDirectives.icdoPaymentDirectives.modified_date = DateTime.Now;
            lbusPaymentDirectives.icdoPaymentDirectives.update_seq = 0;

            lbusPaymentDirectives.icdoPaymentDirectives.Insert();
            if (iclbPaymentDirectives == null)
                iclbPaymentDirectives = new Collection<busPaymentDirectives>();

            iclbPaymentDirectives.Add(lbusPaymentDirectives);

            iclbPaymentDirectives.ForEach(t => t.idtPaymentCycleDate = t.icdoPaymentDirectives.payment_cycle_date.Date);

            return lbusPaymentDirectives;
        }

        public DataTable GetDataForPaymentDirectives(busPaymentDirectives abusPaymentDirectives)
        {
            DataTable ldtblDataForPaymentDirectives = new DataTable();

            ldtblDataForPaymentDirectives.Columns.Add("PAYEE_ACCOUNT_ID", typeof(int));
            ldtblDataForPaymentDirectives.Columns.Add("PLAN_CODE", typeof(string));
            ldtblDataForPaymentDirectives.Columns.Add("PAYEE_ACCOUNT_STATUS", typeof(string));
            ldtblDataForPaymentDirectives.Columns.Add("PAYMENT_CYCLE_DATE", typeof(DateTime));
            ldtblDataForPaymentDirectives.Columns.Add("PAYMENT_BEGIN_DATE", typeof(DateTime));
            ldtblDataForPaymentDirectives.Columns.Add("PAYMENT_END_DATE", typeof(DateTime));
            ldtblDataForPaymentDirectives.Columns.Add("PAYMENT_CATEGORY_DESCRIPTION", typeof(string));
            ldtblDataForPaymentDirectives.Columns.Add("RETIREMENT_TYPE_DESCRIPTION", typeof(string));
            ldtblDataForPaymentDirectives.Columns.Add("PAYMENT_TYPE_DESCRIPTION", typeof(string));
            ldtblDataForPaymentDirectives.Columns.Add("PAYEE_SSN", typeof(string));
            ldtblDataForPaymentDirectives.Columns.Add("PAYEE_MPID", typeof(string));
            ldtblDataForPaymentDirectives.Columns.Add("PAYEE_NAME", typeof(string));
            ldtblDataForPaymentDirectives.Columns.Add("PAYEE_DOB", typeof(DateTime));
            ldtblDataForPaymentDirectives.Columns.Add("PAYEE_DOD", typeof(DateTime));
            ldtblDataForPaymentDirectives.Columns.Add("ACCOUNT_RELATIONSHIP_DESCRIPTION", typeof(string));
            ldtblDataForPaymentDirectives.Columns.Add("PARTI_SSN", typeof(string));
            ldtblDataForPaymentDirectives.Columns.Add("PARTI_MPID", typeof(string));
            ldtblDataForPaymentDirectives.Columns.Add("PARTI_NAME", typeof(string));
            ldtblDataForPaymentDirectives.Columns.Add("PARTI_DOB", typeof(DateTime));
            ldtblDataForPaymentDirectives.Columns.Add("PARTI_DOD", typeof(DateTime));
            ldtblDataForPaymentDirectives.Columns.Add("MINIMUM_DISTRIBUTION_DATE", typeof(DateTime));
            ldtblDataForPaymentDirectives.Columns.Add("RETIREMENT_DATE", typeof(DateTime));
            ldtblDataForPaymentDirectives.Columns.Add("RETRO_ADJUSTMENT_DATE", typeof(DateTime));
            ldtblDataForPaymentDirectives.Columns.Add("PAYMENT_OPTION_DESCRIPTION", typeof(string));
            ldtblDataForPaymentDirectives.Columns.Add("UCD", typeof(string));
            ldtblDataForPaymentDirectives.Columns.Add("GROSS_AMOUNT", typeof(decimal));
            ldtblDataForPaymentDirectives.Columns.Add("DEDUCTION_AMOUNT", typeof(decimal));
            ldtblDataForPaymentDirectives.Columns.Add("EE_CONTRI_AMOUNT", typeof(decimal));
            ldtblDataForPaymentDirectives.Columns.Add("EE_INTEREST_AMOUNT", typeof(decimal));
            ldtblDataForPaymentDirectives.Columns.Add("UVHP_AMOUNT", typeof(decimal));
            ldtblDataForPaymentDirectives.Columns.Add("UVHP_INTEREST_AMOUNT", typeof(decimal));
            ldtblDataForPaymentDirectives.Columns.Add("MISC_PAYMENT_AMT", typeof(decimal));
            ldtblDataForPaymentDirectives.Columns.Add("PENSION_RECEIVABLE_AMT", typeof(decimal));
            ldtblDataForPaymentDirectives.Columns.Add("REPAYMENT_ESTI_END_DATE", typeof(DateTime));
            ldtblDataForPaymentDirectives.Columns.Add("NET_AMOUNT", typeof(decimal));
            ldtblDataForPaymentDirectives.Columns.Add("IAP_BAL_SP_ACCNT_AMT", typeof(decimal));
            ldtblDataForPaymentDirectives.Columns.Add("OVER_UNDER_PAYMT_ADJ_AMT", typeof(decimal));
            ldtblDataForPaymentDirectives.Columns.Add("RETRO_PLUS_CURR_MNT_ANNU_AMT", typeof(decimal));
            ldtblDataForPaymentDirectives.Columns.Add("TOTAL_MONTHS", typeof(int));
            ldtblDataForPaymentDirectives.Columns.Add("RETRO_PLUS_CURR_MNT_MEA", typeof(decimal));
            ldtblDataForPaymentDirectives.Columns.Add("TAX_IDENTIFIER_VALUE", typeof(string));
            ldtblDataForPaymentDirectives.Columns.Add("FED_MARITAL_STATUS_DESCRIPTION", typeof(string));
            ldtblDataForPaymentDirectives.Columns.Add("FED_TAX_OPTION_DESCRIPTION", typeof(string));
            ldtblDataForPaymentDirectives.Columns.Add("FED_TAX_ALLOWANCE", typeof(decimal));
            ldtblDataForPaymentDirectives.Columns.Add("FED_FLAT_PERC", typeof(decimal));
            ldtblDataForPaymentDirectives.Columns.Add("FED_ADDITIONAL_TAX_AMOUNT", typeof(decimal));
            ldtblDataForPaymentDirectives.Columns.Add("FED_TOTAL_TAX_AMOUNT", typeof(decimal));
            ldtblDataForPaymentDirectives.Columns.Add("ST_MARITAL_STATUS_DESCRIPTION", typeof(string));
            ldtblDataForPaymentDirectives.Columns.Add("ST_TAX_OPTION_DESCRIPTION", typeof(string));
            ldtblDataForPaymentDirectives.Columns.Add("ST_TAX_ALLOWANCE", typeof(decimal));
            ldtblDataForPaymentDirectives.Columns.Add("ST_FLAT_PERC", typeof(decimal));
            ldtblDataForPaymentDirectives.Columns.Add("ST_ADDITIONAL_TAX_AMOUNT", typeof(decimal));
            ldtblDataForPaymentDirectives.Columns.Add("ST_TOTAL_TAX_AMOUNT", typeof(decimal));
            ldtblDataForPaymentDirectives.Columns.Add("ACH_FLAG", typeof(string));
            ldtblDataForPaymentDirectives.Columns.Add("BANK", typeof(string));
            ldtblDataForPaymentDirectives.Columns.Add("BANK_ACCOUNT_TYPE_DESCRIPTION", typeof(string));
            ldtblDataForPaymentDirectives.Columns.Add("BANK_ACCOUNT_NUMBER", typeof(string));
            ldtblDataForPaymentDirectives.Columns.Add("ROUTING_NUMBER", typeof(string));
            ldtblDataForPaymentDirectives.Columns.Add("EFFETIVE_DATE", typeof(DateTime));
            ldtblDataForPaymentDirectives.Columns.Add("SPLIT_PAYMENTS_FLAG", typeof(string));
            ldtblDataForPaymentDirectives.Columns.Add("PAYMENT_TO_PAYEE", typeof(decimal));
            ldtblDataForPaymentDirectives.Columns.Add("DIRECT_ROLLOVER", typeof(decimal));
            ldtblDataForPaymentDirectives.Columns.Add("DISTRIBUTION_CODE_VALUE", typeof(string));
            ldtblDataForPaymentDirectives.Columns.Add("DISTRIBUTION_CODE_TYPE", typeof(string));
            ldtblDataForPaymentDirectives.Columns.Add("ROLLOVER_LUMP_SUM_FLAG", typeof(string));
            ldtblDataForPaymentDirectives.Columns.Add("ROLLOVER_BANK", typeof(string));
            ldtblDataForPaymentDirectives.Columns.Add("ROLLOVER_ADDRESS", typeof(string));
            ldtblDataForPaymentDirectives.Columns.Add("ROLLOVER_ACCOUNT_NUMBER", typeof(string));
            ldtblDataForPaymentDirectives.Columns.Add("TRANSFER_ORG_ID", typeof(string));
            ldtblDataForPaymentDirectives.Columns.Add("TRANSFER_ORG_NAME", typeof(string));
            ldtblDataForPaymentDirectives.Columns.Add("TRANSFER_ORG_CONTACT_NAME", typeof(string));
            ldtblDataForPaymentDirectives.Columns.Add("WITHHOLDING_PERCENTAGE", typeof(decimal));
            ldtblDataForPaymentDirectives.Columns.Add("RETIREE_INCR", typeof(string));
            ldtblDataForPaymentDirectives.Columns.Add("FUND_TYPE", typeof(string));
            ldtblDataForPaymentDirectives.Columns.Add("SPECIAL_INSTRUCTIONS", typeof(string));
            ldtblDataForPaymentDirectives.Columns.Add("CREATED_BY", typeof(string));
            ldtblDataForPaymentDirectives.Columns.Add("CREATED_DATE", typeof(DateTime));
            ldtblDataForPaymentDirectives.Columns.Add("APPROVED_BY", typeof(string));
            ldtblDataForPaymentDirectives.Columns.Add("APPROVED_DATE", typeof(DateTime));
            ldtblDataForPaymentDirectives.Columns.Add("VERIFICATION_RQ", typeof(string));
            ldtblDataForPaymentDirectives.Columns.Add("VERIFIED_BY", typeof(string));
            ldtblDataForPaymentDirectives.Columns.Add("VERIFIED_DATE", typeof(DateTime));
            ldtblDataForPaymentDirectives.Columns.Add("IS_DELETED", typeof(string));
            ldtblDataForPaymentDirectives.Columns.Add("MORE_INFORMATION", typeof(string));
            ldtblDataForPaymentDirectives.Columns.Add("ADJUSTMENT_PAYMENT_FLAG", typeof(string));
            ldtblDataForPaymentDirectives.Columns.Add("CHILD_SUPPORT_FLAG", typeof(string));
            ldtblDataForPaymentDirectives.Columns.Add("AWARDED_ON_DATE", typeof(DateTime));
            ldtblDataForPaymentDirectives.Columns.Add("IS_ORG_PAYMENT", typeof(string));
            ldtblDataForPaymentDirectives.Columns.Add("EMERGENCY_ONETIME_PAYMENT_FLAG", typeof(string)); //EmergencyOneTimePayment - 03/17/2020
            ldtblDataForPaymentDirectives.Columns.Add("PAYMENT_METHOD", typeof(string));

            DataRow ldrDataForPaymentDirectives = ldtblDataForPaymentDirectives.NewRow();

            busCode lbusDistributionCode = new busCode();

            ldrDataForPaymentDirectives["PAYEE_ACCOUNT_ID"] = abusPaymentDirectives.icdoPaymentDirectives.payee_account_id;
            ldrDataForPaymentDirectives["PAYMENT_CYCLE_DATE"] = abusPaymentDirectives.icdoPaymentDirectives.payment_cycle_date;
            ldrDataForPaymentDirectives["PAYMENT_BEGIN_DATE"] = abusPaymentDirectives.icdoPaymentDirectives.payment_begin_date;
            ldrDataForPaymentDirectives["PAYMENT_END_DATE"] = abusPaymentDirectives.icdoPaymentDirectives.payment_end_date;
            ldrDataForPaymentDirectives["PAYMENT_CATEGORY_DESCRIPTION"] = Convert.ToString(abusPaymentDirectives.icdoPaymentDirectives.payment_category_value).IsNotNullOrEmpty() ?
                          lbusDistributionCode.GetCodeValue(abusPaymentDirectives.icdoPaymentDirectives.payment_category_id, abusPaymentDirectives.icdoPaymentDirectives.payment_category_value).description : string.Empty;

            ldrDataForPaymentDirectives["PLAN_CODE"] = abusPaymentDirectives.icdoPaymentDirectives.plan_code != null ?
                                                             abusPaymentDirectives.icdoPaymentDirectives.plan_code : string.Empty;

            ldrDataForPaymentDirectives["PAYEE_ACCOUNT_STATUS"] = abusPaymentDirectives.icdoPaymentDirectives.payee_account_status != null ?
                                                            abusPaymentDirectives.icdoPaymentDirectives.payee_account_status : string.Empty;

            ldrDataForPaymentDirectives["RETIREMENT_TYPE_DESCRIPTION"] = Convert.ToString(abusPaymentDirectives.icdoPaymentDirectives.retirement_type_value).IsNotNullOrEmpty() ?
                          lbusDistributionCode.GetCodeValue(abusPaymentDirectives.icdoPaymentDirectives.retirement_type_id, abusPaymentDirectives.icdoPaymentDirectives.retirement_type_value).description : string.Empty;

            ldrDataForPaymentDirectives["PAYMENT_TYPE_DESCRIPTION"] = Convert.ToString(abusPaymentDirectives.icdoPaymentDirectives.payment_type_value).IsNotNullOrEmpty() ?
                           lbusDistributionCode.GetCodeValue(abusPaymentDirectives.icdoPaymentDirectives.payment_type_id, abusPaymentDirectives.icdoPaymentDirectives.payment_type_value).description : string.Empty;

            ldrDataForPaymentDirectives["PAYEE_SSN"] = abusPaymentDirectives.icdoPaymentDirectives.payee_ssn != null ?
                                                                   abusPaymentDirectives.icdoPaymentDirectives.payee_ssn.Insert(5, "-").Insert(3, "-") : string.Empty;
            ldrDataForPaymentDirectives["PAYEE_MPID"] = abusPaymentDirectives.icdoPaymentDirectives.payee_mpid != null ?
                                                                        abusPaymentDirectives.icdoPaymentDirectives.payee_mpid : string.Empty;
            ldrDataForPaymentDirectives["PAYEE_NAME"] = abusPaymentDirectives.icdoPaymentDirectives.payee_name != null ?
                                                                        abusPaymentDirectives.icdoPaymentDirectives.payee_name : string.Empty;
            ldrDataForPaymentDirectives["PAYEE_DOB"] = abusPaymentDirectives.icdoPaymentDirectives.payee_dob;
            ldrDataForPaymentDirectives["PAYEE_DOD"] = abusPaymentDirectives.icdoPaymentDirectives.payee_dod;

            ldrDataForPaymentDirectives["ACCOUNT_RELATIONSHIP_DESCRIPTION"] = Convert.ToString(abusPaymentDirectives.icdoPaymentDirectives.account_relationship_value).IsNotNullOrEmpty() ?
                                                  lbusDistributionCode.GetCodeValue(abusPaymentDirectives.icdoPaymentDirectives.account_relationship_id, abusPaymentDirectives.icdoPaymentDirectives.account_relationship_value).description : string.Empty;

            ldrDataForPaymentDirectives["PARTI_SSN"] = abusPaymentDirectives.icdoPaymentDirectives.parti_ssn != null ?
                                                                        abusPaymentDirectives.icdoPaymentDirectives.parti_ssn.Insert(5, "-").Insert(3, "-") : string.Empty;
            ldrDataForPaymentDirectives["PARTI_MPID"] = abusPaymentDirectives.icdoPaymentDirectives.parti_mpid != null ?
                                                                        abusPaymentDirectives.icdoPaymentDirectives.parti_mpid : string.Empty;
            ldrDataForPaymentDirectives["PARTI_NAME"] = abusPaymentDirectives.icdoPaymentDirectives.parti_name != null ?
                                                                        abusPaymentDirectives.icdoPaymentDirectives.parti_name : string.Empty;
            ldrDataForPaymentDirectives["PARTI_DOB"] = abusPaymentDirectives.icdoPaymentDirectives.parti_dob;
            ldrDataForPaymentDirectives["PARTI_DOD"] = abusPaymentDirectives.icdoPaymentDirectives.parti_dod;
            ldrDataForPaymentDirectives["MINIMUM_DISTRIBUTION_DATE"] = abusPaymentDirectives.icdoPaymentDirectives.minimum_distribution_date;
            ldrDataForPaymentDirectives["RETIREMENT_DATE"] = abusPaymentDirectives.icdoPaymentDirectives.retirement_date;
            ldrDataForPaymentDirectives["RETRO_ADJUSTMENT_DATE"] = abusPaymentDirectives.icdoPaymentDirectives.retro_adjustment_date;

            ldrDataForPaymentDirectives["PAYMENT_OPTION_DESCRIPTION"] = Convert.ToString(abusPaymentDirectives.icdoPaymentDirectives.payment_option_value).IsNotNullOrEmpty() ?
                             lbusDistributionCode.GetCodeValue(abusPaymentDirectives.icdoPaymentDirectives.payment_option_id, abusPaymentDirectives.icdoPaymentDirectives.payment_option_value).description : string.Empty;

            ldrDataForPaymentDirectives["UCD"] = abusPaymentDirectives.icdoPaymentDirectives.ucd;
            ldrDataForPaymentDirectives["GROSS_AMOUNT"] = abusPaymentDirectives.icdoPaymentDirectives.gross_amount;
            ldrDataForPaymentDirectives["DEDUCTION_AMOUNT"] = abusPaymentDirectives.icdoPaymentDirectives.deduction_amt;
            ldrDataForPaymentDirectives["EE_CONTRI_AMOUNT"] = abusPaymentDirectives.icdoPaymentDirectives.ee_contri_amount;
            ldrDataForPaymentDirectives["EE_INTEREST_AMOUNT"] = abusPaymentDirectives.icdoPaymentDirectives.ee_interest_amount;
            ldrDataForPaymentDirectives["UVHP_AMOUNT"] = abusPaymentDirectives.icdoPaymentDirectives.uvhp_amount;
            ldrDataForPaymentDirectives["UVHP_INTEREST_AMOUNT"] = abusPaymentDirectives.icdoPaymentDirectives.uvhp_interest_amount;
            ldrDataForPaymentDirectives["MISC_PAYMENT_AMT"] = abusPaymentDirectives.icdoPaymentDirectives.misc_payment_amt;
            ldrDataForPaymentDirectives["PENSION_RECEIVABLE_AMT"] = abusPaymentDirectives.icdoPaymentDirectives.pension_receivable_amt;
            ldrDataForPaymentDirectives["REPAYMENT_ESTI_END_DATE"] = abusPaymentDirectives.icdoPaymentDirectives.repayment_esti_end_date;
            ldrDataForPaymentDirectives["NET_AMOUNT"] = abusPaymentDirectives.icdoPaymentDirectives.net_amount;
            ldrDataForPaymentDirectives["IAP_BAL_SP_ACCNT_AMT"] = abusPaymentDirectives.icdoPaymentDirectives.iap_bal_sp_accnt_amt;
            ldrDataForPaymentDirectives["OVER_UNDER_PAYMT_ADJ_AMT"] = abusPaymentDirectives.icdoPaymentDirectives.over_under_paymt_adj_amt;
            ldrDataForPaymentDirectives["RETRO_PLUS_CURR_MNT_ANNU_AMT"] = abusPaymentDirectives.icdoPaymentDirectives.retro_plus_curr_mnt_annu_amt;
            ldrDataForPaymentDirectives["TOTAL_MONTHS"] = abusPaymentDirectives.icdoPaymentDirectives.total_months;
            ldrDataForPaymentDirectives["RETRO_PLUS_CURR_MNT_MEA"] = abusPaymentDirectives.icdoPaymentDirectives.retro_plus_curr_mnt_mea;
            if (abusPaymentDirectives.icdoPaymentDirectives.tax_identifier_value == busConstant.FEDRAL_STATE_TAX)
                ldrDataForPaymentDirectives["TAX_IDENTIFIER_VALUE"] = "";
            else if (abusPaymentDirectives.icdoPaymentDirectives.tax_identifier_value == busConstant.CA_STATE_TAX)
                ldrDataForPaymentDirectives["TAX_IDENTIFIER_VALUE"] = "CA";
            else
            {
                if (abusPaymentDirectives.icdoPaymentDirectives.tax_identifier_value != null)
                {
                    ldrDataForPaymentDirectives["TAX_IDENTIFIER_VALUE"] = abusPaymentDirectives.icdoPaymentDirectives.tax_identifier_value.Substring(0, 2);

                }

            }

            ldrDataForPaymentDirectives["FED_MARITAL_STATUS_DESCRIPTION"] = Convert.ToString(abusPaymentDirectives.icdoPaymentDirectives.fed_marital_status_value).IsNotNullOrEmpty() && lbusDistributionCode.GetCodeValue(abusPaymentDirectives.icdoPaymentDirectives.fed_marital_status_id, abusPaymentDirectives.icdoPaymentDirectives.fed_marital_status_value) != null ?
                             lbusDistributionCode.GetCodeValue(abusPaymentDirectives.icdoPaymentDirectives.fed_marital_status_id, abusPaymentDirectives.icdoPaymentDirectives.fed_marital_status_value).data1 : string.Empty;

            ldrDataForPaymentDirectives["FED_TAX_OPTION_DESCRIPTION"] = Convert.ToString(abusPaymentDirectives.icdoPaymentDirectives.fed_tax_option_value).IsNotNullOrEmpty() ?
                             lbusDistributionCode.GetCodeValue(abusPaymentDirectives.icdoPaymentDirectives.fed_tax_option_id, abusPaymentDirectives.icdoPaymentDirectives.fed_tax_option_value).data3 : string.Empty;

            ldrDataForPaymentDirectives["FED_TAX_ALLOWANCE"] = abusPaymentDirectives.icdoPaymentDirectives.fed_tax_allowance;
            ldrDataForPaymentDirectives["FED_FLAT_PERC"] = abusPaymentDirectives.icdoPaymentDirectives.fed_flat_perc;
            ldrDataForPaymentDirectives["FED_ADDITIONAL_TAX_AMOUNT"] = abusPaymentDirectives.icdoPaymentDirectives.fed_additional_tax_amount;
            ldrDataForPaymentDirectives["FED_TOTAL_TAX_AMOUNT"] = abusPaymentDirectives.icdoPaymentDirectives.fed_total_tax_amount;

            ldrDataForPaymentDirectives["ST_MARITAL_STATUS_DESCRIPTION"] = Convert.ToString(abusPaymentDirectives.icdoPaymentDirectives.st_marital_status_value).IsNotNullOrEmpty() && lbusDistributionCode.GetCodeValue(abusPaymentDirectives.icdoPaymentDirectives.st_marital_status_id, abusPaymentDirectives.icdoPaymentDirectives.st_marital_status_value) != null ?
                             lbusDistributionCode.GetCodeValue(abusPaymentDirectives.icdoPaymentDirectives.st_marital_status_id, abusPaymentDirectives.icdoPaymentDirectives.st_marital_status_value).data1 : string.Empty;

            ldrDataForPaymentDirectives["ST_TAX_OPTION_DESCRIPTION"] = Convert.ToString(abusPaymentDirectives.icdoPaymentDirectives.st_tax_option_value).IsNotNullOrEmpty() ?
                             lbusDistributionCode.GetCodeValue(abusPaymentDirectives.icdoPaymentDirectives.st_tax_option_id, abusPaymentDirectives.icdoPaymentDirectives.st_tax_option_value).data3 : string.Empty;

            ldrDataForPaymentDirectives["ST_TAX_ALLOWANCE"] = abusPaymentDirectives.icdoPaymentDirectives.st_tax_allowance;
            ldrDataForPaymentDirectives["ST_FLAT_PERC"] = abusPaymentDirectives.icdoPaymentDirectives.st_flat_perc;
            ldrDataForPaymentDirectives["ST_ADDITIONAL_TAX_AMOUNT"] = abusPaymentDirectives.icdoPaymentDirectives.st_additional_tax_amount;
            ldrDataForPaymentDirectives["ST_TOTAL_TAX_AMOUNT"] = abusPaymentDirectives.icdoPaymentDirectives.st_total_tax_amount;
            ldrDataForPaymentDirectives["ACH_FLAG"] = abusPaymentDirectives.icdoPaymentDirectives.ach_flag != null ?
                                                                        abusPaymentDirectives.icdoPaymentDirectives.ach_flag : string.Empty;
            ldrDataForPaymentDirectives["BANK"] = abusPaymentDirectives.icdoPaymentDirectives.bank != null ?
                                                                        abusPaymentDirectives.icdoPaymentDirectives.bank : string.Empty;

            ldrDataForPaymentDirectives["BANK_ACCOUNT_TYPE_DESCRIPTION"] = Convert.ToString(abusPaymentDirectives.icdoPaymentDirectives.bank_account_type_value).IsNotNullOrEmpty() ?
                             lbusDistributionCode.GetCodeValue(abusPaymentDirectives.icdoPaymentDirectives.bank_account_type_id, abusPaymentDirectives.icdoPaymentDirectives.bank_account_type_value).description : string.Empty;

            ldrDataForPaymentDirectives["BANK_ACCOUNT_NUMBER"] = abusPaymentDirectives.icdoPaymentDirectives.bank_account_number != null ?
                                                                        abusPaymentDirectives.icdoPaymentDirectives.bank_account_number : string.Empty;
            ldrDataForPaymentDirectives["EFFETIVE_DATE"] = abusPaymentDirectives.icdoPaymentDirectives.effetive_date;
            ldrDataForPaymentDirectives["SPLIT_PAYMENTS_FLAG"] = abusPaymentDirectives.icdoPaymentDirectives.split_payments_flag != null ?
                                                                        abusPaymentDirectives.icdoPaymentDirectives.split_payments_flag : string.Empty;
            ldrDataForPaymentDirectives["PAYMENT_TO_PAYEE"] = abusPaymentDirectives.icdoPaymentDirectives.payment_to_payee;
            ldrDataForPaymentDirectives["DIRECT_ROLLOVER"] = abusPaymentDirectives.icdoPaymentDirectives.direct_rollover;
            ldrDataForPaymentDirectives["DISTRIBUTION_CODE_VALUE"] = abusPaymentDirectives.icdoPaymentDirectives.distribution_code_value != null ?
                                                                        abusPaymentDirectives.icdoPaymentDirectives.distribution_code_value : "N/A";
            ldrDataForPaymentDirectives["DISTRIBUTION_CODE_TYPE"] = Convert.ToString(abusPaymentDirectives.icdoPaymentDirectives.distribution_code_value).IsNotNullOrEmpty() ?
                                    lbusDistributionCode.GetCodeValue(abusPaymentDirectives.icdoPaymentDirectives.distribution_code_id, abusPaymentDirectives.icdoPaymentDirectives.distribution_code_value).description : "N/A";
            ldrDataForPaymentDirectives["ROLLOVER_LUMP_SUM_FLAG"] = abusPaymentDirectives.icdoPaymentDirectives.rollover_lump_sum_flag != null ?
                                                                        abusPaymentDirectives.icdoPaymentDirectives.rollover_lump_sum_flag : string.Empty;
            ldrDataForPaymentDirectives["ROLLOVER_BANK"] = abusPaymentDirectives.icdoPaymentDirectives.rollover_bank != null ?
                                                                        abusPaymentDirectives.icdoPaymentDirectives.rollover_bank : string.Empty;
            ldrDataForPaymentDirectives["ROLLOVER_ADDRESS"] = abusPaymentDirectives.icdoPaymentDirectives.rollover_address != null ?
                                                                        abusPaymentDirectives.icdoPaymentDirectives.rollover_address : string.Empty;
            ldrDataForPaymentDirectives["ROLLOVER_ACCOUNT_NUMBER"] = abusPaymentDirectives.icdoPaymentDirectives.rollover_account_number != null ?
                                                                        abusPaymentDirectives.icdoPaymentDirectives.rollover_account_number : string.Empty;
            ldrDataForPaymentDirectives["DIRECT_ROLLOVER"] = abusPaymentDirectives.icdoPaymentDirectives.direct_rollover;


            ldrDataForPaymentDirectives["TRANSFER_ORG_ID"] = abusPaymentDirectives.icdoPaymentDirectives.transfer_org_id != null ?
                                                                        abusPaymentDirectives.icdoPaymentDirectives.transfer_org_id : string.Empty;

            ldrDataForPaymentDirectives["TRANSFER_ORG_NAME"] = abusPaymentDirectives.icdoPaymentDirectives.transfer_org_name != null ?
                                                                        abusPaymentDirectives.icdoPaymentDirectives.transfer_org_name : string.Empty;

            ldrDataForPaymentDirectives["TRANSFER_ORG_CONTACT_NAME"] = abusPaymentDirectives.icdoPaymentDirectives.transfer_org_contact_name != null ?
                                                                        abusPaymentDirectives.icdoPaymentDirectives.transfer_org_contact_name : string.Empty;

            ldrDataForPaymentDirectives["WITHHOLDING_PERCENTAGE"] = abusPaymentDirectives.icdoPaymentDirectives.withholding_percentage;

            ldrDataForPaymentDirectives["RETIREE_INCR"] = abusPaymentDirectives.icdoPaymentDirectives.retiree_incr;

            ldrDataForPaymentDirectives["FUND_TYPE"] = abusPaymentDirectives.icdoPaymentDirectives.fund_type != null ?
                                                                        abusPaymentDirectives.icdoPaymentDirectives.fund_type : string.Empty;

            ldrDataForPaymentDirectives["SPECIAL_INSTRUCTIONS"] = abusPaymentDirectives.icdoPaymentDirectives.special_instructions != null ?
                                                                        abusPaymentDirectives.icdoPaymentDirectives.special_instructions : string.Empty;
            ldrDataForPaymentDirectives["CREATED_BY"] = abusPaymentDirectives.icdoPaymentDirectives.created_by != null ?
                                                                        abusPaymentDirectives.icdoPaymentDirectives.created_by : string.Empty;
            ldrDataForPaymentDirectives["CREATED_DATE"] = abusPaymentDirectives.icdoPaymentDirectives.created_date;

            ldrDataForPaymentDirectives["APPROVED_BY"] = abusPaymentDirectives.icdoPaymentDirectives.approved_by != null ?
                                                                        abusPaymentDirectives.icdoPaymentDirectives.approved_by : string.Empty;
            ldrDataForPaymentDirectives["APPROVED_DATE"] = abusPaymentDirectives.icdoPaymentDirectives.approved_date;

            ldrDataForPaymentDirectives["VERIFICATION_RQ"] = abusPaymentDirectives.icdoPaymentDirectives.verification_rq != null ?
                                                                        abusPaymentDirectives.icdoPaymentDirectives.verification_rq : string.Empty;

            ldrDataForPaymentDirectives["VERIFIED_BY"] = abusPaymentDirectives.icdoPaymentDirectives.verified_by != null ?
                                                                       abusPaymentDirectives.icdoPaymentDirectives.verified_by : string.Empty;
            ldrDataForPaymentDirectives["VERIFIED_DATE"] = abusPaymentDirectives.icdoPaymentDirectives.verified_date;

            ldrDataForPaymentDirectives["IS_DELETED"] = abusPaymentDirectives.icdoPaymentDirectives.is_deleted != null ?
                                                                      abusPaymentDirectives.icdoPaymentDirectives.is_deleted : string.Empty;

            ldrDataForPaymentDirectives["MORE_INFORMATION"] = abusPaymentDirectives.icdoPaymentDirectives.more_information != null ?
                                                                      abusPaymentDirectives.icdoPaymentDirectives.more_information : string.Empty;

            ldrDataForPaymentDirectives["ADJUSTMENT_PAYMENT_FLAG"] = abusPaymentDirectives.icdoPaymentDirectives.adjustment_payment_flag;

            ldrDataForPaymentDirectives["CHILD_SUPPORT_FLAG"] = abusPaymentDirectives.icdoPaymentDirectives.child_support_flag;

            ldrDataForPaymentDirectives["AWARDED_ON_DATE"] = abusPaymentDirectives.icdoPaymentDirectives.awarded_on_date;

            ldrDataForPaymentDirectives["IS_ORG_PAYMENT"] = abusPaymentDirectives.icdoPaymentDirectives.is_org_payment;

            ldrDataForPaymentDirectives["EMERGENCY_ONETIME_PAYMENT_FLAG"] = abusPaymentDirectives.icdoPaymentDirectives.emergency_onetime_payment_flag;

            if (abusPaymentDirectives.icdoPaymentDirectives.ach_flag == busConstant.FLAG_YES)
            {
                ldrDataForPaymentDirectives["ROUTING_NUMBER"] = abusPaymentDirectives.icdoPaymentDirectives.routing_number;
                ldrDataForPaymentDirectives["PAYMENT_METHOD"] = busConstant.PAYMENT_METHOD_ACH;
            }
            else if (abusPaymentDirectives.icdoPaymentDirectives.wire_flag == busConstant.FLAG_YES)
            {
                ldrDataForPaymentDirectives["ROUTING_NUMBER"] = abusPaymentDirectives.icdoPaymentDirectives.aba_swift_bank_code;
                ldrDataForPaymentDirectives["PAYMENT_METHOD"] = busConstant.PAYMENT_METHOD_WIRE;
            }
            else
                ldrDataForPaymentDirectives["PAYMENT_METHOD"] = busConstant.PAYMENT_METHOD_CHK;

            ldtblDataForPaymentDirectives.Rows.Add(ldrDataForPaymentDirectives);

            return ldtblDataForPaymentDirectives;
        }

        public int GetPaymentDirectiveType()
        {
            if (icdoPayeeAccount.retiree_incr_flag == busConstant.FLAG_YES)
                return busConstant.RECURRING_PAYMENT_DIRECTIVE;
            else if (icdoPayeeAccount.iintPlanId == busConstant.IAP_PLAN_ID)
                return busConstant.IAP_PAYMENT_DIRECTIVE;
            else if (icdoPayeeAccount.istrBenefitOptionValue == busConstant.LUMP_SUM)
                return busConstant.ONETIME_PAYMENT_DIRECTIVE;
            else
                return busConstant.RECURRING_PAYMENT_DIRECTIVE;
        }

        public Collection<busPaymentDirectives> GetGeneratedPaymentDirectives()
        {
            LoadPaymentDirectives();

            if (iclbPaymentDirectives != null && iclbPaymentDirectives.Count > 0)
            {
                iclbPaymentDirectives.ForEach(t => t.idtPaymentCycleDate = t.icdoPaymentDirectives.payment_cycle_date.Date);
            }

            return iclbPaymentDirectives;
        }

        public Collection<busPaymentDirectives> GetDeletedPaymentDirectives()
        {
            LoadDeletedPaymentDirectives();

            if (iclbDeletedPaymentDirectives != null && iclbDeletedPaymentDirectives.Count > 0)
            {
                iclbDeletedPaymentDirectives.ForEach(t => t.idtPaymentCycleDate = t.icdoPaymentDirectives.payment_cycle_date + DateTime.Now.TimeOfDay);
            }

            return iclbDeletedPaymentDirectives;
        }

        public bool CheckPaymentDirective()
        {
            LoadPaymentDirectives();

            if (iclbPaymentDirectives != null && iclbPaymentDirectives.Count > 0)
            {
                iclbPaymentDirectives.ForEach(t => t.idtPaymentCycleDate = t.icdoPaymentDirectives.payment_cycle_date.Date);
                if (iclbPaymentDirectives.Where(t => t.idtPaymentCycleDate.Date != DateTime.MinValue.Date).Count() > 0)
                    return true;
            }
            return false;
        }

        public bool CheckDeletedPaymentDirective()
        {
            LoadDeletedPaymentDirectives();

            if (iclbDeletedPaymentDirectives != null && iclbDeletedPaymentDirectives.Count > 0)
            {
                iclbDeletedPaymentDirectives.ForEach(t => t.idtCreatedDate = t.icdoPaymentDirectives.created_date);
                iclbDeletedPaymentDirectives.ForEach(t => t.iintPaymentDirectiveId = t.icdoPaymentDirectives.payment_directives_id);

                if (iclbDeletedPaymentDirectives.Where(t => t.idtCreatedDate.Date != DateTime.MinValue.Date).Count() > 0)
                    return true;
            }
            return false;
        }

        public ArrayList btn_DeleteLatestPaymentDirective()
        {
            if (this.iarrErrors.IsNull())
                this.iarrErrors = new ArrayList();

            if (this.iclbPayeeAccountStatus != null
                && this.iclbPayeeAccountStatus.OrderByDescending(t => t.icdoPayeeAccountStatus.status_effective_date).FirstOrDefault().icdoPayeeAccountStatus.status_value != busConstant.PayeeAccountStatusReview)
            {
                utlError lobjError = AddError(0, "Payee Account must be in Review status.");
                this.iarrErrors.Add(lobjError);
                return iarrErrors;
            }

            LoadPaymentDirectives();
            if (iclbPaymentDirectives != null && iclbPaymentDirectives.Count > 0)
            {
                iclbPaymentDirectives.OrderByDescending(item => item.icdoPaymentDirectives.payment_cycle_date).FirstOrDefault().icdoPaymentDirectives.is_deleted = busConstant.FLAG_YES;
                iclbPaymentDirectives.OrderByDescending(item => item.icdoPaymentDirectives.payment_cycle_date).FirstOrDefault().icdoPaymentDirectives.Update();

                LoadPaymentDirectives();
                LoadDeletedPaymentDirectives();
            }

            iarrErrors.Add(this);

            return iarrErrors;
        }

        #endregion Payment Directives

        #region IAP Payback
        //6/15/2020 - IAP Payback
        public ArrayList btn_DeleteIAPHardshipPaybackDetailClick(int aintIAPPaybackDetailID, string adtCheckDate, string astrCheckNumber, string adecCheckAmount)
        {
            if (this.iarrErrors.IsNull())
                this.iarrErrors = new ArrayList();
            ArrayList larrResult = new ArrayList();
            idtCurrentPaybackCheckReceivedDate = Convert.ToDateTime(adtCheckDate);
            istrCurrentPaybackCheckNumber = Convert.ToString(astrCheckNumber);
            idecCurrentPaybackCheckAmount = Convert.ToDecimal(adecCheckAmount.ToString().Substring(1));

            if (aintIAPPaybackDetailID > 0 && iclbIAPHardshipPayback.Where(item => item.icdoIapHardshipPayback.iap_hardship_payback_id == aintIAPPaybackDetailID).Count() > 0)
            {
                busIapHardshipPayback lbusIAPHardshipPaybackDetails = iclbIAPHardshipPayback.Where(item => item.icdoIapHardshipPayback.iap_hardship_payback_id == aintIAPPaybackDetailID).FirstOrDefault();

                if (this.icdoPayeeAccount.iintPlanId == busConstant.IAP_PLAN_ID)
                {
                    busPersonAccountRetirementContribution lobjRetrContribution = new busPersonAccountRetirementContribution { icdoPersonAccountRetirementContribution = new cdoPersonAccountRetirementContribution() };

                    if (lbusIAPHardshipPaybackDetails.icdoIapHardshipPayback.check_amount != 0)
                    {
                        DataTable ldtbIAPBalance = new DataTable();
                        DataTable ldtbEmergencyPaymentSetupValue = new DataTable();
                        decimal idecFactor = 0;

                        switch (istrCOVIDOptionValue) //Paybacks should be posted back accoriding to the option selected in the benefit application and ratio to be applied based on options (if multiple plans)
                        {
                            case busConstant.COVID_IAP_ONLY_OPTION:
                                lobjRetrContribution.InsertPersonAccountRetirementContirbution(this.ibusPayeeBenefitAccount.icdoPayeeBenefitAccount.person_account_id, lbusIAPHardshipPaybackDetails.icdoIapHardshipPayback.check_date, lbusIAPHardshipPaybackDetails.icdoIapHardshipPayback.payment_posted_date, this.icdoPayeeAccount.idtRetireMentDate.Year, adecIAPBalanceAmount: -lbusIAPHardshipPaybackDetails.icdoIapHardshipPayback.check_amount,
                                astrTransactionType: busConstant.RCTransactionTypePayment, astrContributionType: busConstant.RCContributionTypeAllocation1);
                                break;

                            case busConstant.COVID_L161_SPL_AC_ONLY_OPTION:
                                lobjRetrContribution.InsertPersonAccountRetirementContirbution(this.ibusPayeeBenefitAccount.icdoPayeeBenefitAccount.person_account_id, lbusIAPHardshipPaybackDetails.icdoIapHardshipPayback.check_date, lbusIAPHardshipPaybackDetails.icdoIapHardshipPayback.payment_posted_date, this.icdoPayeeAccount.idtRetireMentDate.Year, adec161SplAccountBalance: -lbusIAPHardshipPaybackDetails.icdoIapHardshipPayback.check_amount,
                                astrTransactionType: busConstant.RCTransactionTypePayment, astrContributionType: busConstant.RCContributionTypeAllocation1);
                                break;

                            case busConstant.COVID_L52_SPL_AC_ONLY_OPTION:
                                lobjRetrContribution.InsertPersonAccountRetirementContirbution(this.ibusPayeeBenefitAccount.icdoPayeeBenefitAccount.person_account_id, lbusIAPHardshipPaybackDetails.icdoIapHardshipPayback.check_date, lbusIAPHardshipPaybackDetails.icdoIapHardshipPayback.payment_posted_date, this.icdoPayeeAccount.idtRetireMentDate.Year, adec52SplAccountBalance: -lbusIAPHardshipPaybackDetails.icdoIapHardshipPayback.check_amount,
                                astrTransactionType: busConstant.RCTransactionTypePayment, astrContributionType: busConstant.RCContributionTypeAllocation1);
                                break;

                            case busConstant.COVID_L52_L161_SPL_AC_ONLY_OPTION:
                                ldtbEmergencyPaymentSetupValue = busBase.Select("cdoEmergencyPaymentSetupValue.GetEmergencyPaymentSetupValue", new object[1] { DateTime.Now });
                                ldtbIAPBalance = busBase.Select("cdoPersonAccountRetirementContribution.GetIAPBalanceAsofYear",
                                               new object[2] { this.ibusPayeeBenefitAccount.icdoPayeeBenefitAccount.person_account_id, Convert.ToInt32(ldtbEmergencyPaymentSetupValue.Rows[0]["IAP_BALANCE_AS_OF_YEAR"]) });
                                idecFactor = lbusIAPHardshipPaybackDetails.icdoIapHardshipPayback.check_amount / Math.Round((Convert.ToDecimal(ldtbIAPBalance.Rows[0]["LOCAL52_SPECIAL_ACCT_BAL_AMOUNT"]) + Convert.ToDecimal(ldtbIAPBalance.Rows[0]["LOCAL161_SPECIAL_ACCT_BAL_AMOUNT"])), 2);
                                lobjRetrContribution.InsertPersonAccountRetirementContirbution(this.ibusPayeeBenefitAccount.icdoPayeeBenefitAccount.person_account_id, lbusIAPHardshipPaybackDetails.icdoIapHardshipPayback.check_date, lbusIAPHardshipPaybackDetails.icdoIapHardshipPayback.payment_posted_date, this.icdoPayeeAccount.idtRetireMentDate.Year, adec52SplAccountBalance: -Convert.ToDecimal(ldtbIAPBalance.Rows[0]["LOCAL52_SPECIAL_ACCT_BAL_AMOUNT"]) * idecFactor, adec161SplAccountBalance: -Convert.ToDecimal(ldtbIAPBalance.Rows[0]["LOCAL161_SPECIAL_ACCT_BAL_AMOUNT"]) * idecFactor,
                                astrTransactionType: busConstant.RCTransactionTypePayment, astrContributionType: busConstant.RCContributionTypeAllocation1);
                                break;

                            case busConstant.COVID_ALL_OPTION:
                                ldtbEmergencyPaymentSetupValue = busBase.Select("cdoEmergencyPaymentSetupValue.GetEmergencyPaymentSetupValue", new object[1] { DateTime.Now });
                                ldtbIAPBalance = busBase.Select("cdoPersonAccountRetirementContribution.GetIAPBalanceAsofYear",
                                               new object[2] { this.ibusPayeeBenefitAccount.icdoPayeeBenefitAccount.person_account_id, Convert.ToInt32(ldtbEmergencyPaymentSetupValue.Rows[0]["IAP_BALANCE_AS_OF_YEAR"]) });
                                idecFactor = lbusIAPHardshipPaybackDetails.icdoIapHardshipPayback.check_amount / Math.Round((Convert.ToDecimal(ldtbIAPBalance.Rows[0]["IAP_BALANCE_AMOUNT"]) + Convert.ToDecimal(ldtbIAPBalance.Rows[0]["LOCAL52_SPECIAL_ACCT_BAL_AMOUNT"]) + Convert.ToDecimal(ldtbIAPBalance.Rows[0]["LOCAL161_SPECIAL_ACCT_BAL_AMOUNT"])), 2);
                                lobjRetrContribution.InsertPersonAccountRetirementContirbution(this.ibusPayeeBenefitAccount.icdoPayeeBenefitAccount.person_account_id, lbusIAPHardshipPaybackDetails.icdoIapHardshipPayback.check_date, lbusIAPHardshipPaybackDetails.icdoIapHardshipPayback.payment_posted_date, this.icdoPayeeAccount.idtRetireMentDate.Year, adecIAPBalanceAmount: -Convert.ToDecimal(ldtbIAPBalance.Rows[0]["IAP_BALANCE_AMOUNT"]) * idecFactor, adec52SplAccountBalance: -Convert.ToDecimal(ldtbIAPBalance.Rows[0]["LOCAL52_SPECIAL_ACCT_BAL_AMOUNT"]) * idecFactor, adec161SplAccountBalance: -Convert.ToDecimal(ldtbIAPBalance.Rows[0]["LOCAL161_SPECIAL_ACCT_BAL_AMOUNT"]) * idecFactor,
                                astrTransactionType: busConstant.RCTransactionTypePayment, astrContributionType: busConstant.RCContributionTypeAllocation1);
                                break;
                        }


                        //lobjRetrContribution.InsertPersonAccountRetirementContirbution(this.ibusPayeeBenefitAccount.icdoPayeeBenefitAccount.person_account_id, DateTime.Now, lbusIAPHardshipPaybackDetails.icdoIapHardshipPayback.payment_posted_date, this.icdoPayeeAccount.idtRetireMentDate.Year, adecIAPBalanceAmount: -lbusIAPHardshipPaybackDetails.icdoIapHardshipPayback.check_amount,
                        //astrTransactionType: busConstant.RCTransactionTypePayment, astrContributionType: busConstant.RCContributionTypeAllocation1);
                    }
                }

                this.iclbIAPHardshipPayback.Remove(this.iclbIAPHardshipPayback.Where(item => item.icdoIapHardshipPayback.iap_hardship_payback_id == aintIAPPaybackDetailID).FirstOrDefault());
                lbusIAPHardshipPaybackDetails.icdoIapHardshipPayback.Delete();
                this.LoadPayeeAccountIAPPaybacks();
            }
            else if (aintIAPPaybackDetailID == 0 && iclbIAPHardshipPayback.Where(item => item.icdoIapHardshipPayback.check_date == idtCurrentPaybackCheckReceivedDate && item.icdoIapHardshipPayback.check_number == istrCurrentPaybackCheckNumber && item.icdoIapHardshipPayback.check_amount == idecCurrentPaybackCheckAmount).Count() > 0)
            {
                this.iclbIAPHardshipPayback.Remove(this.iclbIAPHardshipPayback.Where(item => item.icdoIapHardshipPayback.check_date == idtCurrentPaybackCheckReceivedDate && item.icdoIapHardshipPayback.check_number == istrCurrentPaybackCheckNumber && item.icdoIapHardshipPayback.check_amount == idecCurrentPaybackCheckAmount).FirstOrDefault());
            }

            larrResult.Add(this);
            return larrResult;
        }

        public ArrayList CheckErrorOnAddButton(object aobj, Hashtable ahstParams, ref ArrayList aarrErrors, bool ablnHardErrorOnSave = false)
        {
            utlError lobjError = null;

            DataTable ldtbEmergencyPaymentSetupValue = new DataTable();
            ldtbEmergencyPaymentSetupValue = busBase.Select("cdoEmergencyPaymentSetupValue.GetEmergencyPaymentSetupValueByDate", new object[1] { this.idtIAPHardshipPaymentCheckDate });
            if (Convert.ToString(ahstParams["icdoIapHardshipPayback.payment_posted_date"]).IsNullOrEmpty())
            {
                ahstParams["icdoIapHardshipPayback.payment_posted_date"] = DateTime.Now.Date.ToString("MM/dd/yyyy");
            }
            ahstParams["icdoIapHardshipPayback.check_date"] =  ahstParams["check_date"];
            ahstParams["icdoIapHardshipPayback.check_number"] = ahstParams["check_number"];
            ahstParams["icdoIapHardshipPayback.check_amount"] = ahstParams["check_amount"];

            if (Convert.ToString(ahstParams["icdoIapHardshipPayback.check_date"]).IsNullOrEmpty())
            {
                lobjError = AddError(0, "Please Enter Check Received Date.");
                aarrErrors.Add(lobjError);
                return aarrErrors;
            }

            if (Convert.ToString(ahstParams["icdoIapHardshipPayback.check_date"]).IsNotNullOrEmpty() && Convert.ToDateTime(ahstParams["icdoIapHardshipPayback.check_date"]) > DateTime.Now)
            {
                lobjError = AddError(0, "Check Date cannot be future date.");
                aarrErrors.Add(lobjError);
                return aarrErrors;
            }

            if (Convert.ToDateTime(ahstParams["icdoIapHardshipPayback.check_date"]) < this.idtIAPHardshipPaymentCheckDate)
            {
                lobjError = AddError(0, "Check Date cannot be before payment Withdrawal date.");
                aarrErrors.Add(lobjError);
                return aarrErrors;

            }

            if (Convert.ToString(ahstParams["icdoIapHardshipPayback.check_date"]).IsNotNullOrEmpty() && (Convert.ToDateTime(ahstParams["icdoIapHardshipPayback.check_date"]) < Convert.ToDateTime(ldtbEmergencyPaymentSetupValue.Rows[0]["PAYBACK_BEGIN_DATE"]) || (Convert.ToDateTime(ahstParams["icdoIapHardshipPayback.check_date"]) >= Convert.ToDateTime(ldtbEmergencyPaymentSetupValue.Rows[0]["PAYBACK_BEGIN_DATE"]) && Convert.ToDateTime(ahstParams["icdoIapHardshipPayback.check_date"]) < DateTime.Now.AddDays(-90))))
            {
                lobjError = AddError(0, "Check Date cannot be before " + Convert.ToDateTime(ldtbEmergencyPaymentSetupValue.Rows[0]["PAYBACK_BEGIN_DATE"]).ToShortDateString());
                aarrErrors.Add(lobjError);
                return aarrErrors;
            }

            if (Convert.ToString(ahstParams["icdoIapHardshipPayback.check_number"]).IsNullOrEmpty())
            {
                lobjError = AddError(0, "Please Enter Check Number.");
                aarrErrors.Add(lobjError);
                return aarrErrors;
            }

            if (Convert.ToString(ahstParams["icdoIapHardshipPayback.check_amount"]).IsNullOrEmpty())
            {
                lobjError = AddError(0, "Please Enter Check Amount.");
                aarrErrors.Add(lobjError);
                return aarrErrors;
            }

            if (Convert.ToString(ahstParams["icdoIapHardshipPayback.check_amount"]).IsNotNullOrEmpty() &&  Convert.ToDecimal(ahstParams["icdoIapHardshipPayback.check_amount"]) < busConstant.MINIMUM_ACCEPTABLE_IAP_PAYBACK_AMOUNT && idecIAPPaybackRemainingUnPaidBalance > busConstant.MINIMUM_ACCEPTABLE_IAP_PAYBACK_AMOUNT)
            {
                lobjError = AddError(0, "Check Amount Should be Greater Or Equal to $100.");
                aarrErrors.Add(lobjError);
                return aarrErrors;
            }

            if (iclbIAPHardshipPayback.Where(item => item.icdoIapHardshipPayback.check_number == Convert.ToString(ahstParams["icdoIapHardshipPayback.check_number"])).Count() >= 1)
            {
                lobjError = AddError(0, "Duplicate Check Number is not allowed. Please Enter Another Check Number.");
                aarrErrors.Add(lobjError);
                return aarrErrors;
            }

            if (Convert.ToString(ahstParams["icdoIapHardshipPayback.check_date"]).IsNotNullOrEmpty() && Convert.ToDateTime(ahstParams["icdoIapHardshipPayback.check_date"]) > idtIAPPaybackMaximumDueDate)
            {
                lobjError = AddError(0, "Check Received After Cut Off Date. Cannot Process the Payback.");
                aarrErrors.Add(lobjError);
                return aarrErrors;
            }

            if (Convert.ToString(ahstParams["icdoIapHardshipPayback.check_amount"]).IsNotNullOrEmpty() && Convert.ToDecimal(ahstParams["icdoIapHardshipPayback.check_amount"].ToString().Substring(1)) > idecIAPPaybackRemainingUnPaidBalance)
            {
                lobjError = AddError(0, "Check Amount Cannot Be Greater Than Remaining Balance.");
                aarrErrors.Add(lobjError);
                return aarrErrors;
            }

            if (Convert.ToString(ahstParams["icdoIapHardshipPayback.check_amount"]).IsNotNullOrEmpty() && idecIAPPaybackRemainingUnPaidBalance < busConstant.MINIMUM_ACCEPTABLE_IAP_PAYBACK_AMOUNT && idecIAPPaybackRemainingUnPaidBalance != Convert.ToDecimal(ahstParams["icdoIapHardshipPayback.check_amount"].ToString().Substring(1)))
            {
                if(Convert.ToDecimal(ahstParams["icdoIapHardshipPayback.check_amount"]) != idecIAPPaybackRemainingUnPaidBalance)
                {
                    lobjError = AddError(0, "Check Amount Should be Equal to Remaining Balance, if the remaining balance is less than $100.");
                    aarrErrors.Add(lobjError);
                    return aarrErrors;

                }
               
            }
            if (Convert.ToDecimal(ahstParams["icdoIapHardshipPayback.check_amount"]) > idecIAPPaybackRemainingUnPaidBalance)
            {
                lobjError = AddError(0, "Check Amount Should be Equal to Remaining Balance");
                aarrErrors.Add(lobjError);
                return aarrErrors;

            }

            return aarrErrors;
        }

        #endregion IAP Payback
        //Ticket 75270
        public void GetPayeeDemographicDetails()
        {
            DataTable ldtbPaymentHistory = busBase.Select("cdoPaymentHistoryDistribution.GetPayeeInformation", new object[1] { this.icdoPayeeAccount.person_id });
            if (ldtbPaymentHistory.Rows.Count > 0)
            {
                foreach (DataRow ldrPaymentHistory in ldtbPaymentHistory.Rows)
                {
                    istrPayeeFullName = (ldrPaymentHistory["PAYEE_NAME"] != DBNull.Value ? Convert.ToString(ldrPaymentHistory["PAYEE_NAME"]).ToUpper() : String.Empty).ToUpper();
                    istrPayeeNameProperCase = (ldrPaymentHistory["PAYEE_NAME"] != DBNull.Value ? Convert.ToString(ldrPaymentHistory["PAYEE_NAME"]) : String.Empty).ToProperCase();
                    istrAddrLine1 = (ldrPaymentHistory[enmPaymentHistoryDistribution.addr_line_1.ToString().ToUpper()] != DBNull.Value ? Convert.ToString(ldrPaymentHistory[enmPaymentHistoryDistribution.addr_line_1.ToString().ToUpper()]) : String.Empty).ToUpper();//Convert.ToString(ldrPaymentHistory[enmPaymentHistoryDistribution.addr_line_1.ToString().ToUpper()]);
                    istrAddrLine2 = (ldrPaymentHistory[enmPaymentHistoryDistribution.addr_line_2.ToString().ToUpper()] != DBNull.Value ? Convert.ToString(ldrPaymentHistory[enmPaymentHistoryDistribution.addr_line_2.ToString().ToUpper()]) : String.Empty).ToUpper(); //Convert.ToString(ldrPaymentHistory[enmPaymentHistoryDistribution.addr_line_2.ToString().ToUpper()]);
                    istrAddrLine3 = (ldrPaymentHistory[enmPaymentHistoryDistribution.addr_line_3.ToString().ToUpper()] != DBNull.Value ? Convert.ToString(ldrPaymentHistory[enmPaymentHistoryDistribution.addr_line_3.ToString().ToUpper()]) : String.Empty).ToUpper(); //Convert.ToString(ldrPaymentHistory[enmPaymentHistoryDistribution.addr_line_2.ToString().ToUpper()]);
                    istrCity = (ldrPaymentHistory[enmPaymentHistoryDistribution.addr_city.ToString().ToUpper()] != DBNull.Value ? Convert.ToString(ldrPaymentHistory[enmPaymentHistoryDistribution.addr_city.ToString().ToUpper()]) : String.Empty).ToUpper(); //Convert.ToString(ldrPaymentHistory[enmPaymentHistoryDistribution.addr_city.ToString().ToUpper()]);
                    istrStateDescription = (iobjPassInfo.isrvDBCache.GetCodeDescriptionString(150, Convert.ToString(ldrPaymentHistory[enmPaymentHistoryDistribution.addr_state_value.ToString().ToUpper()]))).ToUpper();
                    istrZipCode = ldrPaymentHistory[enmPaymentHistoryDistribution.addr_zip_code.ToString().ToUpper()] != DBNull.Value ? Convert.ToString(ldrPaymentHistory[enmPaymentHistoryDistribution.addr_zip_code.ToString().ToUpper()]) : String.Empty;// Convert.ToString(ldrPaymentHistory[enmPaymentHistoryDistribution.addr_zip_code.ToString().ToUpper()]);
                    istrZipCode4 = ldrPaymentHistory[enmPaymentHistoryDistribution.addr_zip_4_code.ToString().ToUpper()] != DBNull.Value ? Convert.ToString(ldrPaymentHistory[enmPaymentHistoryDistribution.addr_zip_4_code.ToString().ToUpper()]) : String.Empty; //Convert.ToString(ldrPaymentHistory[enmPaymentHistoryDistribution.addr_zip_4_code.ToString().ToUpper()]);

                    if (ldrPaymentHistory[enmPaymentHistoryDistribution.addr_country_value.ToString().ToUpper()] != DBNull.Value && Convert.ToString(ldrPaymentHistory[enmPaymentHistoryDistribution.addr_country_value.ToString().ToUpper()]) != string.Empty)
                    {
                        istrCountryValue = Convert.ToString(ldrPaymentHistory[enmPaymentHistoryDistribution.addr_country_value.ToString().ToUpper()]);
                        if (istrCountryValue.IsNotNullOrEmpty())
                        {
                            istrCountryDescription = (iobjPassInfo.isrvDBCache.GetCodeDescriptionString(151, Convert.ToString(ldrPaymentHistory[enmPaymentHistoryDistribution.addr_country_value.ToString().ToUpper()]))).ToUpper();
                        }
                        if (Convert.ToInt32(ldrPaymentHistory[enmPaymentHistoryDistribution.addr_country_value.ToString().ToUpper()]) == busConstant.USA)
                        {
                            istrZipCode = (istrCity + " " + Convert.ToString(ldrPaymentHistory[enmPaymentHistoryDistribution.addr_state_value.ToString().ToUpper()]) + "  " +
                                                   istrZipCode) ?? String.Empty;

                            if ((istrZipCode4 != null) &&
                                   (istrZipCode4.Trim() != String.Empty))
                            {
                                istrZipCode += "-" + istrZipCode4 ?? String.Empty;
                            }
                            istrZipCode = istrZipCode.ToUpper();
                        }
                        else
                        {
                            istrZipCode = ldrPaymentHistory[enmPaymentHistoryDistribution.foreign_postal_code.ToString().ToUpper()] != DBNull.Value ? Convert.ToString(ldrPaymentHistory[enmPaymentHistoryDistribution.foreign_postal_code.ToString().ToUpper()]) : String.Empty + " " + istrCity;
                            istrZipCode = istrZipCode.ToUpper();
                        }
                    }
                }
            }
        }


        public void IsPayeeAccountApproved()
        {
            if (ibusBaseActivityInstance != null)
            {
                busSolBpmActivityInstance lbusBpmActivityInstance = ibusBaseActivityInstance as busSolBpmActivityInstance;
                if (lbusBpmActivityInstance != null)
                {
                    if (lbusBpmActivityInstance.ibusBpmProcessInstance.ibusBpmProcess.ibusBpmCase.icdoBpmCase.name == busConstant.PersonAccountMaintenance.APPLICATION_SERVICE_RETIREMENT_BPM)
                    {
                        if (this.iclbPayeeAccountStatus.IsNotNull())
                        {

                            var isApproved = iclbPayeeAccountStatus.Any(item => item.icdoPayeeAccountStatus.status_value == busConstant.PAYEE_STATUS_APPROVED);

                            if (isApproved)
                            {
                                lbusBpmActivityInstance.UpdateParameterValue(busConstant.PersonAccountMaintenance.PAYEE_ACCOUNT_APPROVED, busConstant.FLAG_YES);
                            }
                            else
                            {
                                lbusBpmActivityInstance.UpdateParameterValue(busConstant.PersonAccountMaintenance.PAYEE_ACCOUNT_APPROVED, busConstant.FLAG_NO);
                            }
               
                        }
                    }
                }
            }
        }
         public void AddPayeeAccountNote(int aintPayeeAccountId, int aintPlanId)
         {
            busPayeeAccount lobjPayeeAccount = new busPayeeAccount { icdoPayeeAccount = new cdoPayeeAccount() };
            lobjPayeeAccount.FindPayeeAccount(aintPayeeAccountId);
            string lstrPlanName = string.Empty;
            DataTable ldtplan = Select("cdoPlan.GetPlanById", new object[1] { aintPlanId });
            if (ldtplan.Rows.Count > 0)
            {
                DataRow drRow = ldtplan.Rows[0];
                lstrPlanName = Convert.ToString(drRow[0]);
            }
            busNotes lobjNotes = new busNotes { icdoNotes = new cdoNotes() };
            lobjNotes.icdoNotes.person_id = lobjPayeeAccount.icdoPayeeAccount.person_id;
            lobjNotes.icdoNotes.form_id = busConstant.Form_ID;
            lobjNotes.icdoNotes.form_value = busConstant.PersonAccountMaintenance.SERVICE_RETIREMENT;
            lobjNotes.icdoNotes.notes = "Payee Account approved for next payment cycle for " + lstrPlanName;
            lobjNotes.icdoNotes.created_by = this.iobjPassInfo.istrUserID;
            lobjNotes.icdoNotes.created_date = DateTime.Now;
            lobjNotes.icdoNotes.modified_date = DateTime.Now;
            lobjNotes.icdoNotes.modified_by = this.iobjPassInfo.istrUserID;
            lobjNotes.icdoNotes.ienuObjectState = ObjectState.Insert;
            lobjNotes.icdoNotes.Insert();

        }

        public override ArrayList OnBpmSubmit()
        {
            IsPayeeAccountApproved();
            return base.OnBpmSubmit();  
        }
    }



    public struct PayeeOverPayment
    {
        public int PaymentHistoryHeaderID { get; set; }
        public string PaymentTypeValue { get; set; }
        public decimal NetAmount { get; set; }
    }
}

