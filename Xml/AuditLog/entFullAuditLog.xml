<entity ID="entFullAuditLog" sfwView="False" sfwActive="True" sfwMainCDO="icdoFullAuditLog" sfwType="EntityRule" sfwStatus="Review" sfwTableName="sgs_full_audit_log" Text="Full Audit Log" sfwObjectID="busFullAuditLog" sfwDataObjectID="doFullAuditLog">
  <attributes>
    <attribute sfwValue="audit_log_id" sfwType="Column" sfwKeyNo="1" sfwIsIdentity="True" sfwDataType="int" sfwDBDataType="int" sfwIsNull="False" ID="AuditLogId" sfwCaption="ID" />
    <attribute sfwValue="form_name" sfwType="Column" sfwKeyNo="0" sfwIsIdentity="False" sfwDataType="string" sfwDBDataType="varchar" sfwLength="128" sfwIsNull="False" ID="FormName" sfwCaption="Form Name" />
    <attribute sfwValue="table_name" sfwType="Column" sfwKeyNo="0" sfwIsIdentity="False" sfwDataType="string" sfwDBDataType="varchar" sfwLength="128" sfwIsNull="False" ID="TableName" sfwCaption="Table Name" />
    <attribute sfwValue="primary_key" sfwType="Column" sfwKeyNo="0" sfwIsIdentity="False" sfwDataType="long" sfwDBDataType="bigint" sfwIsNull="True" ID="PrimaryKey" sfwCaption="Primary Key" />
    <attribute sfwValue="person_id" sfwType="Column" sfwKeyNo="0" sfwIsIdentity="False" sfwDataType="int" sfwDBDataType="int" sfwIsNull="True" ID="PersonId" sfwCaption="Person Id" />
    <attribute sfwValue="org_id" sfwType="Column" sfwKeyNo="0" sfwIsIdentity="False" sfwDataType="int" sfwDBDataType="int" sfwIsNull="True" ID="OrgId" sfwCaption="Org Id" />
    <attribute sfwValue="org_plan_id" sfwType="Column" sfwKeyNo="0" sfwIsIdentity="False" sfwDataType="int" sfwDBDataType="int" sfwIsNull="True" ID="OrgPlanId" sfwCaption="Org Plan Id" />
    <attribute sfwValue="change_type" sfwType="Column" sfwKeyNo="0" sfwIsIdentity="False" sfwDataType="string" sfwDBDataType="varchar" sfwLength="1" sfwIsNull="False" ID="ChangeType" sfwCaption="Change Type" />
    <attribute sfwValue="modified_by" sfwType="Column" sfwKeyNo="0" sfwIsIdentity="False" sfwDataType="string" sfwDBDataType="varchar" sfwLength="50" sfwIsNull="False" ID="ModifiedBy" sfwCaption="Modified By" />
    <attribute sfwValue="modified_date" sfwType="Column" sfwKeyNo="0" sfwIsIdentity="False" sfwDataType="datetime" sfwDBDataType="datetime" sfwIsNull="False" ID="ModifiedDate" sfwCaption="Modified Date" />
    <attribute sfwValue="client_ip_address" sfwType="Column" sfwKeyNo="0" sfwIsIdentity="False" sfwDataType="string" sfwDBDataType="varchar" sfwLength="50" sfwIsNull="True" ID="ClientIpAddress" sfwCaption="Client Ip Address" />
    <attribute sfwValue="bo_primary_key" sfwType="Column" sfwKeyNo="0" sfwIsIdentity="False" sfwDataType="long" sfwDBDataType="bigint" sfwIsNull="True" ID="BoPrimaryKey" sfwCaption="Bo Primary Key" />
    <attribute sfwValue="guid_transaction_id" sfwType="Column" sfwKeyNo="0" sfwIsIdentity="False" sfwDataType="guid" sfwDBDataType="uniqueidentifier" sfwIsNull="True" ID="GuidTransactionId" sfwCaption="Guid Transaction Id" />
    <attribute sfwValue="audit_details" sfwType="Column" sfwKeyNo="0" sfwIsIdentity="False" sfwDataType="string" sfwDBDataType="varchar" sfwLength="MAX" sfwIsNull="True" ID="AuditDetails" sfwCaption="Audit Details" />
    <attribute ID="lstFullAuditLogDetail" sfwType="Collection" sfwValue="iclbFullAuditLogDetail" sfwEntity="entFullAuditLogDetail" sfwPrivate="False" />
    <attribute ID="objPerson" sfwType="Object" sfwEntity="entPerson" sfwPrivate="False" sfwValue="ibusPerson" />
  </attributes>
  <ExtraFields />
  <queries>
    <query ID="GetAuditHistory" sfwQueryType="SelectQuery" sfwDataType="EntityTable" sfwSql="IF OBJECT_ID('tempdb..#tempAuditLog') IS NOT NULL  BEGIN DROP TABLE #tempAuditLog  END&#xD;&#xA;&#xD;&#xA;SELECT AUDIT_LOG_ID, AUDIT_DETAILS &#xD;&#xA;INTO #tempAuditLog &#xD;&#xA;FROM SGS_FULL_AUDIT_LOG  &#xD;&#xA;WHERE PRIMARY_KEY = @PRIMARY_KEY  AND FORM_NAME = @FORM_NAME&#xD;&#xA;&#xD;&#xA;IF OBJECT_ID('tempdb..#tempAuditLogDetails') IS NOT NULL  begin drop table #tempAuditLogDetails  end&#xD;&#xA;IF OBJECT_ID('tempdb..#tempAuditLogDetail') IS NOT NULL  begin drop table #tempAuditLogDetail  end&#xD;&#xA;&#xD;&#xA;select PLI.parent_ID,&#xD;&#xA;case when name='column_name' and StringValue &lt;&gt; 'null' and StringValue &lt;&gt; '' then convert(Varchar(200),StringValue) else null end as [column_name],&#xD;&#xA;case when name='old_value' and StringValue &lt;&gt; 'null' and StringValue &lt;&gt; '' then convert(Varchar(200),StringValue) else null end as [old_value],&#xD;&#xA;case when name='new_value' and StringValue &lt;&gt; 'null' and StringValue &lt;&gt; '' then convert(Varchar(200),StringValue) else null end as [new_value],&#xD;&#xA;AL.AUDIT_LOG_ID Audit_Log_Id&#xD;&#xA;into #tempAuditLogDetails&#xD;&#xA;from #tempAuditLog as AL&#xD;&#xA;cross APPLY parseJSON(ISNULL(AL.AUDIT_DETAILS,'')) pli &#xD;&#xA;&#xD;&#xA;select parent_ID,MAX(column_name) AS column_name,MAX(old_value) AS old_value,MAX(new_value) AS new_value, Audit_Log_Id &#xD;&#xA;into #tempAuditLogDetail &#xD;&#xA;from #tempAuditLogDetails &#xD;&#xA;where (column_name is not null or old_value is not null or new_value is not null) &#xD;&#xA;group by parent_ID , Audit_Log_Id&#xD;&#xA;&#xD;&#xA;SELECT AUDIT_LOG_ID,COLUMN_NAME,NEW_VALUE,OLD_VALUE,istrMODIFIED_BY,idtMODIFIED_DATE&#xD;&#xA;FROM&#xD;&#xA;(&#xD;&#xA;    SELECT AUDIT_LOG_ID,COLUMN_NAME,NEW_VALUE,OLD_VALUE,NWVALUE AS istrMODIFIED_BY,NVALUE AS idtMODIFIED_DATE&#xD;&#xA;&#x9;FROM&#xD;&#xA;&#x9;(&#xD;&#xA;&#x9;&#x9;SELECT&#xD;&#xA;&#x9;&#x9;--SFALD.AUDIT_LOG_DETAIL_ID,&#xD;&#xA;&#x9;&#x9;SFALD.AUDIT_LOG_ID,&#xD;&#xA;&#x9;&#x9;SFALD.COLUMN_NAME,&#xD;&#xA;&#x9;&#x9;CASE WHEN ISDATE(SFALD.NEW_VALUE) = 1 THEN CONVERT(VARCHAR(10),CAST(SFALD.NEW_VALUE AS DATETIME),101)&#xD;&#xA;&#x9;&#x9;WHEN SCVNEW.DESCRIPTION IS NOT NULL THEN SCVNEW.DESCRIPTION &#xD;&#xA;&#x9;&#x9;ELSE SFALD.NEW_VALUE END AS NEW_VALUE,&#xD;&#xA;&#x9;&#x9;CASE WHEN ISDATE(SFALD.OLD_VALUE) = 1 THEN CONVERT(VARCHAR(10),CAST(SFALD.OLD_VALUE AS DATETIME),101)&#xD;&#xA;&#x9;&#x9;WHEN SCVOLD.DESCRIPTION IS NOT NULL THEN SCVOLD.DESCRIPTION &#xD;&#xA;&#x9;&#x9;ELSE SFALD.OLD_VALUE END AS OLD_VALUE&#xD;&#xA;&#x9;&#x9;FROM #tempAuditLog SFAL WITH(NOLOCK)&#xD;&#xA;&#x9;&#x9;INNER JOIN #tempAuditLogDetail SFALD WITH(NOLOCK) ON SFAL.AUDIT_LOG_ID = SFALD.AUDIT_LOG_ID&#xD;&#xA;&#x9;&#x9;LEFT OUTER JOIN SGS_CODE_VALUE SCVNEW WITH (NOLOCK) ON SFALD.COLUMN_NAME = 'marital_status_value' AND SCVNEW.CODE_ID = 6015 AND SCVNEW.CODE_VALUE = SFALD.NEW_VALUE&#xD;&#xA;&#x9;&#x9;LEFT OUTER JOIN SGS_CODE_VALUE SCVOLD WITH (NOLOCK) ON SFALD.COLUMN_NAME = 'marital_status_value' AND SCVOLD.CODE_ID = 6015 AND SCVOLD.CODE_VALUE = SFALD.OLD_VALUE&#xD;&#xA;&#x9;&#x9;--WHERE SFAL.PRIMARY_KEY = @PRIMARY_KEY  AND SFAL.FORM_NAME = @FORM_NAME&#xD;&#xA;&#x9;)A&#xD;&#xA;&#xD;&#xA;&#x9;LEFT OUTER JOIN &#xD;&#xA;&#x9;(&#xD;&#xA;&#x9;&#x9;Select SFAL.AUDIT_LOG_ID AS AUDITLOGID, SSFALD.NEW_VALUE AS NWVALUE,SSFALD.COLUMN_NAME AS CL_NAME&#xD;&#xA;&#x9;&#x9;FROM #tempAuditLog SFAL WITH(NOLOCK)&#xD;&#xA;&#x9;&#x9;INNER JOIN #tempAuditLogDetail SSFALD with(nolock) on SFAL.AUDIT_LOG_ID = SSFALD.AUDIT_LOG_ID and SSFALD.COLUMN_NAME='modified_by'&#xD;&#xA;&#x9;&#x9;--WHERE SFAL.PRIMARY_KEY = @PRIMARY_KEY  AND SFAL.FORM_NAME = @FORM_NAME&#xD;&#xA;&#x9;)B ON A.AUDIT_LOG_ID = B.AUDITLOGID&#xD;&#xA;&#xD;&#xA;&#x9;LEFT OUTER JOIN &#xD;&#xA;&#x9;(&#xD;&#xA;&#x9;&#x9;Select SFAL.AUDIT_LOG_ID AS AUDITLOGID, SSFALD.NEW_VALUE AS NVALUE,SSFALD.COLUMN_NAME AS CL_NAME&#xD;&#xA;&#x9;&#x9;FROM #tempAuditLog SFAL WITH(NOLOCK)&#xD;&#xA;&#x9;&#x9;INNER JOIN #tempAuditLogDetail SSFALD with(nolock) on SFAL.AUDIT_LOG_ID = SSFALD.AUDIT_LOG_ID and SSFALD.COLUMN_NAME='modified_date'&#xD;&#xA;&#x9;&#x9;--WHERE SFAL.PRIMARY_KEY = @PRIMARY_KEY  AND SFAL.FORM_NAME = @FORM_NAME&#xD;&#xA;&#x9;)C ON A.AUDIT_LOG_ID = C.AUDITLOGID&#xD;&#xA;&#xD;&#xA;) x&#xD;&#xA;&#xD;&#xA;WHERE x.COLUMN_NAME IN ('ssn','date_of_birth', 'date_of_death','first_name','last_name','middle_name', 'created_by', 'created_date', 'modified_by', 'modified_date')">
      <parameters>
        <parameter ID="@PRIMARY_KEY" sfwDataType="int" />
        <parameter ID="@FORM_NAME" sfwDataType="string" />
      </parameters>
    </query>
    <query ID="GetAuditHistoryForPersonOverview" sfwQueryType="SelectQuery" sfwDataType="EntityTable" sfwSql="IF OBJECT_ID('tempdb..#tempAuditLog') IS NOT NULL  BEGIN DROP TABLE #tempAuditLog  END&#xD;&#xA;&#xD;&#xA;SELECT AUDIT_LOG_ID, MODIFIED_BY, MODIFIED_DATE, AUDIT_DETAILS &#xD;&#xA;INTO #tempAuditLog &#xD;&#xA;FROM SGS_FULL_AUDIT_LOG  &#xD;&#xA;WHERE PRIMARY_KEY = @PRIMARY_KEY  AND FORM_NAME = @FORM_NAME&#xD;&#xA;&#xD;&#xA;IF OBJECT_ID('tempdb..#tempAuditLogDetails') IS NOT NULL  begin drop table #tempAuditLogDetails  end&#xD;&#xA;IF OBJECT_ID('tempdb..#tempAuditLogDetail') IS NOT NULL  begin drop table #tempAuditLogDetail  end&#xD;&#xA;&#xD;&#xA;select PLI.parent_ID,&#xD;&#xA;case when name='column_name' and StringValue &lt;&gt; 'null' and StringValue &lt;&gt; '' then convert(Varchar(200),StringValue) else null end as [column_name],&#xD;&#xA;case when name='old_value' and StringValue &lt;&gt; 'null' and StringValue &lt;&gt; '' then convert(Varchar(200),StringValue) else null end as [old_value],&#xD;&#xA;case when name='new_value' and StringValue &lt;&gt; 'null' and StringValue &lt;&gt; '' then convert(Varchar(200),StringValue) else null end as [new_value],&#xD;&#xA;AL.AUDIT_LOG_ID Audit_Log_Id&#xD;&#xA;into #tempAuditLogDetails&#xD;&#xA;from #tempAuditLog as AL&#xD;&#xA;cross APPLY parseJSON(ISNULL(AL.AUDIT_DETAILS,'')) pli &#xD;&#xA;&#xD;&#xA;select parent_ID,MAX(column_name) AS column_name,MAX(old_value) AS old_value,MAX(new_value) AS new_value, Audit_Log_Id &#xD;&#xA;into #tempAuditLogDetail &#xD;&#xA;from #tempAuditLogDetails &#xD;&#xA;where (column_name is not null or old_value is not null or new_value is not null) &#xD;&#xA;group by parent_ID , Audit_Log_Id&#xD;&#xA;&#xD;&#xA;SELECT&#xD;&#xA;--SFALD.AUDIT_LOG_DETAIL_ID,&#xD;&#xA;SFALD.AUDIT_LOG_ID,&#xD;&#xA;SFALD.COLUMN_NAME,&#xD;&#xA;CASE WHEN ISDATE(SFALD.NEW_VALUE) = 1 THEN CONVERT(VARCHAR(10),CAST(SFALD.NEW_VALUE AS DATETIME),101)&#xD;&#xA;WHEN SCVNEW.DESCRIPTION IS NOT NULL THEN SCVNEW.DESCRIPTION &#xD;&#xA;ELSE SFALD.NEW_VALUE END AS NEW_VALUE,&#xD;&#xA;&#xD;&#xA;CASE WHEN ISDATE(SFALD.OLD_VALUE) = 1 THEN CONVERT(VARCHAR(10),CAST(SFALD.OLD_VALUE AS DATETIME),101)&#xD;&#xA;WHEN SCVOLD.DESCRIPTION IS NOT NULL THEN SCVOLD.DESCRIPTION &#xD;&#xA;ELSE SFALD.OLD_VALUE END AS OLD_VALUE,&#xD;&#xA;sfal.MODIFIED_BY AS istrMODIFIED_BY,&#xD;&#xA;CONVERT(VARCHAR(10),CAST(SFAL.MODIFIED_DATE AS DATETIME),101) idtMODIFIED_DATE&#xD;&#xA;&#xD;&#xA;FROM #tempAuditLog SFAL WITH(NOLOCK)&#xD;&#xA;INNER JOIN #tempAuditLogDetail SFALD WITH(NOLOCK) ON SFAL.AUDIT_LOG_ID = SFALD.AUDIT_LOG_ID&#xD;&#xA;LEFT OUTER JOIN SGS_CODE_VALUE SCVNEW WITH (NOLOCK) ON SFALD.COLUMN_NAME = 'marital_status_value' AND SCVNEW.CODE_ID = 6015 AND SCVNEW.CODE_VALUE = SFALD.NEW_VALUE&#xD;&#xA;LEFT OUTER JOIN SGS_CODE_VALUE SCVOLD WITH (NOLOCK) ON SFALD.COLUMN_NAME = 'marital_status_value' AND SCVOLD.CODE_ID = 6015 AND SCVOLD.CODE_VALUE = SFALD.OLD_VALUE&#xD;&#xA;--WHERE SFAL.PRIMARY_KEY = @PRIMARY_KEY  AND SFAL.FORM_NAME = @FORM_NAME&#xD;&#xA;AND SFALD.COLUMN_NAME IN ('FORFEITURE_DATE(MPIPP)','VESTED_DATE(IAP)','FORFEITURE_DATE(IAP)','VESTED_DATE(MPIPP)')">
      <parameters>
        <parameter ID="@PRIMARY_KEY" sfwDataType="int" />
        <parameter ID="@FORM_NAME" sfwDataType="string" />
      </parameters>
    </query>
  </queries>
  <constraint />
  <rules>
    <rule ID="MakeReadOnly" sfwRuleType="Validation" sfwObjectBased="False" sfwExpression="true" />
  </rules>
  <initialload>
    <item ID="MakeReadOnly" sfwMode="All" sfwStatus="Active" />
  </initialload>
  <softerror />
  <harderror />
  <validatedelete />
  <delete />
  <groupslist />
  <checklist />
  <methods />
  <lifecycle />
  <objectmethods />
</entity>